<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Maîtriser Ethereum</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
<h1>Maîtriser Ethereum</h1>
</div>
<div id="content">
<div class="sect1 pagenumrestart data-line-3">
<h2 id="whatis_chapter">Qu&#39;est-ce qu&#39;Ethereum ?</h2>
<div class="sectionbody">
<div class="paragraph data-line-5">
<p>Ethereum est souvent décrit comme &quot;l&#39;ordinateur du monde.&quot; Mais qu&#39;est-ce que cela signifie ? Commençons par une description axée sur l&#39;informatique, puis essayons de décrypter cela avec une analyse plus pratique des capacités et des caractéristiques d&#39;Ethereum, tout en le comparant à Bitcoin et à d&#39;autres plateformes d&#39;échange d&#39;informations décentralisées (ou « chaînes de blocs » pour court).</p>
</div>
<div class="paragraph data-line-7">
<p>D&#39;un point de vue informatique, Ethereum est une machine à états déterministe mais pratiquement illimitée, composée d&#39;un état singleton globalement accessible et d&#39;une machine virtuelle qui applique des modifications à cet état.</p>
</div>
<div class="paragraph data-line-9">
<p>D&#39;un point de vue plus pratique, Ethereum est une infrastructure informatique à source libre décentralisée à l&#39;échelle mondiale qui exécute des programmes appelés <em>contrats intelligents</em>. Il utilise une chaîne de blocs pour synchroniser et stocker les changements d&#39;état du système, ainsi qu&#39;une cryptomonnaie appelée <em>ether</em> pour mesurer et limiter les coûts des ressources d&#39;exécution.</p>
</div>
<div class="paragraph data-line-11">
<p>La plate-forme Ethereum permet aux développeurs de créer de puissantes applications décentralisées avec des fonctions économiques intégrées. Tout en offrant une disponibilité, une auditabilité, une transparence et une neutralité élevées, il réduit ou élimine également la censure et réduit certains risques de contrepartie.</p>
</div>
<div class="sect2 data-line-14">
<h3 id="bitcoin_comparison">Comparé à Bitcoin</h3>
<div class="paragraph data-line-16">
<p>Beaucoup de gens viendront à Ethereum avec une expérience préalable des cryptomonnaies, en particulier du Bitcoin. Ethereum partage de nombreux éléments communs avec d&#39;autres chaînes de blocs ouvertes : un réseau pair à pair reliant les participants, un algorithme de consensus byzantin tolérant aux pannes pour la synchronisation des mises à jour d&#39;état (une chaîne de blocs de preuve de travail), l&#39;utilisation de primitives cryptographiques telles que le numérique signatures et hachages, et une monnaie numérique (ether).</p>
</div>
<div class="paragraph data-line-18">
<p>Pourtant, à bien des égards, le but et la construction d&#39;Ethereum sont étonnamment différents de ceux des chaînes de blocs ouvertes qui l&#39;ont précédé, y compris Bitcoin.</p>
</div>
<div class="paragraph data-line-20">
<p> Le but d&#39;Ethereum n&#39;est pas principalement d&#39;être un réseau de paiement en monnaie numérique. Alors que la monnaie numérique ether fait à la fois partie intégrante et nécessaire au fonctionnement d&#39;Ethereum, l&#39;ether est conçu comme une <em>monnaie d&#39;utilité</em> pour payer l&#39;utilisation de la plate-forme Ethereum en tant qu&#39;ordinateur mondial.</p>
</div>
<div class="paragraph data-line-22">
<p>Contrairement à Bitcoin, qui a un langage de script très limité, Ethereum est conçu pour être une chaîne de blocs programmable à usage général qui exécute une <em>machine virtuelle</em> capable d&#39;exécuter du code d&#39;une complexité arbitraire et illimitée. Là où le langage de script de Bitcoin est, intentionnellement, contraint à une simple évaluation vrai/faux des conditions de dépenses, le langage d&#39;Ethereum est <em>Turing complet</em>, ce qui signifie qu&#39;Ethereum peut fonctionner directement comme un ordinateur à usage général.</p>
</div>
</div>
<div class="sect2 data-line-25">
<h3 id="blockchain_components">Composantes d&#39;une chaîne de blocs</h3>
<div class="paragraph data-line-27">
<p>Les composantes d&#39;une chaîne de blocs ouverte et publique sont (généralement) :</p>
</div>
<div class="ulist data-line-29">
<ul>
<li class="data-line-29">
<p>Un réseau pair à pair (P2P) connectant les participants et propageant les transactions et les blocs de transactions vérifiées, basé sur un &quot;échange&quot; <span class="keep-together">protocolaire</span> standardisé.</p>
</li>
<li class="data-line-30">
<p>Messages, sous forme de transactions, représentant des transitions d&#39;état</p>
</li>
<li class="data-line-31">
<p>Un ensemble de règles consensuelles, régissant ce qui constitue une transaction et ce qui constitue une transition d&#39;état valide</p>
</li>
<li class="data-line-32">
<p>Une machine à états qui traite les transactions selon les règles du consensus</p>
</li>
<li class="data-line-33">
<p>Une chaîne de blocs cryptographiquement sécurisés qui agit comme un journal de toutes les transitions d&#39;état vérifiées et acceptées</p>
</li>
<li class="data-line-34">
<p>Un algorithme de consensus qui décentralise le contrôle sur la chaîne de blocs, en forçant les participants à coopérer à l&#39;application des règles de consensus</p>
</li>
<li class="data-line-35">
<p>Un schéma d&#39;incitation théoriquement valable (par exemple, les coûts de la preuve de travail plus les récompenses globales) pour sécuriser économiquement la machine d&#39;état dans un <span class="keep-together">environnement</span> ouvert.</p>
</li>
<li class="data-line-36">
<p>Une ou plusieurs implémentations logicielles à source libre des éléments ci-dessus (&quot;clients&quot;)</p>
</li>
</ul>
</div>
<div class="paragraph data-line-38">
<p>Tous ou la plupart de ces composants sont généralement combinés dans un seul client logiciel. Par exemple, dans Bitcoin, l&#39;implémentation de référence est développée par le projet à source libre <em>Bitcoin Core</em> et implémentée en tant que client <em>bitcoind</em>. Dans Ethereum, plutôt qu&#39;une implémentation de référence, il existe une <em>spécification de référence</em>, une description mathématique du système dans le livre jaune (voir <a href="#references">Lectures complémentaires</a>). Il existe un certain nombre de clients, qui sont construits selon la spécification de référence.</p>
</div>
<div class="paragraph data-line-40">
<p>Dans le passé, nous utilisions le terme &quot;chaîne de blocs&quot; pour représenter tous les composants que nous venons d&#39;énumérer, comme une référence abrégée à la combinaison de technologies qui englobent toutes les caractéristiques décrites. Aujourd&#39;hui, cependant, il existe une grande variété de chaînes de blocs avec des propriétés différentes. Nous avons besoin de qualificatifs pour nous aider à comprendre les caractéristiques de la chaîne de blocs en question, telles que <em>ouverte, publique, globale, décentralisée, neutre,</em> et <em>résistante à la censure</em>, pour identifier les caractéristiques émergentes importantes d&#39;un système &quot;chaîne de blocs&quot; que ces composants permettent.</p>
</div>
<div class="paragraph data-line-42">
<p>Toutes les chaînes de blocs ne sont pas créées égales. Quand quelqu&#39;un vous dit que quelque chose est une chaîne de blocs, vous n&#39;avez pas reçu de réponse ; vous devez plutôt commencer à poser beaucoup de questions pour clarifier ce qu&#39;elles veulent dire lorsqu&#39;elles utilisent le mot &quot;chaîne de blocs&quot;. Commencez par demander une description des composants de la liste précédente, puis demandez si cette &quot;chaîne de blocs&quot; présente les caractéristiques d&#39;être <em>ouverte, publique</em>, etc.</p>
</div>
</div>
<div class="sect2 data-line-45">
<h3 id="ethereum_birth">La naissance d&#39;Ethereum</h3>
<div class="paragraph data-line-47">
<p> Toutes les grandes innovations résolvent de vrais problèmes, et Ethereum ne fait pas exception. Ethereum a été conçu à une époque où les gens reconnaissaient la puissance du modèle Bitcoin et essayaient d&#39;aller au-delà des applications de cryptomonnaie. Mais les développeurs étaient confrontés à une énigme : ils devaient soit construire sur Bitcoin, soit démarrer une nouvelle chaîne de blocs. S&#39;appuyer sur Bitcoin signifiait vivre dans les limites intentionnelles du réseau et essayer de trouver des solutions de contournement. L&#39;ensemble limité de types de transactions, de types de données et de tailles de stockage de données semblait limiter les types d&#39;applications pouvant s&#39;exécuter directement sur Bitcoin ; tout le reste nécessitait des couches hors chaîne supplémentaires, ce qui annulait immédiatement bon nombre des avantages de l&#39;utilisation d&#39;une chaîne de blocs publique. Pour les projets qui avaient besoin de plus de liberté et de flexibilité tout en restant pertinent, une nouvelle chaîne de blocs était la seule option. Mais cela signifiait beaucoup de travail : démarrage de tous les éléments de l&#39;infrastructure, tests exhaustifs, etc.</p>
</div>
<div class="paragraph data-line-49">
<p> Vers la fin de 2013, Vitalik Buterin, un jeune programmeur et passionné de Bitcoin, a commencé à réfléchir à l&#39;extension des capacités de Bitcoin et Mastercoin (un protocole Bitcoin de superposition étendu pour offrir des contrats intelligents rudimentaires). En octobre de la même année, Vitalik a proposé une approche plus généralisée à l&#39;équipe Mastercoin, qui permettait à des contrats flexibles et scriptables (mais pas Turing-complets) de remplacer le langage contractuel spécialisé de Mastercoin. Bien que l&#39;équipe Mastercoin ait été impressionnée, cette proposition était un changement trop radical pour s&#39;intégrer dans leur feuille de route de développement.</p>
</div>
<div class="paragraph data-line-51">
<p>En décembre 2013, Vitalik a commencé à partager un livre blanc qui décrivait l&#39;idée derrière Ethereum : une chaîne de blocs à usage général complète de Turing. Quelques dizaines de personnes ont vu cette première ébauche et ont fait part de leurs commentaires, aidant Vitalik à faire évoluer la proposition.</p>
</div>
<div class="paragraph data-line-53">
<p>Les deux auteurs de ce livre ont reçu une première ébauche du livre blanc et l&#39;ont commentée. Andreas M. Antonopoulos a été intrigué par l&#39;idée et a posé de nombreuses questions à Vitalik sur l&#39;utilisation d&#39;une chaîne de blocs distincte pour appliquer des règles de consensus sur l&#39;exécution de contrats intelligents et les implications d&#39;un langage Turing-complet. Andreas a continué à suivre les progrès d&#39;Ethereum avec beaucoup d&#39;intérêt, mais en était aux premiers stades de l&#39;écriture de son livre <em>Mastering Bitcoin</em>, et n&#39;a participé directement à Ethereum que bien plus tard. Dr. Gavin Wood, cependant, a été l&#39;une des premières personnes à contacter Vitalik et à lui proposer de l&#39;aider avec ses compétences en programmation C++. Gavin est devenu le cofondateur, le codesigner et le CTO d&#39;Ethereum.</p>
</div>
<div class="paragraph data-line-55">
<p>Comme le raconte Vitalik dans son <a href="http://bit.ly/2T2t6zs" data-href="http://bit.ly/2T2t6zs">article &quot;Ethereum Prehistory&quot;</a> :</p>
</div>
<div class="quoteblock data-line-57">
<blockquote>
<div class="paragraph data-line-58">
<p>C&#39;était l&#39;époque où le protocole Ethereum était entièrement ma propre création. À partir de là, cependant, de nouveaux participants ont commencé à rejoindre le giron. De loin, le plus important du côté du protocole était Gavin Wood&#8230;&#8203;</p>
</div>
<div class="paragraph data-line-60">
<p>Gavin peut également être largement crédité du changement subtil de vision d&#39;Ethereum comme une plate-forme pour créer de l&#39;argent programmable, avec des contrats basés sur la chaîne de blocs qui peuvent contenir des actifs numériques et les transférer selon des règles prédéfinies, à une plate-forme informatique à usage général. Cela a commencé par de subtils changements d&#39;accent et de terminologie, et plus tard cette influence s&#39;est renforcée avec l&#39;accent croissant mis sur l&#39;ensemble &quot;Web 3&quot;, qui considérait Ethereum comme un élément d&#39;une suite de technologies décentralisées, les deux autres étant Whisper et Swarm.</p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-63">
<p>À partir de décembre 2013, Vitalik et Gavin ont affiné et fait évoluer l&#39;idée, construisant ensemble la couche de protocole qui est devenue Ethereum.</p>
</div>
<div class="paragraph data-line-65">
<p>Les fondateurs d&#39;Ethereum pensaient à une chaîne de blocs sans but précis, qui pourrait prendre en charge une grande variété d&#39;applications en étant <em>programmée</em>. L&#39;idée était qu&#39;en utilisant une chaîne de blocs à usage général comme Ethereum, un développeur pouvait programmer son application particulière sans avoir à mettre en œuvre les mécanismes sous-jacents des réseaux pair à pair, des chaînes de blocs, des algorithmes de consensus, etc. La plateforme Ethereum a été conçue pour abstraire ces détails en fournissant un environnement de programmation déterministe et sécurisé pour les applications chaîne de blocs décentralisées.</p>
</div>
<div class="paragraph data-line-67">
<p>Tout comme Satoshi, Vitalik et Gavin n&#39;ont pas simplement inventé une nouvelle technologie ; ils ont combiné de nouvelles inventions avec des technologies existantes d&#39;une manière nouvelle et ont livré le code prototype pour prouver leurs idées au monde.</p>
</div>
<div class="paragraph data-line-69">
<p>Les fondateurs ont travaillé pendant des années, construisant et affinant la vision. Et le 30 juillet 2015, le premier bloc Ethereum a été miné. L&#39;ordinateur du monde a commencé à servir le monde.</p>
</div>
<div class="admonitionblock note data-line-72">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-73">
<p>L&#39;article de Vitalik Buterin &quot;A Prehistory of Ethereum&quot; a été publié en septembre 2017 et offre une vue fascinante à la première personne des premiers instants d&#39;Ethereum.</p>
</div>
<div class="paragraph data-line-75">
<p>Vous pouvez le lire sur
<a href="https://vitalik.ca/general/2017/09/14/prehistory.html" class="undefined" data-href="https://vitalik.ca/general/2017/09/14/prehistory.html">https://vitalik.ca/general/2017/09/14/prehistory.html</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-80">
<h3 id="development_stages">Les quatre étapes de développement d&#39;Ethereum</h3>
<div class="paragraph data-line-82">
<p>Le développement d&#39;Ethereum a été planifié en quatre étapes distinctes, avec des changements majeurs à chaque étape.  Une étape peut inclure des sous-versions, appelées &quot;embranchements divergents&quot; (hard forks), qui modifient les fonctionnalités d&#39;une manière qui n&#39;est pas rétrocompatible .</p>
</div>
<div class="paragraph data-line-84">
<p>Les quatre principales étapes de développement portent le nom de code <em>Frontier</em>, <em>Homestead</em>, <em>Metropolis</em> et <em>Serenity</em>. Les embranchements divergents intermédiaires qui se sont produits (ou sont prévus) à ce jour portent les noms de code <em>Ice Age</em>, <em>DAO</em>, <em>Tangerine Whistle</em>, <em>Spurious Dragon</em>, <em>Byzantium</em> et <em>Constantinople</em>. Les étapes de développement et les embranchements divergents intermédiaires sont présentées sur la chronologie suivante, qui est &quot;datée&quot; par numéro de bloc :</p>
</div>
<div class="dlist data-line-87">
<dl>
<dt class="hdlist1">Bloc #0</dt>
<dd>
<p><em>Frontier</em>—L&#39;étape initiale d&#39;Ethereum, du 30 juillet 2015 à mars 2016.</p>
</dd>
<dt class="hdlist1">Bloc #200 000</dt>
<dd>
<p><em>Ice Age</em>—Un embranchement divergent pour introduire une augmentation exponentielle de la difficulté, pour motiver une transition vers PoS lorsque prêt.</p>
</dd>
<dt class="hdlist1">Bloc #1 150 000</dt>
<dd>
<p><em>Homestead</em>—La deuxième étape d&#39;Ethereum, lancée en mars 2016.</p>
</dd>
<dt class="hdlist1">Bloc #1 192 000</dt>
<dd>
<p><em>DAO</em>—Un embranchement divergent qui a remboursé les victimes du contrat DAO piraté et a provoqué la scission d&#39;Ethereum et d&#39;Ethereum Classic en deux systèmes concurrents.</p>
</dd>
<dt class="hdlist1">Bloc #2 463 000</dt>
<dd>
<p><em>Tangerine Whistle</em>—Un embranchement divergent pour modifier le calcul du gaz pour certaines opérations lourdes en E/S et pour effacer l&#39;état accumulé d&#39;un déni de service (DoS) attaque qui a exploité le faible coût du gaz de ces opérations.</p>
</dd>
<dt class="hdlist1">Bloc #2 675 000</dt>
<dd>
<p><em>Spurious Dragon</em>—Un embranchement divergent pour traiter plus de vecteurs d&#39;attaque DoS, et un autre effacement d&#39;état. En outre, un mécanisme de protection contre les attaques par relecture.</p>
</dd>
<dt class="hdlist1">Bloc #4 370 000</dt>
<dd>
<p><em>Metropolis Byzantium</em>—Metropolis est la troisième étape d&#39;Ethereum, en cours au moment de la rédaction de ce livre, lancée en octobre 2017. Byzance est le premier des deux embranchements divergents prévus pour Metropolis.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-103">
<p>Après Byzance, il y a un autre embranchement divergent prévu pour Metropolis : Constantinople. Metropolis sera suivi de la dernière étape du déploiement d&#39;Ethereum, baptisée Serenity.</p>
</div>
</div>
<div class="sect2 data-line-107">
<h3 id="general_purpose_blockchain">Ethereum : une chaîne de blocs à usage général</h3>
<div class="paragraph data-line-109">
<p>La chaîne de blocs d&#39;origine, à savoir la chaîne de blocs de Bitcoin, suit l&#39;état de unités de bitcoin et leur propriété.  Vous pouvez considérer Bitcoin comme une <em>machine à états</em> à consensus distribué, où les transactions provoquent une <em>transition d&#39;état</em> globale, modifiant la propriété des pièces. Les transitions d&#39;état sont contraintes par les règles du consensus, permettant à tous les participants de (éventuellement) converger vers un état commun (consensus) du système, après que plusieurs blocs aient été minés.</p>
</div>
<div class="paragraph data-line-111">
<p>Ethereum est également une machine à états distribuée. Mais au lieu de suivre uniquement l&#39;état de la propriété de la devise, Ethereum suit les transitions d&#39;état d&#39;un magasin de données à usage général, c&#39;est-à-dire un magasin pouvant contenir toutes les données exprimables en tant que <em>uplet clé–valeur</em>. Un magasin de données clé-valeur contient des valeurs arbitraires, chacune référencée par une clé ; par exemple, la valeur &quot;Mastering Ethereum&quot; référencée par la clé &quot;Titre du livre&quot;. À certains égards, cela sert le même objectif que le modèle de stockage de données de <em>Random Access Memory</em> (RAM) utilisé par la plupart des ordinateurs à usage général. Ethereum a une mémoire qui stocke à la fois le code et les données, et il utilise la chaîne de blocs Ethereum pour suivre l&#39;évolution de cette mémoire au fil du temps. Comme un ordinateur à programme stocké à usage général, Ethereum peut charger du code dans sa machine d&#39;état et <em>exécuter</em> ce code, en stockant les changements d&#39;état résultants dans sa chaîne de blocs. Deux des différences critiques par rapport à la plupart des ordinateurs à usage général sont que les changements d&#39;état d&#39;Ethereum sont régis par les règles du consensus et que l&#39;état est distribué à l&#39;échelle mondiale. Ethereum répond à la question : &quot;Et si nous pouvions suivre n&#39;importe quel état arbitraire et programmer la machine à états pour créer un ordinateur mondial fonctionnant par consensus ?&quot;</p>
</div>
</div>
<div class="sect2 data-line-114">
<h3 id="ethereum_components">Composants d&#39;Ethereum</h3>
<div class="paragraph data-line-116">
<p>Dans Ethereum, les composantes d&#39;un système de chaîne de blocs décrit dans <a href="#blockchain_components">Composantes d&#39;une chaîne de blocs</a> sont, plus précisément :</p>
</div>
<div class="dlist data-line-119">
<dl>
<dt class="hdlist1">Réseau P2P</dt>
<dd>
<p>Ethereum fonctionne sur le <em>réseau principal Ethereum</em>, qui est adressable sur le port TCP 30303, et exécute un protocole appelé <em>ÐΞVp2p</em>.</p>
</dd>
<dt class="hdlist1">Règles de consensus </dt>
<dd>
<p>Les règles de consensus d&#39;Ethereum sont définies dans la spécification de référence, le Yellow Paper (voir <a href="#references">Lectures complémentaires</a>).</p>
</dd>
<dt class="hdlist1">Transactions</dt>
<dd>
<p>Les transactions Ethereum sont des messages réseau qui incluent (entre autres) un expéditeur, un destinataire, une valeur et une charge utile de données.</p>
</dd>
</dl>
</div>
<div class="dlist pagebreak-before data-line-126">
<dl>
<dt class="hdlist1">Machine d&#39;état</dt>
<dd>
<p>Les transitions d&#39;état Ethereum sont traitées par la <em>Ethereum Virtual Machine</em> (EVM), une machine virtuelle basée sur la pile qui exécute le <em>bytecode</em> (code intermédiaire ou instructions en langage machine). Les programmes EVM, appelés « contrats intelligents », sont écrits dans des langages de haut niveau (par exemple, Solidity) et compilés en code intermédiaire pour être exécutés sur l&#39;EVM.</p>
</dd>
<dt class="hdlist1">Structures de données</dt>
<dd>
<p>L&#39;état d&#39;Ethereum est stocké localement sur chaque nœud en tant que <em>base de données</em> (généralement LevelDB de Google), qui contient les transactions et l&#39;état du système dans une structure de données hachée sérialisée appelée <em>Arbre Merkle Patricia</em>.</p>
</dd>
<dt class="hdlist1">Algorithme de consensus</dt>
<dd>
<p>Ethereum utilise le modèle de consensus de Bitcoin, Nakamoto Consensus, qui utilise des blocs séquentiels à signature unique, pondérés en importance par PoW pour déterminer la chaîne la plus longue et donc l&#39;état actuel. Cependant, il est prévu de passer à un système de vote pondéré PoS, nommé <em>Casper</em>, dans un proche avenir.</p>
</dd>
<dt class="hdlist1">Sécurité économique</dt>
<dd>
<p>Ethereum utilise actuellement un algorithme PoW appelé <em>Ethash</em>, mais cela finira par être abandonné avec le passage au PoS à un moment donné dans le futur.</p>
</dd>
<dt class="hdlist1">Clients</dt>
<dd>
<p>Ethereum a plusieurs implémentations interopérables du logiciel client, dont les plus importantes sont <em>Go-Ethereum</em> (<em>Geth</em>) et <em>Parity</em>.</p>
</dd>
</dl>
</div>
<div class="sect3 data-line-137">
<h4 id="references">Lectures complémentaires</h4>
<div class="paragraph data-line-139">
<p>Les références suivantes fournissent des informations supplémentaires sur les technologies mentionnées ici :</p>
</div>
<div class="ulist data-line-141">
<ul>
<li class="data-line-141">
<p>Le livre jaune Ethereum:
<a href="https://ethereum.github.io/yellowpaper/paper.pdf" class="undefined" data-href="https://ethereum.github.io/yellowpaper/paper.pdf">https://ethereum.github.io/yellowpaper/paper.pdf</a></p>
</li>
<li class="data-line-144">
<p>Le Livre Beige, une réécriture du Livre Jaune pour un public plus large dans un langage moins formel:
<a href="https://github.com/chronaeon/beigepaper" class="undefined" data-href="https://github.com/chronaeon/beigepaper">https://github.com/chronaeon/beigepaper</a></p>
</li>
<li class="data-line-147">
<p>Protocole réseau ÐΞVp2p:
<a href="http://bit.ly/2quAlTE" class="undefined" data-href="http://bit.ly/2quAlTE">http://bit.ly/2quAlTE</a></p>
</li>
<li class="data-line-150">
<p>Liste des ressources de la machine virtuelle Ethereum:
<a href="http://bit.ly/2PmtjiS" class="undefined" data-href="http://bit.ly/2PmtjiS">http://bit.ly/2PmtjiS</a></p>
</li>
<li class="data-line-153">
<p>Base de données LevelDB (utilisée le plus souvent pour stocker la copie locale de la chaîne de blocs):
<a href="https://github.com/google/leveldb" class="undefined" data-href="https://github.com/google/leveldb">https://github.com/google/leveldb</a></p>
</li>
<li class="data-line-156">
<p>Arbres Merkle Patricia:
<a href="https://github.com/ethereum/wiki/wiki/Patricia-Tree" class="undefined" data-href="https://github.com/ethereum/wiki/wiki/Patricia-Tree">https://github.com/ethereum/wiki/wiki/Patricia-Tree</a></p>
</li>
<li class="data-line-159">
<p>Algorithme Ethash PoW:
<a href="https://github.com/ethereum/wiki/wiki/Ethash" class="undefined" data-href="https://github.com/ethereum/wiki/wiki/Ethash">https://github.com/ethereum/wiki/wiki/Ethash</a></p>
</li>
<li class="data-line-162">
<p>Guide de mise en œuvre de Casper PoS v1:
<a href="http://bit.ly/2DyPr3l" class="undefined" data-href="http://bit.ly/2DyPr3l">http://bit.ly/2DyPr3l</a></p>
</li>
<li class="data-line-165">
<p>Client Go-Ethereum (Geth):
<a href="https://geth.ethereum.org/" class="undefined" data-href="https://geth.ethereum.org/">https://geth.ethereum.org/</a></p>
</li>
<li class="data-line-168">
<p>Client Ethereum Parity:
<a href="https://parity.io/" class="undefined" data-href="https://parity.io/">https://parity.io/</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2 data-line-172">
<h3 id="turing_completeness">Complétude d&#39;Ethereum et de Turing</h3>
<div class="paragraph data-line-174">
<p>Dès que vous commencez à lire sur Ethereum, vous rencontrerez immédiatement le terme &quot;Turing complet&quot;. Ethereum, disent-ils, contrairement à Bitcoin, est Turing complet. Qu&#39;est-ce que cela veut dire exactement?</p>
</div>
<div class="paragraph data-line-176">
<p>Le terme fait référence au mathématicien anglais Alan Turing, qui est considéré comme le père de l&#39;informatique. En 1936, il crée un modèle mathématique d&#39;ordinateur consistant en une machine à états qui manipule des symboles en les lisant et en les écrivant sur une mémoire séquentielle (ressemblant à une bande de papier de longueur infinie). Avec cette construction, Turing a continué à fournir une base mathématique pour répondre (par la négative) aux questions sur la <em>calculabilité universelle</em>, c&#39;est-à-dire si tous les problèmes peuvent être résolus. Il a prouvé qu&#39;il existe des classes de problèmes qui ne sont pas calculables. Plus précisément, il a prouvé que le <em>problème d&#39;arrêt</em> (s&#39;il est possible, étant donné un programme arbitraire et son entrée, de déterminer si le programme finira par s&#39;arrêter) n&#39;est pas résoluble.</p>
</div>
<div class="paragraph data-line-178">
<p>Alan Turing a en outre défini un système comme étant <em>Turing complet</em> s&#39;il peut être utilisé pour simuler n&#39;importe quelle machine de Turing. Un tel système s&#39;appelle une <em>machine de Turing universelle</em> (UTM).</p>
</div>
<div class="paragraph data-line-180">
<p>La capacité d&#39;Ethereum à exécuter un programme stocké, dans une machine à états appelée Ethereum Virtual Machine, tout en lisant et en écrivant des données dans la mémoire en fait un système Turing complet et donc un UTM. Ethereum peut calculer n&#39;importe quel algorithme pouvant être calculé par n&#39;importe quelle machine de Turing, compte tenu des limites de la mémoire finie.</p>
</div>
<div class="paragraph data-line-182">
<p>L&#39;innovation révolutionnaire d&#39;Ethereum consiste à combiner l&#39;architecture informatique à usage général d&#39;un ordinateur à programme stocké avec une chaîne de blocs décentralisée, créant ainsi un ordinateur mondial distribué à un seul état (singleton). Les programmes Ethereum s&#39;exécutent &quot;partout&quot;, mais produisent un état commun qui est sécurisé par les règles de <span class="keep-together">consensus</span>.</p>
</div>
<div class="sect3 data-line-185">
<h4 id="turing_completeness_feature">Complétude de Turing en tant que &quot;fonctionnalité&quot;</h4>
<div class="paragraph data-line-187">
<p> En entendant qu&#39;Ethereum est Turing complet, vous pourriez arriver à la conclusion qu&#39;il s&#39;agit d&#39;une <em>fonctionnalité</em> qui manque d&#39;une manière ou d&#39;une autre dans un système qui est incomplet de Turing. C&#39;est plutôt le contraire. La complétude de Turing est très facile à réaliser ; en fait, <a href="http://bit.ly/2ABft33" class="undefined" data-href="http://bit.ly/2ABft33">http://bit.ly/2ABft33</a> [la machine d&#39;état Turing complète la plus simple connue] a 4 états et utilise 6 symboles, avec une définition d&#39;état qui ne compte que 22 instructions. En effet, il arrive parfois que des systèmes soient « accidentellement Turing complets ». Une référence amusante de tels systèmes peut être trouvée à <a href="http://bit.ly/2Og1VgX" class="undefined" data-href="http://bit.ly/2Og1VgX">http://bit.ly/2Og1VgX</a>.</p>
</div>
<div class="paragraph data-line-189">
<p>Cependant, l&#39;exhaustivité de Turing est très dangereuse, en particulier dans les systèmes à accès ouvert comme les chaînes de blocs publiques, en raison du problème d&#39;arrêt que nous avons évoqué plus tôt. Par exemple, les imprimantes modernes sont Turing complètes et peuvent recevoir des fichiers à imprimer qui les envoient dans un état figé. Le fait qu&#39;Ethereum soit Turing complet signifie que n&#39;importe quel programme de n&#39;importe quelle complexité peut être calculé par Ethereum. Mais cette flexibilité pose des problèmes épineux de sécurité et de gestion des ressources. Une imprimante qui ne répond pas peut être éteinte et rallumée. Ce n&#39;est pas possible avec une chaîne de blocs publique.</p>
</div>
</div>
<div class="sect3 data-line-192">
<h4 id="turing_completeness_implications">Implications de la complétude de Turing</h4>
<div class="paragraph data-line-194">
<p>Turing a prouvé que vous ne pouvez pas prédire si un programme se terminera en le simulant sur un ordinateur. En termes simples, nous ne pouvons pas prédire le chemin d&#39;un programme sans l&#39;exécuter. Les systèmes Turing-complets peuvent s&#39;exécuter en &quot;boucles infinies&quot;, un terme utilisé (en simplifiant à l&#39;extrême) pour décrire un programme qui ne se termine pas. Il est trivial de créer un programme qui exécute une boucle qui ne se termine jamais. Mais des boucles sans fin involontaires peuvent survenir sans avertissement, en raison d&#39;interactions complexes entre les conditions de départ et le code. Dans Ethereum, cela pose un défi : chaque nœud participant (client) doit valider chaque transaction, en exécutant tous les contrats intelligents qu&#39;il appelle. Mais comme Turing l&#39;a prouvé, Ethereum ne peut pas prédire si un contrat intelligent prendra fin, ou combien de temps il durera, sans réellement l&#39;exécuter (éventuellement pour toujours). Que ce soit par accident ou exprès, un contrat intelligent peut être créé de telle sorte qu&#39;il s&#39;exécute indéfiniment lorsqu&#39;un nœud tente de le valider. Il s&#39;agit en fait d&#39;une attaque DoS. Et bien sûr, entre un programme qui prend une milliseconde à valider et un autre qui s&#39;exécute indéfiniment, il existe une gamme infinie de programmes désagréables, monopolisant les ressources, gonflant la mémoire et provoquant une surchauffe du processeur qui gaspillent simplement des ressources. Dans un ordinateur mondial, un programme qui abuse des ressources arrive à abuser des ressources mondiales. Comment Ethereum limite-t-il les ressources utilisées par un contrat intelligent s&#39;il ne peut pas prédire l&#39;utilisation des ressources à l&#39;avance ?</p>
</div>
<div class="paragraph data-line-196">
<p>Pour répondre à ce défi, Ethereum introduit un mécanisme de mesure appelé <em>gaz</em>. Comme l&#39;EVM exécute un contrat intelligent, il comptabilise soigneusement chaque instruction (calcul, accès aux données, etc.). Chaque instruction a un coût prédéterminé en unités de gaz. Lorsqu&#39;une transaction déclenche l&#39;exécution d&#39;un contrat intelligent, elle doit inclure une quantité de gaz qui fixe la limite supérieure de ce qui peut être consommé en exécutant le contrat intelligent. L&#39;EVM terminera l&#39;exécution si la quantité de gaz consommée par le calcul dépasse le gaz disponible dans la transaction. Le gaz est le mécanisme utilisé par Ethereum pour permettre un calcul complet de Turing tout en limitant les ressources que tout programme peut consommer.</p>
</div>
<div class="paragraph data-line-198">
<p>La question suivante est, &quot;comment obtenir du gaz pour payer le calcul sur l&#39;ordinateur mondial Ethereum?&quot; Vous ne trouverez pas de gaz sur les échanges.  Il ne peut être acheté que dans le cadre d&#39;une transaction et ne peut être acheté qu&#39;avec de l&#39;ether. L&#39;ether doit être envoyé avec une transaction et il doit être explicitement affecté à l&#39;achat de gaz, avec un prix du gaz acceptable. Comme à la pompe, le prix de l&#39;essence n&#39;est pas fixe. Le gaz est acheté pour la transaction, le calcul est exécuté et tout gaz non utilisé est remboursé à l&#39;expéditeur de la transaction.</p>
</div>
</div>
</div>
<div class="sect2 data-line-201">
<h3 id="DApp">Des chaînes de blocs à usage général aux applications décentralisées (DApps)</h3>
<div class="paragraph data-line-203">
<p>Ethereum a commencé comme un moyen de créer une chaîne de blocs à usage général qui peut être programmé pour une variété d&#39;utilisations. Mais très rapidement, la vision d&#39;Ethereum s&#39;est élargie pour devenir une plateforme de programmation de DApps. Les DApps représentent une perspective plus large que les contrats intelligents. Un DApp est, à tout le moins, un contrat intelligent et une interface utilisateur Web. Plus généralement, une DApp est une application Web qui repose sur des services d&#39;infrastructure ouverts, décentralisés et pair à pair.</p>
</div>
<div class="paragraph data-line-205">
<p>Une DApp est composée d&#39;au moins :</p>
</div>
<div class="ulist data-line-207">
<ul>
<li class="data-line-207">
<p>Contrats intelligents sur une chaîne de blocs</p>
</li>
<li class="data-line-208">
<p>Une interface utilisateur Web frontale</p>
</li>
</ul>
</div>
<div class="paragraph data-line-210">
<p>De plus, de nombreux DApps incluent d&#39;autres composants décentralisés, tels que :</p>
</div>
<div class="ulist data-line-212">
<ul>
<li class="data-line-212">
<p>Un protocole et une plateforme de stockage décentralisé (P2P)</p>
</li>
<li class="data-line-213">
<p>Un protocole et une plateforme de messagerie décentralisée (P2P)</p>
</li>
</ul>
</div>
<div class="admonitionblock tip data-line-216">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-217">
<p>Vous pouvez voir des DApps orthographiés comme <em>ÐApps</em>. Le caractère Ð est le caractère latin appelé &quot;ETH&quot;, faisant allusion à Ethereum. Pour afficher ce caractère, utilisez le point de code Unicode 0xD0, ou si nécessaire l&#39;entité caractère HTML eth (ou entité décimale #208).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-221">
<h3 id="evolving_WWW">Le troisième âge d&#39;Internet</h3>
<div class="paragraph data-line-223">
<p>En 2004, le terme &quot;Web 2.0&quot; a pris de l&#39;importance, décrivant une évolution du Web vers un contenu généré par l&#39;utilisateur, des interfaces réactives et l&#39;interactivité. Web 2.0 n&#39;est pas une spécification technique, mais plutôt un terme décrivant le nouveau centre d&#39;intérêt des <span class="keep-together">applications</span> Web.</p>
</div>
<div class="paragraph data-line-225">
<p>Le concept de DApps est destiné à faire passer le World Wide Web à sa prochaine étape d&#39;évolution naturelle, en introduisant la décentralisation avec des protocoles pair à pair dans tous les aspects d&#39;une application Web. Le terme utilisé pour décrire cette évolution est <em>web3</em>, c&#39;est-à-dire la troisième &quot;version&quot; du web.  Proposé pour la première fois par le Dr Gavin Wood, web3 représente une nouvelle vision et une nouvelle orientation pour les applications Web : des applications détenues et gérées de manière centralisée aux applications basées sur des protocoles décentralisés .</p>
</div>
<div class="paragraph data-line-227">
<p>Dans les chapitres suivants, nous explorerons la bibliothèque JavaScript Ethereum web3.js, qui relie les applications JavaScript qui s&#39;exécutent dans votre navigateur avec la chaîne de blocs Ethereum. La bibliothèque web3.js comprend également une interface vers un réseau de stockage P2P appelé <em>Swarm</em> et un service de messagerie P2P appelé <em>Whisper</em>. Avec ces trois composants inclus dans une bibliothèque JavaScript exécutée dans votre navigateur Web, les développeurs disposent d&#39;une suite complète de développement d&#39;applications qui leur permet de créer des DApps web3.</p>
</div>
</div>
<div class="sect2 data-line-230">
<h3 id="development_culture">Culture de développement d&#39;Ethereum</h3>
<div class="paragraph data-line-232">
<p> Jusqu&#39;à présent, nous avons expliqué en quoi les objectifs et la technologie d&#39;Ethereum diffèrent de ceux des autres chaînes de blocs qui l&#39;ont précédé , comme Bitcoin. Ethereum a également une culture de développement très différente.</p>
</div>
<div class="paragraph data-line-234">
<p>Dans Bitcoin, le développement est guidé par des principes conservateurs : tous les changements sont soigneusement étudiés pour s&#39;assurer qu&#39;aucun des systèmes existants ne soit perturbé. Pour la plupart, les modifications ne sont mises en œuvre que si elles sont rétrocompatibles. Les clients existants sont autorisés à s&#39;inscrire, mais continueront à fonctionner s&#39;ils décident de ne pas effectuer la mise à niveau.</p>
</div>
<div class="paragraph data-line-236">
<p>Dans Ethereum, en comparaison, la culture de développement de la communauté est axée sur l&#39;avenir plutôt que sur le passé. Le mantra (pas tout à fait sérieux) est &quot;avancez vite et cassez des choses&quot;. Si un changement est nécessaire, il est mis en œuvre, même si cela signifie invalider les hypothèses précédentes, rompre la compatibilité ou forcer les clients à se mettre à jour. La culture de développement d&#39;Ethereum se caractérise par une innovation et une évolution rapide et une volonté de déployer des améliorations tournées vers l&#39;avenir, même si cela se fait au détriment d&#39;une certaine rétrocompatibilité.</p>
</div>
<div class="paragraph data-line-238">
<p>Cela signifie pour vous, en tant que développeur, que vous devez rester flexible et être prêt à reconstruire votre infrastructure à mesure que certaines des hypothèses sous-jacentes changent. L&#39;un des grands défis auxquels sont confrontés les développeurs d&#39;Ethereum est la contradiction inhérente entre le déploiement de code sur un système immuable et une plate-forme de développement en constante évolution. Vous ne pouvez pas simplement &quot;mettre à niveau&quot; vos contrats intelligents. Vous devez être prêt à en déployer de nouveaux, à migrer les utilisateurs, les applications et les fonds, et à recommencer.</p>
</div>
<div class="paragraph data-line-240">
<p>Ironiquement, cela signifie également que l&#39;objectif de construire des systèmes avec plus d&#39;autonomie et moins de contrôle centralisé n&#39;est toujours pas pleinement atteint. L&#39;autonomie et la décentralisation nécessitent un peu plus de stabilité dans la plate-forme que vous n&#39;obtiendrez probablement dans Ethereum dans les prochaines années. Afin de &quot;faire évoluer&quot; la plateforme, vous devez être prêt à supprimer et redémarrer vos contrats intelligents, ce qui signifie que vous devez conserver un certain degré de contrôle sur eux.</p>
</div>
<div class="paragraph data-line-242">
<p>Mais, du côté positif, Ethereum avance très vite. Il y a peu d&#39;opportunités pour la &quot;bike-shedding&quot;, une expression qui signifie retarder le développement en se disputant sur des détails mineurs tels que la façon de construire le garage à vélos à l&#39;arrière d&#39;une centrale nucléaire. Si vous commencez à faire du vélo, vous découvrirez peut-être soudainement que pendant que vous étiez distrait, le reste de l&#39;équipe de développement a changé le plan et a abandonné les vélos en faveur de l&#39;aéroglisseur autonome.</p>
</div>
<div class="paragraph data-line-244">
<p>A terme, le développement de la plateforme Ethereum ralentira et ses interfaces deviendront fixes. Mais en attendant, l&#39;innovation est le principe moteur. Vous feriez mieux de suivre, car personne ne ralentira pour vous.</p>
</div>
</div>
<div class="sect2 data-line-247">
<h3 id="why_learn">Pourquoi apprendre Ethereum ?</h3>
<div class="paragraph data-line-249">
<p>Les chaînes de blocs ont une courbe d&#39;apprentissage très abrupte, car elles combinent plusieurs disciplines en un seul domaine: programmation, sécurité de l&#39;information, cryptographie, économie, systèmes distribués, réseaux pair à pair, etc. Ethereum rend cette courbe d&#39;apprentissage beaucoup moins abrupte, vous pouvez donc démarrer rapidement. Mais juste sous la surface d&#39;un environnement d&#39;une simplicité trompeuse se cache bien plus. Au fur et à mesure que vous apprenez et commencez à chercher plus profondément, il y a toujours une autre couche de complexité et d&#39;émerveillement.</p>
</div>
<div class="paragraph data-line-251">
<p>Ethereum est une excellente plate-forme pour en savoir plus sur les chaînes de blocs et construit une communauté massive de développeurs, plus rapidement que toute autre plate-forme de chaîne de blocs. Plus que tout autre, Ethereum est une <em>chaîne de blocs de développeurs</em>, construite par des développeurs pour des développeurs. Un développeur familiarisé avec les applications JavaScript peut se lancer dans Ethereum et commencer à produire du code fonctionnel très rapidement. Pendant les premières années de la vie d&#39;Ethereum, il était courant de voir des T-shirts annonçant que vous pouvez créer un jeton en seulement cinq lignes de code. Bien sûr, c&#39;est une épée à double tranchant. Il est facile d&#39;écrire du code, mais il est très difficile d&#39;écrire du <em>bon</em> code <em>sécurisé</em>.</p>
</div>
</div>
<div class="sect2 data-line-254">
<h3 id="teaching_objectives">Ce que ce livre vous apprendra</h3>
<div class="paragraph data-line-256">
<p>Ce livre plonge dans Ethereum et examine chaque composant. Vous commencerez par une transaction simple, décortiquerez son fonctionnement, établirez un contrat simple, l&#39;améliorerez et suivrez son parcours dans le système Ethereum.</p>
</div>
<div class="paragraph data-line-5">
<p>Vous apprendrez non seulement comment utiliser Ethereum - comment cela fonctionne - mais aussi pourquoi il est conçu comme il est. Vous pourrez comprendre comment chacune des pièces fonctionne, comment elles s&#39;emboîtent et pourquoi. </p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="intro_chapter">Les bases d&#39;Ethereum</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p> Dans ce chapitre, nous commencerons à explorer Ethereum, à apprendre à utiliser les portefeuilles, à créer des transactions, et aussi comment exécuter un contrat intelligent de base.</p>
</div>
<div class="sect2 data-line-7">
<h3 id="ether_units">L&#8217;ether comme unité monétaire</h3>
<div class="paragraph data-line-9">
<p>L&#39;unité monétaire d&#39;Ethereum est appelée <em>ether</em>, également identifiée par &quot;ETH&quot; ou avec les symboles &#926; (de la lettre grecque « Xi » qui ressemble à un E majuscule stylisé) ou, moins souvent, &#9830;: par exemple, 1 éther, ou 1 ETH, ou &#926;1, ou &#9830;1.</p>
</div>
<div class="admonitionblock tip data-line-12">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-13">
<p>Utilisez le caractère Unicode U+039E pour &#926; et U+2666 pour &#9830;.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-16">
<p>L&#39;ether est subdivisé en unités plus petites, jusqu&#39;à la plus petite unité possible, qui est nommée <em>wei</em>. Un ether est égal à 1 quintillion de wei (1 * 10<sup>18</sup> ou 1 000 000 000 000 000 000). Vous entendrez peut-être aussi les gens se référer à la devise &quot;Ethereum&quot;, mais c&#39;est une erreur courante pour les débutants. Ethereum est le système, ether est la monnaie.</p>
</div>
<div class="paragraph data-line-18">
<p>La valeur de l&#39;ether est toujours représentée en interne dans Ethereum sous la forme d&#39;une valeur entière non signée libellée en wei. Lorsque vous traitez 1 ether, la transaction encode 1000000000000000000 wei comme valeur.</p>
</div>
<div class="paragraph data-line-20">
<p>Les différentes dénominations d&#39;ether ont à la fois un <em>nom scientifique</em> utilisant le Système international d&#39;unités (<em>SI</em>) et un nom familier qui rend hommage à de nombreux grands esprits de l&#39;informatique et de la cryptographie.</p>
</div>
<div class="paragraph data-line-22">
<p><a href="#ether_denominations">Dénominations d&#8217;ether et noms d&#39;unités</a> montre les différentes unités, leurs noms familiers (communs) et leurs noms SI. Conformément à la représentation interne de la valeur, le tableau montre toutes les dénominations en wei (première ligne), avec l&#39;ether indiqué par 10<sup>18</sup> wei dans la 7e ligne.</p>
</div>
<table id="ether_denominations" class="tableblock frame-all grid-all stretch data-line-27">
<caption class="title">Table 1. Dénominations d&#8217;ether et noms d&#39;unités</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Valeur (en wei)</th>
<th class="tableblock halign-left valign-top">Exposant</th>
<th class="tableblock halign-left valign-top">Nom commun</th>
<th class="tableblock halign-left valign-top">Nom SI</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wei</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Wei</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>3</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Babbage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kilowei ou femtoether</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>6</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lovelace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mégawei ou picoether</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000 000 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>9</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shanon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gigawei ou nanoether</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000 000 000 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>12</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Szabo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microether ou micro</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000 000 000 000 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>15</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finney</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Milliether ou milli</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>1 000 000 000 000 000 000</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>10<sup>18</sup></em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Ether</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Ether</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000 000 000 000 000 000 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>21</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grandiose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kiloether</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 000 000 000 000 000 000 000 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>24</sup></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mégaether</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2 data-line-41">
<h3 id="choosing_eth_wallet">Choisir un portefeuille Ethereum</h3>
<div class="paragraph data-line-43">
<p>Le terme &quot;portefeuille&quot; est venu signifier beaucoup de choses, bien qu&#39;elles soient toutes liées et qu&#39;elles se résument au quotidien à peu près à la même chose. Nous utiliserons le terme &quot;portefeuille&quot; pour désigner une application logicielle qui vous aide à gérer votre compte Ethereum. En bref, un portefeuille Ethereum est votre passerelle vers le système Ethereum. Il détient vos clés et peut créer et diffuser des transactions en votre nom. Choisir un portefeuille Ethereum peut être difficile car il existe de nombreuses options différentes avec des caractéristiques et des conceptions différentes. Certains sont plus adaptés aux débutants et certains sont plus adaptés aux experts. La plate-forme Ethereum elle-même est toujours en cours d&#39;amélioration, et les &quot;meilleurs&quot; portefeuilles sont souvent ceux qui s&#39;adaptent aux changements qui accompagnent les mises à niveau de la plate-forme.</p>
</div>
<div class="paragraph data-line-45">
<p>Mais ne vous inquiétez pas ! Si vous choisissez un portefeuille et que vous n&#39;aimez pas son fonctionnement, ou si vous l&#39;aimez au début, mais que vous souhaitez ensuite essayer autre chose, vous pouvez changer de portefeuille assez facilement. Tout ce que vous avez à faire est d&#39;effectuer une transaction qui envoie vos fonds de l&#39;ancien portefeuille vers le nouveau portefeuille, ou d&#39;exporter vos clés privées et de les importer dans le nouveau.</p>
</div>
<div class="paragraph data-line-47">
<p>Nous avons sélectionné trois types de portefeuilles différents à utiliser comme exemples tout au long du livre : un portefeuille mobile, un portefeuille de bureau et un portefeuille Web. Nous avons choisi ces trois portefeuilles car ils représentent un large éventail de complexité et de fonctionnalités. Cependant, la sélection de ces portefeuilles n&#39;est pas une approbation de leur qualité ou de leur sécurité. Ils sont simplement un bon point de départ pour des démonstrations et des tests.</p>
</div>
<div class="paragraph data-line-49">
<p>N&#39;oubliez pas que pour qu&#39;une application de portefeuille fonctionne, elle doit avoir accès à vos clés privées, il est donc essentiel que vous ne téléchargiez et n&#39;utilisiez que des applications de portefeuille provenant de sources de confiance. Heureusement, en général, plus une application de portefeuille est populaire, plus elle est susceptible d&#39;être fiable. Néanmoins, il est recommandé d&#39;éviter de &quot;mettre tous vos œufs dans le même panier&quot; et de répartir vos comptes Ethereum sur plusieurs portefeuilles.</p>
</div>
<div class="paragraph data-line-51">
<p>Voici quelques bons portefeuilles de démarrage :</p>
</div>
<div class="dlist data-line-53">
<dl>
<dt class="hdlist1">MetaMask</dt>
<dd>
<p>MetaMask est un portefeuille d&#39;extension de navigateur qui s&#39;exécute dans votre navigateur (Chrome, Firefox, Opera ou Brave Browser). Il est facile à utiliser et pratique pour les tests, car il est capable de se connecter à une variété de nœuds Ethereum et de tester des chaînes de blocs. MetaMask est un portefeuille basé sur le Web.</p>
</dd>
<dt class="hdlist1">Jaxx</dt>
<dd>
<p>Jaxx est un portefeuille multiplateforme et multidevise qui fonctionne sur une variété de systèmes d&#39;exploitation, y compris Android, iOS, Windows, macOS, et Linux. C&#39;est souvent un bon choix pour les nouveaux utilisateurs car il est conçu pour la simplicité et la facilité d&#39;utilisation. Jaxx est soit un portefeuille mobile, soit un portefeuille de bureau, selon l&#39;endroit où vous l&#39;installez.</p>
</dd>
<dt class="hdlist1">MyEtherWallet (MEW)</dt>
<dd>
<p>(&quot;portefeuilles&quot;,&quot;Emerald Wallet&quot; )MyEtherWallet est un portefeuille Web qui s&#39;exécute dans n&#39;importe quel navigateur. Il possède de multiples fonctionnalités sophistiquées que nous explorerons dans plusieurs de nos exemples. MyEtherWallet est un portefeuille basé sur le Web.</p>
</dd>
<dt class="hdlist1">Emerald Wallet</dt>
<dd>
<p>Emerald Wallet est conçu pour fonctionner avec la blockchain Ethereum Classic, mais est compatible avec d&#39;autres blockchains basées sur Ethereum. C&#39;est une application de bureau à source libre et fonctionne sous Windows, macOS et Linux. Emerald Wallet peut exécuter un nœud complet ou se connecter à un nœud distant public, fonctionnant en mode &quot;léger&quot;. Il dispose également d&#39;un outil compagnon pour effectuer toutes les opérations à partir de la ligne de commande.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-61">
<p>Nous commencerons par installer MetaMask sur un bureau, mais nous aborderons d&#39;abord brièvement le contrôle et la gestion des clés.</p>
</div>
</div>
<div class="sect2 data-line-64">
<h3 id="control_responsibility">Contrôle et responsabilité</h3>
<div class="paragraph data-line-66">
<p>Les chaînes de blocs ouvertes comme Ethereum sont importantes car elles fonctionnent comme un système <em>décentralisé</em>. Cela signifie beaucoup de choses, mais un aspect crucial est que chaque utilisateur d&#39;Ethereum peut et doit contrôler ses propres clés privées, qui contrôlent l&#39;accès aux fonds et aux contrats intelligents. Nous appelons parfois la combinaison de l&#39;accès aux fonds et des contrats intelligents un &quot;compte&quot; ou un &quot;portefeuille&quot;. Ces termes peuvent devenir assez complexes dans leur fonctionnalité, nous y reviendrons donc plus en détail plus tard. En tant que principe fondamental, cependant, c&#39;est aussi simple qu&#39;une clé privée équivaut à un &quot;compte&quot;. Certains utilisateurs choisissent de renoncer au contrôle de leurs clés privées en utilisant un dépositaire tiers, tel qu&#39;un échange en ligne. Dans ce livre, nous vous apprendrons à prendre le contrôle et à gérer vos propres clés privées.</p>
</div>
<div class="paragraph data-line-68">
<p>Avec le contrôle vient une grande responsabilité. Si vous perdez vos clés privées, vous perdez l&#39;accès à vos fonds et contrats. Personne ne peut vous aider à retrouver l&#39;accès - vos fonds seront verrouillés pour toujours. Voici quelques conseils pour vous aider à gérer cette responsabilité :</p>
</div>
<div class="ulist data-line-70">
<ul>
<li class="data-line-70">
<p>N&#39;improvisez pas la sécurité. Utilisez des approches standardisées.</p>
</li>
<li class="data-line-72">
<p>Plus le compte est important (par exemple, plus la valeur des fonds contrôlés est élevée, ou plus les contrats intelligents accessibles sont importants), plus les mesures de sécurité doivent être prises.</p>
</li>
<li class="data-line-74">
<p>La sécurité la plus élevée est obtenue à partir d&#39;un appareil isolé, mais ce niveau n&#39;est pas requis pour tous les comptes.</p>
</li>
<li class="data-line-76">
<p>Ne stockez jamais votre clé privée en clair, en particulier sous forme numérique. Heureusement, la plupart des interfaces utilisateur actuelles ne vous permettent même pas de voir la clé privée brute.</p>
</li>
<li class="data-line-78">
<p>Les clés privées peuvent être stockées sous forme cryptée, en tant que fichier &quot;keystore&quot; numérique. Étant cryptés, ils ont besoin d&#39;un mot de passe pour se déverrouiller. Lorsque vous êtes invité à choisir un mot de passe, rendez-le fort (c&#39;est-à-dire long et aléatoire), sauvegardez-le et ne le partagez pas. Si vous n&#39;avez pas de gestionnaire de mots de passe, écrivez-le et conservez-le dans un endroit sûr et secret. Pour accéder à votre compte, vous avez besoin à la fois du fichier keystore et du mot de passe.</p>
</li>
<li class="data-line-80">
<p>Ne stockez aucun mot de passe dans des documents numériques, des photos numériques, des captures d&#39;écran, des lecteurs en ligne, des PDF cryptés, etc. Encore une fois, n&#39;improvisez pas la sécurité. Utilisez un gestionnaire de mots de passe ou un stylo et du papier.</p>
</li>
<li class="data-line-82">
<p>Lorsque vous êtes invité à sauvegarder une clé sous forme de séquence de mots mnémoniques, utilisez un stylo et du papier pour effectuer une sauvegarde physique. Ne laissez pas cette tâche &quot;pour plus tard&quot; ; vous oublierez. Ces sauvegardes peuvent être utilisées pour reconstruire votre clé privée au cas où vous perdriez toutes les données enregistrées sur votre système, ou si vous oubliez ou perdez votre mot de passe. Cependant, ils peuvent également être utilisés par des attaquants pour obtenir vos clés privées. Ne les stockez donc jamais sous forme numérique et conservez la copie physique en toute sécurité dans un tiroir ou un coffre-fort verrouillé.</p>
</li>
<li class="data-line-84">
<p>Avant de transférer des montants importants (en particulier vers de nouvelles adresses), effectuez d&#39;abord une petite transaction test (par exemple, une valeur inférieure à 1 $) et attendez la confirmation de réception.</p>
</li>
<li class="data-line-86">
<p>Lorsque vous créez un nouveau compte, commencez par n&#39;envoyer qu&#39;une petite transaction test à la nouvelle adresse. Une fois que vous avez reçu la transaction de test, essayez de renvoyer à partir de ce compte. Il existe de nombreuses raisons pour lesquelles la création d&#39;un compte peut mal tourner, et si cela a mal tourné, il vaut mieux le découvrir avec une petite perte. Si les tests fonctionnent, tout va bien.</p>
</li>
<li class="data-line-88">
<p>Les explorateurs de blocs publics sont un moyen simple de voir indépendamment si une transaction a été acceptée par le réseau. Cependant, cette commodité a un impact négatif sur votre vie privée, car vous révélez vos adresses pour bloquer les explorateurs, qui peuvent vous suivre.</p>
</li>
<li class="data-line-90">
<p>N&#39;envoyez pas d&#39;argent à l&#39;une des adresses indiquées dans ce livre. Les clés privées sont répertoriées dans le livre et quelqu&#39;un prendra immédiatement cet argent.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-92">
<p>Maintenant que nous avons couvert quelques bonnes pratiques de base pour la gestion des clés et la sécurité, passons au travail avec MetaMask !</p>
</div>
</div>
<div class="sect2 data-line-95">
<h3 id="installing_MetaMask">Premiers pas avec MetaMask</h3>
<div class="paragraph data-line-97">
<p>Ouvrez le navigateur Google Chrome et accédez à <a href="https://chrome.google.com/webstore/category/extensions" class="undefined" data-href="https://chrome.google.com/webstore/category/extensions">https://chrome.google.com/webstore/category/extensions</a>.</p>
</div>
<div class="paragraph data-line-99">
<p>Recherchez &quot;MetaMask&quot; et cliquez sur le logo d&#39;un renard. Vous devriez voir quelque chose comme le résultat affiché dans <a href="#metamask_download">La page de détail de l&#39;extension MetaMask Chrome</a>.</p>
</div>
<div id="metamask_download" class="imageblock data-line-103">
<div class="content">
<img src="images/metamask_download.png" alt="&quot;Page de détails du métamasque&quot;">
</div>
<div class="title">Figure 1. La page de détail de l&#39;extension MetaMask Chrome</div>
</div>
<div class="paragraph data-line-105">
<p>Il est important de vérifier que vous téléchargez la véritable extension MetaMask, car parfois les gens sont capables de passer furtivement des extensions malveillantes au-delà des filtres de Google. Le vrai:</p>
</div>
<div class="ulist data-line-107">
<ul>
<li class="data-line-107">
<p>Affiche l&#39;ID nkbihfbeogaeaoehlefnkodbefgpgknn dans la barre d&#39;adresse</p>
</li>
<li class="data-line-108">
<p>Est offert par <a href="https://metamask.io" class="undefined" data-href="https://metamask.io">https://metamask.io</a></p>
</li>
<li class="data-line-109">
<p>A plus de 1 500 avis</p>
</li>
<li class="data-line-110">
<p>A plus de 1 000 000 d&#39;utilisateurs</p>
</li>
</ul>
</div>
<div class="paragraph data-line-112">
<p>Une fois que vous avez confirmé que vous recherchez la bonne extension, cliquez sur &quot;Ajouter à Chrome&quot; pour l&#39;installer.</p>
</div>
<div class="sect3 data-line-115">
<h4 id="using_MetaMask">Création d&#39;un portefeuille</h4>
<div class="paragraph data-line-117">
<p>Une fois MetaMask installé, vous devriez voir une nouvelle icône (la tête d&#39;un renard) dans la barre d&#39;outils de votre navigateur. Cliquez dessus pour commencer. Il vous sera demandé d&#39;accepter les termes et conditions puis de créer votre nouveau portefeuille Ethereum en saisissant un mot de passe (voir <a href="#metamask_password">La page de mot de passe de l&#39;extension MetaMask Chrome</a>).</p>
</div>
<div id="metamask_password" class="imageblock data-line-121">
<div class="content">
<img src="images/metamask_password.png" alt="&quot;Page de mot de passe du métamasque&quot;">
</div>
<div class="title">Figure 2. La page de mot de passe de l&#39;extension MetaMask Chrome</div>
</div>
<div class="admonitionblock tip data-line-124">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-125">
<p>Le mot de passe contrôle l&#39;accès à MetaMask, de sorte qu&#39;il ne peut être utilisé par personne ayant accès à votre navigateur.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-128">
<p>Une fois que vous avez défini un mot de passe, MetaMask générera un portefeuille pour vous et vous montrera un <em>mnémonique de sauvegarde</em> composé de 12 mots anglais (voir <a href="#metamask_mnemonic">La sauvegarde mnémonique de votre portefeuille, créée par MetaMask</a>). Ces mots peuvent être utilisés dans n&#39;importe quel portefeuille compatible pour récupérer l&#39;accès à vos fonds si quelque chose arrivait à MetaMask ou à votre ordinateur. Vous n&#39;avez pas besoin du mot de passe pour cette récupération ; les 12 mots suffisent.</p>
</div>
<div class="admonitionblock tip data-line-131">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-132">
<p>Sauvegardez votre mnémonique (12 mots) sur papier, deux fois. Conservez les deux sauvegardes papier dans deux emplacements sécurisés distincts, tels qu&#39;un coffre-fort résistant au feu, un tiroir verrouillé ou un coffre-fort. Traitez les sauvegardes papier comme de l&#39;argent de valeur équivalente à ce que vous stockez dans votre portefeuille Ethereum. Toute personne ayant accès à ces mots peut y accéder et voler votre argent.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="metamask_mnemonic" class="imageblock data-line-137">
<div class="content">
<img src="images/metamask_mnemonic.png" alt="&quot;Page Mnémonique MetaMask&quot;">
</div>
<div class="title">Figure 3. La sauvegarde mnémonique de votre portefeuille, créée par MetaMask</div>
</div>
<div class="paragraph data-line-139">
<p>Une fois que vous avez confirmé que vous avez stocké le mnémonique en toute sécurité, vous pourrez voir les détails de votre compte Ethereum, comme indiqué dans <a href="#metamask_account">Votre compte Ethereum dans MetaMask</a>.</p>
</div>
<div id="metamask_account" class="imageblock data-line-143">
<div class="content">
<img src="images/metamask_account.png" alt="&quot;Page de compte MetaMask&quot;">
</div>
<div class="title">Figure 4. Votre compte Ethereum dans MetaMask</div>
</div>
<div class="paragraph data-line-145">
<p>La page de votre compte affiche le nom de votre compte (&quot;Account 1&quot; par défaut), une adresse Ethereum (0x9E713... dans l&#39;exemple), et une icône colorée pour vous aider à distinguer visuellement ce compte des autres comptes. En haut de la page du compte, vous pouvez voir sur quel réseau Ethereum vous travaillez actuellement (&quot;Main Network&quot; dans l&#39;exemple).</p>
</div>
<div class="paragraph data-line-147">
<p>Toutes nos félicitations! Vous avez configuré votre premier portefeuille Ethereum.</p>
</div>
</div>
<div class="sect3 data-line-150">
<h4 id="switching_networks">Changer le réseau</h4>
<div class="paragraph data-line-152">
<p>Comme vous pouvez le voir sur la page du compte MetaMask, vous pouvez choisir entre plusieurs réseaux Ethereum. Par défaut, MetaMask essaiera de se connecter au réseau principal. Les autres choix sont des réseaux de test publics, tout nœud Ethereum de votre choix ou des nœuds exécutant des chaînes de blocs privées sur votre propre ordinateur (localhost) :</p>
</div>
<div class="dlist data-line-154">
<dl>
<dt class="hdlist1">Réseau principal Ethereum</dt>
<dd>
<p>La principale chaîne de blocs publique Ethereum. Véritable ETH, valeur réelle et conséquences réelles.</p>
</dd>
<dt class="hdlist1">Réseau de test Ropsten</dt>
<dd>
<p>Chaîne de blocs et réseau de test public Ethereum. l&#8217;ETH sur ce réseau n&#39;a aucune valeur.</p>
</dd>
<dt class="hdlist1">Réseau de test Kovan</dt>
<dd>
<p>Chaîne de blocs et réseau de test public Ethereum utilisant le protocole de consensus Aura avec preuve d&#39;autorité (signature fédérée). ETH sur ce réseau n&#39;a aucune valeur. Le réseau de test Kovan est uniquement pris en charge par Parity. D&#39;autres clients Ethereum utilisent le protocole de consensus Clique, qui a été proposé plus tard, pour la preuve de la vérification basée sur l&#39;autorité.</p>
</dd>
<dt class="hdlist1">Réseau de test Rinkeby</dt>
<dd>
<p>Chaîne de blocs et réseau de test public Ethereum, utilisant le protocole de consensus Clique avec preuve d&#39;autorité (signature fédérée). ETH sur ce réseau n&#39;a aucune valeur.</p>
</dd>
<dt class="hdlist1">Localhost 8545</dt>
<dd>
<p>Se connecte à un nœud exécuté sur le même ordinateur que le navigateur. Le nœud peut faire partie de n&#39;importe quelle chaîne de blocs publique (principale ou testnet) ou d&#39;un testnet privé.</p>
</dd>
<dt class="hdlist1">RPC personnalisé</dt>
<dd>
<p>vous permet de connecter MetaMask à n&#39;importe quel nœud avec une interface d&#39;appel de procédure distante (RPC) compatible Geth. Le nœud peut faire partie de n&#39;importe quelle chaîne de blocs publique ou privée.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note data-line-167">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-168">
<p>Votre portefeuille MetaMask utilise la même clé privée et la même adresse Ethereum sur tous les réseaux auxquels il se connecte. Cependant, votre solde d&#39;adresses Ethereum sur chaque réseau Ethereum sera différent. Vos clés peuvent contrôler l&#39;éther et les contrats sur Ropsten, par exemple, mais pas sur le réseau principal.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-172">
<h4 id="getting_test_eth">Obtenir de l&#39;ether de test</h4>
<div class="paragraph data-line-174">
<p>Votre première tâche est de financer votre portefeuille. Vous ne ferez pas cela sur le réseau principal car l&#39;éther réel coûte de l&#39;argent et sa manipulation nécessite un peu plus d&#39;expérience. Pour l&#39;instant, vous allez charger votre portefeuille avec de l&#39;ether testnet.</p>
</div>
<div class="paragraph data-line-176">
<p>Passez MetaMask au <em>Réseau test Ropsten</em>. Cliquez sur Deposit, puis sur Ropsten Test Faucet. MetaMask ouvrira une nouvelle page Web, comme indiqué dans <a href="#metamask_ropsten_faucet">MetaMask et le robinet du réseau test Ropsten</a>.</p>
</div>
<div id="metamask_ropsten_faucet" class="imageblock data-line-180">
<div class="content">
<img src="images/metamask_ropsten_faucet.png" alt="&quot;MetaMask et le robinet du réseau test Ropsten&quot;">
</div>
<div class="title">Figure 5. MetaMask et le robinet du réseau test Ropsten</div>
</div>
<div class="paragraph data-line-182">
<p>Vous remarquerez peut-être que la page Web contient déjà l&#39;adresse Ethereum de votre portefeuille MetaMask. MetaMask intègre les pages Web compatibles Ethereum avec votre portefeuille MetaMask et peut &quot;voir&quot; les adresses Ethereum sur la page Web, vous permettant, par exemple, d&#39;envoyer un paiement à une boutique en ligne affichant une adresse Ethereum. MetaMask peut également remplir la page Web avec l&#39;adresse de votre propre portefeuille en tant qu&#39;adresse de destinataire si la page Web le demande. Sur cette page, l&#39;application du robinet demande à MetaMask une adresse de portefeuille à laquelle envoyer de l&#39;ether de test.</p>
</div>
<div class="paragraph data-line-184">
<p>Cliquez sur le bouton vert &quot;demander 1 éther au robinet&quot;. Vous verrez un ID de transaction apparaître dans la partie inférieure de la page. L&#39;application robinet ou "faucet" a créé une transaction, un paiement qui vous est destiné. L&#39;ID de transaction ressemble à ceci :</p>
</div>
<div id="faucet_tx_id" class="listingblock data-line-187">
<div class="content">
<pre>0x7c7ad5aaea6474adccf6f5c5d6abed11b70a350fbc6f9590109e099568090c57</pre>
</div>
</div>
<div class="paragraph data-line-191">
<p>Dans quelques secondes, la nouvelle transaction sera exploitée par les mineurs de Ropsten et votre portefeuille MetaMask affichera un solde de 1 ETH. Cliquez sur l&#39;ID de transaction et votre navigateur vous amènera à un <em>explorateur de bloc</em>, qui est un site Web qui vous permet de visualiser et d&#39;explorer des blocs, des adresses et des transactions. MetaMask utilise <a href="https://etherscan.io/" data-href="https://etherscan.io/">Explorateur de blocs Etherscan</a>, l&#39;un des explorateurs de blocs Ethereum les plus populaires. La transaction contenant le paiement du Ropsten Test Faucet est affichée dans <a href="#ropsten_block_explorer">Explorateur de blocs Ropsten sur Etherscan</a>.</p>
</div>
<div id="ropsten_block_explorer" class="imageblock data-line-195">
<div class="content">
<img src="images/ropsten_block_explorer.png" alt="&quot;Explorateur de blocs Ropsten sur Etherscan&quot;">
</div>
<div class="title">Figure 6. Explorateur de blocs Ropsten sur Etherscan</div>
</div>
<div class="paragraph data-line-197">
<p>La transaction a été enregistrée sur la chaîne de blocs Ropsten et peut être consultée à tout moment par n&#39;importe qui, simplement en recherchant l&#39;ID de transaction, ou <a href="http://bit.ly/2Q860Wk" data-href="http://bit.ly/2Q860Wk">en visitant le lien</a>.</p>
</div>
<div class="paragraph data-line-199">
<p>Essayez de visiter ce lien ou de saisir le hachage de la transaction sur le site Web <em>ropsten.etherscan.io</em> pour le voir par vous-même.</p>
</div>
</div>
<div class="sect3 data-line-202">
<h4 id="sending_eth_MetaMask">Envoi d&#39;ether depuis MetaMask</h4>
<div class="paragraph data-line-204">
<p>Une fois que vous avez reçu votre premier test d&#39;ether du Ropsten Test Faucet, vous pouvez expérimenter l&#39;envoi d&#39;ether en essayant d&#39;en renvoyer au robinet. Comme vous pouvez le voir sur la page Ropsten Test Faucet, il existe une option pour &quot;donner&quot; 1 ETH au robinet. Cette option est disponible pour qu&#39;une fois que vous avez terminé les tests, vous puissiez retourner le reste de votre ether de test, afin que quelqu&#39;un d&#39;autre puisse l&#39;utiliser ensuite. Même si l&#39;ether de test n&#39;a aucune valeur, certaines personnes l&#8217;accumulent, ce qui rend difficile pour tout le monde d&#39;utiliser les réseaux de test. L&#8217;accumulation de l&#39;ether de test est mal vue !</p>
</div>
<div class="paragraph data-line-206">
<p>Heureusement, nous ne sommes pas des accumulateurs d&#39;éther de test. Cliquez sur le bouton orange &quot;1 ether&quot; pour dire à MetaMask de créer une transaction payant le robinet 1 ether. MetaMask préparera une transaction et ouvrira une fenêtre avec la confirmation, comme indiqué dans <a href="#send_to_faucet">Envoi de 1 éther au robinet</a>.</p>
</div>
<div id="send_to_faucet" class="imageblock data-line-211">
<div class="content">
<img src="images/send_to_faucet.png" alt="&quot;Envoi d&#39;1 ether au robinet&quot;">
</div>
<div class="title">Figure 7. Envoi de 1 éther au robinet</div>
</div>
<div class="paragraph data-line-213">
<p>Oups! Vous avez probablement remarqué que vous ne pouvez pas terminer la transaction - MetaMask indique que vous avez un solde insuffisant. À première vue, cela peut sembler déroutant : vous avez 1 ETH, vous voulez envoyer 1 ETH, alors pourquoi MetaMask dit-il que vous avez des fonds insuffisants ?</p>
</div>
<div class="paragraph data-line-215">
<p>La réponse est à cause du coût de <em>gaz</em>. Chaque transaction Ethereum nécessite le paiement d&#39;une redevance, qui est perçue par les mineurs pour valider la transaction. Les frais d&#39;Ethereum sont facturés dans une monnaie virtuelle appelée gaz. Vous payez le gaz avec de l&#39;ether, dans le cadre de la transaction.</p>
</div>
<div class="admonitionblock note data-line-218">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-219">
<p>Des frais sont également exigés sur les réseaux de test. Sans frais, un réseau de test se comporterait différemment du réseau principal, ce qui en ferait une plate-forme de test inadéquate. Les frais protègent également les réseaux de test des attaques DoS et des contrats mal construits (par exemple, des boucles infinies), tout comme ils protègent le réseau principal.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-222">
<p>Lorsque vous avez envoyé la transaction, MetaMask a calculé le prix moyen du gaz des récentes transactions réussies à 3 gwei, ce qui signifie gigawei. Wei est la plus petite <span class="keep-together">subdivision</span> de la monnaie ether, comme nous l&#39;avons vu dans <a href="#ether_units">L&#8217;ether comme unité monétaire</a>. La limite de gaz est fixée au prix de l&#39;envoi d&#39;une transaction de base, soit 21 000 unités de gaz. Par conséquent, le montant maximum d&#39;ETH que vous dépenserez est de 3 * 21 000 gwei = 63 000 gwei = 0,000063 ETH. (Sachez que les prix moyens du gaz peuvent fluctuer, car ils sont principalement déterminés par les mineurs. Nous verrons dans un chapitre ultérieur comment vous pouvez augmenter/diminuer votre limite de gaz pour vous assurer que votre transaction a la priorité si nécessaire.)</p>
</div>
<div class="paragraph data-line-224">
<p>Tout cela pour dire : faire une transaction à 1 ETH coûte 1,000063 ETH. MetaMask arrondit de manière confuse au <em>plancher</em> d'1 ETH lors de l&#39;affichage du total, mais le montant réel dont vous avez besoin est de 1,000063 ETH et vous n&#39;avez que 1 ETH. Cliquez sur Reject pour annuler cette transaction.</p>
</div>
<div class="paragraph data-line-226">
<p>Prenons un peu plus d&#39;ether de test ! Cliquez à nouveau sur le bouton vert &quot;request 1 ether from the faucet&quot; et attendez quelques secondes. Ne vous inquiétez pas, le robinet devrait avoir beaucoup d&#39;ether et vous en donnera plus si vous le demandez.</p>
</div>
<div class="paragraph data-line-228">
<p>Une fois que vous avez un solde de 2 ETH, vous pouvez réessayer. Cette fois, lorsque vous cliquez sur le bouton de don orange &quot;1 ether&quot;, vous disposez d&#39;un solde suffisant pour finaliser la transaction. Cliquez sur Soumettre lorsque MetaMask apparaît dans la fenêtre de paiement. Après tout cela, vous devriez voir un solde de 0,999937 ETH car vous avez envoyé 1 ETH au robinet avec 0,000063 ETH en gaz.</p>
</div>
</div>
<div class="sect3 data-line-231">
<h4 id="explore_tx_history">Explorer l&#39;historique des transactions d&#39;une adresse</h4>
<div class="paragraph data-line-233">
<p>Vous êtes maintenant devenu un expert dans l&#39;utilisation de MetaMask pour envoyer et recevoir de l&#39;ether de test. Votre portefeuille a reçu au moins deux paiements et en a envoyé au moins un. Vous pouvez afficher toutes ces transactions à l&#39;aide de l&#39;explorateur de blocs <em>ropsten.etherscan.io</em>. Vous pouvez soit copier l&#39;adresse de votre portefeuille et la coller dans la zone de recherche de l&#39;explorateur de blocs, soit demander à MetaMask d&#39;ouvrir la page pour vous. À côté de l&#39;icône de votre compte dans MetaMask, vous verrez un bouton affichant trois points. Cliquez dessus pour afficher un menu d&#39;options liées au compte (voir <a href="#metamask_account_context_menu">Menu contextuel du compte MetaMask</a>).</p>
</div>
<div id="metamask_account_context_menu" class="imageblock data-line-237">
<div class="content">
<img src="images/metamask_account_context_menu.png" alt="&quot;Menu contextuel du compte MetaMask&quot;">
</div>
<div class="title">Figure 8. Menu contextuel du compte MetaMask</div>
</div>
<div class="paragraph data-line-239">
<p>Sélectionnez &quot;View account on Etherscan&quot; pour ouvrir une page Web dans l&#39;explorateur de blocs affichant l&#39;historique des transactions de votre compte, comme indiqué dans <a href="#block_explorer_account_history">Historique des transactions d&#8217;une adresse sur Etherscan</a>.</p>
</div>
<div id="block_explorer_account_history" class="imageblock data-line-243">
<div class="content">
<img src="images/block_explorer_account_history.png" alt="&quot;Historique des transactions d&#39;adresses sur Etherscan&quot;">
</div>
<div class="title">Figure 9. Historique des transactions d&#8217;une adresse sur Etherscan</div>
</div>
<div class="paragraph data-line-245">
<p>Ici, vous pouvez voir l&#39;historique complet des transactions de votre adresse Ethereum. Il montre toutes les transactions enregistrées sur la chaîne de blocs Ropsten où votre adresse est l&#39;expéditeur ou le destinataire. Cliquez sur quelques-unes de ces transactions pour voir plus de détails.</p>
</div>
<div class="paragraph data-line-247">
<p>Vous pouvez explorer l&#39;historique des transactions de n&#39;importe quelle adresse. Jetez un œil à l&#39;historique des transactions de l&#39;adresse Ropsten Test Faucet (indice : il s&#39;agit de l&#39;adresse « expéditeur » répertoriée dans le plus ancien paiement à votre adresse). Vous pouvez voir tout l&#39;ether de test envoyé par le robinet à vous et à d&#39;autres adresses. Chaque transaction que vous voyez peut vous mener à plus d&#39;adresses et plus de transactions. D&#39;ici peu, vous serez perdu dans le labyrinthe de données interconnectées. Les chaînes de blocs publiques contiennent une énorme richesse d&#39;informations, qui peuvent toutes être explorées par programmation, comme nous le verrons dans de futurs exemples.</p>
</div>
</div>
</div>
<div class="sect2 data-line-250">
<h3 id="intro_world_computer">Présentation de l&#39;ordinateur mondial</h3>
<div class="paragraph data-line-252">
<p> Vous avez maintenant créé un portefeuille et envoyé et reçu de l&#39;ether. Jusqu&#39;à présent, nous avons traité Ethereum comme une cryptomonnaie. Mais Ethereum est bien plus que cela. En fait, la fonction de cryptomonnaie est subordonnée à la fonction d&#39;Ethereum en tant qu&#39;ordinateur mondial décentralisé. L&#8217;ether est destiné à être utilisé pour payer l&#39;exécution de <em>contrats intelligents</em> aussi, qui sont des programmes informatiques qui s&#39;exécutent sur un ordinateur émulé appelé <em>Ethereum Virtual Machine</em> (EVM).</p>
</div>
<div class="paragraph data-line-254">
<p>L&#39;EVM est un singleton global, ce qui signifie qu&#39;il fonctionne comme s&#39;il s&#39;agissait d&#39;un ordinateur global à instance unique, fonctionnant partout. Chaque nœud du réseau Ethereum exécute une copie locale de l&#39;EVM pour valider l&#39;exécution du contrat, tandis que la blockchain Ethereum enregistre l&#39;état changeant de cet ordinateur mondial lorsqu&#39;il traite les transactions et les contrats intelligents. Nous en discuterons plus en détail dans <a href="#evm_chapter">La machine virtuelle Ethereum</a>.</p>
</div>
</div>
<div class="sect2 data-line-257">
<h3 id="EOA_contracts">Comptes détenus en externe (EOA ou Externally Owned Accounts) et contrats</h3>
<div class="paragraph data-line-259">
<p>Le type de compte que vous avez créé dans le portefeuille MetaMask est appelé un <em>compte détenu par une personne externe</em> (EOA ou Externally Owned Accounts). Les comptes détenus en externe sont ceux qui ont une clé privée ; avoir la clé privée signifie contrôler l&#39;accès aux fonds ou aux contrats. Maintenant, vous devinez probablement qu&#39;il existe un autre type de compte. Cet autre type de compte est un <em>compte de contrat</em>. Un compte de contrat a un code de contrat intelligent, ce qu&#39;un simple EOA ne peut pas avoir. De plus, un compte contractuel ne possède pas de clé privée. Au lieu de cela, il est détenu (et contrôlé) par la logique de son code de contrat intelligent : le programme logiciel enregistré sur la blockchain Ethereum lors de la création du compte de contrat et exécuté par l&#39;EVM.</p>
</div>
<div class="paragraph data-line-261">
<p>Les contrats ont des adresses, tout comme les EOA. Les contrats peuvent également envoyer et recevoir de l&#39;ether, tout comme les EOA. Cependant, lorsqu&#39;une destination de transaction est une adresse de contrat, cela provoque l&#39;exécution de ce contrat dans l&#39;EVM, en utilisant la transaction et les données de la transaction comme entrée. En plus d&#39;ether, les transactions peuvent contenir des <em>données</em> indiquant quelle fonction spécifique du contrat exécuter et quels paramètres transmettre à cette fonction. De cette façon, les transactions peuvent <em>appeler</em> des fonctions dans les contrats.</p>
</div>
<div class="paragraph data-line-263">
<p>Notez qu&#39;étant donné qu&#39;un compte de contrat n&#39;a pas de clé privée, il ne peut pas <em>initier</em> une transaction. Seuls les EOA peuvent initier des transactions, mais les contrats peuvent <em>réagir</em> aux transactions en appelant d&#39;autres contrats, en créant des chemins d&#39;exécution complexes. Une utilisation typique de ceci est un EOA envoyant une transaction de demande à un portefeuille de contrats intelligents multisignatures pour envoyer des ETH à une autre adresse. Un modèle de programmation DApp typique consiste à ce que le contrat A appelle le contrat B afin de maintenir un état partagé entre les utilisateurs du contrat A.</p>
</div>
<div class="paragraph data-line-265">
<p>Dans les prochaines sections, nous rédigerons notre premier contrat. Vous apprendrez ensuite comment créer, financer et utiliser ce contrat avec votre portefeuille MetaMask et tester l&#39;éther sur le réseau de test Ropsten.</p>
</div>
</div>
<div class="sect2 data-line-268">
<h3 id="exemple_contrat_simple">Un contrat simple : un robinet test d&#8217;ether</h3>
<div class="paragraph data-line-270">
<p> Ethereum possède de nombreux langages de haut niveau différents, qui peuvent tous être utilisés pour écrire un contrat et produire un code intermédiaire ou bytecode EVM. Vous pouvez lire sur bon nombre des plus importantes et des plus intéressantes dans <a href="#high_level_languages">Introduction to Ethereum High-Level Languages</a>. Un langage de haut niveau est de loin le choix dominant pour la programmation de contrats intelligents : Solidity. Solidity a été créé par le Dr Gavin Wood, le co-auteur de ce livre, et est devenu le langage le plus largement utilisé dans Ethereum (et au-delà). Nous utiliserons Solidity pour rédiger notre premier contrat.</p>
</div>
<div class="paragraph data-line-272">
<p>Pour notre premier exemple (<a href="#solidity_faucet_example">Faucet.sol: Un contrat Solidity mettant en place un robinet</a>), nous allons écrire un contrat qui contrôle un <em>robinet</em>. Vous avez déjà utilisé un robinet pour obtenir de l&#39;ether de test sur le réseau de test de Ropsten. Un robinet est une chose relativement simple: il donne de l&#39;ether à toute adresse qui le demande et peut être rempli périodiquement. Vous pouvez implémenter un robinet comme un portefeuille contrôlé par un humain ou un serveur Web.</p>
</div>
<div id="solidity_faucet_example" class="exampleblock data-line-276">
<div class="title">Example 1. Faucet.sol: Un contrat Solidity mettant en place un robinet</div>
<div class="content">
<div class="listingblock data-line-278">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// SPDX-License-Identifier: CC-BY-SA-4.0

// Version of Solidity compiler this program was written for
pragma solidity 0.6.4;

// Our first contract is a faucet!
contract Faucet {
    // Accept any incoming amount
    receive() external payable {}

    // Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        // Limit withdrawal amount
        require(withdraw_amount &lt;= 100000000000000000);

        // Send the amount to the address that requested it
        msg.sender.transfer(withdraw_amount);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note data-line-284">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-285">
<p>Vous trouverez tous les exemples de code pour ce livre dans le sous-répertoire <em>code</em> de <a href="https://github.com/ethereumbook/ethereumbook/" data-href="https://github.com/ethereumbook/ethereumbook/">le référentiel GitHub du livre</a>. Concrètement, notre contrat <em>Faucet.sol</em> est en:</p>
</div>
<div class="listingblock data-line-287">
<div class="content">
<pre>code/Solidity/Faucet.sol</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-292">
<p>Il s&#39;agit d&#39;un contrat très simple, à peu près aussi simple que possible. Il s&#39;agit également d&#39;un contrat <em>faussé</em>, démontrant un certain nombre de mauvaises pratiques et de failles de sécurité. Nous apprendrons en examinant tous ses défauts dans les sections suivantes. Mais pour l&#39;instant, regardons ce que fait ce contrat et comment il fonctionne, ligne par ligne. Vous remarquerez rapidement que de nombreux éléments de Solidity sont similaires aux langages de programmation existants, tels que JavaScript, Java ou C++.</p>
</div>
<div class="paragraph data-line-294">
<p>La première ligne est un commentaire :</p>
</div>
<div id="comment" class="listingblock data-line-298">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Notre premier contrat est un robinet (faucet) !</code></pre>
</div>
</div>
<div class="paragraph data-line-302">
<p>Les commentaires sont destinés à être lus par des humains et ne sont pas inclus dans le code intermédiaire exécutable de l&#8217;EVM. Nous les plaçons généralement sur la ligne avant le code que nous essayons d&#39;expliquer, ou parfois sur la même ligne. Les commentaires commencent par deux barres obliques : //. Tout, depuis la première barre oblique jusqu&#39;à la fin de cette ligne, est traité comme une ligne vide et ignoré.</p>
</div>
<div class="paragraph data-line-304">
<p>La ligne suivante est l&#39;endroit où notre contrat réel commence :</p>
</div>
<div id="contract_definition" class="listingblock data-line-308">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Faucet {</code></pre>
</div>
</div>
<div class="paragraph data-line-312">
<p>Cette ligne déclare un objet contract, similaire à une déclaration class dans d&#39;autres langages orientés objet. La définition du contrat inclut toutes les lignes entre les accolades (<code>{}</code>), qui définissent une <em>portée</em>, un peu comme la façon dont les accolades sont utilisées dans de nombreux autres langages de programmation.</p>
</div>
<div class="paragraph data-line-314">
<p>Ensuite, nous déclarons la première fonction du contrat Faucet :</p>
</div>
<div id="withdraw_function" class="listingblock data-line-318">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function withdraw(uint withdraw_amount) public {</code></pre>
</div>
</div>
<div class="paragraph data-line-322">
<p>La fonction est nommée withdraw, et elle prend un argument entier non signé (uint) nommé withdraw_amount. Elle est déclarée fonction publique, c&#39;est-à-dire qu&#39;elle peut être appelée par d&#39;autres contrats. La définition de la fonction suit, entre accolades. La première partie de la fonction retirer fixe une limite aux retraits :</p>
</div>
<div id="withdraw_limit" class="listingblock data-line-326">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">require(withdraw_amount &lt;= 100000000000000000);</code></pre>
</div>
</div>
<div class="paragraph data-line-330">
<p>Il utilise la fonction intégrée Solidity require pour tester une condition préalable, que le withdraw_amount est inférieur ou égal à 100 000 000 000 000 000 wei, qui est l&#39;unité de base de l&#39;ether (voir <a href="#ether_denominations">Dénominations d&#8217;ether et noms d&#39;unités</a>) et équivalent à 0,1 ether. Si la fonction withdraw est appelée avec un withdraw_amount supérieur à ce montant, la fonction require provoquera ici l&#39;arrêt et l&#39;échec de l&#39;exécution du contrat avec une <em>exception</em>. Notez que les instructions doivent se terminer par un point-virgule dans Solidity.</p>
</div>
<div class="paragraph data-line-332">
<p>Cette partie du contrat est la logique principale de notre robinet. Il contrôle le flux de fonds hors du contrat en imposant une limite aux retraits. C&#39;est un contrôle très simple mais qui peut vous donner un aperçu de la puissance d&#39;une chaîne de blocs programmable : un logiciel décentralisé contrôlant l&#39;argent.</p>
</div>
<div class="paragraph data-line-334">
<p>Vient ensuite le retrait proprement dit :</p>
</div>
<div id="withdraw_command" class="listingblock data-line-338">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">msg.sender.transfer(withdraw_amount);</code></pre>
</div>
</div>
<div class="paragraph data-line-342">
<p>Quelques choses intéressantes se passent ici. L&#39;objet msg est l&#39;une des entrées auxquelles tous les contrats peuvent accéder. Il représente la transaction qui a déclenché l&#39;exécution de ce contrat. L&#39;attribut sender est l&#39;adresse de l&#39;expéditeur de la transaction. La fonction transfer est une fonction intégrée qui transfère l&#39;ether du contrat actuel à l&#39;adresse de l&#39;expéditeur. En le lisant à l&#39;envers, cela signifie transfert vers l&#39;+expéditeur+ du msg qui a déclenché l&#39;exécution de ce contrat. La fonction transfer prend un montant comme seul argument. Nous passons la valeur withdraw_amount qui était le paramètre à la fonction withdraw déclarée quelques lignes plus tôt.</p>
</div>
<div class="paragraph data-line-344">
<p>La ligne suivante est l&#39;accolade fermante, indiquant la fin de la définition de notre fonction withdraw.</p>
</div>
<div class="paragraph data-line-346">
<p>Ensuite, nous déclarons une autre fonction :</p>
</div>
<div id="fallback_function" class="listingblock data-line-350">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function () external payable {}</code></pre>
</div>
</div>
<div class="paragraph data-line-354">
<p>Cette fonction est une fonction dite de <em>secours</em> ou de <em>fallback</em> (ou <em>default</em>), qui est appelée si la transaction qui a déclenché le contrat n&#39;a nommé aucune des fonctions déclarées dans le contrat, ou aucune fonction du tout , ou ne contenait pas de données. Les contrats peuvent avoir une telle fonction par défaut (sans nom) et c&#39;est généralement celle qui reçoit l&#39;ether. C&#39;est pourquoi il est défini comme une fonction externe et payante, ce qui signifie qu&#39;il peut accepter de l&#39;ether dans le contrat. Il ne fait rien d&#39;autre que d&#39;accepter l&#39;ether, comme indiqué par la définition vide entre les accolades (<code>{}</code>). Si nous effectuons une transaction qui envoie de l&#39;ether à l&#39;adresse du contrat, comme s&#39;il s&#39;agissait d&#39;un portefeuille, cette fonction s&#39;en chargera.</p>
</div>
<div class="paragraph data-line-356">
<p>Juste en dessous de notre fonction par défaut se trouve l&#39;accolade fermante finale, qui ferme la définition du contrat Faucet. C&#39;est tout !</p>
</div>
</div>
<div class="sect2 data-line-359">
<h3 id="compile_faucet_contract">Compilation du contrat de robinet</h3>
<div class="paragraph data-line-361">
<p>Maintenant que nous avons notre premier exemple de contrat, nous devons utiliser un compilateur Solidity pour convertir le code Solidity en code intermédiaire/bytecode EVM afin qu&#39;il puisse être exécuté par l&#39;EVM sur la chaîne de blocs elle-même .</p>
</div>
<div class="paragraph data-line-363">
<p>Le compilateur Solidity se présente sous la forme d&#39;un exécutable autonome, dans le cadre de divers frameworks, et regroupé dans des environnements de développement intégrés (IDE). Pour garder les choses simples, nous utiliserons l&#39;un des IDE les plus populaires, appelé <em>Remix</em>.</p>
</div>
<div class="paragraph data-line-365">
<p>Utilisez votre navigateur Chrome (avec le portefeuille MetaMask que vous avez installé précédemment) pour accéder à l&#39;IDE Remix à l&#39;adresse <a href="https://remix.ethereum.org" class="undefined" data-href="https://remix.ethereum.org">https://remix.ethereum.org</a>.</p>
</div>
<div class="paragraph data-line-367">
<p>Lorsque vous chargez Remix pour la première fois, il démarre avec un exemple de contrat appelé <em>ballot.sol</em>. Nous n&#39;en avons pas besoin, alors fermez-le en cliquant sur le x dans le coin de l&#39;onglet, comme indiqué dans <a href="#remix_close_tab">Fermer l&#39;onglet d&#39;exemple par défaut</a>.</p>
</div>
<div id="remix_close_tab" class="imageblock data-line-371">
<div class="content">
<img src="images/remix_close_tab.png" alt="&quot;Fermer l&#39;onglet d&#39;exemple par défaut&quot;">
</div>
<div class="title">Figure 10. Fermer l&#39;onglet d&#39;exemple par défaut</div>
</div>
<div class="paragraph data-line-373">
<p>Maintenant, ajoutez un nouvel onglet en cliquant sur le signe plus circulaire dans la barre d&#39;outils en haut à gauche, comme indiqué dans <a href="#remix_toolbar">Cliquez sur le signe plus pour ouvrir un nouvel onglet</a>. Nommez le nouveau fichier <em>Faucet.sol</em>.</p>
</div>
<div id="remix_toolbar" class="imageblock data-line-377">
<div class="content">
<img src="images/remix_toolbar.png" alt="&quot;Cliquez sur le signe plus pour ouvrir un nouvel onglet&quot;">
</div>
<div class="title">Figure 11. Cliquez sur le signe plus pour ouvrir un nouvel onglet</div>
</div>
<div class="paragraph data-line-379">
<p>Une fois que vous avez ouvert le nouvel onglet, copiez et collez le code de notre exemple <em>Faucet.sol</em>, comme indiqué dans <a href="#remix_faucet_load">Copiez l&#39;exemple de code Faucet dans le nouvel onglet</a>.</p>
</div>
<div id="remix_faucet_load" class="imageblock data-line-383">
<div class="content">
<img src="images/remix_faucet_load.png" alt="&quot;Copiez l&#39;exemple de code Faucet dans le nouvel onglet&quot;">
</div>
<div class="title">Figure 12. Copiez l&#39;exemple de code Faucet dans le nouvel onglet</div>
</div>
<div class="paragraph data-line-385">
<p>Une fois que vous avez chargé le contrat <em>Faucet.sol</em> dans l&#39;IDE Remix, l&#39;IDE compilera automatiquement le code. Si tout se passe bien, vous verrez une boîte verte avec &quot;Faucet&quot; dedans apparaître à droite, sous l&#39;onglet Compiler, confirmant la compilation réussie (voir <a href="#remix_compile">Remix compile avec succès le contrat Faucet.sol</a>).</p>
</div>
<div id="remix_compile" class="imageblock data-line-389">
<div class="content">
<img src="images/remix_compile.png" alt="&quot;&quot;">
</div>
<div class="title">Figure 13. Remix compile avec succès le contrat Faucet.sol</div>
</div>
<div class="paragraph data-line-391">
<p>Si quelque chose ne va pas, le problème le plus probable est que l&#39;IDE Remix utilise une version du compilateur Solidity différente de 0.5.12. Dans ce cas, notre directive pragma empêchera <em>Faucet.sol</em> de se compiler. Pour modifier la version du compilateur, accédez à l&#39;onglet Paramètres, définissez la version sur 0.5.12 et réessayez.</p>
</div>
<div class="paragraph data-line-393">
<p>Le compilateur Solidity a maintenant compilé notre <em>Faucet.sol</em> en code intermédiaire EVM. Si vous êtes curieux, le code intermédiaire ressemble à ceci :</p>
</div>
<div id="faucet_bytecode" class="listingblock data-line-396">
<div class="content">
<pre>PUSH1 0x60 PUSH1 0x40 MSTORE CALLVALUE ISZERO PUSH2 0xF JUMPI PUSH1 0x0 DUP1
REVERT JUMPDEST PUSH1 0xE5 DUP1 PUSH2 0x1D PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN
STOP PUSH1 0x60 PUSH1 0x40 MSTORE PUSH1 0x4 CALLDATASIZE LT PUSH1 0x3F JUMPI
PUSH1 0x0 CALLDATALOAD PUSH29
0x100000000000000000000000000000000000000000000000000000000
SWAP1 DIV PUSH4 0xFFFFFFFF AND DUP1 PUSH4 0x2E1A7D4D EQ PUSH1 0x41 JUMPI
JUMPDEST STOP JUMPDEST CALLVALUE ISZERO PUSH1 0x4B JUMPI PUSH1 0x0 DUP1 REVERT
JUMPDEST PUSH1 0x5F PUSH1 0x4 DUP1 DUP1 CALLDATALOAD SWAP1 PUSH1 0x20 ADD SWAP1
SWAP2 SWAP1 POP POP PUSH1 0x61 JUMP JUMPDEST STOP JUMPDEST PUSH8
0x16345785D8A0000 DUP2 GT ISZERO ISZERO ISZERO PUSH1 0x77 JUMPI PUSH1 0x0 DUP1
REVERT JUMPDEST CALLER PUSH20 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND
PUSH2 0x8FC DUP3 SWAP1 DUP2 ISZERO MUL SWAP1 PUSH1 0x40 MLOAD PUSH1 0x0 PUSH1
0x40 MLOAD DUP1 DUP4 SUB DUP2 DUP6 DUP9 DUP9 CALL SWAP4 POP POP POP POP ISZERO
ISZERO PUSH1 0xB6 JUMPI PUSH1 0x0 DUP1 REVERT JUMPDEST POP JUMP STOP LOG1 PUSH6
0x627A7A723058 KECCAK256 PUSH9 0x13D1EA839A4438EF75 GASLIMIT CALLVALUE LOG4 0x5f
PUSH24 0x7541F409787592C988A079407FB28B4AD000290000000000</pre>
</div>
</div>
<div class="paragraph data-line-415">
<p>N&#39;êtes-vous pas content d&#39;utiliser un langage de haut niveau comme Solidity au lieu de programmer directement en code intermédiaire EVM ? Moi aussi !</p>
</div>
</div>
<div class="sect2 data-line-418">
<h3 id="create_contract">Création du contrat sur la chaîne de blocs</h3>
<div class="paragraph data-line-420">
<p>Donc, nous avons un contrat. Nous l&#39;avons compilé en code intermédiaire. Maintenant, nous devons &quot;enregistrer&quot; le contrat sur la chaîne de blocs Ethereum. Nous utiliserons le testnet de Ropsten pour tester notre contrat, c&#39;est donc la chaîne de blocs à laquelle nous voulons le soumettre.</p>
</div>
<div class="paragraph data-line-422">
<p>L&#39;enregistrement d&#39;un contrat sur la chaîne de blocs implique la création d&#39;une transaction spéciale dont la destination est l&#39;adresse 0x00000000000000000000000000000000000000, également appelée <em>zero address</em> ou l'<em>adresse zéro</em>. L&#39;adresse zéro est une adresse spéciale qui indique à la chaîne de blocs Ethereum que vous souhaitez enregistrer un contrat. Heureusement, l&#39;IDE Remix s&#39;occupera de tout cela pour vous et enverra la transaction à MetaMask.</p>
</div>
<div class="paragraph data-line-424">
<p>Tout d&#39;abord, passez à l&#39;onglet Run et sélectionnez Injected Web3 dans la zone de sélection déroulante Environment. Cela connecte l&#39;IDE Remix au portefeuille MetaMask et, via MetaMask, au réseau de test Ropsten. Une fois que vous faites cela, vous pouvez voir Ropsten sous Environment. De plus, dans la zone de sélection du compte, il indique l&#39;adresse de votre portefeuille (voir <a href="#remix_run">Onglet Run du IDE Remix, avec l&#39;environnement Injected Web3 sélectionné</a>).</p>
</div>
<div id="remix_run" class="imageblock data-line-428">
<div class="content">
<img src="images/remix_run.png" alt="&quot;Onglet Run du IDE Remix" width="avec l&#39;environnement Injected Web3 sélectionné&quot;">
</div>
<div class="title">Figure 14. Onglet Run du IDE Remix, avec l&#39;environnement Injected Web3 sélectionné</div>
</div>
<div class="paragraph data-line-430">
<p>Juste en dessous des paramètres d&#39;exécution que vous venez de confirmer se trouve le contrat Faucet, prêt à être créé. Cliquez sur le bouton Deploy affiché dans <a href="#remix_run">Onglet Run du IDE Remix, avec l&#39;environnement Injected Web3 sélectionné</a>.</p>
</div>
<div class="paragraph data-line-432">
<p>Remix construira la transaction spéciale &quot;création&quot; et MetaMask vous demandera de l&#39;approuver, comme indiqué dans <a href="#remix_metamask_create">MetaMask montrant la transaction de création de contrat</a>. Vous remarquerez que la transaction de création de contrat ne contient pas d&#39;ether, mais qu&#39;elle contient 262 octets de données (le contrat compilé) et consommera 10 gwei en gaz. Cliquez sur Soumettre pour l&#39;approuver.</p>
</div>
<div id="remix_metamask_create" class="imageblock data-line-436">
<div class="content">
<img src="images/remix_metamask_create.png" alt="&quot;MetaMask montrant la transaction de création de contrat&quot;">
</div>
<div class="title">Figure 15. MetaMask montrant la transaction de création de contrat</div>
</div>
<div class="paragraph data-line-438">
<p>Maintenant, vous devez attendre. Il faudra environ 15 à 30 secondes pour que le contrat soit miné sur Ropsten. Remix ne semblera pas faire grand-chose, mais soyez patient.</p>
</div>
<div class="paragraph data-line-440">
<p>Une fois le contrat créé, il apparaît en bas de l&#39;onglet Run (voir <a href="#remix_contract_interact">Le contrat Faucet est VIVANT !</a>).</p>
</div>
<div id="remix_contract_interact" class="imageblock data-line-444">
<div class="content">
<img src="images/remix_contract_interact.png" alt="&quot;Le contrat Faucet est VIVANT !&quot;">
</div>
<div class="title">Figure 16. Le contrat Faucet est VIVANT !</div>
</div>
<div class="paragraph data-line-446">
<p>Notez que le contrat Faucet a maintenant sa propre adresse : Remix l&#39;affiche comme &quot;Faucet à 0x72e&#8230;&#8203;c7829&quot; (bien que votre adresse, les lettres et les chiffres aléatoires, soient différents). Le petit symbole de presse-papiers à droite vous permet de copier l&#39;adresse du contrat dans votre presse-papiers. Nous l&#39;utiliserons dans la section suivante.</p>
</div>
</div>
<div class="sect2 data-line-449">
<h3 id="interact_contract">Interagir avec le contrat</h3>
<div class="paragraph data-line-451">
<p>Récapitulons ce que nous avons appris jusqu&#39;à présent : les contrats Ethereum sont des programmes qui contrôler l&#39;argent, qui s&#39;exécutent à l&#39;intérieur d&#39;une machine virtuelle appelée EVM. Ils sont créés par une transaction spéciale qui soumet leur code intermédiaire à enregistrer sur la chaîne de blocs. Une fois créés sur la chaîne de blocs, ils ont une adresse Ethereum, tout comme les portefeuilles. Chaque fois que quelqu&#39;un envoie une transaction à une adresse de contrat, le contrat s&#39;exécute dans l&#39;EVM, avec la transaction en entrée. Transactions envoyées pour les adresses de  <span class="keep-together">contrat</span> peuvent contenir de l&#39;ether ou des données ou les deux. S&#39;ils contiennent de l&#39;ether, il est &quot;déposé&quot; sur le solde du contrat. S&#39;ils contiennent des données, les données peuvent spécifier une fonction nommée dans le contrat et l&#39;appeler, en transmettant des arguments à la fonction.</p>
</div>
<div class="sect3 data-line-454">
<h4 id="view_contract_address">Affichage de l&#39;adresse du contrat dans un explorateur de blocs</h4>
<div class="paragraph data-line-456">
<p>Nous avons maintenant un contrat enregistré sur la chaîne de blocs, et nous pouvons voir qu&#39;il a une adresse Ethereum. Vérifions-le dans l&#39;explorateur de blocs <em>ropsten.etherscan.io</em> et voyons à quoi ressemble un contrat. Dans l&#39;IDE Remix, copiez l&#39;adresse du contrat en cliquant sur l&#39;icône du presse-papiers à côté de son nom (voir <a href="#remix_contract_address">Copiez l&#39;adresse du contrat de Remix</a>).</p>
</div>
<div id="remix_contract_address" class="imageblock data-line-460">
<div class="content">
<img src="images/remix_contract_address.png" alt="&quot;Copier l&#39;adresse du contrat depuis Remix&quot;">
</div>
<div class="title">Figure 17. Copiez l&#39;adresse du contrat de Remix</div>
</div>
<div class="paragraph data-line-462">
<p>Gardez Remix ouvert ; nous y reviendrons plus tard. Maintenant, naviguez dans votre navigateur jusqu&#39;à <em>ropsten.etherscan.io</em> et collez l&#39;adresse dans le champ de recherche. Vous devriez voir l&#39;historique des adresses Ethereum du contrat, comme indiqué dans <a href="#etherscan_contract_address">Afficher l&#39;adresse du contrat Faucet dans l&#39;explorateur de blocs Etherscan</a>.</p>
</div>
<div id="etherscan_contract_address" class="imageblock data-line-466">
<div class="content">
<img src="images/etherscan_contract_address.png" alt="&quot;Afficher l&#39;adresse du contrat Faucet dans l&#39;explorateur de blocs etherscan&quot;">
</div>
<div class="title">Figure 18. Afficher l&#39;adresse du contrat Faucet dans l&#39;explorateur de blocs Etherscan</div>
</div>
</div>
<div class="sect3 data-line-469">
<h4 id="fund_contract">Financement du contrat</h4>
<div class="paragraph data-line-471">
<p>Pour l&#39;instant, le contrat n&#39;a qu&#39;une seule transaction dans son historique : l&#8217;opération de création de contrat. Comme vous pouvez le voir, le contrat n&#39;a pas non plus d&#39;ether (solde nul). C&#39;est parce que nous n&#39;avons pas envoyé d&#39;éther au contrat dans la transaction de création, même si nous aurions pu le faire.</p>
</div>
<div class="paragraph data-line-473">
<p>Notre robinet a besoin de fonds ! Notre premier projet sera d&#39;utiliser MetaMask pour envoyer de l&#39;ether au contrat. Vous devriez toujours avoir l&#39;adresse du contrat dans votre presse-papiers (sinon, copiez-la à nouveau depuis Remix). Ouvrez MetaMask et envoyez-lui 1 éther, exactement comme vous le feriez à n&#39;importe quelle autre adresse Ethereum (voir <a href="#metamask_send_to_contract">Envoyer 1 ether à l&#39;adresse du contrat</a>).</p>
</div>
<div id="metamask_send_to_contract" class="imageblock data-line-477">
<div class="content">
<img src="images/metamask_send_to_contract.png" alt="&quot;&quot;">
</div>
<div class="title">Figure 19. Envoyer 1 ether à l&#39;adresse du contrat</div>
</div>
<div class="paragraph data-line-479">
<p>Dans une minute, si vous rechargez l&#39;explorateur de blocs Etherscan, il affichera une autre transaction à l&#39;adresse du contrat et un solde mis à jour de 1 ether.</p>
</div>
<div class="paragraph data-line-481">
<p>Vous souvenez-vous de la fonction de paiement externe par défaut sans nom dans notre code <em>Faucet.sol</em> ? Ça ressemblait à ça :</p>
</div>
<div id="fallback_function_review" class="listingblock data-line-485">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function () external payable {}</code></pre>
</div>
</div>
<div class="paragraph data-line-489">
<p>Lorsque vous avez envoyé une transaction à l&#39;adresse du contrat, sans données spécifiant la fonction à appeler, elle a appelé cette fonction par défaut. Parce que nous l&#39;avons déclaré comme payable, il a accepté et déposé le 1 éther dans le solde du compte du contrat. Votre transaction a entraîné l&#39;exécution du contrat dans l&#39;EVM, mettant à jour son solde. Vous avez financé votre robinet !</p>
</div>
</div>
<div class="sect3 data-line-492">
<h4 id="withdraw_from_contract">Faire un retrait sur notre contrat</h4>
<div class="paragraph data-line-494">
<p>Ensuite, retirons des fonds du robinet. Pour retirer, nous devons construire une transaction qui appelle la fonction withdraw et lui passe un argument withdraw_amount. Pour garder les choses simples pour le moment, Remix construira cette transaction pour nous et MetaMask la présentera pour notre approbation.</p>
</div>
<div class="paragraph data-line-496">
<p>Revenez à l&#39;onglet Remix et consultez le contrat dans l&#39;onglet Run. Vous devriez voir une boîte orange intitulée wthdraw (retrait) avec une entrée de champ intitulée uint256 withdraw_amount (voir <a href="#remix_contract_withdraw">La fonction de retrait (withdraw) de Faucet.sol, dans Remix</a>).</p>
</div>
<div id="remix_contract_withdraw" class="imageblock data-line-500">
<div class="content">
<img src="images/remix_contract_interact.png" alt="&quot;La fonction de retrait (withdraw) de Faucet.sol" width="dans Remix&quot;">
</div>
<div class="title">Figure 20. La fonction de retrait (withdraw) de Faucet.sol, dans Remix</div>
</div>
<div class="paragraph data-line-502">
<p>Il s&#39;agit de l&#39;interface Remix du contrat. Il nous permet de construire des transactions qui appellent les fonctions définies dans le contrat. Nous entrerons un withdraw_amount et cliquerons sur le bouton de retrait pour générer la transaction.</p>
</div>
<div class="paragraph data-line-504">
<p>Tout d&#39;abord, déterminons le withdraw_amount (montant de retrait). Nous voulons essayer de retirer 0,1 éther, qui est le montant maximum autorisé par notre contrat. N&#39;oubliez pas que toutes les valeurs monétaires d&#39;Ethereum sont libellées en wei en interne, et notre fonction withdraw s&#39;attend à ce que le withdraw_amount soit également libellé en wei. La quantité que nous voulons est de 0,1 éther, soit 100 000 000 000 000 000 wei (un 1 suivi de 17 zéros).</p>
</div>
<div class="admonitionblock tip data-line-509">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-510">
<p>En raison d&#39;une limitation de JavaScript, un nombre aussi grand que 10<sup>17</sup> ne peut pas être traité par Remix. Au lieu de cela, nous l&#39;entourons de guillemets doubles, pour permettre à Remix de le recevoir sous forme de chaîne et de le manipuler comme un BigNumber. Si nous ne le mettons pas entre guillemets, l&#39;IDE Remix ne parviendra pas à le traiter et affichera &quot;Error encoding arguments: Error: Assertion failed.&quot;</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-513">
<p>Tapez &quot;100000000000000000&quot; (avec les guillemets) dans la case withdraw_amount et cliquez sur le bouton de retrait (voir <a href="#remix_withdraw">Cliquez sur &quot;withdraw&quot; dans Remix pour créer une transaction de retrait</a>).</p>
</div>
<div id="remix_withdraw" class="imageblock data-line-517">
<div class="content">
<img src="images/remix_withdraw.png" alt="&quot;&quot;">
</div>
<div class="title">Figure 21. Cliquez sur &quot;withdraw&quot; dans Remix pour créer une transaction de retrait</div>
</div>
<div class="paragraph data-line-519">
<p>MetaMask fera apparaître une fenêtre de transaction que vous devrez approuver. Cliquez sur Confirmer pour envoyer votre appel de retrait au contrat (voir <a href="#metamask_withdraw">Transaction MetaMask pour appeler la fonction de retrait</a>).</p>
</div>
<div id="metamask_withdraw" class="imageblock data-line-523">
<div class="content">
<img src="images/metamask_withdraw.png" alt="&quot;Transaction MetaMask pour appeler la fonction de retrait&quot;">
</div>
<div class="title">Figure 22. Transaction MetaMask pour appeler la fonction de retrait</div>
</div>
<div class="paragraph data-line-525">
<p>Attendez une minute, puis rechargez l&#39;explorateur de blocs Etherscan pour voir la transaction reflétée dans l&#39;historique des adresses de contrat + Faucet + (voir <a href="#etherscan_withdrawal_tx">Etherscan montre la transaction appelant la fonction de retrait</a>).</p>
</div>
<div id="etherscan_withdrawal_tx" class="imageblock data-line-529">
<div class="content">
<img src="images/etherscan_withdrawal_tx.png" alt="&quot;Etherscan affiche la transaction appelant la fonction de retrait&quot;">
</div>
<div class="title">Figure 23. Etherscan montre la transaction appelant la fonction de retrait</div>
</div>
<div class="paragraph data-line-532">
<p>Nous voyons maintenant une nouvelle transaction avec l&#39;adresse du contrat comme destination et une valeur de 0 éther. Le solde du contrat a changé et est maintenant de 0,9 éther car il nous a envoyé 0,1 éther comme demandé. Mais nous ne voyons pas de transaction &quot;OUT&quot; dans l&#39;_historique des adresses de contrat_.</p>
</div>
<div class="paragraph data-line-534">
<p>Où est le retrait sortant ? Un nouvel onglet est apparu sur la page d&#39;historique des adresses du contrat, nommé Transactions internes. Parce que le transfert d&#39;éther 0.1 provient du code de contrat, il s&#39;agit d&#39;une transaction interne (également appelée <em>message</em>). Cliquez sur cet onglet pour le voir (voir <a href="#etherscan_withdrawal_internal">Etherscan montre la transaction interne transférant l&#39;ether du contrat</a>).</p>
</div>
<div class="paragraph data-line-537">
<p>Cette &quot;transaction interne&quot; a été envoyée par le contrat dans cette ligne de code (à partir de la fonction <code><span class="keep-together">withdraw</span></code> dans <em>Faucet.sol</em>) :</p>
</div>
<div id="withdraw_command_review" class="listingblock data-line-541">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">msg.sender.transfer(withdraw_amount);</code></pre>
</div>
</div>
<div class="paragraph data-line-545">
<p>Pour récapituler : vous avez envoyé une transaction depuis votre portefeuille MetaMask contenant des instructions de données pour appeler la fonction withdraw avec un argument withdraw_amount de 0,1 ether. Cette transaction a entraîné l&#39;exécution du contrat à l&#39;intérieur de l&#39;EVM. Lorsque l&#39;EVM a exécuté la fonction withdraw du contrat Faucet, il a d&#39;abord appelé la fonction require et validé que le montant demandé était inférieur ou égal au retrait maximal autorisé de 0,1 éther. Ensuite, il a appelé la fonction transfer pour vous envoyer l&#39;éther. L&#39;exécution de la fonction transfer a généré une transaction interne qui a déposé 0,1 éther dans votre adresse de portefeuille, à partir du solde du contrat. C&#39;est celui affiché sur l&#39;onglet Internal Transactions dans Etherscan. </p>
</div>
<div id="etherscan_withdrawal_internal" class="imageblock data-line-549">
<div class="content">
<img src="images/etherscan_withdrawal_internal.png" alt="&quot;Etherscan montre la transaction interne transférant l&#39;éther hors du contrat&quot;">
</div>
<div class="title">Figure 24. Etherscan montre la transaction interne transférant l&#39;ether du contrat</div>
</div>
</div>
</div>
<div class="sect2 data-line-552">
<h3 id="intro_conclusion">Conclusion</h3>
<div class="paragraph data-line-554">
<p>Dans ce chapitre, vous avez configuré un portefeuille à l&#39;aide de MetaMask et l&#39;avez financé à l&#39;aide d&#39;un robinet sur le réseau de test Ropsten. Vous avez reçu de l&#39;ether dans l&#39;adresse Ethereum de votre portefeuille, puis vous avez envoyé de l&#39;ether à l&#39;adresse du robinet Ethereum.</p>
</div>
<div class="paragraph data-line-556">
<p>Ensuite, vous avez écrit un contrat de robinet dans Solidity. Vous avez utilisé l&#39;IDE Remix pour compiler le contrat en code intermédiaire EVM, puis utilisé Remix pour former une transaction et créé le contrat Faucet sur la chaîne de blocs Ropsten. Une fois créé, le contrat Faucet avait une adresse Ethereum, et vous lui avez envoyé de l&#39;ether. Enfin, vous avez construit une transaction pour appeler la fonction withdraw et demandé avec succès 0,1 éther. Le contrat a vérifié la demande et vous a envoyé 0,1 ether avec une transaction interne.</p>
</div>
<div class="paragraph data-line-558">
<p>Cela peut ne pas sembler beaucoup, mais vous venez d&#39;interagir avec succès avec un logiciel qui contrôle l&#39;argent sur un ordinateur mondial décentralisé.</p>
</div>
<div class="paragraph data-line-7">
<p>Nous ferons beaucoup plus de programmation de contrats intelligents dans <a href="#smart_contracts_chapter">Contrats intelligents et Solidity</a> et découvrirons les meilleures pratiques et les considérations de sécurité dans <a href="#smart_contract_security">Sécurité des contrats intelligents</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="ethereum_clients_chapter">Clients Ethereum</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>An Ethereum client is a software application that implements the Ethereum specification and communicates over the peer-to-peer network with other Ethereum clients. Different Ethereum clients <em>interoperate</em> if they comply with the reference specification and the standardized communications protocols. While these different clients are implemented by different teams and in different programming languages, they all "speak" the same protocol and follow the same rules. As such, they can all be used to operate and interact with the same Ethereum network.</p>
</div>
<div class="paragraph data-line-6">
<p>Ethereum is an open source project, and the source code for all the major clients is available under open source licenses (e.g., LGPL v3.0), free to download and use for any purpose. <em>Open source</em> means more than simply free to use, though. It also means that Ethereum is developed by an open community of volunteers and can be modified by anyone. More eyes means more trustworthy code.</p>
</div>
<div class="paragraph data-line-8">
<p>Ethereum is defined by a formal specification called the "Yellow Paper" (see <a href="#references">Lectures complémentaires</a>).</p>
</div>
<div class="paragraph data-line-10">
<p>This is in contrast to, for example, Bitcoin, which is not defined in any formal way. Where Bitcoin&#8217;s "specification" is the reference implementation Bitcoin Core, Ethereum&#8217;s specification is documented in a paper that combines an English and a mathematical (formal) specification. This formal specification, in addition to various Ethereum Improvement Proposals, defines the standard behavior of an Ethereum <span class="keep-together">client</span>. The Yellow Paper is periodically updated as major changes are made to <span class="keep-together">Ethereum</span>.</p>
</div>
<div class="paragraph data-line-12">
<p>As a result of Ethereum&#8217;s clear formal specification, there are a number of independently developed, yet interoperable, software implementations of an Ethereum client. Ethereum has a greater diversity of implementations running on the network than any other blockchain, which is generally regarded as a good thing. Indeed, it has, for example, proven itself to be an excellent way of defending against attacks on the network, because exploitation of a particular client&#8217;s implementation strategy simply hassles the developers while they patch the exploit, while other clients keep the network running almost unaffected.</p>
</div>
<div class="sect2 data-line-14">
<h3 id="_ethereum_networks">Ethereum Networks</h3>
<div class="paragraph data-line-16">
<p>There exist a variety of Ethereum-based networks that largely conform to the formal specification defined in the Ethereum Yellow Paper, but which may or may not interoperate with each other.</p>
</div>
<div class="paragraph data-line-18">
<p>Among these Ethereum-based networks are Ethereum, Ethereum Classic, Ella, Expanse, Ubiq, Musicoin, and many others. While mostly compatible at the protocol level, these networks often have features or attributes that require maintainers of Ethereum client software to make small changes in order to support each network. Because of this, not every version of Ethereum client software runs every Ethereum-based blockchain.</p>
</div>
<div class="paragraph data-line-20">
<p>Currently, there are six main implementations of the Ethereum protocol, written in six different languages:</p>
</div>
<div class="ulist data-line-22">
<ul>
<li class="data-line-22">
<p>Parity, written in Rust</p>
</li>
<li class="data-line-23">
<p>Geth, written in Go</p>
</li>
<li class="data-line-24">
<p>cpp-ethereum, written in C++</p>
</li>
<li class="data-line-25">
<p>pyethereum, written in Python</p>
</li>
<li class="data-line-26">
<p>Mantis, written in Scala</p>
</li>
<li class="data-line-27">
<p>Harmony, written in Java</p>
</li>
</ul>
</div>
<div class="paragraph data-line-29">
<p>In this section, we will look at the two most common clients, Parity and Geth. We&#8217;ll show how to set up a node using each client, and explore some of their command-line options and application programming interfaces (APIs).</p>
</div>
<div class="sect3 data-line-32">
<h4 id="full_node_importance">Should I Run a Full Node?</h4>
<div class="paragraph data-line-34">
<p>The health, resilience, and censorship resistance of blockchains depend on them having many independently operated and geographically dispersed full nodes. Each full node can help other new nodes obtain the block data to bootstrap their operation, as well as offering the operator an authoritative and independent verification of all transactions and contracts.</p>
</div>
<div class="paragraph data-line-36">
<p>However, running a full node will incur a cost in hardware resources and bandwidth. A full node must download 80&#x2013;300 GB of data (as of January 2020, depending on the client configuration) and store it on a local hard drive. This data burden increases quite rapidly every day as new transactions and blocks are added. We discuss this topic in greater detail in <a href="#requirements">Hardware Requirements for a Full Node</a>.</p>
</div>
<div class="paragraph data-line-38">
<p>A full node running on a live <em>mainnet</em> network is not necessary for Ethereum development. You can do almost everything you need to do with a <em>testnet</em> node (which connects you to one of the smaller public test blockchains), with a local private blockchain like Ganache, or with a cloud-based Ethereum client offered by a service provider like Infura.</p>
</div>
<div class="paragraph data-line-40">
<p>You also have the option of running a remote client, which does not store a local copy of the blockchain or validate blocks and transactions. These clients offer the functionality of a wallet and can create and broadcast transactions. Remote clients can be used to connect to existing networks, such as your own full node, a public blockchain, a public or permissioned (proof-of-authority) testnet, or a private local blockchain. In practice, you will likely use a remote client such as MetaMask, Emerald Wallet, <span class="keep-together">MyEtherWallet</span>, or MyCrypto as a convenient way to switch between all of the different node options.</p>
</div>
<div class="paragraph data-line-42">
<p>The terms "remote client" and "wallet" are used interchangeably, though there are some differences. Usually, a remote client offers an API (such as the web3.js API) in addition to the transaction functionality of a wallet.</p>
</div>
<div class="paragraph data-line-44">
<p>Do not confuse the concept of a remote wallet in Ethereum with that of a <em>light client</em> (which is analogous to a Simplified Payment Verification client in Bitcoin). Light clients validate block headers and use Merkle proofs to validate the inclusion of transactions in the blockchain and determine their effects, giving them a similar level of security to a full node. Conversely, Ethereum remote clients do not validate block headers or transactions. They entirely trust a full client to give them access to the blockchain, and hence lose significant security and anonymity guarantees. You can mitigate these problems by using a full client you run yourself.</p>
</div>
</div>
<div class="sect3 data-line-47">
<h4 id="full_node_adv_disadv">Full Node Advantages and Disadvantages</h4>
<div class="paragraph data-line-49">
<p>Choosing to run a full node helps with the operation of the networks you connect it to, but also incurs some mild to moderate costs for you. Let&#8217;s look at some of the advantages and disadvantages.</p>
</div>
<div class="paragraph data-line-51">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist data-line-53">
<ul>
<li class="data-line-53">
<p>Supports the resilience and censorship resistance of Ethereum-based networks</p>
</li>
<li class="data-line-54">
<p>Authoritatively validates all transactions</p>
</li>
<li class="data-line-55">
<p>Can interact with any contract on the public blockchain without an intermediary</p>
</li>
<li class="data-line-56">
<p>Can directly deploy contracts into the public blockchain without an intermediary</p>
</li>
<li class="data-line-57">
<p>Can query (read-only) the blockchain status (accounts, contracts, etc.) offline</p>
</li>
<li class="data-line-58">
<p>Can query the blockchain without letting a third party know the information you&#8217;re reading</p>
</li>
</ul>
</div>
<div class="paragraph data-line-60">
<p><strong>Disadvantages:</strong></p>
</div>
<div class="ulist data-line-62">
<ul>
<li class="data-line-62">
<p>Requires significant and growing hardware and bandwidth resources</p>
</li>
<li class="data-line-63">
<p>May require several days to fully sync when first started</p>
</li>
<li class="data-line-64">
<p>Must be maintained, upgraded, and kept online to remain synced</p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-67">
<h4 id="pub_test_adv_disadv">Public Testnet Advantages and Disadvantages</h4>
<div class="paragraph data-line-69">
<p>Whether or not you choose to run a full node, you will probably want to run a public testnet node. Let&#8217;s look at some of the advantages and disadvantages of using a public testnet.</p>
</div>
<div class="paragraph data-line-71">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist data-line-73">
<ul>
<li class="data-line-73">
<p>A testnet node needs to sync and store much less data&#x2014;about 45 GB depending on the network.</p>
</li>
<li class="data-line-74">
<p>A testnet node can sync fully in a few hours.</p>
</li>
<li class="data-line-75">
<p>Deploying contracts or making transactions requires test ether, which has no value and can be acquired for free from several "faucets."</p>
</li>
<li class="data-line-76">
<p>Testnets are public blockchains with many other users and contracts, running "live."</p>
</li>
</ul>
</div>
<div class="paragraph data-line-78">
<p><strong>Disadvantages:</strong></p>
</div>
<div class="ulist data-line-80">
<ul>
<li class="data-line-80">
<p>You can&#8217;t use "real" money on a testnet; it runs on test ether. Consequently, you can&#8217;t test security against real adversaries, as there is nothing at stake.</p>
</li>
<li class="data-line-81">
<p>There are some aspects of a public blockchain that you cannot test realistically on a testnet. For example, transaction fees, although necessary to send transactions, are not a consideration on a testnet, since gas is free. Further, the testnets do not experience network congestion like the public mainnet sometimes does.</p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-84">
<h4 id="localtest_adv_dis">Local Blockchain Simulation Advantages and Disadvantages</h4>
<div class="paragraph data-line-86">
<p>For many testing purposes, the best option is to launch a single-instance private blockchain. Ganache (formerly named testrpc) is one of the most popular local blockchain simulations that you can interact with, without any other participants. It shares many of the advantages and disadvantages of the public testnet, but also has some differences.</p>
</div>
<div class="paragraph data-line-88">
<p><strong>Advantages:</strong></p>
</div>
<div class="ulist data-line-90">
<ul>
<li class="data-line-90">
<p>No syncing and almost no data on disk; you mine the first block yourself</p>
</li>
<li class="data-line-91">
<p>No need to obtain test ether; you "award" yourself mining rewards that you can use for testing</p>
</li>
<li class="data-line-92">
<p>No other users, just you</p>
</li>
<li class="data-line-93">
<p>No other contracts, just the ones you deploy after you launch it</p>
</li>
</ul>
</div>
<div class="paragraph data-line-95">
<p><strong>Disadvantages:</strong></p>
</div>
<div class="ulist data-line-97">
<ul>
<li class="data-line-97">
<p>Having no other users means that it doesn&#8217;t behave the same as a public blockchain. There&#8217;s no competition for transaction space or sequencing of <span class="keep-together">transactions</span>.</p>
</li>
<li class="data-line-98">
<p>No miners other than you means that mining is more predictable; therefore, you can&#8217;t test some scenarios that occur on a public blockchain.</p>
</li>
<li class="data-line-99">
<p>Having no other contracts means you have to deploy everything that you want to test, including dependencies and contract libraries.</p>
</li>
<li class="data-line-100">
<p>You can&#8217;t recreate some of the public contracts and their addresses to test some scenarios (e.g., the DAO contract).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2 data-line-104">
<h3 id="running_client">Running an Ethereum Client</h3>
<div class="paragraph data-line-106">
<p>If you have the time and resources, you should attempt to run a full node, even if only to learn more about the process. In this section we cover how to download, compile, and run the Ethereum clients Parity and Geth. This requires some familiarity with using the command-line interface on your operating system. It&#8217;s worth installing these clients, whether you choose to run them as full nodes, as testnet nodes, or as clients to a local private blockchain.</p>
</div>
<div class="sect3 data-line-109">
<h4 id="requirements">Hardware Requirements for a Full Node</h4>
<div class="paragraph data-line-111">
<p>Before we get started, you should ensure you have a computer with sufficient resources to run an Ethereum full node. You will need at least 300 GB of disk space to store a full copy of the Ethereum blockchain. If you also want to run a full node on the Ethereum testnet, you will need at least an additional 45 GB. Downloading 345 GB of blockchain data can take a long time, so it&#8217;s recommended that you work on a fast internet connection.</p>
</div>
<div class="paragraph data-line-113">
<p>Syncing the Ethereum blockchain is very input/output (I/O) intensive. It is best to have a solid-state drive (SSD). If you have a mechanical hard disk drive (HDD), you will need at least 8 GB of RAM to use as cache. Otherwise, you may discover that your system is too slow to keep up and sync fully.</p>
</div>
<div class="paragraph data-line-115">
<p><strong>Minimum requirements:</strong></p>
</div>
<div class="ulist data-line-117">
<ul>
<li class="data-line-117">
<p>CPU with 2+ cores</p>
</li>
<li class="data-line-118">
<p>At least 300 GB free storage space</p>
</li>
<li class="data-line-119">
<p>4 GB RAM minimum with an SSD, 8 GB+ if you have an HDD</p>
</li>
<li class="data-line-120">
<p>8 MBit/sec download internet service</p>
</li>
</ul>
</div>
<div class="paragraph data-line-122">
<p>These are the minimum requirements to sync a full (but pruned) copy of an Ethereum-based blockchain.</p>
</div>
<div class="paragraph data-line-124">
<p>At the time of writing the Parity codebase is lighter on resources, so if you&#8217;re running with limited hardware you&#8217;ll likely see better results using Parity.</p>
</div>
<div class="paragraph data-line-126">
<p>If you want to sync in a reasonable amount of time and store all the development tools, libraries, clients, and blockchains we discuss in this book, you will want a more capable computer.</p>
</div>
<div class="paragraph data-line-128">
<p><strong>Recommended specifications:</strong></p>
</div>
<div class="ulist data-line-130">
<ul>
<li class="data-line-130">
<p>Fast CPU with 4+ cores</p>
</li>
<li class="data-line-131">
<p>16 GB+ RAM</p>
</li>
<li class="data-line-132">
<p>Fast SSD with at least 500 GB free space</p>
</li>
<li class="data-line-133">
<p>25+ MBit/sec download internet service</p>
</li>
</ul>
</div>
<div class="paragraph data-line-135">
<p>It’s difficult to predict how fast a blockchain&#8217;s size will increase and when more disk space will be required, so it’s recommended to check the blockchain&#8217;s latest size before you start syncing.</p>
</div>
<div class="admonitionblock note data-line-138">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-139">
<p>The disk size requirements listed here assume you will be running a node with default settings, where the blockchain is "pruned" of old state data. If you instead run a full "archival" node, where all state is kept on disk, it will likely require more than 1 TB of disk space.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-142">
<p>These links provide up-to-date estimates of the blockchain size:</p>
</div>
<div class="ulist data-line-144">
<ul>
<li class="data-line-144">
<p><a href="https://bitinfocharts.com/ethereum/" data-href="https://bitinfocharts.com/ethereum/">Ethereum</a></p>
</li>
<li class="data-line-146">
<p><a href="https://bitinfocharts.com/ethereum%20classic/" data-href="https://bitinfocharts.com/ethereum%20classic/">Ethereum Classic</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3 data-line-149">
<h4 id="sw_reqs">Software Requirements for Building and Running a Client (Node)</h4>
<div class="paragraph data-line-151">
<p>This section covers Parity and Geth client software. It also assumes you are using a Unix-like command-line environment. The examples show the commands and output as they appear on an Ubuntu GNU/Linux operating system running the bash shell (command-line execution environment).</p>
</div>
<div class="paragraph data-line-153">
<p>Typically every blockchain will have its own version of Geth, while Parity provides support for multiple Ethereum-based blockchains (Ethereum, Ethereum Classic, <span class="keep-together">Ellaism</span>, Expanse, Musicoin) with the same client download.</p>
</div>
<div class="admonitionblock tip data-line-156">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-157">
<p>In many of the examples in this chapter, we will be using the operating system&#8217;s command-line interface (also known as a "shell"), accessed via a "terminal" application. The shell will display a prompt; you type a command, and the shell responds with some text and a new prompt for your next command. The prompt may look different on your system, but in the following examples, it is denoted by a $ symbol. In the examples, when you see text after a $ symbol, don&#8217;t type the $ symbol but type the command immediately following it (shown in bold), then press Enter to execute the command. In the examples, the lines below each command are the operating system&#8217;s responses to that command. When you see the next $ prefix, you&#8217;ll know it&#8217;s a new command and you should repeat the process.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-160">
<p>Before we get started, you may need to install some software. If you&#8217;ve never done any software development on the computer you are currently using, you will probably need to install some basic tools. For the examples that follow, you will need to install git, the source-code management system; golang, the Go programming language and standard libraries; and Rust, a systems programming language.</p>
</div>
<div class="paragraph data-line-162">
<p>Git can be installed by following the instructions at <a href="https://git-scm.com" class="undefined" data-href="https://git-scm.com">https://git-scm.com</a>.</p>
</div>
<div class="paragraph data-line-164">
<p>Go can be installed by following the instructions at <a href="https://golang.org" class="undefined" data-href="https://golang.org">https://golang.org</a>, or <a href="https://github.com/golang/go/wiki/Ubuntu" class="undefined" data-href="https://github.com/golang/go/wiki/Ubuntu">https://github.com/golang/go/wiki/Ubuntu</a> if you are using Ubuntu.</p>
</div>
<div class="admonitionblock note data-line-167">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-168">
<p>Geth requirements vary, but if you stick with Go version 1.10 or greater you should be able to compile any version of Geth you want. Of course, you should always refer to the documentation for your chosen flavor of Geth.</p>
</div>
<div class="paragraph data-line-170">
<p>The version of golang that is installed on your operating system or is available from your system&#8217;s package manager may be significantly older than 1.10. If so, remove it and install the latest version from <a href="https://golang.org/" class="undefined" data-href="https://golang.org/">https://golang.org/</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-173">
<p>Rust can be installed by following the instructions at <a href="https://www.rustup.rs/" class="undefined" data-href="https://www.rustup.rs/">https://www.rustup.rs/</a>.</p>
</div>
<div class="admonitionblock note data-line-176">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-177">
<p>Parity requires Rust version 1.27 or greater.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-180">
<p>Parity also requires some software libraries, such as OpenSSL and libudev. To install these on a Ubuntu or Debian GNU/Linux compatible system, use the following <span class="keep-together">command</span>:</p>
</div>
<pre data-type="programlisting">
$ <strong>sudo apt-get install openssl libssl-dev libudev-dev cmake clang</strong>
</pre>
<div class="paragraph data-line-188">
<p>For other operating systems, use the package manager of your OS or follow the <a href="https://github.com/paritytech/parity/wiki/Setup" data-href="https://github.com/paritytech/parity/wiki/Setup">Wiki instructions</a> to install the required libraries.</p>
</div>
<div class="paragraph data-line-190">
<p>Now that you have git, golang, Rust, and the necessary libraries installed, let&#8217;s get to work!</p>
</div>
</div>
<div class="sect3 data-line-193">
<h4 id="parity">Parity</h4>
<div class="paragraph data-line-195">
<p>Parity is an implementation of a full-node Ethereum client and DApp browser. It was written &#x201c;from the ground up&#x201d; in Rust, a systems programming language, with the aim of building a modular, secure, and scalable Ethereum client. Parity is developed by Parity Tech, a UK company, and is released under the GPLv3 free software license.</p>
</div>
<div class="admonitionblock note data-line-198">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-199">
<p>Disclosure: One of the authors of this book, Dr. Gavin Wood, is the founder of Parity Tech and wrote much of the Parity client. Parity represents about 25% of the installed Ethereum client base.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-202">
<p>To install Parity, you can use the Rust package manager cargo or download the source code from GitHub. The package manager also downloads the source code, so there&#8217;s not much difference between the two options. In the next section, we will show you how to download and compile Parity yourself.</p>
</div>
<div class="sect4 data-line-205">
<h5 id="install_parity">Installing Parity</h5>
<div class="paragraph data-line-207">
<p>The <a href="https://wiki.parity.io/Setup" data-href="https://wiki.parity.io/Setup">Parity Wiki</a> offers instructions for building Parity in different environments and containers. We&#8217;ll show you how to build Parity from source. This assumes you have already installed Rust using rustup (see <a href="#sw_reqs">Software Requirements for Building and Running a Client (Node)</a>).</p>
</div>
<div class="paragraph data-line-209">
<p>First, get the source code from GitHub:</p>
</div>
<pre data-type="programlisting">
$ <strong>git clone https://github.com/paritytech/parity</strong>
</pre>
<div class="paragraph data-line-217">
<p>Then change to the <em>parity</em> directory and use cargo to build the executable:</p>
</div>
<pre data-type="programlisting">
$ <strong>cd parity</strong>
$ <strong>cargo install --path .</strong>
</pre>
<div class="paragraph data-line-226">
<p>If all goes well, you should see something like:</p>
</div>
<pre data-type="programlisting">
$ <strong>cargo install --path .</strong>
Installing parity-ethereum v2.7.0 (/root/parity)
Updating crates.io index
Updating git repository `https://github.com/paritytech/rust-ctrlc.git`
Updating git repository `https://github.com/paritytech/app-dirs-rs`   Updating git repository

 [...]

Compiling parity-ethereum v2.7.0 (/root/parity)
Finished release [optimized] target(s) in 10m 16s
Installing /root/.cargo/bin/parity
Installed package `parity-ethereum v2.7.0 (/root/parity)` (executable `parity`)
$
</pre>
<div class="paragraph data-line-246">
<p>Try and run parity to see if it is installed, by invoking the --version option:</p>
</div>
<pre data-type="programlisting">
$ <strong>parity --version</strong>
Parity Ethereum Client.
  version Parity-Ethereum/v2.7.0-unstable-b69a33b3a-20200124/x86_64-unknown-linux-gnu/rustc1.40.0
Copyright 2015-2020 Parity Technologies (UK) Ltd.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

By Wood/Paronyan/Kotewicz/Drwięga/Volf/Greeff
   Habermeier/Czaban/Gotchac/Redman/Nikolsky
   Schoedon/Tang/Adolfsson/Silva/Palm/Hirsz et al.
$
</pre>
<div class="paragraph data-line-266">
<p>Great! Now that Parity is installed, you can sync the blockchain and get started with some basic command-line options.</p>
</div>
</div>
</div>
<div class="sect3 data-line-269">
<h4 id="go_ethereum_geth">Go-Ethereum (Geth)</h4>
<div class="paragraph data-line-271">
<p>Geth is the Go language implementation that is actively developed by the Ethereum Foundation, so is considered the "official" implementation of the Ethereum client. Typically, every Ethereum-based blockchain will have its own Geth implementation. If you&#8217;re running Geth, then you&#8217;ll want to make sure you grab the correct version for your blockchain using one of the following repository links:</p>
</div>
<div class="ulist data-line-274">
<ul>
<li class="data-line-274">
<p><a href="https://github.com/ethereum/go-ethereum" data-href="https://github.com/ethereum/go-ethereum">Ethereum</a> (or <a href="https://geth.ethereum.org/" class="undefined" data-href="https://geth.ethereum.org/">https://geth.ethereum.org/</a>)</p>
</li>
<li class="data-line-276">
<p><a href="https://github.com/etclabscore/go-ethereum" data-href="https://github.com/etclabscore/go-ethereum">Ethereum Classic</a></p>
</li>
<li class="data-line-278">
<p><a href="https://github.com/ellaism/go-ellaism" data-href="https://github.com/ellaism/go-ellaism">Ellaism</a></p>
</li>
<li class="data-line-280">
<p><a href="https://github.com/expanse-org/go-expanse" data-href="https://github.com/expanse-org/go-expanse">Expanse</a></p>
</li>
<li class="data-line-282">
<p><a href="https://github.com/Musicoin/go-musicoin" data-href="https://github.com/Musicoin/go-musicoin">Musicoin</a></p>
</li>
<li class="data-line-284">
<p><a href="https://github.com/ubiq/go-ubiq" data-href="https://github.com/ubiq/go-ubiq">Ubiq</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note data-line-287">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-288">
<p>You can also skip these instructions and install a precompiled binary for your platform of choice. The precompiled releases are much easier to install and can be found in the "releases" section of any of the repositories listed here. However, you may learn more by downloading and compiling the software yourself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-292">
<h5 id="cloning_repo">Cloning the repository</h5>
<div class="paragraph data-line-294">
<p>The first step is to clone the Git repository, to get a copy of the source code.</p>
</div>
<div class="paragraph data-line-296">
<p>To make a local clone of your chosen repository, use the git command as follows, in your home directory or under any directory you use for development:</p>
</div>
<pre data-type="programlisting">
$ <strong>git clone &lt;Repository Link&gt;</strong>
</pre>
<div class="paragraph data-line-304">
<p>You should see a progress report as the repository is copied to your local system:</p>
</div>
<div id="cloning_status" class="listingblock data-line-307">
<div class="content">
<pre>Cloning into 'go-ethereum'...
remote: Enumerating objects: 86915, done.
remote: Total 86915 (delta 0), reused 0 (delta 0), pack-reused 86915
Receiving objects: 100% (86915/86915), 134.73 MiB | 29.30 MiB/s, done.
Resolving deltas: 100% (57590/57590), done.</pre>
</div>
</div>
<div class="paragraph data-line-315">
<p>Great! Now that you have a local copy of Geth, you can compile an executable for your platform.</p>
</div>
</div>
<div class="sect4 data-line-318">
<h5 id="build_geth_src">Building Geth from source code</h5>
<div class="paragraph data-line-320">
<p>To build Geth, change to the directory where the source code was downloaded and use the make command:</p>
</div>
<pre data-type="programlisting">
$ <strong>cd go-ethereum</strong>
$ <strong>make geth</strong>
</pre>
<div class="paragraph data-line-329">
<p>If all goes well, you will see the Go compiler building each component until it produces the geth executable:</p>
</div>
<div id="making_geth_status" class="listingblock data-line-332">
<div class="content">
<pre>build/env.sh go run build/ci.go install ./cmd/geth
&gt;&gt;&gt; /usr/local/go/bin/go install -ldflags -X main.gitCommit=58a1e13e6dd7f52a1d...
github.com/ethereum/go-ethereum/common/hexutil
github.com/ethereum/go-ethereum/common/math
github.com/ethereum/go-ethereum/crypto/sha3
github.com/ethereum/go-ethereum/rlp
github.com/ethereum/go-ethereum/crypto/secp256k1
github.com/ethereum/go-ethereum/common
[...]
github.com/ethereum/go-ethereum/cmd/utils
github.com/ethereum/go-ethereum/cmd/geth
Done building.
Run "build/bin/geth" to launch geth.
$</pre>
</div>
</div>
<div class="paragraph data-line-349">
<p>Let&#8217;s make sure geth works without actually starting it running:</p>
</div>
<pre data-type="programlisting">
$ <strong>./build/bin/geth version</strong>

Geth
Version: 1.9.11-unstable
Git Commit: 0b284f6c6cfc6df452ca23f9454ee16a6330cb8e
Git Commit Date: 20200123
Architecture: amd64
Protocol Versions: [64 63]
Go Version: go1.13.4
Operating System: linux
[...]
</pre>
<div class="paragraph data-line-367">
<p>Your geth version command may show slightly different information, but you should see a version report much like the one seen here.</p>
</div>
<div class="paragraph data-line-369">
<p>The next sections explains the challenge with the initial synchronization of Ethereum&#8217;s blockchain.</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-373">
<h3 id="first_sync">The First Synchronization of Ethereum-Based Blockchains</h3>
<div class="paragraph data-line-375">
<p>Traditionally, when syncing an Ethereum blockchain, your client would download and validate every block and every transaction since the very start&#x2014;i.e., from the genesis block.</p>
</div>
<div class="paragraph data-line-377">
<p>While it is possible to fully sync the blockchain this way, this type of sync will take a very long time and has high resource requirements (it will need much more RAM, and will take a very long time indeed if you don&#8217;t have fast storage).</p>
</div>
<div class="paragraph data-line-379">
<p>Many Ethereum-based blockchains were the victim of denial-of-service attacks at the end of 2016. Affected blockchains will tend to sync slowly when doing a full sync.</p>
</div>
<div class="paragraph data-line-381">
<p>For example, on Ethereum, a new client will make rapid progress until it reaches block 2,283,397. This block was mined on September 18, 2016, and marks the beginning of the DoS attacks. From this block to block 2,700,031 (November 26, 2016), the validation of transactions becomes extremely slow, memory intensive, and I/O intensive. This results in validation times exceeding 1 minute per block. Ethereum implemented a series of upgrades, using hard forks, to address the underlying vulnerabilities that were exploited in the DoS attacks. These upgrades also cleaned up the blockchain by removing some 20 million empty accounts created by spam transactions.</p>
</div>
<div class="paragraph data-line-383">
<p>If you are syncing with full validation, your client will slow down and may take several days, or perhaps even longer, to validate the blocks affected by the DoS attacks.</p>
</div>
<div class="paragraph data-line-385">
<p>Fortunately, most Ethereum clients by default now perform a "fast" synchronization that skips the full validation of transactions until it has synced to the tip of the blockchain, then resumes full validation.</p>
</div>
<div class="paragraph data-line-387">
<p>Geth performs fast synchronization by default for Ethereum. You may need to refer to the specific instructions for other chosen Ethereum chain.</p>
</div>
<div class="paragraph data-line-389">
<p>Parity also does fast synchronization by default.</p>
</div>
<div class="admonitionblock note data-line-392">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-393">
<p>Geth can only operate fast synchronization when starting with an empty block database. If you have already started syncing without fast mode, Geth cannot switch. It is faster to delete the blockchain data directory and start fast syncing from the beginning than to continue syncing with full validation. Be careful to not delete any wallets when deleting the blockchain data!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-396">
<h4 id="_running_geth_or_parity">Running Geth or Parity</h4>
<div class="paragraph data-line-398">
<p>Now that you understand the challenges of the "first sync," you&#8217;re ready to start an Ethereum client and sync the blockchain. For both Geth and Parity, you can use the --help option to see all the configuration parameters. The default settings are usually sensible and appropriate for most uses. Choose how to configure any optional parameters to suit your needs, then start Geth or Parity to sync the chain. Then wait&#8230;&#8203;</p>
</div>
<div class="admonitionblock tip data-line-401">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-402">
<p>Syncing the Ethereum blockchain will take anywhere from half a day on a very fast system with lots of RAM, to several days on a slower system.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-406">
<h4 id="json_rpc">The JSON-RPC Interface</h4>
<div class="paragraph data-line-408">
<p>Ethereum clients offer an application programming interface and a set of Remote Procedure Call (RPC) commands, which are encoded as JavaScript Object Notation (JSON). You will see this referred to as the <em>JSON-RPC API</em>. Essentially, the JSON-RPC API is an interface that allows us to write programs that use an Ethereum client as a <em>gateway</em> to an Ethereum network and blockchain.</p>
</div>
<div class="paragraph data-line-410">
<p>Usually, the RPC interface is offered as an HTTP service on port 8545. For security reasons it is restricted, by default, to only accept connections from localhost (the IP address of your own computer, which is 127.0.0.1).</p>
</div>
<div class="paragraph data-line-412">
<p>To access the JSON-RPC API, you can use a specialized library (written in the programming language of your choice) that provides "stub" function calls corresponding to each available RPC command, or you can manually construct HTTP requests and send/receive JSON-encoded requests. You can even use a generic command-line HTTP client, like curl, to call the RPC interface. Let&#8217;s try that. First, ensure that you have Geth up and running, configured with --rpc to allow HTTP access to the RPC interface, then switch to a new terminal window (e.g., with Ctrl-Shift-N or Ctrl-Shift-T in an existing terminal window) as shown here:</p>
</div>
<pre data-type="programlisting">
$ <strong>curl -X POST -H "Content-Type: application/json" --data \
  '{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}' \
  http://localhost:8545</strong>

{"jsonrpc":"2.0","id":1,
"result":"Geth/v1.9.11-unstable-0b284f6c-20200123/linux-amd64/go1.13.4"}
</pre>
<div class="paragraph data-line-425">
<p>In this example, we use curl to make an HTTP connection to the address <em><a href="http://localhost:8545" class="undefined" data-href="http://localhost:8545">http://localhost:8545</a></em>. We are already running geth, which offers the JSON-RPC API as an HTTP service on port 8545. We instruct curl to use the HTTP POST command and to identify the content as type application/json. Finally, we pass a JSON-encoded request as the data component of our HTTP request. Most of our command line is just setting up curl to make the HTTP connection correctly. The interesting part is the actual JSON-RPC command we issue:</p>
</div>
<div id="JSON_RPC_command" class="listingblock data-line-428">
<div class="content">
<pre>{"jsonrpc":"2.0","method":"web3_clientVersion","params":[],"id":1}</pre>
</div>
</div>
<div class="paragraph data-line-432">
<p>The JSON-RPC request is formatted according to the <a href="https://www.jsonrpc.org/specification" data-href="https://www.jsonrpc.org/specification">JSON-RPC 2.0 specification</a>. Each request contains four elements:</p>
</div>
<div class="dlist data-line-434">
<dl>
<dt class="hdlist1">jsonrpc</dt>
<dd>
<p>Version of the JSON-RPC protocol. This MUST be exactly "2.0".</p>
</dd>
<dt class="hdlist1">method</dt>
<dd>
<p>The name of the method to be invoked.</p>
</dd>
<dt class="hdlist1">params</dt>
<dd>
<p>A structured value that holds the parameter values to be used during the invocation of the method. This member MAY be omitted.</p>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>An identifier established by the client that MUST contain a String, Number, or NULL value if included. The server MUST reply with the same value in the response object if included. This member is used to correlate the context between the two objects.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip data-line-443">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-444">
<p>The id parameter is used primarily when you are making multiple requests in a single JSON-RPC call, a practice called <em>batching</em>. Batching is used to avoid the overhead of a new HTTP and TCP connection for every request. In the Ethereum context, for example, we would use batching if we wanted to retrieve thousands of transactions over one HTTP connection. When batching, you set a different id for each request and then match it to the id in each response from the JSON-RPC server. The easiest way to implement this is to maintain a counter and increment the value for each request.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-448">
<p>The response we receive is:</p>
</div>
<div class="listingblock data-line-450">
<div class="content">
<pre>{"jsonrpc":"2.0","id":1,
"result":"Geth/v1.9.11-unstable-0b284f6c-20200123/linux-amd64/go1.13.4"}</pre>
</div>
</div>
<div class="paragraph data-line-455">
<p>This tells us that the JSON-RPC API is being served by Geth client version 1.13.4.</p>
</div>
<div class="paragraph data-line-457">
<p>Let&#8217;s try something a bit more interesting. In the next example, we ask the JSON-RPC API for the current price of gas in wei:</p>
</div>
<pre data-type="programlisting">
$ <strong>curl -X POST -H "Content-Type: application/json" --data \
  '{"jsonrpc":"2.0","method":"eth_gasPrice","params":[],"id":4213}' \
  http://localhost:8545</strong>

{"jsonrpc":"2.0","id":4213,"result":"0x430e23400"}
</pre>
<div class="paragraph data-line-469">
<p>The response, 0x430e23400, tells us that the current gas price is 18 gwei (gigawei or billion wei). If, like us, you don&#8217;t think in hexadecimal, you can convert it to decimal on the command line with a little bash-fu:</p>
</div>
<pre data-type="programlisting">
$ <strong>echo $((0x430e23400))</strong>

18000000000
</pre>
<div class="paragraph data-line-479">
<p>The full JSON-RPC API can be investigated on the <a href="https://github.com/ethereum/wiki/wiki/JSON-RPC" data-href="https://github.com/ethereum/wiki/wiki/JSON-RPC">Ethereum wiki</a>.</p>
</div>
<div class="sect4 data-line-482">
<h5 id="parity_compatibility_mode">Parity&#8217;s Geth compatibility mode</h5>
<div class="paragraph data-line-484">
<p>Parity has a special "Geth compatibility mode,&#x201d; where it offers a JSON-RPC API that is identical to that offered by Geth. To run Parity in this mode, use the --geth switch:</p>
</div>
<pre data-type="programlisting">
$ <strong>parity --geth</strong>
</pre>
</div>
</div>
</div>
<div class="sect2 data-line-493">
<h3 id="lw_eth_clients">Remote Ethereum Clients</h3>
<div class="paragraph data-line-495">
<p>Remote clients offer a subset of the functionality of a full client. They do not store the full Ethereum blockchain, so they are faster to set up and require far less data storage.</p>
</div>
<div class="paragraph pagebreak-before data-line-498">
<p>These clients typically provide the ability to do one or more of the following:</p>
</div>
<div class="ulist data-line-500">
<ul>
<li class="data-line-500">
<p>Manage private keys and Ethereum addresses in a wallet.</p>
</li>
<li class="data-line-501">
<p>Create, sign, and broadcast transactions.</p>
</li>
<li class="data-line-502">
<p>Interact with smart contracts, using the data payload.</p>
</li>
<li class="data-line-503">
<p>Browse and interact with DApps.</p>
</li>
<li class="data-line-504">
<p>Offer links to external services such as block explorers.</p>
</li>
<li class="data-line-505">
<p>Convert ether units and retrieve exchange rates from external sources.</p>
</li>
<li class="data-line-506">
<p>Inject a web3 instance into the web browser as a JavaScript object.</p>
</li>
<li class="data-line-507">
<p>Use a web3 instance provided/injected into the browser by another client.</p>
</li>
<li class="data-line-508">
<p>Access RPC services on a local or remote Ethereum node.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-510">
<p>Some remote clients, for example mobile (smartphone) wallets, offer only basic wallet functionality. Other remote clients are full-blown DApp browsers. Remote clients commonly offer some of the functions of a full-node Ethereum client without synchronizing a local copy of the Ethereum blockchain by connecting to a full node being run elsewhere, e.g., by you locally on your machine or on a web server, or by a third party on their servers.</p>
</div>
<div class="paragraph data-line-512">
<p>Let&#8217;s look at some of the most popular remote clients and the functions they offer.</p>
</div>
<div class="sect3 data-line-515">
<h4 id="mobile_wallets">Mobile (Smartphone) Wallets</h4>
<div class="paragraph data-line-517">
<p>All mobile wallets are remote clients, because smartphones do not have adequate resources to run a full Ethereum client. Light clients are in development and not in general use for Ethereum. In the case of Parity, the light client is marked "experimental" and can be used by running parity with the --light option.</p>
</div>
<div class="paragraph data-line-519">
<p>Popular mobile wallets include the following (we list these merely as examples; this is not an endorsement or an indication of the security or functionality of these wallets):</p>
</div>
<div class="dlist data-line-521">
<dl>
<dt class="hdlist1"><a href="https://jaxx.io" data-href="https://jaxx.io">Jaxx</a></dt>
<dd>
<p>A multicurrency mobile wallet based on BIP-39 mnemonic seeds, with support for Bitcoin, Litecoin, Ethereum, Ethereum Classic, ZCash, a variety of ERC20 tokens, and many other currencies. Jaxx is available on Android and iOS, as a browser plug-in wallet, and as a desktop wallet for a variety of operating systems.</p>
</dd>
<dt class="hdlist1"><a href="https://status.im" data-href="https://status.im">Status</a></dt>
<dd>
<p>A mobile wallet and DApp browser, with support for a variety of tokens and popular DApps. Available for iOS and Android.</p>
</dd>
<dt class="hdlist1"><a href="https://trustwalletapp.com/" data-href="https://trustwalletapp.com/">Trust Wallet</a></dt>
<dd>
<p>A mobile multi-currency wallet that supports Ethereum and Ethereum Classic as well as ERC20 and ERC223 tokens. Trust Wallet is available for iOS and Android.</p>
</dd>
<dt class="hdlist1"><a href="https://www.cipherbrowser.com" data-href="https://www.cipherbrowser.com">Cipher Browser</a></dt>
<dd>
<p>A full-featured Ethereum-enabled mobile DApp browser and wallet that allows integration with Ethereum apps and tokens. Available for iOS and Android.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-530">
<h4 id="browser_wallets">Browser Wallets</h4>
<div class="paragraph data-line-532">
<p>A variety of wallets and DApp browsers are available as plug-ins or extensions of web browsers such as Chrome and Firefox. These are remote clients that run inside your browser.</p>
</div>
<div class="paragraph data-line-534">
<p>Some of the more popular ones are MetaMask, Jaxx, MyEtherWallet, and MyCrypto.</p>
</div>
<div class="sect4 data-line-537">
<h5 id="MetaMask">MetaMask</h5>
<div class="paragraph data-line-539">
<p><a href="https://metamask.io/" data-href="https://metamask.io/">MetaMask</a>, introduced in <a href="#intro_chapter">Les bases d&#39;Ethereum</a>, is a versatile browser-based wallet, RPC client, and basic contract explorer. It is available on Chrome, Firefox, Opera, and Brave Browser.</p>
</div>
<div class="paragraph data-line-541">
<p>Unlike other browser wallets, MetaMask injects a web3 instance into the browser JavaScript context, acting as an RPC client that connects to a variety of Ethereum blockchains (mainnet, Ropsten testnet, Kovan testnet, local RPC node, etc.). The ability to inject a web3 instance and act as a gateway to external RPC services makes MetaMask a very powerful tool for developers and users alike. It can be combined, for example, with MyEtherWallet or MyCrypto, acting as a web3 provider and RPC gateway for those tools.</p>
</div>
</div>
<div class="sect4 data-line-544">
<h5 id="Jaxx">Jaxx</h5>
<div class="paragraph data-line-546">
<p><a href="https://jaxx.io" data-href="https://jaxx.io">Jaxx</a>, which was introduced as a mobile wallet in the previous section, is also available as a Chrome and Firefox extension and as a desktop wallet.</p>
</div>
</div>
<div class="sect4 data-line-549">
<h5 id="MEW">MyEtherWallet (MEW)</h5>
<div class="paragraph data-line-551">
<p><a href="https://www.myetherwallet.com/" data-href="https://www.myetherwallet.com/">MyEtherWallet</a> is a browser-based JavaScript remote client that offers:</p>
</div>
<div class="ulist data-line-553">
<ul>
<li class="data-line-553">
<p>A bridge to popular hardware wallets such as the Trezor and Ledger</p>
</li>
<li class="data-line-554">
<p>A web3 interface that can connect to a web3 instance injected by another client (e.g., MetaMask)</p>
</li>
<li class="data-line-555">
<p>An RPC client that can connect to an Ethereum full client</p>
</li>
<li class="data-line-556">
<p>A basic interface that can interact with smart contracts, given a contract&#8217;s address and application binary interface (ABI)</p>
</li>
<li class="data-line-557">
<p>A mobile app, MEWConnect, that enables one to use a compatible Android or iOS device to store funds, similarly to a hardware wallet.</p>
</li>
<li class="data-line-558">
<p>A software wallet running in JavaScript</p>
</li>
</ul>
</div>
<div class="admonitionblock warning data-line-561">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-562">
<p>You must be very careful when accessing MyEtherWallet and other browser-based JavaScript wallets, as they are frequent targets for phishing. Always use a bookmark and not a search engine or link to access the correct web URL.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-566">
<h5 id="MyCrypto">MyCrypto</h5>
<div class="paragraph data-line-568">
<p>In early 2018, the MyEtherWallet project split into two competing implementations, guided by two independent development teams: a "fork," as it is called in open source development. The two projects are called MyEtherWallet (the original branding) and <a href="https://mycrypto.com/" data-href="https://mycrypto.com/">MyCrypto</a>. MyCrypto offers almost identical functionality to MyEtherWallet, but instead of using MEWConnect, it offers a connection to the Parity Signer mobile app. Like MEWConnect, Parity Signer stores keys on the phone and interfaces with MyCrypto in a similar manner as a hardware wallet.</p>
</div>
</div>
<div class="sect4 data-line-571">
<h5 id="Mist">Mist (Deprecated)</h5>
<div class="paragraph data-line-573">
<p><a href="https://github.com/ethereum/mist" data-href="https://github.com/ethereum/mist">Mist</a> was the first Ethereum-enabled browser, built by the Ethereum Foundation. It contained a browser-based wallet that was the first implementation of the ERC20 token standard (Fabian Vogelsteller, author of ERC20, was also the main developer of Mist). Mist was also the first wallet to introduce the camelCase checksum (EIP-55). As of March, 2019, Mist was deprecated and should no longer be used.</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-575">
<h3 id="_conclusions">Conclusions</h3>
<div class="paragraph data-line-9">
<p>In this chapter we explored Ethereum clients. You downloaded, installed, and synchronized a client, becoming a participant in the Ethereum network, and contributing to the health and stability of the system by replicating the blockchain on your own computer.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="keys_addresses">Cryptographie</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>One of Ethereum&#8217;s foundational technologies is <em>cryptography</em>, which is a branch of mathematics used extensively in computer security. Cryptography means "secret writing" in Greek, but the study of cryptography encompasses more than just secret writing, which is referred to as <em>encryption</em>. Cryptography can, for example, also be used to prove knowledge of a secret without revealing that secret (e.g., with a digital signature), or to prove the authenticity of data (e.g., with digital fingerprints, also known as "hashes"). These types of cryptographic proofs are mathematical tools critical to the operation of the Ethereum platform (and, indeed, all blockchain systems), and are also extensively used in Ethereum applications. </p>
</div>
<div class="paragraph data-line-6">
<p>Note that, at the time of publication, no part of the Ethereum protocol involves encryption; that is to say all communications with the Ethereum platform and between nodes (including transaction data) are unencrypted and can (necessarily) be read by anyone. This is so everyone can verify the correctness of state updates and consensus can be reached. In the future, advanced cryptographic tools, such as zero knowledge proofs and homomorphic encryption, will be available that will allow for some encrypted calculations to be recorded on the blockchain while still enabling consensus; however, while provision has been made for them, they have yet to be deployed.</p>
</div>
<div class="paragraph data-line-8">
<p>In this chapter we will introduce some of the cryptography used in Ethereum: namely public key cryptography (PKC), which is used to control ownership of funds, in the form of private keys and addresses.</p>
</div>
<div class="sect2 data-line-11">
<h3 id="keys_addresses_intro">Keys and Addresses</h3>
<div class="paragraph data-line-13">
<p>As we saw earlier in the book, Ethereum has two different types of accounts: <em>externally owned accounts</em> (EOAs) and <em>contracts</em>. Ownership of ether by EOAs is established through digital <em>private keys</em>, <em>Ethereum addresses</em>, and <em>digital signatures</em>. The private keys are at the heart of all user interaction with Ethereum. In fact, account addresses are derived directly from private keys: a private key uniquely determines a single Ethereum address, also known as an <em>account</em>.</p>
</div>
<div class="paragraph data-line-15">
<p>Private keys are not used directly in the Ethereum system in any way; they are never transmitted or stored on Ethereum. That is to say that private keys should remain private and never appear in messages passed to the network, nor should they be stored on-chain; only account addresses and digital signatures are ever transmitted and stored on the Ethereum system. For more information on how to keep private keys safe and secure, see <a href="#control_responsibility">Contrôle et responsabilité</a> and <a href="#wallets_chapter">Portefeuilles</a>.</p>
</div>
<div class="paragraph data-line-17">
<p>Access and control of funds is achieved with digital signatures, which are also created using the private key. Ethereum transactions require a valid digital signature to be included in the blockchain. Anyone with a copy of a private key has control of the corresponding account and any ether it holds. Assuming a user keeps their private key safe, the digital signatures in Ethereum transactions prove the true owner of the funds, because they prove ownership of the private key.</p>
</div>
<div class="paragraph data-line-19">
<p>In public key cryptography&#x2013;based systems, such as that used by Ethereum, keys come in pairs consisting of a private (secret) key and a public key. Think of the public key as similar to a bank account number, and the private key as similar to the secret PIN; it is the latter that provides control over the account, and the former that identifies it to others. The private keys themselves are very rarely seen by Ethereum users; for the most part, they are stored (in encrypted form) in special files and managed by Ethereum wallet software.</p>
</div>
<div class="paragraph data-line-21">
<p>In the payment portion of an Ethereum transaction, the intended recipient is represented by an Ethereum address, which is used in the same way as the beneficiary account details of a bank transfer. As we will see in more detail shortly, an Ethereum address for an EOA is generated from the public key portion of a key pair. However, not all Ethereum addresses represent public–private key pairs; they can also represent contracts, which, as we will see in <a href="#smart_contracts_chapter">Contrats intelligents et Solidity</a>, are not backed by private keys.</p>
</div>
<div class="paragraph data-line-23">
<p>In the rest of this chapter, we will first explore basic cryptography in a bit more detail and explain the mathematics used in Ethereum. Then we will look at how keys are generated, stored, and managed.  Finally, we will review the various encoding formats used to represent private keys, public keys, and addresses.</p>
</div>
</div>
<div class="sect2 data-line-26">
<h3 id="pkc">Public Key Cryptography and Cryptocurrency</h3>
<div class="paragraph data-line-28">
<p>Public key cryptography (also called "asymmetric cryptography") is a core part of modern-day information security. The key exchange protocol, first published in the 1970s by Martin Hellman, Whitfield Diffie, and Ralph Merkle, was a monumental breakthrough that incited the first big wave of public interest in the field of cryptography. Before the 1970s, strong cryptographic knowledge was kept secret by <span class="keep-together">governments</span>.</p>
</div>
<div class="paragraph data-line-30">
<p>Public key cryptography uses unique keys to secure information. These keys are based on mathematical functions that have a special property: it is easy to calculate them, but hard to calculate their inverse. Based on these functions, cryptography enables the creation of digital secrets and unforgeable digital signatures, which are secured by the laws of mathematics.</p>
</div>
<div class="paragraph data-line-32">
<p>For example, multiplying two large prime numbers together is trivial. But given the product of two large primes, it is very difficult to find the prime factors (a problem called <em>prime factorization</em>). Let&#8217;s say we present the number 8,018,009 and tell you it is the product of two primes. Finding those two primes is much harder for you than it was for me to multiply them to produce 8,018,009.</p>
</div>
<div class="paragraph data-line-34">
<p>Some of these mathematical functions can be inverted easily if you know some secret information. In the preceding example, if I tell you that one of the prime factors is 2,003, you can trivially find the other one with a simple division: 8,018,009 ÷ 2,003 = 4,003. Such functions are often called <em>trapdoor functions</em> because they are very difficult to invert unless you are given a piece of secret information that can be used as a shortcut to reverse the function.</p>
</div>
<div class="paragraph data-line-36">
<p>A more advanced category of mathematical functions that is useful in cryptography is based on arithmetic operations on an elliptic curve. In elliptic curve arithmetic, multiplication modulo a prime is simple but division (the inverse) is practically impossible. This is called the <em>discrete logarithm problem</em> and there are currently no known trapdoors. <em>Elliptic curve cryptography</em> is used extensively in modern computer systems and is the basis of Ethereum&#8217;s (and other cryptocurrencies') use of private keys and digital signatures.</p>
</div>
<div class="admonitionblock note data-line-39">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-40">
<p>Take a look at the following resources if you&#8217;re interested in reading more about cryptography and the mathematical functions that are used in modern cryptography:</p>
</div>
<div class="ulist data-line-42">
<ul>
<li class="data-line-42">
<p><a href="http://bit.ly/2DcwNhn" data-href="http://bit.ly/2DcwNhn">Cryptography</a></p>
</li>
<li class="data-line-44">
<p><a href="http://bit.ly/2zeZV3c" data-href="http://bit.ly/2zeZV3c">Trapdoor function</a></p>
</li>
<li class="data-line-46">
<p><a href="http://bit.ly/2ACJjnV" data-href="http://bit.ly/2ACJjnV">Prime factorization</a></p>
</li>
<li class="data-line-48">
<p><a href="http://bit.ly/2Q7mZYI" data-href="http://bit.ly/2Q7mZYI">Discrete logarithm</a></p>
</li>
<li class="data-line-50">
<p><a href="http://bit.ly/2zfeKCP" data-href="http://bit.ly/2zfeKCP">Elliptic curve cryptography</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-53">
<p>In Ethereum, we use public key cryptography (also known as asymmetric cryptography) to create the public–private key pair we have been talking about in this chapter. They are considered a "pair" because the public key is derived from the private key. Together, they represent an Ethereum account by providing, respectively, a publicly accessible account handle (the address) and private control over access to any ether in the account and over any authentication the account needs when using smart contracts. The private key controls access by being the unique piece of information needed to create <em>digital signatures</em>, which are required to sign transactions to spend any funds in the account. Digital signatures are also used to authenticate owners or users of contracts, as we will see in <a href="#smart_contracts_chapter">Contrats intelligents et Solidity</a>.</p>
</div>
<div class="admonitionblock tip data-line-56">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-57">
<p>In most wallet implementations, the private and public keys are stored together as a <em>key pair</em> for convenience. However, the public key can be trivially calculated from the private key, so storing only the private key is also possible.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-60">
<p>A digital signature can be created to sign any message. For Ethereum transactions, the details of the transaction itself are used as the message. The mathematics of cryptography&#x2014;in this case, elliptic curve cryptography&#x2014;provides a way for the message (i.e., the transaction details) to be combined with the private key to create a code that can only be produced with knowledge of the private key. That
code is called the digital signature. Note that an Ethereum transaction is basically a request to access a particular account with a particular Ethereum address. When a transaction is sent to the Ethereum network in order to move funds or interact with smart contracts, it needs to be sent with a digital signature created with the private key corresponding to the Ethereum address in question. Elliptic curve mathematics means that <em>anyone</em> can verify that a transaction is valid, by checking that the digital signature matches the transaction details <em>and</em> the Ethereum address to which access is being requested. The verification doesn&#8217;t involve the private key at all; that remains private. However, the verification process determines beyond doubt that the transaction could have only come from someone with the private key that corresponds to the public key behind the Ethereum address. This is the "magic" of public key cryptography.</p>
</div>
<div class="admonitionblock tip data-line-65">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-66">
<p>There is no encryption as part of the Ethereum protocol&#x2014;all messages that are sent as part of the operation of the Ethereum network can (necessarily) be read by everyone. As such, private keys are only used to create digital signatures for transaction authentication.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-70">
<h3 id="private_keys">Private Keys</h3>
<div class="paragraph data-line-72">
<p>A private key is simply a number, picked at random. Ownership and control of the private key is the root of user control over all funds associated with the corresponding Ethereum address, as well as access to contracts that authorize that address. The private key is used to create signatures required to spend ether by proving ownership of funds used in a transaction. The private key must remain secret at all times, because revealing it to third parties is equivalent to giving them control over the ether and contracts secured by that private key. The private key must also be backed up and protected from accidental loss. If it&#8217;s lost, it cannot be recovered and the funds secured by it are lost forever too.</p>
</div>
<div class="admonitionblock tip data-line-75">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-76">
<p>The Ethereum private key is just a number. One way to pick your private keys randomly is to simply use a coin, pencil, and paper: toss a coin 256 times and you have the binary digits of a random private key you can use in an Ethereum wallet (probably&#x2014;see the next section). The public key and address can then be generated from the private key.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-80">
<h4 id="generating_private_key">Generating a Private Key from a Random Number</h4>
<div class="paragraph data-line-82">
<p>The first and most important step in generating keys is to find a secure source of entropy, or randomness. Creating an Ethereum private key essentially involves picking a number between 1 and 2<sup>256</sup>. The exact method you use to pick that number does not matter as long as it is not predictable or deterministic. Ethereum software uses the underlying operating system&#8217;s random number generator to produce 256 random bits. Usually, the OS random number generator is initialized by a human source of randomness, which is why you may be asked to wiggle your mouse around for a few seconds, or press random keys on your keyboard. An alternative could be cosmic radiation noise on the computer&#8217;s microphone channel.</p>
</div>
<div class="paragraph data-line-84">
<p>More precisely, a private key can be any nonzero number up to a very large number slightly less than 2<sup>256</sup>&#x2014;a huge 78-digit number, roughly 1.158 * 10<sup>77</sup>. The exact number shares the first 38 digits with 2<sup>256</sup> and is defined as the order of the elliptic curve used in Ethereum (see <a href="#elliptic_curve">Elliptic Curve Cryptography Explained</a>). To create a private key, we randomly pick a 256-bit number and check that it is within the valid range. In programming terms, this is usually achieved by feeding an even larger string of random bits (collected from a cryptographically secure source of randomness) into a 256-bit hash algorithm such as Keccak-256 or SHA-256, both of which will conveniently produce a 256-bit number. If the result is within the valid range, we have a suitable private key. Otherwise, we simply try again with another random number.</p>
</div>
<div class="admonitionblock tip data-line-87">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-88">
<p>2<sup>256</sup>&#x2014;the size of Ethereum&#8217;s private key space&#x2014;is an unfathomably large number. It is approximately 10<sup>77</sup> in decimal; that is, a number with 77 digits. For comparison, the visible universe is estimated to contain 10<sup>80</sup> atoms. Thus, there are almost enough private keys to give every atom in the universe an Ethereum account. If you pick a private key randomly, there is no conceivable way anyone will ever guess it or pick it themselves.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-91">
<p>Note that the private key generation process is an offline one; it does not require any communication with the Ethereum network, or indeed any communication with anyone at all. As such, in order to pick a number that no one else will ever pick, it needs to be truly random. If you choose the number yourself, the chance that someone else will try it (and then run off with your ether) is too high. Using a bad random number generator (like the pseudorandom rand function in most programming languages) is even worse, because it is even more obvious and even easier to replicate. Just like with passwords for online accounts, the private key needs to be unguessable. Fortunately, you never need to remember your private key, so you can take the best possible approach for picking it: namely, true randomness.</p>
</div>
<div class="admonitionblock warning data-line-94">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-95">
<p>Do not write your own code to create a random number or use a "simple" random number generator offered by your programming language. It is vital that you use a cryptographically secure pseudo-random number generator (such as CSPRNG) with a seed from a source of sufficient entropy. Study the documentation of the random number generator library you choose to make sure it is cryptographically secure. Correct implementation of the CSPRNG library is critical to the security of the keys.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-98">
<p>The following is a randomly generated private key shown in hexadecimal format (256 bits shown as 64 hexadecimal digits, each 4 bits):</p>
</div>
<div id="prv_key_example" class="listingblock data-line-101">
<div class="content">
<pre>f8f8a2f43c8376ccb0871305060d7b27b0554d2cc72bccf41b2705608452f315</pre>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-107">
<h3 id="pubkey">Public Keys</h3>
<div class="paragraph data-line-109">
<p>An Ethereum public key is a <em>point</em> on an elliptic curve, meaning it is a set of <em>x</em> and <em>y</em> coordinates that satisfy the elliptic curve equation.</p>
</div>
<div class="paragraph data-line-111">
<p>In simpler terms, an Ethereum public key is two numbers, joined together. These numbers are produced from the private key by a calculation that can <em>only go one way</em>. That means that it is trivial to calculate a public key if you have the private key, but you cannot calculate the private key from the public key.</p>
</div>
<div class="admonitionblock warning data-line-114">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-115">
<p>MATH is about to happen! Don&#8217;t panic. If you start to get lost at any point in the following paragraphs, you can skip the next few sections. There are many tools and libraries that will do the math for you.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-118">
<p>The public key is calculated from the private key using elliptic curve multiplication, which is practically irreversible: <em>K</em> = <em>k</em> * <em>G</em>, where <em>k</em> is the private key, <em>G</em> is a constant point called the <em>generator point</em>, <em>K</em> is the resulting public key, and * is the special elliptic curve "multiplication" operator. Note that elliptic curve multiplication is not like normal multiplication. It shares functional attributes with normal multiplication, but that is about it. For example, the reverse operation (which would be division for normal numbers), known as "finding the discrete logarithm&#x201d;&#x2014;i.e., calculating <em>k</em> if you know <em>K</em>&#x2014;is as difficult as trying all possible values of <em>k</em> (a brute-force search that will likely take more time than this universe will allow for).</p>
</div>
<div class="paragraph data-line-120">
<p>In simpler terms: arithmetic on the elliptic curve is different from "regular" integer arithmetic. A point (<em>G</em>) can be multiplied by an integer (<em>k</em>) to produce another point (<em>K</em>). But there is no such thing as <em>division</em>, so it is not possible to simply "divide" the public key <em>K</em> by the point <em>G</em> to calculate the private key <em>k</em>. This is the one-way mathematical function described in <a href="#pkc">Public Key Cryptography and Cryptocurrency</a>.</p>
</div>
<div class="admonitionblock note data-line-123">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-124">
<p>Elliptic curve multiplication is a type of function that cryptographers call a "one-way" function: it is easy to do in one direction (multiplication) and impossible to do in the reverse direction (division). The owner of the private key can easily create the public key and then share it with the world, knowing that no one can reverse the function and calculate the private key from the public key. This mathematical trick becomes the basis for unforgeable and secure digital signatures that prove ownership of Ethereum funds and control of contracts.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-127">
<p>Before we demonstrate how to generate a public key from a private key, let&#8217;s look at elliptic curve cryptography in a bit more detail.</p>
</div>
<div class="sect3 data-line-131">
<h4 id="elliptic_curve">Elliptic Curve Cryptography Explained</h4>
<div class="paragraph data-line-133">
<p>Elliptic curve cryptography is a type of asymmetric or public key cryptography based on the discrete logarithm problem as expressed by addition and multiplication on the points of an elliptic curve.</p>
</div>
<div class="paragraph data-line-135">
<p><a href="#ecc-curve">A visualization of an elliptic curve</a> is an example of an elliptic curve, similar to that used by Ethereum.</p>
</div>
<div class="admonitionblock note data-line-138">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-139">
<p>Ethereum uses the exact same elliptic curve, called secp256k1, as Bitcoin. That makes it possible to reuse many of the elliptic curve libraries and tools from Bitcoin.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="ecc-curve" class="imageblock data-line-144">
<div class="content">
<img src="images/simple_elliptic_curve.png" alt="ecc-curve">
</div>
<div class="title">Figure 25. A visualization of an elliptic curve</div>
</div>
<div class="paragraph data-line-146">
<p>Ethereum uses a specific elliptic curve and set of mathematical constants, as defined in a standard called secp256k1, established by the US National Institute of Standards and Technology (NIST). The secp256k1 curve is defined by the following function, which produces an elliptic curve:</p>
</div>
<div data-type="equation">
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow>
    <mrow>
      <msup><mi>y</mi> <mn>2</mn> </msup>
      <mo>=</mo>
      <mrow>
        <mo>(</mo>
        <msup><mi>x</mi> <mn>3</mn> </msup>
        <mo>+</mo>
        <mn>7</mn>
        <mo>)</mo>
      </mrow>
    </mrow>
    <mspace width="3.33333pt"/>
    <mtext>over</mtext>
    <mspace width="3.33333pt"/>
    <mrow>
      <mo>(</mo>
      <msub><mi>&#x1d53d;</mi> <mi>p</mi> </msub>
      <mo>)</mo>
    </mrow>
  </mrow>
</math>
</div>
<div class="paragraph data-line-176">
<p>or:</p>
</div>
<div data-type="equation">
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow>
    <msup><mi>y</mi> <mn>2</mn> </msup>
    <mspace width="3.33333pt"/>
    <mo form="prefix">mod</mo>
    <mspace width="0.277778em"/>
    <mi>p</mi>
    <mo>=</mo>
    <mrow>
      <mo>(</mo>
      <msup><mi>x</mi> <mn>3</mn> </msup>
      <mo>+</mo>
      <mn>7</mn>
      <mo>)</mo>
    </mrow>
    <mspace width="3.33333pt"/>
    <mo form="prefix">mod</mo>
    <mspace width="0.277778em"/>
    <mi>p</mi>
  </mrow>
</math>
</div>
<div class="paragraph data-line-204">
<p>The <em>mod p</em> (modulo prime number <em>p</em>) indicates that this curve is over a finite field of prime order <em>p</em>, also written as \(\( \mathbb{F}_p \)\), where <em>p</em> = 2<sup>256</sup> – 2<sup>32</sup> – 2<sup>9</sup> – 2<sup>8</sup> – 2<sup>7</sup> – 2<sup>6</sup> – 2<sup>4</sup> – 1, which is a very large prime number.</p>
</div>
<div class="paragraph data-line-206">
<p>Because this curve is defined over a finite field of prime order instead of over the real numbers, it looks like a pattern of dots scattered in two dimensions, which makes it difficult to visualize. However, the math is identical to that of an elliptic curve over real numbers. As an example, <a href="#ecc-over-F17-math">Elliptic curve cryptography: visualizing an elliptic curve over F(p), with p=17</a> shows the same elliptic curve over a much smaller finite field of prime order 17, showing a pattern of dots on a grid. The secp256k1 Ethereum elliptic curve can be thought of as a much more complex pattern of dots on an unfathomably large grid.</p>
</div>
<div id="ecc-over-F17-math" class="imageblock smallersixty data-line-211">
<div class="content">
<img src="images/ec_over_small_prime_field.png" alt="ecc-over-F17-math">
</div>
<div class="title">Figure 26. Elliptic curve cryptography: visualizing an elliptic curve over F(p), with p=17</div>
</div>
<div class="paragraph data-line-213">
<p>So, for example, the following is a point <em>Q</em> with coordinates (<em>x</em>,<em>y</em>) that is a point on the secp256k1 curve:</p>
</div>
<div id="coordinates_example" class="listingblock data-line-216">
<div class="content">
<pre>Q =
(49790390825249384486033144355916864607616083520101638681403973749255924539515,
59574132161899900045862086493921015780032175291755807399284007721050341297360)</pre>
</div>
</div>
<div class="paragraph data-line-222">
<p><a href="#example_1">[example_1]</a> shows how you can check this yourself using Python. The variables x and y are the coordinates of the point <em>Q</em>, as in the preceding example. The variable p is the prime order of the elliptic curve (the prime that is used for all the modulo operations). The last line of Python is the elliptic curve equation (the % operator in Python is the modulo operator). If x and y are indeed the coordinates of a point on the elliptic curve, then they satisfy the equation and the result is zero (0L is a long integer with value zero). Try it yourself, by typing **python** on a command line and copying each line (after the prompt &gt;&gt;&gt;) from the listing.</p>
</div>
<div data-type="example" id="example_1">
<h5>Using Python to confirm that this point is on the elliptic curve</h5>
<pre data-type="programlisting">
Python 3.4.0 (default, Mar 30 2014, 19:23:13)
[GCC 4.2.1 Compatible Apple LLVM 5.1 (clang-503.0.38)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>> <strong>p = 115792089237316195423570985008687907853269984665640564039457584007908834 \
671663</strong>
>>> <strong>x = 49790390825249384486033144355916864607616083520101638681403973749255924539515</strong>
>>> <strong>y = 59574132161899900045862086493921015780032175291755807399284007721050341297360</strong>
>>> <strong>(x ** 3 + 7 - y**2) % p</strong>
0L
</pre>
</div>
</div>
<div class="sect3 data-line-242">
<h4 id="EC_math">Elliptic Curve Arithmetic Operations</h4>
<div class="paragraph data-line-244">
<p>A lot of elliptic curve math looks and works very much like the integer arithmetic we learned at school. Specifically, we can define an addition operator, which instead of jumping along the number line is jumping to other points on the curve. Once we have the addition operator, we can also define multiplication of a point and a whole number, which is equivalent to repeated addition.</p>
</div>
<div class="paragraph data-line-246">
<p>Elliptic curve addition is defined such that given two points <em>P</em><sub>1</sub> and <em>P</em><sub>2</sub> on the elliptic curve, there is a third point <em>P</em><sub>3</sub> = <em>P</em><sub>1</sub> + <em>P</em><sub>2</sub>, also on the elliptic curve.</p>
</div>
<div class="paragraph data-line-248">
<p>Geometrically, this third point <em>P</em><sub>3</sub> is calculated by drawing a line between <em>P</em><sub>1</sub> and <em>P</em><sub>2</sub>. This line will intersect the elliptic curve in exactly one additional place (amazingly). Call this point <em>P</em><sub>3</sub>' = (<em>x</em>, <em>y</em>). Then reflect in the x-axis to get <em>P</em><sub>3</sub> = (<em>x</em>, <em>–y</em>).</p>
</div>
<div class="paragraph data-line-250">
<p>If <em>P</em><sub>1</sub> and <em>P</em><sub>2</sub> are the same point, the line "between" <em>P</em><sub>1</sub> and <em>P</em><sub>2</sub> should extend to be the tangent to the curve at this point <em>P</em><sub>1</sub>. This tangent will intersect the curve at exactly one new point. You can use techniques from calculus to determine the slope of the tangent line. Curiously, these techniques work, even though we are restricting our interest to points on the curve with two integer coordinates!</p>
</div>
<div class="paragraph data-line-252">
<p>In elliptic curve math, there is also a point called the "point at infinity," which roughly corresponds to the role of the number zero in addition. On computers, it&#8217;s sometimes represented by <em>x</em> = <em>y</em> = 0 (which doesn&#8217;t satisfy the elliptic curve equation, but it&#8217;s an easy separate case that can be checked). There are a couple of special cases that explain the need for the point at infinity.</p>
</div>
<div class="paragraph data-line-254">
<p>In some cases (e.g., if <em>P</em><sub>1</sub> and <em>P</em><sub>2</sub> have the same <em>x</em> values but different <em>y</em> values), the line will be exactly vertical, in which case <em>P</em><sub>3</sub> = the point at infinity.</p>
</div>
<div class="paragraph data-line-256">
<p>If <em>P</em><sub>1</sub> is the point at infinity, then <em>P</em><sub>1</sub> + <em>P</em><sub>2</sub> = <em>P</em><sub>2</sub>. Similarly, if <em>P</em><sub>2</sub> is the point at infinity, then <em>P</em><sub>1</sub> + <em>P</em><sub>2</sub> = <em>P</em><sub>1</sub>. This shows how the point at infinity plays the role that zero plays in "normal" arithmetic.</p>
</div>
<div class="paragraph data-line-258">
<p>It turns out that + is associative, which means that (<em>A</em> + <em>B</em>) + <em>C</em> = <em>A</em> + (<em>B</em> + <em>C</em>). That means we can write <em>A</em> + <em>B</em> + <em>C</em> (without parentheses) without ambiguity.</p>
</div>
<div class="paragraph data-line-260">
<p>Now that we have defined addition, we can define multiplication in the standard way that extends addition. For a point <em>P</em> on the elliptic curve, if <em>k</em> is a whole number, then <em>k</em> * <em>P</em> = <em>P</em> + <em>P</em> + <em>P</em> + &#8230;&#8203; + <em>P</em> (<em>k</em> times). Note that <em>k</em> is sometimes (perhaps confusingly) called an "exponent" in this case.</p>
</div>
</div>
<div class="sect3 data-line-263">
<h4 id="public_key_derivation">Generating a Public Key</h4>
<div class="paragraph data-line-265">
<p>Starting with a private key in the form of a randomly generated number <em>k</em>, we multiply it by a predetermined point on the curve called the <em>generator point</em> <em>G</em> to produce another point somewhere else on the curve, which is the corresponding public key <em>K</em>:</p>
</div>
<div data-type="equation">
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow>
    <mi>K</mi>
    <mo>=</mo>
    <mi>k</mi>
    <mo>*</mo>
    <mi>G</mi>
  </mrow>
</math>
</div>
<div class="paragraph data-line-281">
<p>The generator point is specified as part of the secp256k1 standard; it is the same for all implementations of secp256k1, and all keys derived from that curve use the same point <em>G</em>. Because the generator point is always the same for all Ethereum users, a private key <em>k</em> multiplied with <em>G</em> will always result in the same public key <em>K</em>. The relationship between <em>k</em> and <em>K</em> is fixed, but can only be calculated in one direction, from <em>k</em> to <em>K</em>. That&#8217;s why an Ethereum address (derived from <em>K</em>) can be shared with anyone and does not reveal the user&#8217;s private key (<em>k</em>).</p>
</div>
<div class="paragraph data-line-283">
<p>As we described in the previous section, the multiplication of <em>k</em> * <em>G</em> is equivalent to repeated addition, so <em>G</em> + <em>G</em> + <em>G</em> + &#8230;&#8203; + <em>G</em>, repeated <em>k</em> times. In summary, to produce a public key <em>K</em> from a private key <em>k</em>, we add the generator point <em>G</em> to itself, <em>k</em> times.</p>
</div>
<div class="admonitionblock tip data-line-286">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-287">
<p>A private key can be converted into a public key, but a public key cannot be converted back into a private key, because the math only works one way.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-290">
<p>Let&#8217;s apply this calculation to find the public key for the specific private key we showed you in <a href="#private_keys">Private Keys</a>:</p>
</div>
<div id="example_privkey" class="listingblock data-line-295">
<div class="title">Example private key to public key calculation</div>
<div class="content">
<pre>K = f8f8a2f43c8376ccb0871305060d7b27b0554d2cc72bccf41b2705608452f315 * G</pre>
</div>
</div>
<div class="paragraph data-line-299">
<p>A cryptographic library can help us calculate <em>K</em>, using elliptic curve multiplication. The resulting public key <em>K</em> is defined as the point:</p>
</div>
<div class="listingblock data-line-301">
<div class="content">
<pre>K = (x, y)</pre>
</div>
</div>
<div class="paragraph data-line-305">
<p>where:</p>
</div>
<div class="listingblock data-line-307">
<div class="content">
<pre>x = 6e145ccef1033dea239875dd00dfb4fee6e3348b84985c92f103444683bae07b
y = 83b5c38e5e2b0c8529d7fa3f64d46daa1ece2d9ac14cab9477d042c84c32ccd0</pre>
</div>
</div>
<div class="paragraph data-line-312">
<p>In Ethereum you may see public keys represented as a serialization of 130 hexadecimal characters (65 bytes). This is adopted from a standard serialization format proposed by the industry consortium Standards for Efficient Cryptography Group (SECG), documented in <a href="http://www.secg.org/sec1-v2.pdf" data-href="http://www.secg.org/sec1-v2.pdf">Standards for Efficient Cryptography (SEC1)</a>. The standard defines four possible prefixes that can be used to identify points on an elliptic curve, listed in <a href="#EC_prefix_table">Serialized EC public key prefixes</a>.</p>
</div>
<table id="EC_prefix_table" class="tableblock frame-all grid-all stretch data-line-317">
<caption class="title">Table 2. Serialized EC public key prefixes</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Prefix</th>
<th class="tableblock halign-left valign-top">Meaning</th>
<th class="tableblock halign-left valign-top">Length (bytes counting prefix)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Point at infinity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x04</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uncompressed point</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">65</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x02</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compressed point with even y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x03</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compressed point with odd y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-325">
<p>Ethereum only uses uncompressed public keys; therefore the only prefix that is relevant is (hex) 04. The serialization concatenates the <em>x</em> and <em>y</em> coordinates of the public key:</p>
</div>
<div id="concat_coordinates" class="listingblock data-line-328">
<div class="content">
<pre>04 + x-coordinate (32 bytes/64 hex) + y-coordinate (32 bytes/64 hex)</pre>
</div>
</div>
<div class="paragraph data-line-332">
<p>Therefore, the public key we calculated earlier is serialized as:</p>
</div>
<div id="serialized_pubkey" class="listingblock data-line-335">
<div class="content">
<pre>046e145ccef1033dea239875dd00dfb4fee6e3348b84985c92f103444683bae07b83b5c38e5e2b0 \
c8529d7fa3f64d46daa1ece2d9ac14cab9477d042c84c32ccd0</pre>
</div>
</div>
</div>
<div class="sect3 data-line-341">
<h4 id="EC_lib">Elliptic Curve Libraries</h4>
<div class="paragraph data-line-343">
<p>There are a couple of implementations of the secp256k1 elliptic curve that are used in cryptocurrency-related projects:</p>
</div>
<div class="dlist data-line-345">
<dl>
<dt class="hdlist1"><a href="https://www.openssl.org/" data-href="https://www.openssl.org/">OpenSSL</a></dt>
<dd>
<p>The OpenSSL library offers a comprehensive set of cryptographic primitives, including a full implementation of secp256k1. For example, to derive the public key, the function EC_POINT_mul can be used.</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/bitcoin-core/secp256k1" data-href="https://github.com/bitcoin-core/secp256k1">libsecp256k1</a></dt>
<dd>
<p>Bitcoin Core&#8217;s libsecp256k1 is a C-language implementation of the secp256k1 elliptic curve and other cryptographic primitives. It was written from scratch to replace OpenSSL in Bitcoin Core software, and is considered superior in both performance and security.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2 data-line-350">
<h3 id="hash_functions">Cryptographic Hash Functions</h3>
<div class="paragraph data-line-352">
<p>Cryptographic hash functions are used throughout Ethereum. In fact, hash functions are used extensively in almost all cryptographic systems&#x2014;a fact captured by <span class="keep-together">cryptographer</span> <a href="http://bit.ly/2Q79qZp" data-href="http://bit.ly/2Q79qZp">Bruce Schneier</a>, who said, "Much more than encryption algorithms, one-way hash functions are the workhorses of modern cryptography."</p>
</div>
<div class="paragraph data-line-354">
<p>In this section we will discuss hash functions, explore their basic properties, and see how those properties make them so useful in so many areas of modern cryptography. We address hash functions here because they are part of the transformation of Ethereum public keys into addresses. They can also be used to create <em>digital fingerprints</em>, which aid in the verification of data.</p>
</div>
<div class="paragraph data-line-356">
<p>In simple terms, a <a href="http://bit.ly/2CR26gD" data-href="http://bit.ly/2CR26gD"><em>hash function</em></a> is &#x201c;any function that can be used to map data of arbitrary size to data of fixed size.&#x201d; The input to a hash function is called a <em>pre-image</em>, the <em>message</em>, or simply the <em>input data</em>. The output is called the <em>hash</em>. <a href="http://bit.ly/2Jrn3jM" data-href="http://bit.ly/2Jrn3jM"><em>Cryptographic hash functions</em></a> are a special subcategory that have specific properties that are useful to secure platforms, such as Ethereum.</p>
</div>
<div class="paragraph data-line-358">
<p>A cryptographic hash function is a <em>one-way</em> hash function that maps data of arbitrary size to a fixed-size string of bits. The "one-way" nature means that it is computationally infeasible to recreate the input data if one only knows the output hash. The only way to determine a possible input is to conduct a brute-force search, checking each candidate for a matching output; given that the search space is virtually infinite, it is easy to understand the practical impossibility of the task. Even if you find some input data that creates a matching hash, it may not be the original input data: hash functions are "many-to-one" functions. Finding two sets of input data that hash to the same output is called finding a <em>hash collision</em>. Roughly speaking, the better the hash function, the rarer hash collisions are. For Ethereum, they are effectively impossible.</p>
</div>
<div class="paragraph data-line-360">
<p>Let&#8217;s take a closer look at the main properties of cryptographic hash functions. These include:</p>
</div>
<div class="dlist data-line-362">
<dl>
<dt class="hdlist1">Determinism</dt>
<dd>
<p>A given input message always produces the same hash output.</p>
</dd>
<dt class="hdlist1">Verifiability</dt>
<dd>
<p>Computing the hash of a message is efficient (linear complexity).</p>
</dd>
<dt class="hdlist1">Noncorrelation</dt>
<dd>
<p>A small change to the message (e.g., a 1-bit change) should change the hash output so extensively that it cannot be correlated to the hash of the original message.</p>
</dd>
<dt class="hdlist1">Irreversibility</dt>
<dd>
<p>Computing the message from its hash is infeasible, equivalent to a brute-force search through all possible messages.</p>
</dd>
<dt class="hdlist1">Collision protection</dt>
<dd>
<p>It should be infeasible to calculate two different messages that produce the same hash output.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-372">
<p>Resistance to hash collisions is particularly important for avoiding digital signature forgery in Ethereum.</p>
</div>
<div class="paragraph data-line-374">
<p>The combination of these properties make cryptographic hash functions useful for a broad range of security applications, including:</p>
</div>
<div class="ulist data-line-376">
<ul>
<li class="data-line-376">
<p>Data fingerprinting</p>
</li>
<li class="data-line-377">
<p>Message integrity (error detection)</p>
</li>
<li class="data-line-378">
<p>Proof of work</p>
</li>
<li class="data-line-379">
<p>Authentication (password hashing and key stretching)</p>
</li>
<li class="data-line-380">
<p>Pseudorandom number generators</p>
</li>
<li class="data-line-381">
<p>Message commitment (commit–reveal mechanisms)</p>
</li>
<li class="data-line-382">
<p>Unique identifiers</p>
</li>
</ul>
</div>
<div class="paragraph data-line-384">
<p>We will find many of these in Ethereum as we progress through the various layers of the system.</p>
</div>
<div class="sect3 data-line-387">
<h4 id="keccak256">Ethereum&#8217;s Cryptographic Hash Function: Keccak-256</h4>
<div class="paragraph data-line-389">
<p>Ethereum uses the <em>Keccak-256</em> cryptographic hash function in many places. Keccak-256 was designed as a candidate for the SHA-3 Cryptographic Hash Function Competition held in 2007 by the National Institute of Science and Technology. Keccak was the winning algorithm, which became standardized as Federal Information Processing Standard (FIPS) 202 in 2015.</p>
</div>
<div class="paragraph data-line-391">
<p>However, during the period when Ethereum was developed, the NIST standardization was not yet finalized. NIST adjusted some of the parameters of Keccak after the completion of the standards process, allegedly to improve its efficiency. This was occurring at the same time as heroic whistleblower Edward Snowden revealed documents that imply that NIST may have been improperly influenced by the National Security Agency to intentionally weaken the Dual_EC_DRBG random-number generator standard, effectively placing a backdoor in the standard random number generator. The result of this controversy was a backlash against the proposed changes and a significant delay in the standardization of SHA-3. At the time, the Ethereum Foundation decided to implement the original Keccak algorithm, as proposed by its inventors, rather than the SHA-3 standard as modified by NIST.</p>
</div>
<div class="admonitionblock warning data-line-394">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-395">
<p>While you may see "SHA-3" mentioned throughout Ethereum documents and code, many if not all of those instances actually refer to Keccak-256, not the finalized FIPS-202 SHA-3 standard. The implementation differences are slight, having to do with padding parameters, but they are significant in that Keccak-256 produces different hash outputs from FIPS-202 SHA-3 for the same input.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-399">
<h4 id="which_hash">Which Hash Function Am I Using?</h4>
<div class="paragraph data-line-401">
<p>How can you tell if the software library you are using implements FIPS-202 SHA-3 or Keccak-256, if both might be called "SHA-3"?</p>
</div>
<div class="paragraph data-line-403">
<p>An easy way to tell is to use a <em>test vector</em>, an expected output for a given input. The test most commonly used for a hash function is the <em>empty input</em>. If you run the hash function with an empty string as input you should see the following results:</p>
</div>
<div class="listingblock data-line-405">
<div class="content">
<pre>Keccak256("") =
  c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470

SHA3("") =
  a7ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a</pre>
</div>
</div>
<div class="paragraph data-line-414">
<p>Regardless of what the function is called, you can test it to see whether it is the original Keccak-256 or the final NIST standard FIPS-202 SHA-3 by running this simple test. Remember, Ethereum uses Keccak-256, even though it is often called SHA-3 in the code.</p>
</div>
<div class="admonitionblock note data-line-417">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-418">
<p>Due to the confusion created by the difference between the hash function used in Ethereum (Keccak-256) and the finalized standard (FIP-202 SHA-3), there is an effort underway to rename all instances of sha3 in all code, opcodes, and libraries to keccak256. See <a href="https://github.com/ethereum/EIPs/issues/59" data-href="https://github.com/ethereum/EIPs/issues/59">ERC59</a> for details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-422">
<p>Next, let&#8217;s examine the first application of Keccak-256 in Ethereum, which is to produce Ethereum addresses from public keys.</p>
</div>
</div>
</div>
<div class="sect2 data-line-425">
<h3 id="eth_address">Ethereum Addresses</h3>
<div class="paragraph data-line-427">
<p>Ethereum addresses are <em>unique identifiers</em> that are derived from public keys or contracts using the Keccak-256 one-way hash function.</p>
</div>
<div class="paragraph data-line-429">
<p>In our previous examples, we started with a private key and used elliptic curve multiplication to derive a public key:</p>
</div>
<div class="paragraph pagebreak-before data-line-432">
<p>Private key <em>k</em>:</p>
</div>
<div class="listingblock data-line-434">
<div class="content">
<pre>k = f8f8a2f43c8376ccb0871305060d7b27b0554d2cc72bccf41b2705608452f315</pre>
</div>
</div>
<div id="concat_pubkey" class="paragraph data-line-439">
<p>Public key <em>K</em> (<em>x</em> and <em>y</em> coordinates concatenated and shown as hex):</p>
</div>
<div class="listingblock data-line-441">
<div class="content">
<pre>K = 6e145ccef1033dea239875dd00dfb4fee6e3348b84985c92f103444683bae07b83b5c38e5e...</pre>
</div>
</div>
<div class="admonitionblock note data-line-446">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-447">
<p>It is worth noting that the public key is not formatted with the prefix (hex) 04 when the address is calculated.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-450">
<p>We use Keccak-256 to calculate the <em>hash</em> of this public key:</p>
</div>
<div id="calculate_hash" class="listingblock data-line-453">
<div class="content">
<pre>Keccak256(K) = 2a5bc342ed616b5ba5732269001d3f1ef827552ae1114027bd3ecf1f086ba0f9</pre>
</div>
</div>
<div class="paragraph data-line-457">
<p>Then we keep only the last 20 bytes (least significant bytes), which is our Ethereum address:</p>
</div>
<div id="keep_last_20" class="listingblock data-line-460">
<div class="content">
<pre>001d3f1ef827552ae1114027bd3ecf1f086ba0f9</pre>
</div>
</div>
<div class="paragraph data-line-464">
<p>Most often you will see Ethereum addresses with the prefix 0x that indicates they are hexadecimal-encoded, like this:</p>
</div>
<div id="hex_prefix" class="listingblock data-line-467">
<div class="content">
<pre>0x001d3f1ef827552ae1114027bd3ecf1f086ba0f9</pre>
</div>
</div>
<div class="sect3 data-line-472">
<h4 id="eth_address_format">Ethereum Address Formats</h4>
<div class="paragraph data-line-474">
<p>Ethereum addresses are hexadecimal numbers, identifiers derived from the last 20 bytes of the Keccak-256 hash of the public key.</p>
</div>
<div class="paragraph data-line-476">
<p>Unlike Bitcoin addresses, which are encoded in the user interface of all clients to include a built-in checksum to protect against mistyped addresses, Ethereum addresses are presented as raw hexadecimal without any checksum.</p>
</div>
<div class="paragraph data-line-478">
<p>The rationale behind that decision was that Ethereum addresses would eventually be hidden behind abstractions (such as name services) at higher layers of the system and that checksums should be added at higher layers if necessary.</p>
</div>
<div class="paragraph data-line-480">
<p>In reality, these higher layers were developed too slowly and this design choice led to a number of problems in the early days of the ecosystem, including the loss of funds due to mistyped addresses and input validation errors. Furthermore, because Ethereum name services were developed slower than initially expected, alternative encodings were adopted very slowly by wallet developers. We&#8217;ll look at a few of the encoding options next.</p>
</div>
</div>
<div class="sect3 data-line-483">
<h4 id="ICAP">Inter Exchange Client Address Protocol</h4>
<div class="paragraph data-line-485">
<p>The <em>Inter exchange Client Address Protocol</em> (ICAP) is an Ethereum address encoding that is partly compatible with the International Bank Account Number (IBAN) encoding, offering a versatile, checksummed, and interoperable encoding for Ethereum addresses. ICAP addresses can encode Ethereum addresses or common names registered with an Ethereum name registry. You can read more about ICAP on the <a href="http://bit.ly/2JsZHKu" data-href="http://bit.ly/2JsZHKu">Ethereum Wiki</a>.</p>
</div>
<div class="paragraph data-line-487">
<p>IBAN is an international standard for identifying bank account numbers, mostly used for wire transfers. It is broadly adopted in the European Single Euro Payments Area (SEPA) and beyond. IBAN is a centralized and heavily regulated service. ICAP is a decentralized but compatible implementation for Ethereum addresses.</p>
</div>
<div class="paragraph data-line-489">
<p>An IBAN consists of a string of up to 34 alphanumeric characters (case-insensitive) comprising a country code, checksum, and bank account identifier (which is country-specific).</p>
</div>
<div class="paragraph data-line-491">
<p>ICAP uses the same structure by introducing a nonstandard country code, &#x201c;XE,&#x201d; that stands for "Ethereum,&#x201d; followed by a two-character checksum and three possible variations of an account identifier:</p>
</div>
<div class="dlist data-line-493">
<dl>
<dt class="hdlist1">Direct</dt>
<dd>
<p>A big-endian base-36 integer comprised of up to 30 alphanumeric characters, representing the 155 least significant bits of an Ethereum address. Because this encoding fits less than the full 160 bits of a general Ethereum address, it only works for Ethereum addresses that start with one or more zero bytes. The advantage is that it is compatible with IBAN, in terms of the field length and checksum. Example: XE60HAMICDXSV5QXVJA7TJW47Q9CHWKJD (33 characters long).</p>
</dd>
<dt class="hdlist1">Basic</dt>
<dd>
<p>Same as the Direct encoding, except that it is 31 characters long. This allows it to encode any Ethereum address, but makes it incompatible with IBAN field validation. Example: XE18CHDJBPLTBCJ03FE9O2NS0BPOJVQCU2P (35 characters long).</p>
</dd>
<dt class="hdlist1">Indirect</dt>
<dd>
<p>Encodes an identifier that resolves to an Ethereum address through a name registry provider. It uses 16 alphanumeric characters, comprising an <em>asset identifier</em> (e.g., ETH), a name service (e.g., XREG), and a 9-character human-readable name (e.g., KITTYCATS). Example: XE##ETHXREGKITTYCATS (20 characters long), where the ## should be replaced by the two computed checksum characters.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-499">
<p>We can use the helpeth command-line tool to create ICAP addresses. You can get helpeth by installing it with:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm install -g helpeth</strong>
</pre>
<div class="paragraph data-line-507">
<p>If you don&#8217;t have npm, you may have to install nodeJS first, which you can do by following the instructions at <a href="https://nodeJS.org" class="undefined" data-href="https://nodeJS.org">https://nodeJS.org</a>.</p>
</div>
<div class="paragraph data-line-509">
<p>Now that we have helpeth, let&#8217;s try creating an ICAP address with our example private key (prefixed with 0x and passed as a parameter to helpeth).</p>
</div>
<pre data-type="programlisting">
$ <strong>helpeth keyDetails \
  -p 0xf8f8a2f43c8376ccb0871305060d7b27b0554d2cc72bccf41b2705608452f315</strong>

Address: 0x001d3f1ef827552ae1114027bd3ecf1f086ba0f9
ICAP: XE60 HAMI CDXS V5QX VJA7 TJW4 7Q9C HWKJ D
Public key: 0x6e145ccef1033dea239875dd00dfb4fee6e3348b84985c92f103444683bae07b...
</pre>
<div class="paragraph data-line-522">
<p>The helpeth command constructs a hexadecimal Ethereum address as well as an ICAP address for us. The ICAP address for our example key is:</p>
</div>
<div id="ICAP_example" class="listingblock data-line-525">
<div class="content">
<pre>XE60HAMICDXSV5QXVJA7TJW47Q9CHWKJD</pre>
</div>
</div>
<div class="paragraph data-line-529">
<p>Because our example Ethereum address happens to start with a zero byte, it can be encoded using the Direct ICAP encoding method that is valid in IBAN format. You can tell because it is 33 characters long.</p>
</div>
<div class="paragraph data-line-531">
<p>If our address did not start with a zero, it would be encoded with the Basic encoding, which would be 35 characters long and invalid as an IBAN.</p>
</div>
<div class="admonitionblock tip data-line-534">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-535">
<p>The chances of any Ethereum address starting with a zero byte are 1 in 256. To generate one like that, it will take on average 256 attempts with 256 different random private keys before we find one that works as an IBAN-compatible "Direct" encoded ICAP address.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-538">
<p>At this time, ICAP is unfortunately only supported by a few wallets.</p>
</div>
</div>
<div class="sect3 data-line-541">
<h4 id="EIP55">Hex Encoding with Checksum in Capitalization (EIP-55)</h4>
<div class="paragraph data-line-543">
<p>Due to the slow deployment of ICAP and name services, a standard was proposed by <a href="https://github.com/Ethereum/EIPs/blob/master/EIPS/eip-55.md" data-href="https://github.com/Ethereum/EIPs/blob/master/EIPS/eip-55.md">Ethereum Improvement Proposal 55 (EIP-55)</a>. EIP-55 offers a backward-compatible checksum for Ethereum addresses by modifying the capitalization of the hexadecimal address. The idea is that Ethereum addresses are case-insensitive and all wallets are supposed to accept Ethereum addresses expressed in capital or lowercase characters, without any difference in interpretation.</p>
</div>
<div class="paragraph data-line-545">
<p>By modifying the capitalization of the alphabetic characters in the address, we can convey a checksum that can be used to protect the integrity of the address against typing or reading mistakes. Wallets that do not support EIP-55 checksums simply ignore the fact that the address contains mixed capitalization, but those that do support it can validate it and detect errors with a 99.986% accuracy.</p>
</div>
<div class="paragraph data-line-547">
<p>The mixed-capitals encoding is subtle and you may not notice it at first. Our example address is:</p>
</div>
<div class="listingblock data-line-549">
<div class="content">
<pre>0x001d3f1ef827552ae1114027bd3ecf1f086ba0f9</pre>
</div>
</div>
<div class="paragraph data-line-553">
<p>With an EIP-55 mixed-capitalization checksum it becomes:</p>
</div>
<div id="mixed_capitalization" class="listingblock data-line-556">
<div class="content">
<pre>0x001d3F1ef827552Ae1114027BD3ECF1f086bA0F9</pre>
</div>
</div>
<div class="paragraph data-line-560">
<p>Can you tell the difference? Some of the alphabetic (A&#x2013;F) characters from the hexadecimal encoding alphabet are now capital, while others are lowercase.</p>
</div>
<div class="paragraph data-line-562">
<p>EIP-55 is quite simple to implement. We take the Keccak-256 hash of the lowercase hexadecimal address. This hash acts as a digital fingerprint of the address, giving us a convenient checksum. Any small change in the input (the address) should cause a big change in the resulting hash (the checksum), allowing us to detect errors effectively. The hash of our address is then encoded in the capitalization of the address itself. Let&#8217;s break it down, step by step:</p>
</div>
<div class="olist arabic data-line-564">
<ol class="arabic">
<li class="data-line-564">
<p>Hash the lowercase address, without the 0x prefix:</p>
</li>
</ol>
</div>
<div id="hash_lower_case_address" class="listingblock data-line-567">
<div class="content">
<pre>Keccak256("001d3f1ef827552ae1114027bd3ecf1f086ba0f9") =
23a69c1653e4ebbb619b0b2cb8a9bad49892a8b9695d9a19d8f673ca991deae1</pre>
</div>
</div>
<div class="olist arabic data-line-573">
<ol class="arabic" start="2">
<li class="data-line-573">
<p>Capitalize each alphabetic address character if the corresponding hex digit of the hash is greater than or equal to 0x8. This is easier to show if we line up the address and the hash:</p>
</li>
</ol>
</div>
<div id="capitalize_input" class="listingblock data-line-576">
<div class="content">
<pre>Address: 001d3f1ef827552ae1114027bd3ecf1f086ba0f9
Hash   : 23a69c1653e4ebbb619b0b2cb8a9bad49892a8b9...</pre>
</div>
</div>
<div class="paragraph data-line-581">
<p>Our address contains an alphabetic character d in the fourth position. The fourth character of the hash is 6, which is less than 8. So, we leave the d lowercase. The next alphabetic character in our address is f, in the sixth position. The sixth character of the hexadecimal hash is c, which is greater than 8. Therefore, we capitalize the F in the address, and so on. As you can see, we only use the first 20 bytes (40 hex characters) of the hash as a checksum, since we only have 20 bytes (40 hex characters) in the address to capitalize appropriately.</p>
</div>
<div class="paragraph data-line-583">
<p>Check the resulting mixed-capitals address yourself and see if you can tell which characters were capitalized and which characters they correspond to in the address hash:</p>
</div>
<div id="capitalize_output" class="listingblock data-line-586">
<div class="content">
<pre>Address: 001d3F1ef827552Ae1114027BD3ECF1f086bA0F9
Hash   : 23a69c1653e4ebbb619b0b2cb8a9bad49892a8b9...</pre>
</div>
</div>
<div class="sect4 data-line-592">
<h5 id="EIP55_error">Detecting an error in an EIP-55 encoded address</h5>
<div class="paragraph data-line-594">
<p>Now, let&#8217;s look at how EIP-55 addresses will help us find an error. Let&#8217;s assume we have printed out an Ethereum address, which is EIP-55 encoded:</p>
</div>
<div id="correct_address" class="listingblock data-line-597">
<div class="content">
<pre>0x001d3F1ef827552Ae1114027BD3ECF1f086bA0F9</pre>
</div>
</div>
<div class="paragraph data-line-601">
<p>Now let&#8217;s make a basic mistake in reading that address. The character before the last one is a capital F. For this example let&#8217;s assume we misread that as a capital E, and we type the following (incorrect) address into our wallet:</p>
</div>
<div id="incorrect_address" class="listingblock data-line-604">
<div class="content">
<pre>0x001d3F1ef827552Ae1114027BD3ECF1f086bA0E9</pre>
</div>
</div>
<div class="paragraph data-line-608">
<p>Fortunately, our wallet is EIP-55 compliant! It notices the mixed capitalization and attempts to validate the address. It converts it to lowercase, and calculates the checksum hash:</p>
</div>
<div id="hash_demo" class="listingblock data-line-611">
<div class="content">
<pre>Keccak256("001d3f1ef827552ae1114027bd3ecf1f086ba0e9") =
5429b5d9460122fb4b11af9cb88b7bb76d8928862e0a57d46dd18dd8e08a6927</pre>
</div>
</div>
<div class="paragraph data-line-616">
<p>As you can see, even though the address has only changed by one character (in fact, only one bit, as e and f are one bit apart), the hash of the address has changed radically. That&#8217;s the property of hash functions that makes them so useful for checksums!</p>
</div>
<div class="paragraph data-line-618">
<p>Now, let&#8217;s line up the two and check the capitalization:</p>
</div>
<div id="incorrect_capitalization" class="listingblock data-line-621">
<div class="content">
<pre>001d3F1ef827552Ae1114027BD3ECF1f086bA0E9
5429b5d9460122fb4b11af9cb88b7bb76d892886...</pre>
</div>
</div>
<div class="paragraph data-line-626">
<p>It&#8217;s all wrong! Several of the alphabetic characters are incorrectly capitalized. Remember that the capitalization is the encoding of the <em>correct</em> checksum.</p>
</div>
<div class="paragraph data-line-628">
<p>The capitalization of the address we input doesn&#8217;t match the checksum just calculated, meaning something has changed in the address, and an error has been <span class="keep-together">introduced</span>.</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-632">
<h3 id="keys-addresses-conclusions">Conclusions</h3>
<div class="paragraph data-line-11">
<p>In this chapter we provided a brief survey of public key cryptography and focused on the use of public and private keys in Ethereum and the use of cryptographic tools, such as hash functions, in the creation and verification of Ethereum addresses. We also looked at digital signatures and how they can demonstrate ownership of a private key without revealing that private key. In <a href="#wallets_chapter">Portefeuilles</a>, we will put these ideas together and look at how wallets can be used to manage collections of keys.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="wallets_chapter">Portefeuilles</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>The word "wallet" is used to describe a few different things in Ethereum.</p>
</div>
<div class="paragraph data-line-6">
<p>At a high level, a wallet is a software application that serves as the primary user interface to Ethereum. The wallet controls access to a user&#8217;s money, managing keys and addresses, tracking the balance, and creating and signing transactions. In addition, some Ethereum wallets can also interact with contracts, such as ERC20 tokens.</p>
</div>
<div class="paragraph data-line-8">
<p>More narrowly, from a programmer&#8217;s perspective, the word <em>wallet</em> refers to the system used to store and manage a user&#8217;s keys. Every wallet has a key-management component. For some wallets, that&#8217;s all there is. Other wallets are part of a much broader category, that of <em>browsers</em>, which are interfaces to Ethereum-based decentralized applications, or <em>DApps</em>, which we will examine in more detail in <a href="#decentralized_applications_chap">Applications décentralisées (DApps)</a>. There are no clear lines of distinction between the various categories that are conflated under the term wallet.</p>
</div>
<div class="paragraph data-line-10">
<p>In this chapter we will look at wallets as containers for private keys, and as systems for managing these keys.</p>
</div>
<div class="sect2 data-line-13">
<h3 id="wallet_tech_overview">Wallet Technology Overview</h3>
<div class="paragraph data-line-15">
<p>In this section we summarize the various technologies used to construct user-friendly, secure, and flexible Ethereum wallets.</p>
</div>
<div class="paragraph data-line-17">
<p>One key consideration in designing wallets is balancing convenience and privacy. The most convenient Ethereum wallet is one with a single private key and address that you reuse for everything. Unfortunately, such a solution is a privacy nightmare, as anyone can easily track and correlate all your transactions. Using a new key for every transaction is best for privacy, but becomes very difficult to manage. The correct balance is difficult to achieve, but that&#8217;s why good wallet design is paramount.</p>
</div>
<div class="paragraph data-line-19">
<p>A common misconception about Ethereum is that Ethereum wallets contain ether or tokens. In fact, very strictly speaking, the wallet holds only keys. The ether or other tokens are recorded on the Ethereum blockchain. Users control the tokens on the network by signing transactions with the keys in their wallets. In a sense, an Ethereum wallet is a <em>keychain</em>. Having said that, given that the keys held by the wallet are the only things that are needed to transfer ether or tokens to others, in practice this distinction is fairly irrelevant. Where the difference does matter is in changing one&#8217;s mindset from dealing with the centralized system of conventional banking (where only you, and the bank, can see the money in your account, and you only need convince the bank that you want to move funds to make a transaction) to the decentralized system of blockchain platforms (where everyone can see the ether balance of an account, although they probably don&#8217;t know the account&#8217;s owner, and everyone needs to be convinced the owner wants to move funds for a transaction to be enacted). In practice this means that there is an independent way to check an account&#8217;s balance, without needing its wallet. Moreover, you can move your account handling from your current wallet to a different wallet, if you grow to dislike the wallet app you started out using.</p>
</div>
<div class="admonitionblock note data-line-22">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-23">
<p>Ethereum wallets contain keys, not ether or tokens. Wallets are like keychains containing pairs of private and public keys. Users sign transactions with the private keys, thereby proving they own the ether. The ether is stored on the blockchain.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-26">
<p>There are two primary types of wallets, distinguished by whether the keys they contain are related to each other or not.</p>
</div>
<div class="paragraph data-line-28">
<p>The first type is a <em>nondeterministic wallet</em>, where each key is independently generated from a different random number. The keys are not related to each other. This type of wallet is also known as a JBOK wallet, from the phrase "Just a Bunch of Keys.&#x201d;</p>
</div>
<div class="paragraph data-line-30">
<p>The second type of wallet is a <em>deterministic wallet</em>, where all the keys are derived from a single master key, known as the <em>seed</em>. All the keys in this type of wallet are related to each other and can be generated again if one has the original seed. There are a number of different <em>key derivation</em> methods used in deterministic wallets. The most commonly used derivation method uses a tree-like structure, as described in <a href="#hd_wallets">Hierarchical Deterministic Wallets (BIP-32/BIP-44)</a>.</p>
</div>
<div class="paragraph data-line-32">
<p>To make deterministic wallets slightly more secure against data-loss accidents, such as having your phone stolen or dropping it in the toilet, the seeds are often encoded as a list of words (in English or another language) for you to write down and use in the event of an accident. These are known as the wallet&#8217;s <em>mnemonic code words</em>. Of course, if someone gets hold of your mnemonic code words, then they can also recreate your wallet and thus gain access to your ether and smart contracts. As such, be very, very careful with your recovery word list! Never store it electronically, in a file, on your computer or phone. Write it down on paper and store it in a safe and secure place.</p>
</div>
<div class="paragraph data-line-34">
<p>The next few sections introduce each of these technologies at a high level.</p>
</div>
<div class="sect3 data-line-38">
<h4 id="random_wallet">Nondeterministic (Random) Wallets</h4>
<div class="paragraph data-line-40">
<p>In the first Ethereum wallet (produced for the Ethereum pre-sale), each wallet file stored a single randomly generated private key. Such wallets are being replaced with deterministic wallets because these "old-style" wallets are in many ways inferior. For example, it is considered good practice to avoid Ethereum address reuse as part of maximizing your privacy while using Ethereum&#x2014;i.e., to use a new address (which needs a new private key) every time you receive funds. You can go further and use a new address for each transaction, although this can get expensive if you deal a lot with tokens. To follow this practice, a nondeterministic wallet will need to regularly increase its list of keys, which means you will need to make regular backups. If you ever lose your data (disk failure, drink accident, phone stolen) before you&#8217;ve managed to back up your wallet, you will lose access to your funds and smart contracts. The "type 0" nondeterministic wallets are the hardest to deal with, because they create a new wallet file for every new address in a "just in time" manner.</p>
</div>
<div class="paragraph data-line-42">
<p>Nevertheless, many Ethereum clients (including geth) use a <em>keystore</em> file, which is a JSON-encoded file that contains a single (randomly generated) private key, encrypted by a passphrase for extra security. The JSON file&#8217;s contents look like this:</p>
</div>
<div id="keystore_example" class="listingblock data-line-46">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "address": "001d3f1ef827552ae1114027bd3ecf1f086ba0f9",
    "crypto": {
        "cipher": "aes-128-ctr",
        "ciphertext":
            "233a9f4d236ed0c13394b504b6da5df02587c8bf1ad8946f6f2b58f055507ece",
        "cipherparams": {
            "iv": "d10c6ec5bae81b6cb9144de81037fa15"
        },
        "kdf": "scrypt",
        "kdfparams": {
            "dklen": 32,
            "n": 262144,
            "p": 1,
            "r": 8,
            "salt":
                "99d37a47c7c9429c66976f643f386a61b78b97f3246adca89abe4245d2788407"
        },
        "mac": "594c8df1c8ee0ded8255a50caf07e8c12061fd859f4b7c76ab704b17c957e842"
    },
    "id": "4fcb2ba4-ccdb-424f-89d5-26cce304bf9c",
    "version": 3
}</code></pre>
</div>
</div>
<div class="paragraph data-line-72">
<p>The keystore format uses a <em>key derivation function</em> (KDF), also known as a password stretching algorithm, which protects against brute-force, dictionary, and rainbow table attacks. In simple terms, the private key is not encrypted by the passphrase directly. Instead, the passphrase is <em>stretched</em>, by repeatedly hashing it. The hashing function is repeated for 262,144 rounds, which can be seen in the keystore JSON as the parameter crypto.kdfparams.n. An attacker trying to brute-force the passphrase would have to apply 262,144 rounds of hashing for every attempted passphrase, which slows down the attack sufficiently to make it infeasible for passphrases of sufficient complexity and length.</p>
</div>
<div class="paragraph data-line-74">
<p>There are a number of software libraries that can read and write the keystore format, such as the JavaScript library <a href="https://github.com/ethereumjs/keythereum" data-href="https://github.com/ethereumjs/keythereum">keythereum</a>.</p>
</div>
<div class="admonitionblock tip data-line-77">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-78">
<p>The use of nondeterministic wallets is discouraged for anything other than simple tests. They are too cumbersome to back up and use for anything but the most basic of situations. Instead, use an industry-standard&#x2013;based HD wallet with a mnemonic seed for backup.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-82">
<h4 id="deterministic_wallets">Deterministic (Seeded) Wallets</h4>
<div class="paragraph data-line-84">
<p>Deterministic or "seeded" wallets are wallets that contain private keys that are all derived from a single master key, or seed. The seed is a randomly generated number that is combined with other data, such as an index number or "chain code" (see <a href="#extended_keys">Extended public and private keys</a>), to derive any number of private keys. In a deterministic wallet, the seed is sufficient to recover all the derived keys, and therefore a single backup, at creation time, is sufficient to secure all the funds and smart contracts in the wallet. The seed is also sufficient for a wallet export or import, allowing for easy migration of all the keys between different wallet implementations.</p>
</div>
<div class="paragraph data-line-86">
<p>This design makes the security of the seed of utmost importance, as only the seed is needed to gain access to the entire wallet. On the other hand, being able to focus security efforts on a single piece of data can be seen as an advantage.</p>
</div>
</div>
<div class="sect3 data-line-89">
<h4 id="hd_wallets">Hierarchical Deterministic Wallets (BIP-32/BIP-44)</h4>
<div class="paragraph data-line-91">
<p>Deterministic wallets were developed to make it easy to derive many keys from a single seed. Currently, the most advanced form of deterministic wallet is the <em>hierarchical deterministic</em> (HD) wallet defined by Bitcoin&#8217;s <a href="http://bit.ly/2B2vQWs" data-href="http://bit.ly/2B2vQWs"><em>BIP-32 standard</em></a>. HD wallets contain keys derived in a tree structure, such that a parent key can derive a sequence of child keys, each of which can derive a sequence of grandchild keys, and so on. This tree structure is illustrated in <a href="#hd_wallets_figure">HD wallet: a tree of keys generated from a single seed</a>.</p>
</div>
<div id="hd_wallets_figure" class="imageblock data-line-95">
<div class="content">
<img src="images/hd_wallet.png" alt="HD wallet">
</div>
<div class="title">Figure 27. HD wallet: a tree of keys generated from a single seed</div>
</div>
<div class="paragraph data-line-97">
<p>HD wallets offer a few key advantages over simpler deterministic wallets. First, the tree structure can be used to express additional organizational meaning, such as when a specific branch of subkeys is used to receive incoming payments and a different branch is used to receive change from outgoing payments. Branches of keys can also be used in corporate settings, allocating different branches to departments, subsidiaries, specific functions, or accounting categories.</p>
</div>
<div class="paragraph data-line-99">
<p>The second advantage of HD wallets is that users can create a sequence of public keys without having access to the corresponding private keys. This allows HD wallets to be used on an insecure server or in a watch-only or receive-only capacity, where the wallet doesn&#8217;t have the private keys that can spend the funds.</p>
</div>
</div>
<div class="sect3 data-line-102">
<h4 id="mnemonic_codes">Seeds and Mnemonic Codes (BIP-39)</h4>
<div class="paragraph data-line-104">
<p>There are many ways to encode a private key for secure backup and retrieval. The currently preferred method is using a sequence of words that, when taken together in the correct order, can uniquely recreate the private key. This is sometimes known as a <em>mnemonic</em>, and the approach has been standardized by <a href="http://bit.ly/2OEMjUz" data-href="http://bit.ly/2OEMjUz">BIP-39</a>. Today, many Ethereum wallets (as well as wallets for other cryptocurrencies) use this standard, and can import and export seeds for backup and recovery using interoperable mnemonics.</p>
</div>
<div class="paragraph data-line-106">
<p>To see why this approach has become popular, let&#8217;s have a look at an example:</p>
</div>
<div id="hex_seed_example" class="listingblock data-line-110">
<div class="title">A seed for a deterministic wallet, in hex</div>
<div class="content">
<pre>FCCF1AB3329FD5DA3DA9577511F8F137</pre>
</div>
</div>
<div id="mnemonic_seed_example" class="listingblock data-line-116">
<div class="title">A seed for a deterministic wallet, from a 12-word mnemonic</div>
<div class="content">
<pre>wolf juice proud gown wool unfair
wall cliff insect more detail hub</pre>
</div>
</div>
<div class="paragraph data-line-121">
<p>In practical terms, the chance of an error when writing down the hex sequence is unacceptably high. In contrast, the list of known words is quite easy to deal with, mainly because there is a high level of redundancy in the writing of words (especially English words). If "inzect" had been recorded by accident, it could quickly be determined, upon the need for wallet recovery, that "inzect" is not a valid English word and that "insect" should be used instead. We are talking about writing down a representation of the seed because that is good practice when managing HD wallets: the seed is needed to recover a wallet in the case of data loss (whether through accident or theft), so keeping a backup is very prudent. However, the seed must be kept extremely private, so digital backups should be carefully avoided; hence the earlier advice to back up with pen and paper.</p>
</div>
<div class="paragraph data-line-123">
<p>In summary, the use of a recovery word list to encode the seed for an HD wallet makes for the easiest way to safely export, transcribe, record on paper, read without error, and import a private key set into another wallet.</p>
</div>
</div>
</div>
<div class="sect2 data-line-127">
<h3 id="wallet_best_practices">Wallet Best Practices</h3>
<div class="paragraph data-line-129">
<p>As cryptocurrency wallet technology has matured, certain common industry standards have emerged that make wallets broadly interoperable, easy to use, secure, and flexible. These standards also allow wallets to derive keys for multiple different cryptocurrencies, all from a single mnemonic. These common standards are:</p>
</div>
<div class="ulist data-line-131">
<ul>
<li class="data-line-131">
<p>Mnemonic code words, based on BIP-39</p>
</li>
<li class="data-line-132">
<p>HD wallets, based on BIP-32</p>
</li>
<li class="data-line-133">
<p>Multipurpose HD wallet structure, based on BIP-43</p>
</li>
<li class="data-line-134">
<p>Multicurrency and multiaccount wallets, based on BIP-44</p>
</li>
</ul>
</div>
<div class="paragraph data-line-136">
<p>These standards may change or be obsoleted by future developments, but for now they form a set of interlocking technologies that have become the <em>de facto</em> wallet standard for most blockchain platforms and their cryptocurrencies.</p>
</div>
<div class="paragraph data-line-138">
<p>The standards have been adopted by a broad range of software and hardware wallets, making all these wallets interoperable. A user can export a mnemonic generated in one of these wallets and import it to another wallet, recovering all keys and addresses.</p>
</div>
<div class="paragraph data-line-140">
<p>Some examples of software wallets supporting these standards include (listed alphabetically) Jaxx, MetaMask, MyCrypto, and MyEtherWallet (MEW). Examples of hardware wallets supporting these standards include Keepkey, Ledger, and Trezor.</p>
</div>
<div class="paragraph data-line-142">
<p>The following sections examine each of these technologies in detail.</p>
</div>
<div class="admonitionblock tip data-line-145">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-146">
<p>If you are implementing an Ethereum wallet, it should be built as an HD wallet, with a seed encoded as a mnemonic code for backup, following the BIP-32, BIP-39, BIP-43, and BIP-44 standards, as described in the following sections.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 data-line-151">
<h4 id="mnemonic_code_words">Mnemonic Code Words (BIP-39)</h4>
<div class="paragraph data-line-153">
<p>Mnemonic code words are word sequences that encode a random number used as a seed to derive a deterministic wallet. The sequence of words is sufficient to recreate the seed, and from there recreate the wallet and all the derived keys. A wallet application that implements deterministic wallets with mnemonic words will show the user a sequence of 12 to 24 words when first creating a wallet. That sequence of words is the wallet backup, and can be used to recover and recreate all the keys in the same or any compatible wallet application. As we explained earlier, mnemonic word lists make it easier for users to back up wallets, because they are easy to read and correctly <span class="keep-together">transcribe</span>.</p>
</div>
<div class="admonitionblock note data-line-156">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-157">
<p>Mnemonic words are often confused with "brainwallets." They are not the same. The primary difference is that a brainwallet consists of words chosen by the user, whereas mnemonic words are created randomly by the wallet and presented to the user. This important difference makes mnemonic words much more secure, because humans are very poor sources of randomness. Perhaps more importantly, using the term "brainwallet" suggests that the words have to be memorized, which is a terrible idea, and a recipe for not having your backup when you need it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-160">
<p>Mnemonic codes are defined in BIP-39. Note that BIP-39 is one implementation of a mnemonic code standard. There is a different standard, <em>with a different set of words</em>, used by the Electrum Bitcoin wallet and predating BIP-39. BIP-39 was proposed by the company behind the Trezor hardware wallet and is incompatible with Electrum&#8217;s implementation. However, BIP-39 has now achieved broad industry support across dozens of interoperable implementations and should be considered the <em>de facto</em> industry standard. Furthermore, BIP-39 can be used to produce multicurrency wallets supporting Ethereum, whereas Electrum seeds cannot.</p>
</div>
<div class="paragraph data-line-162">
<p>BIP-39 defines the creation of a mnemonic code and seed, which we describe here in nine steps. For clarity, the process is split into two parts: steps 1 through 6 are shown in <a href="#generating_mnemonic_words">Generating mnemonic words</a> and steps 7 through 9 are shown in <a href="#mnemonic_to_seed">From mnemonic to seed</a>.</p>
</div>
<div class="sect4 data-line-165">
<h5 id="generating_mnemonic_words">Generating mnemonic words</h5>
<div class="paragraph data-line-167">
<p>Mnemonic words are generated automatically by the wallet using the standardized process defined in BIP-39. The wallet starts from a source of entropy, adds a checksum, and then maps the entropy to a word list:</p>
</div>
<div class="olist arabic data-line-169">
<ol class="arabic">
<li class="data-line-169">
<p>Create a cryptographically random sequence S of 128 to 256 bits.</p>
</li>
<li class="data-line-170">
<p>Create a checksum of S by taking the first length-of-S ÷ 32 bits of the SHA-256 hash of S.</p>
</li>
<li class="data-line-171">
<p>Add the checksum to the end of the random sequence S.</p>
</li>
<li class="data-line-172">
<p>Divide the sequence-and-checksum concatenation into sections of 11 bits.</p>
</li>
<li class="data-line-173">
<p>Map each 11-bit value to a word from the predefined dictionary of 2,048 words.</p>
</li>
<li class="data-line-174">
<p>Create the mnemonic code from the sequence of words, maintaining the order.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-176">
<p><a href="#generating_entropy_and_encoding">Generating entropy and encoding as mnemonic words</a> shows how entropy is used to generate mnemonic words.</p>
</div>
<div class="paragraph data-line-178">
<p><a href="#table_bip39_entropy">Mnemonic codes: entropy and word length</a> shows the relationship between the size of the entropy data and the length of mnemonic codes in words.</p>
</div>
<table id="table_bip39_entropy" class="tableblock frame-all grid-all stretch data-line-183">
<caption class="title">Table 3. Mnemonic codes: entropy and word length</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Entropy (bits)</th>
<th class="tableblock halign-left valign-top">Checksum (bits)</th>
<th class="tableblock halign-left valign-top">Entropy <strong>+</strong> checksum (bits)</th>
<th class="tableblock halign-left valign-top">Mnemonic length (words)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">132</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">160</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">165</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">198</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">224</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">231</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">21</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">256</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">264</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
</tr>
</tbody>
</table>
<div id="generating_entropy_and_encoding" class="imageblock smallerseventy data-line-195">
<div class="content">
<img src="images/bip39-part1.png" alt="Generating entropy and encoding as mnemonic words">
</div>
<div class="title">Figure 28. Generating entropy and encoding as mnemonic words</div>
</div>
</div>
<div class="sect4 data-line-198">
<h5 id="mnemonic_to_seed">From mnemonic to seed</h5>
<div class="paragraph data-line-200">
<p>The mnemonic words represent entropy with a length of 128 to 256 bits. The entropy is then used to derive a longer (512-bit) seed through the use of the key-stretching function PBKDF2. The seed produced is used to build a deterministic wallet and derive its keys.</p>
</div>
<div class="paragraph data-line-202">
<p>The key-stretching function takes two parameters: the mnemonic and a <em>salt</em>. The purpose of a salt in a key-stretching function is to make it difficult to build a lookup table enabling a brute-force attack. In the BIP-39 standard, the salt has another purpose: it allows the introduction of a passphrase that serves as an additional security factor protecting the seed, as we will describe in more detail in <a href="#mnemonic_passphrase">Optional passphrase in BIP-39</a>.</p>
</div>
<div class="paragraph data-line-204">
<p>The process described in steps 7 through 9 continues from the process described in the previous section:</p>
</div>
<div class="olist arabic data-line-207">
<ol class="arabic" start="7">
<li class="data-line-207">
<p>The first parameter to the PBKDF2 key-stretching function is the <em>mnemonic</em> produced in step 6.</p>
</li>
<li class="data-line-208">
<p>The second parameter to the PBKDF2 key-stretching function is a <em>salt</em>. The salt is composed of the string constant "mnemonic" concatenated with an optional user-supplied passphrase.</p>
</li>
<li class="data-line-209">
<p>PBKDF2 stretches the mnemonic and salt parameters using 2,048 rounds of hashing with the HMAC-SHA512 algorithm, producing a 512-bit value as its final output. That 512-bit value is the seed.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-211">
<p><a href="#mnemonic_to_seed_figure">From mnemonic to seed</a> shows how a mnemonic is used to generate a seed.</p>
</div>
<div id="mnemonic_to_seed_figure" class="imageblock data-line-215">
<div class="content">
<img src="images/bip39-part2.png" alt="From mnemonic to seed">
</div>
<div class="title">Figure 29. From mnemonic to seed</div>
</div>
<div class="admonitionblock note data-line-218">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-219">
<p>The key-stretching function, with its 2,048 rounds of hashing, is a somewhat effective protection against brute-force attacks against the mnemonic or the passphrase. It makes it costly (in computation) to try more than a few thousand passphrase and mnemonic combinations, while the number of possible derived seeds is vast (2<sup>512</sup>, or about 10<sup>154</sup>)&#x2014;far bigger than the number of atoms in the visible universe (about 10<sup>80</sup>).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-222">
<p>Tables <a data-type="xref" data-xrefstyle="select:labelnumber" href="#mnemonic_128_no_pass">#mnemonic_128_no_pass</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="#mnemonic_128_w_pass">#mnemonic_128_w_pass</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#mnemonic_256_no_pass">#mnemonic_256_no_pass</a> show some examples of mnemonic codes and the seeds they produce.</p>
</div>
<table id="mnemonic_128_no_pass" class="tableblock frame-all grid-all stretch data-line-227">
<caption class="title">Table 4. 128-bit entropy mnemonic code, no passphrase, resulting seed</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Entropy input (128 bits)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">0c1e24e5917779d297e14d45f14e1a1a</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Mnemonic (12 words)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">army van defense carry jealous true garbage claim echo media make crunch</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Passphrase</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Seed  (512 bits)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">5b56c417303faa3fcba7e57400e120a0ca83ec5a4fc9ffba757fbe63fbd77a89a1a3be4c67196f57c39
a88b76373733891bfaba16ed27a813ceed498804c0570</p></td>
</tr>
</tbody>
</table>
<table id="mnemonic_128_w_pass" class="tableblock frame-all grid-all stretch data-line-238">
<caption class="title">Table 5. 128-bit entropy mnemonic code, with passphrase, resulting seed</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Entropy input (128 bits)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">0c1e24e5917779d297e14d45f14e1a1a</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Mnemonic (12 words)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">army van defense carry jealous true garbage claim echo media make crunch</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Passphrase</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">SuperDuperSecret</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Seed  (512 bits)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">3b5df16df2157104cfdd22830162a5e170c0161653e3afe6c88defeefb0818c793dbb28ab3ab091897d0
715861dc8a18358f80b79d49acf64142ae57037d1d54</p></td>
</tr>
</tbody>
</table>
<table id="mnemonic_256_no_pass" class="tableblock frame-all grid-all stretch pagebreak-before data-line-250">
<caption class="title">Table 6. 256-bit entropy mnemonic code, no passphrase, resulting seed</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Entropy input (256 bits)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">2041546864449caff939d32d574753fe684d3c947c3346713dd8423e74abcf8c</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Mnemonic (24 words)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">cake apple borrow silk endorse fitness top denial coil riot stay wolf
luggage oxygen faint major edit measure invite love trap field dilemma oblige</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Passphrase</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">(none)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock"><strong>Seed (512 bits)</strong></p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">3269bce2674acbd188d4f120072b13b088a0ecf87c6e4cae41657a0bb78f5315b33b3a04356e53d062e5
5f1e0deaa082df8d487381379df848a6ad7e98798404</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4 data-line-260">
<h5 id="mnemonic_passphrase">Optional passphrase in BIP-39</h5>
<div class="paragraph data-line-262">
<p>The BIP-39 standard allows the use of an optional passphrase in the derivation of the seed. If no passphrase is used, the mnemonic is stretched with a salt consisting of the constant string "mnemonic", producing a specific 512-bit seed from any given mnemonic. If a passphrase is used, the stretching function produces a <em>different</em> seed from that same mnemonic. In fact, given a single mnemonic, every possible passphrase leads to a different seed. Essentially, there is no "wrong" passphrase. All passphrases are valid and they all lead to different seeds, forming a vast set of possible uninitialized wallets. The set of possible wallets is so large (2<sup>512</sup>) that there is no practical possibility of brute-forcing or accidentally guessing one that is in use, as long as the passphrase has sufficient complexity and length.</p>
</div>
<div class="admonitionblock tip data-line-265">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-266">
<p>There are no "wrong" passphrases in BIP-39. Every passphrase leads to some wallet, which unless previously used will be empty.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-269">
<p>The optional passphrase creates two important features:</p>
</div>
<div class="ulist data-line-271">
<ul>
<li class="data-line-271">
<p>A second factor (something memorized) that makes a mnemonic useless on its own, protecting mnemonic backups from compromise by a thief.</p>
</li>
<li class="data-line-273">
<p>A form of plausible deniability or "duress wallet," where a chosen passphrase leads to a wallet with a small amount of funds, used to distract an attacker from the "real" wallet that contains the majority of funds.</p>
</li>
</ul>
</div>
<div class="paragraph pagebreak-before data-line-276">
<p>However, it is important to note that the use of a passphrase also introduces the risk of loss:</p>
</div>
<div class="ulist data-line-278">
<ul>
<li class="data-line-278">
<p>If the wallet owner is incapacitated or dead and no one else knows the passphrase, the seed is useless and all the funds stored in the wallet are lost forever.</p>
</li>
<li class="data-line-280">
<p>Conversely, if the owner backs up the passphrase in the same place as the seed, it defeats the purpose of a second factor.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-282">
<p>While passphrases are very useful, they should only be used in combination with a carefully planned process for backup and recovery, considering the possibility of heirs surviving the owner being able to recover the cryptocurrency.</p>
</div>
</div>
<div class="sect4 data-line-285">
<h5 id="working_mnemonic_codes">Working with mnemonic codes</h5>
<div class="paragraph data-line-287">
<p>BIP-39 is implemented as a library in many different programming languages. For example:</p>
</div>
<div class="dlist data-line-289">
<dl>
<dt class="hdlist1"><a href="https://github.com/trezor/python-mnemonic" data-href="https://github.com/trezor/python-mnemonic">python-mnemonic</a></dt>
<dd>
<p>The reference implementation of the standard by the SatoshiLabs team that proposed BIP-39, in Python</p>
</dd>
<dt class="hdlist1"><a href="https://github.com/ConsenSys/eth-lightwallet" data-href="https://github.com/ConsenSys/eth-lightwallet">ConsenSys/eth-lightwallet</a></dt>
<dd>
<p>Lightweight JS Ethereum wallet for nodes and browser (with BIP-39)</p>
</dd>
<dt class="hdlist1"><a href="https://www.npmjs.com/package/bip39" data-href="https://www.npmjs.com/package/bip39">npm/bip39</a></dt>
<dd>
<p>JavaScript implementation of Bitcoin BIP-39: Mnemonic code for generating deterministic keys</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-295">
<p>There is also a BIP-39 generator implemented in a standalone web page (<a href="#a_bip39_generator_as_a_standalone_web_page">A BIP-39 generator as a standalone web page</a>), which is extremely useful for testing and experimentation. The <a href="https://iancoleman.io/bip39/" data-href="https://iancoleman.io/bip39/">Mnemonic Code Converter</a> generates mnemonics, seeds, and extended private keys. It can be used offline in a browser, or accessed online.</p>
</div>
<div id="a_bip39_generator_as_a_standalone_web_page" class="imageblock data-line-299">
<div class="content">
<img src="images/bip39_web.png" alt="BIP-39 generator web-page">
</div>
<div class="title">Figure 30. A BIP-39 generator as a standalone web page</div>
</div>
</div>
</div>
<div class="sect3 data-line-302">
<h4 id="create_hd_wallet">Creating an HD Wallet from the Seed</h4>
<div class="paragraph data-line-304">
<p>HD wallets are created from a single <em>root seed</em>, which is a 128-, 256-, or 512-bit random number. Most commonly, this seed is generated from a mnemonic as detailed in the previous section.</p>
</div>
<div class="paragraph data-line-306">
<p>Every key in the HD wallet is deterministically derived from this root seed, which makes it possible to recreate the entire HD wallet from that seed in any compatible HD wallet. This makes it easy to export, back up, restore, and import HD wallets containing thousands or even millions of keys by transferring just the mnemonic from which the root seed is derived.</p>
</div>
</div>
<div class="sect3 data-line-309">
<h4 id="bip32_bip43_44">HD Wallets (BIP-32) and Paths (BIP-43/44)</h4>
<div class="paragraph data-line-311">
<p>Most HD wallets follow the BIP-32 standard, which has become a <em>de facto</em> industry standard for deterministic key generation.</p>
</div>
<div class="paragraph data-line-313">
<p>We won&#8217;t be discussing all the details of BIP-32 here, only the components necessary to understand how it is used in wallets. The main important aspect is the tree-like hierarchical relationships that it is possible for the derived keys to have, as you can see in <a href="#hd_wallets_figure">HD wallet: a tree of keys generated from a single seed</a>. It&#8217;s also important to understand the ideas of <em>extended keys</em> and <em>hardened keys</em>, which are explained in the following sections.</p>
</div>
<div class="paragraph data-line-315">
<p>There are dozens of interoperable implementations of BIP-32 offered in many software libraries. These are mostly designed for Bitcoin wallets, which implement addresses in a different way, but share the same key-derivation implementation as Ethereum&#8217;s BIP-32-compatible wallets. Use one <a href="https://github.com/ConsenSys/eth-lightwallet" data-href="https://github.com/ConsenSys/eth-lightwallet">designed for Ethereum</a>, or adapt one from Bitcoin by adding an Ethereum address encoding library.</p>
</div>
<div class="paragraph data-line-317">
<p>There is also a BIP-32 generator implemented as a <a href="http://bip32.org/" data-href="http://bip32.org/">standalone web page</a> that is very useful for testing and experimentation with BIP-32.</p>
</div>
<div class="admonitionblock warning data-line-320">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-321">
<p>The standalone BIP-32 generator is not an HTTPS site. That&#8217;s to remind you that the use of this tool is not secure. It is only for testing. You should not use the keys produced by this site with real funds.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-325">
<h5 id="extended_keys">Extended public and private keys</h5>
<div class="paragraph data-line-327">
<p>In BIP-32 terminology, keys can be "extended.&#x201d; With the right mathematical operations, these extended "parent" keys can be used to derive "child" keys, thus producing the hierarchy of keys and addresses described earlier. A parent key doesn&#8217;t have to be at the top of the tree. It can be picked out from anywhere in the tree hierarchy. Extending a key involves taking the key itself and appending a special <em>chain code</em> to it. A chain code is a 256-bit binary string that is mixed with each key to produce child keys.</p>
</div>
<div class="paragraph data-line-329">
<p>If the key is a private key, it becomes an <em>extended private key</em> distinguished by the <span class="keep-together">prefix</span> xprv:</p>
</div>
<div id="xprv_example" class="listingblock data-line-332">
<div class="content">
<pre>xprv9s21ZrQH143K2JF8RafpqtKiTbsbaxEeUaMnNHsm5o6wCW3z8ySyH4UxFVSfZ8n7ESu7fgir8i...</pre>
</div>
</div>
<div class="paragraph data-line-336">
<p>An <em>extended public key</em> is distinguished by the prefix xpub:</p>
</div>
<div id="xpub_example" class="listingblock data-line-339">
<div class="content">
<pre>xpub661MyMwAqRbcEnKbXcCqD2GT1di5zQxVqoHPAgHNe8dv5JP8gWmDproS6kFHJnLZd23tWevhdn...</pre>
</div>
</div>
<div class="paragraph data-line-343">
<p>A very useful characteristic of HD wallets is the ability to derive child public keys from parent public keys, <em>without</em> having the private keys. This gives us two ways to derive a child public key: either directly from the child private key, or from the parent public key.</p>
</div>
<div class="paragraph data-line-345">
<p>An extended public key can be used, therefore, to derive all of the public keys (and only the public keys) in that branch of the HD wallet structure.</p>
</div>
<div class="paragraph data-line-347">
<p>This shortcut can be used to create very secure public key&#x2013;only deployments, where a server or application has a copy of an extended public key, but no private keys whatsoever. That kind of deployment can produce an infinite number of public keys and Ethereum addresses, but cannot spend any of the money sent to those addresses. Meanwhile, on another, more secure server, the extended private key can derive all the corresponding private keys to sign transactions and spend the money.</p>
</div>
<div class="paragraph data-line-349">
<p>One common application of this method is to install an extended public key on a web server that serves an ecommerce application. The web server can use the public key derivation function to create a new Ethereum address for every transaction (e.g., for a customer shopping cart), and will not have any private keys that would be vulnerable to theft. Without HD wallets, the only way to do this is to generate thousands of Ethereum addresses on a separate secure server and then preload them on the ecommerce server. That approach is cumbersome and requires constant maintenance to ensure that the server doesn&#8217;t run out of keys, hence the preference to use extended public keys from HD wallets.</p>
</div>
<div class="paragraph data-line-351">
<p>Another common application of this solution is for cold-storage or hardware wallets. In that scenario, the extended private key can be stored in a hardware wallet, while the extended public key can be kept online. The user can create "receive" addresses at will, while the private keys are safely stored offline. To spend the funds, the user can use the extended private key in an offline signing Ethereum client, or sign transactions on the hardware wallet device.</p>
</div>
</div>
<div class="sect4 data-line-354">
<h5 id="hardened_child_key">Hardened child key derivation</h5>
<div class="paragraph data-line-356">
<p>The ability to derive a branch of public keys from an extended public key, or <em>xpub</em>, is very useful, but it comes with a potential risk. Access to an xpub does not give access to child private keys. However, because the xpub contains the chain code (used to derive child public keys from the parent public key), if a child private key is known, or somehow leaked, it can be used with the chain code to derive all the other child private keys. A single leaked child private key, together with a parent chain code, reveals all the private keys of all the children. Worse, the child private key together with a parent chain code can be used to deduce the parent private key.</p>
</div>
<div class="paragraph data-line-358">
<p>To counter this risk, HD wallets use an alternative derivation function called <em>hardened derivation</em>, which "breaks" the relationship between parent public key and child chain code. The hardened derivation function uses the parent private key to derive the child chain code, instead of the parent public key. This creates a "firewall" in the parent/child sequence, with a chain code that cannot be used to compromise a parent or sibling private key.</p>
</div>
<div class="paragraph data-line-360">
<p>In simple terms, if you want to use the convenience of an xpub to derive branches of public keys without exposing yourself to the risk of a leaked chain code, you should derive it from a hardened parent, rather than a normal parent. Best practice is to have the level-1 children of the master keys always derived by hardened derivation, to prevent compromise of the master keys.</p>
</div>
</div>
<div class="sect4 data-line-363">
<h5 id="index_number">Index numbers for normal and hardened derivation</h5>
<div class="paragraph data-line-365">
<p>It is clearly desirable to be able to derive more than one child key from a given parent key. To manage this, an index number is used. Each index number, when combined with a parent key using the special child derivation function, gives a different child key. The index number used in the BIP-32 parent-to-child derivation function is a 32-bit integer. To easily distinguish between keys derived through the normal (unhardened) derivation function versus keys derived through hardened derivation, this index number is split into two ranges. Index numbers between 0 and 2<sup>31</sup>&#x2013;1 (0x0 to 0x7FFFFFFF) are used <em>only</em> for normal derivation. Index numbers between 2<sup>31</sup> and 2<sup>32</sup>&#x2013;1 (0x80000000 to 0xFFFFFFFF) are used <em>only</em> for hardened derivation. Therefore, if the index number is less than 2<sup>31</sup>, the child is normal, whereas if the index number is equal to or above 2<sup>31</sup>, the child is hardened.</p>
</div>
<div class="paragraph data-line-367">
<p>To make the index numbers easier to read and display, the index numbers for hardened children are displayed starting from zero, but with a prime symbol. The first normal child key is therefore displayed as 0, whereas the first hardened child (index 0x80000000) is displayed as 0&amp;#x27;. In sequence, then, the second hardened key would have index of 0x80000001 and would be displayed as 1&amp;#x27;, and so on. When you see an HD wallet index i&amp;#x27;, that means 2<sup>31</sup> + i.</p>
</div>
</div>
<div class="sect4 data-line-370">
<h5 id="hd_wallet_path">HD wallet key identifier (path)</h5>
<div class="paragraph data-line-372">
<p>Keys in an HD wallet are identified using a "path" naming convention, with each level of the tree separated by a slash (/) character (see <a href="#hd_path_table">HD wallet path examples</a>). Private keys derived from the master private key start with m. Public keys derived from the master public key start with M. Therefore, the first child private key of the master private key is m/0. The first child public key is M/0. The second grandchild of the first child is m/0/1, and so on.</p>
</div>
<div class="paragraph data-line-374">
<p>The "ancestry" of a key is read from right to left, until you reach the master key from which it was derived. For example, identifier m/x/y/z describes the key that is the z-th child of key m/x/y, which is the y-th child of key m/x, which is the x-th child of m.</p>
</div>
<table id="hd_path_table" class="tableblock frame-all grid-all stretch data-line-379">
<caption class="title">Table 7. HD wallet path examples</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HD path</th>
<th class="tableblock halign-left valign-top">Key described</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m/0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first (0) child private key of the master private key (m)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m/0/0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first grandchild private key of the first child (m/0)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m/0'/0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first normal grandchild of the first <em>hardened</em> child (m/0')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m/1/0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first grandchild private key of the second child (m/1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">M/23/17/0/0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The first great-great-grandchild public key of the first great-grandchild of the 18th grandchild of the <span class="keep-together">24th child</span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4 data-line-389">
<h5 id="navigating_hd_wallet_tree">Navigating the HD wallet tree structure</h5>
<div class="paragraph data-line-391">
<p>The HD wallet tree structure is tremendously flexible. The flip side of this is that it also allows for unbounded complexity: each parent extended key can have 4 billion children: 2 billion normal children and 2 billion hardened children. Each of those children can have another 4 billion children, and so on. The tree can be as deep as you want, with a potentially infinite number of generations. With all that potential, it can become quite difficult to navigate these very large trees.</p>
</div>
<div class="paragraph data-line-393">
<p>Two BIPs offer a way to manage this potential complexity by creating standards for the structure of HD wallet trees. BIP-43 proposes the use of the first hardened child index as a special identifier that signifies the "purpose" of the tree structure. Based on BIP-43, an HD wallet should use only one level-1 branch of the tree, with the index number defining the purpose of the wallet by identifying the structure and namespace of the rest of the tree. More specifically, an HD wallet using only branch m/i&amp;#x27;/... is intended to signify a specific purpose and that purpose is identified by index number i.</p>
</div>
<div class="paragraph data-line-395">
<p>Extending that specification, BIP-44 proposes a multicurrency multiaccount structure signified by setting the "purpose" number to 44'. All HD wallets following the BIP-44 structure are identified by the fact that they only use one branch of the tree: m/44'/*.</p>
</div>
<div class="paragraph data-line-397">
<p>BIP-44 specifies the structure as consisting of five predefined tree levels:</p>
</div>
<div id="bip44_tree" class="listingblock data-line-400">
<div class="content">
<pre>m / purpose' / coin_type' / account' / change / address_index</pre>
</div>
</div>
<div class="paragraph data-line-404">
<p>The first level, purpose&amp;#x27;, is always set to 44&amp;#x27;. The second level, coin_type&amp;#x27;, specifies the type of cryptocurrency coin, allowing for multicurrency HD wallets where each currency has its own subtree under the second level. There are several currencies defined in a standards document called <a href="https://github.com/satoshilabs/slips/blob/master/slip-0044.md" data-href="https://github.com/satoshilabs/slips/blob/master/slip-0044.md">SLIP0044</a>; for example, Ethereum is m/44&amp;#x27;/60&amp;#x27;, Ethereum Classic is m/44&amp;#x27;/61&amp;#x27;, Bitcoin is m/44&amp;#x27;/0&amp;#x27;, and Testnet for all currencies is m/44&amp;#x27;/1&amp;#x27;.</p>
</div>
<div class="paragraph data-line-406">
<p>The third level of the tree is account&amp;#x27;, which allows users to subdivide their wallets into separate logical subaccounts for accounting or organizational purposes. For example, an HD wallet might contain two Ethereum "accounts": m/44&amp;#x27;/60&amp;#x27;/0&amp;#x27; and m/44&amp;#x27;/60&amp;#x27;/1&amp;#x27;. Each account is the root of its own subtree.</p>
</div>
<div class="paragraph data-line-408">
<p>Because BIP-44 was created originally for Bitcoin, it contains a "quirk" that isn&#8217;t relevant in the Ethereum world. On the fourth level of the path, change, an HD wallet has two subtrees: one for creating receiving addresses and one for creating change addresses. Only the "receive" path is used in Ethereum, as there is no necessity for a change address like there is in Bitcoin. Note that whereas the previous levels used hardened derivation, this level uses normal derivation. This is to allow the account level of the tree to export extended public keys for use in a nonsecured environment. Usable addresses are derived by the HD wallet as children of the fourth level, making the fifth level of the tree the address_index. For example, the third receiving address for Ethereum payments in the primary account would be M/44&amp;#x27;/60&amp;#x27;/0&amp;#x27;/0/2. <a href="#bip44_path_examples">BIP-44 HD wallet structure examples</a> shows a few more examples.</p>
</div>
<table id="bip44_path_examples" class="tableblock frame-all grid-all stretch data-line-413">
<caption class="title">Table 8. BIP-44 HD wallet structure examples</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">HD path</th>
<th class="tableblock halign-left valign-top">Key described</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">M/44&amp;#x27;/60&amp;#x27;/0&amp;#x27;/0/2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The third receiving public key for the primary Ethereum account</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">M/44&amp;#x27;/0&amp;#x27;/3&amp;#x27;/1/14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The 15<sup>th</sup> change-address public key for the 4<sup>th</sup> Bitcoin account</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">m/44&amp;#x27;/2&amp;#x27;/0&amp;#x27;/0/1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The second private key in the Litecoin main account, for signing transactions</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2 data-line-420">
<h3 id="_conclusions_2">Conclusions</h3>
<div class="paragraph data-line-13">
<p>Wallets are the foundation of any user-facing blockchain application. They allow users to manage collections of keys and addresses. Wallets also allow users to demonstrate their ownership of ether, and authorize transactions, by applying digital signatures, as we will see in <a href="#tx_chapter">Transactions</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="tx_chapter">Transactions</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Transactions are signed messages originated by an externally owned account, transmitted by the Ethereum network, and recorded on the Ethereum blockchain. This basic definition conceals a lot of surprising and fascinating details. Another way to look at transactions is that they are the only things that can trigger a change of state, or cause a contract to execute in the EVM. Ethereum is a global singleton state machine, and transactions are what make that state machine "tick," changing its state. Contracts don&#8217;t run on their own. Ethereum doesn&#8217;t run  autonomously. Everything starts with a transaction.</p>
</div>
<div class="paragraph data-line-6">
<p>In this chapter, we will dissect transactions, show how they work, and examine the details. Note that much of this chapter is addressed to those who are interested in managing their own transactions at a low level, perhaps because they are writing a wallet app; you don&#8217;t have to worry about this if you are happy using existing wallet applications, although you may find the details interesting!</p>
</div>
<div class="sect2 data-line-9">
<h3 id="tx_struct">The Structure of a Transaction</h3>
<div class="paragraph data-line-11">
<p>First let&#8217;s take a look at the basic structure of a transaction, as it is serialized and transmitted on the Ethereum network. Each client and application that receives a serialized transaction will store it in-memory using its own internal data structure, perhaps embellished with metadata that doesn&#8217;t exist in the network serialized transaction itself. The network-serialization is the only standard form of a transaction.</p>
</div>
<div class="paragraph data-line-13">
<p>A transaction is a serialized binary message that contains the following data:</p>
</div>
<div class="dlist data-line-15">
<dl>
<dt class="hdlist1">Nonce</dt>
<dd>
<p>A sequence number, issued by the originating EOA, used to prevent message replay</p>
</dd>
<dt class="hdlist1">Gas price</dt>
<dd>
<p>The price of gas (in wei) the originator is willing to pay</p>
</dd>
<dt class="hdlist1">Gas limit</dt>
<dd>
<p>The maximum amount of gas the originator is willing to buy for this transaction</p>
</dd>
<dt class="hdlist1">Recipient</dt>
<dd>
<p>The destination Ethereum address</p>
</dd>
<dt class="hdlist1">Value</dt>
<dd>
<p>The amount of ether to send to the destination</p>
</dd>
<dt class="hdlist1">Data</dt>
<dd>
<p>The variable-length binary data payload</p>
</dd>
<dt class="hdlist1">v,r,s</dt>
<dd>
<p>The three components of an ECDSA digital signature of the originating EOA</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-29">
<p>The transaction message&#8217;s structure is serialized using the Recursive Length Prefix (RLP) encoding scheme, which was created specifically for simple, byte-perfect data serialization in Ethereum. All numbers in Ethereum are encoded as big-endian integers, of lengths that are multiples of 8 bits.</p>
</div>
<div class="paragraph data-line-31">
<p>Note that the field labels (to, gas limit, etc.) are shown here for clarity, but are not part of the transaction serialized data, which contains the field values RLP-encoded. In general, RLP does not contain any field delimiters or labels. RLP&#8217;s length prefix is used to identify the length of each field. Anything beyond the defined length belongs to the next field in the structure.</p>
</div>
<div class="paragraph data-line-33">
<p>While this is the actual transaction structure transmitted, most internal representations and user interface visualizations embellish this with additional information, derived from the transaction or from the blockchain.</p>
</div>
<div class="paragraph data-line-35">
<p>For example, you may notice there is no &#x201c;from&#x201d; data in the address identifying the originator EOA. That is because the EOA&#8217;s public key can be derived from the v,r,s components of the ECDSA signature. The address can, in turn, be derived from the public key. When you see a transaction showing a "from" field, that was added by the software used to visualize the transaction. Other metadata frequently added to the transaction by client software includes the block number (once it is mined and included in the blockchain) and a transaction ID (calculated hash). Again, this data is derived from the transaction, and does not form part of the transaction message itself.</p>
</div>
</div>
<div class="sect2 data-line-38">
<h3 id="tx_nonce">The Transaction Nonce</h3>
<div class="paragraph data-line-40">
<p>The nonce is one of the most important and least understood components of a transaction. The definition in the Yellow Paper (see <a href="#references">Lectures complémentaires</a>) reads:</p>
</div>
<div class="quoteblock data-line-42">
<blockquote>
<div class="paragraph data-line-43">
<p>nonce: A scalar value equal to the number of transactions sent from this address or, in the case of accounts with associated code, the number of contract-creations made by this account.</p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-46">
<p>Strictly speaking, the nonce is an attribute of the originating address; that is, it only has meaning in the context of the sending address. However, the nonce is not stored explicitly as part of an account&#8217;s state on the blockchain. Instead, it is calculated dynamically, by counting the number of confirmed transactions that have originated from an address.</p>
</div>
<div class="paragraph data-line-48">
<p>There are two scenarios where the existence of a transaction-counting nonce is important: the usability feature of transactions being included in the order of creation, and the vital feature of transaction duplication protection. Let&#8217;s look at an example scenario for each of these:</p>
</div>
<div class="olist arabic data-line-50">
<ol class="arabic">
<li class="data-line-50">
<p>Imagine you wish to make two transactions. You have an important payment to make of 6 ether, and also another payment of 8 ether. You sign and broadcast the 6-ether transaction first, because it is the more important one, and then you sign and broadcast the second, 8-ether transaction. Sadly, you have overlooked the fact that your account contains only 10 ether, so the network can&#8217;t accept both transactions: one of them will fail. Because you sent the more important 6-ether one first, you understandably expect that one to go through and the 8-ether one to be rejected. However, in a decentralized system like Ethereum, nodes may receive the transactions in either order; there is no guarantee that a particular node will have one transaction propagated to it before the other. As such, it will almost certainly be the case that some nodes receive the 6-ether transaction first and others receive the 8-ether transaction first. Without the nonce, it would be random as to which one gets accepted and which rejected. However, with the nonce included, the first transaction you sent will have a nonce of, let&#8217;s say, 3, while the 8-ether transaction has the next nonce value (i.e., 4). So, that transaction will be ignored until the transactions with nonces from 0 to 3 have been processed, even if it is received first. Phew!</p>
</li>
<li class="data-line-53">
<p>Now imagine you have an account with 100 ether. Fantastic! You find someone online who will accept payment in ether for a mcguffin-widget that you really want to buy. You send them 2 ether and they send you the mcguffin-widget. Lovely. To make that 2-ether payment, you signed a transaction sending 2 ether from your account to their account, and then broadcast it to the Ethereum network to be verified and included on the blockchain. Now, without a nonce value in the transaction, a second transaction sending 2 ether to the same address a second time will look exactly the same as the first transaction. This means that anyone who sees your transaction on the Ethereum network (which means everyone, including the recipient or your enemies) can "replay" the transaction again and again and again until all your ether is gone simply by copying and pasting your original transaction and resending it to the network. However, with the nonce value included in the transaction data, <em>every single transaction is unique</em>, even when sending the same amount of ether to the same recipient address multiple times. Thus, by having the incrementing nonce as part of the transaction, it is simply not possible for anyone to "duplicate" a payment you have made.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-55">
<p>In summary, it is important to note that the use of the nonce is actually vital for an <em>account-based</em> protocol, in contrast to the &#x201c;Unspent Transaction Output&#x201d; (UTXO) mechanism of the Bitcoin protocol.</p>
</div>
<div class="sect3 data-line-58">
<h4 id="tracking_nonce">Keeping Track of Nonces</h4>
<div class="paragraph data-line-60">
<p>In practical terms, the nonce is an up-to-date count of the number of <em>confirmed</em> (i.e., on-chain) transactions that have originated from an account. To find out what the nonce is, you can interrogate the blockchain, for example via the web3 interface. Open a JavaScript console in Geth (or your preferred web3 interface) on Ropsten testnet, then type:</p>
</div>
<pre data-type="programlisting">
&gt; <strong>web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f")</strong>
40
</pre>
<div class="admonitionblock tip data-line-70">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-71">
<p>The nonce is a zero-based counter, meaning the first transaction has nonce 0. In this example, we have a transaction count of 40, meaning nonces 0 through 39 have been seen. The next transaction&#8217;s nonce will need to be 40.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-74">
<p>Your wallet will keep track of nonces for each address it manages. It&#8217;s fairly simple to do that, as long as you are only originating transactions from a single point. Let&#8217;s say you are writing your own wallet software or some other application that originates transactions. How do you track nonces?</p>
</div>
<div class="paragraph data-line-76">
<p>When you create a new transaction, you assign the next nonce in the sequence. But until it is confirmed, it will not count toward the getTransactionCount total.</p>
</div>
<div id="get_tx_count_bug" class="admonitionblock warning data-line-80">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-81">
<p>Be careful when using the getTransactionCount function for counting pending transactions, because you might run into some problems if you send a few transactions in a row.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-84">
<p>Let&#8217;s look at an example:</p>
</div>
<pre data-type="programlisting">
&gt; <strong>web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f", \
"pending")</strong>
40
&gt; <strong>web3.eth.sendTransaction({from: web3.eth.accounts[0], to: \
"0xB0920c523d582040f2BCB1bD7FB1c7C1ECEbdB34", value: web3.utils.toWei(0.01, "ether")});</strong>
&gt; <strong>web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f", \
"pending")</strong>
41
&gt; <strong>web3.eth.sendTransaction({from: web3.eth.accounts[0], to: \
"0xB0920c523d582040f2BCB1bD7FB1c7C1ECEbdB34", value: web3.utils.toWei(0.01, "ether")});</strong>
&gt; <strong>web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f", \
"pending")</strong>
41
&gt; <strong>web3.eth.sendTransaction({from: web3.eth.accounts[0], to: \
"0xB0920c523d582040f2BCB1bD7FB1c7C1ECEbdB34", value: web3.utils.toWei(0.01, "ether")});</strong>
&gt; <strong>web3.eth.getTransactionCount("0x9e713963a92c02317a681b9bb3065a8249de124f", \
"pending")</strong>
41
</pre>
<div class="admonitionblock tip data-line-109">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-110">
<p>If you&#8217;re trying to recreate these code examples yourself in Geth&#8217;s javascript console, you should use web3.toWei() instead of web3.utils.toWei(). This is because Geth uses an older version of the web3 library.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-113">
<p>As you can see, the first transaction we sent increased the transaction count to 41, showing the pending transaction. But when we sent three more transactions in quick succession, the getTransactionCount call didn&#8217;t count them. It only counted one, even though you might expect there to be three pending in the mempool. If we wait a few seconds to allow for network communications to settle down, the getTransactionCount call will return the expected number. But in the interim, while there is more than one transaction pending, it might not help us.</p>
</div>
<div class="paragraph data-line-115">
<p>When you build an application that constructs transactions, it cannot rely on <span class="keep-together"><code>getTransactionCount</code></span> for pending transactions. Only when the pending and confirmed counts are equal (all outstanding transactions are confirmed) can you trust the output of getTransactionCount to start your nonce counter. Thereafter, keep track of the nonce in your application until each transaction confirms.</p>
</div>
<div class="paragraph data-line-117">
<p>Parity&#8217;s JSON RPC interface offers the parity_nextNonce function, which returns the next nonce that should be used in a transaction. The parity_nextNonce function counts nonces correctly, even if you construct several transactions in rapid succession without confirming them:</p>
</div>
<pre data-type="programlisting">
$ <strong>curl --data '{"method":"parity_nextNonce", \
  "params":["0x9e713963a92c02317a681b9bb3065a8249de124f"],\
  "id":1,"jsonrpc":"2.0"}' -H "Content-Type: application/json" -X POST \
  localhost:8545</strong>

{"jsonrpc":"2.0","result":"0x32","id":1}
</pre>
<div id="parity_curl" class="admonitionblock tip data-line-132">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-133">
<p>Parity has a web console for accessing the JSON RPC interface, but here we are using a command-line HTTP client to access it.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-137">
<h4 id="gaps_nonce">Gaps in Nonces, Duplicate Nonces, and Confirmation</h4>
<div class="paragraph data-line-139">
<p>It is important to keep track of nonces if you are creating transactions programmatically, especially if you are doing so from multiple independent processes <span class="keep-together">simultaneously</span>.</p>
</div>
<div class="paragraph data-line-141">
<p>The Ethereum network processes transactions sequentially, based on the nonce. That means that if you transmit a transaction with nonce 0 and then transmit a transaction with nonce 2, the second transaction will not be included in any blocks. It will be stored in the mempool, while the Ethereum network waits for the missing nonce to appear. All nodes will assume that the missing nonce has simply been delayed and that the transaction with nonce 2 was received out of sequence.</p>
</div>
<div class="paragraph data-line-143">
<p>If you then transmit a transaction with the missing nonce 1, both transactions (nonces 1 and 2) will be processed and included (if valid, of course). Once you fill the gap, the network can mine the out-of-sequence transaction that it held in the mempool.</p>
</div>
<div class="paragraph data-line-145">
<p>What this means is that if you create several transactions in sequence and one of them does not get officially included in any blocks, all the subsequent transactions will be "stuck," waiting for the missing nonce. A transaction can create an inadvertent "gap" in the nonce sequence because it is invalid or has insufficient gas. To get things moving again, you have to transmit a valid transaction with the missing nonce. You should be equally mindful that once a transaction with the "missing" nonce is validated by the network, all the broadcast transactions with subsequent nonces will incrementally become valid; it is not possible to "recall" a transaction!</p>
</div>
<div class="paragraph data-line-147">
<p>If, on the other hand, you accidentally duplicate a nonce, for example by transmitting two transactions with the same nonce but different recipients or values, then one of them will be confirmed and one will be rejected. Which one is confirmed will be determined by the sequence in which they arrive at the first validating node that receives them&#x2014;i.e., it will be fairly random.</p>
</div>
<div class="paragraph data-line-149">
<p>As you can see, keeping track of nonces is necessary, and if your application doesn&#8217;t manage that process correctly you will run into problems. Unfortunately, things get even more difficult if you are trying to do this concurrently, as we will see in the next section.</p>
</div>
</div>
<div class="sect3 data-line-152">
<h4 id="concurrency">Concurrency, Transaction Origination, and Nonces</h4>
<div class="paragraph data-line-154">
<p>Concurrency is a complex aspect of computer science, and it crops up unexpectedly sometimes, especially in decentralized and distributed real-time systems like <span class="keep-together">Ethereum</span>.</p>
</div>
<div class="paragraph data-line-156">
<p>In simple terms, concurrency is when you have simultaneous computation by multiple independent systems. These can be in the same program (e.g., multithreading), on the same CPU (e.g., multiprocessing), or on different computers (i.e., distributed <span class="keep-together">systems</span>). Ethereum, by definition, is a system that allows concurrency of operations (nodes, clients, DApps) but enforces a singleton state through consensus.</p>
</div>
<div class="paragraph data-line-158">
<p>Now, imagine that you have multiple independent wallet applications that are generating transactions from the same address or addresses. One example of such a situation would be an exchange processing withdrawals from the exchange&#8217;s hot wallet (a wallet whose keys are stored online, in contrast to a cold wallet where the keys are never online). Ideally, you&#8217;d want to have more than one computer processing withdrawals, so that it doesn&#8217;t become a bottleneck or single point of failure. However, this quickly becomes problematic, as having more than one computer producing withdrawals will result in some thorny concurrency problems, not least of which is the selection of nonces. How do multiple computers generating, signing, and broadcasting transactions from the same hot wallet account coordinate?</p>
</div>
<div class="paragraph data-line-160">
<p>You could use a single computer to assign nonces, on a first-come first-served basis, to computers signing transactions. However, this computer is now a single point of failure. Worse, if several nonces are assigned and one of them never gets used (because of a failure in the computer processing the transaction with that nonce), all subsequent transactions get stuck.</p>
</div>
<div class="paragraph data-line-162">
<p>Another approach would be to generate the transactions, but not assign a nonce to them (and therefore leave them unsigned&#x2014;remember that the nonce is an integral part of the transaction data and therefore needs to be included in the digital signature that authenticates the transaction). You could then queue them to a single node that signs them and also keeps track of nonces. Again, though, this would be a choke point in the process: the signing and tracking of nonces is the part of your operation that is likely to become congested under load, whereas the generation of the unsigned transaction is the part you don&#8217;t really need to parallelize. You would have some concurrency, but it would be lacking in a critical part of the process.</p>
</div>
<div class="paragraph data-line-164">
<p>In the end, these concurrency problems, on top of the difficulty of tracking account balances and transaction confirmations in independent processes, force most implementations toward avoiding concurrency and creating bottlenecks such as a single process handling all withdrawal transactions in an exchange, or setting up multiple hot wallets that can work completely independently for withdrawals and only need to be intermittently rebalanced.</p>
</div>
</div>
</div>
<div class="sect2 data-line-167">
<h3 id="tx_gas">Transaction Gas</h3>
<div class="paragraph data-line-169">
<p>We talked about gas a little in earlier chapters, and we discuss it in more detail in <a href="#gas">Gas</a>. However, let&#8217;s cover some basics about the role of the gasPrice and gasLimit components of a transaction.</p>
</div>
<div class="paragraph data-line-171">
<p>Gas is the fuel of Ethereum. Gas is not ether&#x2014;it&#8217;s a separate virtual currency with its own exchange rate against ether. Ethereum uses gas to control the amount of resources that a transaction can use, since it will be processed on thousands of computers around the world. The open-ended (Turing-complete) computation model requires some form of metering in order to avoid denial-of-service attacks or inadvertently resource-devouring transactions.</p>
</div>
<div class="paragraph data-line-173">
<p>Gas is separate from ether in order to protect the system from the volatility that might arise along with rapid changes in the value of ether, and also as a way to manage the important and sensitive ratios between the costs of the various resources that gas pays for (namely, computation, memory, and storage).</p>
</div>
<div class="paragraph data-line-175">
<p>The gasPrice field in a transaction allows the transaction originator to set the price they are willing to pay in exchange for gas. The price is measured in wei per gas unit. For example, in the sample transaction in <a href="#intro_chapter">Les bases d&#39;Ethereum</a> your wallet set the gasPrice to 3 gwei (3 gigawei or 3 billion wei).</p>
</div>
<div class="admonitionblock tip data-line-178">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-179">
<p>The popular site <a href="https://ethgasstation.info/" data-href="https://ethgasstation.info/">ETH Gas Station</a> provides information on the current prices of gas and other relevant gas metrics for the Ethereum main network.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-182">
<p>Wallets can adjust the gasPrice in transactions they originate to achieve faster confirmation of transactions. The higher the gasPrice, the faster the transaction is likely to be confirmed. Conversely, lower-priority transactions can carry a reduced price, resulting in slower confirmation. The minimum value that gasPrice can be set to is zero, which means a fee-free transaction. During periods of low demand for space in a block, such transactions might very well get mined.</p>
</div>
<div class="admonitionblock note data-line-185">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-186">
<p>The minimum acceptable gasPrice is zero. That means that wallets can generate completely free transactions. Depending on capacity, these may never be confirmed, but there is nothing in the protocol that prohibits free transactions. You can find several examples of such transactions successfully included on the Ethereum blockchain.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="gas_price_suggestion" class="paragraph data-line-190">
<p>The web3 interface offers a gasPrice suggestion, by calculating a median price across several blocks (we can use the truffle console or any JavaScript web3 console to do that):</p>
</div>
<pre data-type="programlisting">
> <strong>web3.eth.getGasPrice(console.log)</strong>
> null BigNumber { s: 1, e: 10, c: [ 10000000000 ] }
</pre>
<div id="calc_gas_price" class="paragraph data-line-200">
<p>The second important field related to gas is gasLimit. In simple terms, gasLimit gives the maximum number of units of gas the transaction originator is willing to buy in order to complete the transaction. For simple payments, meaning transactions that transfer ether from one EOA to another EOA, the gas amount needed is fixed at 21,000 gas units. To calculate how much ether that will cost, you multiply 21,000 by the gasPrice you&#8217;re willing to pay. For example:</p>
</div>
<pre data-type="programlisting">
> <strong>web3.eth.getGasPrice(function(err, res) {console.log(res*21000)} )</strong>
> 210000000000000
</pre>
<div class="paragraph data-line-209">
<p>If your transaction&#8217;s destination address is a contract, then the amount of gas needed can be estimated but cannot be determined with accuracy. That&#8217;s because a contract can evaluate different conditions that lead to different execution paths, with different total gas costs. The contract may execute only a simple computation or a more complex one, depending on conditions that are outside of your control and cannot be predicted. To demonstrate this, let&#8217;s look at an example: we can write a smart contract that increments a counter each time it is called and executes a particular loop a number of times equal to the call count. Maybe on the 100th call it gives out a special prize, like a lottery, but needs to do additional computation to calculate the prize. If you call the contract 99 times one thing happens, but on the 100th call something very different happens. The amount of gas you would pay for that depends on how many other transactions have called that function before your transaction is included in a block. Perhaps your estimate is based on being the 99th transaction, but just before your transaction is confirmed someone else calls the contract for the 99th time. Now you&#8217;re the 100th transaction to call, and the computation effort (and gas cost) is much higher.</p>
</div>
<div class="paragraph data-line-211">
<p>To borrow a common analogy used in Ethereum, you can think of gasLimit as the capacity of the fuel tank in your car (your car is the transaction). You fill the tank with as much gas as you think it will need for the journey (the computation needed to validate your transaction). You can estimate the amount to some degree, but there might be unexpected changes to your journey, such as a diversion (a more complex execution path), that increase fuel consumption.</p>
</div>
<div class="paragraph data-line-213">
<p>The analogy to a fuel tank is somewhat misleading, however. It&#8217;s actually more like a credit account for a gas station company, where you pay after the trip is completed, based on how much gas you actually used. When you transmit your transaction, one of the first validation steps is to check that the account it originated from has enough ether to pay the gasPrice * gas limit. But the amount is not actually deducted from your account until the transaction finishes executing. You are only billed for gas actually consumed by your transaction, but you have to have enough balance for the maximum amount you are willing to pay before you send your transaction.</p>
</div>
</div>
<div class="sect2 data-line-216">
<h3 id="tx_recipient">Transaction Recipient</h3>
<div class="paragraph data-line-218">
<p>The recipient of a transaction is specified in the to field. This contains a 20-byte Ethereum address. The address can be an EOA or a contract address.</p>
</div>
<div class="paragraph data-line-220">
<p>Ethereum does no further validation of this field. Any 20-byte value is considered valid. If the 20-byte value corresponds to an address without a corresponding private key, or without a corresponding contract, the transaction is still valid. Ethereum has no way of knowing whether an address was correctly derived from a public key (and therefore from a private key) in existence.</p>
</div>
<div class="admonitionblock warning data-line-223">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-224">
<p>The Ethereum protocol does not validate recipient addresses in transactions. You can send to an address that has no corresponding private key or contract, thereby "burning" the ether, rendering it forever unspendable. Validation should be done at the user interface level.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-227">
<p>Sending a transaction to the wrong address will probably <em>burn</em> the ether sent, rendering it forever inaccessible (unspendable), since most addresses do not have a known private key and therefore no signature can be generated to spend it. It is assumed that validation of the address happens at the user interface level (see <a href="#EIP55">Hex Encoding with Checksum in Capitalization (EIP-55)</a>). In fact, there are a number of valid reasons for burning ether&#x2014;for example, as a disincentive to cheating in payment channels and other smart contracts&#x2014;and since the amount of ether is finite, burning ether effectively distributes the value burned to all ether holders (in proportion to the amount of ether they hold).</p>
</div>
</div>
<div class="sect2 data-line-230">
<h3 id="tx_value_data">Transaction Value and Data</h3>
<div class="paragraph data-line-232">
<p>The main "payload" of a transaction is contained in two fields: value and data. Transactions can have both value and data, only value, only data, or neither value nor data. All four combinations are valid.</p>
</div>
<div class="paragraph data-line-234">
<p>A transaction with only value is a <em>payment</em>. A transaction with only data is an <em>invocation</em>. A transaction with both value and data is both a payment and an invocation. A transaction with neither value nor data&#x2014;well that&#8217;s probably just a waste of gas! But it is still possible.</p>
</div>
<div class="paragraph data-line-236">
<p>Let&#8217;s try all of these combinations. First we&#8217;ll set the source and destination addresses from our wallet, just to make the demo easier to read:</p>
</div>
<div class="listingblock data-line-239">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">src = web3.eth.accounts[0];
dst = web3.eth.accounts[1];</code></pre>
</div>
</div>
<div class="paragraph data-line-244">
<p>Our first transaction contains only a value (payment), and no data payload:</p>
</div>
<div id="tx_value_nodata_src" class="listingblock data-line-248">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">web3.eth.sendTransaction({from: src, to: dst, \
  value: web3.utils.toWei(0.01, "ether"), data: ""});</code></pre>
</div>
</div>
<div class="paragraph data-line-253">
<p>Our wallet shows a confirmation screen indicating the value to send, as shown in <a href="#parity_txdemo_value_nodata">Parity wallet showing a transaction with value, but no data</a>.</p>
</div>
<div id="parity_txdemo_value_nodata" class="imageblock data-line-257">
<div class="content">
<img src="images/parity_txdemo_value_nodata.png" alt="Parity wallet showing a transaction with value, but no data">
</div>
<div class="title">Figure 31. Parity wallet showing a transaction with value, but no data</div>
</div>
<div class="paragraph data-line-260">
<p>The next example specifies both a value and a data payload:</p>
</div>
<div id="tx_value_data_src" class="listingblock data-line-264">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">web3.eth.sendTransaction({from: src, to: dst, \
  value: web3.utils.toWei(0.01, "ether"), data: "0x1234"});</code></pre>
</div>
</div>
<div class="paragraph data-line-269">
<p>Our wallet shows a confirmation screen indicating the value to send as well as the data payload, as shown in <a href="#parity_txdemo_value_data">Parity wallet showing a transaction with value and data</a>.</p>
</div>
<div id="parity_txdemo_value_data" class="imageblock data-line-273">
<div class="content">
<img src="images/parity_txdemo_value_data.png" alt="Parity wallet showing a transaction with value and data">
</div>
<div class="title">Figure 32. Parity wallet showing a transaction with value and data</div>
</div>
<div class="paragraph data-line-275">
<p>The next transaction includes a data payload but specifies a value of zero:</p>
</div>
<div id="tx_novalue_data_src" class="listingblock data-line-279">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">web3.eth.sendTransaction({from: src, to: dst, value: 0, data: "0x1234"});</code></pre>
</div>
</div>
<div class="paragraph data-line-283">
<p>Our wallet shows a confirmation screen indicating the zero value and the data payload, as shown in <a href="#parity_txdemo_novalue_data">Parity wallet showing a transaction with no value, only data</a>.</p>
</div>
<div id="parity_txdemo_novalue_data" class="imageblock data-line-287">
<div class="content">
<img src="images/parity_txdemo_novalue_data.png" alt="Parity wallet showing a transaction with no value, only data">
</div>
<div class="title">Figure 33. Parity wallet showing a transaction with no value, only data</div>
</div>
<div class="paragraph pagebreak-before data-line-290">
<p>Finally, the last transaction includes neither a value to send nor a data payload:</p>
</div>
<div id="tx_novalue_nodata_src" class="listingblock data-line-294">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">web3.eth.sendTransaction({from: src, to: dst, value: 0, data: ""}));</code></pre>
</div>
</div>
<div class="paragraph data-line-298">
<p>Our wallet shows a confirmation screen indicating zero value, as shown in <a href="#parity_txdemo_novalue_nodata">Parity wallet showing a transaction with no value, and no data</a>.</p>
</div>
<div id="parity_txdemo_novalue_nodata" class="imageblock data-line-302">
<div class="content">
<img src="images/parity_txdemo_novalue_nodata.png" alt="Parity wallet showing a transaction with no value, and no data">
</div>
<div class="title">Figure 34. Parity wallet showing a transaction with no value, and no data</div>
</div>
<div class="sect3 data-line-305">
<h4 id="value_EOA_contracts">Transmitting Value to EOAs and Contracts</h4>
<div class="paragraph data-line-307">
<p>When you construct an Ethereum transaction that contains a value, it is the equivalent of a <em>payment</em>. Such transactions behave differently depending on whether the destination address is a contract or not.</p>
</div>
<div class="paragraph data-line-309">
<p>For EOA addresses, or rather for any address that isn&#8217;t flagged as a contract on the blockchain, Ethereum will record a state change, adding the value you sent to the balance of the address. If the address has not been seen before, it will be added to the client&#8217;s internal representation of the state and its balance initialized to the value of your payment.</p>
</div>
<div class="paragraph data-line-311">
<p>If the destination address (to) is a contract, then the EVM will execute the contract and will attempt to call the function named in the data payload of your transaction. If there is no data in your transaction, the EVM will call a <em>fallback</em> function and, if that function is payable, will execute it to determine what to do next. If there is no code in fallback function, then the effect of the transaction will be to increase the balance of the contract, exactly like a payment to a wallet. If there is no fallback function or non-payable fallback function, then transaction will be reverted.</p>
</div>
<div class="paragraph data-line-313">
<p>A contract can reject incoming payments by throwing an exception immediately when a function is called, or as determined by conditions coded in a function. If the function terminates successfully (without an exception), then the contract&#8217;s state is updated to reflect an increase in the contract&#8217;s ether balance.</p>
</div>
</div>
<div class="sect3 data-line-316">
<h4 id="data_EOA">Transmitting a Data Payload to an EOA or Contract</h4>
<div class="paragraph data-line-318">
<p>When your transaction contains data, it is most likely addressed to a contract address. That doesn&#8217;t mean you cannot send a data payload to an EOA&#x2014;that is completely valid in the Ethereum protocol. However, in that case, the interpretation of the data is up to the wallet you use to access the EOA. It is ignored by the Ethereum protocol. Most wallets also ignore any data received in a transaction to an EOA they control. In the future, it is possible that standards may emerge that allow wallets to interpret data the way contracts do, thereby allowing transactions to invoke functions running inside user wallets. The critical difference is that any interpretation of the data payload by an EOA is not subject to Ethereum&#8217;s consensus rules, unlike a contract <span class="keep-together">execution</span>.</p>
</div>
<div class="paragraph data-line-320">
<p>For now, let&#8217;s assume your transaction is delivering data to a contract address. In that case, the data will be interpreted by the EVM as a <em>contract invocation</em>. Most contracts use this data more specifically as a <em>function invocation</em>, calling the named function and passing any encoded arguments to the function.</p>
</div>
<div class="paragraph data-line-322">
<p>The data payload sent to an ABI-compatible contract (which you can assume all contracts are) is a hex-serialized encoding of:</p>
</div>
<div class="dlist data-line-324">
<dl>
<dt class="hdlist1">A function selector</dt>
<dd>
<p>The first 4 bytes of the Keccak-256 hash of the function&#8217;s prototype. This allows the contract to unambiguously identify which function you wish to invoke.</p>
</dd>
<dt class="hdlist1">The function arguments</dt>
<dd>
<p>The function&#8217;s arguments, encoded according to the rules for the various elementary types defined in the ABI specification.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-328">
<p>In <a href="#solidity_faucet_example">Faucet.sol: Un contrat Solidity mettant en place un robinet</a>, we defined a function for withdrawals:</p>
</div>
<div id="withdraw_function_src" class="listingblock data-line-332">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function withdraw(uint withdraw_amount) public {</code></pre>
</div>
</div>
<div class="paragraph data-line-336">
<p>The <em>prototype</em> of a function is defined as the string containing the name of the function, followed by the data types of each of its arguments, enclosed in parentheses and separated by commas. The function name here is withdraw and it takes a single argument that is a uint (which is an alias for uint256), so the prototype of withdraw would be:</p>
</div>
<div class="listingblock data-line-339">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">withdraw(uint256)</code></pre>
</div>
</div>
<div class="paragraph data-line-343">
<p>Let&#8217;s calculate the Keccak-256 hash of this string:</p>
</div>
<pre data-type="programlisting">
> <strong>web3.utils.sha3("withdraw(uint256)");</strong>
'0x2e1a7d4d13322e7b96f9a57413e1525c250fb7a9021cf91d1540d5b69f16a49f'
</pre>
<div class="paragraph data-line-352">
<p>The first 4 bytes of the hash are 0x2e1a7d4d. That&#8217;s our "function selector" value, which will tell the contract which function we want to call.</p>
</div>
<div class="paragraph data-line-354">
<p>Next, let&#8217;s calculate a value to pass as the argument withdraw_amount. We want to withdraw 0.01 ether. Let&#8217;s encode that to a hex-serialized big-endian unsigned 256-bit integer, denominated in wei:</p>
</div>
<pre data-type="programlisting">
> <strong>withdraw_amount = web3.utils.toWei(0.01, "ether");</strong>
'10000000000000000'
> <strong>withdraw_amount_hex = web3.utils.toHex(withdraw_amount);</strong>
'0x2386f26fc10000'
</pre>
<div class="paragraph data-line-365">
<p>Now, we add the function selector to the amount (padded to 32 bytes):</p>
</div>
<div class="listingblock data-line-367">
<div class="content">
<pre>2e1a7d4d000000000000000000000000000000000000000000000000002386f26fc10000</pre>
</div>
</div>
<div class="paragraph data-line-371">
<p>That&#8217;s the data payload for our transaction, invoking the withdraw function and requesting 0.01 ether as the withdraw_amount.</p>
</div>
</div>
</div>
<div class="sect2 data-line-374">
<h3 id="contract_reg">Special Transaction: Contract Creation</h3>
<div class="paragraph data-line-376">
<p>One special case that we should mention is a transaction that <em>creates a new contract</em> on the blockchain, deploying it for future use. Contract creation transactions are sent to a special destination address called the <em>zero address</em>; the to field in a contract registration transaction contains the address 0x0. This address represents neither an EOA (there is no corresponding private–public key pair) nor a contract. It can never spend ether or initiate a transaction. It is only used as a destination, with the special meaning "create this contract."</p>
</div>
<div class="paragraph data-line-378">
<p>While the zero address is intended only for contract creation, it sometimes receives payments from various addresses. There are two explanations for this: either it is by accident, resulting in the loss of ether, or it is an intentional <em>ether burn</em> (deliberately destroying ether by sending it to an address from which it can never be spent). However, if you want to do an intentional ether burn, you should make your intention clear to the network and use the specially designated burn address instead:</p>
</div>
<div id="burn_address" class="listingblock data-line-381">
<div class="content">
<pre>0x000000000000000000000000000000000000dEaD</pre>
</div>
</div>
<div class="admonitionblock warning data-line-386">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-387">
<p>Any ether sent to the designated burn address will become unspendable and be lost forever.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-390">
<p>A contract creation transaction need only contain a data payload that contains the compiled bytecode which will create the contract. The only effect of this transaction is to create the contract. You can include an ether amount in the value field if you want to set the new contract up with a starting balance, but that is entirely optional. If you send a value (ether) to the contract creation address without a data payload (no contract), then the effect is the same as sending to a burn address&#x2014;there is no contract to credit, so the ether is lost.</p>
</div>
<div class="paragraph data-line-392">
<p>As an example, we can create the <em>Faucet.sol</em> contract used in <a href="#intro_chapter">Les bases d&#39;Ethereum</a> by manually creating a transaction to the zero address with the contract in the data payload. The contract needs to be compiled into a bytecode representation. This can be done with the Solidity compiler:</p>
</div>
<pre data-type="programlisting" class="pagebreak-before">
$ <strong>solc --bin Faucet.sol</strong>

Binary:
6060604052341561000f57600080fd5b60e58061001d6000396000f30060606040526004361060...
</pre>
<div class="paragraph data-line-403">
<p>The same information can also be obtained from the Remix online compiler.</p>
</div>
<div class="paragraph data-line-405">
<p>Now we can create the transaction:</p>
</div>
<pre data-type="programlisting">
> <strong>src = web3.eth.accounts[0];</strong>
> <strong>faucet_code = \
  "0x6060604052341561000f57600080fd5b60e58061001d6000396000f300606...f0029";</strong>
> <strong>web3.eth.sendTransaction({from: src, to: 0, data: faucet_code, \
  gas: 113558, gasPrice: 200000000000});</strong>

"0x7bcc327ae5d369f75b98c0d59037eec41d44dfae75447fd753d9f2db9439124b"
</pre>
<div class="paragraph data-line-419">
<p>It is good practice to always specify a to parameter, even in the case of zero-address contract creation, because the cost of accidentally sending your ether to 0x0 and losing it forever is too great. You should also specify a gasPrice and gasLimit.</p>
</div>
<div class="paragraph data-line-421">
<p>Once the contract is mined we can see it on the Etherscan block explorer, as shown in <a href="#publish_contract_from_web3">Etherscan showing the contract successfully mined</a>.</p>
</div>
<div id="publish_contract_from_web3" class="imageblock data-line-425">
<div class="content">
<img src="images/contract_published.png" alt="Etherscan showing the contract successfully mined">
</div>
<div class="title">Figure 35. Etherscan showing the contract successfully mined</div>
</div>
<div class="paragraph data-line-427">
<p>We can look at the receipt of the transaction to get information about the contract:</p>
</div>
<pre data-type="programlisting">
> <strong>web3.eth.getTransactionReceipt( \
  "0x7bcc327ae5d369f75b98c0d59037eec41d44dfae75447fd753d9f2db9439124b");</strong>

{
  blockHash: "0x6fa7d8bf982490de6246875deb2c21e5f3665b4422089c060138fc3907a95bb2",
  blockNumber: 3105256,
  contractAddress: "0xb226270965b43373e98ffc6e2c7693c17e2cf40b",
  cumulativeGasUsed: 113558,
  from: "0x2a966a87db5913c1b22a59b0d8a11cc51c167a89",
  gasUsed: 113558,
  logs: [],
  logsBloom: \
    "0x00000000000000000000000000000000000000000000000000...00000",
  status: "0x1",
  to: null,
  transactionHash: \
    "0x7bcc327ae5d369f75b98c0d59037eec41d44dfae75447fd753d9f2db9439124b",
  transactionIndex: 0
}
</pre>
<div class="paragraph data-line-453">
<p>This includes the address of the contract, which we can use to send funds to and receive funds from the contract as shown in the previous section:</p>
</div>
<pre data-type="programlisting">
> <strong>contract_address = "0xb226270965b43373e98ffc6e2c7693c17e2cf40b"</strong>
> <strong>web3.eth.sendTransaction({from: src, to: contract_address, \
  value: web3.utils.toWei(0.1, "ether"), data: ""});</strong>

"0x6ebf2e1fe95cc9c1fe2e1a0dc45678ccd127d374fdf145c5c8e6cd4ea2e6ca9f"

> <strong>web3.eth.sendTransaction({from: src, to: contract_address, value: 0, data: \
  "0x2e1a7d4d000000000000000000000000000000000000000000000000002386f26fc10000"});</strong>

"0x59836029e7ce43e92daf84313816ca31420a76a9a571b69e31ec4bf4b37cd16e"
</pre>
<div class="paragraph data-line-470">
<p>After a while, both transactions are visible on Etherscan, as shown in <a href="#publish_contract_transactions">Etherscan showing the transactions for sending and receiving funds</a>.</p>
</div>
<div id="publish_contract_transactions" class="imageblock data-line-474">
<div class="content">
<img src="images/published_contract_transactions.png" alt="Etherscan showing the transactions for sending and receiving funds">
</div>
<div class="title">Figure 36. Etherscan showing the transactions for sending and receiving funds</div>
</div>
</div>
<div class="sect2 data-line-478">
<h3 id="digital_sign">Digital Signatures</h3>
<div class="paragraph data-line-480">
<p>So far, we have not delved into any detail about digital signatures. In this section, we look at how digital signatures work and how they can be used to present proof of ownership of a private key without revealing that private key.</p>
</div>
<div class="sect3 data-line-483">
<h4 id="ecdsa">The Elliptic Curve Digital Signature Algorithm</h4>
<div class="paragraph data-line-485">
<p>The digital signature algorithm used in Ethereum is the <em>Elliptic Curve Digital Signature Algorithm</em> (ECDSA). It&#8217;s based on elliptic curve private–public key pairs, as described in <a href="#elliptic_curve">Elliptic Curve Cryptography Explained</a>.</p>
</div>
<div class="paragraph data-line-487">
<p>A digital signature serves three purposes in Ethereum (see the following sidebar). First, the signature proves that the owner of the private key, who is by implication the owner of an Ethereum account, has <em>authorized</em> the spending of ether, or execution of a contract. Secondly, it guarantees <em>non-repudiation</em>: the proof of authorization is undeniable. Thirdly, the signature proves that the transaction data has not been and <em>cannot be modified</em> by anyone after the transaction has been signed.</p>
</div>
<div id="digital_signature_definition" class="sidebarblock data-line-491">
<div class="content">
<div class="title">Wikipedia&#8217;s Definition of a Digital Signature</div>
<div class="paragraph data-line-492">
<p>A <em>digital signature</em> is a mathematical scheme for presenting the authenticity of digital messages or documents. A valid digital signature gives a recipient reason to believe that the message was created by a known sender (authentication), that the sender cannot deny having sent the message (non-repudiation), and that the message was not altered in transit (integrity).</p>
</div>
<div class="paragraph data-line-494">
<p><em>Source: <a href="https://en.wikipedia.org/wiki/Digital_signature" class="undefined" data-href="https://en.wikipedia.org/wiki/Digital_signature">https://en.wikipedia.org/wiki/Digital_signature</a></em></p>
</div>
</div>
</div>
</div>
<div class="sect3 data-line-498">
<h4 id="digital_sign_work">How Digital Signatures Work</h4>
<div class="paragraph data-line-500">
<p>A digital signature is a mathematical scheme that consists of two parts. The first part is an algorithm for creating a signature, using a private key (the signing key), from a message (which in our case is the transaction). The second part is an algorithm that allows anyone to verify the signature by only using the message and a public key.</p>
</div>
<div class="sect4 data-line-503">
<h5 id="digital_sign_create">Creating a digital signature</h5>
<div class="paragraph data-line-505">
<p>In Ethereum&#8217;s implementation of ECDSA, the "message" being signed is the transaction, or more accurately, the Keccak-256 hash of the RLP-encoded data from the transaction. The signing key is the EOA&#8217;s private key. The result is the signature:</p>
</div>
<div data-type="equation">
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow>
    <mrow>
      <mi>S</mi>
      <mi>i</mi>
      <mi>g</mi>
    </mrow>
    <mo>=</mo>
    <msub><mi>F</mi> <mrow><mi>s</mi><mi>i</mi><mi>g</mi></mrow> </msub>
    <mrow>
      <mo>(</mo>
      <msub><mi>F</mi> <mrow><mi>k</mi><mi>e</mi><mi>c</mi><mi>c</mi><mi>a</mi><mi>k</mi><mn>256</mn></mrow> </msub>
      <mrow>
        <mo>(</mo>
        <mi>m</mi>
        <mo>)</mo>
      </mrow>
      <mo>,</mo>
      <mi>k</mi>
      <mo>)</mo>
    </mrow>
  </mrow>
</math>
</div>
<div class="paragraph data-line-535">
<p>where:</p>
</div>
<div class="ulist data-line-537">
<ul>
<li class="data-line-537">
<p><em>k</em> is the signing private key.</p>
</li>
<li class="data-line-538">
<p><em>m</em> is the RLP-encoded transaction.</p>
</li>
<li class="data-line-539">
<p><em>F</em><sub><em>keccak256</em></sub> is the Keccak-256 hash function.</p>
</li>
<li class="data-line-540">
<p><em>F</em><sub><em>sig</em></sub> is the signing algorithm.</p>
</li>
<li class="data-line-541">
<p><em>Sig</em> is the resulting signature.</p>
</li>
</ul>
</div>
<div id="sign_function" class="paragraph data-line-544">
<p>The function <em>F</em><sub><em>sig</em></sub> produces a signature <em>Sig</em> that is composed of two values, commonly referred to as <em>r</em> and <em>s</em>:</p>
</div>
<div data-type="equation">
<math xmlns="http://www.w3.org/1998/Math/MathML" display="block">
  <mrow>
    <mrow>
      <mi>S</mi>
      <mi>i</mi>
      <mi>g</mi>
    </mrow>
    <mo>=</mo>
    <mo>(</mo>
    <mi>r</mi>
    <mo>,</mo>
    <mi>s</mi>
    <mo>)</mo>
  </mrow>
</math>
</div>
</div>
</div>
<div class="sect3 data-line-567">
<h4 id="verify_sign">Verifying the Signature</h4>
<div class="paragraph data-line-569">
<p>To verify the signature, one must have the signature (<em>r</em> and <em>s</em>), the serialized transaction, and the public key that corresponds to the private key used to create the signature. Essentially, verification of a signature means "only the owner of the private key that generated this public key could have produced this signature on this transaction."</p>
</div>
<div class="paragraph data-line-571">
<p>The signature verification algorithm takes the message (i.e., a hash of the transaction for our usage), the signer&#8217;s public key, and the signature (<em>r</em> and <em>s</em> values), and returns true if the signature is valid for this message and public key.</p>
</div>
</div>
<div class="sect3 data-line-574">
<h4 id="ecdsa_math">ECDSA Math</h4>
<div class="paragraph data-line-576">
<p>As mentioned previously, signatures are created by a mathematical function <em>F</em><sub><em>sig</em></sub> that produces a signature composed of two values, <em>r</em> and <em>s</em>. In this section we look at the function <em>F</em><sub><em>sig</em></sub> in more detail.</p>
</div>
<div class="paragraph data-line-578">
<p>The signature algorithm first generates an <em>ephemeral</em> (temporary) private key in a cryptographically secure way. This temporary key is used in the calculation of the <em>r</em> and <em>s</em> values to ensure that the sender&#8217;s actual private key can&#8217;t be calculated by attackers watching signed transactions on the Ethereum network.</p>
</div>
<div class="paragraph data-line-580">
<p>As we know from <a href="#pubkey">Public Keys</a>, the ephemeral private key is used to derive the corresponding (ephemeral) public key, so we have:</p>
</div>
<div class="ulist data-line-582">
<ul>
<li class="data-line-582">
<p>A cryptographically secure random number <em>q</em>, which is used as the ephemeral private key</p>
</li>
<li class="data-line-583">
<p>The corresponding ephemeral public key <em>Q</em>, generated from <em>q</em> and the elliptic curve generator point <em>G</em></p>
</li>
</ul>
</div>
<div class="paragraph data-line-585">
<p>The <em>r</em> value of the digital signature is then the <em>x</em> coordinate of the ephemeral public key <em>Q</em>.</p>
</div>
<div class="paragraph data-line-587">
<p>From there, the algorithm calculates the <em>s</em> value of the signature, such that:</p>
</div>
<ul class="simplelist">
<li><em>s</em> &#8801; <em>q</em><sup>-1</sup> (<em>Keccak256</em>(<em>m</em>) + <em>r</em> * <em>k</em>)  &nbsp;  &nbsp; (<em>mod p</em>)</li>
</ul>
<div class="paragraph data-line-595">
<p>where:</p>
</div>
<div class="ulist data-line-597">
<ul>
<li class="data-line-597">
<p><em>q</em> is the ephemeral private key.</p>
</li>
<li class="data-line-598">
<p><em>r</em> is the <em>x</em> coordinate of the ephemeral public key.</p>
</li>
<li class="data-line-599">
<p><em>k</em> is the signing (EOA owner&#8217;s) private key.</p>
</li>
<li class="data-line-600">
<p><em>m</em> is the transaction data.</p>
</li>
<li class="data-line-601">
<p><em>p</em> is the prime order of the elliptic curve.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-603">
<p>Verification is the inverse of the signature generation function, using the <em>r</em> and <em>s</em> values and the sender&#8217;s public key to calculate a value <em>Q</em>, which is a point on the elliptic curve (the ephemeral public key used in signature creation). The steps are as follows:</p>
</div>
<div class="olist arabic data-line-605">
<ol class="arabic">
<li class="data-line-605">
<p>Check all inputs are correctly formed</p>
</li>
<li class="data-line-606">
<p>Calculate <em>w</em> = <em>s</em><sup>-1</sup> <em>mod p</em></p>
</li>
<li class="data-line-607">
<p>Calculate <em>u<sub>1</sub></em> = <em>Keccak256</em>(<em>m</em>) * <em>w</em> <em>mod p</em></p>
</li>
<li class="data-line-608">
<p>Calculate <em>u<sub>2</sub></em> = <em>r</em> * <em>w</em> <em>mod p</em></p>
</li>
<li class="data-line-609">
<p>Finally, calculate the point on the elliptic curve <em>Q</em> &#8801; <em>u<sub>1</sub></em> * <em>G</em> + <em>u<sub>2</sub></em> * <em>K</em>  &#160; &#160; (<em>mod p</em>)</p>
</li>
</ol>
</div>
<div class="paragraph data-line-611">
<p>where:</p>
</div>
<div class="ulist data-line-613">
<ul>
<li class="data-line-613">
<p><em>r</em> and <em>s</em> are the signature values.</p>
</li>
<li class="data-line-614">
<p><em>K</em> is the signer&#8217;s (EOA owner&#8217;s) public key.</p>
</li>
<li class="data-line-615">
<p><em>m</em> is the transaction data that was signed.</p>
</li>
<li class="data-line-616">
<p><em>G</em> is the elliptic curve generator point.</p>
</li>
<li class="data-line-617">
<p><em>p</em> is the prime order of the elliptic curve.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-619">
<p>If the <em>x</em> coordinate of the calculated point <em>Q</em> is equal to <em>r</em>, then the verifier can conclude that the signature is valid.</p>
</div>
<div class="paragraph data-line-621">
<p>Note that in verifying the signature, the private key is neither known nor revealed.</p>
</div>
<div class="admonitionblock tip data-line-624">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-625">
<p>ECDSA is necessarily a fairly complicated piece of math; a full explanation is beyond the scope of this book. A number of great guides online take you through it step by step: search for "ECDSA explained" or try this one: <a href="http://bit.ly/2r0HhGB" class="undefined" data-href="http://bit.ly/2r0HhGB">http://bit.ly/2r0HhGB</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-629">
<h4 id="tx_sign">Transaction Signing in Practice</h4>
<div class="paragraph data-line-631">
<p>To produce a valid transaction, the originator must digitally sign the message, using the Elliptic Curve Digital Signature Algorithm. When we say "sign the transaction" we actually mean "sign the Keccak-256 hash of the RLP-serialized transaction data." The signature is applied to the hash of the transaction data, not the transaction itself.</p>
</div>
<div class="paragraph data-line-633">
<p>To sign a transaction in Ethereum, the originator must:</p>
</div>
<div class="olist arabic data-line-635">
<ol class="arabic">
<li class="data-line-635">
<p>Create a transaction data structure, containing nine fields: nonce, gasPrice, gasLimit, to, value, data, chainID, 0, 0.</p>
</li>
<li class="data-line-636">
<p>Produce an RLP-encoded serialized message of the transaction data structure.</p>
</li>
<li class="data-line-637">
<p>Compute the Keccak-256 hash of this serialized message.</p>
</li>
<li class="data-line-638">
<p>Compute the ECDSA signature, signing the hash with the originating EOA&#8217;s private key.</p>
</li>
<li class="data-line-639">
<p>Append the ECDSA signature&#8217;s computed v, r, and s values to the transaction.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-641">
<p>The special signature variable v indicates two things: the chain ID and the recovery identifier to help the ECDSArecover function check the signature. It is calculated as either one of 27 or 28, or as the chain ID doubled plus 35 or 36. For more information on the chain ID, see <a href="#raw_tx_eip155">Raw Transaction Creation with EIP-155</a>. The recovery identifier (27 or 28 in the "old-style" signatures, or 35 or 36 in the full Spurious Dragon&#x2013;style transactions) is used to indicate the parity of the y component of the public key (see <a href="#sign_prefix">The Signature Prefix Value (v) and Public Key Recovery</a> for more details).</p>
</div>
<div class="admonitionblock note data-line-645">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-646">
<p>At block #2,675,000 Ethereum implemented the "Spurious Dragon" hard fork, which, among other changes, introduced a new signing scheme that includes transaction replay protection (preventing transactions meant for one network being replayed on others). This new signing scheme is specified in EIP-155. This change affects the form of the transaction and its signature, so attention must be paid to the first of the three signature variables (i.e., v), which takes one of two forms and indicates the data fields included in the transaction message being hashed.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-651">
<h4 id="raw_tx">Raw Transaction Creation and Signing</h4>
<div class="paragraph data-line-653">
<p>In this section we&#8217;ll create a raw transaction and sign it, using the ethereumjs-tx library, which can be installed with npm. This demonstrates the functions that would normally be used inside a wallet, or an application that signs transactions on behalf of a user. The source code for this example is in the file <em>raw_tx_demo.js</em> in the book&#8217;s <a href="http://bit.ly/2yI2GL3" data-href="http://bit.ly/2yI2GL3">GitHub repository</a>:</p>
</div>
<div id="raw_tx_demo_source" class="listingblock data-line-0">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">// Load requirements first:
//
// npm init
// npm install ethereumjs-tx
//
// Run with: $ node raw_tx_demo.js
const ethTx = require('ethereumjs-tx').Transaction;

const txData = {
  nonce: '0x0',
  gasPrice: '0x09184e72a000',
  gasLimit: '0x30000',
  to: '0xb0920c523d582040f2bcb1bd7fb1c7c1ecebdb34',
  value: '0x00',
  data: '',
  v: "0x1c", // Ethereum mainnet chainID
  r: 0,
  s: 0 
};

tx = new ethTx(txData);
console.log('RLP-Encoded Tx: 0x' + tx.serialize().toString('hex'))

txHash = tx.hash(); // This step encodes into RLP and calculates the hash
console.log('Tx Hash: 0x' + txHash.toString('hex'))

// Sign transaction
const privKey = Buffer.from(
    '91c8360c4cb4b5fac45513a7213f31d4e4a7bfcb4630e9fbf074f42a203ac0b9', 'hex');
tx.sign(privKey);

serializedTx = tx.serialize();
rawTx = 'Signed Raw Transaction: 0x' + serializedTx.toString('hex');
console.log(rawTx)</code></pre>
</div>
</div>
<div id="raw_tx_demo_run" class="paragraph data-line-662">
<p>Running the example code produces the following results:</p>
</div>
<pre data-type="programlisting">
$ <strong>node raw_tx_demo.js</strong>
RLP-Encoded Tx: 0xe6808609184e72a0008303000094b0920c523d582040f2bcb1bd7fb1c7c1...
Tx Hash: 0xaa7f03f9f4e52fcf69f836a6d2bbc7706580adce0a068ff6525ba337218e6992
Signed Raw Transaction: 0xf866808609184e72a0008303000094b0920c523d582040f2bcb1...
</pre>
</div>
<div class="sect3 data-line-674">
<h4 id="raw_tx_eip155">Raw Transaction Creation with EIP-155</h4>
<div class="paragraph data-line-676">
<p>The EIP-155 "Simple Replay Attack Protection" standard specifies a replay-attack-protected transaction encoding, which includes a <em>chain identifier</em> inside the transaction data, prior to signing. This ensures that transactions created for one blockchain (e.g., the Ethereum main network) are invalid on another blockchain (e.g., Ethereum Classic or the Ropsten test network). Therefore, transactions broadcast on one network cannot be <em>replayed</em> on another, hence the name of the standard.</p>
</div>
<div class="paragraph data-line-678">
<p>EIP-155 adds three fields to the main six fields of the transaction data structure, namely the chain identifier, 0, and 0. These three fields are added to the transaction data <em>before it is encoded and hashed</em>. They therefore change the transaction&#8217;s hash, to which the signature is later applied. By including the chain identifier in the data being signed, the transaction signature prevents any changes, as the signature is invalidated if the chain identifier is modified. Therefore, EIP-155 makes it impossible for a transaction to be replayed on another chain, because the signature&#8217;s validity depends on the chain identifier.</p>
</div>
<div class="paragraph data-line-681">
<p>The chain identifier field takes a value according to the network the transaction is meant for, as outlined in <a href="#chain_id_table">Chain identifiers</a>.</p>
</div>
<table id="chain_id_table" class="tableblock frame-all grid-all stretch data-line-686">
<caption class="title">Table 9. Chain identifiers</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Chain</th>
<th class="tableblock halign-left valign-top">Chain ID</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethereum mainnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Morden (obsolete), Expanse</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ropsten</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rinkeby</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rootstock mainnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rootstock testnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kovan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">42</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethereum Classic mainnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">61</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethereum Classic testnet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">62</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Geth private testnets</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1337</p></td>
</tr>
</tbody>
</table>
<div class="paragraph data-line-700">
<p>The resulting transaction structure is RLP-encoded, hashed, and signed. The signature algorithm is modified slightly to encode the chain identifier in the v prefix too.</p>
</div>
<div class="paragraph data-line-702">
<p>For more details, see <a href="http://bit.ly/2CQUgne" data-href="http://bit.ly/2CQUgne">the EIP-155 specification</a>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-705">
<h3 id="sign_prefix">The Signature Prefix Value (v) and Public Key Recovery</h3>
<div class="paragraph data-line-707">
<p>As mentioned in <a href="#tx_struct">The Structure of a Transaction</a>, the transaction message doesn&#8217;t include a "from" field. That&#8217;s because the originator&#8217;s public key can be computed directly from the ECDSA signature. Once you have the public key, you can compute the address easily. The process of recovering the signer&#8217;s public key is called <em>public key recovery</em>.</p>
</div>
<div class="paragraph data-line-709">
<p>Given the values r and s that were computed in <a href="#ecdsa_math">ECDSA Math</a>, we can compute two possible public keys.</p>
</div>
<div class="paragraph data-line-711">
<p>First, we compute two elliptic curve points, <em>R</em> and <em>R</em><sup><em>'</em></sup>, from the <em>x</em> coordinate r value that is in the signature. There are two points because the elliptic curve is symmetric across the x-axis, so that for any value x there are two possible values that fit the curve, one on each side of the x-axis.</p>
</div>
<div class="paragraph data-line-713">
<p>From r we also calculate <em>r</em><sup>-1</sup>, which is the multiplicative inverse of r.</p>
</div>
<div class="paragraph data-line-715">
<p>Finally, we calculate <em>z</em>, which is the <em>n</em> lowest bits of the message hash, where <em>n</em> is the order of the elliptic curve.</p>
</div>
<div class="paragraph data-line-717">
<p>The two possible public keys are then:</p>
</div>
<ul class="simplelist">
<li><em>K</em><sub>1</sub> = <em>r</em><sup>&#x2013;1</sup> (<em>sR</em> &#x2013; <em>zG</em>)</li>
</ul>
<div class="paragraph data-line-725">
<p>and:</p>
</div>
<ul class="simplelist">
<li><em>K</em><sub>2</sub> = <em>r</em><sup>&#x2013;1</sup> (<em>sR</em><sup>'</sup> &#x2013; <em>zG</em>)</li>
</ul>
<div class="paragraph data-line-733">
<p>where:</p>
</div>
<div class="ulist data-line-735">
<ul>
<li class="data-line-735">
<p><em>K</em><sub>1</sub> and <em>K</em><sub>2</sub> are the two possibilities for the signer&#8217;s public key.</p>
</li>
<li class="data-line-736">
<p><em>r</em><sup>-1</sup> is the multiplicative inverse of the signature&#8217;s r value.</p>
</li>
<li class="data-line-737">
<p><em>s</em> is the signature&#8217;s s value.</p>
</li>
<li class="data-line-738">
<p><em>R</em> and <em>R</em><sup>'</sup> are the two possibilities for the ephemeral public key <em>Q</em>.</p>
</li>
<li class="data-line-739">
<p><em>z</em> is the <em>n</em>-lowest bits of the message hash.</p>
</li>
<li class="data-line-740">
<p><em>G</em> is the elliptic curve generator point.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-742">
<p>To make things more efficient, the transaction signature includes a prefix value v, which tells us which of the two possible <em>R</em> values is the ephemeral public key. If v is even, then <em>R</em> is the correct value. If v is odd, then it is <em>R</em><sup>'</sup>. That way, we need to calculate only one value for <em>R</em> and only one value for <em>K</em>.</p>
</div>
</div>
<div class="sect2 data-line-745">
<h3 id="offline_sign">Separating Signing and Transmission (Offline Signing)</h3>
<div class="paragraph data-line-747">
<p>Once a transaction is signed, it is ready to transmit to the Ethereum network. The three steps of creating, signing, and broadcasting a transaction normally happen as a single operation, for example using web3.eth.sendTransaction. However, as you saw in <a href="#raw_tx">Raw Transaction Creation and Signing</a>, you can create and sign the transaction in two separate steps. Once you have a signed transaction, you can then transmit it using web3.eth.sendSignedTransaction, which takes a hex-encoded and signed transaction and transmits it on the Ethereum network.</p>
</div>
<div class="paragraph data-line-749">
<p>Why would you want to separate the signing and transmission of transactions? The most common reason is security. The computer that signs a transaction must have unlocked private keys loaded in memory. The computer that does the transmitting must be connected to the internet (and be running an Ethereum client). If these two functions are on one computer, then you have private keys on an online system, which is quite dangerous. Separating the functions of signing and transmitting and performing them on different machines (on an offline and an online device, respectively) is called <em>offline signing</em> and is a common security practice.</p>
</div>
<div class="paragraph data-line-751">
<p><a href="#offline_signing">Offline signing of Ethereum transactions</a> shows the process:</p>
</div>
<div class="olist arabic data-line-753">
<ol class="arabic">
<li class="data-line-753">
<p>Create an unsigned transaction on the online computer where the current state of the account, notably the current nonce and funds available, can be retrieved.</p>
</li>
<li class="data-line-754">
<p>Transfer the unsigned transaction to an "air-gapped" offline device for transaction signing, e.g., via a QR code or USB flash drive.</p>
</li>
<li class="data-line-755">
<p>Transmit the signed transaction (back) to an online device for broadcast on the Ethereum blockchain, e.g., via QR code or USB flash drive.</p>
</li>
</ol>
</div>
<div id="offline_signing" class="imageblock data-line-759">
<div class="content">
<img src="images/offline_signing.png" alt="Offline signing of Ethereum transactions">
</div>
<div class="title">Figure 37. Offline signing of Ethereum transactions</div>
</div>
<div class="paragraph data-line-761">
<p>Depending on the level of security you need, your "offline signing" computer can have varying degrees of separation from the online computer, ranging from an isolated and firewalled subnet (online but segregated) to a completely offline system known as an <em>air-gapped</em> system. In an air-gapped system there is no network connectivity at all&#x2014;the computer is separated from the online environment by a gap of "air." To sign transactions you transfer them to and from the air-gapped computer using data storage media or (better) a webcam and QR code. Of course, this means you must manually transfer every transaction you want signed, and this doesn&#8217;t scale.</p>
</div>
<div class="paragraph data-line-763">
<p>While not many environments can utilize a fully air-gapped system, even a small degree of isolation has significant security benefits. For example, an isolated subnet with a firewall that only allows a message-queue protocol through can offer a much-reduced attack surface and much higher security than signing on the online system. Many companies use a protocol such as ZeroMQ (0MQ) for this purpose. With a setup like that, transactions are serialized and queued for signing. The queuing protocol transmits the serialized message, in a way similar to a TCP socket, to the signing computer. The signing computer reads the serialized transactions from the queue (carefully), applies a signature with the appropriate key, and places them on an outgoing queue. The outgoing queue transmits the signed transactions to a computer with an Ethereum client that dequeues them and transmits them.</p>
</div>
</div>
<div class="sect2 data-line-766">
<h3 id="tx_propagation">Transaction Propagation</h3>
<div class="paragraph data-line-768">
<p>The Ethereum network uses a "flood routing" protocol. Each Ethereum client acts as a <em>node</em> in a <em>peer-to-peer (P2P)</em> network, which (ideally) forms a <em>mesh</em> network. No network node is special: they all act as equal peers. We will use the term "node" to refer to an Ethereum client that is connected to and participates in the P2P network.</p>
</div>
<div class="paragraph data-line-770">
<p>Transaction propagation starts with the originating Ethereum node creating (or receiving from offline) a signed transaction. The transaction is validated and then transmitted to all the other Ethereum nodes that are <em>directly</em> connected to the originating node. On average, each Ethereum node maintains connections to at least 13 other nodes, called its <em>neighbors</em>. Each neighbor node validates the transaction as soon as they receive it. If they agree that it is valid, they store a copy and propagate it to all their neighbors (except the one it came from). As a result, the transaction ripples outwards from the originating node, <em>flooding</em> across the network, until all nodes in the network have a copy of the transaction. Nodes can filter the messages they propagate, but the default is to propagate all valid transaction messages they receive.</p>
</div>
<div class="paragraph data-line-772">
<p>Within just a few seconds, an Ethereum transaction propagates to all the Ethereum nodes around the globe. From the perspective of each node, it is not possible to discern the origin of the transaction. The neighbor that sent it to the node may be the originator of the transaction or may have received it from one of its neighbors. To be able to track the origins of transactions, or interfere with propagation, an attacker would have to control a significant percentage of all nodes. This is part of the security and privacy design of P2P networks, especially as applied to blockchain networks.</p>
</div>
</div>
<div class="sect2 data-line-775">
<h3 id="chain_record">Recording on the Blockchain</h3>
<div class="paragraph data-line-777">
<p>While all the nodes in Ethereum are equal peers, some of them are operated by <em>miners</em> and are feeding transactions and blocks to <em>mining farms</em>, which are computers with high-performance graphics processing units (GPUs). The mining computers add transactions to a candidate block and attempt to find a <em>proof of work</em> that makes the candidate block valid. We will discuss this in more detail in <a href="#consensus">Consensus</a>.</p>
</div>
<div class="paragraph data-line-779">
<p>Without going into too much detail, valid transactions will eventually be included in a block of transactions and, thus, recorded in the Ethereum blockchain. Once mined into a block, transactions also modify the state of the Ethereum singleton, either by modifying the balance of an account (in the case of a simple payment) or by invoking contracts that change their internal state. These changes are recorded alongside the transaction, in the form of a transaction <em>receipt</em>, which may also include <em>events</em>. We will examine all this in much more detail in <a href="#evm_chapter">La machine virtuelle Ethereum</a>.</p>
</div>
<div class="paragraph data-line-781">
<p>A transaction that has completed its journey from creation through signing by an EOA, propagation, and finally mining has changed the state of the singleton and left an indelible mark on the blockchain.</p>
</div>
</div>
<div class="sect2 data-line-783">
<h3 id="_multiple_signature_multisig_transactions">Multiple-Signature (Multisig) Transactions</h3>
<div class="paragraph data-line-785">
<p>If you are familiar with Bitcoin&#8217;s scripting capabilities, you know that it is possible to create a Bitcoin multisig account which can only spend funds when multiple parties sign the transaction (e.g., 2 of 2 or 3 of 4 signatures). Ethereum&#8217;s basic EOA value transactions have no provisions for multiple signatures; however, arbitrary signing restrictions can be enforced by smart contracts with any conditions you can think of, to handle the transfer of ether and tokens alike.</p>
</div>
<div class="paragraph data-line-787">
<p>To take advantage of this capability, ether has to be transferred to a "wallet contract" that is programmed with the spending rules desired, such as multisignature requirements or spending limits (or combinations of the two). The wallet contract then sends the funds when prompted by an authorized EOA once the spending conditions have been satisfied. For example, to protect your ether under a multisig condition, transfer the ether to a multisig contract. Whenever you want to send funds to another account, all the required users will need to send transactions to the contract using a regular wallet app, effectively authorizing the contract to perform the final <span class="keep-together">transaction</span>.</p>
</div>
<div class="paragraph data-line-789">
<p>These contracts can also be designed to require multiple signatures before executing local code or to trigger other contracts. The security of the scheme is ultimately determined by the multisig contract code.</p>
</div>
<div class="paragraph data-line-791">
<p>The ability to implement multisignature transactions as a smart contract demonstrates the flexiblity of Ethereum. However, it is a double-edged sword, as the extra flexibility can lead to bugs that undermine the security of multisignature schemes. There are, in fact, a number of proposals to create a multisignature command in the EVM that removes the need for smart contracts, at least for the simple M-of-N multisignature schemes. This would be equivalent to Bitcoin&#8217;s multisignature system, which is part of the core consensus rules and has proven to be robust and secure.</p>
</div>
</div>
<div class="sect2 data-line-793">
<h3 id="_conclusions_3">Conclusions</h3>
<div class="paragraph data-line-15">
<p>Transactions are the starting point of every activity in the Ethereum system. Transactions are the "inputs" that cause the Ethereum Virtual Machine to evaluate contracts, update balances, and more generally modify the state of the Ethereum blockchain. Next, we will work with smart contracts in a lot more detail and learn how to program in the Solidity contract-oriented language.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="smart_contracts_chapter">Contrats intelligents et Solidity</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>As we discussed in <a href="#intro_chapter">Les bases d&#39;Ethereum</a>, there are two different types of accounts in Ethereum: externally owned accounts (EOAs) and contract accounts. EOAs are controlled by users, often via software such as a wallet application that is external to the Ethereum platform. In contrast, contract accounts are controlled by program code (also commonly referred to as &#x201c;smart contracts&#x201d;) that is executed by the Ethereum Virtual Machine. In short, EOAs are simple accounts without any associated code or data storage, whereas contract accounts have both associated code and data storage. EOAs are controlled by transactions created and cryptographically signed with a private key in the "real world" external to and independent of the protocol, whereas contract accounts do not have private keys and so "control themselves" in the predetermined way prescribed by their smart contract code. Both types of accounts are identified by an Ethereum address. In this chapter, we will discuss contract accounts and the program code that controls them.</p>
</div>
<div class="sect2 data-line-7">
<h3 id="smart_contracts_definition">What Is a Smart Contract?</h3>
<div class="paragraph data-line-9">
<p>The term <em>smart contract</em> has been used over the years to describe a wide variety of different things. In the 1990s, cryptographer Nick Szabo coined the term and defined it as “a set of promises, specified in digital form, including protocols within which the parties perform on the other promises.” Since then, the concept of smart contracts has evolved, especially after the introduction of decentralized blockchain platforms with the invention of Bitcoin in 2009. In the context of Ethereum, the term is actually a bit of a misnomer, given that Ethereum smart contracts are neither smart nor legal contracts, but the term has stuck. In this book, we use the term “smart contracts” to refer to immutable computer programs that run deterministically in the context of an Ethereum Virtual Machine as part of the Ethereum network protocol&#x2014;i.e., on the decentralized Ethereum world computer.</p>
</div>
<div class="paragraph data-line-11">
<p>Let’s unpack that definition:</p>
</div>
<div class="dlist data-line-13">
<dl>
<dt class="hdlist1">Computer programs</dt>
<dd>
<p>Smart contracts are simply computer programs. The word &#x201c;contract&#x201d; has no legal meaning in this context.</p>
</dd>
<dt class="hdlist1">Immutable</dt>
<dd>
<p>Once deployed, the code of a smart contract cannot change. Unlike with traditional software, the only way to modify a smart contract is to deploy a new instance.</p>
</dd>
<dt class="hdlist1">Deterministic</dt>
<dd>
<p>The outcome of the execution of a smart contract is the same for everyone who runs it, given the context of the transaction that initiated its execution and the state of the Ethereum blockchain at the moment of execution.</p>
</dd>
<dt class="hdlist1">EVM context</dt>
<dd>
<p>Smart contracts operate with a very limited execution context. They can access their own state, the context of the transaction that called them, and some information about the most recent blocks.</p>
</dd>
<dt class="hdlist1">Decentralized world computer</dt>
<dd>
<p>The EVM runs as a local instance on every Ethereum node, but because all instances of the EVM operate on the same initial state and produce the same final state, the system as a whole operates as a single "world computer."</p>
</dd>
</dl>
</div>
</div>
<div class="sect2 data-line-29">
<h3 id="smart_contract_lifecycle">Life Cycle of a Smart Contract</h3>
<div class="paragraph data-line-31">
<p>Smart contracts are typically written in a high-level language, such as Solidity. But in order to run, they must be compiled to the low-level bytecode that runs in the EVM. Once compiled, they are deployed on the Ethereum platform using a special <em>contract creation</em> transaction, which is identified as such by being sent to the special contract creation address, namely 0x0 (see <a href="#contract_reg">Special Transaction: Contract Creation</a>). Each contract is identified by an Ethereum address, which is derived from the contract creation transaction as a function of the originating account and nonce. The Ethereum address of a contract can be used in a transaction as the recipient, sending funds to the contract or calling one of the contract’s functions. Note that, unlike with EOAs, there are no keys associated with an account created for a new smart contract. As the contract creator, you don&#8217;t get any special privileges at the protocol level (although you can explicitly code them into the smart contract). You certainly don&#8217;t receive the private key for the contract account, which in fact does not exist&#x2014;we can say that smart contract accounts own themselves.</p>
</div>
<div class="paragraph data-line-33">
<p>Importantly, contracts <em>only run if they are called by a transaction</em>. All smart contracts in Ethereum are executed, ultimately, because of a transaction initiated from an EOA. A contract can call another contract that can call another contract, and so on, but the first contract in such a chain of execution will always have been called by a transaction from an EOA. Contracts never run “on their own” or “in the background.” Contracts effectively lie dormant until a transaction triggers execution, either directly or indirectly as part of a chain of contract calls. It is also worth noting that smart contracts are not executed "in parallel" in any sense&#x2014;the Ethereum world computer can be considered to be a single-threaded machine.</p>
</div>
<div class="paragraph data-line-35">
<p>Transactions are <em>atomic</em>, regardless of how many contracts they call or what those contracts do when called. Transactions execute in their entirety, with any changes in the global state (contracts, accounts, etc.) recorded only if all execution terminates successfully. Successful termination means that the program executed without an error and reached the end of execution. If execution fails due to an error, all of its effects (changes in state) are “rolled back” as if the transaction never ran. A failed transaction is still recorded as having been attempted, and the ether spent on gas for the execution is deducted from the originating account, but it otherwise has no other effects on contract or account state.</p>
</div>
<div class="paragraph data-line-37">
<p>As mentioned previously, it is important to remember that a contract’s code cannot be changed. However, a contract can be “deleted,” removing the code and its internal state (storage) from its address, leaving a blank account. Any transactions sent to that account address after the contract has been deleted do not result in any code execution, because there is no longer any code there to execute. To delete a contract, you execute an EVM opcode called SELFDESTRUCT (previously called SUICIDE). That operation costs “negative gas,” a gas refund, thereby incentivizing the release of network client resources from the deletion of stored state. Deleting a contract in this way does not remove the transaction history (past) of the contract, since the blockchain itself is immutable. It is also important to note that the SELFDESTRUCT capability will only be available if the contract author programmed the smart contract to have that functionality. If the contract&#8217;s code does not have a SELFDESTRUCT opcode, or it is inaccessible, the smart contract cannot be deleted.</p>
</div>
</div>
<div class="sect2 data-line-40">
<h3 id="high_level_languages">Introduction to Ethereum High-Level Languages</h3>
<div class="paragraph data-line-42">
<p>The EVM is a virtual machine that runs a special form of code called <em>EVM bytecode</em>, analogous to your computer&#8217;s CPU, which runs machine code such as x86_64. We will examine the operation and language of the EVM in much more detail in <a href="#evm_chapter">La machine virtuelle Ethereum</a>. In this section we will look at how smart contracts are written to run on the EVM.</p>
</div>
<div class="paragraph data-line-44">
<p>While it is possible to program smart contracts directly in bytecode, EVM bytecode is rather unwieldy and very difficult for programmers to read and understand. Instead, most Ethereum developers use a high-level language to write programs, and a compiler to convert them into bytecode.</p>
</div>
<div class="paragraph data-line-46">
<p>While any high-level language could be adapted to write smart contracts, adapting an arbitrary language to be compilable to EVM bytecode is quite a cumbersome exercise and would in general lead to some amount of confusion. Smart contracts operate in a highly constrained and minimalistic execution environment (the EVM). In addition, a special set of EVM-specific system variables and functions needs to be available. As such, it is easier to build a smart contract language from scratch than it is to make a general-purpose language suitable for writing smart contracts. As a result, a number of special-purpose languages have emerged for programming smart contracts. Ethereum has several such languages, together with the compilers needed to produce EVM-executable bytecode.</p>
</div>
<div class="paragraph data-line-48">
<p>In general, programming languages can be classified into two broad programming paradigms: <em>declarative</em> and <em>imperative</em>, also known as <em>functional</em> and <em>procedural</em>, respectively. In declarative programming, we write functions that express the <em>logic</em> of a program, but not its <em>flow</em>. Declarative programming is used to create programs where there are no <em>side effects</em>, meaning that there are no changes to state outside of a function. Declarative programming languages include Haskell and SQL. Imperative programming, by contrast, is where a programmer writes a set of procedures that combine the logic and flow of a program. Imperative programming languages include C++ and Java. Some languages are “hybrid,” meaning that they encourage declarative programming but can also be used to express an imperative programming paradigm. Such hybrids include Lisp, JavaScript, and Python. In general, any imperative language can be used to write in a declarative paradigm, but it often results in inelegant code. By comparison, pure declarative languages cannot be used to write in an imperative paradigm. In purely declarative languages, <em>there are no “variables.”</em></p>
</div>
<div class="paragraph data-line-50">
<p>While imperative programming is more commonly used by programmers, it can be very difficult to write programs that execute <em>exactly as expected</em>. The ability of any part of the program to change the state of any other makes it difficult to reason about a program’s execution and introduces many opportunities for bugs. Declarative programming, by comparison, makes it easier to understand how a program will behave: since it has no side effects, any part of a program can be understood in isolation.</p>
</div>
<div class="paragraph data-line-52">
<p>In smart contracts, bugs literally cost money. As a result, it is critically important to write smart contracts without unintended effects. To do that, you must be able to clearly reason about the expected behavior of the program. So, declarative languages play a much bigger role in smart contracts than they do in general-purpose software. Nevertheless, as you will see, the most widely used language for smart contracts (Solidity) is imperative. Programmers, like most humans, resist change!</p>
</div>
<div class="paragraph data-line-54">
<p>Currently supported high-level programming languages for smart contracts include (ordered by approximate age):</p>
</div>
<div class="dlist data-line-56">
<dl>
<dt class="hdlist1">LLL</dt>
<dd>
<p>A functional (declarative) programming language, with Lisp-like syntax. It was the first high-level language for Ethereum smart contracts but is rarely used today.</p>
</dd>
<dt class="hdlist1">Serpent</dt>
<dd>
<p>A procedural (imperative) programming language with a syntax similar to Python. Can also be used to write functional (declarative) code, though it is not entirely free of side effects.</p>
</dd>
<dt class="hdlist1">Solidity</dt>
<dd>
<p>A procedural (imperative) programming language with a syntax similar to JavaScript, C++, or Java. The most popular and frequently used language for Ethereum smart contracts.</p>
</dd>
<dt class="hdlist1">Vyper</dt>
<dd>
<p>A more recently developed language, similar to Serpent and again with Python-like syntax. Intended to get closer to a pure-functional Python-like language than Serpent, but not to replace Serpent.</p>
</dd>
<dt class="hdlist1">Bamboo</dt>
<dd>
<p>A newly developed language, influenced by Erlang, with explicit state transitions and without iterative flows (loops). Intended to reduce side effects and increase auditability. Very new and yet to be widely adopted.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-66">
<p>As you can see, there are many languages to choose from. However, of all of these Solidity is by far the most popular, to the point of being the <em>de facto</em> high-level language of Ethereum and even other EVM-like blockchains. We will spend most of our time using Solidity, but will also explore some of the examples in other high-level languages to gain an understanding of their different philosophies.</p>
</div>
</div>
<div class="sect2 data-line-69">
<h3 id="building_a_smart_contract_sec">Building a Smart Contract with Solidity</h3>
<div class="paragraph data-line-71">
<p>Solidity was created by Dr. Gavin Wood (coauthor of this book) as a language explicitly for writing smart contracts with features to directly support execution in the decentralized environment of the Ethereum world computer. The resulting attributes are quite general, and so it has ended up being used for coding smart contracts on several other blockchain platforms. It was developed by Christian Reitiwessner and then also by Alex Beregszaszi, Liana Husikyan, Yoichi Hirai, and several former Ethereum core contributors. Solidity is now developed and maintained as an independent project <a href="https://github.com/ethereum/solidity" data-href="https://github.com/ethereum/solidity">on GitHub</a>.</p>
</div>
<div class="paragraph data-line-73">
<p>The main "product" of the Solidity project is the Solidity compiler, solc, which converts programs written in the Solidity language to EVM bytecode. The project also manages the important application binary interface (ABI) standard for Ethereum smart contracts, which we will explore in detail in this chapter. Each version of the Solidity compiler corresponds to and compiles a specific version of the Solidity <span class="keep-together">language</span>.</p>
</div>
<div class="paragraph data-line-75">
<p>To get started, we will download a binary executable of the Solidity compiler. Then we will develop and compile a simple contract, following on from the example we started with in <a href="#intro_chapter">Les bases d&#39;Ethereum</a>.</p>
</div>
<div class="sect3 data-line-77">
<h4 id="_selecting_a_version_of_solidity">Selecting a Version of Solidity</h4>
<div class="paragraph data-line-79">
<p>Solidity follows a versioning model called <a href="https://semver.org/" data-href="https://semver.org/"><em>semantic versioning</em></a>, which specifies version numbers structured as three numbers separated by dots: <em>MAJOR.MINOR.PATCH</em>. The "major" number is incremented for major and <em>backward-incompatible</em> changes, the "minor" number is incremented as backward-compatible features are added in between major releases, and the "patch" number is incremented for backward-compatible bug fixes.</p>
</div>
<div class="paragraph data-line-81">
<p>At the time of writing, Solidity is at version 0.4.24.  The rules for major version 0, which is for initial development of a project, are different: anything may change at any time. In practice, Solidity treats the "minor" number as if it were the major version and the "patch" number as if it were the minor version. Therefore, in 0.4.24, 4 is considered to be the major version and 24 the minor version.</p>
</div>
<div class="paragraph data-line-83">
<p>The 0.5 major version release of Solidity is anticipated imminently.</p>
</div>
<div class="paragraph data-line-85">
<p>As you saw in <a href="#intro_chapter">Les bases d&#39;Ethereum</a>, your Solidity programs can contain a pragma directive that specifies the minimum and maximum versions of Solidity that it is compatible with, and can be used to compile your contract.</p>
</div>
<div class="paragraph data-line-87">
<p>Since Solidity is rapidly evolving, it is often better to install the latest release.</p>
</div>
</div>
<div class="sect3 data-line-89">
<h4 id="_download_and_install">Download and Install</h4>
<div class="paragraph data-line-91">
<p>There are a number of methods you can use to download and install Solidity, either as a binary release or by compiling from source code. You can find detailed instructions in <a href="http://bit.ly/2RrZmup" data-href="http://bit.ly/2RrZmup">the Solidity documentation</a>.</p>
</div>
<div class="paragraph data-line-93">
<p>Here&#8217;s how to install the latest binary release of Solidity on an Ubuntu/Debian operating system, using the apt package manager:</p>
</div>
<pre data-type="programlisting">
$ <strong>sudo add-apt-repository ppa:ethereum/ethereum</strong>
$ <strong>sudo apt update</strong>
$ <strong>sudo apt install solc</strong>
</pre>
<div class="paragraph data-line-103">
<p>Once you have solc installed, check the version by running:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc --version</strong>
solc, the solidity compiler commandline interface
Version: 0.4.24+commit.e67f0147.Linux.g++
</pre>
<div class="paragraph data-line-113">
<p>There are a number of other ways to install Solidity, depending on your operating system and requirements, including compiling from the source code directly. For more information see <a href="https://github.com/ethereum/solidity" class="undefined" data-href="https://github.com/ethereum/solidity">https://github.com/ethereum/solidity</a>.</p>
</div>
</div>
<div class="sect3 data-line-117">
<h4 id="_development_environment">Development Environment</h4>
<div class="paragraph data-line-119">
<p>To develop in Solidity, you can use any text editor and solc on the command line. However, you might find that some text editors designed for development, such as Emacs, Vim, and Atom, offer additional features such as syntax highlighting and macros that make Solidity development easier.</p>
</div>
<div class="paragraph data-line-121">
<p>There are also web-based development environments, such as <a href="https://remix.ethereum.org/" data-href="https://remix.ethereum.org/">Remix IDE</a> and <a href="https://ethfiddle.com/" data-href="https://ethfiddle.com/">EthFiddle</a>.</p>
</div>
<div class="paragraph data-line-123">
<p>Use the tools that make you productive. In the end, Solidity programs are just plain text files. While fancy editors and development environments can make things easier, you don&#8217;t need anything more than a simple text editor, such as nano (Linux/Unix), TextEdit (macOS), or even NotePad (Windows). Simply save your program source code with a <em>.sol</em> extension and it will be recognized by the Solidity compiler as a Solidity program.</p>
</div>
</div>
<div class="sect3 data-line-125">
<h4 id="_writing_a_simple_solidity_program">Writing a Simple Solidity Program</h4>
<div class="paragraph data-line-127">
<p>In <a href="#intro_chapter">Les bases d&#39;Ethereum</a>, we wrote our first Solidity program.  When we first built the Faucet contract, we used the Remix IDE to compile and deploy the contract. In this section, we will revisit, improve, and embellish Faucet.</p>
</div>
<div class="paragraph data-line-129">
<p>Our first attempt looked like <a href="#original_sol_faucet">Faucet.sol: A Solidity contract implementing a faucet</a>.</p>
</div>
<div id="original_sol_faucet" class="exampleblock data-line-133">
<div class="title">Example 2. Faucet.sol: A Solidity contract implementing a faucet</div>
<div class="content">
<div class="listingblock data-line-135">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// SPDX-License-Identifier: CC-BY-SA-4.0

// Version of Solidity compiler this program was written for
pragma solidity 0.6.4;

// Our first contract is a faucet!
contract Faucet {
    // Accept any incoming amount
    receive() external payable {}

    // Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        // Limit withdrawal amount
        require(withdraw_amount &lt;= 100000000000000000);

        // Send the amount to the address that requested it
        msg.sender.transfer(withdraw_amount);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3 data-line-140">
<h4 id="_compiling_with_the_solidity_compiler_solc">Compiling with the Solidity Compiler (solc)</h4>
<div class="paragraph data-line-142">
<p>Now, we will use the Solidity compiler on the command line to compile our contract directly. The Solidity compiler solc offers a variety of options, which you can see by passing the --help argument.</p>
</div>
<div class="paragraph data-line-144">
<p>We use the --bin and --optimize arguments of solc to produce an optimized binary of our example contract:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc --optimize --bin Faucet.sol</strong>
======= Faucet.sol:Faucet =======
Binary:
6060604052341561000f57600080fd5b60cf8061001d6000396000f300606060405260043610603e5
763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416
632e1a7d4d81146040575b005b3415604a57600080fd5b603e60043567016345785d8a00008111156
06357600080fd5b73ffffffffffffffffffffffffffffffffffffffff331681156108fc0282604051
600060405180830381858888f19350505050151560a057600080fd5b505600a165627a7a723058203
556d79355f2da19e773a9551e95f1ca7457f2b5fbbf4eacf7748ab59d2532130029
</pre>
<div class="paragraph data-line-162">
<p>The result that solc produces is a hex-serialized binary that can be submitted to the Ethereum blockchain.</p>
</div>
</div>
</div>
<div class="sect2 data-line-165">
<h3 id="eth_contract_abi_sec">The Ethereum Contract ABI</h3>
<div class="paragraph data-line-167">
<p>In computer software, an <em>application binary interface</em> is an interface between two program modules; often, between the operating system and user programs. An ABI defines how data structures and functions are accessed in <em>machine code</em>; this is not to be confused with an API, which defines this access in high-level, often human-readable formats as <em>source code</em>. The ABI is thus the primary way of encoding and decoding data into and out of machine code.</p>
</div>
<div class="paragraph data-line-169">
<p>In Ethereum, the ABI is used to encode contract calls for the EVM and to read data out of transactions. The purpose of an ABI is to define the functions in the contract that can be invoked and describe how each function will accept arguments and return its result.</p>
</div>
<div class="paragraph data-line-171">
<p>A contract&#8217;s ABI is specified as a JSON array of function descriptions (see <a href="#solidity_functions">Functions</a>) and events (see <a href="#solidity_events">Events</a>). A function description is a JSON object with fields <code>type</code>, <code>name</code>, <code>inputs</code>, <code>outputs</code>, <code>constant</code>, and <code>payable</code>. An event description object has fields <code>type</code>, <code>name</code>, <code>inputs</code>, and <code>anonymous</code>.</p>
</div>
<div class="paragraph data-line-173">
<p>We use the solc command-line Solidity compiler to produce the ABI for our <span class="keep-together"><em>Faucet.sol</em></span> example contract:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc --abi Faucet.sol</strong>
======= Faucet.sol:Faucet =======
Contract JSON ABI
[{"constant":false,"inputs":[{"name":"withdraw_amount","type":"uint256"}], \
"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable", \
"type":"function"},{"payable":true,"stateMutability":"payable", \
"type":"fallback"}]
</pre>
<div class="paragraph data-line-187">
<p>As you can see, the compiler produces a JSON array describing the two functions that are defined by <em>Faucet.sol</em>. This JSON can be used by any application that wants to access the Faucet contract once it is deployed. Using the ABI, an application such as a wallet or DApp browser can construct transactions that call the functions in Faucet with the correct arguments and argument types. For example, a wallet would know that to call the function withdraw it would have to provide a uint256 argument named withdraw_amount. The wallet could prompt the user to provide that value, then create a transaction that encodes it and executes the withdraw function.</p>
</div>
<div class="paragraph data-line-189">
<p>All that is needed for an application to interact with a contract is an ABI and the address where the contract has been deployed.</p>
</div>
<div class="sect3 data-line-192">
<h4 id="solidity_pragma">Selecting a Solidity Compiler and Language Version</h4>
<div class="paragraph data-line-194">
<p>As we saw in the previous code, our Faucet contract compiles successfully with Solidity version 0.4.21. But what if we had used a different version of the Solidity compiler? The language is still in constant flux and things may change in unexpected ways. Our contract is fairly simple, but what if our program used a feature that was only added in Solidity version 0.4.19 and we tried to compile it with 0.4.18?</p>
</div>
<div class="paragraph data-line-196">
<p>To resolve such issues, Solidity offers a <em>compiler directive</em> known as a <em>version pragma</em> that instructs the compiler that the program expects a specific compiler (and language) version. Let’s look at an example:</p>
</div>
<div id="compiler_version" class="listingblock data-line-199">
<div class="content">
<pre>pragma solidity ^0.4.19;</pre>
</div>
</div>
<div class="paragraph data-line-203">
<p>The Solidity compiler reads the version pragma and will produce an error if the compiler version is incompatible with the version pragma. In this case, our version pragma says that this program can be compiled by a Solidity compiler with a minimum version of 0.4.19. The symbol ^ states, however, that we allow compilation with any <em>minor revision</em> above 0.4.19; e.g., 0.4.20, but not 0.5.0 (which is a major revision, not a minor revision). Pragma directives are not compiled into EVM bytecode. They are only used by the compiler to check compatibility.</p>
</div>
<div class="paragraph data-line-205">
<p>Let’s add a pragma directive to our Faucet contract. We will name the new file <span class="keep-together"><em>Faucet2.sol</em></span>, to keep track of our changes as we proceed through these examples starting in <a href="#add_pragma_to_faucet">Faucet2.sol: Adding the version pragma to Faucet</a>.</p>
</div>
<div id="add_pragma_to_faucet" class="exampleblock data-line-209">
<div class="title">Example 3. Faucet2.sol: Adding the version pragma to Faucet</div>
<div class="content">
<div class="listingblock data-line-211">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// SPDX-License-Identifier: CC-BY-SA-4.0

// Version of Solidity compiler this program was written for
pragma solidity ^0.6.4;

// Our first contract is a faucet!
contract Faucet {
    // Accept any incoming amount
    receive() external payable {}

    // Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        // Limit withdrawal amount
        require(withdraw_amount &lt;= 100000000000000000);

        // Send the amount to the address that requested it
        msg.sender.transfer(withdraw_amount);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-216">
<p>Adding a version pragma is a best practice, as it avoids problems with mismatched compiler and language versions. We will explore other best practices and continue to improve the Faucet contract throughout this chapter.</p>
</div>
</div>
</div>
<div class="sect2 data-line-218">
<h3 id="_programming_with_solidity">Programming with Solidity</h3>
<div class="paragraph data-line-220">
<p>In this section, we will look at some of the capabilities of the Solidity language. As we mentioned in <a href="#intro_chapter">Les bases d&#39;Ethereum</a>, our first contract example was very simple and also flawed in various ways. We&#8217;ll gradually improve it here, while exploring how to use Solidity. This won&#8217;t be a comprehensive Solidity tutorial, however, as Solidity is quite complex and rapidly evolving. We&#8217;ll cover the basics and give you enough of a foundation to be able to explore the rest on your own. The documentation for Solidity can be found
<a href="https://solidity.readthedocs.io/en/latest/" data-href="https://solidity.readthedocs.io/en/latest/">on the project website</a>.</p>
</div>
<div class="sect3 data-line-223">
<h4 id="_data_types">Data Types</h4>
<div class="paragraph data-line-225">
<p>First, let&#8217;s look at some of the basic data types offered in Solidity:</p>
</div>
<div class="dlist data-line-227">
<dl>
<dt class="hdlist1">Boolean (bool)</dt>
<dd>
<p>Boolean value, true or false, with logical operators ! (not), &amp;&amp; (and), || (or), == (equal), and != (not equal).</p>
</dd>
<dt class="hdlist1">Integer (int, uint)</dt>
<dd>
<p>Signed (int) and unsigned (uint) integers, declared in increments of 8 bits from int8 to uint256. Without a size suffix, 256-bit quantities are used, to match the word size of the EVM.</p>
</dd>
<dt class="hdlist1">Fixed point (fixed, ufixed)</dt>
<dd>
<p>Fixed-point numbers, declared with (<code>u</code>)<code>fixed<em>M</em>x<em>N</em></code> where <em>M</em> is the size in bits (increments of 8 up to 256) and <em>N</em> is the number of decimals after the point (up to 18); e.g., ufixed32x2.</p>
</dd>
<dt class="hdlist1">Address</dt>
<dd>
<p>A 20-byte Ethereum address. The address object has many helpful member functions, the main ones being balance (returns the account balance) and <span class="keep-together"><code>transfer</code></span> (transfers ether to the account).</p>
</dd>
<dt class="hdlist1">Byte array (fixed)</dt>
<dd>
<p>Fixed-size arrays of bytes, declared with bytes1 up to bytes32.</p>
</dd>
<dt class="hdlist1">Byte array (dynamic)</dt>
<dd>
<p>Variable-sized arrays of bytes, declared with bytes or string.</p>
</dd>
<dt class="hdlist1">Enum</dt>
<dd>
<p>User-defined type for enumerating discrete values: enum NAME {LABEL1, LABEL 2, ...}.</p>
</dd>
<dt class="hdlist1">Arrays</dt>
<dd>
<p>An array of any type, either fixed or dynamic: uint32[][5] is a fixed-size array of five dynamic arrays of unsigned integers.</p>
</dd>
<dt class="hdlist1">Struct</dt>
<dd>
<p>User-defined data containers for grouping variables: <code>struct NAME {TYPE1 <span class="keep-together">VARIABLE1</span>; TYPE2 VARIABLE2; ...}</code>.</p>
</dd>
<dt class="hdlist1">Mapping</dt>
<dd>
<p>Hash lookup tables for <em>key</em> =&gt; <em>value</em> pairs: mapping(KEY_TYPE =&gt; VALUE_TYPE) NAME.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-247">
<p>In addition to these data types, Solidity also offers a variety of value literals that can be used to calculate different units:</p>
</div>
<div class="dlist data-line-249">
<dl>
<dt class="hdlist1">Time units</dt>
<dd>
<p>The units seconds, minutes, hours, and days can be used as suffixes, converting to multiples of the base unit seconds.</p>
</dd>
<dt class="hdlist1">Ether units</dt>
<dd>
<p>The units wei, finney, szabo, and ether can be used as suffixes, converting to multiples of the base unit wei.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-253">
<p>In our Faucet contract example, we used a uint (which is an alias for uint256) for the withdraw_amount variable. We also indirectly used an address variable, which we set with msg.sender. We will use more of these data types in our examples in the rest of this chapter.</p>
</div>
<div class="paragraph data-line-255">
<p>Let&#8217;s use one of the unit multipliers to improve the readability of our example contract. In the withdraw function we limit the maximum withdrawal, expressing the limit in wei, the base unit of ether:</p>
</div>
<div class="listingblock data-line-257">
<div class="content">
<pre>require(withdraw_amount &lt;= 100000000000000000);</pre>
</div>
</div>
<div class="paragraph data-line-261">
<p>That&#8217;s not very easy to read. We can improve our code by using the unit multiplier ether, to express the value in ether instead of wei:</p>
</div>
<div class="listingblock data-line-263">
<div class="content">
<pre>require(withdraw_amount &lt;= 0.1 ether);</pre>
</div>
</div>
</div>
<div class="sect3 data-line-267">
<h4 id="_predefined_global_variables_and_functions">Predefined Global Variables and Functions</h4>
<div class="paragraph data-line-269">
<p>When a contract is executed in the EVM, it has access to a small set of global objects. These include the block, msg, and tx objects. In addition, Solidity exposes a number of EVM opcodes as predefined functions. In this section we will examine the variables and functions you can access from within a smart contract in Solidity.</p>
</div>
<div class="sect4 data-line-271">
<h5 id="_transactionmessage_call_context">Transaction/message call context</h5>
<div class="paragraph data-line-273">
<p>The msg object is the transaction call (EOA originated) or message call (contract originated) that launched this contract execution. It contains a number of useful attributes:</p>
</div>
<div class="dlist data-line-275">
<dl>
<dt class="hdlist1">msg.sender</dt>
<dd>
<p>We&#8217;ve already used this one. It represents the address that initiated this contract call, not necessarily the originating EOA that sent the transaction. If our contract was called directly by an EOA transaction, then this is the address that signed the transaction, but otherwise it will be a contract address.</p>
</dd>
<dt class="hdlist1">msg.value</dt>
<dd>
<p>The value of ether sent with this call (in wei).</p>
</dd>
<dt class="hdlist1">msg.gas</dt>
<dd>
<p>The amount of gas left in the gas supply of this execution environment. This was deprecated in Solidity v0.4.21 and replaced by the gasleft function.</p>
</dd>
<dt class="hdlist1">msg.data</dt>
<dd>
<p>The data payload of this call into our contract.</p>
</dd>
<dt class="hdlist1">msg.sig</dt>
<dd>
<p>The first four bytes of the data payload, which is the function selector.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note data-line-286">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-287">
<p>Whenever a contract calls another contract, the values of all the attributes of msg change to reflect the new caller&#8217;s information. The only exception to this is the delegatecall function, which runs the code of another contract/library within the original msg <span class="keep-together">context</span>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4 data-line-290">
<h5 id="_transaction_context">Transaction context</h5>
<div class="paragraph data-line-292">
<p>The tx object provides a means of accessing transaction-related information:</p>
</div>
<div class="dlist data-line-294">
<dl>
<dt class="hdlist1">tx.gasprice</dt>
<dd>
<p>The gas price in the calling transaction.</p>
</dd>
<dt class="hdlist1">tx.origin</dt>
<dd>
<p>The address of the originating EOA for this transaction. WARNING: unsafe!</p>
</dd>
</dl>
</div>
</div>
<div class="sect4 data-line-298">
<h5 id="_block_context">Block context</h5>
<div class="paragraph data-line-300">
<p>The block object contains information about the current block:</p>
</div>
<div class="dlist data-line-302">
<dl>
<dt class="hdlist1">block.blockhash(__blockNumber__)</dt>
<dd>
<p>The block hash of the specified block number, up to 256 blocks in the past. Deprecated and replaced with the blockhash function in Solidity v0.4.22.</p>
</dd>
<dt class="hdlist1">block.coinbase</dt>
<dd>
<p>The address of the recipient of the current block&#8217;s fees and block reward.</p>
</dd>
<dt class="hdlist1">block.difficulty</dt>
<dd>
<p>The difficulty (proof of work) of the current block.</p>
</dd>
<dt class="hdlist1">block.gaslimit</dt>
<dd>
<p>The maximum amount of gas that can be spent across all transactions included in the current block.</p>
</dd>
<dt class="hdlist1">block.number</dt>
<dd>
<p>The current block number (blockchain height).</p>
</dd>
<dt class="hdlist1">block.timestamp</dt>
<dd>
<p>The timestamp placed in the current block by the miner (number of seconds since the Unix epoch).</p>
</dd>
</dl>
</div>
</div>
<div class="sect4 data-line-315">
<h5 id="solidity_address_object">address object</h5>
<div class="paragraph data-line-317">
<p>Any address, either passed as an input or cast from a contract object, has a number of attributes and methods:</p>
</div>
<div class="dlist data-line-319">
<dl>
<dt class="hdlist1">address.balance</dt>
<dd>
<p>The balance of the address, in wei. For example, the current contract balance is address(this).balance.</p>
</dd>
<dt class="hdlist1">address.transfer(__amount__)</dt>
<dd>
<p>Transfers the amount (in wei) to this address, throwing an exception on any error. We used this function in our Faucet example as a method on the msg.sender address, as msg.sender.transfer.</p>
</dd>
<dt class="hdlist1">address.send(__amount__)</dt>
<dd>
<p>Similar to transfer, only instead of throwing an exception, it returns false on error. WARNING: always check the return value of send.</p>
</dd>
<dt class="hdlist1">address.call(__payload__)</dt>
<dd>
<p>Low-level CALL function&#x2014;can construct an arbitrary message call with a data payload. Returns false on error. WARNING: unsafe&#x2014;recipient can (accidentally or maliciously) use up all your gas, causing your contract to halt with an OOG exception; always check the return value of call.</p>
</dd>
<dt class="hdlist1">address.callcode(__payload__)</dt>
<dd>
<p>Low-level CALLCODE function, like address(this).call(...) but with this contract&#8217;s code replaced with that of address. Returns false on error. WARNING: advanced use only!</p>
</dd>
<dt class="hdlist1">address.delegatecall()</dt>
<dd>
<p>Low-level DELEGATECALL function, like callcode(...) but with the full msg context seen by the current contract. Returns false on error. WARNING: advanced use only!</p>
</dd>
</dl>
</div>
</div>
<div class="sect4 data-line-331">
<h5 id="_built_in_functions">Built-in functions</h5>
<div class="paragraph data-line-333">
<p>Other functions worth noting are:</p>
</div>
<div class="dlist data-line-335">
<dl>
<dt class="hdlist1">addmod, mulmod</dt>
<dd>
<p>For modulo addition and multiplication. For example, addmod(x,y,k) calculates (x + y) % k.</p>
</dd>
<dt class="hdlist1">keccak256, sha256, sha3, ripemd160</dt>
<dd>
<p>Functions to calculate hashes with various standard hash algorithms.</p>
</dd>
<dt class="hdlist1">ecrecover</dt>
<dd>
<p>Recovers the address used to sign a message from the signature.</p>
</dd>
<dt class="hdlist1">selfdestruct(__recipient_address__)</dt>
<dd>
<p>Deletes the current contract, sending any remaining ether in the account to the recipient address.</p>
</dd>
<dt class="hdlist1">this</dt>
<dd>
<p>The address of the currently executing contract account.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3 data-line-345">
<h4 id="_contract_definition">Contract Definition</h4>
<div class="paragraph data-line-347">
<p>Solidity&#8217;s principal data type is contract; our Faucet example simply defines a <span class="keep-together"><code>contract</code></span> object. Similar to any object in an object-oriented language, the contract is a container that includes data and methods.</p>
</div>
<div class="paragraph data-line-349">
<p>Solidity offers two other object types that are similar to a contract:</p>
</div>
<div class="dlist data-line-351">
<dl>
<dt class="hdlist1">interface</dt>
<dd>
<p>An interface definition is structured exactly like a contract, except none of the functions are defined, they are only declared. This type of declaration is often called a <em>stub</em>; it tells you the functions' arguments and return types without any implementation. An interface specifies the "shape" of a contract; when inherited, each of the functions declared by the interface must be defined by the child.</p>
</dd>
<dt class="hdlist1">library</dt>
<dd>
<p>A library contract is one that is meant to be deployed only once and used by other contracts, using the delegatecall method (see <a href="#solidity_address_object">address object</a>).</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-356">
<h4 id="solidity_functions">Functions</h4>
<div class="paragraph data-line-358">
<p>Within a contract, we define functions that can be called by an EOA transaction or another contract. In our Faucet example, we have two functions: withdraw and the (unnamed) <em>fallback</em> function.</p>
</div>
<div class="paragraph data-line-360">
<p>The syntax we use to declare a function in Solidity is as follows:</p>
</div>
<pre data-type="programlisting">
function FunctionName([<em>parameters</em>]) {public|private|internal|external}
[pure|constant|view|payable] [<em>modifiers</em>] [returns (<em>return types</em>)]
</pre>
<div class="paragraph data-line-370">
<p>Let&#8217;s look at each of these components:</p>
</div>
<div class="dlist data-line-372">
<dl>
<dt class="hdlist1">FunctionName</dt>
<dd>
<p>The name of the function, which is used to call the function in a transaction (from an EOA), from another contract, or even from within the same contract. One function in each contract may be defined without a name, in which case it is the <em>fallback</em> function, which is called when no other function is named. The fallback function cannot have any arguments or return anything.</p>
</dd>
<dt class="hdlist1"><em>parameters</em></dt>
<dd>
<p>Following the name, we specify the arguments that must be passed to the function, with their names and types. In our Faucet example we defined uint withdraw_amount as the only argument to the <code><span class="keep-together">withdraw</span></code> function.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-376">
<p>The next set of keywords (public, private, internal, external) specify the function&#8217;s <em>visibility</em>:</p>
</div>
<div class="dlist data-line-378">
<dl>
<dt class="hdlist1">public</dt>
<dd>
<p>Public is the default; such functions can be called by other contracts or EOA transactions, or from within the contract. In our Faucet example, both functions are defined as public.</p>
</dd>
<dt class="hdlist1">external</dt>
<dd>
<p>External functions are like public functions, except they cannot be called from within the contract unless explicitly prefixed with the keyword this.</p>
</dd>
<dt class="hdlist1">internal</dt>
<dd>
<p>Internal functions are only accessible from within the contract&#x2014;they cannot be called by another contract or EOA transaction. They can be called by derived contracts (those that inherit this one).</p>
</dd>
<dt class="hdlist1">private</dt>
<dd>
<p>Private functions are like internal functions but cannot be called by derived <span class="keep-together">contracts</span>.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-386">
<p>Keep in mind that the terms <em>internal</em> and <em>private</em> are somewhat misleading. Any function or data inside a contract is always <em>visible</em> on the public blockchain, meaning that anyone can see the code or data. The keywords described here only affect how and when a function can be <em>called</em>.</p>
</div>
<div class="paragraph data-line-388">
<p>The second set of keywords (pure, constant, view, payable) affect the behavior of the function:</p>
</div>
<div class="dlist data-line-390">
<dl>
<dt class="hdlist1">constant or view</dt>
<dd>
<p>A function marked as a <em>view</em> promises not to modify any state. The term <em>constant</em> is an alias for view that will be deprecated in a future release. At this time, the compiler does not enforce the view modifier, only producing a warning, but this is expected to become an enforced keyword in v0.5 of Solidity.</p>
</dd>
<dt class="hdlist1">pure</dt>
<dd>
<p>A pure function is one that neither reads nor writes any variables in storage. It can only operate on arguments and return data, without reference to any stored data. Pure functions are intended to encourage declarative-style programming without side effects or state.</p>
</dd>
<dt class="hdlist1">payable</dt>
<dd>
<p>A payable function is one that can accept incoming payments. Functions not declared as payable will reject incoming payments. There are two exceptions, due to design decisions in the EVM: coinbase payments and SELFDESTRUCT inheritance will be paid even if the fallback function is not declared as payable, but this makes sense because code execution is not part of those payments <span class="keep-together">anyway</span>.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-396">
<p>As you can see in our Faucet example, we have one payable function (the fallback function), which is the only function that can receive incoming payments.</p>
</div>
</div>
<div class="sect3 data-line-398">
<h4 id="_contract_constructor_and_selfdestruct">Contract Constructor and selfdestruct</h4>
<div class="paragraph data-line-400">
<p>There is a special function that is only used once. When a contract is created, it also runs the <em>constructor function</em> if one exists, to initialize the state of the contract. The constructor is run in the same transaction as the contract creation. The constructor function is optional; you&#8217;ll notice our Faucet example doesn&#8217;t have one.</p>
</div>
<div class="paragraph data-line-402">
<p>Constructors can be specified in two ways. Up to and including in Solidity v0.4.21, the constructor is a function whose name matches the name of the contract, as you can see here:</p>
</div>
<div class="listingblock data-line-405">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract MEContract {
	function MEContract() {
		// This is the constructor
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-414">
<p>The difficulty with this format is that if the contract name is changed and the constructor function name is not changed, it is no longer a constructor. Likewise, if there is an accidental typo in the naming of the contract and/or constructor, the function is again no longer a constructor. This can cause some pretty nasty, unexpected, and difficult-to-find bugs. Imagine for example if the constructor is setting the owner of the contract for purposes of control. If the function is not actually the constructor because of a naming error, not only will the owner be left unset at the time of contract creation, but the function may also be deployed as a permanent and "callable" part of the contract, like a normal function, allowing any third party to hijack the contract and become the "owner" after contract creation.</p>
</div>
<div class="paragraph data-line-416">
<p>To address the potential problems with constructor functions being based on having an identical name as the contract, Solidity v0.4.22 introduces a constructor keyword that operates like a constructor function but does not have a name. Renaming the contract does not affect the constructor at all. Also, it is easier to identify which function is the constructor. It looks like this:</p>
</div>
<div class="listingblock data-line-419">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma ^0.4.22
contract MEContract {
	constructor () {
		// This is the constructor
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-428">
<p>To summarize, a contract&#8217;s life cycle starts with a creation transaction from an EOA or contract account. If there is a constructor, it is executed as part of contract creation, to initialize the state of the contract as it is being created, and is then discarded.</p>
</div>
<div class="paragraph data-line-430">
<p>The other end of the contract&#8217;s life cycle is <em>contract destruction</em>. Contracts are destroyed by a special EVM opcode called SELFDESTRUCT. It used to be called <span class="keep-together"><code>SUICIDE</code></span>, but that name was deprecated due to the negative associations of the word. In Solidity, this opcode is exposed as a high-level built-in function called selfdestruct, which takes one argument: the address to receive any ether balance remaining in the contract account. It looks like this:</p>
</div>
<div class="listingblock data-line-433">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">selfdestruct(address recipient);</code></pre>
</div>
</div>
<div class="paragraph data-line-437">
<p>Note that you must explicitly add this command to your contract if you want it to be deletable&#x2014;this is the only way a contract can be deleted, and it is not present by default. In this way, users of a contract who might rely on a contract being there forever can be certain that a contract can&#8217;t be deleted if it doesn&#8217;t contain a <span class="keep-together"><code>SELFDESTRUCT</code></span> opcode.</p>
</div>
</div>
<div class="sect3 data-line-439">
<h4 id="_adding_a_constructor_and_selfdestruct_to_our_faucet_example">Adding a Constructor and selfdestruct to Our Faucet Example</h4>
<div class="paragraph data-line-441">
<p>The Faucet example contract we introduced in <a href="#intro_chapter">Les bases d&#39;Ethereum</a> does not have any constructor or selfdestruct functions. It is an eternal contract that cannot be deleted. Let&#8217;s change that, by adding a constructor and selfdestruct function. We probably want selfdestruct to be callable <em>only</em> by the EOA that originally created the contract. By convention, this is usually stored in an address variable called owner. Our constructor sets the owner variable, and the selfdestruct function will first check that the owner called it directly.</p>
</div>
<div class="paragraph data-line-443">
<p>First, our constructor:</p>
</div>
<div class="listingblock data-line-446">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Version of Solidity compiler this program was written for
pragma solidity ^0.4.22;

// Our first contract is a faucet!
contract Faucet {

	address owner;

	// Initialize Faucet contract: set owner
	constructor() {
		owner = msg.sender;
	}

[...]</code></pre>
</div>
</div>
<div class="paragraph data-line-463">
<p>We&#8217;ve changed the pragma directive to specify v0.4.22 as the minimum version for this example, as we are using the new constructor keyword introduced in v0.4.22 of Solidity. Our contract now has an address type variable named owner. The name "owner" is not special in any way. We could call this address variable "potato" and still use it the same way. The name owner simply makes its purpose clear.</p>
</div>
<div class="paragraph data-line-465">
<p>Next, our constructor, which runs as part of the contract creation transaction, assigns the address from msg.sender to the owner variable. We used msg.sender in the <span class="keep-together"><code>withdraw</code></span> function to identify the initiator of the withdrawal request. In the constructor, however, the msg.sender is the EOA or contract address that initiated contract creation. We know this is the case <em>because</em> this is a constructor function: it only runs once, during contract creation.</p>
</div>
<div class="paragraph data-line-467">
<p>Now we can add a function to destroy the contract. We need to make sure that only the owner can run this function, so we will use a require statement to control access. Here&#8217;s how it will look:</p>
</div>
<div class="listingblock data-line-470">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Contract destructor
function destroy() public {
	require(msg.sender == owner);
	selfdestruct(owner);
}</code></pre>
</div>
</div>
<div class="paragraph data-line-478">
<p>If anyone calls this destroy function from an address other than owner, it will fail. But if the same address stored in owner by the constructor calls it, the contract will self-destruct and send any remaining balance to the owner address. Note that we did not use the unsafe tx.origin to determine whether the owner wished to destroy the contract&#x2014;using tx.origin would allow malign contracts to destroy your contract without your permission.</p>
</div>
</div>
<div class="sect3 data-line-480">
<h4 id="_function_modifiers">Function Modifiers</h4>
<div class="paragraph data-line-482">
<p>Solidity offers a special type of function called a <em>function modifier</em>. You apply modifiers to functions by adding the modifier name in the function declaration. Modifiers are most often used to create conditions that apply to many functions within a contract. We have an access control statement already, in our destroy function. Let&#8217;s create a function modifier that expresses that condition:</p>
</div>
<div class="listingblock data-line-485">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">modifier onlyOwner {
    require(msg.sender == owner);
    _;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-493">
<p>This function modifier, named onlyOwner, sets a condition on any function that it modifies, requiring that the address stored as the owner of the contract is the same as the address of the transaction&#8217;s msg.sender. This is the basic design pattern for access control, allowing only the owner of a contract to execute any function that has the onlyOwner modifier.</p>
</div>
<div class="paragraph data-line-495">
<p>You may have noticed that our function modifier has a peculiar syntactic "placeholder" in it, an underscore followed by a semicolon (&amp;#95;;). This placeholder is replaced by the code of the function that is being modified. Essentially, the modifier is "wrapped around" the modified function, placing its code in the location identified by the underscore character.</p>
</div>
<div class="paragraph data-line-497">
<p>To apply a modifier, you add its name to the function declaration. More than one modifier can be applied to a function; they are applied in the sequence they are declared, as a comma-separated list.</p>
</div>
<div class="paragraph data-line-499">
<p>Let&#8217;s rewrite our destroy function to use the onlyOwner modifier:</p>
</div>
<div class="listingblock data-line-502">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function destroy() public onlyOwner {
    selfdestruct(owner);
}</code></pre>
</div>
</div>
<div class="paragraph data-line-508">
<p>The function modifier&#8217;s name (onlyOwner) is after the keyword public and tells us that the destroy function is modified by the onlyOwner modifier. Essentially, you can read this as "Only the owner can destroy this contract." In practice, the resulting code is equivalent to "wrapping" the code from onlyOwner around destroy.</p>
</div>
<div class="paragraph data-line-510">
<p>Function modifiers are an extremely useful tool because they allow us to write preconditions for functions and apply them consistently, making the code easier to read and, as a result, easier to audit for security. They are most often used for access control, but they are quite versatile and can be used for a variety of other purposes.</p>
</div>
<div class="paragraph data-line-512">
<p>Inside a modifier, you can access all the values (variables and arguments) visible to the modified function. In this case, we can access the owner variable, which is declared within the contract. However, the inverse is not true: you cannot access any of the modifier&#8217;s variables inside the modified function.</p>
</div>
</div>
<div class="sect3 data-line-514">
<h4 id="_contract_inheritance">Contract Inheritance</h4>
<div class="paragraph data-line-516">
<p>Solidity&#8217;s contract object supports <em>inheritance</em>, which is a mechanism for extending a base contract with additional functionality. To use inheritance, specify a parent contract with the keyword is:</p>
</div>
<div class="listingblock data-line-519">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Child is Parent {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph data-line-525">
<p>With this construct, the Child contract inherits all the methods, functionality, and variables of Parent. Solidity also supports multiple inheritance, which can be specified by comma-separated contract names after the keyword is:</p>
</div>
<div class="listingblock data-line-528">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Child is Parent1, Parent2 {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph data-line-534">
<p>Contract inheritance allows us to write our contracts in such a way as to achieve modularity, extensibility, and reuse. We start with contracts that are simple and implement the most generic capabilities, then extend them by inheriting those capabilities in more specialized contracts.</p>
</div>
<div class="paragraph data-line-536">
<p>In our Faucet contract, we introduced the constructor and destructor, together with access control for an owner, assigned on construction. Those capabilities are quite generic: many contracts will have them. We can define them as generic contracts, then use inheritance to extend them to the Faucet contract.</p>
</div>
<div class="paragraph data-line-538">
<p>We start by defining a base contract owned, which has an owner variable, setting it in the contract&#8217;s constructor:</p>
</div>
<div class="listingblock data-line-541">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract owned {
	address owner;

	// Contract constructor: set owner
	constructor() {
		owner = msg.sender;
	}

	// Access control modifier
	modifier onlyOwner {
	    require(msg.sender == owner);
	    _;
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-558">
<p>Next, we define a base contract mortal, which inherits owned:</p>
</div>
<div class="listingblock data-line-561">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract mortal is owned {
	// Contract destructor
	function destroy() public onlyOwner {
		selfdestruct(owner);
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-570">
<p>As you can see, the mortal contract can use the onlyOwner function modifier, defined in owned. It indirectly also uses the owner address variable and the constructor defined in owned. Inheritance makes each contract simpler and focused on its specific functionality, allowing us to manage the details in a modular way.</p>
</div>
<div class="paragraph data-line-572">
<p>Now we can further extend the owned contract, inheriting its capabilities in Faucet:</p>
</div>
<div class="listingblock data-line-575">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Faucet is mortal {
    // Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        // Limit withdrawal amount
        require(withdraw_amount &lt;= 0.1 ether);
        // Send the amount to the address that requested it
        msg.sender.transfer(withdraw_amount);
    }
    // Accept any incoming amount
    function () external payable {}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-589">
<p>By inheriting mortal, which in turn inherits owned, the Faucet contract now has the constructor and destroy functions, and a defined owner. The functionality is the same as when those functions were within Faucet, but now we can reuse those functions in other contracts without writing them again. Code reuse and modularity make our code cleaner, easier to read, and easier to audit.</p>
</div>
</div>
<div class="sect3 data-line-591">
<h4 id="_error_handling_assert_require_revert">Error Handling (assert, require, revert)</h4>
<div class="paragraph data-line-593">
<p>A contract call can terminate and return an error. Error handling in Solidity is handled by four functions: assert, require, revert, and throw (now deprecated).</p>
</div>
<div class="paragraph data-line-595">
<p>When a contract terminates with an error, all the state changes (changes to variables, balances, etc.) are reverted, all the way up the chain of contract calls if more than one contract was called. This ensures that transactions are <em>atomic</em>, meaning they either complete successfully or have no effect on state and are reverted entirely.</p>
</div>
<div class="paragraph data-line-597">
<p>The assert and require functions operate in the same way, evaluating a condition and stopping execution with an error if the condition is false. By convention, assert is used when the outcome is expected to be true, meaning that we use assert to test internal conditions. By comparison, require is used when testing inputs (such as function arguments or transaction fields), setting our expectations for those <span class="keep-together">conditions</span>.</p>
</div>
<div class="paragraph data-line-599">
<p>We&#8217;ve used require in our function modifier onlyOwner, to test that the message sender is the owner of the contract:</p>
</div>
<div class="listingblock data-line-602">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">require(msg.sender == owner);</code></pre>
</div>
</div>
<div class="paragraph data-line-606">
<p>The require function acts as a <em>gate condition</em>, preventing execution of the rest of the function and producing an error if it is not satisfied.</p>
</div>
<div class="paragraph data-line-608">
<p>As of Solidity v0.4.22, require can also include a helpful text message that can be used to show the reason for the error. The error message is recorded in the transaction log. So, we can improve our code by adding an error message in our require function:</p>
</div>
<div class="listingblock data-line-611">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">require(msg.sender == owner, "Only the contract owner can call this function");</code></pre>
</div>
</div>
<div class="paragraph data-line-615">
<p>The revert and throw functions halt the execution of the contract and revert any state changes. The throw function is obsolete and will be removed in future versions of Solidity; you should use revert instead. The revert function can also take an error message as the only argument, which is recorded in the transaction log.</p>
</div>
<div class="paragraph data-line-617">
<p>Certain conditions in a contract will generate errors regardless of whether we explicitly check for them. For example, in our Faucet contract, we don&#8217;t check whether there is enough ether to satisfy a withdrawal request. That&#8217;s because the transfer function will fail with an error and revert the transaction if there is insufficient balance to make the transfer:</p>
</div>
<div class="listingblock data-line-620">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">msg.sender.transfer(withdraw_amount);</code></pre>
</div>
</div>
<div class="paragraph data-line-624">
<p>However, it might be better to check explicitly and provide a clear error message on failure. We can do that by adding a require statement before the transfer:</p>
</div>
<div class="listingblock data-line-627">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">require(this.balance &gt;= withdraw_amount,
	"Insufficient balance in faucet for withdrawal request");
msg.sender.transfer(withdraw_amount);</code></pre>
</div>
</div>
<div class="paragraph data-line-633">
<p>Additional error-checking code like this will increase gas consumption slightly, but it offers better error reporting than if omitted. You will need to find the right balance between gas consumption and verbose error checking based on the expected use of your contract. In the case of a Faucet contract intended for a testnet, we&#8217;d probably err on the side of extra reporting even if it costs more gas. Perhaps for a mainnet contract we&#8217;d choose to be frugal with our gas usage instead.</p>
</div>
</div>
<div class="sect3 data-line-636">
<h4 id="solidity_events">Events</h4>
<div class="paragraph data-line-638">
<p>When a transaction completes (successfully or not), it produces a <em>transaction receipt</em>, as we will see in <a href="#evm_chapter">La machine virtuelle Ethereum</a>. The transaction receipt contains <em>log</em> entries that provide information about the actions that occurred during the execution of the transaction. <em>Events</em> are the Solidity high-level objects that are used to construct these logs.</p>
</div>
<div class="paragraph data-line-640">
<p>Events are especially useful for light clients and DApp services, which can "watch" for specific events and report them to the user interface, or make a change in the state of the application to reflect an event in an underlying contract.</p>
</div>
<div class="paragraph data-line-642">
<p>Event objects take arguments that are serialized and recorded in the transaction logs, in the blockchain. You can supply the keyword indexed before an argument, to make the value part of an indexed table (hash table) that can be searched or filtered by an application.</p>
</div>
<div class="paragraph data-line-644">
<p>We have not added any events in our Faucet example so far, so let&#8217;s do that. We will add two events, one to log any withdrawals and one to log any deposits. We will call these events Withdrawal and Deposit, respectively. First, we define the events in the Faucet contract:</p>
</div>
<div class="listingblock data-line-647">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Faucet is mortal {
	event Withdrawal(address indexed to, uint amount);
	event Deposit(address indexed from, uint amount);

	[...]
}</code></pre>
</div>
</div>
<div class="paragraph data-line-656">
<p>We&#8217;ve chosen to make the addresses indexed, to allow searching and filtering in any user interface built to access our Faucet.</p>
</div>
<div class="paragraph data-line-658">
<p>Next, we use the emit keyword to incorporate the event data in the transaction logs:</p>
</div>
<div class="listingblock data-line-661">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Give out ether to anyone who asks
function withdraw(uint withdraw_amount) public {
    [...]
    msg.sender.transfer(withdraw_amount);
    emit Withdrawal(msg.sender, withdraw_amount);
}
// Accept any incoming amount
function () external payable {
    emit Deposit(msg.sender, msg.value);
}</code></pre>
</div>
</div>
<div class="paragraph data-line-674">
<p>The resulting <em>Faucet.sol</em> contract looks like <a href="#Faucet8_sol">Faucet8.sol: Revised Faucet contract, with events</a>.</p>
</div>
<div id="Faucet8_sol" class="exampleblock data-line-678">
<div class="title">Example 4. Faucet8.sol: Revised Faucet contract, with events</div>
<div class="content">
<div class="listingblock data-line-680">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// SPDX-License-Identifier: CC-BY-SA-4.0

// Version of Solidity compiler this program was written for
pragma solidity ^0.6.4;

contract Owned {
    address payable owner;

    // Contract constructor: set owner
    constructor() public {
        owner = msg.sender;
    }

    // Access control modifier
    modifier onlyOwner {
        require(msg.sender == owner, "Only the contract owner can call this function");
        _;
    }
}

contract Mortal is Owned {
    // Contract destructor
    function destroy() public onlyOwner {
        selfdestruct(owner);
    }
}

contract Faucet is Mortal {
    event Withdrawal(address indexed to, uint amount);
    event Deposit(address indexed from, uint amount);

    // Accept any incoming amount
    receive() external payable {
        emit Deposit(msg.sender, msg.value);
    }

    // Give out ether to anyone who asks
    function withdraw(uint withdraw_amount) public {
        // Limit withdrawal amount
        require(withdraw_amount &lt;= 0.1 ether);

        require(
            address(this).balance &gt;= withdraw_amount,
            "Insufficient balance in faucet for withdrawal request"
        );

        // Send the amount to the address that requested it
        msg.sender.transfer(withdraw_amount);

        emit Withdrawal(msg.sender, withdraw_amount);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4 data-line-685">
<h5 id="_catching_events">Catching events</h5>
<div class="paragraph data-line-687">
<p>OK, so we&#8217;ve set up our contract to emit events. How do we see the results of a transaction and "catch" the events? The web3.js library provides a data structure that contains a transaction&#8217;s logs. Within those we can see the events generated by the transaction.</p>
</div>
<div class="paragraph data-line-689">
<p>Let&#8217;s use truffle to run a test transaction on the revised Faucet contract. Follow the instructions in <a href="#truffle">Truffle</a> to set up a project directory and compile the <span class="keep-together"><code>Faucet</code></span> code. The source code can be found in <a href="https://github.com/ethereumbook/ethereumbook" data-href="https://github.com/ethereumbook/ethereumbook">the book&#8217;s GitHub repository</a> under <em>code/truffle/FaucetEvents</em>.</p>
</div>
<pre data-type="programlisting">
$ <strong>truffle develop</strong>
truffle(develop)> <strong>compile</strong>
truffle(develop)> <strong>migrate</strong>
Using network 'develop'.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  ... 0xb77ceae7c3f5afb7fbe3a6c5974d352aa844f53f955ee7d707ef6f3f8e6b4e61
  Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0
Saving successful migration to network...
  ... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying Faucet...
  ... 0xfa850d754314c3fb83f43ca1fa6ee20bc9652d891c00a2f63fd43ab5bfb0d781
  Faucet: 0x345ca3e014aaf5dca488057592ee47305d9b3e10
Saving successful migration to network...
  ... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0
Saving artifacts...

truffle(develop)> <strong>Faucet.deployed().then(i => {FaucetDeployed = i})</strong>
truffle(develop)> <strong>FaucetDeployed.send(web3.utils.toWei(1, "ether")).then(res => \
                  { console.log(res.logs[0].event, res.logs[0].args) })</strong>
Deposit { from: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  amount: BigNumber { s: 1, e: 18, c: [ 10000 ] } }
truffle(develop)> <strong>FaucetDeployed.withdraw(web3.utils.toWei(0.1, "ether")).then(res => \
                  { console.log(res.logs[0].event, res.logs[0].args) })</strong>
Withdrawal { to: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  amount: BigNumber { s: 1, e: 17, c: [ 1000 ] } }
</pre>
<div class="paragraph data-line-725">
<p>After deploying the contract using the deployed function, we execute two transactions. The first transaction is a deposit (using send), which emits a Deposit event in the transaction logs:</p>
</div>
<div class="listingblock data-line-727">
<div class="content">
<pre>Deposit { from: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  amount: BigNumber { s: 1, e: 18, c: [ 10000 ] } }</pre>
</div>
</div>
<div class="paragraph data-line-732">
<p>Next, we use the withdraw function to make a withdrawal. This emits a Withdrawal event:</p>
</div>
<div class="listingblock data-line-734">
<div class="content">
<pre>Withdrawal { to: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  amount: BigNumber { s: 1, e: 17, c: [ 1000 ] } }</pre>
</div>
</div>
<div class="paragraph data-line-739">
<p>To get these events, we looked at the logs array returned as a result (res) of the transactions. The first log entry (logs[0]) contains an event name in logs[0].event and the event arguments in logs[0].args. By showing these on the console, we can see the emitted event name and the event arguments.</p>
</div>
<div class="paragraph data-line-741">
<p>Events are a very useful mechanism, not only for intra-contract communication, but also for debugging during development.</p>
</div>
</div>
</div>
<div class="sect3 data-line-743">
<h4 id="_calling_other_contracts_send_call_callcode_delegatecall">Calling Other Contracts (send, call, callcode, delegatecall)</h4>
<div class="paragraph data-line-745">
<p>Calling other contracts from within your contract is a very useful but potentially dangerous operation. We&#8217;ll examine the various ways you can achieve this and evaluate the risks of each method. In short, the risks arise from the fact that you may not know much about a contract you are calling into or that is calling into your contract. When writing smart contracts, you must keep in mind that while you may mostly expect to be dealing with EOAs, there is nothing to stop arbitrarily complex and perhaps malign contracts from calling into and being called by your code.</p>
</div>
<div class="sect4 data-line-747">
<h5 id="_creating_a_new_instance">Creating a new instance</h5>
<div class="paragraph data-line-749">
<p>The safest way to call another contract is if you create that other contract yourself. That way, you are certain of its interfaces and behavior. To do this, you can simply instantiate it, using the keyword new, as in other object-oriented languages. In Solidity, the keyword new will create the contract on the blockchain and return an object that you can use to reference it. Let&#8217;s say you want to create and call a Faucet contract from within another contract called Token:</p>
</div>
<div class="listingblock pagebreak-before data-line-753">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Token is mortal {
	Faucet _faucet;

	constructor() {
		_faucet = new Faucet();
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-763">
<p>This mechanism for contract construction ensures that you know the exact type of the contract and its interface. The contract Faucet must be defined within the scope of Token, which you can do with an import statement if the definition is in another file:</p>
</div>
<div class="listingblock data-line-766">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "Faucet.sol";

contract Token is mortal {
	Faucet _faucet;

	constructor() {
		_faucet = new Faucet();
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-778">
<p>You can optionally specify the value of ether transfer on creation, and pass arguments to the new contract&#8217;s constructor:</p>
</div>
<div class="listingblock data-line-781">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "Faucet.sol";

contract Token is mortal {
	Faucet _faucet;

	constructor() {
		_faucet = (new Faucet).value(0.5 ether)();
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-793">
<p>You can also then call the Faucet functions. In this example, we call the destroy function of Faucet from within the destroy function of Token:</p>
</div>
<div class="listingblock data-line-796">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "Faucet.sol";

contract Token is mortal {
	Faucet _faucet;

	constructor() {
		_faucet = (new Faucet).value(0.5 ether)();
	}

	function destroy() ownerOnly {
		_faucet.destroy();
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-812">
<p>Note that while you are the owner of the Token contract, the Token contract itself owns the new Faucet contract, so only the Token contract can destroy it.</p>
</div>
</div>
<div class="sect4 data-line-814">
<h5 id="_addressing_an_existing_instance">Addressing an existing instance</h5>
<div class="paragraph data-line-816">
<p>Another way you can call a contract is by casting the address of an existing instance of the contract. With this method, you apply a known interface to an existing instance. It is therefore critically important that you know, for sure, that the instance you are addressing is in fact of the type you assume. Let&#8217;s look at an example:</p>
</div>
<div class="listingblock data-line-819">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "Faucet.sol";

contract Token is mortal {

	Faucet _faucet;

	constructor(address _f) {
		_faucet = Faucet(_f);
		_faucet.withdraw(0.1 ether)
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-833">
<p>Here, we take an address provided as an argument to the constructor, _f, and we cast it to a Faucet object. This is much riskier than the previous mechanism, because we don&#8217;t know for sure whether that address actually is a Faucet object. When we call withdraw, we are assuming that it accepts the same arguments and executes the same code as our Faucet declaration, but we can&#8217;t be sure. For all we know, the withdraw function at this address could execute something completely different from what we expect, even if it is named the same. Using addresses passed as input and casting them into specific objects is therefore much more dangerous than creating the contract yourself.</p>
</div>
</div>
<div class="sect4 data-line-835">
<h5 id="_raw_call_delegatecall">Raw call, delegatecall</h5>
<div class="paragraph data-line-837">
<p>Solidity offers some even more "low-level" functions for calling other contracts. These correspond directly to EVM opcodes of the same name and allow us to construct a contract-to-contract call manually. As such, they represent the most flexible <em>and</em> the most dangerous mechanisms for calling other contracts.</p>
</div>
<div class="paragraph data-line-839">
<p>Here&#8217;s the same example, using a call method:</p>
</div>
<div class="listingblock data-line-842">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Token is mortal {
	constructor(address _faucet) {
		_faucet.call("withdraw", 0.1 ether);
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-850">
<p>As you can see, this type of call is a <em>blind</em> call into a function, very much like constructing a raw transaction, only from within a contract&#8217;s context. It can expose your contract to a number of security risks, most importantly <em>reentrancy</em>, which we will discuss in more detail in <a href="#reentrancy_security">Reentrancy</a>. The call function will return false if there is a problem, so you can evaluate the return value for error handling:</p>
</div>
<div class="listingblock data-line-853">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Token is mortal {
	constructor(address _faucet) {
		if !(_faucet.call("withdraw", 0.1 ether)) {
			revert("Withdrawal from faucet failed");
		}
	}
}</code></pre>
</div>
</div>
<div class="paragraph data-line-863">
<p>Another variant of call is delegatecall, which replaced the more dangerous callcode. The <code><span class="keep-together">callcode</span></code> method will be deprecated soon, so it should not be used.</p>
</div>
<div class="paragraph data-line-865">
<p>As mentioned in <a href="#solidity_address_object">address object</a>, a delegatecall is different from a call in that the msg context does not change. For example, whereas a call changes the value of msg.sender to be the calling contract, a delegatecall keeps the same msg.sender as in the calling contract. Essentially, delegatecall runs the code of another contract inside the context of the execution of the current contract. It is most often used to invoke code from a library. It also allows you to draw on the pattern of using library functions stored elsewhere, but have that code work with the storage data of your contract.</p>
</div>
<div class="paragraph data-line-867">
<p>The delegate call should be used with great caution. It can have some unexpected effects, especially if the contract you call was not designed as a library.</p>
</div>
<div class="paragraph data-line-869">
<p>Let&#8217;s use an example contract to demonstrate the various call semantics used by call and delegatecall for calling libraries and contracts. In <a href="#call_examples_code">CallExamples.sol: An example of different call semantics</a>, we use an event to log the details of each call and see how the calling context changes depending on the call type.</p>
</div>
<div id="call_examples_code" class="exampleblock data-line-873">
<div class="title">Example 5. CallExamples.sol: An example of different call semantics</div>
<div class="content">
<div class="listingblock data-line-875">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.22;

contract calledContract {
    event callEvent(address sender, address origin, address from);
    function calledFunction() public {
        emit callEvent(msg.sender, tx.origin, this);
    }
}

library calledLibrary {
    event callEvent(address sender, address origin,  address from);
    function calledFunction() public {
        emit callEvent(msg.sender, tx.origin, this);
    }
}

contract caller {

    function make_calls(calledContract _calledContract) public {

    // Calling calledContract and calledLibrary directly
    _calledContract.calledFunction();
    calledLibrary.calledFunction();

    // Low-level calls using the address object for calledContract
    require(address(_calledContract).
            call(bytes4(keccak256("calledFunction()"))));
    require(address(_calledContract).
            delegatecall(bytes4(keccak256("calledFunction()"))));



	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-880">
<p>As you can see in this example, our main contract is caller, which calls a library calledLibrary and a contract calledContract. Both the called library and the contract have identical calledFunction functions, which emit an event calledEvent. The event calledEvent logs three pieces of data: msg.sender, tx.origin, and this. Each time calledFunction is called it may have a different execution context (with different values for potentially all the context variables), depending on whether it is called directly or through delegatecall.</p>
</div>
<div class="paragraph data-line-882">
<p>In caller, we first call the contract and library directly, by invoking calledFunction in each. Then, we explicitly use the low-level functions call and delegatecall to call calledContract.calledFunction. This way we can see how the various calling mechanisms behave.</p>
</div>
<div class="paragraph data-line-884">
<p>Let&#8217;s run this in a Truffle development environment and capture the events, to see how it looks:</p>
</div>
<pre data-type="programlisting">
truffle(develop)> <strong>migrate</strong>
Using network 'develop'.
[...]
Saving artifacts...
truffle(develop)> <strong>web3.eth.accounts[0]</strong>
'0x627306090abab3a6e1400e9345bc60c78a8bef57'
truffle(develop)> <strong>caller.address</strong>
'0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f'
truffle(develop)> <strong>calledContract.address</strong>
'0x345ca3e014aaf5dca488057592ee47305d9b3e10'
truffle(develop)> <strong>calledLibrary.address</strong>
'0xf25186b5081ff5ce73482ad761db0eb0d25abfbf'
truffle(develop)> <strong>caller.deployed().then( i => { callerDeployed = i })</strong>

truffle(develop)> <strong>callerDeployed.make_calls(calledContract.address).then(res => \
                  { res.logs.forEach( log => { console.log(log.args) })})</strong>
{ sender: '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f',
  origin: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  from: '0x345ca3e014aaf5dca488057592ee47305d9b3e10' }
{ sender: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  origin: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  from: '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f' }
{ sender: '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f',
  origin: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  from: '0x345ca3e014aaf5dca488057592ee47305d9b3e10' }
{ sender: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  origin: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
  from: '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f' }
</pre>
<div class="paragraph data-line-919">
<p>Let&#8217;s see what happened here. We called the make_calls function and passed the address of calledContract, then caught the four events emitted by each of the different calls. Let&#8217;s look at the make_calls function and walk through each step.</p>
</div>
<div class="paragraph data-line-921">
<p>The first call is:</p>
</div>
<div class="listingblock data-line-923">
<div class="content">
<pre>_calledContract.calledFunction();</pre>
</div>
</div>
<div class="paragraph data-line-927">
<p>Here, we&#8217;re calling calledContract.calledFunction directly, using the high-level ABI for calledFunction. The event emitted is:</p>
</div>
<div class="listingblock data-line-929">
<div class="content">
<pre>sender: '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f',
origin: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
from: '0x345ca3e014aaf5dca488057592ee47305d9b3e10'</pre>
</div>
</div>
<div class="paragraph data-line-935">
<p>As you can see, msg.sender is the address of the caller contract. The tx.origin is the address of our account, web3.eth.accounts[0], that sent the transaction to caller. The event was emitted by calledContract, as we can see from the last argument in the event.</p>
</div>
<div class="paragraph data-line-937">
<p>The next call in make_calls is to the library:</p>
</div>
<div class="listingblock data-line-939">
<div class="content">
<pre>calledLibrary.calledFunction();</pre>
</div>
</div>
<div class="paragraph data-line-943">
<p>It looks identical to how we called the contract, but behaves very differently. Let&#8217;s look at the second event emitted:</p>
</div>
<div class="listingblock data-line-945">
<div class="content">
<pre>sender: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
origin: '0x627306090abab3a6e1400e9345bc60c78a8bef57',
from: '0x8f0483125fcb9aaaefa9209d8e9d7b9c8b9fb90f'</pre>
</div>
</div>
<div class="paragraph data-line-951">
<p>This time, the msg.sender is not the address of caller. Instead, it is the address of our account, and is the same as the transaction origin. That&#8217;s because when you call a library, the call is always delegatecall and runs within the context of the caller. So, when the calledLibrary code was running, it inherited the execution context of caller, as if its code was running inside caller. The variable this (shown as from in the event emitted) is the address of caller, even though it is accessed from within <span class="keep-together"><code>calledLibrary</code></span>.</p>
</div>
<div class="paragraph data-line-953">
<p>The next two calls, using the low-level call and delegatecall, verify our expectations, emitting events that mirror what we just saw.</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-956">
<h3 id="gas_sec">Gas Considerations</h3>
<div class="paragraph data-line-958">
<p>Gas, described in more detail in <a href="#gas">Gas</a>, is an incredibly important consideration in smart contract programming. Gas is a resource constraining the maximum amount of computation that Ethereum will allow a transaction to consume. If the gas limit is exceeded during computation, the following series of events occurs:</p>
</div>
<div class="ulist data-line-960">
<ul>
<li class="data-line-960">
<p>An "out of gas" exception is thrown.</p>
</li>
<li class="data-line-961">
<p>The state of the contract prior to execution is restored (reverted).</p>
</li>
<li class="data-line-962">
<p>All ether used to pay for the gas is taken as a transaction fee; it is <em>not</em> refunded.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-964">
<p>Because gas is paid by the user who initiates the transaction, users are discouraged from calling functions that have a high gas cost. It is thus in the programmer&#8217;s best interest to minimize the gas cost of a contract&#8217;s functions. To this end, there are certain practices that are recommended when constructing smart contracts, so as to minimize the gas cost of a function call.</p>
</div>
<div class="sect3 data-line-966">
<h4 id="_avoid_dynamically_sized_arrays">Avoid Dynamically Sized Arrays</h4>
<div class="paragraph data-line-968">
<p>Any loop through a dynamically sized array where a function performs operations on each element or searches for a particular element introduces the risk of using too much gas. Indeed, the contract may run out of gas before finding the desired result, or before acting on every element, thus wasting time and ether without giving any result at all.</p>
</div>
</div>
<div class="sect3 data-line-970">
<h4 id="_avoid_calls_to_other_contracts">Avoid Calls to Other Contracts</h4>
<div class="paragraph data-line-972">
<p>Calling other contracts, especially when the gas cost of their functions is not known, introduces the risk of running out of gas. Avoid using libraries that are not well tested and broadly used. The less scrutiny a library has received from other programmers, the greater the risk of using it.</p>
</div>
</div>
<div class="sect3 data-line-974">
<h4 id="_estimating_gas_cost">Estimating Gas Cost</h4>
<div class="paragraph data-line-976">
<p>If you need to estimate the gas necessary to execute a certain method of a contract considering its arguments, you could use the following procedure:</p>
</div>
<div class="listingblock data-line-979">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var contract = web3.eth.contract(abi).at(address);
var gasEstimate = contract.myAweSomeMethod.estimateGas(arg1, arg2,
    {from: account});</code></pre>
</div>
</div>
<div class="paragraph data-line-983">
<p>gasEstimate will tell you the number of gas units needed for its execution. It is an estimate because of the Turing completeness of the EVM&#x2014;it is relatively trivial to create a function that will take vastly different amounts of gas to execute different calls. Even production code can change execution paths in subtle ways, resulting in hugely different gas costs from one call to the next. However, most functions are sensible and estimateGas will give a good estimate most of the time.</p>
</div>
<div class="paragraph data-line-985">
<p>To obtain the gas price from the network you can use:</p>
</div>
<div class="listingblock data-line-988">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var gasPrice = web3.eth.getGasPrice();</code></pre>
</div>
</div>
<div class="paragraph data-line-990">
<p>And from there you can estimate the gas cost:</p>
</div>
<div class="listingblock data-line-993">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var gasCostInEther = web3.utils.fromWei((gasEstimate * gasPrice), 'ether');</code></pre>
</div>
</div>
<div class="paragraph data-line-995">
<p>Let&#8217;s apply our gas estimation functions to estimating the gas cost of our Faucet example, using the code <a href="http://bit.ly/2zf0SIO" data-href="http://bit.ly/2zf0SIO">from the book&#8217;s repository</a>.</p>
</div>
<div class="paragraph data-line-997">
<p>Start Truffle in development mode and execute the JavaScript file in <a href="#estimateGas_function">gas_estimates.js: Using the estimateGas function</a>, <em>gas_estimates.js</em>.</p>
</div>
<div id="estimateGas_function" class="exampleblock data-line-1002">
<div class="title">Example 6. gas_estimates.js: Using the estimateGas function</div>
<div class="content">
<div class="listingblock data-line-1004">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var FaucetContract = artifacts.require("./Faucet.sol");

FaucetContract.web3.eth.getGasPrice(function(error, result) {
    var gasPrice = Number(result);
    console.log("Gas Price is " + gasPrice + " wei"); // "10000000000000"

    // Get the contract instance
    FaucetContract.deployed().then(function(FaucetContractInstance) {

		// Use the keyword 'estimateGas' after the function name to get the gas
		// estimation for this particular function (aprove)
		FaucetContractInstance.send(web3.utils.toWei(1, "ether"));
        return FaucetContractInstance.withdraw.estimateGas(web3.utils.toWei(0.1, "ether"));

    }).then(function(result) {
        var gas = Number(result);

        console.log("gas estimation = " + gas + " units");
        console.log("gas cost estimation = " + (gas * gasPrice) + " wei");
        console.log("gas cost estimation = " +
                FaucetContract.web3.utils.fromWei((gas * gasPrice), 'ether') + " ether");
    });
});</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-1031">
<p>Here&#8217;s how that looks in the Truffle development console:</p>
</div>
<pre data-type="programlisting">
$ <strong>truffle develop</strong>

truffle(develop)> <strong>exec gas_estimates.js</strong>
Using network 'develop'.

Gas Price is 20000000000 wei
gas estimation = 31397 units
gas cost estimation = 627940000000000 wei
gas cost estimation = 0.00062794 ether
</pre>
<div class="paragraph data-line-1047">
<p>It is recommended that you evaluate the gas cost of functions as part of your development workflow, to avoid any surprises when deploying contracts to the mainnet.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1049">
<h3 id="_conclusions_4">Conclusions</h3>
<div class="paragraph data-line-17">
<p>In this chapter we started working with smart contracts in detail and explored the Solidity contract programming language. We took a simple example contract, <em>Faucet.sol</em>, and gradually improved it and made it more complex, using it to explore various aspects of the Solidity language. In <a href="#vyper_chap">Contrats intelligents et Vyper</a> we will work with Vyper, another contract-oriented programming language. We will compare Vyper to Solidity, showing some of the differences in the design of these two languages and deepening our understanding of smart contract programming.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="vyper_chap">Contrats intelligents et Vyper</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Vyper is an experimental, contract-oriented programming language for the Ethereum Virtual Machine that strives to provide superior auditability, by making it easier for developers to produce intelligible code. In fact, one of the principles of Vyper is to make it virtually impossible for developers to write misleading code.</p>
</div>
<div class="paragraph data-line-6">
<p>In this chapter we will look at common problems with smart contracts, introduce the Vyper contract programming language, and compare it to Solidity, demonstrating the differences.</p>
</div>
<div class="sect2 data-line-8">
<h3 id="_vulnerabilities_and_vyper">Vulnerabilities and Vyper</h3>
<div class="paragraph data-line-10">
<p><a href="https://arxiv.org/pdf/1802.06038.pdf" data-href="https://arxiv.org/pdf/1802.06038.pdf">A recent study</a> analyzed nearly one million deployed Ethereum smart contracts and found that many of these contracts contained serious vulnerabilities. During their analysis, the researchers outlined three basic categories of trace vulnerabilities:</p>
</div>
<div class="dlist data-line-12">
<dl>
<dt class="hdlist1">Suicidal contracts</dt>
<dd>
<p>Smart contracts that can be killed by arbitrary addresses</p>
</dd>
<dt class="hdlist1">Greedy contracts</dt>
<dd>
<p>Smart contracts that can reach a state in which they cannot release ether</p>
</dd>
<dt class="hdlist1">Prodigal contracts</dt>
<dd>
<p>Smart contracts that can be made to release ether to arbitrary addresses</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-18">
<p>Vulnerabilities are introduced into smart contracts via code. It may be strongly argued that these and other vulnerabilities are not intentionally introduced, but regardless, undesirable smart contract code evidently results in the unexpected loss of funds for Ethereum users, and this is not ideal. Vyper is designed to make it easier to write secure code, or equally to make it more difficult to accidentally write misleading or vulnerable code.</p>
</div>
</div>
<div class="sect2 data-line-21">
<h3 id="comparison_to_solidity_sec">Comparison to Solidity</h3>
<div class="paragraph data-line-23">
<p>One of the ways in which Vyper tries to make unsafe code harder to write is by deliberately <em>omitting</em> some of Solidity&#8217;s features. It is important for those considering developing smart contracts in Vyper to understand what features Vyper does <em>not</em> have, and why. Therefore, in this section, we will explore those features and provide justification for why they have been omitted.</p>
</div>
<div class="sect3 data-line-25">
<h4 id="_modifiers">Modifiers</h4>
<div class="paragraph data-line-27">
<p>As we saw in the previous chapter, in Solidity you can write a function using modifiers. For example, the following function, <code>changeOwner</code>, will run the code in a modifier called <code>onlyBy</code> as part of its execution:</p>
</div>
<div class="listingblock data-line-30">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function changeOwner(address _newOwner)
    public
    onlyBy(owner)
{
    owner = _newOwner;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-39">
<p>This modifier enforces a rule in relation to ownership. As you can see, this particular modifier acts as a mechanism to perform a pre-check on behalf of the <code>changeOwner</code> function:</p>
</div>
<div class="listingblock data-line-42">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">modifier onlyBy(address _account)
{
    require(msg.sender == _account);
    _;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-50">
<p>But modifiers are not just there to perform checks, as shown here. In fact, as modifiers, they can significantly change a smart contract&#8217;s environment, in the context of the calling function. Put simply, modifiers are <em>pervasive</em>.</p>
</div>
<div class="paragraph data-line-52">
<p>Let&#8217;s look at another Solidity-style example:</p>
</div>
<div class="listingblock data-line-55">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">enum Stages {
    SafeStage,
    DangerStage,
    FinalStage
}

uint public creationTime = now;
Stages public stage = Stages.SafeStage;

function nextStage() internal {
    stage = Stages(uint(stage) + 1);
}

modifier stageTimeConfirmation() {
    if (stage == Stages.SafeStage &amp;&amp;
                now &gt;= creationTime + 10 days)
        nextStage();
    _;
}

function a()
    public
    stageTimeConfirmation
    // More code goes here
{
}</code></pre>
</div>
</div>
<div class="paragraph data-line-84">
<p>On the one hand, developers should always check any other code that their own code is calling. However, it is possible that in certain situations (like when time constraints or exhaustion result in lack of concentration) a developer may overlook a single line of code. This is even more likely if the developer has to jump around inside a large file while mentally keeping track of the function call hierarchy and committing the state of smart contract variables to memory.</p>
</div>
<div class="paragraph data-line-86">
<p>Let&#8217;s look at the preceding example in a bit more depth. Imagine that a developer is writing a public function called <code>a</code>. The developer is new to this contract and is utilizing a modifier written by someone else. At a glance, it appears that the <code>stageTimeConfirmation</code> modifier is simply performing some checks regarding the age of the contract in relation to the calling function. What the developer may <em>not</em> realize is that the modifier is also calling another function, <code>nextStage</code>. In this simplistic demonstration scenario, simply calling the public function <code>a</code> results in the smart contract&#8217;s <code>stage</code> variable moving from <code>SafeStage</code> to <code>DangerStage</code>.</p>
</div>
<div class="paragraph data-line-88">
<p>Vyper has done away with modifiers altogether. The recommendations from Vyper are as follows: if only performing assertions with modifiers, then simply use inline checks and asserts as part of the function; if modifying smart contract state and so forth, again make these changes explicitly part of the function. Doing this improves auditability and readability, as the reader doesn&#8217;t have to mentally (or manually) "wrap" the modifier code around the function to see what it does.</p>
</div>
</div>
<div class="sect3 data-line-90">
<h4 id="_class_inheritance">Class Inheritance</h4>
<div class="paragraph data-line-92">
<p>Inheritance allows programmers to harness the power of prewritten code by acquiring preexisting functionality, properties, and behaviors from existing software libraries. Inheritance is powerful and promotes the reuse of code. Solidity supports multiple inheritance as well as polymorphism, but while these are key features of object-oriented programming, Vyper does not support them. Vyper maintains that the implementation of inheritance requires coders and auditors to jump between multiple files in order to understand what the program is doing. Vyper also takes the view that multiple inheritance can make code too complicated to understand&#x2014;a view tacitly admitted by the Solidity <a href="http://bit.ly/2Q6Azvo" data-href="http://bit.ly/2Q6Azvo">documentation</a>, which gives an example of how multiple inheritance can be problematic.</p>
</div>
</div>
<div class="sect3 data-line-94">
<h4 id="_inline_assembly">Inline Assembly</h4>
<div class="paragraph data-line-96">
<p>Inline assembly gives developers low-level access to the Ethereum Virtual Machine, allowing Solidity programs to perform operations by directly accessing EVM instructions. For example, the following inline assembly code adds 3 to memory location 0x80:</p>
</div>
<div class="listingblock data-line-98">
<div class="content">
<pre>3 0x80 mload add 0x80 mstore</pre>
</div>
</div>
<div class="paragraph data-line-102">
<p>Vyper considers the loss of readability to be too high a price to pay for the extra power, and thus does not support inline assembly.</p>
</div>
</div>
<div class="sect3 data-line-104">
<h4 id="_function_overloading">Function Overloading</h4>
<div class="paragraph data-line-106">
<p>Function overloading allows developers to write multiple functions of the same name. Which function is used on a given occasion depends on the types of the arguments supplied. Take the following two functions, for example:</p>
</div>
<div class="listingblock data-line-109">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">function f(uint _in) public pure returns (uint out) {
    out = 1;
}

function f(uint _in, bytes32 _key) public pure returns (uint out) {
    out = 2;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-119">
<p>The first function (named f) accepts an input argument of type uint; the second function (also named f) accepts two arguments, one of type uint and one of type bytes32. Having multiple function definitions with the same name taking different arguments can be confusing, so Vyper does not support function overloading.</p>
</div>
</div>
<div class="sect3 data-line-121">
<h4 id="_variable_typecasting">Variable Typecasting</h4>
<div class="paragraph data-line-123">
<p>There are two sorts of typecasting: <em>implicit</em> and <em>explicit</em></p>
</div>
<div class="paragraph data-line-125">
<p>Implicit typecasting is often performed at compile time. For example, if a type conversion is semantically sound and no information is likely to be lost, the compiler can perform an implicit conversion, such as converting a variable of type uint8 to uint16. The earliest versions of Vyper allowed implicit typecasting of variables, but recent versions do not.</p>
</div>
<div class="paragraph data-line-127">
<p>Explicit typecasts can be inserted in Solidity. Unfortunately, they can lead to unexpected behavior. For example, casting a uint32 to the smaller type uint16 simply removes the higher-order bits, as demonstrated here:</p>
</div>
<div class="listingblock data-line-130">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">uint32 a = 0x12345678;
uint16 b = uint16(a);
// Variable b is 0x5678 now</code></pre>
</div>
</div>
<div class="paragraph data-line-136">
<p>Vyper instead has a convert function to perform explicit casts. The convert function (found on line 82 of <a href="http://bit.ly/2P36ZKT" data-href="http://bit.ly/2P36ZKT"><em>convert.py</em></a>):</p>
</div>
<div class="listingblock data-line-139">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def convert(expr, context):
    output_type = expr.args[1].s
    if output_type in conversion_table:
        return conversion_table[output_type](expr, context)
    else:
        raise Exception("Conversion to {} is invalid.".format(output_type))</code></pre>
</div>
</div>
<div class="paragraph data-line-148">
<p>Note the use of conversion_table (found on line 90 of the same file), which looks like this:</p>
</div>
<div class="listingblock data-line-151">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">conversion_table = {
    'int128': to_int128,
    'uint256': to_unint256,
    'decimal': to_decimal,
    'bytes32': to_bytes32,
}</code></pre>
</div>
</div>
<div class="paragraph data-line-160">
<p>When a developer calls convert, it references conversion_table, which ensures that the appropriate conversion is performed. For example, if a developer passes an int128 to the convert function, the to_int128 function on line 26 of the same (<em>convert.py</em>) file will be executed. The to_int128 function is as follows:</p>
</div>
<div class="listingblock data-line-163">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">@signature(('int128', 'uint256', 'bytes32', 'bytes'), 'str_literal')
def to_int128(expr, args, kwargs, context):
    in_node = args[0]
    typ, len = get_type(in_node)
    if typ in ('int128', 'uint256', 'bytes32'):
        if in_node.typ.is_literal
            and not SizeLimits.MINNUM &lt;= in_node.value &lt;= SizeLimits.MAXNUM:
            raise InvalidLiteralException(
                "Number out of range: {}".format(in_node.value), expr
            )
        return LLLnode.from_list(
            ['clamp', ['mload', MemoryPositions.MINNUM], in_node,
            ['mload', MemoryPositions.MAXNUM]], typ=BaseType('int128'),
            pos=getpos(expr)
        )
    else:
        return byte_array_to_num(in_node, expr, 'int128')</code></pre>
</div>
</div>
<div class="paragraph data-line-183">
<p>As you can see, the conversion process ensures that no information can be lost; if it could be, an exception is raised. The conversion code prevents truncation as well as other anomalies that would ordinarily be allowed by implicit typecasting.</p>
</div>
<div class="paragraph data-line-185">
<p>Choosing explicit over implicit typecasting means that the developer is responsible for performing all casts. While this approach does produce more verbose code, it also improves the safety and auditability of smart contracts.</p>
</div>
</div>
<div class="sect3 data-line-188">
<h4 id="_preconditions_and_postconditions">Preconditions and Postconditions</h4>
<div class="paragraph data-line-190">
<p>Vyper handles preconditions, postconditions, and state changes explicitly. While this produces redundant code, it also allows for maximal readability and safety. When writing a smart contract in Vyper, a developer should observe the following three points:</p>
</div>
<div class="dlist data-line-192">
<dl>
<dt class="hdlist1">Condition</dt>
<dd>
<p>What is the current state/condition of the Ethereum state variables?</p>
</dd>
<dt class="hdlist1">Effects</dt>
<dd>
<p>What effects will this smart contract code have on the condition of the state variables upon execution? That is, what <em>will</em> be affected, and what <em>will not</em> be affected? Are these effects congruent with the smart contract&#8217;s intentions?</p>
</dd>
<dt class="hdlist1">Interaction</dt>
<dd>
<p>After the first two considerations have been exhaustively dealt with, it is time to run the code. Before deployment, logically step through the code and consider all of the possible permanent outcomes, consequences, and scenarios of executing the code, including interactions with other contracts.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-199">
<p>Ideally, each of these points should be carefully considered and then thoroughly documented in the code. Doing so will improve the design of the code, ultimately making it more readable and auditable.</p>
</div>
</div>
</div>
<div class="sect2 data-line-202">
<h3 id="decorators_sec">Decorators</h3>
<div class="paragraph data-line-203">
<p>The following decorators may be used at the start of each function:</p>
</div>
<div class="dlist data-line-205">
<dl>
<dt class="hdlist1">@private</dt>
<dd>
<p>The <code>@private</code> decorator makes the function inaccessible from outside the contract.</p>
</dd>
<dt class="hdlist1">@public</dt>
<dd>
<p>The <code>@public</code> decorator makes the function both visible and executable publicly. For example, even the Ethereum wallet will display such functions when viewing the contract.</p>
</dd>
<dt class="hdlist1">@constant</dt>
<dd>
<p>Functions with the <code>@constant</code> decorator are not allowed to change state variables. In fact, the compiler will reject the entire program (with an appropriate error) if the function tries to change a state variable.</p>
</dd>
<dt class="hdlist1">@payable</dt>
<dd>
<p>Only functions with the <code>@payable</code> decorator are allowed to transfer value.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-213">
<p>Vyper implements <a href="http://bit.ly/2P14RDq" data-href="http://bit.ly/2P14RDq">the logic of decorators</a> explicitly. For example, the Vyper compilation process will fail if a function has both a <code>@payable</code> decorator and a <code>@constant</code> decorator. This makes sense because a function that transfers value has by definition updated the state, so cannot be <code>@constant</code>. Each Vyper function must be decorated with either <code>@public</code> or <code>@private</code> (but not both!).</p>
</div>
</div>
<div class="sect2 data-line-216">
<h3 id="order_of_functions_sec">Function and Variable Ordering</h3>
<div class="paragraph data-line-218">
<p>Each individual Vyper smart contract consists of a single Vyper file only. In other words, all of a given Vyper smart contract&#8217;s code, including all functions, variables, and so forth, exists in one place. Vyper requires that each smart contract&#8217;s function and variable declarations are physically written in a particular order. Solidity does not have this requirement at all. Let&#8217;s take a quick look at a Solidity example:</p>
</div>
<div class="listingblock data-line-221">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">pragma solidity ^0.4.0;

contract ordering {

    function topFunction()
    external
    returns (bool) {
        initiatizedBelowTopFunction = this.lowerFunction();
        return initiatizedBelowTopFunction;
    }

    bool initiatizedBelowTopFunction;
    bool lowerFunctionVar;

    function lowerFunction()
    external
    returns (bool) {
        lowerFunctionVar = true;
        return lowerFunctionVar;
    }

}</code></pre>
</div>
</div>
<div class="paragraph data-line-246">
<p>In this example, the function called topFunction is calling another function, lowerFunction. topFunction is also assigning a value to a variable called initiatizedBelowTopFunction. As you can see, Solidity does not require these functions and variables to be physically declared before being called upon by the excecuting code. This is valid Solidity code that will compile successfully.</p>
</div>
<div class="paragraph data-line-248">
<p>Vyper&#8217;s ordering requirements are not a new thing; in fact, these ordering requirements have always been present in Python programming. The ordering required by Vyper is straightforward and logical, as illustrated in this next example:</p>
</div>
<div class="listingblock data-line-251">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python"># Declare a variable called theBool
theBool: public(bool)

# Declare a function called topFunction
@public
def topFunction() -&gt; bool:
    # Assign a value to the already declared function called theBool
    self.theBool = True
    return self.theBool

# Declare a function called lowerFunction
@public
def lowerFunction():
    # Call the already declared function called topFunction
    assert self.topFunction()</code></pre>
</div>
</div>
<div class="paragraph data-line-269">
<p>This shows the correct ordering of functions and variables in a Vyper smart contract. Note how the variable theBool and the function topFunction are declared before they are assigned a value and called, respectively. If theBool was declared below topFunction or if topFunction was declared below lowerFunction this contract would not compile.</p>
</div>
</div>
<div class="sect2 data-line-272">
<h3 id="online_code_editor_and_compiler_sec">Compilation</h3>
<div class="paragraph data-line-273">
<p>Vyper has its own <a href="https://vyper.online" data-href="https://vyper.online">online code editor and compiler</a>, which allows you to write and then compile your smart contracts into bytecode, ABI, and LLL using only your web browser. The Vyper online compiler has a variety of prewritten smart contracts for your convenience, including contracts for a simple open auction, safe remote purchases, ERC20 tokens, and more. This tool, offers only one version of the compilation software. It is updated regularly but does not always guarantee the latest version. Etherscan has an <a href="https://etherscan.io/vyper" data-href="https://etherscan.io/vyper">online Vyper compiler</a> which allows you to select the compiler version. Also <a href="https://remix.ethereum.org" data-href="https://remix.ethereum.org">Remix</a>, originally designed for Solidity smart contracts, now has a Vyper plugin available in the settings tab.</p>
</div>
<div class="admonitionblock note data-line-276">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-277">
<p>Vyper implements ERC20 as a precompiled contract, allowing these smart contracts to be easily used out of the box. Contracts in Vyper must be declared as global variables. An example for declaring the ERC20 variable is as follows:</p>
</div>
<div class="listingblock data-line-280">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">token: address(ERC20)</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-285">
<p>You can also compile a contract using the command line. Each Vyper contract is saved in a single file with the <em>.vy</em> extension.
Once installed, you can compile a contract with Vyper by running the following command:</p>
</div>
<div class="listingblock data-line-288">
<div class="content">
<pre>vyper ~/hello_world.vy</pre>
</div>
</div>
<div class="paragraph data-line-292">
<p>The human-readable ABI description (in JSON format) can then be obtained by running the following command:</p>
</div>
<div class="listingblock data-line-294">
<div class="content">
<pre>vyper -f json ~/hello_world.v.py</pre>
</div>
</div>
</div>
<div class="sect2 data-line-299">
<h3 id="protecting_against_overflows_sec">Protecting Against Overflow Errors at the Compiler Level</h3>
<div class="paragraph data-line-301">
<p>Overflow errors in software can be catastrophic when dealing with real value. For example, one <a href="http://bit.ly/2yHfvoF" data-href="http://bit.ly/2yHfvoF">transaction from mid-April 2018</a> shows the  <span class="keep-together">malicious transfer of over 57,896,044,618,658,100,000,000,000,000,000,000,000,000,&thinsp;</span>000,000,000,000,000,000 BEC tokens. This transaction was the result of an integer overflow issue in BeautyChain&#8217;s ERC20 token contract (<em>BecToken.sol</em>). Solidity developers do have access to libraries like <a href="http://bit.ly/2ABhb4l" data-href="http://bit.ly/2ABhb4l">SafeMath</a> as well as Ethereum smart contract security analysis tools like <a href="http://bit.ly/2CQRoGU" data-href="http://bit.ly/2CQRoGU">Mythril OSS</a>. However, developers are not forced to use the safety tools. Put simply, if safety is not enforced by the language, developers can write unsafe code that will successfully compile and later on "successfully" execute.</p>
</div>
<div class="paragraph data-line-303">
<p>Vyper has built-in overflow protection, implemented in a two-pronged approach. Firstly, Vyper provides <a href="http://bit.ly/2PuDfpB" data-href="http://bit.ly/2PuDfpB">a SafeMath equivalent</a> that includes the necessary exception cases for integer arithmetic. Secondly, Vyper uses clamps whenever a literal constant is loaded, a value is passed to a function, or a variable is assigned. Clamps are implemented via custom functions in the Low-level Lisp-like Language (LLL) compiler, and cannot be disabled. (The Vyper compiler outputs LLL rather than EVM bytecode; this simplifies the development of Vyper itself.)</p>
</div>
</div>
<div class="sect2 data-line-307">
<h3 id="reading_and_writing_data_sec">Reading and Writing Data</h3>
<div class="paragraph data-line-308">
<p>While it is costly to store, read, and modify data, these storage operations are a necessary component of most smart contracts. Smart contracts can write data to two places:</p>
</div>
<div class="dlist data-line-310">
<dl>
<dt class="hdlist1">Global state</dt>
<dd>
<p>The state variables in a given smart contract are stored in Ethereum&#8217;s global state trie; a smart contract can only store, read, and modify data in relation to that particular contract&#8217;s address (i.e., smart contracts cannot read or write to other smart contracts).</p>
</dd>
<dt class="hdlist1">Logs</dt>
<dd>
<p>A smart contract can also write to Ethereum&#8217;s chain data through log events. While Vyper initially employed the <code>__log__</code> syntax for declaring these events, an update has been made that brings its event declaration more in line with Solidity&#8217;s original syntax. For example, Vyper&#8217;s declaration of an event called <code>MyLog</code> was originally <code>MyLog: __log__({arg1: indexed(bytes[3])})</code>. The syntax has now become <code>MyLog: event({arg1: indexed(bytes[3])})</code>. It is important to note that the execution of the log event in Vyper was, and still is, as follows: <code>log.MyLog("123")</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-314">
<p>While smart contracts can write to Ethereum&#8217;s chain data (through log events), they are unable to read the on-chain log events they&#8217;ve created. Notwithstanding, one of the advantages of writing to Ethereum&#8217;s chain data via log events is that logs can be discovered and read, on the public chain, by light clients. For example, the logsBloom value in a mined block can indicate whether or not a log event is present. Once the existence of log events has been established, the log data can be obtained from a given transaction receipt.</p>
</div>
</div>
<div class="sect2 data-line-317">
<h3 id="_conclusions_5">Conclusions</h3>
<div class="paragraph data-line-19">
<p>Vyper is a powerful and interesting new contract-oriented programming language. Its design is biased toward "correctness," at the expense of some flexibility. This may allow programmers to write better smart contracts and avoid certain pitfalls that cause serious vulnerabilities to arise. Next, we will look at smart contract security in more detail. Some of the nuances of Vyper design may become more apparent once you read about all the possible security problems that can arise in smart contracts.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="smart_contract_security">Sécurité des contrats intelligents</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Security is one of the most important considerations when writing smart contracts. In the field of smart contract programming, mistakes are costly and easily exploited. In this chapter we will look at security best practices and design patterns, as well as "security antipatterns," which are practices and patterns that can introduce vulnerabilities in our smart contracts.</p>
</div>
<div class="paragraph data-line-6">
<p>As with other programs, a smart contract will execute exactly what is written, which is not always what the programmer intended. Furthermore, all smart contracts are public, and any user can interact with them simply by creating a transaction. Any vulnerability can be exploited, and losses are almost always impossible to recover. It is therefore critical to follow best practices and use well-tested design patterns.</p>
</div>
<div class="sect2 data-line-8">
<h3 id="_security_best_practices">Security Best Practices</h3>
<div class="paragraph data-line-10">
<p><em>Defensive programming</em> is a style of programming that is particularly well suited to smart contracts. It emphasizes the following, all of which are best practices:</p>
</div>
<div class="dlist data-line-12">
<dl>
<dt class="hdlist1">Minimalism/simplicity</dt>
<dd>
<p>Complexity is the enemy of security. The simpler the code, and the less it does, the lower the chances are of a bug or unforeseen effect occurring. When first engaging in smart contract programming, developers are often tempted to try to write a lot of code. Instead, you should look through your smart contract code and try to find ways to do less, with fewer lines of code, less complexity, and fewer "features." If someone tells you that their project has produced "thousands of lines of code" for their smart contracts, you should question the security of that project. Simpler is more secure.</p>
</dd>
<dt class="hdlist1">Code reuse</dt>
<dd>
<p>Try not to reinvent the wheel. If a library or contract already exists that does most of what you need, reuse it. Within your own code, follow the DRY principle: Don&#8217;t Repeat Yourself. If you see any snippet of code repeated more than once, ask yourself whether it could be written as a function or library and reused. Code that has been extensively used and tested is likely more secure than any new code you write. Beware of &#x201c;Not Invented Here&#x201d; syndrome, where you are tempted to "improve" a feature or component by building it from scratch. The security risk is often greater than the improvement value.</p>
</dd>
<dt class="hdlist1">Code quality</dt>
<dd>
<p>Smart contract code is unforgiving. Every bug can lead to monetary loss. You should not treat smart contract programming the same way as general-purpose programming. Writing DApps in Solidity is not like creating a web widget in JavaScript. Rather, you should apply rigorous engineering and software development methodologies, as you would in aerospace engineering or any similarly unforgiving discipline. Once you "launch" your code, there&#8217;s little you can do to fix any problems.</p>
</dd>
<dt class="hdlist1">Readability/auditability</dt>
<dd>
<p>Your code should be clear and easy to comprehend. The easier it is to read, the easier it is to audit. Smart contracts are public, as everyone can read the bytecode and anyone can reverse-engineer it. Therefore, it is beneficial to develop your work in public, using collaborative and open source methodologies, to draw upon the collective wisdom of the developer community and benefit from the highest common denominator of open source development. You should write code that is well documented and easy to read, following the style and naming conventions that are part of the Ethereum community.</p>
</dd>
<dt class="hdlist1">Test coverage</dt>
<dd>
<p>Test everything that you can. Smart contracts run in a public execution environment, where anyone can execute them with whatever input they want. You should never assume that input, such as function arguments, is well formed, properly bounded, or has a benign purpose. Test all arguments to make sure they are within expected ranges and properly formatted before allowing execution of your code to continue.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2 data-line-22">
<h3 id="_security_risks_and_antipatterns">Security Risks and Antipatterns</h3>
<div class="paragraph data-line-24">
<p>As a smart contract programmer, you should be familiar with the most common security risks, so as to be able to detect and avoid the programming patterns that leave your contracts exposed to these risks. In the next several sections we will look at different security risks, examples of how vulnerabilities can arise, and countermeasures or preventative solutions that can be used to address them.</p>
</div>
</div>
<div class="sect2 data-line-27">
<h3 id="reentrancy_security">Reentrancy</h3>
<div class="paragraph data-line-29">
<p>One of the features of Ethereum smart contracts is their ability to call
and utilize code from other external contracts. Contracts also typically
handle ether, and as such often send ether to various external user
addresses. These operations require the contracts to submit external calls. These
external calls can be hijacked by attackers, who can force the
contracts to execute further code (through a fallback function),
including calls back into themselves. Attacks of this kind were used in the
infamous <a href="http://bit.ly/2DamSZT" data-href="http://bit.ly/2DamSZT">DAO hack</a>.</p>
</div>
<div class="paragraph data-line-38">
<p>For further reading on reentrancy attacks, see Gus Guimareas&#8217;s <a href="http://bit.ly/2zaqSEY" data-href="http://bit.ly/2zaqSEY">blog post</a> on the subject and the <a href="http://bit.ly/2ERDMxV" data-href="http://bit.ly/2ERDMxV">Ethereum Smart Contract Best Practices</a>.</p>
</div>
<div class="sect3 notoc data-line-41">
<h4 id="_the_vulnerability">The Vulnerability</h4>
<div class="paragraph data-line-47">
<p>This type of attack can occur when a contract sends ether to an unknown address.
An attacker can carefully construct a contract at an external address
that contains malicious code in the fallback function. Thus, when a contract sends ether to this address, it will
invoke the malicious code. Typically the malicious code executes a
function on the vulnerable contract, performing operations not expected
by the developer. The term "reentrancy" comes from the fact that the
external malicious contract calls a function on the vulnerable
contract and the path of code execution &#x201c;<em>reenters</em>&#x201d; it.</p>
</div>
<div class="paragraph data-line-56">
<p>To clarify this, consider the simple vulnerable contract in <a href="#etherstore_vulnerable">EtherStore.sol</a>, which acts as
an Ethereum vault that allows depositors to withdraw only 1 ether per
week.</p>
</div>
<div id="etherstore_vulnerable" class="exampleblock data-line-62">
<div class="title">Example 7. EtherStore.sol</div>
<div class="content">
<div class="listingblock data-line-64">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract EtherStore {

    uint256 public withdrawalLimit = 1 ether;
    mapping(address =&gt; uint256) public lastWithdrawTime;
    mapping(address =&gt; uint256) public balances;

    function depositFunds() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdrawFunds (uint256 _weiToWithdraw) public {
        require(balances[msg.sender] &gt;= _weiToWithdraw);
        // limit the withdrawal
        require(_weiToWithdraw &lt;= withdrawalLimit);
        // limit the time allowed to withdraw
        require(now &gt;= lastWithdrawTime[msg.sender] + 1 weeks);
        require(msg.sender.call.value(_weiToWithdraw)());
        balances[msg.sender] -= _weiToWithdraw;
        lastWithdrawTime[msg.sender] = now;
    }
 }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-89">
<p>This contract has two public functions, <code>depositFunds</code> and
<code>withdrawFunds</code>. The <code>depositFunds</code> function simply increments the
sender&#8217;s balance. The <code>withdrawFunds</code> function allows the sender to
specify the amount of wei to withdraw. This function is intended to succeed
only if the requested amount to withdraw is less than 1 ether and a withdrawal
has not occurred in the last week.</p>
</div>
<div class="paragraph data-line-96">
<p>The vulnerability is in line 17, where the contract sends the user their
requested amount of ether. Consider an attacker who has created the contract in <a href="#etherstore_attack">Attack.sol</a>.</p>
</div>
<div id="etherstore_attack" class="exampleblock data-line-101">
<div class="title">Example 8. Attack.sol</div>
<div class="content">
<div class="listingblock data-line-103">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "EtherStore.sol";

contract Attack {
  EtherStore public etherStore;

  // intialize the etherStore variable with the contract address
  constructor(address _etherStoreAddress) {
      etherStore = EtherStore(_etherStoreAddress);
  }

  function attackEtherStore() external payable {
      // attack to the nearest ether
      require(msg.value &gt;= 1 ether);
      // send eth to the depositFunds() function
      etherStore.depositFunds.value(1 ether)();
      // start the magic
      etherStore.withdrawFunds(1 ether);
  }

  function collectEther() public {
      msg.sender.transfer(this.balance);
  }

  // fallback function - where the magic happens
  function () payable {
      if (etherStore.balance &gt; 1 ether) {
          etherStore.withdrawFunds(1 ether);
      }
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-137">
<p>How might the exploit occur? First, the attacker would create the malicious contract (let’s say at the
address <code>0x0&#8230;&#8203;123</code>) with the <code>EtherStore</code>’s contract address as the sole
constructor parameter. This would initialize and point the public
variable <code>etherStore</code> to the contract to be attacked.</p>
</div>
<div class="paragraph data-line-142">
<p>The attacker would then call the <code>attackEtherStore</code> function, with some
amount of ether greater than or equal to 1&#x2014;let&#8217;s assume <code>1 ether</code> for
the time being. In this example, we will also assume a number of other users have
deposited ether into this contract, such that its current balance is
<code>10 ether</code>. The following will then occur:</p>
</div>
<div class="olist arabic data-line-148">
<ol class="arabic">
<li class="data-line-148">
<p><em>Attack.sol</em>, line 15: The <code>depositFunds</code> function of the <code>EtherStore</code>
contract will be called with a <code>msg.value</code> of <code>1 ether</code> (and a lot of gas). The
sender (<code>msg.sender</code>) will be the malicious contract (<code>0x0&#8230;&#8203;123</code>). Thus,
       <code>balances[0x0..123] = 1 ether</code>.</p>
</li>
<li class="data-line-153">
<p><em>Attack.sol</em>, line 17: The malicious contract will then call the
<code>withdrawFunds</code> function of the <code>EtherStore</code> contract with a parameter of <code>1
ether</code>. This will pass all the requirements (lines 12–16 of the
    <code>EtherStore</code> contract) as no previous withdrawals have been made.</p>
</li>
<li class="data-line-158">
<p><em>EtherStore.sol</em>, line 17: The contract will send <code>1 ether</code> back to
the malicious <span class="keep-together">contract</span>.</p>
</li>
<li class="data-line-161">
<p><em>Attack.sol</em>, line 25: The payment to the malicious contract will
then execute the fallback function.</p>
</li>
<li class="data-line-164">
<p><em>Attack.sol</em>, line 26: The total balance of the EtherStore contract was
<code>10 ether</code> and is now <code>9 ether</code>, so this if statement passes.</p>
</li>
<li class="data-line-167">
<p><em>Attack.sol</em>, line 27: The fallback function calls the <code>EtherStore</code>
<code>withdrawFunds</code> function again and '<em>reenters</em>' the <code>EtherStore</code>
contract.</p>
</li>
<li class="data-line-171">
<p><em>EtherStore.sol</em>, line 11: In this second call to <code>withdrawFunds</code>, the
attacking contract&#8217;s balance is still <code>1 ether</code> as line 18 has not yet been executed. Thus, we
still have <code>balances[0x0..123] = 1 ether</code>. This is also the case for the
<code>lastWithdrawTime</code> variable. Again, we pass all the requirements.</p>
</li>
<li class="data-line-176">
<p><em>EtherStore.sol</em>, line 17: The attacking contract withdraws another <code>1 ether</code>.</p>
</li>
<li class="data-line-178">
<p>Steps 4&#x2013;8 repeat until it is no longer the case that <code>EtherStore.balance &gt; 1</code>, as dictated by line 26 in <em>Attack.sol</em>.</p>
</li>
<li class="data-line-180">
<p><em>Attack.sol</em>, line 26: Once there is 1 (or less) ether left in the <code>EtherStore</code> contract, this <code>if</code> statement will fail. This will then allow lines 18 and 19 of the <code>EtherStore</code> contract to be executed (for each call to the <code>withdrawFunds</code> function).</p>
</li>
<li class="data-line-182">
<p><em>EtherStore.sol</em>, lines 18 and 19: The <code>balances</code> and
<code>lastWithdrawTime</code> mappings will be set and the execution will end.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-185">
<p>The final result is that the attacker has withdrawn all but 1 ether
from the <code>EtherStore</code> contract in a single transaction.</p>
</div>
</div>
<div class="sect3 notoc data-line-189">
<h4 id="_preventative_techniques">Preventative Techniques</h4>
<div class="paragraph data-line-191">
<p>There are a number of common techniques that help avoid potential
reentrancy vulnerabilities in smart contracts. The first is to (whenever possible) use the built-in
<a href="http://bit.ly/2Ogvnng" data-href="http://bit.ly/2Ogvnng">transfer</a>
function when sending ether to external contracts. The transfer function
only sends 2300 gas with the external call, which is not enough for the destination
address/contract to call another contract (i.e., reenter the sending
contract).</p>
</div>
<div class="paragraph data-line-199">
<p>The second technique is to ensure that all logic that changes state
variables happens before ether is sent out of the contract (or any
external call). In the <code>EtherStore</code> example, lines 18 and 19 of
<em>EtherStore.sol</em> should be put before line 17. It is good practice for any code that performs external calls to unknown addresses to be the
last operation in a localized function or piece of code execution. This
is known as the
<a href="http://bit.ly/2EVo70v" data-href="http://bit.ly/2EVo70v">checks-effects-interactions
pattern</a>.</p>
</div>
<div class="paragraph data-line-208">
<p>A third technique is to introduce a mutex&#x2014;that is, to add a state
variable that locks the contract during code execution, preventing
reentrant calls.</p>
</div>
<div class="paragraph data-line-212">
<p>Applying all of these techniques (using all three is unnecessary, but we do it
for demonstrative purposes) to <em>EtherStore.sol</em>, gives the
reentrancy-free contract:</p>
</div>
<div class="listingblock data-line-217">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract EtherStore {

    // initialize the mutex
    bool reEntrancyMutex = false;
    uint256 public withdrawalLimit = 1 ether;
    mapping(address =&gt; uint256) public lastWithdrawTime;
    mapping(address =&gt; uint256) public balances;

    function depositFunds() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdrawFunds (uint256 _weiToWithdraw) public {
        require(!reEntrancyMutex);
        require(balances[msg.sender] &gt;= _weiToWithdraw);
        // limit the withdrawal
        require(_weiToWithdraw &lt;= withdrawalLimit);
        // limit the time allowed to withdraw
        require(now &gt;= lastWithdrawTime[msg.sender] + 1 weeks);
        balances[msg.sender] -= _weiToWithdraw;
        lastWithdrawTime[msg.sender] = now;
        // set the reEntrancy mutex before the external call
        reEntrancyMutex = true;
        msg.sender.transfer(_weiToWithdraw);
        // release the mutex after the external call
        reEntrancyMutex = false;
    }
 }</code></pre>
</div>
</div>
</div>
<div class="sect3 data-line-249">
<h4 id="real_world_example_the_dao">Real-World Example: The DAO</h4>
<div class="paragraph data-line-251">
<p>The DAO (Decentralized Autonomous Organization) attack was one of the major hacks that
occurred in the early development of Ethereum. At the time, the contract
held over $150 million. Reentrancy played a major role in the
attack, which ultimately led to the hard fork that created Ethereum
Classic (ETC). For a good analysis of the DAO exploit, see
<a href="http://bit.ly/2EQaLCI" class="undefined" data-href="http://bit.ly/2EQaLCI">http://bit.ly/2EQaLCI</a>. More information on Ethereum&#8217;s fork history, the DAO hack timeline, and the birth of ETC in a hard fork can be found in <a href="#ethereum_standards">Normes Ethereum</a>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-258">
<h3 id="_arithmetic_overunderflows">Arithmetic Over/Underflows</h3>
<div class="paragraph data-line-260">
<p>The Ethereum Virtual Machine specifies fixed-size data types for
integers. This means that an integer variable can represent only a certain range
of numbers. A <code>uint8</code>, for example, can only store
numbers in the range [0,255]. Trying to store <code>256</code> into a <code>uint8</code> will
result in <code>0</code>. If care is not taken, variables in Solidity can be
exploited if user input is unchecked and calculations are performed
that result in numbers that lie outside the range of the data type that
stores them.</p>
</div>
<div class="paragraph data-line-269">
<p>For further reading on arithmetic over/underflows, see <a href="https://bit.ly/2nNLuOr" data-href="https://bit.ly/2nNLuOr">&#x201c;How to Secure Your Smart Contracts&#x201d;</a>,
<a href="https://bit.ly/2MOfBPv" data-href="https://bit.ly/2MOfBPv">Ethereum Smart Contract Best Practices</a>, and
<a href="https://bit.ly/2xvbx1M" data-href="https://bit.ly/2xvbx1M">&#x201c;Ethereum, Solidity and integer overflows: programming blockchains like 1970&#x201d;</a>.</p>
</div>
<div class="sect3 notoc data-line-274">
<h4 id="_the_vulnerability_2">The Vulnerability</h4>
<div class="paragraph data-line-276">
<p>An over/underflow occurs when an operation is performed that requires a
fixed-size variable to store a number (or piece of data) that is outside
the range of the variable’s data type.</p>
</div>
<div class="paragraph data-line-280">
<p>For example, subtracting <code>1</code> from a <code>uint8</code> (unsigned integer of 8 bits; i.e., nonnegative) variable whose value is <code>0</code> will result
in the number <code>255</code>. This is an <em>underflow</em>. We have assigned a number
below the range of the <code>uint8</code>, so the result <em>wraps around</em> and gives the
largest number a <code>uint8</code> can store. Similarly, adding <code>2^8=256</code> to a
<code>uint8</code> will leave the variable unchanged, as we have wrapped around the
entire length of the <code>uint</code>. Two simple analogies of this behavior are
odometers in cars, which measure distance traveled (they reset to 000000, after
the largest number, i.e., 999999, is surpassed) and periodic mathematical functions
(adding 2π to the argument of sin leaves the value unchanged).</p>
</div>
<div class="paragraph data-line-290">
<p>Adding numbers larger than the data type’s range is called an <em>overflow</em>. For
clarity, adding <code>257</code> to a <code>uint8</code> that currently has a value of <code>0</code> will result
in the number <code>1</code>.  It is sometimes instructive to think of fixed-size variables
as being cyclic, where we start again from zero if we add numbers above the
largest possible stored number, and start counting down from the largest number if we subtract from zero. In the case of signed <code>int</code> types, which <em>can</em> represent negative numbers, we start again once we reach the largest negative value; for example, if we try to subtract <code>1</code> from a <code>int8</code> whose value is <code>-128</code>, we will get <code>127</code>.</p>
</div>
<div class="paragraph data-line-296">
<p>These kinds of numerical gotchas allow attackers to misuse code and create
unexpected logic flows. For example, consider the TimeLock contract in
<a href="#timelock_sol_security">TimeLock.sol</a>.</p>
</div>
<div id="timelock_sol_security" class="exampleblock data-line-302">
<div class="title">Example 9. TimeLock.sol</div>
<div class="content">
<div class="listingblock data-line-304">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract TimeLock {

    mapping(address =&gt; uint) public balances;
    mapping(address =&gt; uint) public lockTime;

    function deposit() external payable {
        balances[msg.sender] += msg.value;
        lockTime[msg.sender] = now + 1 weeks;
    }

    function increaseLockTime(uint _secondsToIncrease) public {
        lockTime[msg.sender] += _secondsToIncrease;
    }

    function withdraw() public {
        require(balances[msg.sender] &gt; 0);
        require(now &gt; lockTime[msg.sender]);
        balances[msg.sender] = 0;
        msg.sender.transfer(balance);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-329">
<p>This contract is designed to act like a time vault: users can
deposit ether into the contract and it will be locked there for at least
a week. The user may extend the wait time to longer than 1 week if they choose,
but once deposited, the user can be sure their ether is locked in safely
for at least a week&#x2014;or so this contract intends.</p>
</div>
<div class="paragraph data-line-335">
<p>In the event that a user is forced to hand over their private key, a contract such as
this might be handy to ensure their ether is unobtainable for a short period of time. But if
a user had locked in <code>100 ether</code> in this contract and handed their keys over to
an attacker, the attacker could use an overflow to receive the ether, regardless
of the <code>lockTime</code>.</p>
</div>
<div class="paragraph data-line-341">
<p>The attacker could determine the current <code>lockTime</code> for the address they
now hold the key for (it&#8217;s a public variable). Let’s call this
<code>userLockTime</code>. They could then call the <code>increaseLockTime</code> function and
pass as an argument the number <code>2^256 - userLockTime</code>. This number would
be added to the current <code>userLockTime</code> and cause an overflow, resetting
<code>lockTime[msg.sender]</code> to <code>0</code>. The attacker could then simply call the
<code>withdraw</code> function to obtain their reward.</p>
</div>
<div class="paragraph data-line-349">
<p>Let’s look at another example (<a href="#underflow_vulnerability_example_from_ethernaut_challenge">Underflow vulnerability example from Ethernaut challenge</a>), this one from the <a href="https://github.com/OpenZeppelin/ethernaut" data-href="https://github.com/OpenZeppelin/ethernaut">Ethernaut challenges</a>.</p>
</div>
<div class="paragraph data-line-351">
<p><strong>SPOILER ALERT:</strong> <em>If you have not yet done the Ethernaut challenges, this
gives a solution to one of the levels</em>.</p>
</div>
<div id="underflow_vulnerability_example_from_ethernaut_challenge" class="exampleblock data-line-356">
<div class="title">Example 10. Underflow vulnerability example from Ethernaut challenge</div>
<div class="content">
<div class="listingblock data-line-358">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.18;

contract Token {

  mapping(address =&gt; uint) balances;
  uint public totalSupply;

  function Token(uint _initialSupply) {
    balances[msg.sender] = totalSupply = _initialSupply;
  }

  function transfer(address _to, uint _value) public returns (bool) {
    require(balances[msg.sender] - _value &gt;= 0);
    balances[msg.sender] -= _value;
    balances[_to] += _value;
    return true;
  }

  function balanceOf(address _owner) public constant returns (uint balance) {
    return balances[_owner];
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-384">
<p>This is a simple token contract that employs a <code>transfer</code> function,
allowing participants to move their tokens around. Can you see the error
in this contract?</p>
</div>
<div class="paragraph data-line-388">
<p>The flaw comes in the <code>transfer</code> function. The require statement on
line 13 can be bypassed using an underflow. Consider a user with a zero
balance. They could call the <code>transfer</code> function with any nonzero
<code>_value</code> and pass the require statement on line 13. This is because
<code>balances[msg.sender]</code> is 0 (and a <code>uint256</code>), so subtracting any
positive amount (excluding <code>2^256</code>) will result in a positive number, as described previously. This is also true for line 14,
where the balance will be credited with a positive number. Thus, in this
example, an attacker can achieve free tokens due to an underflow vulnerability.</p>
</div>
</div>
<div class="sect3 notoc data-line-398">
<h4 id="_preventative_techniques_2">Preventative Techniques</h4>
<div class="paragraph data-line-400">
<p>The current conventional technique to guard against under/overflow
vulnerabilities is to use or build mathematical libraries that replace
the standard math operators addition, subtraction, and multiplication
(division is excluded as it does not cause over/underflows and the EVM
reverts on division by 0).</p>
</div>
<div class="paragraph data-line-406">
<p><a href="https://github.com/OpenZeppelin/openzeppelin-solidity" data-href="https://github.com/OpenZeppelin/openzeppelin-solidity">OpenZeppelin</a> has
done a great job of building and auditing secure libraries for the Ethereum community. In particular, its <a href="http://bit.ly/2ABhb4l" data-href="http://bit.ly/2ABhb4l">SafeMath library</a> can be used to avoid under/overflow vulnerabilities.</p>
</div>
<div class="paragraph data-line-409">
<p>To demonstrate how these libraries are used in Solidity, let&#8217;s correct the <code>TimeLock</code> contract using the <code>SafeMath</code> library. The overflow-free version of the contract is:</p>
</div>
<div class="listingblock data-line-412">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">library SafeMath {

  function mul(uint256 a, uint256 b) internal pure returns (uint256) {
    if (a == 0) {
      return 0;
    }
    uint256 c = a * b;
    assert(c / a == b);
    return c;
  }

  function div(uint256 a, uint256 b) internal pure returns (uint256) {
    // assert(b &gt; 0); // Solidity automatically throws when dividing by 0
    uint256 c = a / b;
    // assert(a == b * c + a % b); // This holds in all cases
    return c;
  }

  function sub(uint256 a, uint256 b) internal pure returns (uint256) {
    assert(b &lt;= a);
    return a - b;
  }

  function add(uint256 a, uint256 b) internal pure returns (uint256) {
    uint256 c = a + b;
    assert(c &gt;= a);
    return c;
  }
}

contract TimeLock {
    using SafeMath for uint; // use the library for uint type
    mapping(address =&gt; uint256) public balances;
    mapping(address =&gt; uint256) public lockTime;

    function deposit() external payable {
        balances[msg.sender] = balances[msg.sender].add(msg.value);
        lockTime[msg.sender] = now.add(1 weeks);
    }

    function increaseLockTime(uint256 _secondsToIncrease) public {
        lockTime[msg.sender] = lockTime[msg.sender].add(_secondsToIncrease);
    }

    function withdraw() public {
        require(balances[msg.sender] &gt; 0);
        require(now &gt; lockTime[msg.sender]);
        balances[msg.sender] = 0;
        msg.sender.transfer(balance);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-466">
<p>Notice that all standard math operations have been replaced by those
defined in the <code>SafeMath</code> library. The <code>TimeLock</code> contract no longer
performs any operation that is capable of under/overflow.</p>
</div>
</div>
<div class="sect3 data-line-470">
<h4 id="_real_world_examples_powhc_and_batch_transfer_overflow_cve_201810299">Real-World Examples: PoWHC and Batch Transfer Overflow (CVE-2018–10299)</h4>
<div class="paragraph data-line-472">
<p>Proof of Weak Hands Coin (PoWHC), originally devised as a joke of sorts, was a
Ponzi scheme written by an internet collective. Unfortunately it seems that the author(s) of the contract
had not seen over/underflows before, and consequently 866 ether were
liberated from its contract. Eric Banisadr gives a good overview of how the underflow occurred
(which is not too dissimilar to the Ethernaut challenge described earlier) in his <a href="https://bit.ly/2wrxIFJ" data-href="https://bit.ly/2wrxIFJ">blog post</a> on the event.</p>
</div>
<div class="paragraph data-line-478">
<p><a href="http://bit.ly/2CUf7WG" data-href="http://bit.ly/2CUf7WG">Another example</a> comes from the implementation of a <code>batchTransfer()</code> function into a group of ERC20 token contracts. The implementation contained an overflow vulnerability; you can read about the details in <a href="https://bit.ly/2HDlIs8" data-href="https://bit.ly/2HDlIs8">PeckShield&#8217;s account</a>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-480">
<h3 id="_unexpected_ether">Unexpected Ether</h3>
<div class="paragraph data-line-482">
<p>Typically, when ether is sent to a contract it must execute either the
fallback function or another function defined in the contract. There
are two exceptions to this, where ether can exist in a contract without
having executed any code. Contracts that rely on code execution for
all ether sent to them can be vulnerable to attacks where
ether is forcibly sent.</p>
</div>
<div class="paragraph data-line-489">
<p>For further reading on this, see <a href="https://bit.ly/2MR8Gp0" data-href="https://bit.ly/2MR8Gp0">&#x201c;How to Secure Your Smart Contracts&#x201d;</a> and <a href="http://bit.ly/2RjXmUWl" data-href="http://bit.ly/2RjXmUWl">&#x201c;Solidity Security Patterns - Forcing Ether to a Contract&#x201d;</a>.</p>
</div>
<div class="sect3 notoc data-line-492">
<h4 id="_the_vulnerability_3">The Vulnerability</h4>
<div class="paragraph data-line-494">
<p>A common defensive programming technique that is useful in enforcing
correct state transitions or validating operations is
<em>invariant checking</em>. This technique involves defining a set of
invariants (metrics or parameters that should not change) and checking
that they remain unchanged after a single (or many) operation(s).
This is typically good design, provided the invariants being checked are
in fact invariants. One example of an invariant is the <code>totalSupply</code> of
a fixed-issuance
<a href="http://bit.ly/2CUf7WG" data-href="http://bit.ly/2CUf7WG">ERC20 token</a>. As no function should modify this invariant, one could add a
check to the <code>transfer</code> function that ensures the <code>totalSupply</code>
remains unmodified, to guarantee the function is working as expected.</p>
</div>
<div class="paragraph data-line-506">
<p>In particular, there is one apparent invariant that it may be tempting to use
but that can in fact be manipulated by external users (regardless of the rules put
in place in the smart contract). This is the current ether stored in the
contract. Often when developers first learn Solidity they have the
misconception that a contract can only accept or obtain ether via payable
functions. This misconception can lead to contracts that have false assumptions
about the ether balance within them, which can lead to a range of
vulnerabilities. The smoking gun for this vulnerability is the (incorrect) use
of <code>this.balance</code>.</p>
</div>
<div class="paragraph data-line-516">
<p>There are two ways in which ether can (forcibly) be sent to a contract
without using a payable function or executing any code on the
contract:</p>
</div>
<div class="dlist data-line-520">
<dl>
<dt class="hdlist1">Self-destruct/suicide</dt>
<dd>
<p>Any contract is able to implement the
<a href="http://bit.ly/2RovrDf" data-href="http://bit.ly/2RovrDf"><code>selfdestruct</code>
function</a>, which removes all bytecode from the contract address and sends
all ether stored there to the parameter-specified address. If this
specified address is also a contract, no functions (including the
fallback) get called. Therefore, the <code>selfdestruct</code> function can be
used to forcibly send ether to any contract regardless of any code that
may exist in the contract, even contracts with no
payable functions. This means any attacker can create a contract with a
<code>selfdestruct</code> function, send ether to it, call <code>selfdestruct(target)</code>
and force ether to be sent to a <code>target</code> contract. Martin Swende has an
excellent <a href="http://bit.ly/2OfLukM" data-href="http://bit.ly/2OfLukM">blog post</a> describing some quirks of the self-destruct opcode (Quirk #2) along with
an account of how client nodes were checking incorrect invariants,
which could have led to a rather catastrophic crash of the Ethereum network.</p>
</dd>
<dt class="hdlist1">Pre-sent ether</dt>
<dd>
<p>Another way to get ether into a contract is to preload the contract address
with ether. Contract addresses are deterministic&#x2014;in fact, the address is
calculated from the Keccak-256 (commonly synonymous with SHA-3) hash of the
address creating the contract and the transaction nonce that creates the
contract. Specifically, it is of the form <code>address = sha3(rlp.encode([account_address,transaction_nonce]))</code>
(see Adrian Manning&#8217;s discussion of <a href="http://bit.ly/2EPj5Tq" data-href="http://bit.ly/2EPj5Tq">&#x201c;Keyless Ether&#x201d;</a> for some fun use cases of this). This
means anyone can calculate what a contract&#8217;s address will be before it is
created and send ether to that address. When the contract is
created it will have a nonzero ether balance.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-549">
<p>Let’s explore some pitfalls that can arise given this knowledge. Consider the overly simple contract in <a href="#etherGame_security">EtherGame.sol</a>.</p>
</div>
<div id="etherGame_security" class="exampleblock data-line-553">
<div class="title">Example 11. EtherGame.sol</div>
<div class="content">
<div class="listingblock data-line-555">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract EtherGame {

    uint public payoutMileStone1 = 3 ether;
    uint public mileStone1Reward = 2 ether;
    uint public payoutMileStone2 = 5 ether;
    uint public mileStone2Reward = 3 ether;
    uint public finalMileStone = 10 ether;
    uint public finalReward = 5 ether;

    mapping(address =&gt; uint) redeemableEther;
    // Users pay 0.5 ether. At specific milestones, credit their accounts.
    function play() external payable {
        require(msg.value == 0.5 ether); // each play is 0.5 ether
        uint currentBalance = this.balance + msg.value;
        // ensure no players after the game has finished
        require(currentBalance &lt;= finalMileStone);
        // if at a milestone, credit the player's account
        if (currentBalance == payoutMileStone1) {
            redeemableEther[msg.sender] += mileStone1Reward;
        }
        else if (currentBalance == payoutMileStone2) {
            redeemableEther[msg.sender] += mileStone2Reward;
        }
        else if (currentBalance == finalMileStone ) {
            redeemableEther[msg.sender] += finalReward;
        }
        return;
    }

    function claimReward() public {
        // ensure the game is complete
        require(this.balance == finalMileStone);
        // ensure there is a reward to give
        require(redeemableEther[msg.sender] &gt; 0);
        redeemableEther[msg.sender] = 0;
        msg.sender.transfer(transferValue);
    }
 }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-597">
<p>This contract represents a simple game (which would naturally involve
race conditions) where players send 0.5 ether to the contract in the hopes of being the player that reaches one of
three milestones first. Milestones are denominated in ether. The first
to reach the milestone may claim a portion of the ether when the game
has ended. The game ends when the final milestone (10 ether) is
reached; users can then claim their rewards.</p>
</div>
<div class="paragraph data-line-604">
<p>The issues with the <code>EtherGame</code> contract come from the poor use of
<code>this.balance</code> in both lines 14 (and by association 16) and 32. A
mischievous attacker could forcibly send a small amount of ether&#x2014;say, 0.1 ether&#x2014;via the <code>selfdestruct</code> function (discussed earlier) to
prevent any future players from reaching a milestone. <code>this.balance</code> will never be a multiple of 0.5 ether thanks to this 0.1 ether
contribution, because all legitimate players can only send 0.5-ether increments. This prevents all the if conditions on lines 18, 21,
and 24 from being true.</p>
</div>
<div class="paragraph data-line-611">
<p>Even worse, a vengeful attacker who missed a milestone could forcibly
send 10 ether (or an equivalent amount of ether that pushes the
contract’s balance above the <code>finalMileStone</code>), which would lock all
rewards in the contract forever. This is because the <code>claimReward</code>
function will always revert, due to the require on line 32 (i.e., because
<code>this.balance</code> is greater than <code>finalMileStone</code>).</p>
</div>
</div>
<div class="sect3 notoc data-line-619">
<h4 id="_preventative_techniques_3">Preventative Techniques</h4>
<div class="paragraph data-line-621">
<p>This sort of vulnerability typically arises from the misuse of <code>this.balance</code>.
Contract logic, when possible, should avoid being dependent on exact
values of the balance of the contract, because it can be artificially
manipulated. If applying logic based on <code>this.balance</code>, you have to
cope with unexpected balances.</p>
</div>
<div class="paragraph data-line-627">
<p>If exact values of deposited ether are required, a self-defined variable
should be used that is incremented in payable functions, to safely
track the deposited ether. This variable will not be influenced by the
forced ether sent via a <code>selfdestruct</code> call.</p>
</div>
<div class="paragraph data-line-632">
<p>With this in mind, a corrected version of the <code>EtherGame</code> contract could
look like:</p>
</div>
<div class="listingblock data-line-636">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract EtherGame {

    uint public payoutMileStone1 = 3 ether;
    uint public mileStone1Reward = 2 ether;
    uint public payoutMileStone2 = 5 ether;
    uint public mileStone2Reward = 3 ether;
    uint public finalMileStone = 10 ether;
    uint public finalReward = 5 ether;
    uint public depositedWei;

    mapping (address =&gt; uint) redeemableEther;

    function play() external payable {
        require(msg.value == 0.5 ether);
        uint currentBalance = depositedWei + msg.value;
        // ensure no players after the game has finished
        require(currentBalance &lt;= finalMileStone);
        if (currentBalance == payoutMileStone1) {
            redeemableEther[msg.sender] += mileStone1Reward;
        }
        else if (currentBalance == payoutMileStone2) {
            redeemableEther[msg.sender] += mileStone2Reward;
        }
        else if (currentBalance == finalMileStone ) {
            redeemableEther[msg.sender] += finalReward;
        }
        depositedWei += msg.value;
        return;
    }

    function claimReward() public {
        // ensure the game is complete
        require(depositedWei == finalMileStone);
        // ensure there is a reward to give
        require(redeemableEther[msg.sender] &gt; 0);
        redeemableEther[msg.sender] = 0;
        msg.sender.transfer(transferValue);
    }
 }</code></pre>
</div>
</div>
<div class="paragraph data-line-678">
<p>Here, we have created a new variable, <code>depositedWei</code>, which keeps
track of the known ether deposited, and it is this variable that we
use for our tests. Note that we no longer have any
reference to <code>this.balance</code>.</p>
</div>
</div>
<div class="sect3 data-line-683">
<h4 id="_further_examples">Further Examples</h4>
<div class="paragraph data-line-685">
<p>A few examples of exploitable contracts were given in the
<a href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/" data-href="https://github.com/Arachnid/uscc/tree/master/submissions-2017/">Underhanded
Solidity Coding Contest</a>, which also provides extended examples of a number of the
pitfalls raised in this section.</p>
</div>
</div>
</div>
<div class="sect2 data-line-690">
<h3 id="_delegatecall">DELEGATECALL</h3>
<div class="paragraph data-line-692">
<p>The <code>CALL</code> and <code>DELEGATECALL</code> opcodes are useful in allowing Ethereum
developers to modularize their code. Standard external message calls to
contracts are handled by the <code>CALL</code> opcode, whereby code is run in the
context of the external contract/function. The <code>DELEGATECALL</code> opcode is
almost identical, except that the code executed at the targeted address is
run in the context of the calling contract, and <code>msg.sender</code> and <code>msg.value</code> remain unchanged. This
feature enables the implementation of <em>libraries</em>, allowing developers to
deploy reusable code once and call it from future contracts.</p>
</div>
<div class="paragraph data-line-701">
<p>Although the differences between these two opcodes are simple and
intuitive, the use of <code>DELEGATECALL</code> can lead to unexpected code
execution.</p>
</div>
<div class="paragraph data-line-705">
<p>For further reading, see Loi.Luu&#8217;s
<a href="http://bit.ly/2AAElb8" data-href="http://bit.ly/2AAElb8">Ethereum
Stack Exchange question on this topic</a> and the
<a href="http://bit.ly/2Oi7UlH" data-href="http://bit.ly/2Oi7UlH">Solidity docs</a>.</p>
</div>
<div class="sect3 notoc data-line-711">
<h4 id="_the_vulnerability_4">The Vulnerability</h4>
<div class="paragraph data-line-713">
<p>As a result of the context-preserving nature of <code>DELEGATECALL</code>, building
vulnerability-free custom libraries is not as easy as one might think.
The code in libraries themselves can be secure and vulnerability-free;
however, when run in the context of another application new
vulnerabilities can arise. Let’s see a fairly complex example of this,
using Fibonacci numbers.</p>
</div>
<div class="paragraph data-line-720">
<p>Consider the library in <a href="#fibonacci_security">FibonacciLib.sol</a>, which can generate the Fibonacci sequence
and sequences of similar form. (Note: this code was
modified from <a href="https://bit.ly/2MReuii" class="undefined" data-href="https://bit.ly/2MReuii">https://bit.ly/2MReuii</a>.)</p>
</div>
<div id="fibonacci_security" class="exampleblock data-line-726">
<div class="title">Example 12. FibonacciLib.sol</div>
<div class="content">
<div class="listingblock data-line-728">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// library contract - calculates Fibonacci-like numbers
contract FibonacciLib {
    // initializing the standard Fibonacci sequence
    uint public start;
    uint public calculatedFibNumber;

    // modify the zeroth number in the sequence
    function setStart(uint _start) public {
        start = _start;
    }

    function setFibonacci(uint n) public {
        calculatedFibNumber = fibonacci(n);
    }

    function fibonacci(uint n) internal returns (uint) {
        if (n == 0) return start;
        else if (n == 1) return start + 1;
        else return fibonacci(n - 1) + fibonacci(n - 2);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-753">
<p>This library provides a function that can generate the <em>n</em>-th Fibonacci
number in the sequence. It allows users to change the starting number of the
sequence (<code>start</code>) and calculate the <em>n</em>-th Fibonacci-like numbers in this new
sequence.</p>
</div>
<div class="paragraph data-line-758">
<p>Let us now consider a contract that utilizes this library, shown in <a href="#fib_balance_security">FibonacciBalance.sol</a>.</p>
</div>
<div id="fib_balance_security" class="exampleblock data-line-762">
<div class="title">Example 13. FibonacciBalance.sol</div>
<div class="content">
<div class="listingblock data-line-764">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract FibonacciBalance {

    address public fibonacciLibrary;
    // the current Fibonacci number to withdraw
    uint public calculatedFibNumber;
    // the starting Fibonacci sequence number
    uint public start = 3;
    uint public withdrawalCounter;
    // the Fibonancci function selector
    bytes4 constant fibSig = bytes4(sha3("setFibonacci(uint256)"));

    // constructor - loads the contract with ether
    constructor(address _fibonacciLibrary) external payable {
        fibonacciLibrary = _fibonacciLibrary;
    }

    function withdraw() {
        withdrawalCounter += 1;
        // calculate the Fibonacci number for the current withdrawal user-
        // this sets calculatedFibNumber
        require(fibonacciLibrary.delegatecall(fibSig, withdrawalCounter));
        msg.sender.transfer(calculatedFibNumber * 1 ether);
    }

    // allow users to call Fibonacci library functions
    function() public {
        require(fibonacciLibrary.delegatecall(msg.data));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-797">
<p>This contract allows a participant to withdraw ether from the contract,
with the amount of ether being equal to the Fibonacci number
corresponding to the participant&#8217;s withdrawal order; i.e., the first
participant gets 1 ether, the second also gets 1, the third gets 2, the
fourth gets 3, the fifth 5, and so on (until the balance of the contract
is less than the Fibonacci number being withdrawn).</p>
</div>
<div class="paragraph data-line-807">
<p>There are a number of elements in this contract that may require some
explanation. Firstly, there is an interesting-looking variable,
<code>fibSig</code>. This holds the first 4 bytes of the Keccak-256 (SHA-3) hash of the
string <code>'setFibonacci(uint256)'</code>. This is known as the
<a href="http://bit.ly/2RmueMP" data-href="http://bit.ly/2RmueMP">function
selector</a> and is put into <code>calldata</code> to specify which function of a
smart contract will be called. It is used in the <code>delegatecall</code> function
on line 21 to specify that we wish to run the <code>fibonacci(uint256)</code>
function. The second argument in <code>delegatecall</code> is the parameter we are
passing to the function. Secondly, we assume that the address for the
<code>FibonacciLib</code> library is correctly referenced in the constructor
(<a href="#external_contract_referencing">External Contract Referencing</a> discusses some
potential vulnerabilities relating to this kind of contract reference
initialization).</p>
</div>
<div class="paragraph data-line-822">
<p>Can you spot any errors in this contract? If one were to deploy this contract,
fill it with ether, and call <code>withdraw</code>, it would likely revert.</p>
</div>
<div class="paragraph data-line-825">
<p>You may have noticed that the state variable <code>start</code> is used in both the
library and the main calling contract. In the library contract, <code>start</code>
is used to specify the beginning of the Fibonacci sequence and is set to
<code>0</code>, whereas it is set to <code>3</code> in the calling contract. You
may also have noticed that the fallback function in the
<code>FibonacciBalance</code> contract allows all calls to be passed to the library
contract, which allows for the <code>setStart</code> function of the library
contract to be called. Recalling that we preserve the state of the
contract, it may seem that this function would allow you to change the
state of the <code>start</code> variable in the local <code>FibonnacciBalance</code> contract.
If so, this would allow one to withdraw more ether, as the resulting
<code>calculatedFibNumber</code> is dependent on the <code>start</code> variable (as seen in
the library contract). In actual fact, the <code>setStart</code> function does
not (and cannot) modify the <code>start</code> variable in the <code>FibonacciBalance</code>
contract. The underlying vulnerability in this contract is significantly
worse than just modifying the <code>start</code> variable.</p>
</div>
<div class="paragraph data-line-845">
<p>Before discussing the actual issue, let&#8217;s take a quick detour to
understand how state variables actually get
stored in contracts. State or storage variables (variables that
persist over individual transactions) are placed into <em>slots</em>
sequentially as they are introduced in the contract. (There are some complexities here; consult the <a href="http://bit.ly/2JslDWf" data-href="http://bit.ly/2JslDWf">Solidity docs</a> for a more thorough understanding.)</p>
</div>
<div class="paragraph data-line-851">
<p>As an example, let’s look at the library contract. It has two state
variables, <code>start</code> and <code>calculatedFibNumber</code>. The first variable,
<code>start</code>, is stored in the contract’s storage at <code>slot[0]</code>
(i.e., the first slot). The second variable, <code>calculatedFibNumber</code>, is
placed in the next available storage slot, <code>slot[1]</code>. The
function <code>setStart</code> takes an input and sets <code>start</code> to whatever
the input was. This function therefore sets <code>slot[0]</code> to whatever
input we provide in the <code>setStart</code> function. Similarly, the
<code>setFibonacci</code> function sets <code>calculatedFibNumber</code> to the result of
<code>fibonacci(n)</code>. Again, this is simply setting storage <code>slot[1]</code> to the
value of <code>fibonacci(n)</code>.</p>
</div>
<div class="paragraph data-line-863">
<p>Now let&#8217;s look at the <code>FibonacciBalance</code> contract. Storage <code>slot[0]</code> now
corresponds to the <code>fibonacciLibrary</code> address, and <code>slot[1]</code> corresponds to
<code>calculatedFibNumber</code>. It is in this incorrect mapping that the vulnerability occurs.
<code>delegatecall</code> <em>preserves contract context</em>. This means that code that
is executed via <code>delegatecall</code> will act on the state (i.e., storage) of
the calling contract.</p>
</div>
<div class="paragraph data-line-870">
<p>Now notice that in <code>withdraw</code> on line 21 we execute
<code>fibonacciLibrary.delegatecall(fibSig,withdrawalCounter)</code>. This calls
the <code>setFibonacci</code> function, which, as we discussed, modifies storage
<code>slot[1]</code>, which in our current context is <code>calculatedFibNumber</code>. This
is as expected (i.e., after execution, <code>calculatedFibNumber</code> is
modified). However, recall that the <code>start</code> variable in the
<code>FibonacciLib</code> contract is located in storage <code>slot[0]</code>, which is the
<code>fibonacciLibrary</code> address in the current contract. This means that the
function <code>fibonacci</code> will give an unexpected result. This is because
it references <code>start</code> (<code>slot[0]</code>), which in the current calling context
is the <code>fibonacciLibrary</code> address (which will often be quite large, when
interpreted as a <code>uint</code>). Thus it is likely that the <code>withdraw</code>
function will revert, as it will not contain <code>uint(fibonacciLibrary)</code>
amount of ether, which is what <code>calculatedFibNumber</code> will return.</p>
</div>
<div class="paragraph data-line-885">
<p>Even worse, the <code>FibonacciBalance</code> contract allows users to call all of
the <code>fibonacciLibrary</code> functions via the fallback function at line 26.
As we discussed earlier, this includes the <code>setStart</code> function. We
discussed that this function allows anyone to modify or set storage
<code>slot[0]</code>. In this case, storage <code>slot[0]</code> is the <code>fibonacciLibrary</code>
address. Therefore, an attacker could create a malicious contract, convert the address to a <code>uint</code> (this can be
done in Python easily using <code>int('&lt;address&gt;',16)</code>), and then call
<code>setStart(&lt;attack_contract_address_as_uint&gt;)</code>. This will change
<code>fibonacciLibrary</code> to the address of the attack contract. Then, whenever
a user calls <code>withdraw</code> or the fallback function, the malicious
contract will run (which can steal the entire balance of the contract)
because we’ve modified the actual address for <code>fibonacciLibrary</code>. An
example of such an attack contract would be:</p>
</div>
<div class="listingblock data-line-900">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Attack {
    uint storageSlot0; // corresponds to fibonacciLibrary
    uint storageSlot1; // corresponds to calculatedFibNumber

    // fallback - this will run if a specified function is not found
    function() public {
        storageSlot1 = 0; // we set calculatedFibNumber to 0, so if withdraw
        // is called we don't send out any ether
        &lt;attacker_address&gt;.transfer(this.balance); // we take all the ether
    }
 }</code></pre>
</div>
</div>
<div class="paragraph data-line-914">
<p>Notice that this attack contract modifies the <code>calculatedFibNumber</code> by
changing storage <code>slot[1]</code>. In principle, an attacker could modify any
other storage slots they choose, to perform all kinds of attacks on this
contract. We encourage you to put these contracts into <a href="https://remix.ethereum.org" data-href="https://remix.ethereum.org">Remix</a> and experiment with different attack contracts and state changes through these <code>delegatecall</code> functions.</p>
</div>
<div class="paragraph data-line-919">
<p>It is also important to notice that when we say that <code>delegatecall</code> is
state-preserving, we are not talking about the variable names of the
contract, but rather the actual storage slots to which those names point. As
you can see from this example, a simple mistake can lead to an attacker
hijacking the entire contract and its ether.</p>
</div>
</div>
<div class="sect3 notoc data-line-926">
<h4 id="_preventative_techniques_4">Preventative Techniques</h4>
<div class="paragraph data-line-928">
<p>Solidity provides the <code>library</code> keyword for implementing library
contracts (see the <a href="http://bit.ly/2zjD8TI" data-href="http://bit.ly/2zjD8TI">docs</a> for further details). This ensures the library contract is
stateless and non-self-destructable. Forcing libraries to be stateless
mitigates the complexities of storage context demonstrated in this
section. Stateless libraries also prevent attacks wherein attackers
modify the state of the library directly in order to affect the
contracts that depend on the library’s code. As a general rule of thumb,
when using <code>DELEGATECALL</code> pay careful attention to the possible calling
context of both the library contract and the calling contract, and
whenever possible build stateless <span class="keep-together">libraries</span>.</p>
</div>
</div>
<div class="sect3 data-line-940">
<h4 id="multisig_secondhack">Real-World Example: Parity Multisig Wallet (Second Hack)</h4>
<div class="paragraph data-line-942">
<p>The Second Parity Multisig Wallet hack is an example of how well-written library code can be exploited if run outside its intended
context. There are a number of good explanations of this hack, such as
<a href="http://bit.ly/2Dg7GtW" data-href="http://bit.ly/2Dg7GtW">&#x201c;Parity Multisig Hacked. Again&#x201d;</a> and <a href="http://bit.ly/2Of06B9" data-href="http://bit.ly/2Of06B9">&#x201c;An In-Depth Look at the Parity Multisig Bug&#x201d;</a>.</p>
</div>
<div class="paragraph data-line-946">
<p>To add to these references, let’s explore the contracts that were
exploited. The library and wallet contracts can be found <a href="http://bit.ly/2OgnXQC" data-href="http://bit.ly/2OgnXQC">on GitHub</a>.</p>
</div>
<div class="paragraph data-line-949">
<p>The library contract is as follows:</p>
</div>
<div class="listingblock data-line-952">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract WalletLibrary is WalletEvents {

  ...

  // throw unless the contract is not yet initialized.
  modifier only_uninitialized { if (m_numOwners &gt; 0) throw; _; }

  // constructor - just pass on the owner array to multiowned and
  // the limit to daylimit
  function initWallet(address[] _owners, uint _required, uint _daylimit)
      only_uninitialized {
    initDaylimit(_daylimit);
    initMultiowned(_owners, _required);
  }

  // kills the contract sending everything to `_to`.
  function kill(address _to) onlymanyowners(sha3(msg.data)) external {
    suicide(_to);
  }

  ...

}</code></pre>
</div>
</div>
<div class="paragraph data-line-978">
<p>And here&#8217;s the wallet contract:</p>
</div>
<div class="listingblock data-line-981">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Wallet is WalletEvents {

  ...

  // METHODS

  // gets called when no other function matches
  function() payable {
    // just being sent some cash?
    if (msg.value &gt; 0)
      Deposit(msg.sender, msg.value);
    else if (msg.data.length &gt; 0)
      _walletLibrary.delegatecall(msg.data);
  }

  ...

  // FIELDS
  address constant _walletLibrary =
    0xcafecafecafecafecafecafecafecafecafecafe;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1005">
<p>Notice that the <code>Wallet</code> contract essentially passes all calls to the
<code>WalletLibrary</code> contract via a delegate call. The constant
<code>_walletLibrary</code> address in this code snippet acts as a placeholder for
the actually deployed <code>WalletLibrary</code> contract (which was at
<code>0x863DF6BFa4469f3ead0bE8f9F2AAE51c91A907b4</code>).</p>
</div>
<div class="paragraph data-line-1011">
<p>The intended operation of these contracts was to have a simple low-cost
deployable <code>Wallet</code> contract whose codebase and main functionality were
in the <code>WalletLibrary</code> contract. Unfortunately, the <code>WalletLibrary</code>
contract is itself a contract and maintains its own state. Can you see
why this might be an issue?</p>
</div>
<div class="paragraph data-line-1017">
<p>It is possible to send calls to the <code><span class="keep-together">WalletLibrary</span></code> contract itself.
Specifically, the <code><span class="keep-together">WalletLibrary</span></code> contract could be initialized and
become owned. In fact, a user did this, calling the <code>initWallet</code> function on the
<code>WalletLibrary</code> contract and becoming an owner of the library contract. The
same user subsequently called the <code>kill</code> function. Because the user
was an owner of the library contract, the modifier passed and the
library contract self-destructed. As all <code>Wallet</code> contracts in existence refer
to this library contract and contain no method to change this reference,
all of their functionality, including the ability to withdraw ether, was
lost along with the <code>WalletLibrary</code> contract. As a result, all ether
in all Parity multisig wallets of this type instantly became lost or
permanently unrecoverable.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1030">
<h3 id="_default_visibilities">Default Visibilities</h3>
<div class="paragraph data-line-1032">
<p>Functions in Solidity have visibility specifiers that dictate how
they can be called. The visibility determines whether a
function can be called externally by users, by other derived contracts,
only internally, or only externally. There are four visibility
specifiers, which are described in detail in the <a href="http://bit.ly/2ABiv7j" data-href="http://bit.ly/2ABiv7j">Solidity docs</a>. Functions default to <code>public</code>, allowing users to call them
externally. We shall now see how incorrect use of visibility specifiers can lead to some devastating vulnerabilities in smart contracts.</p>
</div>
<div class="sect3 notoc data-line-1040">
<h4 id="_the_vulnerability_5">The Vulnerability</h4>
<div class="paragraph data-line-1042">
<p>The default visibility for functions is <code>public</code>, so functions
that do not specify their visibility will be callable by external users.
The issue arises when developers mistakenly omit visibility specifiers
on functions that should be private (or only callable within the
contract itself).</p>
</div>
<div class="paragraph data-line-1048">
<p>Let&#8217;s quickly explore a trivial example:</p>
</div>
<div class="listingblock data-line-1051">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract HashForEther {

    function withdrawWinnings() {
        // Winner if the last 8 hex characters of the address are 0
        require(uint32(msg.sender) == 0);
        _sendWinnings();
     }

     function _sendWinnings() {
         msg.sender.transfer(this.balance);
     }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1066">
<p>This simple contract is designed to act as an address-guessing bounty
game. To win the balance of the contract, a user must generate an
Ethereum address whose last 8 hex characters are 0. Once achieved, they
can call the <code>withdrawWinnings</code> function to obtain their bounty.</p>
</div>
<div class="paragraph data-line-1071">
<p>Unfortunately, the visibility of the functions has not been specified.
In particular, the <code>_sendWinnings</code> function is <code>public</code> (the default), and thus any
address can call this function to steal the bounty.</p>
</div>
</div>
<div class="sect3 notoc data-line-1076">
<h4 id="_preventative_techniques_5">Preventative Techniques</h4>
<div class="paragraph data-line-1078">
<p>It is good practice to always specify the visibility of all functions in
a contract, even if they are intentionally <code>public</code>. Recent versions of
solc show a warning for functions that
have no explicit visibility set, to encourage this practice.</p>
</div>
</div>
<div class="sect3 data-line-1083">
<h4 id="_real_world_example_parity_multisig_wallet_first_hack">Real-World Example: Parity Multisig Wallet (First Hack)</h4>
<div class="paragraph data-line-1085">
<p>In the first Parity multisig hack, about $31M worth of Ether was stolen,
mostly from three wallets. A good recap of exactly how this was done
is given by <a href="https://bit.ly/2vHiuJQ" data-href="https://bit.ly/2vHiuJQ">Haseeb Qureshi</a>.</p>
</div>
<div class="paragraph data-line-1089">
<p>Essentially, the multisig wallet
is constructed from a base <code>Wallet</code> contract, which calls a library
contract containing the core functionality (as described in
<a href="#multisig_secondhack">Real-World Example: Parity Multisig Wallet (Second Hack)</a>).
The library contract contains the code to initialize the wallet, as can
be seen from the following snippet:</p>
</div>
<div class="listingblock data-line-1097">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract WalletLibrary is WalletEvents {

  ...

  // METHODS

  ...

  // constructor is given number of sigs required to do protected
  // "onlymanyowners" transactionsas well as the selection of addresses
  // capable of confirming them
  function initMultiowned(address[] _owners, uint _required) {
    m_numOwners = _owners.length + 1;
    m_owners[1] = uint(msg.sender);
    m_ownerIndex[uint(msg.sender)] = 1;
    for (uint i = 0; i &lt; _owners.length; ++i)
    {
      m_owners[2 + i] = uint(_owners[i]);
      m_ownerIndex[uint(_owners[i])] = 2 + i;
    }
    m_required = _required;
  }

  ...

  // constructor - just pass on the owner array to multiowned and
  // the limit to daylimit
  function initWallet(address[] _owners, uint _required, uint _daylimit) {
    initDaylimit(_daylimit);
    initMultiowned(_owners, _required);
  }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1132">
<p>Note that neither of the functions specifies their
visibility, so both default to <code>public</code>. The <code>initWallet</code>
function is called in the wallet&#8217;s constructor, and sets the owners for
the multisig wallet as can be seen in the <code>initMultiowned</code> function.
Because these functions were accidentally left <code>public</code>, an attacker was
able to call these functions on deployed contracts, resetting the
ownership to the attacker&#8217;s address. Being the owner, the attacker then
drained the wallets of all their ether.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1142">
<h3 id="entropyillusion_security">Entropy Illusion</h3>
<div class="paragraph data-line-1144">
<p>All transactions on the Ethereum blockchain are deterministic state
transition operations. This means that every transaction modifies the
global state of the Ethereum ecosystem in a calculable
way, with no uncertainty. This has the fundamental implication that
there is no source of entropy or randomness in Ethereum.
Achieving decentralized entropy
(randomness) is a well-known problem for which many solutions have been proposed, including <a href="https://github.com/randao/randao" data-href="https://github.com/randao/randao">RANDAO</a>, or using a chain of hashes, as
described by Vitalik Buterin in the blog post
<a href="https://vitalik.ca/files/randomness.html" data-href="https://vitalik.ca/files/randomness.html">&#x201c;Validator Ordering and Randomness in PoS&#x201d;</a>.</p>
</div>
<div class="sect3 notoc data-line-1155">
<h4 id="_the_vulnerability_6">The Vulnerability</h4>
<div class="paragraph data-line-1157">
<p>Some of the first contracts built on the Ethereum platform were based
around gambling. Fundamentally, gambling requires uncertainty (something
to bet on), which makes building a gambling system on the blockchain (a
deterministic system) rather difficult. It is clear that the uncertainty
must come from a source external to the blockchain. This is possible for
bets between players (see for example the <a href="http://bit.ly/2CUh2KS" data-href="http://bit.ly/2CUh2KS">commit&#x2013;reveal technique</a>); however, it is significantly more difficult if you want to
implement a contract to act as &#x201c;the house&#x201d; (like in blackjack or
roulette). A common pitfall is to use future block variables&#x2014;that is,
variables containing information about the transaction block whose values are not yet known, such as
hashes, timestamps, block numbers, or gas limits. The issue with these are
that they are controlled by the miner who mines the block, and as such
are not truly random. Consider, for example, a roulette smart contract
with logic that returns a black number if the next block hash ends in an
even number. A miner (or miner pool) could bet $1M on black. If they
solve the next block and find the hash ends in an odd number, they could
happily not publish their block and mine another, until they find a
solution with the block hash being an even number (assuming the block
reward and fees are less than $1M). Using past or present variables can
be even more devastating, as Martin Swende demonstrates in his excellent <a href="http://martin.swende.se/blog/Breaking_the_house.html" data-href="http://martin.swende.se/blog/Breaking_the_house.html">blog post</a>.
Furthermore, using solely block variables means that the pseudorandom
number will be the same for all transactions in a block, so an attacker
can multiply their wins by doing many transactions within a block
(should there be a maximum bet).</p>
</div>
</div>
<div class="sect3 notoc data-line-1182">
<h4 id="_preventative_techniques_6">Preventative Techniques</h4>
<div class="paragraph data-line-1184">
<p>The source of entropy (randomness) must be external to the blockchain.
This can be done among peers with systems such as
<a href="http://bit.ly/2CUh2KS" data-href="http://bit.ly/2CUh2KS">commit–reveal</a>,
or via changing the trust model to a group of participants (as in
<a href="https://github.com/randao/randao" data-href="https://github.com/randao/randao">RandDAO</a>). This can also be done via a
centralized entity that acts as a randomness oracle. Block variables
(in general, there are some exceptions) should not be used to source
entropy, as they can be manipulated by miners.</p>
</div>
</div>
<div class="sect3 data-line-1193">
<h4 id="_real_world_example_prng_contracts">Real-World Example: PRNG Contracts</h4>
<div class="paragraph data-line-1195">
<p>In February 2018 Arseny Reutov
<a href="http://bit.ly/2Q589lx" data-href="http://bit.ly/2Q589lx">blogged</a> about his analysis of 3,649 live smart contracts that were using some
sort of pseudorandom number generator (PRNG); he found 43 contracts
that could be exploited.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1201">
<h3 id="external_contract_referencing">External Contract Referencing</h3>
<div class="paragraph data-line-1203">
<p>One of the benefits of the Ethereum &#x201c;world computer&#x201d; is the ability to
reuse code and interact with contracts already deployed on the network.
As a result, a large number of contracts reference external contracts,
usually via external message calls.
These external message calls can mask malicious actors'
intentions in some nonobvious ways, which we&#8217;ll now examine.</p>
</div>
<div class="sect3 notoc data-line-1211">
<h4 id="_the_vulnerability_7">The Vulnerability</h4>
<div class="paragraph data-line-1213">
<p>In Solidity, any address can be cast to a contract, regardless of whether
the code at the address represents the contract type being cast. This
can cause problems, especially when the author of the contract is trying
to hide malicious code. Let&#8217;s illustrate this with an example.</p>
</div>
<div class="paragraph data-line-1218">
<p>Consider a piece of code like <a href="#rot13_security">Rot13Encryption.sol</a>, which rudimentarily implements the
<a href="https://en.wikipedia.org/wiki/ROT13" data-href="https://en.wikipedia.org/wiki/ROT13">ROT13 cipher</a>.</p>
</div>
<div id="rot13_security" class="exampleblock data-line-1223">
<div class="title">Example 14. Rot13Encryption.sol</div>
<div class="content">
<div class="listingblock data-line-1225">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// encryption contract
contract Rot13Encryption {

   event Result(string convertedString);

    // rot13-encrypt a string
    function rot13Encrypt (string text) public {
        uint256 length = bytes(text).length;
        for (var i = 0; i &lt; length; i++) {
            byte char = bytes(text)[i];
            // inline assembly to modify the string
            assembly {
                // get the first byte
                char := byte(0,char)
                // if the character is in [n,z], i.e. wrapping
                if and(gt(char,0x6D), lt(char,0x7B))
                // subtract from the ASCII number 'a',
                // the difference between character &lt;char&gt; and 'z'
                { char:= sub(0x60, sub(0x7A,char)) }
                if iszero(eq(char, 0x20)) // ignore spaces
                // add 13 to char
                {mstore8(add(add(text,0x20), mul(i,1)), add(char,13))}
            }
        }
        emit Result(text);
    }

    // rot13-decrypt a string
    function rot13Decrypt (string text) public {
        uint256 length = bytes(text).length;
        for (var i = 0; i &lt; length; i++) {
            byte char = bytes(text)[i];
            assembly {
                char := byte(0,char)
                if and(gt(char,0x60), lt(char,0x6E))
                { char:= add(0x7B, sub(char,0x61)) }
                if iszero(eq(char, 0x20))
                {mstore8(add(add(text,0x20), mul(i,1)), sub(char,13))}
            }
        }
        emit Result(text);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-1272">
<p>This code simply takes a string (letters a&#x2013;z, without validation) and
<em>encrypts</em> it by shifting each character 13 places to the right (wrapping
around <code>z</code>); i.e., <code>a</code> shifts to <code>n</code> and <code>x</code> shifts to <code>k</code>. The assembly
in the preceding contract does not need to be understood to appreciate the issue
being discussed, so readers unfamiliar with assembly can safely ignore it.</p>
</div>
<div class="paragraph data-line-1278">
<p>Now consider the following contract, which uses this code for its encryption:</p>
</div>
<div class="listingblock data-line-1281">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "Rot13Encryption.sol";

// encrypt your top-secret info
contract EncryptionContract {
    // library for encryption
    Rot13Encryption encryptionLibrary;

    // constructor - initialize the library
    constructor(Rot13Encryption _encryptionLibrary) {
        encryptionLibrary = _encryptionLibrary;
    }

    function encryptPrivateData(string privateInfo) {
        // potentially do some operations here
        encryptionLibrary.rot13Encrypt(privateInfo);
     }
 }</code></pre>
</div>
</div>
<div class="paragraph data-line-1301">
<p>The issue with this contract is that the <code>encryptionLibrary</code> address is
not public or constant. Thus, the deployer of the contract could give an address in the constructor that points to this contract:</p>
</div>
<div class="listingblock data-line-1305">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// encryption contract
contract Rot26Encryption {

   event Result(string convertedString);

    // rot13-encrypt a string
    function rot13Encrypt (string text) public {
        uint256 length = bytes(text).length;
        for (var i = 0; i &lt; length; i++) {
            byte char = bytes(text)[i];
            // inline assembly to modify the string
            assembly {
                // get the first byte
                char := byte(0,char)
                // if the character is in [n,z], i.e. wrapping
                if and(gt(char,0x6D), lt(char,0x7B))
                // subtract from the ASCII number 'a',
                // the difference between character &lt;char&gt; and 'z'
                { char:= sub(0x60, sub(0x7A,char)) }
                // ignore spaces
                if iszero(eq(char, 0x20))
                // add 26 to char!
                {mstore8(add(add(text,0x20), mul(i,1)), add(char,26))}
            }
        }
        emit Result(text);
    }

    // rot13-decrypt a string
    function rot13Decrypt (string text) public {
        uint256 length = bytes(text).length;
        for (var i = 0; i &lt; length; i++) {
            byte char = bytes(text)[i];
            assembly {
                char := byte(0,char)
                if and(gt(char,0x60), lt(char,0x6E))
                { char:= add(0x7B, sub(char,0x61)) }
                if iszero(eq(char, 0x20))
                {mstore8(add(add(text,0x20), mul(i,1)), sub(char,26))}
            }
        }
        emit Result(text);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1352">
<p>This contract implements the ROT26 cipher, which shifts each character by 26 places
(i.e., does nothing). Again, there is no need to understand the assembly in this
contract. More simply, the attacker could have linked the following
contract to the same effect:</p>
</div>
<div class="listingblock data-line-1358">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Print{
    event Print(string text);

    function rot13Encrypt(string text) public {
        emit Print(text);
    }
 }</code></pre>
</div>
</div>
<div class="paragraph data-line-1368">
<p>If the address of either of these contracts were given in the
constructor, the <code>encryptPrivateData</code> function would simply produce an
event that prints the unencrypted private data.</p>
</div>
<div class="paragraph data-line-1372">
<p>Although in this
example a library-like contract was set in the constructor, it is often
the case that a privileged user (such as an owner) can change library
contract addresses. If a linked contract doesn’t contain the function
being called, the fallback function will execute. For example, with the
line <code>encryptionLibrary.rot13&#x200b;Encrypt()</code>, if the contract specified by
<code>encryptionLibrary</code> was:</p>
</div>
<div class="listingblock data-line-1381">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity"> contract Blank {
     event Print(string text);
     function () {
         emit Print("Here");
         // put malicious code here and it will run
     }
 }</code></pre>
</div>
</div>
<div class="paragraph data-line-1391">
<p>then an event with the text <code>Here</code> would be emitted. Thus, if users can
alter contract libraries, they can in principle get other users to unknowingly
run arbitrary code.</p>
</div>
<div class="admonitionblock warning data-line-1396">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-1397">
<p>The contracts represented here are for demonstrative purposes only and
do not represent proper encryption. They should not be used for
encryption.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 notoc data-line-1403">
<h4 id="_preventative_techniques_7">Preventative Techniques</h4>
<div class="paragraph data-line-1405">
<p>As demonstrated previously, safe contracts can (in some cases)
be deployed in such a way that they behave maliciously. An auditor could
publicly verify a contract and have its owner deploy it in a malicious
way, resulting in a publicly audited contract that has vulnerabilities
or malicious intent.</p>
</div>
<div class="paragraph data-line-1411">
<p>There are a number of techniques that prevent these scenarios.</p>
</div>
<div class="paragraph data-line-1413">
<p>One technique is to use the <code>new</code> keyword to create contracts. In the
preceding example, the constructor could be written as:</p>
</div>
<div class="listingblock data-line-1417">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">constructor() {
    encryptionLibrary = new Rot13Encryption();
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1423">
<p>This way an instance of the referenced contract is created at deployment
time, and the deployer cannot replace the <code>Rot13Encryption</code> contract
without changing it.</p>
</div>
<div class="paragraph data-line-1427">
<p>Another solution is to hardcode external contract addresses.</p>
</div>
<div class="paragraph data-line-1429">
<p>In general, code that calls external contracts should always be
audited carefully. As a developer, when defining external contracts, it can
be a good idea to make the contract addresses public (which is not the
case in the honey-pot example in the following section) to allow users to easily examine
code referenced by the contract. Conversely, if a contract has
a private variable contract address it can be a sign of someone behaving
maliciously (as shown in the real-world example). If a user can change
a contract address that is used to
call external functions, it can be important (in a decentralized system
context) to implement a time-lock and/or voting mechanism to allow users to
see what code is being changed, or to give participants a chance to opt
in/out with the new contract address.</p>
</div>
</div>
<div class="sect3 data-line-1442">
<h4 id="_real_world_example_reentrancy_honey_pot">Real-World Example: Reentrancy Honey Pot</h4>
<div class="paragraph data-line-1444">
<p>A number of recent honey pots have been released on the mainnet. These
contracts try to outsmart Ethereum hackers who try to exploit the
contracts, but who in turn end up losing ether to the contract
they expect to exploit. One example employs this attack by
replacing an expected contract with a malicious one in the constructor.
The code can be found
<a href="http://bit.ly/2JtdqRi" data-href="http://bit.ly/2JtdqRi">here</a>:</p>
</div>
<div class="listingblock data-line-1453">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.19;

contract Private_Bank
{
    mapping (address =&gt; uint) public balances;
    uint public MinDeposit = 1 ether;
    Log TransferLog;

    function Private_Bank(address _log)
    {
        TransferLog = Log(_log);
    }

    function Deposit()
    public
    payable
    {
        if(msg.value &gt;= MinDeposit)
        {
            balances[msg.sender]+=msg.value;
            TransferLog.AddMessage(msg.sender,msg.value,"Deposit");
        }
    }

    function CashOut(uint _am)
    {
        if(_am&lt;=balances[msg.sender])
        {
            if(msg.sender.call.value(_am)())
            {
                balances[msg.sender]-=_am;
                TransferLog.AddMessage(msg.sender,_am,"CashOut");
            }
        }
    }

    function() external payable{}

}

contract Log
{
    struct Message
    {
        address Sender;
        string  Data;
        uint Val;
        uint  Time;
    }

    Message[] public History;
    Message LastMsg;

    function AddMessage(address _adr,uint _val,string _data)
    public
    {
        LastMsg.Sender = _adr;
        LastMsg.Time = now;
        LastMsg.Val = _val;
        LastMsg.Data = _data;
        History.push(LastMsg);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1519">
<p>This
<a href="http://bit.ly/2Q58VyX" data-href="http://bit.ly/2Q58VyX">post</a>
by one reddit user explains how they lost 1 ether to this contract
by trying to exploit the reentrancy bug they expected to be present in the
contract.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1525">
<h3 id="_short_addressparameter_attack">Short Address/Parameter Attack</h3>
<div class="paragraph data-line-1527">
<p>This attack is not performed on Solidity contracts
themselves, but on third-party applications that may interact with them. This
section is added for completeness and to give the reader an awareness of how parameters can be
manipulated in contracts.</p>
</div>
<div class="paragraph data-line-1532">
<p>For further reading, see
<a href="http://bit.ly/2yKme14" data-href="http://bit.ly/2yKme14">&#x201c;The ERC20
Short Address Attack Explained&#x201d;</a>,
<a href="http://bit.ly/2yFOGRQ" data-href="http://bit.ly/2yFOGRQ">&#x201c;ICO
Smart Contract Vulnerability: Short Address Attack&#x201d;</a>, or this
<a href="http://bit.ly/2CQjBhc" data-href="http://bit.ly/2CQjBhc">Reddit
post</a>.</p>
</div>
<div class="sect3 notoc data-line-1541">
<h4 id="_the_vulnerability_8">The Vulnerability</h4>
<div class="paragraph data-line-1543">
<p>When passing parameters to a smart contract, the parameters are encoded
according to the
<a href="http://bit.ly/2Q5VIG9" data-href="http://bit.ly/2Q5VIG9">ABI
specification</a>. It is possible to send encoded parameters that are
shorter than the expected parameter length (for example, sending an
address that is only 38 hex chars (19 bytes) instead of the standard 40
hex chars (20 bytes)). In such a scenario, the EVM will add zeros to the
end of the encoded parameters to make up the expected length.</p>
</div>
<div class="paragraph data-line-1552">
<p>This becomes an issue when third-party applications do not validate
inputs. The clearest example is an exchange that doesn’t verify the
address of an
ERC20 token
when a user requests a withdrawal. This example is covered in more
detail in Peter Vessenes’s post,
<a href="http://bit.ly/2Q1ybpQ" data-href="http://bit.ly/2Q1ybpQ">&#x201c;The ERC20
Short Address Attack Explained&#x201d;</a>.</p>
</div>
<div class="paragraph data-line-1561">
<p>Consider the standard
<a href="http://bit.ly/2CUf7WG" data-href="http://bit.ly/2CUf7WG">ERC20</a>
transfer function interface, noting the order of the parameters:</p>
</div>
<div class="listingblock data-line-1566">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function transfer(address to, uint tokens) public returns (bool success);</code></pre>
</div>
</div>
<div class="paragraph data-line-1570">
<p>Now consider an exchange holding a large amount of a token (let’s say
<code>REP</code>) and a user who wishes to withdraw their share of 100 tokens. The user
would submit their address, <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddeaddead</code>,
and the number of tokens, <code>100</code>. The exchange would encode these
parameters in the order specified by the <code><span class="keep-together">transfer</span></code> function; that is,
<code>address</code> then <code>tokens</code>. The encoded result would be:</p>
</div>
<div class="listingblock data-line-1577">
<div class="content">
<pre>a9059cbb000000000000000000000000deaddeaddea \
ddeaddeaddeaddeaddeaddeaddead0000000000000
000000000000000000000000000000000056bc75e2d63100000</pre>
</div>
</div>
<div class="paragraph data-line-1583">
<p>The first 4
bytes (<code>a9059cbb</code>) are the <code>transfer</code>
<a href="http://bit.ly/2RmueMP" data-href="http://bit.ly/2RmueMP">function
signature/selector</a>, the next 32 bytes are the address, and
the final 32 bytes represent the <code>uint256</code> number of tokens.
Notice that the hex <code>56bc75e2d63100000</code> at the end corresponds to 100
tokens (with 18 decimal places, as specified by the <code>REP</code> token
<span class="keep-together">contract</span>).</p>
</div>
<div class="paragraph data-line-1592">
<p>Let us now look at what would happen if one were to send an address that
was missing 1 byte (2 hex digits). Specifically, let’s say an attacker
sends <code>0xdeaddeaddeaddeaddeaddeaddeaddeaddeadde</code> as an address (missing
the last two digits) and the same <code>100</code> tokens to withdraw. If the
exchange does not validate this input, it will get encoded as:</p>
</div>
<div class="listingblock data-line-1598">
<div class="content">
<pre>a9059cbb000000000000000000000000deaddeaddea \
ddeaddeaddeaddeaddeaddeadde00000000000000
00000000000000000000000000000000056bc75e2d6310000000</pre>
</div>
</div>
<div class="paragraph data-line-1604">
<p>The difference
is subtle. Note that <code>00</code> has been added to the end of the encoding, to
make up for the short address that was sent. When this gets sent to the
smart contract, the <code>address</code> parameters will be read as
<code>0xdeaddeaddeaddeaddeaddeaddeaddeaddeadde00</code> and the value will be read
as <code>56bc75e2d6310000000</code> (notice the two extra 0s). This value is
now <code>25600</code> tokens (the value has been multiplied by <code>256</code>). In this
example, if the exchange held this many tokens, the user would withdraw
<code>25600</code> tokens (while the exchange thinks the user is only withdrawing
<code>100</code>) to the modified address. Obviously the attacker won&#8217;t possess the
modified address in this example, but if the attacker were to generate
any address that ended in 0s (which can be easily brute-forced) and
used this generated address, they could steal tokens from the
unsuspecting exchange.</p>
</div>
</div>
<div class="sect3 notoc data-line-1620">
<h4 id="_preventative_techniques_8">Preventative Techniques</h4>
<div class="paragraph data-line-1622">
<p>All input parameters in external applications should be validated before
sending them to the blockchain. It should
also be noted that parameter ordering plays an important role here. As padding
only occurs at the end, careful ordering of parameters in the smart contract
can mitigate some forms of this attack.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1628">
<h3 id="_unchecked_call_return_values">Unchecked CALL Return Values</h3>
<div class="paragraph data-line-1630">
<p>There are a number of ways of performing external calls in Solidity. Sending
ether to external accounts is commonly performed via the <code>transfer</code> method.
However, the <code>send</code> function can also be used, and for more versatile
external calls the <code>CALL</code> opcode can be directly employed in Solidity.
The <code>call</code> and <code>send</code> functions return a Boolean indicating whether the
call succeeded or failed. Thus, these functions have a simple caveat, in
that the transaction that executes these functions will not revert if
the external call (intialized by <code>call</code> or <code>send</code>) fails; rather, the
functions will simply return <code>false</code>. A common error is
that the developer expects a revert to occur if the external call fails, and does not check the return value.</p>
</div>
<div class="paragraph data-line-1641">
<p>For further reading, see #4 on the <a href="http://www.dasp.co/#item-4" data-href="http://www.dasp.co/#item-4">DASP Top 10 of 2018</a> and
<a href="http://bit.ly/2RnS1vA" data-href="http://bit.ly/2RnS1vA">&#x201c;Scanning
Live Ethereum Contracts for the &lsquo;Unchecked-Send&rsquo; Bug&#x201d;</a>.</p>
</div>
<div class="sect3 notoc data-line-1646">
<h4 id="_the_vulnerability_9">The Vulnerability</h4>
<div class="paragraph data-line-1648">
<p>Consider the following example:</p>
</div>
<div class="listingblock data-line-1651">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Lotto {

    bool public payedOut = false;
    address public winner;
    uint public winAmount;

    // ... extra functionality here

    function sendToWinner() public {
        require(!payedOut);
        winner.send(winAmount);
        payedOut = true;
    }

    function withdrawLeftOver() public {
        require(payedOut);
        msg.sender.send(this.balance);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1673">
<p>This represents a Lotto-like contract, where a <code>winner</code>
receives <code>winAmount</code> of ether, which typically leaves a little left over
for anyone to withdraw.</p>
</div>
<div class="paragraph data-line-1677">
<p>The vulnerability exists on line 11, where a <code>send</code> is used without checking
the response. In this trivial example, a <code>winner</code> whose transaction
fails (either by running out of gas or by being a contract that intentionally
throws in the fallback function) allows <code>payedOut</code> to be set to <code>true</code> regardless
of whether ether was sent or not. In this case, anyone can withdraw
the <code>winner</code>’s winnings via the <code>withdrawLeftOver</code> function.</p>
</div>
</div>
<div class="sect3 notoc data-line-1685">
<h4 id="_preventative_techniques_9">Preventative Techniques</h4>
<div class="paragraph data-line-1687">
<p>Whenever possible, use the <code>transfer</code> function rather than <code>send</code>, as
<code>transfer</code> will revert if the external transaction reverts. If
<code>send</code> is required, always check the return value.</p>
</div>
<div class="paragraph data-line-1691">
<p>A more robust
<a href="http://bit.ly/2CSdF7y" data-href="http://bit.ly/2CSdF7y">recommendation</a>
is to adopt a <em>withdrawal pattern</em>. In this solution, each user must
call an isolated withdraw function
that handles the sending of ether out of the contract and
deals with the consequences of failed send transactions.
The idea is to logically isolate the external send functionality from
the rest of the codebase, and place the burden of a potentially failed
transaction on the end user calling the withdraw function.</p>
</div>
</div>
<div class="sect3 data-line-1701">
<h4 id="_real_world_example_etherpot_and_king_of_the_ether">Real-World Example: Etherpot and King of the Ether</h4>
<div class="paragraph data-line-1703">
<p><a href="http://bit.ly/2OfHalK" data-href="http://bit.ly/2OfHalK">Etherpot</a> was a smart contract lottery, not
too dissimilar to the example contract mentioned earlier.
The downfall of this contract was primarily due to incorrect use of
block hashes (only the last 256 block hashes are usable; see Aakil
Fernandes’s
<a href="http://bit.ly/2Jpzf4x" data-href="http://bit.ly/2Jpzf4x">post</a>
about how Etherpot failed to take account of this correctly). However, this
contract also suffered from an unchecked call value. Consider the
function <code>cash</code> in <a href="#lotto_security">lotto.sol: Code snippet</a>.</p>
</div>
<div id="lotto_security" class="exampleblock data-line-1715">
<div class="title">Example 15. lotto.sol: Code snippet</div>
<div class="content">
<div class="listingblock data-line-1717">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">...
  function cash(uint roundIndex, uint subpotIndex){

        var subpotsCount = getSubpotsCount(roundIndex);

        if(subpotIndex&gt;=subpotsCount)
            return;

        var decisionBlockNumber = getDecisionBlockNumber(roundIndex,subpotIndex);

        if(decisionBlockNumber&gt;block.number)
            return;

        if(rounds[roundIndex].isCashed[subpotIndex])
            return;
        //Subpots can only be cashed once. This is to prevent double payouts

        var winner = calculateWinner(roundIndex,subpotIndex);
        var subpot = getSubpot(roundIndex);

        winner.send(subpot);

        rounds[roundIndex].isCashed[subpotIndex] = true;
        //Mark the round as cashed
}
...</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-1747">
<p>Notice that on line 21 the <code>send</code> function’s return value is not
checked, and the following line then sets a Boolean indicating that the
winner has been sent their funds. This bug can allow a state where the
winner does not receive their ether, but the state of the contract can
indicate that the winner has already been paid.</p>
</div>
<div class="paragraph data-line-1753">
<p>A more serious version of this bug occurred in the
<a href="http://bit.ly/2ACsfi1" data-href="http://bit.ly/2ACsfi1">King of
the Ether</a>. An excellent
<a href="http://bit.ly/2ESoaub" data-href="http://bit.ly/2ESoaub">post-mortem</a> of this
contract has been written that details how an unchecked failed <code>send</code>
could be used to attack the <span class="keep-together">contract</span>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1761">
<h3 id="frontrunning_security">Race Conditions/Front Running</h3>
<div class="paragraph data-line-1763">
<p>The combination of external calls to other contracts and the multiuser
nature of the underlying blockchain gives rise to a variety of potential
Solidity pitfalls whereby users <em>race</em> code execution to obtain
unexpected states. Reentrancy (discussed earlier in this chapter) is one example of such
a race condition. In this section we will discuss
other kinds of race conditions that can occur on the Ethereum
blockchain. There are a variety of good posts on this subject, including
&#x201c;Race Conditions&#x201d; on the <a href="http://bit.ly/2yFesFF" data-href="http://bit.ly/2yFesFF">Ethereum
Wiki</a>, <a href="http://www.dasp.co/#item-7" data-href="http://www.dasp.co/#item-7">#7 on the DASP Top10 of 2018</a>, and the
<a href="http://bit.ly/2Q6E4lP" data-href="http://bit.ly/2Q6E4lP">Ethereum Smart Contract Best Practices</a>.</p>
</div>
<div class="sect3 notoc data-line-1775">
<h4 id="_the_vulnerability_10">The Vulnerability</h4>
<div class="paragraph data-line-1777">
<p>As with most blockchains, Ethereum nodes pool transactions and form them
into blocks. The transactions are only considered valid once a miner has
solved a consensus mechanism (currently
<a href="http://bit.ly/2yI5Dv7" data-href="http://bit.ly/2yI5Dv7">Ethash</a> PoW for Ethereum).
The miner who solves the block also chooses which transactions from the
pool will be included in the block, typically ordered by the
<code>gasPrice</code> of each transaction. Here is a potential attack vector. An
attacker can watch the transaction pool for transactions that may
contain solutions to problems, and modify or revoke the solver&#8217;s
permissions or change state in a contract detrimentally to the
solver. The attacker can then get the data from this transaction and
create a transaction of their own with a higher <code>gasPrice</code> so their
transaction is included in a block before the original.</p>
</div>
<div class="paragraph data-line-1791">
<p>Let’s see how this could work with a simple example. Consider the
contract shown in <a href="#findthishash_security">FindThisHash.sol</a>.</p>
</div>
<div id="findthishash_security" class="exampleblock data-line-1796">
<div class="title">Example 16. FindThisHash.sol</div>
<div class="content">
<div class="listingblock data-line-1798">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract FindThisHash {
    bytes32 constant public hash =
      0xb5b5b97fafd9855eec9b41f74dfb6c38f5951141f9a3ecd7f44d5479b630ee0a;

    constructor() external payable {} // load with ether

    function solve(string solution) public {
        // If you can find the pre-image of the hash, receive 1000 ether
        require(hash == sha3(solution));
        msg.sender.transfer(1000 ether);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-1814">
<p>Say this contract contains 1,000 ether. The user who can find the
preimage of the following SHA-3 hash:</p>
</div>
<div class="listingblock data-line-1817">
<div class="content">
<pre>0xb5b5b97fafd9855eec9b41f74dfb6c38f5951141f9a3ecd7f44d5479b630ee0a</pre>
</div>
</div>
<div class="paragraph data-line-1821">
<p>can submit the solution and retrieve the 1,000 ether. Let&#8217;s say one user
figures out the solution is <code>Ethereum!</code>. They call <code>solve</code> with
<code>Ethereum!</code> as the parameter. Unfortunately, an attacker has been clever
enough to watch the transaction pool for anyone submitting a solution.
They see this solution, check its validity, and then submit an
equivalent transaction with a much higher <code>gasPrice</code> than the original
transaction. The miner who solves the block will likely give the
attacker preference due to the higher <code>gasPrice</code>, and mine their
transaction before the original solver&#8217;s. The attacker will take the 1,000
ether, and the user who solved the problem will get nothing. Keep in mind that in this type of "front-running" vulnerability, miners are uniquely incentivized to run the attacks themselves (or can be bribed to run these attacks with extravagant fees). The possibility of the attacker being a miner themselves should not be underestimated.</p>
</div>
</div>
<div class="sect3 notoc data-line-1833">
<h4 id="_preventative_techniques_10">Preventative Techniques</h4>
<div class="paragraph data-line-1835">
<p>There are two classes of actor who can perform these kinds of
front-running attacks: users (who modify the <code>gasPrice</code> of their
transactions) and miners themselves (who can reorder the transactions
in a block how they see fit). A contract that is vulnerable to the first
class (users) is significantly worse off than one vulnerable to the
second (miners), as miners can only perform the attack when they solve a
block, which is unlikely for any individual miner targeting a specific
block. Here we’ll list a few mitigation measures relative to both
classes of attackers.</p>
</div>
<div class="paragraph data-line-1845">
<p>One method is to place an upper bound on the <code>gasPrice</code>.
This prevents users from
increasing the <code>gasPrice</code> and getting preferential transaction ordering
beyond the upper bound. This measure only guards against the
first class of attackers (arbitrary users). Miners in this scenario can
still attack the contract, as they can order the transactions in their
block however they like, regardless of gas price.</p>
</div>
<div class="paragraph data-line-1853">
<p>A more robust method is to use a
<a href="http://bit.ly/2CUh2KS" data-href="http://bit.ly/2CUh2KS">commit–reveal</a>
scheme. Such a scheme dictates that users send
transactions with hidden information (typically a hash). After the
transaction has been included in a block, the user sends a transaction
revealing the data that was sent (the reveal phase). This method
prevents both miners and users from front-running transactions, as they
cannot determine the contents of the transaction. This method, however,
cannot conceal the transaction value (which in some cases is the
valuable information that needs to be hidden). The
<a href="https://ens.domains/" data-href="https://ens.domains/">ENS</a> smart contract allowed users to send
transactions whose committed data included the amount of ether they
were willing to spend. Users could then send transactions of arbitrary
value. During the reveal phase, users were refunded the difference
between the amount sent in the transaction and the amount they were
willing to spend.</p>
</div>
<div class="paragraph data-line-1870">
<p>A further suggestion by Lorenz Breidenbach, Phil Daian, Ari Juels, and Florian Tramèr is to use
<a href="http://bit.ly/2SygqQx" data-href="http://bit.ly/2SygqQx">&#x201c;submarine
sends&#x201d;</a>. An efficient implementation of this idea requires the <code>CREATE2</code>
opcode, which currently hasn’t been adopted but seems likely to be in
upcoming hard forks.</p>
</div>
</div>
<div class="sect3 data-line-1876">
<h4 id="_real_world_examples_erc20_and_bancor">Real-World Examples: ERC20 and Bancor</h4>
<div class="paragraph data-line-1878">
<p>The <a href="http://bit.ly/2CUf7WG" data-href="http://bit.ly/2CUf7WG">ERC20
standard</a> is quite well-known for building tokens on Ethereum. This
standard has a potential front-running vulnerability that comes about
due to the <code>approve</code> function. <a href="http://bit.ly/2DbvQpJ" data-href="http://bit.ly/2DbvQpJ">Mikhail Vladimirov and Dmitry Khovratovich</a> have written a good explanation of this
vulnerability (and ways to mitigate the attack).</p>
</div>
<div class="paragraph data-line-1884">
<p>The standard specifies the <code>approve</code> function as:</p>
</div>
<div class="listingblock data-line-1887">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function approve(address _spender, uint256 _value) returns (bool success)</code></pre>
</div>
</div>
<div class="paragraph data-line-1891">
<p>This function allows a user to permit other users to transfer tokens on
their behalf. The front-running vulnerability occurs in the scenario where
a user Alice <em>approves</em> her friend Bob to spend 100 tokens. Alice
later decides that she wants to revoke Bob’s approval to spend, say,
100 tokens, so she creates a transaction that sets Bob’s allocation
to 50 tokens. Bob, who has been carefully watching the chain, sees
this transaction and builds a transaction of his own spending the
100 tokens. He puts a higher <code>gasPrice</code> on his transaction than
Alice&#8217;s, so gets his transaction prioritized over hers. Some
implementations of <code>approve</code> would allow Bob to transfer his
100 tokens and then, when Alice’s transaction is committed, reset
Bob’s approval to 50 tokens, in effect giving Bob access to
150 tokens.</p>
</div>
<div class="paragraph data-line-1905">
<p>Another prominent real-world example is
<a href="https://www.bancor.network/" data-href="https://www.bancor.network/">Bancor</a>. Ivan Bogatyy and his team
documented a profitable attack on the initial Bancor implementation. His
<a href="http://bit.ly/2EUlLzb" data-href="http://bit.ly/2EUlLzb">blog
post</a> and <a href="http://bit.ly/2yHgkhs" data-href="http://bit.ly/2yHgkhs">DevCon3 talk</a>
discuss in detail how this was done. Essentially, prices of tokens are
determined based on transaction value; users can watch the transaction
pool for Bancor transactions and front-run them to profit from the price
differences. This attack has been addressed by the Bancor team.</p>
</div>
</div>
</div>
<div class="sect2 data-line-1915">
<h3 id="_denial_of_service_dos">Denial of Service (DoS)</h3>
<div class="paragraph data-line-1917">
<p>This category is very broad, but fundamentally consists of attacks where
users can render a contract inoperable for a period of time, or
in some cases permanently. This can trap ether in these contracts
forever, as was the case in <a href="#multisig_secondhack">Real-World Example: Parity Multisig Wallet (Second Hack)</a>.</p>
</div>
<div class="sect3 notoc data-line-1923">
<h4 id="_the_vulnerability_11">The Vulnerability</h4>
<div class="paragraph data-line-1925">
<p>There are various ways a contract can become inoperable. Here we
highlight just a few less-obvious Solidity
coding patterns that can lead to DoS vulnerabilities:</p>
</div>
<div class="dlist data-line-1929">
<dl>
<dt class="hdlist1">Looping through externally manipulated mappings or arrays</dt>
<dd>
<p>This pattern typically appears when an owner wishes to distribute tokens
to investors with a <code>distribute</code>-like function,
as in this example contract:</p>
<div class="listingblock data-line-1935">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract DistributeTokens {
    address public owner; // gets set somewhere
    address[] investors; // array of investors
    uint[] investorTokens; // the amount of tokens each investor gets

    // ... extra functionality, including transfertoken()

    function invest() external payable {
        investors.push(msg.sender);
        investorTokens.push(msg.value * 5); // 5 times the wei sent
        }

    function distribute() public {
        require(msg.sender == owner); // only owner
        for(uint i = 0; i &lt; investors.length; i++) {
            // here transferToken(to,amount) transfers "amount" of
            // tokens to the address "to"
            transferToken(investors[i],investorTokens[i]);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-1959">
<p>Notice that the loop in this contract runs over an array that can be
artificially inflated. An attacker can create many user accounts, making
the <code>investor</code> array large. In principle this can be done such that the
gas required to execute the for loop exceeds the block gas limit,
essentially making the <code>distribute</code> function inoperable.</p>
</div>
</dd>
<dt class="hdlist1">Owner operations</dt>
<dd>
<p>Another common pattern is where owners have
specific privileges in contracts and must perform some task in order for
the contract to proceed to the next state. One example would be an Initial Coin Offering (ICO)
contract that requires the owner to <code>finalize</code> the contract, which then
allows tokens to be transferable. For example:</p>
<div class="listingblock data-line-1973">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">bool public isFinalized = false;
address public owner; // gets set somewhere

function finalize() public {
    require(msg.sender == owner);
    isFinalized == true;
}

// ... extra ICO functionality

// overloaded transfer function
function transfer(address _to, uint _value) returns (bool) {
    require(isFinalized);
    super.transfer(_to,_value)
}

...</code></pre>
</div>
</div>
<div class="paragraph data-line-1993">
<p>In such cases, if the privileged user loses their private keys or becomes
inactive, the entire token contract becomes inoperable. In this case, if
the owner cannot call <span class="keep-together"><code>finalize</code></span> no tokens can be transferred;
the entire operation of the token ecosystem hinges on a single
address.</p>
</div>
</dd>
<dt class="hdlist1">Progressing state based on external calls</dt>
<dd>
<p>Contracts are sometimes written
such that progressing to a new state requires sending ether to an
address, or waiting for some input from an external source.  These patterns can
lead to DoS attacks when the external call fails or is prevented for external
reasons. In the example of sending ether, a user can create a contract that
does not accept ether. If a contract requires ether to be withdrawn in order to progress to a new state (consider a
time-locking contract that requires all ether to be withdrawn before being
usable again), the contract will never
achieve the new state, as ether can never be sent to the user&#8217;s contract that
does not accept ether.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 notoc data-line-2011">
<h4 id="_preventative_techniques_11">Preventative Techniques</h4>
<div class="paragraph data-line-2013">
<p>In the first example, contracts should not loop through data structures
that can be artificially manipulated by external users. A withdrawal
pattern is recommended, whereby each of the investors call a withdraw
function to claim tokens independently.</p>
</div>
<div class="paragraph data-line-2018">
<p>In the second example, a privileged user was required to change the state
of the contract. In such examples a failsafe can be
used in the event that the owner becomes incapacitated. One solution
is to make the owner a multisig contract. Another solution
is to use a time-lock: in the example given the require on line 5 could include a
time-based mechanism, such as
<code>require(msg.sender == owner || now &gt; unlockTime)</code>, that allows any user
to finalize after a period of time specified by <code>unlockTime</code>. This kind
of mitigation technique can be used in the third example also. If
external calls are required to progress to a new state, account for
their possible failure and potentially add a time-based state
progression in the event that the desired call never comes.</p>
</div>
<div class="admonitionblock note data-line-2032">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-2033">
<p>Of course, there are centralized alternatives to these suggestions:
one can add a <code>maintenanceUser</code> who can come along and fix
problems with DoS-based attack vectors if need be. Typically these kinds
of contracts have trust issues, because of the power of such an entity.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-2039">
<h4 id="_real_world_examples_governmental">Real-World Examples: GovernMental</h4>
<div class="paragraph data-line-2041">
<p><a href="http://governmental.github.io/GovernMental/" data-href="http://governmental.github.io/GovernMental/">GovernMental</a> was an old
Ponzi scheme that accumulated quite a large amount of ether (1,100 ether, at one point). Unfortunately, it was
susceptible to the DoS vulnerabilities mentioned in this section. A <a href="http://bit.ly/2DcgvFc" data-href="http://bit.ly/2DcgvFc">Reddit post</a> by etherik describes how the contract required the deletion of a large
mapping in order to withdraw the ether. The deletion of this mapping had
a gas cost that exceeded the block gas limit at the time, and thus it was
not possible to withdraw the 1,100 ether. The contract address is
<a href="http://bit.ly/2Oh8j7R" data-href="http://bit.ly/2Oh8j7R">0xF45717552f12Ef7cb65e95476F217Ea008167Ae3</a>,
and you can see from transaction <a href="http://bit.ly/2Ogzrnn" data-href="http://bit.ly/2Ogzrnn">0x0d80d67202bd9cb6773df8dd2020e719&amp;thinsp;0a1b0793e8ec4fc105257e8128f0506b</a> that the 1,100 ether were finally obtained with a transaction that used
2.5M gas (when the block gas limit had risen enough to allow such a transaction).</p>
</div>
</div>
</div>
<div class="sect2 data-line-2051">
<h3 id="_block_timestamp_manipulation">Block Timestamp Manipulation</h3>
<div class="paragraph data-line-2053">
<p>Block timestamps have historically been used for a variety of
applications, such as entropy for random numbers (see the
<a href="#entropyillusion_security">Entropy Illusion</a> for further details), locking
funds for periods of time, and various state-changing conditional
statements that are time-dependent. Miners have the ability to adjust
timestamps slightly, which can prove to be dangerous if block
timestamps are used incorrectly in smart contracts.</p>
</div>
<div class="paragraph data-line-2061">
<p>Useful references for this include
<a href="http://bit.ly/2OdUC9C" data-href="http://bit.ly/2OdUC9C">the
Solidity docs</a> and <a href="http://bit.ly/2CQ8gh4" data-href="http://bit.ly/2CQ8gh4">Joris Bontje&#8217;s Ethereum Stack
Exchange question</a> on the topic.</p>
</div>
<div class="sect3 notoc data-line-2067">
<h4 id="_the_vulnerability_12">The Vulnerability</h4>
<div class="paragraph data-line-2069">
<p><code>block.timestamp</code> and its alias <code>now</code> can be manipulated by miners if
they have some incentive to do so. Let&#8217;s construct a simple game, shown in <a href="#roulette_security">roulette.sol</a>, that
would be vulnerable to miner exploitation.</p>
</div>
<div id="roulette_security" class="exampleblock data-line-2075">
<div class="title">Example 17. roulette.sol</div>
<div class="content">
<div class="listingblock data-line-2077">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Roulette {
    uint public pastBlockTime; // forces one bet per block

    constructor() external payable {} // initially fund contract

    // fallback function used to make a bet
    function () external payable {
        require(msg.value == 10 ether); // must send 10 ether to play
        require(now != pastBlockTime); // only 1 transaction per block
        pastBlockTime = now;
        if(now % 15 == 0) { // winner
            msg.sender.transfer(this.balance);
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-2096">
<p>This contract behaves like a simple lottery. One transaction per block
can bet 10 ether for a chance to win the balance of the contract. The
assumption here is that `block.timestamp&#8217;s last two digits are uniformly distributed. If that were the case, there would be a 1 in 15
chance of winning this lottery.</p>
</div>
<div class="paragraph data-line-2101">
<p>However, as we know, miners can adjust the timestamp should they need
to. In this particular case, if enough ether pools in the contract, a
miner who solves a block is incentivized to choose a timestamp such that
<code>block.timestamp</code> or <code>now</code> modulo 15 is <code>0</code>. In doing so they may win
the ether locked in this contract along with the block reward. As there
is only one person allowed to bet per block, this is also vulnerable to
front-running attacks (see <a href="#frontrunning_security">Race Conditions/Front Running</a> for further details).</p>
</div>
<div class="paragraph data-line-2109">
<p>In practice, block timestamps are monotonically increasing and so miners
cannot choose arbitrary block timestamps (they must be later than their
predecessors). They are also limited to setting block times not too far
in the future, as these blocks will likely be rejected by the network
(nodes will not validate blocks whose timestamps are in the future).</p>
</div>
</div>
<div class="sect3 notoc data-line-2116">
<h4 id="_preventative_techniques_12">Preventative Techniques</h4>
<div class="paragraph data-line-2118">
<p>Block timestamps should not be used for entropy or generating random
numbers&#x2014;i.e., they should not be the deciding factor (either directly
or through some derivation) for winning a game or changing an important
state.</p>
</div>
<div class="paragraph data-line-2123">
<p>Time-sensitive logic is sometimes required; e.g., for unlocking contracts
(time-locking), completing an ICO after a few weeks, or enforcing expiry
dates. It is sometimes recommended to use <a href="http://bit.ly/2OdUC9C" data-href="http://bit.ly/2OdUC9C"><code>block.number</code></a> and an average block time to estimate times; with
a <code>10 second</code> block time, <code>1 week</code> equates to approximately, <code>60480 blocks</code>.
Thus, specifying a block number at which to change a contract state can
be more secure, as miners are unable to easily manipulate the block number. The
<a href="http://bit.ly/2AAebFr" data-href="http://bit.ly/2AAebFr">BAT
ICO</a> contract employed this strategy.</p>
</div>
<div class="paragraph data-line-2132">
<p>This can be unnecessary if contracts aren’t particularly concerned with
miner manipulations of the block timestamp, but it is something to be
aware of when developing contracts.</p>
</div>
</div>
<div class="sect3 data-line-2136">
<h4 id="_real_world_example_governmental">Real-World Example: GovernMental</h4>
<div class="paragraph data-line-2138">
<p><a href="http://governmental.github.io/GovernMental/" data-href="http://governmental.github.io/GovernMental/">GovernMental</a>, the old Ponzi scheme mentioned above, was also
vulnerable to a timestamp-based attack. The contract paid out to the
player who was the last player to join (for at least one minute) in a
round. Thus, a miner who was a player could adjust the timestamp (to a
future time, to make it look like a minute had elapsed) to make it
appear that they were the last player to join for over a minute (even
though this was not true in reality). More detail on this can be found in
the
<a href="http://bit.ly/2Q1AMA6" data-href="http://bit.ly/2Q1AMA6">&#x201c;History
of Ethereum Security Vulnerabilities, Hacks and Their Fixes&#x201d; post</a> by Tanya <span class="keep-together">Bahrynovska</span>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-2149">
<h3 id="_constructors_with_care">Constructors with Care</h3>
<div class="paragraph data-line-2151">
<p>Constructors are special functions that often perform critical,
privileged tasks when initializing contracts. Before Solidity v0.4.22,
constructors were defined as functions that had the same name as the
contract that contained them. In such cases, when the contract name is changed in
development, if the constructor name isn’t changed too it becomes a normal,
callable function. As you can imagine, this can lead (and has) to some
interesting contract hacks.</p>
</div>
<div class="paragraph data-line-2159">
<p>For further insight, the reader may be interested in attempting the
<a href="https://github.com/OpenZeppelin/ethernaut" data-href="https://github.com/OpenZeppelin/ethernaut">Ethernaut challenges</a> (in
particular the Fallout level).</p>
</div>
<div class="sect3 notoc data-line-2164">
<h4 id="_the_vulnerability_13">The Vulnerability</h4>
<div class="paragraph data-line-2166">
<p>If the contract name is modified, or there is a typo in the
constructor&#8217;s name such that it does not match the name of the
contract, the constructor will behave like a normal function. This can
lead to dire consequences, especially if the constructor performs
privileged operations. Consider the following contract:</p>
</div>
<div class="listingblock data-line-2173">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract OwnerWallet {
    address public owner;

    // constructor
    function ownerWallet(address _owner) public {
        owner = _owner;
    }

    // Fallback. Collect ether.
    function () payable {}

    function withdraw() public {
        require(msg.sender == owner);
        msg.sender.transfer(this.balance);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-2192">
<p>This contract collects ether and allows only the owner to withdraw it,
by calling the <code>withdraw</code> function. The issue arises because the constructor is not named exactly the same as the contract:
the first letter is different! Thus, any
user can call the <code>ownerWallet</code> function, set themselves as the owner,
and then take all the ether in the contract by calling <code>withdraw</code>.</p>
</div>
</div>
<div class="sect3 notoc data-line-2199">
<h4 id="_preventative_techniques_13">Preventative Techniques</h4>
<div class="paragraph data-line-2201">
<p>This issue has been addressed in version 0.4.22 of the Solidity compiler. This version introduced a <code>constructor</code> keyword that
specifies the constructor, rather than requiring the name of the
function to match the contract name. Using this keyword to specify
constructors is recommended to prevent naming issues.</p>
</div>
</div>
<div class="sect3 data-line-2206">
<h4 id="_real_world_example_rubixi">Real-World Example: Rubixi</h4>
<div class="paragraph data-line-2208">
<p><a href="http://bit.ly/2ESWG7t" data-href="http://bit.ly/2ESWG7t">Rubixi</a> was another pyramid scheme that exhibited this kind of
vulnerability. It was originally called <code>DynamicPyramid</code>, but the
contract name was changed before deployment to <code>Rubixi</code>. The
constructor’s name wasn’t changed, allowing any user to become the
creator. Some interesting discussion related to this bug can be found
on <a href="http://bit.ly/2P0TRWw" data-href="http://bit.ly/2P0TRWw">Bitcointalk</a>. Ultimately, it allowed users to fight for creator status to
claim the fees from the pyramid scheme. More detail on this particular
bug can be found in <a href="http://bit.ly/2Q1AMA6" data-href="http://bit.ly/2Q1AMA6">&#x201c;History of Ethereum Security Vulnerabilities, Hacks and Their Fixes&#x201d;</a>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-2217">
<h3 id="_uninitialized_storage_pointers">Uninitialized Storage Pointers</h3>
<div class="paragraph data-line-2219">
<p>The EVM stores data either as storage or as memory. Understanding
exactly how this is done and the default types for local variables of
functions is highly recommended when developing contracts. This is
because it is possible to produce vulnerable contracts by
inappropriately intializing variables.</p>
</div>
<div class="paragraph data-line-2225">
<p>To read more about storage and memory in the EVM, see the Solidity documentation on <a href="http://bit.ly/2OdUU0l" data-href="http://bit.ly/2OdUU0l">data location</a>, <a href="http://bit.ly/2JslDWf" data-href="http://bit.ly/2JslDWf">layout of state variables in storage</a>, and <a href="http://bit.ly/2Dch2Hc" data-href="http://bit.ly/2Dch2Hc">layout in memory</a>.</p>
</div>
<div class="admonitionblock note data-line-2228">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-2229">
<p>This section is based on an excellent
<a href="http://bit.ly/2ERI0pb" data-href="http://bit.ly/2ERI0pb">post
by Stefan Beyer</a>. Further reading on this topic, inspired by Stefan, can be found in this
<a href="http://bit.ly/2OgxPtG" data-href="http://bit.ly/2OgxPtG">Reddit
thread</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 notoc data-line-2237">
<h4 id="_the_vulnerability_14">The Vulnerability</h4>
<div class="paragraph data-line-2239">
<p>Local variables within functions default to storage or memory
depending on their type. Uninitialized local storage variables may
contain the value of other storage variables in the contract; this fact
can cause unintentional vulnerabilities, or be exploited deliberately.</p>
</div>
<div class="paragraph data-line-2244">
<p>Let’s consider the relatively simple name registrar contract in <a href="#nameregistrar_security">NameRegistrar.sol</a>.</p>
</div>
<div id="nameregistrar_security" class="exampleblock data-line-2248">
<div class="title">Example 18. NameRegistrar.sol</div>
<div class="content">
<div class="listingblock data-line-2250">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// A locked name registrar
contract NameRegistrar {

    bool public unlocked = false;  // registrar locked, no name updates

    struct NameRecord { // map hashes to addresses
        bytes32 name;
        address mappedAddress;
    }

    // records who registered names
    mapping(address =&gt; NameRecord) public registeredNameRecord;
    // resolves hashes to addresses
    mapping(bytes32 =&gt; address) public resolve;

    function register(bytes32 _name, address _mappedAddress) public {
        // set up the new NameRecord
        NameRecord newRecord;
        newRecord.name = _name;
        newRecord.mappedAddress = _mappedAddress;

        resolve[_name] = _mappedAddress;
        registeredNameRecord[msg.sender] = newRecord;

        require(unlocked); // only allow registrations if contract is unlocked
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-2281">
<p>This simple name registrar has only one function. When the contract is
<code>unlocked</code>, it allows anyone to register a name (as a <code>bytes32</code> hash)
and map that name to an address. The registrar is
initially locked, and the <code>require</code> on line 25 prevents <code>register</code>
from adding name records. It seems that the contract is unusable, as
there is no way to unlock the registry! There is, however, a vulnerability
that allows name registration regardless of the <code>unlocked</code> variable.</p>
</div>
<div class="paragraph data-line-2293">
<p>To discuss this vulnerability, first we need to understand how storage
works in Solidity. As a high-level overview (without any proper
technical detail&#x2014;we suggest reading the Solidity docs for a proper
review), state variables are stored sequentially in <em>slots</em> as they
appear in the contract (they can be grouped together but aren&#8217;t in this
example, so we won&#8217;t worry about that). Thus, <code>unlocked</code> exists in
<code>slot[0]</code>, <code>registeredNameRecord</code> in <code>slot[1]</code>, and <code>resolve</code> in
<code>slot[2]</code>, etc. Each of these slots is 32 bytes in size (there are added
complexities with mappings, which we&#8217;ll ignore for now). The Boolean
<code>unlocked</code> will look like <code>0x000&#8230;&#8203;0</code> (64 0s, excluding the <code>0x</code>) for
<code>false</code> or <code>0x000&#8230;&#8203;1</code> (63 0s) for <code>true</code>. As you can see, there is a
significant waste of storage in this particular example.</p>
</div>
<div class="paragraph data-line-2306">
<p>The next piece of the puzzle is that Solidity by default puts
complex data types, such as structs, in storage when initializing
them as local variables. Therefore, <span class="keep-together"><code>newRecord</code></span> on line 18 defaults to storage. The vulnerability is caused by the fact that <span class="keep-together"><code>newRecord</code></span> is
not initialized. Because it defaults to storage, it is mapped to
storage slot[0], which currently contains a pointer to <code>unlocked</code>.
Notice that on lines 19 and 20 we
then set <code>newRecord.name</code> to <code>_name</code> and <code>newRecord.mappedAddress</code> to <span class="keep-together"><code>_mappedAddress</code></span>; this updates the storage locations of slot[0]
and slot[1], which modifies both <code>unlocked</code> and the storage slot
associated with <code>registeredNameRecord</code>.</p>
</div>
<div class="paragraph data-line-2316">
<p>This means that <code>unlocked</code> can be directly modified, simply by the
<code>bytes32 _name</code> parameter of the <code>register</code> function. Therefore, if
the last byte of <code>_name</code> is nonzero, it will modify the last byte of
storage <code>slot[0]</code> and directly change <code>unlocked</code> to <code>true</code>. Such <code>_name</code>
values will cause the <code>require</code> call on line 25 to succeed, as we have set
<code>unlocked</code> to <code>true</code>. Try this in Remix. Note the function will pass
if you use a <code>_name</code> of the form:</p>
</div>
<div class="listingblock data-line-2324">
<div class="content">
<pre>0x0000000000000000000000000000000000000000000000000000000000000001</pre>
</div>
</div>
</div>
<div class="sect3 notoc data-line-2329">
<h4 id="_preventative_techniques_14">Preventative Techniques</h4>
<div class="paragraph data-line-2331">
<p>The Solidity compiler shows a warning for unintialized storage variables;
developers should pay careful attention to these warnings when
building smart contracts. The current version of Mist (0.10) doesn’t
allow these contracts to be compiled. It is often good practice to
explicitly use the <code>memory</code> or <code>storage</code> specifiers when dealing with complex types,
to ensure they behave as expected.</p>
</div>
</div>
<div class="sect3 data-line-2338">
<h4 id="_real_world_examples_openaddresslottery_and_cryptoroulette_honey_pots">Real-World Examples: OpenAddressLottery and CryptoRoulette Honey Pots</h4>
<div class="paragraph data-line-2340">
<p>A honey pot named <a href="http://bit.ly/2AAVnWD" data-href="http://bit.ly/2AAVnWD">OpenAddressLottery</a> was deployed that used this uninitialized storage variable quirk
to collect ether from some would-be hackers. The contract is rather
involved, so we will leave the analysis to the <a href="http://bit.ly/2OgxPtG" data-href="http://bit.ly/2OgxPtG">Reddit
thread</a> where the attack is quite clearly explained.</p>
</div>
<div class="paragraph data-line-2345">
<p>Another honey pot, <a href="http://bit.ly/2OfNGJ2" data-href="http://bit.ly/2OfNGJ2">CryptoRoulette</a>, also utilized this trick <span class="keep-together">to try</span> and collect some ether. If you
can’t figure out how the attack works, see
<a href="http://bit.ly/2OVkSL4" data-href="http://bit.ly/2OVkSL4">&#x201c;An
Analysis of a Couple Ethereum Honeypot Contracts&#x201d;</a> for an overview of
this contract and others.</p>
</div>
</div>
</div>
<div class="sect2 data-line-2351">
<h3 id="_floating_point_and_precision">Floating Point and Precision</h3>
<div class="paragraph data-line-2353">
<p>As of this writing (v0.4.24), Solidity does not support fixed-point and floating-point
numbers. This means that floating-point
representations must be constructed with integer types in Solidity. This
can lead to errors and vulnerabilities if not implemented correctly.</p>
</div>
<div class="admonitionblock note data-line-2359">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-2360">
<p>For further reading, see the
<a href="http://bit.ly/2Ogp2Ia" data-href="http://bit.ly/2Ogp2Ia">Ethereum
Contract Security Techniques and Tips wiki</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 notoc data-line-2366">
<h4 id="_the_vulnerability_15">The Vulnerability</h4>
<div class="paragraph data-line-2368">
<p>As there is no fixed-point type in Solidity, developers are required to
implement their own using the standard integer data types. There are a
number of pitfalls developers can run into during this process. We will
try to highlight some of these in this section.</p>
</div>
<div class="paragraph data-line-2373">
<p>Let&#8217;s begin with a code example (we&#8217;ll ignore over/underflow issues, discussed earlier in this chapter, for simplicity):</p>
</div>
<div class="listingblock data-line-2376">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract FunWithNumbers {
    uint constant public tokensPerEth = 10;
    uint constant public weiPerEth = 1e18;
    mapping(address =&gt; uint) public balances;

    function buyTokens() external payable {
        // convert wei to eth, then multiply by token rate
        uint tokens = msg.value/weiPerEth*tokensPerEth;
        balances[msg.sender] += tokens;
    }

    function sellTokens(uint tokens) public {
        require(balances[msg.sender] &gt;= tokens);
        uint eth = tokens/tokensPerEth;
        balances[msg.sender] -= tokens;
        msg.sender.transfer(eth*weiPerEth);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-2397">
<p>This simple token buying/selling contract has some obvious problems. Although the mathematical calculations
for buying and selling tokens are correct, the lack of floating-point
numbers will give erroneous results. For example, when buying tokens on
line 8, if the value is less than <code>1 ether</code> the initial division will
result in <code>0</code>, leaving the result of the final multiplication as <code>0</code> (e.g., <code>200 wei</code>
divided by <code>1e18</code> <code>weiPerEth</code> equals <code>0</code>). Similarly, when selling
tokens, any number of tokens less than <code>10</code> will also result in <code>0 ether</code>. In
fact, rounding here is always down, so selling <code>29 tokens</code> will result
in <code>2 ether</code>.</p>
</div>
<div class="paragraph data-line-2407">
<p>The issue with this contract is that the precision is only to the
nearest ether (i.e., 1e18 wei). This can get tricky when
dealing with decimals in
<a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md" data-href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md">ERC20</a>
tokens when you need higher precision.</p>
</div>
</div>
<div class="sect3 notoc data-line-2414">
<h4 id="_preventative_techniques_15">Preventative Techniques</h4>
<div class="paragraph data-line-2416">
<p>Keeping the right precision in your smart contracts is very important,
especially when dealing with ratios and rates that reflect economic
decisions.</p>
</div>
<div class="paragraph data-line-2420">
<p>You should ensure that any ratios or rates you are using allow for large
numerators in fractions. For example, we used the rate <code>tokensPerEth</code> in
our example. It would have been better to use <code>weiPerTokens</code>, which would
be a large number. To calculate the corresponding number of tokens we could do
<code>msg.value/weiPerTokens</code>. This would give a more precise result.</p>
</div>
<div class="paragraph data-line-2426">
<p>Another tactic to keep in mind is to be mindful of order of operations.
In our example, the calculation to purchase tokens was
<code>msg.value/weiPerEth*tokenPerEth</code>. Notice that the division occurs
before the multiplication. (Solidity, unlike some languages, guarantees to perform operations in the order in which they are written.) This example would have achieved a greater
precision if the calculation performed the multiplication first and then
the division; i.e., <code>msg.value*tokenPerEth/weiPerEth</code>.</p>
</div>
<div class="paragraph data-line-2433">
<p>Finally, when defining arbitrary precision for numbers it can be a good
idea to convert values to higher precision, perform all
mathematical operations, then finally convert back down to
the precision required for output. Typically uint256s are used (as they are
optimal for gas usage); these give approximately 60 orders of magnitude
in their range, some of which can be dedicated to the precision of
mathematical operations. It may be the case that it is better to keep
all variables in high precision in Solidity and convert back to lower
precisions in external apps (this is essentially how the <code>decimals</code>
variable works in ERC20 token
contracts). To see an example of how this can be done, we recommend looking at <a href="https://github.com/dapphub/ds-math" data-href="https://github.com/dapphub/ds-math">DS-Math</a>. It uses some
funky naming (&#x201c;wads&#x201d; and &#x201c;rays&#x201d;), but the concept is useful.</p>
</div>
</div>
<div class="sect3 data-line-2446">
<h4 id="_real_world_example_ethstick">Real-World Example: Ethstick</h4>
<div class="paragraph data-line-2448">
<p>The <a href="http://bit.ly/2Qb7PSB" data-href="http://bit.ly/2Qb7PSB">Ethstick contract</a> does not use extended precision; however, it deals with wei. So,
this contract will have issues of rounding, but only at the wei level
of precision. It has some more serious flaws, but these relate
back to the difficulty in getting entropy on the blockchain (see
<a href="#entropyillusion_security">Entropy Illusion</a>). For a further discussion of
the Ethstick contract, we’ll refer you to another post by Peter Vessenes,
<a href="http://bit.ly/2SwDnE0" data-href="http://bit.ly/2SwDnE0">&#x201c;Ethereum
Contracts Are Going to Be Candy for Hackers&#x201d;</a>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-2457">
<h3 id="_tx_origin_authentication">Tx.Origin Authentication</h3>
<div class="paragraph data-line-2459">
<p>Solidity has a global variable, <code>tx.origin</code>, which traverses the entire
call stack and contains the address of the account that originally sent
the call (or transaction). Using this variable for authentication in a smart contract leaves the contract vulnerable to a phishing-like
attack.</p>
</div>
<div class="admonitionblock note data-line-2465">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-2466">
<p>For further reading, see dbryson&#8217;s Ethereum <a href="http://bit.ly/2PxU1UM" data-href="http://bit.ly/2PxU1UM">Stack
Exchange question</a>,
<a href="http://bit.ly/2qm7ocJ" data-href="http://bit.ly/2qm7ocJ">&#x201c;Tx.Origin and Ethereum Oh My!&#x201d;</a> by Peter Vessenes, and
<a href="http://bit.ly/2P3KVA4" data-href="http://bit.ly/2P3KVA4">&#x201c;Solidity: Tx Origin Attacks&#x201d;</a> by Chris Coverdale.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3 notoc data-line-2473">
<h4 id="_the_vulnerability_16">The Vulnerability</h4>
<div class="paragraph data-line-2475">
<p>Contracts that authorize users using the <code>tx.origin</code> variable are
typically vulnerable to phishing attacks that can trick users into
performing authenticated actions on the vulnerable contract.</p>
</div>
<div class="paragraph data-line-2479">
<p>Consider the simple contract in <a href="#phishable_security">Phishable.sol</a>.</p>
</div>
<div id="phishable_security" class="exampleblock data-line-2483">
<div class="title">Example 19. Phishable.sol</div>
<div class="content">
<div class="listingblock data-line-2485">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract Phishable {
    address public owner;

    constructor (address _owner) {
        owner = _owner;
    }

    function () external payable {} // collect ether

    function withdrawAll(address _recipient) public {
        require(tx.origin == owner);
        _recipient.transfer(this.balance);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-2503">
<p>Notice that on line 11 the contract authorizes the <code>withdrawAll</code>
function using <code>tx.origin</code>. This contract allows for an attacker to
create an attacking contract of the form:</p>
</div>
<div class="listingblock data-line-2508">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">import "Phishable.sol";

contract AttackContract {

    Phishable phishableContract;
    address attacker; // The attacker's address to receive funds

    constructor (Phishable _phishableContract, address _attackerAddress) {
        phishableContract = _phishableContract;
        attacker = _attackerAddress;
    }

    function () payable {
        phishableContract.withdrawAll(attacker);
    }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-2527">
<p>The attacker might disguise this contract as their own private address and socially engineer the victim (the owner of the Phishable contract) to send some form of transaction to the address—perhaps sending this contract some amount of ether. The victim, unless careful, may not notice that
there is code at the attacker’s address, or the attacker might pass it off
as being a multisignature wallet or some advanced storage wallet (remember
that the source code of public contracts is not available by default).</p>
</div>
<div class="paragraph data-line-2532">
<p>In any case, if the victim sends a transaction with enough gas to the
<code>AttackContract</code> address, it will invoke the fallback function, which in
turn calls the <code>withdrawAll</code> function of the <code>Phishable</code> contract
with the parameter <code>attacker</code>. This will result in the withdrawal of all
funds from the <code>Phishable</code> contract to the <code>attacker</code> address. This is
because the address that first initialized the call was the victim
(i.e., the owner of the <code>Phishable</code> contract). Therefore, <code>tx.origin</code>
will be equal to <code>owner</code> and the <code>require</code> on line 11 of the
<code>Phishable</code> contract will pass.</p>
</div>
</div>
<div class="sect3 notoc data-line-2543">
<h4 id="_preventative_techniques_16">Preventative Techniques</h4>
<div class="paragraph data-line-2545">
<p><code>tx.origin</code> should not be used for authorization in smart contracts.
This isn’t to say that the <code>tx.origin</code> variable should never be used. It
does have some legitimate use cases in smart contracts. For example, if
one wanted to deny external contracts from calling the current contract,
one could implement a <code>require</code> of the form
<code>require(tx.origin == msg.sender)</code>. This prevents intermediate contracts
being used to call the current contract, limiting the contract to
regular codeless addresses.</p>
</div>
</div>
</div>
<div class="sect2 data-line-2555">
<h3 id="contract_libraries_sec">Contract Libraries</h3>
<div class="paragraph data-line-2557">
<p>There is a lot of existing code available for reuse, both deployed on-chain as callable libraries and off-chain as code template libraries. On-platform libraries, having been deployed, exist as bytecode smart contracts, so great care should be taken before using them in production. However, using well-established existing on-platform libraries comes with many advantages, such as being able to benefit from the latest upgrades, and saves you money and benefits the Ethereum ecosystem by reducing the total number of live contracts in Ethereum.</p>
</div>
<div class="paragraph data-line-2559">
<p>In Ethereum, the most widely used resource is the <a href="https://openzeppelin.org/" data-href="https://openzeppelin.org/">OpenZeppelin suite</a>, an ample library of contracts ranging from implementations of ERC20 and ERC721 tokens, to many flavors of crowdsale models, to simple behaviors commonly found in contracts, such as <code>Ownable</code>, <code>Pausable</code>, or <code>LimitBalance</code>. The contracts in this repository have been extensively tested and in some cases even function as <em>de facto</em> standard implementations. They are free to use, and are built and maintained by <a href="https://zeppelin.solutions" data-href="https://zeppelin.solutions">Zeppelin</a> together with an ever-growing list of external contributors.</p>
</div>
<div class="paragraph data-line-2561">
<p>Also from Zeppelin is <a href="https://zeppelinos.org/" data-href="https://zeppelinos.org/">ZeppelinOS</a>, an open source platform of services and tools to develop and manage smart contract applications securely. ZeppelinOS provides a layer on top of the EVM that makes it easy for developers to launch upgradeable DApps linked to an on-chain library of well-tested contracts that are themselves upgradeable. Different versions of these libraries can coexist on the Ethereum platform, and a vouching system allows users to propose or push improvements in different directions. A set of off-chain tools to debug, test, deploy, and monitor decentralized applications is also provided by the platform.</p>
</div>
<div class="paragraph data-line-2563">
<p>The project ethpm aims to organize the various resources that are developing in the ecosystem by providing a package management system. As such, their registry provides more examples for you to browse:</p>
</div>
<div class="ulist data-line-2565">
<ul>
<li class="data-line-2565">
<p>Website: <a href="https://www.ethpm.com/" class="undefined" data-href="https://www.ethpm.com/">https://www.ethpm.com/</a></p>
</li>
<li class="data-line-2566">
<p>Repository link: <a href="https://www.ethpm.com/registry" class="undefined" data-href="https://www.ethpm.com/registry">https://www.ethpm.com/registry</a></p>
</li>
<li class="data-line-2567">
<p>GitHub link: <a href="https://github.com/ethpm" class="undefined" data-href="https://github.com/ethpm">https://github.com/ethpm</a></p>
</li>
<li class="data-line-2568">
<p>Documentation: <a href="https://www.ethpm.com/docs/integration-guide" class="undefined" data-href="https://www.ethpm.com/docs/integration-guide">https://www.ethpm.com/docs/integration-guide</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2 data-line-2570">
<h3 id="_conclusions_6">Conclusions</h3>
<div class="paragraph data-line-2572">
<p>There is a lot for any developer working in the smart contract domain to know and understand. By following best practices in your smart contract design and code writing, you will avoid many severe pitfalls and traps.</p>
</div>
<div class="paragraph data-line-21">
<p>Perhaps the most fundamental software security principle is to maximize reuse of trusted code. In cryptography, this is so important it has been condensed into an adage: "Don&#8217;t roll your own crypto." In the case of smart contracts, this amounts to gaining as much as possible from freely available libraries that have been thoroughly vetted by the community.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="tokens_chapter">Jetons</h2>
<div class="sectionbody">
<div class="paragraph data-line-5">
<p>The word "token" derives from the Old English "tācen," meaning a sign or symbol. It is commonly used to refer to privately issued special-purpose coin-like items of insignificant intrinsic value, such as transportation tokens, laundry tokens, and arcade game tokens.</p>
</div>
<div class="paragraph data-line-7">
<p>Nowadays, "tokens" administered on blockchains are redefining the word to mean blockchain-based abstractions that can be owned and that represent assets, currency, or access rights.</p>
</div>
<div class="paragraph data-line-9">
<p>The association between the word "token" and insignificant value has a lot to do with the limited use of the physical versions of tokens. Often restricted to specific businesses, organizations, or locations, physical tokens are not easily exchangeable and typically have only one function. With blockchain tokens, these restrictions are lifted&#x2014;or, more accurately, completely redefinable. Many blockchain tokens serve multiple purposes globally and can be traded for each other or for other currencies on global liquid markets. With the restrictions on use and ownership gone, the "insignificant value" expectation is also a thing of the past.</p>
</div>
<div class="paragraph data-line-11">
<p>In this chapter, we look at various uses for tokens and how they are created. We also discuss attributes of tokens such as fungibility and intrinsicality. Finally, we examine the standards and technologies that they are based on, and experiment by building our own tokens.</p>
</div>
<div class="sect2 data-line-14">
<h3 id="tokens_use">How Tokens Are Used</h3>
<div class="paragraph data-line-16">
<p>The most obvious use of tokens is as digital private currencies. However, this is only one possible use. Tokens can be programmed to serve many different functions, often overlapping. For example, a token can simultaneously convey a voting right, an access right, and ownership of a resource. As the following list shows, currency is just the first "app":</p>
</div>
<div class="dlist data-line-18">
<dl>
<dt class="hdlist1">Currency</dt>
<dd>
<p>A token can serve as a form of currency, with a value determined through private trade.</p>
</dd>
<dt class="hdlist1">Resource</dt>
<dd>
<p>A token can represent a resource earned or produced in a sharing economy or resource-sharing environment; for example, a storage or CPU token representing resources that can be shared over a network.</p>
</dd>
<dt class="hdlist1">Asset</dt>
<dd>
<p>A token can represent ownership of an intrinsic or extrinsic, tangible or intangible asset; for example, gold, real estate, a car, oil, energy, MMOG items, etc.</p>
</dd>
<dt class="hdlist1">Access</dt>
<dd>
<p>A token can represent access rights and grant access to a digital or physical property, such as a discussion forum, an exclusive website, a hotel room, or a rental car.</p>
</dd>
<dt class="hdlist1">Equity</dt>
<dd>
<p>A token can represent shareholder equity in a digital organization (e.g., a DAO) or legal entity (e.g., a corporation).</p>
</dd>
<dt class="hdlist1">Voting</dt>
<dd>
<p>A token can represent voting rights in a digital or legal system.</p>
</dd>
<dt class="hdlist1">Collectible</dt>
<dd>
<p>A token can represent a digital collectible (e.g., CryptoPunks) or physical collectible (e.g., a painting).</p>
</dd>
<dt class="hdlist1">Identity</dt>
<dd>
<p>A token can represent a digital identity (e.g., avatar) or legal identity (e.g., national ID).</p>
</dd>
<dt class="hdlist1">Attestation</dt>
<dd>
<p>A token can represent a certification or attestation of fact by some authority or by a decentralized reputation system (e.g., marriage record, birth certificate, college degree).</p>
</dd>
<dt class="hdlist1">Utility</dt>
<dd>
<p>A token can be used to access or pay for a service.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-38">
<p>Often, a single token encompasses several of these functions. Sometimes it is hard to discern between them, as the physical equivalents have always been inextricably linked. For example, in the physical world, a driver&#8217;s license (attestation) is also an identity document (identity) and the two cannot be separated. In the digital realm, previously commingled functions can be separated and developed independently (e.g., an anonymous attestation).</p>
</div>
</div>
<div class="sect2 data-line-41">
<h3 id="tokens_fungibility">Tokens and Fungibility</h3>
<div class="paragraph data-line-43">
<p><a href="https://en.wikipedia.org/wiki/Fungibility" data-href="https://en.wikipedia.org/wiki/Fungibility">Wikipedia</a> says: "In economics, fungibility is the property of a good or a commodity whose individual units are essentially interchangeable."</p>
</div>
<div class="paragraph data-line-45">
<p>Tokens are fungible when we can substitute any single unit of the token for another without any difference in its value or function.</p>
</div>
<div class="paragraph data-line-47">
<p>Strictly speaking, if a token&#8217;s historical provenance can be tracked, then it is not entirely fungible. The ability to track provenance can lead to blacklisting and whitelisting, reducing or eliminating fungibility.</p>
</div>
<div class="paragraph data-line-49">
<p>Non-fungible tokens are tokens that each represent a unique tangible or intangible item and therefore are not interchangeable. For example, a token that represents ownership of a <em>specific</em> Van Gogh painting is not equivalent to another token that represents a Picasso, even though they might be part of the same "art ownership token" system. Similarly, a token representing a <em>specific</em> digital collectible such as a specific CryptoKitty is not interchangeable with any other CryptoKitty. Each non-fungible token is associated with a unique identifier, such as a serial number.</p>
</div>
<div class="paragraph data-line-51">
<p>We will see examples of both fungible and non-fungible tokens later in this chapter.</p>
</div>
<div class="admonitionblock note data-line-54">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-55">
<p>Note that "fungible" is often used to mean "directly exchangeable for money" (for example, a casino token can be "cashed in," while laundry tokens typically cannot). This is <em>not</em> the sense in which we use the word here.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2 data-line-59">
<h3 id="counterparty_risk">Counterparty Risk</h3>
<div class="paragraph data-line-61">
<p>Counterparty risk is the risk that the <em>other</em> party in a transaction will fail to meet their obligations. Some types of transactions suffer additional counterparty risk because there are more than two parties involved. For example, if you hold a certificate of deposit for a precious metal and you sell that to someone, there are at least three parties in that transaction: the seller, the buyer, and the custodian of the precious metal. Someone holds the physical asset; by necessity they become party to the fulfillment of the transaction and add counterparty risk to any transaction involving that asset. In general, when an asset is traded indirectly through the exchange of a token of ownership, there is additional counterparty risk from the custodian of the asset. Do they have the asset? Will they recognize (or allow) the transfer of ownership based on the transfer of a token (such as a certificate, deed, title, or digital token)? In the world of digital tokens representing assets, as in the nondigital world, it is important to understand who holds the asset that is represented by the token and what rules apply to that underlying asset.</p>
</div>
</div>
<div class="sect2 data-line-64">
<h3 id="tokens_intrinsicality">Tokens and Intrinsicality</h3>
<div class="paragraph data-line-66">
<p>The word "intrinsic" derives from the Latin "intra," meaning "from within."</p>
</div>
<div class="paragraph data-line-68">
<p>Some tokens represent digital items that are intrinsic to the blockchain. Those digital assets are governed by consensus rules, just like the tokens themselves. This has an important implication: tokens that represent intrinsic assets do not carry additional counterparty risk. If you hold the keys for a CryptoKitty, there is no other party holding that CryptoKitty for you&#x2014;you own it directly. The blockchain consensus rules apply and your ownership (i.e., control) of the private keys is equivalent to ownership of the asset, without any intermediary.</p>
</div>
<div class="paragraph data-line-70">
<p>Conversely, many tokens are used to represent <em>extrinsic</em> things, such as real estate, corporate voting shares, trademarks, and gold bars. The ownership of these items, which are not "within" the blockchain, is governed by law, custom, and policy, separate from the consensus rules that govern the token. In other words, token issuers and owners may still depend on real-world non-smart contracts. As a result, these extrinsic assets carry additional counterparty risk because they are held by custodians, recorded in external registries, or controlled by laws and policies outside the blockchain environment.</p>
</div>
<div class="paragraph data-line-72">
<p>One of the most important ramifications of blockchain-based tokens is the ability to convert extrinsic assets into intrinsic assets and thereby remove counterparty risk. A good example is moving from equity in a corporation (extrinsic) to an equity or voting token in a <em>DAO</em> or similar (intrinsic) organization.</p>
</div>
</div>
<div class="sect2 data-line-75">
<h3 id="using_tokens">Using Tokens: Utility or Equity</h3>
<div class="paragraph data-line-77">
<p>Almost all projects in Ethereum today launch with some kind of token. But do all these projects really need tokens? Are there any disadvantages to using a token, or will we see the slogan "tokenize all the things" come to fruition? In principle, the use of tokens can be seen as the ultimate management or organization tool. In practice, the integration of blockchain platforms, including Ethereum, into the existing structures of society means that, so far, there are many limitations to their applicability.</p>
</div>
<div class="paragraph data-line-79">
<p>Let&#8217;s start by clarifying the role of a token in a new project. The majority of projects are using tokens in one of two ways: either as "utility tokens" or as "equity tokens." Very often, those two roles are conflated.</p>
</div>
<div class="paragraph data-line-81">
<p>Utility tokens are those where the use of the token is required to gain access to a service, application, or resource. Examples of utility tokens include tokens that represent resources such as shared storage, or access to services such as social media networks.</p>
</div>
<div class="paragraph data-line-83">
<p>Equity tokens are those that represent shares in the control or ownership of something, such as a startup. Equity tokens can be as limited as nonvoting shares for distribution of dividends and profits, or as expansive as voting shares in a decentralized autonomous organization, where management of the platform is through some complex governance system based on votes by the token holders.</p>
</div>
<div class="sect3 data-line-86">
<h4 id="its_not_duck">It&#8217;s a Duck!</h4>
<div class="paragraph data-line-88">
<p>Many startups face a difficult problem: tokens are a great fundraising mechanism, but offering securities (equity) to the public is a regulated activity in most jurisdictions. By disguising equity tokens as utility tokens, many startups hope to get around these regulatory restrictions and raise money from a public offering while presenting it as a pre-sale of "service access vouchers" or, as we call them, utility tokens. Whether these thinly disguised equity offerings will be able to skirt the regulators remains to be seen.</p>
</div>
<div class="paragraph data-line-90">
<p>As the popular saying goes: "If it walks like a duck and quacks like a duck, it&#8217;s a duck." Regulators are not likely to be distracted by these semantic contortions; quite the opposite, they are more likely to see such legal sophistry as an attempt to deceive the public.</p>
</div>
</div>
<div class="sect3 data-line-93">
<h4 id="who_needs_utility_tokens">Utility Tokens: Who Needs Them?</h4>
<div class="paragraph data-line-95">
<p>The real problem is that utility tokens introduce significant risks and adoption barriers for startups. Perhaps in a distant future "tokenize all the things" will become reality, but at present the set of people who have an understanding of and desire to use a token is a subset of the already small cryptocurrency market.</p>
</div>
<div class="paragraph data-line-97">
<p>For a startup, each innovation represents a risk and a market filter. Innovation is taking the road least traveled, walking away from the path of tradition. It is already a lonely walk. If a startup is trying to innovate in a new area of technology, such as storage sharing over P2P networks, that is a lonely enough path. Adding a utility token to that innovation and requiring users to adopt tokens in order to use the service compounds the risk and increases the barriers to adoption. It&#8217;s walking off the already lonely trail of P2P storage innovation and into the wilderness.</p>
</div>
<div class="paragraph data-line-99">
<p>Think of each innovation as a filter. It limits adoption to the subset of the market that can become early adopters of this innovation. Adding a second filter compounds that effect, further limiting the addressable market. You are asking your early adopters to adopt not one but two completely new technologies: the novel application/platform/service you built, and the token economy.</p>
</div>
<div class="paragraph data-line-101">
<p>For a startup, each innovation introduces risks that increase the chance of failure of the startup. If you take your already risky startup idea and add a utility token, you are adding all the risks of the underlying platform (Ethereum), broader economy (exchanges, liquidity), regulatory environment (equity/commodity regulators), and technology (smart contracts, token standards). That&#8217;s a lot of risk for a startup.</p>
</div>
<div class="paragraph data-line-103">
<p>Advocates of "tokenize all the things" will likely counter that by adopting tokens they are also inheriting the market enthusiasm, early adopters, technology, innovation, and liquidity of the entire token economy. That is true too. The question is whether the benefits and enthusiasm outweigh the risks and uncertainties.</p>
</div>
<div class="paragraph data-line-105">
<p>Nevertheless, some of the most innovative business ideas are indeed taking place in the crypto realm. If regulators are not quick enough to adopt laws and support new business models, entrepreneurs and associated talent will seek to operate in other jurisdictions that are more crypto-friendly. This is already happening.</p>
</div>
<div class="paragraph data-line-107">
<p>Finally, at the beginning of this chapter, when introducing tokens, we discussed the colloquial meaning of "token" as "something of insignificant value." The underlying reason for the insignificant value of most tokens is because they can only be used in a very narrow context: one bus company, one laundromat, one arcade, one hotel, or one company store. Limited liquidity, limited applicability, and high conversion costs reduce the value of tokens until they are only of "token" value. So when you add a utility token to your platform, but the token can only be used on your single platform with a small market, you are recreating the conditions that made physical tokens worthless. This may indeed be the correct way to incorporate tokenization into your project. However, if in order to use your platform a user has to convert something into your utility token, use it, and then convert the remainder back into something more generally useful, you&#8217;ve created a company scrip. The switching costs of a digital token are orders of magnitude lower than for a physical token without a market, but they are not zero. Utility tokens that work across an entire industry sector will be very interesting and probably quite valuable. But if you set up your startup to have to bootstrap an entire industry standard in order to succeed, you may have already failed.</p>
</div>
<div class="admonitionblock note data-line-110">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-111">
<p>One of the benefits of deploying services on general-purpose platforms like Ethereum is being able to connect smart contracts (and therefore the utility of tokens) across projects, increasing the potential for liquidity and utility of tokens.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-114">
<p>Make this decision for the right reasons. Adopt a token because your application <em>cannot work without a token</em>. Adopt it because the token lifts a fundamental market barrier or solves an access problem. Don&#8217;t introduce a utility token because it is the only way you can raise money fast and you need to pretend it&#8217;s not a public securities offering.</p>
</div>
</div>
</div>
<div class="sect2 data-line-117">
<h3 id="token_std">Tokens on Ethereum</h3>
<div class="paragraph data-line-119">
<p>Blockchain tokens existed before Ethereum. In some ways, the first blockchain currency, Bitcoin, is a token itself. Many token platforms were also developed on Bitcoin and other cryptocurrencies before Ethereum. However, the introduction of the first token standard on Ethereum led to an explosion of tokens.</p>
</div>
<div class="paragraph data-line-121">
<p>Vitalik Buterin suggested tokens as one of the most obvious and useful applications of a generalized programmable blockchain such as Ethereum. In fact, in the first year of Ethereum, it was common to see Vitalik and others wearing T-shirts emblazoned with the Ethereum logo and a smart contract sample on the back. There were several variations of this T-shirt, but the most common showed an implementation of a token.</p>
</div>
<div class="paragraph data-line-123">
<p>Before we delve into the details of creating tokens on Ethereum, it is important to have an overview of how tokens work on Ethereum. Tokens are different from ether because the Ethereum protocol does not know anything about them. Sending ether is an intrinsic action of the Ethereum platform, but sending or even owning tokens is not. The ether balance of Ethereum accounts is handled at the protocol level, whereas the token balance of Ethereum accounts is handled at the smart contract level. In order to create a new token on Ethereum, you must create a new smart contract. Once deployed, the smart contract handles everything, including ownership, transfers, and access rights. You can write your smart contract to perform all the necessary actions any way you want, but it is probably wisest to follow an existing standard. We will look at such standards next. We discuss the pros and cons of the following standards at the end of the chapter.</p>
</div>
<div class="sect3 data-line-127">
<h4 id="ERC20_std">The ERC20 Token Standard</h4>
<div class="paragraph data-line-129">
<p>The first standard was introduced in November 2015 by Fabian Vogelsteller as an Ethereum Request for Comments (ERC). It was automatically assigned GitHub issue number 20, giving rise to the name "ERC20 token." The vast majority of tokens are currently based on the ERC20 standard. The ERC20 request for comments eventually became Ethereum Improvement Proposal 20 (EIP-20), but it is mostly still referred to by the original name, ERC20.</p>
</div>
<div class="paragraph data-line-131">
<p>ERC20 is a standard for <em>fungible tokens</em>, meaning that different units of an ERC20 token are interchangeable and have no unique properties.</p>
</div>
<div class="paragraph data-line-133">
<p><a href="http://bit.ly/2CUf7WG" data-href="http://bit.ly/2CUf7WG">The ERC20 standard</a> defines a common interface for contracts implementing a token, such that any compatible token can be accessed and used in the same way. The interface consists of a number of functions that must be present in every implementation of the standard, as well as some optional functions and attributes that may be added by developers.</p>
</div>
<div class="sect4 data-line-136">
<h5 id="ERC20_reqd_func">ERC20 required functions and events</h5>
<div class="paragraph data-line-138">
<p>An ERC20-compliant token contract must provide at least the following functions and events:</p>
</div>
<div class="dlist data-line-140">
<dl>
<dt class="hdlist1">totalSupply</dt>
<dd>
<p>Returns the total units of this token that currently exist. ERC20 tokens can have a fixed or a variable supply.</p>
</dd>
<dt class="hdlist1">balanceOf</dt>
<dd>
<p>Given an address, returns the token balance of that address.</p>
</dd>
<dt class="hdlist1">transfer</dt>
<dd>
<p>Given an address and amount, transfers that amount of tokens to that address, from the balance of the address that executed the transfer.</p>
</dd>
<dt class="hdlist1">transferFrom</dt>
<dd>
<p>Given a sender, recipient, and amount, transfers tokens from one account to another. Used in combination with approve.</p>
</dd>
<dt class="hdlist1">approve</dt>
<dd>
<p>Given a recipient address and amount, authorizes that address to execute several transfers up to that amount, from the account that issued the approval.</p>
</dd>
<dt class="hdlist1">allowance</dt>
<dd>
<p>Given an owner address and a spender address, returns the remaining amount that the spender is approved to withdraw from the owner.</p>
</dd>
<dt class="hdlist1">Transfer</dt>
<dd>
<p>Event triggered upon a successful transfer (call to transfer or transferFrom) (even for zero-value transfers).</p>
</dd>
<dt class="hdlist1">Approval</dt>
<dd>
<p>Event logged upon a successful call to approve.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4 data-line-157">
<h5 id="ERC20_optional_func">ERC20 optional functions</h5>
<div class="paragraph data-line-159">
<p>In addition to the required functions listed in the previous section, the following optional functions are also defined by the standard:</p>
</div>
<div class="dlist data-line-161">
<dl>
<dt class="hdlist1">name</dt>
<dd>
<p>Returns the human-readable name (e.g., "US Dollars") of the token.</p>
</dd>
<dt class="hdlist1">symbol</dt>
<dd>
<p>Returns a human-readable symbol (e.g., "USD") for the token.</p>
</dd>
<dt class="hdlist1">decimals</dt>
<dd>
<p>Returns the number of decimals used to divide token amounts. For example, if decimals is 2, then the token amount is divided by 100 to get its user <span class="keep-together">representation</span>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4 data-line-168">
<h5 id="ERC20_interface">The ERC20 interface defined in Solidity</h5>
<div class="paragraph data-line-170">
<p>Here&#8217;s what an ERC20 interface specification looks like in Solidity:</p>
</div>
<div id="ERC20_interface_example" class="listingblock data-line-174">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract ERC20 {
   function totalSupply() constant returns (uint theTotalSupply);
   function balanceOf(address _owner) constant returns (uint balance);
   function transfer(address _to, uint _value) returns (bool success);
   function transferFrom(address _from, address _to, uint _value) returns
      (bool success);
   function approve(address _spender, uint _value) returns (bool success);
   function allowance(address _owner, address _spender) constant returns
      (uint remaining);
   event Transfer(address indexed _from, address indexed _to, uint _value);
   event Approval(address indexed _owner, address indexed _spender, uint _value);
}</code></pre>
</div>
</div>
</div>
<div class="sect4 data-line-190">
<h5 id="ERC20_data_struct">ERC20 data structures</h5>
<div class="paragraph data-line-192">
<p>If you examine any ERC20 implementation you will see that it contains two data structures, one to track balances and one to track allowances. In Solidity, they are implemented with a <em>data mapping</em>.</p>
</div>
<div class="paragraph data-line-194">
<p>The first data mapping implements an internal table of token balances, by owner. This allows the token contract to keep track of who owns the tokens. Each transfer is a deduction from one balance and an addition to another balance:</p>
</div>
<div id="balance_mapping" class="listingblock data-line-198">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">mapping(address =&gt; uint256) balances;</code></pre>
</div>
</div>
<div class="paragraph data-line-202">
<p>The second data structure is a data mapping of allowances. As we will see in the next section, with ERC20 tokens an owner of a token can delegate authority to a spender, allowing them to spend a specific amount (allowance) from the owner&#8217;s balance. The ERC20 contract keeps track of the allowances with a two-dimensional mapping, with the primary key being the address of the token owner, mapping to a spender address and an allowance amount:</p>
</div>
<div id="allowance_mapping" class="listingblock data-line-206">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">mapping (address =&gt; mapping (address =&gt; uint256)) public allowed;</code></pre>
</div>
</div>
</div>
<div class="sect4 data-line-212">
<h5 id="transfer_workflows">ERC20 workflows: "transfer" and "approve &amp; transferFrom"</h5>
<div class="paragraph data-line-214">
<p>The ERC20 token standard has two transfer functions. You might be wondering why.</p>
</div>
<div class="paragraph data-line-216">
<p>ERC20 allows for two different workflows. The first is a single-transaction, straightforward workflow using the transfer function. This workflow is the one used by wallets to send tokens to other wallets. The vast majority of token transactions happen with the transfer workflow.</p>
</div>
<div class="paragraph data-line-218">
<p>Executing the transfer contract is very simple. If Alice wants to send 10 tokens to Bob, her wallet sends a transaction to the token contract&#8217;s address, calling the <span class="keep-together"><code>transfer</code></span> function with Bob&#8217;s address and 10 as the arguments. The token contract adjusts Alice&#8217;s balance (&#x2013;10) and Bob&#8217;s balance (+10) and issues a Transfer event.</p>
</div>
<div class="paragraph data-line-220">
<p>The second workflow is a two-transaction workflow that uses approve followed by transferFrom. This workflow allows a token owner to delegate their control to another address. It is most often used to delegate control to a contract for distribution of tokens, but it can also be used by exchanges.</p>
</div>
<div class="paragraph data-line-222">
<p>For example, if a company is selling tokens for an ICO, they can approve a crowdsale contract address to distribute a certain amount of tokens. The crowdsale contract can then transferFrom the token contract owner&#8217;s balance to each buyer of the token, as illustrated in <a href="#approve_transferFrom_workflow">The two-step approve &amp; transferFrom workflow of ERC20 tokens</a>.</p>
</div>
<div class="admonitionblock note data-line-225">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-226">
<p>An <em>Initial Coin Offering</em> (ICO) is a crowdfunding mechanism used by companies and organizations to raise money by selling tokens. The term is derived from Initial Public Offering (IPO), which is the process by which a public company offers shares for sale to investors on a stock exchange. Unlike the highly regulated IPO markets, ICOs are open, global, and messy. The examples and explanations of ICOs in this book are not an endorsement of this type of fundraising.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="approve_transferFrom_workflow" class="imageblock data-line-231">
<div class="content">
<img src="images/approve_transferFrom_workflow.png" alt="The two-step approve &amp; transferFrom workflow of ERC20 tokens">
</div>
<div class="title">Figure 38. The two-step approve &amp; transferFrom workflow of ERC20 tokens</div>
</div>
<div class="paragraph data-line-233">
<p>For the approve &amp; transferFrom workflow, two transactions are needed. Let&#8217;s say that Alice wants to allow the AliceICO contract to sell 50% of all the AliceCoin tokens to buyers like Bob and Charlie. First, Alice launches the AliceCoin ERC20 contract, issuing all the AliceCoin to her own address. Then, Alice launches the AliceICO contract that can sell tokens for ether. Next, Alice initiates the approve &amp; transferFrom workflow. She sends a transaction to the AliceCoin contract, calling approve with the address of the AliceICO contract and 50% of the totalSupply as arguments. This will trigger the Approval event. Now, the AliceICO contract can sell AliceCoin.</p>
</div>
<div class="paragraph data-line-235">
<p>When the AliceICO contract receives ether from Bob, it needs to send some AliceCoin to Bob in return. Within the AliceICO contract is an exchange rate between AliceCoin and ether. The exchange rate that Alice set when she created the AliceICO contract determines how many tokens Bob will receive for the amount of ether sent to the AliceICO contract. When the AliceICO contract calls the AliceCoin transferFrom function, it sets Alice&#8217;s address as the sender and Bob&#8217;s address as the recipient, and uses the exchange rate to determine how many AliceCoin tokens will be transferred to Bob in the value field. The AliceCoin contract transfers the balance from Alice&#8217;s address to Bob&#8217;s address and triggers a Transfer event. The AliceICO contract can call transferFrom an unlimited number of times, as long as it doesn&#8217;t exceed the approval limit Alice set. The AliceICO contract can keep track of how many AliceCoin tokens it can sell by calling the allowance function.</p>
</div>
</div>
<div class="sect4 data-line-238">
<h5 id="ERC20_implementation">ERC20 implementations</h5>
<div class="paragraph data-line-240">
<p>While it is possible to implement an ERC20-compatible token in about 30 lines of Solidity code, most implementations are more complex. This is to account for potential security vulnerabilities. There are two implementations mentioned in the EIP-20 standard:</p>
</div>
<div class="dlist data-line-242">
<dl>
<dt class="hdlist1"><a href="http://bit.ly/2EUYCMR" data-href="http://bit.ly/2EUYCMR">Consensys EIP20</a></dt>
<dd>
<p>A simple and easy-to-read implementation of an ERC20-compatible token.</p>
</dd>
<dt class="hdlist1"><a href="https://bit.ly/2xPYck6" data-href="https://bit.ly/2xPYck6">OpenZeppelin StandardToken</a></dt>
<dd>
<p>This implementation is ERC20-compatible, with additional security precautions. It forms the basis of OpenZeppelin libraries implementing more complex ERC20-compatible tokens with fundraising caps, auctions, vesting schedules, and other features.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3 data-line-247">
<h4 id="METoken_example">Launching Our Own ERC20 Token</h4>
<div class="paragraph data-line-249">
<p>Let&#8217;s create and launch our own token. For this example, we will use the Truffle framework. The example assumes you have already installed truffle and configured it, and are familiar with its basic operation (for details, see <a href="#truffle">Truffle</a>).</p>
</div>
<div class="paragraph data-line-251">
<p>We will call our token "Mastering Ethereum Token,&#x201d; with the symbol "MET."</p>
</div>
<div class="admonitionblock note data-line-254">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-255">
<p>You can find this example <a href="https://github.com/ethereumbook/ethereumbook/blob/develop/code/truffle/METoken" data-href="https://github.com/ethereumbook/ethereumbook/blob/develop/code/truffle/METoken">in the book&#8217;s GitHub repository</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-258">
<p>First, let&#8217;s create and initialize a Truffle project directory. Run these four commands and accept the default answers to any questions:</p>
</div>
<pre data-type="programlist">
$ <strong>mkdir METoken</strong>
$ <strong>cd METoken</strong>
METoken $ <strong>truffle init</strong>
METoken $ <strong>npm init</strong>
</pre>
<div class="paragraph data-line-269">
<p>You should now have the following directory structure:</p>
</div>
<div id="truffle_directory" class="listingblock data-line-272">
<div class="content">
<pre>METoken/
+---- contracts
|   `---- Migrations.sol
+---- migrations
|   `---- 1_initial_migration.js
+---- package.json
+---- test
+---- truffle-config.js
`---- truffle.js</pre>
</div>
</div>
<div class="paragraph data-line-284">
<p>Edit the <em>truffle.js</em> or <em>truffle-config.js</em> configuration file to set up your Truffle environment, or copy the latter from <a href="http://bit.ly/2DdP2mz" data-href="http://bit.ly/2DdP2mz">the repository</a>.</p>
</div>
<div class="paragraph data-line-286">
<p>If you use the example <em>truffle-config.js</em>, remember to create a file <em>.env</em> in the <em>METoken</em> folder containing your test private keys for testing and deployment on public Ethereum test networks, such as Ropsten or Kovan. You can export your test network private key from MetaMask.</p>
</div>
<div class="paragraph data-line-288">
<p>After that your directory should look like:</p>
</div>
<div id="truffle_directory_metoken" class="listingblock data-line-291">
<div class="content">
<pre>METoken/
+---- contracts
|   `---- Migrations.sol
+---- migrations
|   `---- 1_initial_migration.js
+---- package.json
+---- test
+---- truffle-config.js
+---- truffle.js
`---- .env *new file*</pre>
</div>
</div>
<div class="admonitionblock warning data-line-305">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-306">
<p>Only use test keys or test mnemonics that are <em>not</em> used to hold funds on the main Ethereum network. <em>Never</em> use keys that hold real money for testing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-309">
<p>For our example, we will import the OpenZeppelin library, which implements some important security checks and is easy to extend:</p>
</div>
<pre data-type="programlist">
$ <strong>npm install openzeppelin-solidity@1.12.0</strong>

+ openzeppelin-solidity@1.12.0
added 1 package from 1 contributor and audited 2381 packages in 4.074s
</pre>
<div class="paragraph data-line-320">
<p>The openzeppelin-solidity package will add about 250 files under the <em>node_modules</em> directory. The OpenZeppelin library includes a lot more than the ERC20 token, but we will only use a small part of it.</p>
</div>
<div class="paragraph data-line-322">
<p>Next, let&#8217;s write our token contract. Create a new file, <em>METoken.sol</em>, and copy the example code from <a href="http://bit.ly/2qfIFH0" data-href="http://bit.ly/2qfIFH0">GitHub</a>.</p>
</div>
<div class="paragraph data-line-324">
<p>Our contract, shown in <a href="#solidity_token_example">METoken.sol: A Solidity contract implementing an ERC20 token</a>, is very simple, as it inherits all its functionality from the OpenZeppelin library.</p>
</div>
<div id="solidity_token_example" class="exampleblock data-line-328">
<div class="title">Example 20. METoken.sol: A Solidity contract implementing an ERC20 token</div>
<div class="content">
<div class="listingblock data-line-330">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.21;

import 'openzeppelin-solidity/contracts/token/ERC20/StandardToken.sol';

contract METoken is StandardToken {
    string public constant name = 'Mastering Ethereum Token';
    string public constant symbol = 'MET';
    uint8 public constant decimals = 2;
    uint constant _initial_supply = 2100000000;

    function METoken() public {
        totalSupply_ = _initial_supply;
        balances[msg.sender] = _initial_supply;
        emit Transfer(address(0), msg.sender, _initial_supply);
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-335">
<p>Here, we are defining the optional variables name, symbol, and decimals. We also define an _initial_supply variable, set to 21 million tokens; with two decimals of subdivision that gives 2.1 billion total units. In the contract&#8217;s initialization (constructor) function we set the totalSupply to be equal to _initial_supply and allocate all of the _initial_supply to the balance of the account (msg.sender) that creates the METoken contract.</p>
</div>
<div class="paragraph data-line-337">
<p>We now use truffle to compile the METoken code:</p>
</div>
<pre data-type="programlist">
$ <strong>truffle compile</strong>
Compiling ./contracts/METoken.sol...
Compiling ./contracts/Migrations.sol...
Compiling openzeppelin-solidity/contracts/math/SafeMath.sol...
Compiling openzeppelin-solidity/contracts/token/ERC20/BasicToken.sol...
Compiling openzeppelin-solidity/contracts/token/ERC20/ERC20.sol...
Compiling openzeppelin-solidity/contracts/token/ERC20/ERC20Basic.sol...
Compiling openzeppelin-solidity/contracts/token/ERC20/StandardToken.sol...
</pre>
<div class="paragraph data-line-352">
<p>As you can see, truffle incorporates necessary dependencies from the OpenZeppelin libraries and compiles those contracts too.</p>
</div>
<div class="paragraph data-line-354">
<p>Let&#8217;s set up a migration script to deploy the METoken contract. Create a new file called <em>2_deploy_contracts.js</em>, in the <em>METoken/migrations</em> folder. Copy the contents from the example <a href="http://bit.ly/2P0rHLl" data-href="http://bit.ly/2P0rHLl">in the GitHub repository</a>:</p>
</div>
<div id="METoken_migration" class="listingblock data-line-0">
<div class="title">2_deploy_contracts: Migration to deploy METoken</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var METoken = artifacts.require("METoken");

module.exports = function(deployer) {
  // Deploy the METoken contract as our only task
  deployer.deploy(METoken);
};</code></pre>
</div>
</div>
<div class="paragraph data-line-364">
<p>Before we deploy on one of the Ethereum test networks, let&#8217;s start a local blockchain to test everything. Start the ganache blockchain, either from the command line with ganache-cli or from the graphical user interface.</p>
</div>
<div class="paragraph data-line-366">
<p>Once ganache is started, we can deploy our METoken contract and see if everything works as expected:</p>
</div>
<pre data-type="programlist">
$ <strong>truffle migrate --network ganache</strong>
Using network 'ganache'.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  ... 0xb2e90a056dc6ad8e654683921fc613c796a03b89df6760ec1db1084ea4a084eb
  Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0
Saving successful migration to network...
  ... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying METoken...
  ... 0xbe9290d59678b412e60ed6aefedb17364f4ad2977cfb2076b9b8ad415c5dc9f0
  METoken: 0x345ca3e014aaf5dca488057592ee47305d9b3e10
Saving successful migration to network...
  ... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0
Saving artifacts...
</pre>
<div class="paragraph data-line-390">
<p>On the ganache console, we should see that our deployment has created four new transactions, as depicted in <a href="#ganache_METoken">METoken deployment on ganache</a>.</p>
</div>
<div id="ganache_METoken" class="imageblock data-line-394">
<div class="content">
<img src="images/ganache_metoken.png" alt="METoken deployment on Ganache">
</div>
<div class="title">Figure 39. METoken deployment on ganache</div>
</div>
<div class="sect4 data-line-397">
<h5 id="truffle_console">Interacting with METoken using the Truffle console</h5>
<div class="paragraph data-line-399">
<p>We can interact with our contract on the ganache blockchain using the Truffle console. This is an interactive JavaScript environment that provides access to the Truffle environment and, via web3, to the blockchain. In this case, we will connect the Truffle console to the ganache blockchain:</p>
</div>
<pre data-type="programlist">
$ <strong>truffle console --network ganache</strong>
truffle(ganache)&gt;
</pre>
<div class="paragraph data-line-408">
<p>The truffle(ganache)&gt; prompt shows that we are connected to the ganache blockchain and are ready to type our commands. The Truffle console supports all the truffle commands, so we could compile and migrate from the console. We&#8217;ve already run those commands, so let&#8217;s go directly to the contract itself. The METoken contract exists as a JavaScript object within the Truffle environment. Type **METoken** at the prompt and it will dump the entire contract definition:</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>METoken</strong>
{ [Function: TruffleContract]
  _static_methods:

[...]

currentProvider:
 HttpProvider {
   host: 'http://localhost:7545',
   timeout: 0,
   user: undefined,
   password: undefined,
   headers: undefined,
   send: [Function],
   sendAsync: [Function],
   _alreadyWrapped: true },
network_id: '5777' }
</pre>
<div class="paragraph data-line-432">
<p>The METoken object also exposes several attributes, such as the address of the contract (as deployed by the migrate command):</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>METoken.address</strong>
'0x345ca3e014aaf5dca488057592ee47305d9b3e10'
</pre>
<div class="paragraph data-line-441">
<p>If we want to interact with the deployed contract, we have to use an asynchronous call, in the form of a JavaScript "promise." We use the deployed function to get the contract instance and then call the totalSupply function:</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>METoken.deployed().then(instance => instance.totalSupply())</strong>
BigNumber { s: 1, e: 9, c: [ 2100000000 ] }
</pre>
<div class="paragraph data-line-450">
<p>Next, let&#8217;s use the accounts created by ganache to check our METoken balance and send some METoken to another address. First, let&#8217;s get the account addresses:</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>let accounts</strong>
undefined
truffle(ganache)&gt; <strong>web3.eth.getAccounts((err,res) => { accounts = res })</strong>
undefined
truffle(ganache)&gt; <strong>accounts[0]</strong>
'0x627306090abab3a6e1400e9345bc60c78a8bef57'
</pre>
<div class="paragraph data-line-463">
<p>The accounts list now contains all the accounts created by ganache, and account[0] is the account that deployed the METoken contract. It should have a balance of <span class="keep-together">METoken</span>, because our METoken constructor gives the entire token supply to the address that created it. Let&#8217;s check:</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =></strong>
                  <strong>{ instance.balanceOf(accounts[0]).then(console.log) })</strong>
undefined
truffle(ganache)&gt; <strong>BigNumber { s: 1, e: 9, c: [ 2100000000 ] }</strong>
</pre>
<div class="paragraph data-line-474">
<p>Finally, let&#8217;s transfer 1000.00 METoken from account[0] to account[1], by calling the contract&#8217;s transfer function:</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.transfer(accounts[1], 100000) })</strong>
undefined
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.balanceOf(accounts[0]).then(console.log) })</strong>
undefined
truffle(ganache)&gt; <strong>BigNumber { s: 1, e: 9, c: [ 2099900000 ] }</strong>
undefined
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.balanceOf(accounts[1]).then(console.log) })</strong>
undefined
truffle(ganache)&gt; <strong>BigNumber { s: 1, e: 5, c: [ 100000 ] }</strong>
</pre>
<div class="admonitionblock tip data-line-494">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-495">
<p>METoken has 2 decimals of precision, meaning that 1 METoken is 100 units in the contract. When we transfer 1,000 METoken, we specify the value as 100000 in the call to the transfer function.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-498">
<p>As you can see, in the console, account[0] now has 20,999,000 MET, and account[1] has 1,000 MET.</p>
</div>
<div class="paragraph data-line-500">
<p>If you switch to the ganache graphical user interface, as shown in <a href="#ganache_METoken_transfer">METoken transfer on ganache</a>, you will see the transaction that called the transfer function.</p>
</div>
<div id="ganache_METoken_transfer" class="imageblock data-line-504">
<div class="content">
<img src="images/ganache_metoken_transfer.png" alt="METoken transfer on Ganache">
</div>
<div class="title">Figure 40. METoken transfer on ganache</div>
</div>
</div>
<div class="sect4 data-line-507">
<h5 id="sending_erc20_tokens_contracts">Sending ERC20 tokens to contract addresses</h5>
<div class="paragraph data-line-509">
<p>So far, we&#8217;ve set up an ERC20 token and transferred some tokens from one account to another. All the accounts we used for these demonstrations are externally owned accounts, meaning they are controlled by a private key, not a contract. What happens if we send MET to a contract address? Let&#8217;s find out!</p>
</div>
<div class="paragraph data-line-511">
<p>First, let&#8217;s deploy another contract into our test environment. For this example, we will use our first contract, <em>Faucet.sol</em>. Let&#8217;s add it to the METoken project by copying it to the <em>contracts</em> directory. Our directory should look like this:</p>
</div>
<div id="METoken_directory" class="listingblock data-line-514">
<div class="content">
<pre>METoken/
+---- contracts
|   +---- Faucet.sol
|   +---- METoken.sol
|   `---- Migrations.sol</pre>
</div>
</div>
<div class="paragraph data-line-522">
<p>We&#8217;ll also add a migration, to deploy Faucet separately from METoken:</p>
</div>
<div id="faucet_migration" class="listingblock data-line-526">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">var Faucet = artifacts.require("Faucet");

module.exports = function(deployer) {
  // Deploy the Faucet contract as our only task
  deployer.deploy(Faucet);
};</code></pre>
</div>
</div>
<div class="paragraph data-line-535">
<p>Let&#8217;s compile and migrate the contracts from the Truffle console:</p>
</div>
<pre data-type="programlist">
$ <strong>truffle console --network ganache</strong>
truffle(ganache)&gt; <strong>compile</strong>
Compiling ./contracts/Faucet.sol...
Writing artifacts to ./build/contracts

truffle(ganache)&gt; <strong>migrate</strong>
Using network 'ganache'.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  ... 0x89f6a7bd2a596829c60a483ec99665c7af71e68c77a417fab503c394fcd7a0c9
  Migrations: 0xa1ccce36fb823810e729dce293b75f40fb6ea9c9
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Replacing METoken...
  ... 0x28d0da26f48765f67e133e99dd275fac6a25fdfec6594060fd1a0e09a99b44ba
  METoken: 0x7d6bf9d5914d37bcba9d46df7107e71c59f3791f
Saving artifacts...
Running migration: 3_deploy_faucet.js
  Deploying Faucet...
  ... 0x6fbf283bcc97d7c52d92fd91f6ac02d565f5fded483a6a0f824f66edc6fa90c3
  Faucet: 0xb18a42e9468f7f1342fa3c329ec339f254bc7524
Saving artifacts...
</pre>
<div class="paragraph data-line-565">
<p>Great. Now let&#8217;s send some MET to the Faucet contract:</p>
</div>
<pre data-type="programlist">
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.transfer(Faucet.address, 100000) })</strong>
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.balanceOf(Faucet.address).then(console.log)})</strong>
truffle(ganache)&gt; <strong>BigNumber { s: 1, e: 5, c: [ 100000 ] }</strong>
</pre>
<div class="paragraph data-line-577">
<p>Alright, we have transferred 1,000 MET to the Faucet contract. Now, how do we withdraw those tokens?</p>
</div>
<div class="paragraph data-line-579">
<p>Remember, <em>Faucet.sol</em> is a pretty simple contract. It only has one function, <span class="keep-together"><code>withdraw</code></span>, which is for withdrawing <em>ether</em>. It doesn&#8217;t have a function for withdrawing MET, or any other ERC20 token. If we use withdraw it will try to send ether, but since Faucet doesn&#8217;t have a balance of ether yet, it will fail.</p>
</div>
<div class="paragraph data-line-581">
<p>The METoken contract knows that Faucet has a balance, but the only way that it can transfer that balance is if it receives a transfer call from the address of the contract. Somehow we need to make the Faucet contract call the transfer function in <span class="keep-together"><code>METoken</code></span>.</p>
</div>
<div class="paragraph data-line-583">
<p>If you&#8217;re wondering what to do next, don&#8217;t. There is no solution to this problem. The MET sent to Faucet is stuck, forever. Only the Faucet contract can transfer it, and the Faucet contract doesn&#8217;t have code to call the transfer function of an ERC20 token contract.</p>
</div>
<div class="paragraph data-line-585">
<p>Perhaps you anticipated this problem. Most likely, you didn&#8217;t. In fact, neither did hundreds of Ethereum users who accidentally transferred various tokens to contracts that didn&#8217;t have any ERC20 capability. According to some estimates, tokens worth more than roughly $2.5 million USD (at the time of writing) have gotten "stuck" like this and are lost forever.</p>
</div>
<div class="paragraph data-line-587">
<p>One of the ways that users of ERC20 tokens can inadvertently lose their tokens in a transfer, is when they attempt to transfer to an exchange or another service. They copy an Ethereum address from the website of an exchange, thinking they can simply send tokens to it. However, many exchanges publish receiving addresses that are actually contracts! These contracts are only meant to receive ether, not ERC20 tokens, most often sweeping all funds sent to them to "cold storage" or another centralized wallet. Despite the many warnings saying "do not send tokens to this address," lots of tokens are lost this way.</p>
</div>
</div>
<div class="sect4 data-line-590">
<h5 id="transfer_workflow_demo">Demonstrating the &#x201c;approve &amp; transferFrom&#x201d; workflow</h5>
<div class="paragraph data-line-592">
<p>Our Faucet contract couldn&#8217;t handle ERC20 tokens. Sending tokens to it using the transfer function resulted in the loss of those tokens. Let&#8217;s rewrite the contract now and make it handle ERC20 tokens. Specifically, we will turn it into a faucet that gives out MET to anyone who asks.</p>
</div>
<div class="paragraph data-line-594">
<p>For this example, we&#8217;ll make a copy of the <em>truffle</em> project directory (we&#8217;ll call it <em>METoken_METFaucet</em>), initialize truffle and npm, install the OpenZeppelin dependencies, and copy the <em>METoken.sol</em> contract. See our first example, in <a href="#METoken_example">Launching Our Own ERC20 Token</a>, for the detailed instructions.</p>
</div>
<div class="paragraph data-line-596">
<p>Our new faucet contract, <em>METFaucet.sol</em>, will look like <a href="#METFaucet">METFaucet.sol: A faucet for METoken</a>.</p>
</div>
<div id="METFaucet" class="exampleblock data-line-600">
<div class="title">Example 21. METFaucet.sol: A faucet for METoken</div>
<div class="content">
<div class="listingblock data-line-602">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Version of Solidity compiler this program was written for
pragma solidity ^0.4.19;

import 'openzeppelin-solidity/contracts/token/ERC20/StandardToken.sol';


// A faucet for ERC20 token MET
contract METFaucet {

	StandardToken public METoken;
	address public METOwner;

	// METFaucet constructor, provide the address of METoken contract and
	// the owner address we will be approved to transferFrom
	function METFaucet(address _METoken, address _METOwner) public {

		// Initialize the METoken from the address provided
		METoken = StandardToken(_METoken);
		METOwner = _METOwner;
	}

	function withdraw(uint withdraw_amount) public {

    	// Limit withdrawal amount to 10 MET
    	require(withdraw_amount &lt;= 1000);

		// Use the transferFrom function of METoken
		METoken.transferFrom(METOwner, msg.sender, withdraw_amount);
    }

	// REJECT any incoming ether
	function () external payable { revert(); }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-607">
<p>We&#8217;ve made quite a few changes to the basic Faucet example. Since METFaucet will use the transferFrom function in METoken, it will need two additional variables. One will hold the address of the deployed METoken contract. The other will hold the address of the owner of the MET, who will approve the faucet withdrawals. The METFaucet contract will call METoken.transferFrom and instruct it to move MET from the owner to the address where the faucet withdrawal request came from.</p>
</div>
<div class="paragraph data-line-610">
<p>We declare these two variables here:</p>
</div>
<div class="listingblock data-line-613">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">StandardToken public METoken;
address public METOwner;</code></pre>
</div>
</div>
<div class="paragraph data-line-618">
<p>Since our faucet needs to be initialized with the correct addresses for METoken and METOwner, we need to declare a custom constructor:</p>
</div>
<div id="custom_constructor" class="listingblock data-line-622">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// METFaucet constructor - provide the address of the METoken contract and
// the owner address we will be approved to transferFrom
function METFaucet(address _METoken, address _METOwner) public {

	// Initialize the METoken from the address provided
	METoken = StandardToken(_METoken);
	METOwner = _METOwner;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-633">
<p>The next change is to the withdraw function. Instead of calling transfer, METFaucet uses the transferFrom function in METoken and asks METoken to transfer MET to the faucet recipient:</p>
</div>
<div id="transfer_met" class="listingblock data-line-637">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Use the transferFrom function of METoken
METoken.transferFrom(METOwner, msg.sender, withdraw_amount);</code></pre>
</div>
</div>
<div class="paragraph data-line-642">
<p>Finally, since our faucet no longer sends ether, we should probably prevent anyone from sending ether to METFaucet, as we wouldn&#8217;t want it to get stuck. We change the fallback payable function to reject incoming ether, using the revert function to revert any incoming payments:</p>
</div>
<div id="reject_incoming_eth" class="listingblock data-line-646">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// REJECT any incoming ether
function () external payable { revert(); }</code></pre>
</div>
</div>
<div class="paragraph data-line-651">
<p>Now that our <em>METFaucet.sol</em> code is ready, we need to modify the migration script to deploy it. This migration script will be a bit more complex, as METFaucet depends on the address of METoken. We will use a JavaScript promise to deploy the two contracts in sequence. Create <em>2_deploy_contracts.js</em> as follows:</p>
</div>
<div class="listingblock data-line-654">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">var METoken = artifacts.require("METoken");
var METFaucet = artifacts.require("METFaucet");
var owner = web3.eth.accounts[0];

module.exports = function(deployer) {

	// Deploy the METoken contract first
	deployer.deploy(METoken, {from: owner}).then(function() {
		// Then deploy METFaucet and pass the address of METoken and the
		// address of the owner of all the MET who will approve METFaucet
		return deployer.deploy(METFaucet, METoken.address, owner);
  	});
}</code></pre>
</div>
</div>
<div class="paragraph data-line-670">
<p>Now, we can test everything in the Truffle console. First, we use migrate to deploy the contracts. When METoken is deployed it will allocate all the MET to the account that created it, web3.eth.accounts[0]. Then, we call the approve function in <code><span class="keep-together">METoken</span></code> to approve METFaucet to send up to 1,000 MET on behalf of web3.eth.accounts[0]. Finally, to test our faucet, we call METFaucet.withdraw from web3.eth.accounts[1] and try to withdraw 10 MET. Here are the console commands:</p>
</div>
<pre data-type="programlist">
$ <strong>truffle console --network ganache</strong>
truffle(ganache)&gt; <strong>migrate</strong>
Using network 'ganache'.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  ... 0x79352b43e18cc46b023a779e9a0d16b30f127bfa40266c02f9871d63c26542c7
  Migrations: 0xaa588d3737b611bafd7bd713445b314bd453a5c8
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Replacing METoken...
  ... 0xc42a57f22cddf95f6f8c19d794c8af3b2491f568b38b96fef15b13b6e8bfff21
  METoken: 0xf204a4ef082f5c04bb89f7d5e6568b796096735a
  Replacing METFaucet...
  ... 0xd9615cae2fa4f1e8a377de87f86162832cf4d31098779e6e00df1ae7f1b7f864
  METFaucet: 0x75c35c980c0d37ef46df04d31a140b65503c0eed
Saving artifacts...
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.approve(METFaucet.address, 100000) })</strong>
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.balanceOf(web3.eth.accounts[1]).then(console.log) })</strong>
truffle(ganache)&gt; <strong>BigNumber { s: 1, e: 0, c: [ 0 ] }</strong>
truffle(ganache)&gt; <strong>METFaucet.deployed().then(instance =>
                  { instance.withdraw(1000, {from:web3.eth.accounts[1]}) } )</strong>
truffle(ganache)&gt; <strong>METoken.deployed().then(instance =>
                  { instance.balanceOf(web3.eth.accounts[1]).then(console.log) })</strong>
truffle(ganache)&gt; <strong>BigNumber { s: 1, e: 3, c: [ 1000 ] }</strong>
</pre>
<div class="paragraph data-line-704">
<p>As you can see from the results, we can use the approve &amp; transferFrom workflow to authorize one contract to transfer tokens defined in another token. If properly used, ERC20 tokens can be used by EOAs and other contracts.</p>
</div>
<div class="paragraph data-line-706">
<p>However, the burden of managing ERC20 tokens correctly is pushed to the user interface. If a user incorrectly attempts to transfer ERC20 tokens to a contract address and that contract is not equipped to receive ERC20 tokens, the tokens will be lost.</p>
</div>
</div>
</div>
<div class="sect3 data-line-709">
<h4 id="ERC20_issues">Issues with ERC20 Tokens</h4>
<div class="paragraph data-line-711">
<p>The adoption of the ERC20 token standard has been truly explosive. Thousands of tokens have been launched, both to experiment with new capabilities and to raise funds in various "crowdfund" auctions and ICOs. However, there are some potential pitfalls, as we saw with the issue of transferring tokens to contract addresses.</p>
</div>
<div class="paragraph data-line-713">
<p>One of the less obvious issues with ERC20 tokens is that they expose subtle differences between tokens and ether itself. Where ether is transferred by a transaction that has a recipient address as its destination, token transfers occur within the <em>specific token contract state</em> and have the token contract as their destination, not the recipient&#8217;s address. The token contract tracks balances and issues events. In a token transfer, no transaction is actually sent to the recipient of the token. Instead, the recipient&#8217;s address is added to a map within the token contract itself. A transaction sending ether to an address changes the state of an address. A transaction transferring a token to an address only changes the state of the token contract, not the state of the recipient address. Even a wallet that has support for ERC20 tokens does not become aware of a token balance unless the user explicitly adds a specific token contract to "watch." Some wallets watch the most popular token contracts to detect balances held by addresses they control, but that&#8217;s limited to a small fraction of existing ERC20 <span class="keep-together">contracts</span>.</p>
</div>
<div class="paragraph data-line-715">
<p>In fact, it&#8217;s unlikely that a user would <em>want</em> to track all balances in all possible ERC20 token contracts. Many ERC20 tokens are more like email spam than usable tokens. They automatically create balances for accounts that have ether activity, in order to attract users. If you have an Ethereum address with a long history of activity, especially if it was created in the presale, you will find it full of "junk" tokens that appeared out of nowhere. Of course, the address isn&#8217;t really full of tokens; it&#8217;s the token contracts that have your address in them. You only see these balances if these token contracts are being watched by the block explorer or wallet you use to view your address.</p>
</div>
<div class="paragraph data-line-717">
<p>Tokens don&#8217;t behave the same way as ether. Ether is sent with the send function and accepted by any payable function in a contract or any externally owned address. Tokens are sent using transfer or approve &amp; transferFrom functions that exist only in the ERC20 contract, and do not (at least in ERC20) trigger any payable functions in a recipient contract. Tokens are meant to function just like a cryptocurrency such as ether, but they come with certain differences that break that illusion.</p>
</div>
<div class="paragraph data-line-719">
<p>Consider another issue. To send ether or use any Ethereum contract you need ether to pay for gas. To send tokens, you <em>also need ether</em>. You cannot pay for a transaction&#8217;s gas with a token and the token contract can&#8217;t pay for the gas for you. This may change at some point in the distant future, but in the meantime this can cause some rather strange user experiences. For example, let&#8217;s say you use an exchange or ShapeShift to convert some bitcoin to a token. You "receive" the token in a wallet that tracks that token&#8217;s contract and shows your balance. It looks the same as any of the other cryptocurrencies you have in your wallet. Try sending the token, though, and your wallet will inform you that you need ether to do that. You might be confused&#x2014;after all, you didn&#8217;t need ether to receive the token. Perhaps you have no ether. Perhaps you didn&#8217;t even know the token was an ERC20 token on Ethereum; maybe you thought it was a cryptocurrency with its own blockchain. The illusion just broke.</p>
</div>
<div class="paragraph data-line-721">
<p>Some of these issues are specific to ERC20 tokens. Others are more general issues that relate to abstraction and interface boundaries within Ethereum. Some can be solved by changing the token interface, while others may need changes to fundamental structures within Ethereum (such as the distinction between EOAs and contracts, and between transactions and messages). Some may not be "solvable" exactly and may require user interface design to hide the nuances and make the user experience consistent regardless of the underlying distinctions.</p>
</div>
<div class="paragraph data-line-723">
<p>In the next sections we will look at various proposals that attempt to address some of these issues.</p>
</div>
</div>
<div class="sect3 data-line-726">
<h4 id="ERC223_std">ERC223: A Proposed Token Contract Interface Standard</h4>
<div class="paragraph data-line-728">
<p>The ERC223 proposal attempts to solve the problem of inadvertent transfer of tokens to a contract (that may or may not support tokens) by detecting whether the destination address is a contract or not. ERC223 requires that contracts designed to accept tokens implement a function named tokenFallback. If the destination of a transfer is a contract and the contract does not have support for tokens (i.e., does not implement tokenFallback), the transfer fails.</p>
</div>
<div id="is_contract" class="paragraph data-line-731">
<p>To detect whether the destination address is a contract, the ERC223 reference implementation uses a small segment of inline bytecode in a rather creative way:</p>
</div>
<div class="listingblock data-line-734">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">function isContract(address _addr) private view returns (bool is_contract) {
  uint length;
    assembly {
       // retrieve the size of the code on target address; this needs assembly
       length := extcodesize(_addr)
    }
    return (length&gt;0);
}</code></pre>
</div>
</div>
<div id="ERC223_interface" class="paragraph data-line-746">
<p>The ERC223 contract interface specification is:</p>
</div>
<div class="listingblock data-line-749">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC223Token {
  uint public totalSupply;
  function balanceOf(address who) public view returns (uint);

  function name() public view returns (string _name);
  function symbol() public view returns (string _symbol);
  function decimals() public view returns (uint8 _decimals);
  function totalSupply() public view returns (uint256 _supply);

  function transfer(address to, uint value) public returns (bool ok);
  function transfer(address to, uint value, bytes data) public returns (bool ok);
  function transfer(address to, uint value, bytes data, string custom_fallback)
      public returns (bool ok);

  event Transfer(address indexed from, address indexed to, uint value,
                 bytes indexed data);
}</code></pre>
</div>
</div>
<div class="paragraph data-line-769">
<p>ERC223 is not widely implemented, and there is some debate in <a href="https://github.com/ethereum/EIPs/issues/223" data-href="https://github.com/ethereum/EIPs/issues/223">the ERC discussion</a> thread about backward compatibility and trade-offs between implementing changes at the contract interface level versus the user interface. The debate continues.</p>
</div>
</div>
<div class="sect3 data-line-771">
<h4 id="_erc777_a_proposed_token_contract_interface_standard">ERC777: A Proposed Token Contract Interface Standard</h4>
<div class="paragraph data-line-773">
<p>Another proposal for an improved token contract standard is <a href="https://eips.ethereum.org/EIPS/eip-777" data-href="https://eips.ethereum.org/EIPS/eip-777">ERC777</a>. This proposal has several goals, including:</p>
</div>
<div class="ulist data-line-775">
<ul>
<li class="data-line-775">
<p>To offer an ERC20-compatible interface</p>
</li>
<li class="data-line-776">
<p>To transfer tokens using a send function, similar to ether transfers</p>
</li>
<li class="data-line-777">
<p>To be compatible with ERC820 for token contract registration</p>
</li>
<li class="data-line-778">
<p>To allow contracts and addresses to control which tokens they send through a <code>tokensToSend</code> function that is called prior to sending</p>
</li>
<li class="data-line-779">
<p>To enable contracts and addresses to be notified of the tokens' receipt by calling a <code>tokensReceived</code> function in the recipient, and to reduce the probability of tokens being locked into contracts by requiring contracts to provide a <span class="keep-together"><code>tokensReceived</code></span> function</p>
</li>
<li class="data-line-780">
<p>To allow existing contracts to use proxy contracts for the tokensToSend and tokensReceived functions</p>
</li>
<li class="data-line-781">
<p>To operate in the same way whether sending to a contract or an EOA</p>
</li>
<li class="data-line-782">
<p>To provide specific events for the minting and burning of tokens</p>
</li>
<li class="data-line-783">
<p>To enable operators (trusted third parties, intended to be verified contracts) to move tokens on behalf of a token holder</p>
</li>
<li class="data-line-784">
<p>To provide metadata on token transfer transactions in userData and operatorData fields</p>
</li>
</ul>
</div>
<div class="paragraph data-line-786">
<p>The ongoing discussion on ERC777 can be found <a href="https://github.com/ethereum/EIPs/issues/777" data-href="https://github.com/ethereum/EIPs/issues/777">on GitHub</a>.</p>
</div>
<div id="ERC777_interface" class="paragraph data-line-789">
<p>The ERC777 contract interface specification is:</p>
</div>
<div class="listingblock data-line-792">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC777Token {
    function name() public constant returns (string);
    function symbol() public constant returns (string);
    function totalSupply() public constant returns (uint256);
    function granularity() public constant returns (uint256);
    function balanceOf(address owner) public constant returns (uint256);

    function send(address to, uint256 amount, bytes userData) public;

    function authorizeOperator(address operator) public;
    function revokeOperator(address operator) public;
    function isOperatorFor(address operator, address tokenHolder)
        public constant returns (bool);
    function operatorSend(address from, address to, uint256 amount,
                          bytes userData,bytes operatorData) public;

    event Sent(address indexed operator, address indexed from,
               address indexed to, uint256 amount, bytes userData,
               bytes operatorData);
    event Minted(address indexed operator, address indexed to,
                 uint256 amount, bytes operatorData);
    event Burned(address indexed operator, address indexed from,
                 uint256 amount, bytes userData, bytes operatorData);
    event AuthorizedOperator(address indexed operator,
                             address indexed tokenHolder);
    event RevokedOperator(address indexed operator, address indexed tokenHolder);
}</code></pre>
</div>
</div>
<div class="sect4 data-line-823">
<h5 id="ERC777_hooks">ERC777 hooks</h5>
<div id="ERC777TokensSender_interface" class="paragraph data-line-826">
<p>The ERC777 tokens sender hook specification is:</p>
</div>
<div class="listingblock data-line-829">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC777TokensSender {
    function tokensToSend(address operator, address from, address to,
                          uint value, bytes userData, bytes operatorData) public;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-836">
<p>The implementation of this interface is required for any address wishing to be notified of, to handle, or to prevent the debit of tokens. The address for which the contract implements this interface must be registered via ERC820, whether the contract implements the interface for itself or for another address.</p>
</div>
<div id="ERC777TokensRecipient_interface" class="paragraph data-line-839">
<p>The ERC777 tokens recipient hook specification is:</p>
</div>
<div class="listingblock data-line-842">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC777TokensRecipient {
  function tokensReceived(
     address operator, address from, address to,
    uint amount, bytes userData, bytes operatorData
  ) public;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-851">
<p>The implementation of this interface is required for any address wishing to be notified of, to handle, or to reject the reception of tokens. The same logic and requirements apply to the tokens recipient as to the tokens sender interface, with the added constraint that recipient contracts must implement this interface to prevent locking tokens. If the recipient contract does not register an address implementing this interface, the transfer of tokens will fail.</p>
</div>
<div class="paragraph data-line-853">
<p>An important aspect is that only one token sender and one token recipient can be registered per address. Hence, for every ERC777 token transfer the same hook functions are called upon debit and reception of every ERC777 token transfer. A specific token can be identified in these functions using the message&#8217;s sender, which is the specific token contract address, to handle a particular use case.</p>
</div>
<div class="paragraph data-line-855">
<p>On the other hand, the same token sender and token recipient hooks can be registered for multiple addresses and the hooks can distinguish who are the sender and the intended recipient using the <code>from</code> and <code>to</code> parameters.</p>
</div>
<div class="paragraph data-line-857">
<p>A <a href="http://bit.ly/2qkAKba" data-href="http://bit.ly/2qkAKba">reference implementation</a> of ERC777 is linked in the proposal. ERC777 depends on a parallel proposal for a registry contract, specified in ERC820. Some of the debate on ERC777 is about the complexity of adopting two big changes at once: a new token standard and a registry standard. The discussion continues.</p>
</div>
</div>
</div>
<div class="sect3 data-line-860">
<h4 id="erc721">ERC721: Non-fungible Token (Deed) Standard</h4>
<div class="paragraph data-line-862">
<p>All the token standards we have looked at so far are for <em>fungible</em> tokens, meaning that units of a token are interchangeable. The ERC20 token standard only tracks the final balance of each account and does not (explicitly) track the provenance of any token.</p>
</div>
<div class="paragraph data-line-864">
<p>The <a href="http://bit.ly/2Ogs7Im" data-href="http://bit.ly/2Ogs7Im">ERC721 proposal</a> is for a standard for <em>non-fungible</em> tokens, also known as <em>deeds</em>.</p>
</div>
<div class="paragraph data-line-866">
<p>From the Oxford Dictionary:</p>
</div>
<div class="quoteblock data-line-868">
<blockquote>
<div class="paragraph data-line-869">
<p><em>deed</em>: A legal document that is signed and delivered, especially one regarding the ownership of property or legal rights.</p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-872">
<p>The use of the word "deed" is intended to reflect the "ownership of property" part, even though these are not recognized as "legal documents" in any jurisdiction&#x2014;yet. It is likely that at some point in the future, legal ownership based on digital signatures on a blockchain platform will be legally recognized.</p>
</div>
<div class="paragraph data-line-874">
<p>Non-fungible tokens track ownership of a unique thing. The thing owned can be a digital item, such as an in-game item or digital collectible; or the thing can be a physical item whose ownership is tracked by a token, such as a house, a car, or an artwork. Deeds can also represent things with negative value, such as loans (debt), liens, easements, etc. The ERC721 standard places no limitation or expectation on the nature of the thing whose ownership is tracked by a deed and requires only that it can be uniquely identified, which in the case of this standard is achieved by a 256-bit <span class="keep-together">identifier</span>.</p>
</div>
<div class="paragraph data-line-876">
<p>The details of the standard and discussion are tracked in two different GitHub <span class="keep-together">locations</span>:</p>
</div>
<div class="ulist data-line-878">
<ul>
<li class="data-line-878">
<p><a href="https://github.com/ethereum/EIPs/issues/721" data-href="https://github.com/ethereum/EIPs/issues/721">Initial proposal</a></p>
</li>
<li class="data-line-880">
<p><a href="https://github.com/ethereum/EIPs/pull/841" data-href="https://github.com/ethereum/EIPs/pull/841">Continued discussion</a></p>
</li>
</ul>
</div>
<div id="map_deed_owner" class="paragraph data-line-883">
<p>To grasp the basic difference between ERC20 and ERC721, it is sufficient to look at the internal data structure used in ERC721:</p>
</div>
<div class="listingblock data-line-886">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Mapping from deed ID to owner
mapping (uint256 =&gt; address) private deedOwner;</code></pre>
</div>
</div>
<div class="paragraph data-line-891">
<p>Whereas ERC20 tracks the balances that belong to each owner, with the owner being the primary key of the mapping, ERC721 tracks each deed ID and who owns it, with the deed ID being the primary key of the mapping. From this basic difference flow all the properties of a non-fungible token.</p>
</div>
<div id="ERC721_interface" class="paragraph data-line-894">
<p>The ERC721 contract interface specification is:</p>
</div>
<div class="listingblock data-line-897">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC721 /* is ERC165 */ {
    event Transfer(address indexed _from, address indexed _to, uint256 _deedId);
    event Approval(address indexed _owner, address indexed _approved,
                   uint256 _deedId);
    event ApprovalForAll(address indexed _owner, address indexed _operator,
                         bool _approved);

    function balanceOf(address _owner) external view returns (uint256 _balance);
    function ownerOf(uint256 _deedId) external view returns (address _owner);
    function transfer(address _to, uint256 _deedId) external payable;
    function transferFrom(address _from, address _to, uint256 _deedId)
        external payable;
    function approve(address _approved, uint256 _deedId) external payable;
    function setApprovalForAll(address _operateor, boolean _approved) payable;
    function supportsInterface(bytes4 interfaceID) external view returns (bool);
}</code></pre>
</div>
</div>
<div class="paragraph data-line-916">
<p>ERC721 also supports two <em>optional</em> interfaces, one for metadata and one for enumeration of deeds and owners.</p>
</div>
<div id="ERC721_metadata" class="paragraph data-line-919">
<p>The ERC721 optional interface for metadata is:</p>
</div>
<div class="listingblock data-line-922">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC721Metadata /* is ERC721 */ {
    function name() external pure returns (string _name);
    function symbol() external pure returns (string _symbol);
    function deedUri(uint256 _deedId) external view returns (string _deedUri);
}</code></pre>
</div>
</div>
<div id="ERC721_enum" class="paragraph data-line-931">
<p>The ERC721 optional interface for enumeration is:</p>
</div>
<div class="listingblock data-line-934">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">interface ERC721Enumerable /* is ERC721 */ {
    function totalSupply() external view returns (uint256 _count);
    function deedByIndex(uint256 _index) external view returns (uint256 _deedId);
    function countOfOwners() external view returns (uint256 _count);
    function ownerByIndex(uint256 _index) external view returns (address _owner);
    function deedOfOwnerByIndex(address _owner, uint256 _index) external view
        returns (uint256 _deedId);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-946">
<h3 id="token_std_review">Using Token Standards</h3>
<div class="paragraph data-line-948">
<p>In the previous section we reviewed several proposed standards and a couple of widely deployed standards for token contracts. What exactly do these standards do? Should you use these standards? How should you use them? Should you add functionality beyond these standards? Which standards should you use? We will examine some of those questions next.</p>
</div>
<div class="sect3 data-line-951">
<h4 id="token_std_purpose">What Are Token Standards? What Is Their Purpose?</h4>
<div class="paragraph data-line-953">
<p>Token standards are the <em>minimum</em> specifications for an implementation. What that means is that in order to be compliant with, say, ERC20, you need to at minimum implement the functions and behavior specified by the ERC20 standard. You are also free to <em>add</em> to the functionality by implementing functions that are not part of the standard.</p>
</div>
<div class="paragraph data-line-955">
<p>The primary purpose of these standards is to encourage <em>interoperability</em> between contracts. Thus, all wallets, exchanges, user interfaces, and other infrastructure components can <em>interface</em> in a predictable manner with any contract that follows the specification. In other words, if you deploy a contract that follows the ERC20 standard, all existing wallet users can seamlessly start trading your token without any wallet upgrade or effort on your part.</p>
</div>
<div class="paragraph data-line-957">
<p>The standards are meant to be <em>descriptive</em>, rather than <em>prescriptive</em>. How you choose to implement those functions is up to you&#x2014;the internal functioning of the contract is not relevant to the standard. They have some functional requirements, which govern the behavior under specific circumstances, but they do not prescribe an implementation. An example of this is the behavior of a transfer function if the value is set to zero.</p>
</div>
</div>
<div class="sect3 data-line-960">
<h4 id="should_use_std">Should You Use These Standards?</h4>
<div class="paragraph data-line-962">
<p>Given all these standards, each developer faces a dilemma: use the existing standards or innovate beyond the restrictions they impose?</p>
</div>
<div class="paragraph data-line-964">
<p>This dilemma is not easy to resolve. Standards necessarily restrict your ability to innovate, by creating a narrow "rut" that you have to follow. On the other hand, the basic standards have emerged from experience with hundreds of applications and often fit well with the vast majority of use cases.</p>
</div>
<div class="paragraph data-line-966">
<p>As part of this consideration is an even bigger issue: the value of interoperability and broad adoption. If you choose to use an existing standard, you gain the value of all the systems designed to work with that standard. If you choose to depart from the standard, you have to consider the cost of building all of the support infrastructure on your own, or persuading others to support your implementation as a new standard. The tendency to forge your own path and ignore existing standards is known as "Not Invented Here" syndrome and is antithetical to open source culture. On the other hand, progress and innovation depend on departing from tradition sometimes. It&#8217;s a tricky choice, so consider it carefully!</p>
</div>
<div class="admonitionblock note data-line-969">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-970">
<p>Per Wikipedia, <a href="https://en.wikipedia.org/wiki/Not_invented_here" data-href="https://en.wikipedia.org/wiki/Not_invented_here">&#x201c;Not Invented Here&#x201d;</a> is a stance adopted by social, corporate, or institutional cultures that avoid using or buying already existing products, research, standards, or knowledge because of their external origins and costs, such as royalties.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-975">
<h4 id="security_maturity">Security by Maturity</h4>
<div class="paragraph data-line-977">
<p>Beyond the choice of standard, there is the parallel choice of <em>implementation</em>. When you decide to use a standard such as ERC20, you have to then decide how to implement a compatible design. There are a number of existing "reference" implementations that are widely used in the Ethereum ecosystem, or you could write your own from scratch. Again, this choice represents a dilemma that can have serious security implications.</p>
</div>
<div class="paragraph data-line-979">
<p>Existing implementations are &#x201c;battle-tested.&#x201d; While it is impossible to prove that they are secure, many of them underpin millions of dollars' worth of tokens. They have been attacked, repeatedly and vigorously. So far, no significant vulnerabilities have been discovered. Writing your own is not easy&#x2014;there are many subtle ways that a contract can be compromised. It is much safer to use a well-tested, widely used implementation. In our examples, we used the OpenZeppelin implementation of the ERC20 standard, as this implementation is security-focused from the ground up.</p>
</div>
<div class="paragraph data-line-981">
<p>If you use an existing implementation you can also extend it. Again, however, be careful with this impulse. Complexity is the enemy of security. Every single line of code you add expands the <em>attack surface</em> of your contract and could represent a vulnerability lying in wait. You may not notice a problem until you put a lot of value on top of the contract and someone breaks it.</p>
</div>
<div class="admonitionblock tip data-line-984">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-985">
<p>Standards and implementation choices are important parts of overall secure smart contract design, but they&#8217;re not the only considerations. See <a href="#smart_contract_security">Sécurité des contrats intelligents</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2 data-line-990">
<h3 id="extend_token_interface">Extensions to Token Interface Standards</h3>
<div class="paragraph data-line-992">
<p>The token standards discussed in this chapter provide a very minimal interface, with limited functionality. Many projects have created extended implementations to support features that they need for their applications. Some of these features include:</p>
</div>
<div class="dlist data-line-994">
<dl>
<dt class="hdlist1">Owner control</dt>
<dd>
<p>The ability to give specific addresses, or sets of addresses (i.e., multisignature schemes), special capabilities, such as blacklisting, whitelisting, minting, recovery, etc.</p>
</dd>
<dt class="hdlist1">Burning</dt>
<dd>
<p>The ability to deliberately destroy (&#x201c;burn&#x201d;) tokens by transferring them to an unspendable address or by erasing a balance and reducing the supply.</p>
</dd>
<dt class="hdlist1">Minting</dt>
<dd>
<p>The ability to add to the total supply of tokens, at a predictable rate or by "fiat" of the creator of the token.</p>
</dd>
<dt class="hdlist1">Crowdfunding</dt>
<dd>
<p>The ability to offer tokens for sale, for example through an auction, market sale, reverse auction, etc.</p>
</dd>
<dt class="hdlist1">Caps</dt>
<dd>
<p>The ability to set predefined and immutable limits on the total supply (the opposite of the "minting" feature).</p>
</dd>
<dt class="hdlist1">Recovery backdoors</dt>
<dd>
<p>Functions to recover funds, reverse transfers, or dismantle the token that can be activated by a designated address or set of addresses.</p>
</dd>
<dt class="hdlist1">Whitelisting</dt>
<dd>
<p>The ability to restrict actions (such as token transfers) to specific addresses. Most commonly used to offer tokens to "accredited investors" after vetting by the rules of different jurisdictions. There is usually a mechanism for updating the whitelist.</p>
</dd>
<dt class="hdlist1">Blacklisting</dt>
<dd>
<p>The ability to restrict token transfers by disallowing specific addresses. There is usually a function for updating the blacklist.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-1010">
<p>There are reference implementations for many of these functions, for example in the OpenZeppelin library. Some of these are use case–specific and only implemented in a few tokens. There are, as of now, no widely accepted standards for the interfaces to these functions.</p>
</div>
<div class="paragraph data-line-1012">
<p>As previously discussed, the decision to extend a token standard with additional functionality represents a trade-off between innovation/risk and interoperability/security.</p>
</div>
</div>
<div class="sect2 data-line-1015">
<h3 id="tokens_ico">Tokens and ICOs</h3>
<div class="paragraph data-line-1017">
<p>Tokens have been an explosive development in the Ethereum ecosystem. It is likely that they will become a very important component of all smart contract platforms like Ethereum.</p>
</div>
<div class="paragraph data-line-1019">
<p>Nevertheless, the importance and future impact of these standards should not be confused with an endorsement of current token offerings. As in any early-stage technology, the first wave of products and companies will almost all fail, and some will fail spectacularly. Many of the tokens on offer in Ethereum today are barely disguised scams, pyramid schemes, and money grabs.</p>
</div>
<div class="paragraph data-line-1021">
<p>The trick is to separate the long-term vision and impact of this technology, which is likely to be huge, from the short-term bubble of token ICOs, which are rife with fraud. Token standards and the platform will survive the current token mania, and then they will likely change the world.</p>
</div>
</div>
<div class="sect2 data-line-1023">
<h3 id="_conclusions_7">Conclusions</h3>
<div class="paragraph data-line-23">
<p>Tokens are a very powerful concept in Ethereum and can form the basis of many important decentralized applications. In this chapter we looked at the different types of tokens and token standards, and you built your first token and related application. We will revisit tokens again in <a href="#decentralized_applications_chap">Applications décentralisées (DApps)</a>, where you will use a non-fungible token as the basis for an auction DApp.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="oracles_chap">Oracles</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>In this chapter we discuss <em>oracles</em>, which are systems that can provide external data sources to Ethereum smart contracts. The term "oracle" comes from Greek mythology, where it referred to a person in communication with the gods who could see visions of the future. In the context of blockchains, an oracle is a system that can answer questions that are external to Ethereum. Ideally oracles are systems that are <em>trustless</em>, meaning that they do not need to be trusted because they operate on decentralized principles.</p>
</div>
<div class="sect2 data-line-7">
<h3 id="why_oracles">Why Oracles Are Needed</h3>
<div class="paragraph data-line-9">
<p>A key component of the Ethereum platform is the Ethereum Virtual Machine, with its ability to execute programs and update the state of Ethereum, constrained by consensus rules, on any node in the decentralized network. In order to maintain consensus, EVM execution must be totally deterministic and based only on the shared context of the Ethereum state and signed transactions. This has two particularly important consequences: the first is that there can be no intrinsic source of randomness for the EVM and smart contracts to work with; the second is that extrinsic data can only be introduced as the data payload of a transaction.</p>
</div>
<div class="paragraph data-line-11">
<p>Let&#8217;s unpack those two consequences further. To understand the prohibition of a true random function in the EVM to provide randomness for smart contracts, consider the effect on attempts to achieve consensus after the execution of such a function: node A would execute the command and store 3 on behalf of the smart contract in its storage, while node B, executing the same smart contract, would store 7 instead. Thus, nodes A and B would come to different conclusions about what the resulting state should be, despite having run exactly the same code in the same context. Indeed, it could be that a different resulting state would be achieved every time that the smart contract is evaluated. As such, there would be no way for the network, with its multitude of nodes running independently around the world, to ever come to a decentralized consensus on what the resulting state should be. In practice, it would get much worse than this example very quickly, because knock-on effects, including ether transfers, would build up exponentially.</p>
</div>
<div class="paragraph data-line-13">
<p>Note that pseudorandom functions, such as cryptographically secure hash functions (which are deterministic and therefore can be, and indeed are, part of the EVM), are not enough for many applications. Take a gambling game that simulates coin flips to resolve bet payouts, which needs to randomize heads or tails&#x2014;a miner can gain an advantage by playing the game and only including their transactions in blocks for which they will win. So how do we get around this problem? Well, all nodes can agree on the contents of signed transactions, so extrinsic information, including sources of randomness, price information, weather forecasts, etc., can be introduced as the data part of transactions sent to the network. However, such data simply cannot be trusted, because it comes from unverifiable sources. As such, we have just deferred the problem. We use oracles to attempt to solve these problems, which we will discuss in detail, in the rest of this chapter.</p>
</div>
</div>
<div class="sect2 data-line-16">
<h3 id="oracle_use_cases">Oracle Use Cases and Examples</h3>
<div class="paragraph data-line-18">
<p>Oracles, ideally, provide a trustless (or at least near-trustless) way of getting extrinsic (i.e., "real-world" or off-chain) information, such as the results of football games, the price of gold, or truly random numbers, onto the Ethereum platform for smart contracts to use. They can also be used to relay data securely to DApp frontends directly. Oracles can therefore be thought of as a mechanism for bridging the gap between the off-chain world and smart contracts. Allowing smart contracts to enforce contractual relationships based on real-world events and data broadens their scope dramatically. However, this can also introduce external risks to Ethereum&#8217;s security model. Consider a "smart will" contract that distributes assets when a person dies. This is something frequently discussed in the smart contract space, and highlights the risks of a trusted oracle. If the inheritance amount controlled by such a contract is high enough, the incentive to hack the oracle and trigger distribution of assets <em>before</em> the owner dies is very high.</p>
</div>
<div class="paragraph data-line-20">
<p>Note that some oracles provide data that is particular to a specific private data source, such as academic certificates or government IDs. The source of such data, such as a university or government department, is fully trusted, and the truth of the data is subjective (truth is only determined by appeal to the authority of the source). Such data cannot therefore be provided trustlessly—i.e., without  trusting a source—as there is no independently verifiably objective truth. As such, we include these data sources in our definition of what counts as "oracles" because they also provide a data bridge for smart contracts. The data they provide generally takes the form of attestations, such as passports or records of achievement. Attestations will become a big part of the success of blockchain platforms in the future, particularly in relation to the related issues of verifying identity or reputation, so it is important to explore how they can be served by blockchain platforms.</p>
</div>
<div class="paragraph data-line-22">
<p>Some more examples of data that might be provided by oracles include:</p>
</div>
<div class="ulist data-line-24">
<ul>
<li class="data-line-24">
<p>Random numbers/entropy from physical sources such as quantum/thermal processes: e.g., to fairly select a winner in a lottery smart contract</p>
</li>
<li class="data-line-25">
<p>Parametric triggers indexed to natural hazards: e.g., triggering of catastrophe bond smart contracts, such as Richter scale measurements for an earthquake bond</p>
</li>
<li class="data-line-26">
<p>Exchange rate data: e.g., for accurate pegging of cryptocurrencies to fiat currency</p>
</li>
<li class="data-line-27">
<p>Capital markets data: e.g., pricing baskets of tokenized assets/securities</p>
</li>
<li class="data-line-28">
<p>Benchmark reference data: e.g., incorporating interest rates into smart financial derivatives</p>
</li>
<li class="data-line-29">
<p>Static/pseudostatic data: security identifiers, country codes, currency codes, etc.</p>
</li>
<li class="data-line-30">
<p>Time and interval data: for event triggers grounded in precise time measurements</p>
</li>
<li class="data-line-31">
<p>Weather data: e.g., insurance premium calculations based on weather forecasts</p>
</li>
<li class="data-line-32">
<p>Political events: for prediction market resolution</p>
</li>
<li class="data-line-33">
<p>Sporting events: for prediction market resolution and fantasy sports contracts</p>
</li>
<li class="data-line-34">
<p>Geolocation data: e.g., as used in supply chain tracking</p>
</li>
<li class="data-line-35">
<p>Damage verification: for insurance contracts</p>
</li>
<li class="data-line-36">
<p>Events occurring on other blockchains: interoperability functions</p>
</li>
<li class="data-line-37">
<p>Ether market price: e.g., for fiat gas price oracles</p>
</li>
<li class="data-line-38">
<p>Flight statistics: e.g., as used by groups and clubs for flight ticket pooling</p>
</li>
</ul>
</div>
<div class="paragraph data-line-41">
<p>In the following sections, we will examine some of the ways oracles can be implemented, including basic oracle patterns, computation oracles, decentralized oracles, and oracle client implementations in Solidity.</p>
</div>
</div>
<div class="sect2 data-line-44">
<h3 id="oracle_design_patterns">Oracle Design Patterns</h3>
<div class="paragraph data-line-46">
<p>All oracles provide a few key functions, by definition. These include the ability to:</p>
</div>
<div class="ulist data-line-48">
<ul>
<li class="data-line-48">
<p>Collect data from an off-chain source.</p>
</li>
<li class="data-line-49">
<p>Transfer the data on-chain with a signed message.</p>
</li>
<li class="data-line-50">
<p>Make the data available by putting it in a smart contract&#8217;s storage.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-52">
<p>Once the data is available in a smart contract&#8217;s storage, it can be accessed by other smart contracts via message calls that invoke a "retrieve" function of the oracle&#8217;s smart contract; it can also be accessed by Ethereum nodes or network-enabled clients directly by "looking into&#x201d; the oracle&#8217;s storage.</p>
</div>
<div class="paragraph data-line-54">
<p>The three main ways to set up an oracle can be categorized as <em>request–response</em>, <span class="keep-together"><em>publish-subscribe</em></span>, and <em>immediate-read</em>.</p>
</div>
<div class="paragraph data-line-56">
<p>Starting with the simplest, <em>immediate-read</em> oracles are those that provide data that is only needed for an immediate decision, like "What is the address for <em>ethereumbook.info</em>?" or "Is this person over 18?" Those wishing to query this kind of data tend to do so on a "just-in-time" basis; the lookup is done when the information is needed and possibly never again. Examples of such oracles include those that hold data about or issued by organizations, such as academic certificates, dial codes, institutional memberships, airport identifiers, self-sovereign IDs, etc. This type of oracle stores data once in its contract storage, whence any other smart contract can look it up using a request call to the oracle contract. It may be updated. The data in the oracle&#8217;s storage is also available for direct lookup by blockchain-enabled (i.e., Ethereum <span class="keep-together">client–connected</span>) applications without having to go through the palaver and incurring the gas costs of issuing a transaction. A shop wanting to check the age of a customer wishing to purchase alcohol could use an oracle in this way. This type of oracle is attractive to an organization or company that might otherwise have to run and maintain servers to answer such data requests. Note that the data stored by the oracle is likely not to be the raw data that the oracle is serving, e.g., for efficiency or privacy reasons. A university might set up an oracle for the certificates of academic achievement of past students. However, storing the full details of the certificates (which could run to pages of courses taken and grades achieved) would be excessive. Instead, a hash of the certificate is sufficient. Likewise, a government might wish to put citizen IDs onto the Ethereum platform, where clearly the details included need to be kept private. Again, hashing the data (more carefully, in Merkle trees with salts) and only storing the root hash in the smart contract&#8217;s storage would be an efficient way to organize such a service.</p>
</div>
<div class="paragraph data-line-58">
<p>The next setup is <em>publish–subscribe</em>, where an oracle that effectively provides a broadcast service for data that is expected to change (perhaps both regularly and frequently) is either polled by a smart contract on-chain, or watched by an off-chain daemon for updates. This category has a pattern similar to RSS feeds, WebSub, and the like, where the oracle is updated with new information and a flag signals that new data is available to those who consider themselves "subscribed." Interested parties must either poll the oracle to check whether the latest information has changed, or listen for updates to oracle contracts and act when they occur. Examples include price feeds, weather information, economic or social statistics, traffic data, etc. Polling is very inefficient in the world of web servers, but not so in the peer-to-peer context of blockchain platforms: Ethereum clients have to keep up with all state changes, including changes to contract storage, so polling for data changes is a local call to a synced client. Ethereum event logs make it particularly easy for applications to look out for oracle updates, and so this pattern can in some ways even be considered a "push" service. However, if the polling is done from a smart contract, which might be necessary for some decentralized applications (e.g., where activation incentives are not possible), then significant gas expenditure may be incurred.</p>
</div>
<div class="paragraph data-line-60">
<p>The <em>request–response</em> category is the most complicated: this is where the data space is too huge to be stored in a smart contract and users are expected to only need a small part of the overall dataset at a time. It is also an applicable model for data provider businesses. In practical terms, such an oracle might be implemented as a system of on-chain smart contracts and off-chain infrastructure used to monitor requests and retrieve and return data. A request for data from a decentralized application would typically be an asynchronous process involving a number of steps. In this pattern, firstly, an EOA transacts with a decentralized application, resulting in an interaction with a function defined in the oracle smart contract. This function initiates the request to the oracle, with the associated arguments detailing the data requested in addition to supplementary information that might include callback functions and scheduling parameters. Once this transaction has been validated, the oracle request can be observed as an EVM event emitted by the oracle contract, or as a state change; the arguments can be retrieved and used to perform the actual query of the off-chain data source. The oracle may also require payment for processing the request, gas payment for the callback, and permissions to access the requested data. Finally, the resulting data is signed by the oracle owner, attesting to the validity of the data at a given time, and delivered in a transaction to the decentralized application that made the request—either directly or via the oracle contract. Depending on the scheduling parameters, the oracle may broadcast further transactions updating the data at regular intervals (e.g., end-of-day pricing information).</p>
</div>
<div class="paragraph data-line-62">
<p>The steps for a request–response oracle may be summarized as follows:</p>
</div>
<div class="olist arabic data-line-64">
<ol class="arabic">
<li class="data-line-64">
<p>Receive a query from a DApp.</p>
</li>
<li class="data-line-65">
<p>Parse the query.</p>
</li>
<li class="data-line-66">
<p>Check that payment and data access permissions are provided.</p>
</li>
<li class="data-line-67">
<p>Retrieve relevant data from an off-chain source (and encrypt it if necessary).</p>
</li>
<li class="data-line-68">
<p>Sign the transaction(s) with the data included.</p>
</li>
<li class="data-line-69">
<p>Broadcast the transaction(s) to the network.</p>
</li>
<li class="data-line-70">
<p>Schedule any further necessary transactions, such as notifications, etc.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-72">
<p>A range of other schemes are also possible; for example, data can be requested from and returned directly by an EOA, removing the need for an oracle smart contract. Similarly, the request and response could be made to and from an Internet of Things–enabled hardware sensor. Therefore, oracles can be human, software, or hardware.</p>
</div>
<div class="paragraph data-line-74">
<p>The request–response pattern described here is commonly seen in client–server architectures. While this is a useful messaging pattern that allows applications to have a two-way conversation, it is perhaps inappropriate under certain conditions. For example, a smart bond requiring an interest rate from an oracle might have to request the data on a daily basis under a request–response pattern in order to ensure the rate is always correct. Given that interest rates change infrequently, a publish–subscribe pattern may be more appropriate here—especially when taking into consideration Ethereum&#8217;s limited bandwidth.</p>
</div>
<div class="paragraph data-line-76">
<p>Publish–subscribe is a pattern where publishers (in this context, oracles) do not send messages directly to receivers, but instead categorize published messages into distinct classes. Subscribers are able to express an interest in one or more classes and retrieve only those messages that are of interest. Under such a pattern, an oracle might write the interest rate to its own internal storage each time it changes. Multiple subscribed DApps can simply read it from the oracle contract, thereby reducing the impact on network bandwidth while minimizing storage costs.</p>
</div>
<div class="paragraph data-line-78">
<p>In a broadcast or multicast pattern, an oracle would post all messages to a channel and subscribing contracts would listen to the channel under a variety of subscription modes. For example, an oracle might publish messages to a cryptocurrency exchange rate channel. A subscribing smart contract could request the full content of the channel if it required the time series for, e.g., a moving average calculation; another might require only the latest rate for a spot price calculation. A broadcast pattern is appropriate where the oracle does not need to know the identity of the subscribing <span class="keep-together">contract</span>.</p>
</div>
</div>
<div class="sect2 data-line-81">
<h3 id="data_authentication_sec">Data Authentication</h3>
<div class="paragraph data-line-83">
<p>If we assume that the source of data being queried by a DApp is both authoritative and trustworthy (a not insignificant assumption), an outstanding question remains: given that the oracle and the request–response mechanism may be operated by distinct entities, how are we able trust this mechanism? There is a distinct possibility that data may be tampered with in transit, so it is critical that off-chain methods are able to attest to the returned data&#8217;s integrity. Two common approaches to data authentication are <em>authenticity proofs</em> and <em>trusted execution environments</em> (TEEs).</p>
</div>
<div class="paragraph data-line-85">
<p>Authenticity proofs are cryptographic guarantees that data has not been tampered with. Based on a variety of attestation techniques (e.g., digitally signed proofs), they effectively shift the trust from the data carrier to the attestor (i.e., the provider of the attestation). By verifying the authenticity proof on-chain, smart contracts are able to verify the integrity of the data before operating upon it. <a href="http://www.oraclize.it/" data-href="http://www.oraclize.it/">Oraclize</a> is an example of an oracle service leveraging a variety of authenticity proofs. One such proof that is currently available for data queries from the Ethereum main network is the TLSNotary proof. TLSNotary proofs allow a client to provide evidence to a third party that HTTPS web traffic occurred between the client and a server. While HTTPS is itself secure, it doesn’t support data signing. As a result, TLSNotary proofs rely on TLSNotary (via PageSigner) signatures. TLSNotary proofs leverage the Transport Layer Security (TLS) protocol, enabling the TLS master key, which signs the data after it has been accessed, to be split between three parties: the server (the oracle), an auditee (Oraclize), and an auditor. Oraclize uses an Amazon Web Services (AWS) virtual machine instance as the auditor, which can be verified as having been unmodified since instantiation. This AWS instance stores the TLSNotary secret, allowing it to provide honesty proofs. Although it offers higher assurances against data tampering than a pure request–response mechanism, this approach does require the assumption that Amazon itself will not tamper with the VM instance.</p>
</div>
<div class="paragraph data-line-87">
<p><a href="http://www.town-crier.org/" data-href="http://www.town-crier.org/">Town Crier</a> is an authenticated data feed oracle system based on the TEE approach; such methods utilize hardware-based secure enclaves to ensure data integrity. Town Crier uses Intel&#8217;s  Software Guard eXtensions (SGX) to ensure that responses from HTTPS queries can be verified as authentic. SGX provides guarantees of integrity, ensuring that applications running within an enclave are protected by the CPU against tampering by any other process. It also provides confidentiality, ensuring that an application&#8217;s state is opaque to other processes when running within the enclave. And finally, SGX allows attestation, by generating a digitally signed proof that an application—securely identified by a hash of its build—is actually running within an enclave. By verifying this digital signature, it is possible for a decentralized application to prove that a Town Crier instance is running securely within an SGX enclave. This, in turn, proves that the instance has not been tampered with and that the data emitted by Town Crier is therefore authentic. The confidentiality property additionally enables Town Crier to handle private data by allowing data queries to be encrypted using the Town Crier instance&#8217;s public key. Operating an oracle&#8217;s query/response mechanism within an enclave such as SGX effectively allows us to think of it as running securely on trusted third-party hardware, ensuring that the requested data is returned untampered with (assuming that we trust Intel/SGX).</p>
</div>
</div>
<div class="sect2 data-line-90">
<h3 id="computation_oracles_sec">Computation Oracles</h3>
<div class="paragraph data-line-92">
<p>So far, we have only discussed oracles in the context of requesting and delivering data. However, oracles can also be used to perform arbitrary computation, a function that can be especially useful given Ethereum’s inherent block gas limit and comparatively expensive computation costs. Rather than just relaying the results of a query, computation oracles can be used to perform computation on a set of inputs and return a calculated result that may have been infeasible to calculate on-chain. For example, one might use a computation oracle to perform a computationally intensive regression calculation in order to estimate the yield of a bond contract.</p>
</div>
<div class="paragraph data-line-94">
<p>If you are willing to trust a centralized but auditable service, you can go again to Oraclize. They provide a service that allows decentralized applications to request the output of a computation performed in a sandboxed AWS virtual machine. The AWS instance creates an executable container from a user-configured Dockerfile packed in an archive that is uploaded to the Inter-Planetary File System (IPFS; see <a href="#data_storage_sec">Data Storage</a>). On request, Oraclize retrieves this archive using its hash and then initializes and executes the Docker container on AWS, passing any arguments that are provided to the application as environment variables. The containerized application performs the calculation, subject to a time constraint, and writes the result to standard output, where it can be retrieved by Oraclize and returned to the decentralized application. Oraclize currently offers this service on an auditable t2.micro AWS instance, so if the computation is of some nontrivial value, it is possible to check that the correct Docker container was executed. Nonetheless, this is not a truly decentralized solution.</p>
</div>
<div class="paragraph data-line-96">
<p>The concept of a 'cryptlet' as a standard for verifiable oracle truths has been formalized as part of Microsoft&#8217;s wider ESC Framework.  Cryptlets execute within an encrypted capsule that abstracts away the infrastructure, such as I/O, and has the CryptoDelegate attached so incoming and outgoing messages are signed, validated, and proven automatically.  Cryptlets support distributed transactions so that contract logic can take on complex multistep, multiblockchain, and external system transactions in an ACID manner.  This allows developers to create portable, isolated, and private resolutions of the truth for use in smart contracts. Cryptlets follow the format shown here:</p>
</div>
<div class="listingblock data-line-99">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">public class SampleContractCryptlet : Cryptlet
  {
        public SampleContractCryptlet(Guid id, Guid bindingId, string name,
            string address, IContainerServices hostContainer, bool contract)
            : base(id, bindingId, name, address, hostContainer, contract)
        {
            MessageApi = new CryptletMessageApi(GetType().FullName,
                new SampleContractConstructor())</code></pre>
</div>
</div>
<div class="paragraph data-line-110">
<p>For a more decentralized solution, we can turn to <a href="https://truebit.io/" data-href="https://truebit.io/">TrueBit</a>, which offers a solution for scalable and verifiable off-chain computation. They use a system of solvers and verifiers who are incentivized to perform computations and verification of those computations, respectively. Should a solution be challenged, an iterative verification process on subsets of the computation is performed on-chain—a kind of 'verification game'. The game proceeds through a series of rounds, each recursively checking a smaller and smaller subset of the computation. The game eventually reaches a final round, where the challenge is sufficiently trivial such that the judges—Ethereum miners—can make a final ruling on whether the challenge was met, on-chain. In effect, TrueBit is an implementation of a computation market, allowing decentralized applications to pay for verifiable computation to be performed outside of the network, but relying on Ethereum to enforce the rules of the verification game. In theory, this enables trustless smart contracts to securely perform any computation task.</p>
</div>
<div class="paragraph data-line-112">
<p>A broad range of applications exist for systems like TrueBit, ranging from machine learning to verification of proof of work. An example of the latter is the Doge–Ethereum bridge, which uses TrueBit to verify Dogecoin’s proof of work (Scrypt), which is a memory-hard and computationally intensive function that cannot be computed within the Ethereum block gas limit. By performing this verification on TrueBit, it has been possible to securely verify Dogecoin transactions within a smart contract on Ethereum&#8217;s Rinkeby testnet.</p>
</div>
</div>
<div class="sect2 data-line-115">
<h3 id="decentralized_orackes_sec">Decentralized Oracles</h3>
<div class="paragraph data-line-117">
<p>While centralized data or computation oracles suffice for many applications, they represent single points of failure in the Ethereum network. A number of schemes have been proposed around the idea of decentralized oracles as a means of ensuring data availability and the creation of a network of individual data providers with an on-chain data aggregation system.</p>
</div>
<div class="paragraph data-line-119">
<p><a href="https://www.smartcontract.com/link" data-href="https://www.smartcontract.com/link">ChainLink</a> has proposed a decentralized oracle network consisting of three key smart contracts&#x2014;a reputation contract, an order-matching contract, and an aggregation contract&#x2014;and an off-chain registry of data providers. The reputation contract is used to keep track of data providers' performance. Scores in the reputation contract are used to populate the off-chain registry. The order-matching contract selects bids from oracles using the reputation contract. It then finalizes a service-level agreement, which includes query parameters and the number of oracles required. This means that the purchaser needn’t transact with the individual oracles directly. The aggregation contract collects responses (submitted using a commit–reveal scheme) from multiple oracles, calculates the final collective result of the query, and finally feeds the results back into the reputation contract.</p>
</div>
<div class="paragraph data-line-121">
<p>One of the main challenges with such a decentralized approach is the formulation of the aggregation function. ChainLink proposes calculating a weighted response, allowing a validity score to be reported for each oracle response. Detecting an 'invalid' score here is nontrivial, since it relies on the premise that outlying data points, measured by deviations from responses provided by peers, are incorrect. Calculating a validity score based on the location of an oracle response among a distribution of responses risks penalizing correct answers over average ones. Therefore, ChainLink offers a standard set of aggregation contracts, but also allows customized aggregation contracts to be specified.</p>
</div>
<div class="paragraph data-line-123">
<p>A related idea is the SchellingCoin protocol. Here, multiple participants report values and the median is taken as the &#x201c;correct&#x201d; answer. Reporters are required to provide a deposit that is redistributed in favor of values that are closer to the median, therefore incentivizing the reporting of values that are similar to others. A common value, also known as the Schelling point, which respondents might consider as the natural and obvious target around which to coordinate is expected to be close to the actual value.</p>
</div>
<div class="paragraph data-line-125">
<p>Jason Teutsch of TrueBit recently proposed a new design for a decentralized off-chain data availability oracle. This design leverages a dedicated proof-of-work blockchain that is able to correctly report on whether or not registered data is available during a given epoch. Miners attempt to download, store, and propagate all currently registered data, thereby guaranteeing data is available locally. While such a system is expensive in the sense that every mining node stores and propagates all registered data, the system allows storage to be reused by releasing data after the registration period ends.</p>
</div>
</div>
<div class="sect2 data-line-128">
<h3 id="oracle_client_interfaces_in_solidity_sec">Oracle Client Interfaces in Solidity</h3>
<div class="paragraph data-line-130">
<p><a href="#using_oraclize_to_update_the_eth_usd">Using Oraclize to update the ETH/USD exchange rate from an external source</a> is a Solidity example demonstrating how Oraclize can be used to continuously poll for the ETH/USD price from an API and store the result in a usable manner.</p>
</div>
<div id="using_oraclize_to_update_the_eth_usd" class="exampleblock data-line-134">
<div class="title">Example 22. Using Oraclize to update the ETH/USD exchange rate from an external source</div>
<div class="content">
<div class="listingblock data-line-136">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">/*
   ETH/USD price ticker leveraging CryptoCompare API

   This contract keeps in storage an updated ETH/USD price,
   which is updated every 10 minutes.
 */

pragma solidity ^0.4.1;
import "github.com/oraclize/ethereum-api/oraclizeAPI.sol";

/*
   "oraclize_" prepended methods indicate inheritance from "usingOraclize"
 */
contract EthUsdPriceTicker is usingOraclize {

    uint public ethUsd;

    event newOraclizeQuery(string description);
    event newCallbackResult(string result);

    function EthUsdPriceTicker() payable {
        // signals TLSN proof generation and storage on IPFS
        oraclize_setProof(proofType_TLSNotary | proofStorage_IPFS);

        // requests query
        queryTicker();
    }

    function __callback(bytes32 _queryId, string _result, bytes _proof) public {
        if (msg.sender != oraclize_cbAddress()) throw;
        newCallbackResult(_result);

        /*
         * Parse the result string into an unsigned integer for on-chain use.
         * Uses inherited "parseInt" helper from "usingOraclize", allowing for
         * a string result such as "123.45" to be converted to uint 12345.
         */
        ethUsd = parseInt(_result, 2);

        // called from callback since we're polling the price
        queryTicker();
    }

    function queryTicker() external payable {
        if (oraclize_getPrice("URL") &gt; this.balance) {
            newOraclizeQuery("Oraclize query was NOT sent, please add some ETH
                to cover for the query fee");
        } else {
            newOraclizeQuery("Oraclize query was sent, standing by for the
                answer...");

            // query params are (delay in seconds, datasource type,
            // datasource argument)
            // specifies JSONPath, to fetch specific portion of JSON API result
            oraclize_query(60 * 10, "URL",
                "json(https://min-api.cryptocompare.com/data/price?\
                fsym=ETH&amp;tsyms=USD,EUR,GBP).USD");
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-200">
<p>To integrate with Oraclize, the contract EthUsdPriceTicker must be a child of <span class="keep-together"><code>usingOraclize</code></span>; the usingOraclize contract is defined in the <em>oraclizeAPI</em> file. The data request is made using the oraclize_query function, which is inherited from the usingOraclize contract. This is an overloaded function that expects at least two arguments:</p>
</div>
<div class="ulist data-line-202">
<ul>
<li class="data-line-202">
<p>The supported data source to use, such as URL, WolframAlpha, IPFS, or computation</p>
</li>
<li class="data-line-203">
<p>The argument for the given data source, which may include the use of JSON or XML parsing helpers</p>
</li>
</ul>
</div>
<div class="paragraph data-line-205">
<p>The price query is performed in the queryTicker function. In order to perform the query, Oraclize requires the payment of a small fee in ether, covering the gas cost for processing the result and transmitting it to the __callback function and an accompanying surcharge for the service. This amount is dependent on the data source and, where specified, the type of authenticity proof that is required. Once the data has been retrieved, the __callback function is called by an Oraclize-controlled account permissioned to do the callback; it passes in the response value and a unique queryId argument, which, for example, can be used to handle and track multiple pending callbacks from Oraclize.</p>
</div>
<div class="paragraph data-line-207">
<p>Financial data provider Thomson Reuters also provides an oracle service for Ethereum, called BlockOne IQ, allowing market and reference data to be requested by smart contracts running on private or permissioned networks. <a href="#contract_calling_the_blockone_iq_service_for_market_data">Contract calling the BlockOne IQ service for market data</a> shows the interface for the oracle, and a client contract that will make the request.</p>
</div>
<div id="contract_calling_the_blockone_iq_service_for_market_data" class="exampleblock data-line-211">
<div class="title">Example 23. Contract calling the BlockOne IQ service for market data</div>
<div class="content">
<div class="listingblock data-line-213">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.11;

contract Oracle {
    uint256 public divisor;
    function initRequest(
       uint256 queryType, function(uint256) external onSuccess,
       function(uint256
    ) external onFailure) public returns (uint256 id);
    function addArgumentToRequestUint(uint256 id, bytes32 name, uint256 arg) public;
    function addArgumentToRequestString(uint256 id, bytes32 name, bytes32 arg)
        public;
    function executeRequest(uint256 id) public;
    function getResponseUint(uint256 id, bytes32 name) public constant
        returns(uint256);
    function getResponseString(uint256 id, bytes32 name) public constant
        returns(bytes32);
    function getResponseError(uint256 id) public constant returns(bytes32);
    function deleteResponse(uint256 id) public constant;
}

contract OracleB1IQClient {

    Oracle private oracle;
    event LogError(bytes32 description);

    function OracleB1IQClient(address addr) external payable {
        oracle = Oracle(addr);
        getIntraday("IBM", now);
    }

    function getIntraday(bytes32 ric, uint256 timestamp) public {
        uint256 id = oracle.initRequest(0, this.handleSuccess, this.handleFailure);
        oracle.addArgumentToRequestString(id, "symbol", ric);
        oracle.addArgumentToRequestUint(id, "timestamp", timestamp);
        oracle.executeRequest(id);
    }

    function handleSuccess(uint256 id) public {
        assert(msg.sender == address(oracle));
        bytes32 ric = oracle.getResponseString(id, "symbol");
        uint256 open = oracle.getResponseUint(id, "open");
        uint256 high = oracle.getResponseUint(id, "high");
        uint256 low = oracle.getResponseUint(id, "low");
        uint256 close = oracle.getResponseUint(id, "close");
        uint256 bid = oracle.getResponseUint(id, "bid");
        uint256 ask = oracle.getResponseUint(id, "ask");
        uint256 timestamp = oracle.getResponseUint(id, "timestamp");
        oracle.deleteResponse(id);
        // Do something with the price data
    }

    function handleFailure(uint256 id) public {
        assert(msg.sender == address(oracle));
        bytes32 error = oracle.getResponseError(id);
        oracle.deleteResponse(id);
        emit LogError(error);
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-276">
<p>The data request is initiated using the initRequest function, which allows the query type (in this example, a request for an intraday price) to be specified, in addition to two callback functions.
This returns a uint256 identifier that can then be used to provide additional arguments. The addArgumentToRequestString function is used to specify the Reuters Instrument Code (RIC), here for IBM stock, and <span class="keep-together"><code>addArgumentToRequestUint</code></span> allows the timestamp to be specified. Now, passing in an alias for block.timestamp will retrieve the current price for IBM. The request is then executed by the executeRequest function. Once the request has been processed, the oracle contract will call the onSuccess callback function with the query identifier, allowing the resulting data to be retrieved; in the event of retrieval failure, the <span class="keep-together"><code>onFailure</code></span> callback will return an error code instead. The available fields that can be retrieved on success include open, high, low, close (OHLC), and bid/ask prices.</p>
</div>
</div>
<div class="sect2 data-line-280">
<h3 id="_conclusions_8">Conclusions</h3>
<div class="paragraph data-line-282">
<p>As you can see, oracles provide a crucial service to smart contracts: they bring external facts to contract execution. With that, of course, oracles also introduce a significant risk&#x2014;if they are trusted sources and can be compromised, they can result in compromised execution of the smart contracts they feed.</p>
</div>
<div class="paragraph data-line-284">
<p>Generally, when considering the use of an oracle be very careful about the <em>trust model</em>. If you assume the oracle can be trusted, you may be undermining the security of your smart contract by exposing it to potentially false inputs. That said, oracles can be very useful if the security assumptions are carefully considered.</p>
</div>
<div class="paragraph data-line-25">
<p>Decentralized oracles can resolve some of these concerns and offer Ethereum smart contracts trustless external data. Choose carefully and you can start exploring the bridge between Ethereum and the "real world" that oracles offer.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="decentralized_applications_chap">Applications décentralisées (DApps)</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>In this chapter we will explore the world of <em>decentralized applications</em>, or <em>DApps</em>. From the early days of Ethereum, the founders' vision was much broader than "smart contracts": no less than reinventing the web and creating a new world of DApps, aptly called <em>web3</em>. Smart contracts are a way to decentralize the controlling logic and payment functions of applications. Web3 DApps are about decentralizing all other aspects of an application: storage, messaging, naming, etc. (see <a href="#image_web3_suite">Web3: A decentralized web using smart contracts and P2P technologies</a>).</p>
</div>
<div id="image_web3_suite" class="imageblock data-line-8">
<div class="content">
<img src="images/web3suite.png" alt="Web3: A decentralized web using smart contracts and P2P Technologies">
</div>
<div class="title">Figure 41. Web3: A decentralized web using smart contracts and P2P technologies</div>
</div>
<div class="admonitionblock warning data-line-11">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-12">
<p>While "decentralized apps" are an audacious vision of the future, the term "DApp" is often applied to any smart contract with a web frontend. Some of these so-called DApps are highly centralized applications (CApps?). Beware of false DApps!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-15">
<p>In this chapter we will develop and deploy a sample DApp: an auction platform. You can find the source code in the book&#8217;s repository under <a href="http://bit.ly/2DcmjyA" data-href="http://bit.ly/2DcmjyA"><em>code/auction_dapp</em></a>. We will look at each aspect of an auction application and see how we can decentralize the application as much as possible. First, though, let&#8217;s take a closer look at the defining characteristics and advantages of DApps.</p>
</div>
<div class="sect2 data-line-18">
<h3 id="what_is_a_dapp_sec">What Is a DApp?</h3>
<div class="paragraph data-line-20">
<p>A DApp is an application that is mostly or entirely decentralized.</p>
</div>
<div class="paragraph data-line-22">
<p>Consider all the possible aspects of an application that may be decentralized:</p>
</div>
<div class="ulist data-line-24">
<ul>
<li class="data-line-24">
<p>Backend software (application logic)</p>
</li>
<li class="data-line-25">
<p>Frontend software</p>
</li>
<li class="data-line-26">
<p>Data storage</p>
</li>
<li class="data-line-27">
<p>Message communications</p>
</li>
<li class="data-line-28">
<p>Name resolution</p>
</li>
</ul>
</div>
<div class="paragraph data-line-30">
<p>Each of these can be somewhat centralized or somewhat decentralized. For example, a frontend can be developed as a web app that runs on a centralized server, or as a mobile app that runs on your device. The backend and storage can be on private servers and proprietary databases, or you can use a smart contract and P2P storage.</p>
</div>
<div class="paragraph data-line-32">
<p>There are many advantages to creating a DApp that a typical centralized architecture cannot provide:</p>
</div>
<div class="dlist data-line-34">
<dl>
<dt class="hdlist1">Resiliency</dt>
<dd>
<p>Because the business logic is controlled by a smart contract, a DApp backend will be fully distributed and managed on a blockchain platform. Unlike an application deployed on a centralized server, a DApp will have no downtime and will continue to be available as long as the platform is still operating.</p>
</dd>
<dt class="hdlist1">Transparency</dt>
<dd>
<p>The on-chain nature of a DApp allows everyone to inspect the code and be more sure about its function. Any interaction with the DApp will be stored forever in the blockchain.</p>
</dd>
<dt class="hdlist1">Censorship resistance</dt>
<dd>
<p>As long as a user has access to an Ethereum node (running one if necessary), the user will always be able to interact with a DApp without interference from any centralized control. No service provider, or even the owner of the smart contract, can alter the code once it is deployed on the network.</p>
</dd>
</dl>
</div>
<div class="paragraph data-line-43">
<p>In the Ethereum ecosystem as it stands today, there are very few truly decentralized apps&#x2014;most still rely on centralized services and servers for some part of their operation. In the future, we expect that it will be possible for every part of any DApp to be operated in a fully decentralized way.</p>
</div>
<div class="sect3 data-line-46">
<h4 id="blockchain_smart_contracts_sec">Backend (Smart Contract)</h4>
<div class="paragraph data-line-48">
<p>In a DApp, smart contracts are used to store the business logic (program code) and the related state of your application. You can think of a smart contract replacing a server-side (aka "backend") component in a regular application. This is an oversimplification, of course. One of the main differences is that any computation executed in a smart contract is very expensive and so should be kept as minimal as possible. It is therefore important to identify which aspects of the application need a trusted and decentralized execution platform.</p>
</div>
<div class="paragraph data-line-50">
<p>Ethereum smart contracts allow you to build architectures in which a network of smart contracts call and pass data between each other, reading and writing their own state variables as they go, with their complexity restricted only by the block gas limit. After you deploy your smart contract, your business logic could well be used by many other developers in the future.</p>
</div>
<div class="paragraph data-line-52">
<p>One major consideration of smart contract architecture design is the inability to change the code of a smart contract once it is deployed. It can be deleted if it is programmed with an accessible SELFDESTRUCT opcode, but other than complete removal, the code cannot be changed in any way.</p>
</div>
<div class="paragraph data-line-54">
<p>The second major consideration of smart contract architecture design is DApp size. A really large monolithic smart contract may cost a lot of gas to deploy and use. Therefore, some applications may choose to have off-chain computation and an external data source. Keep in mind, however, that having the core business logic of the DApp be dependent on external data (e.g., from a centralized server) means your users will have to trust these external resources.</p>
</div>
</div>
<div class="sect3 data-line-57">
<h4 id="front_end_web_ui_cec">Frontend (Web User Interface)</h4>
<div class="paragraph data-line-59">
<p>Unlike the business logic of the DApp, which requires a developer to understand the EVM and new languages such as Solidity, the client-side interface of a DApp can use standard web technologies (HTML, CSS, JavaScript, etc.). This allows a traditional web developer to use familiar tools, libraries, and frameworks. Interactions with Ethereum, such as signing messages, sending transactions, and managing keys, are often conducted through the web browser, via an extension such as MetaMask (see <a href="#intro_chapter">Les bases d&#39;Ethereum</a>).</p>
</div>
<div class="paragraph data-line-61">
<p>Although it is possible to create a mobile DApp as well, currently there are few resources to help create mobile DApp frontends, mainly due to the lack of mobile clients that can serve as a light client with key-management functionality.</p>
</div>
<div class="paragraph data-line-63">
<p>The frontend is usually linked to Ethereum via the <em>web3.js</em> JavaScript library, which is bundled with the frontend resources and served to a browser by a web server.</p>
</div>
</div>
<div class="sect3 data-line-66">
<h4 id="data_storage_sec">Data Storage</h4>
<div class="paragraph data-line-68">
<p>Due to high gas costs and the currently low block gas limit, smart contracts are not well suited to storing or processing large amounts of data. Hence, most DApps utilize off-chain data storage services, meaning they store the bulky data off the Ethereum chain, on a data storage platform. That data storage platform can be centralized (for example, a typical cloud database), or the data can be decentralized, stored on a P2P platform such as the IPFS, or Ethereum&#8217;s own Swarm platform.</p>
</div>
<div class="paragraph data-line-70">
<p>Decentralized P2P storage is ideal for storing and distributing large static assets such as images, videos, and the resources of the application&#8217;s frontend web interface (HTML, CSS, JavaScript, etc.). We&#8217;ll look at a few of the options next.</p>
</div>
<div class="sect4 data-line-73">
<h5 id="ipfs_sec">IPFS</h5>
<div class="paragraph data-line-75">
<p>The <em>Inter-Planetary File System</em> (IPFS) is a decentralized content-addressable storage system that distributes stored objects among peers in a P2P network. "Content addressable" means that each piece of content (file) is hashed and the hash is used to identify that file. You can then retrieve any file from any IPFS node by requesting it by its hash.</p>
</div>
<div class="paragraph data-line-77">
<p>IPFS aims to replace HTTP as the protocol of choice for delivery of web applications. Instead of storing a web application on a single server, the files are stored on IPFS and can be retrieved from any IPFS node.</p>
</div>
<div class="paragraph data-line-79">
<p>More information about IPFS can be found at <a href="https://ipfs.io" class="undefined" data-href="https://ipfs.io">https://ipfs.io</a>.</p>
</div>
</div>
<div class="sect4 data-line-83">
<h5 id="swarm_sec">Swarm</h5>
<div class="paragraph data-line-85">
<p>Swarm is another content-addressable P2P storage system, similar to IPFS. Swarm was created by the Ethereum Foundation, as part of the Go-Ethereum suite of tools. Like IPFS, it allows you to store files that get disseminated and replicated by Swarm nodes. You can access any Swarm file by referring to it by a hash. Swarm allows you to access a website from a decentralized P2P system, instead of a central web server.</p>
</div>
<div class="paragraph data-line-87">
<p>The home page for Swarm is itself stored on Swarm and accessible on your Swarm node or a gateway:
<a href="https://swarm-gateways.net/bzz:/theswarm.eth/" class="undefined" data-href="https://swarm-gateways.net/bzz:/theswarm.eth/">https://swarm-gateways.net/bzz:/theswarm.eth/</a>.</p>
</div>
</div>
</div>
<div class="sect3 data-line-92">
<h4 id="interdapp_coammunications_protocol_sec">Decentralized Message Communications Protocols</h4>
<div class="paragraph data-line-94">
<p>Another major component of any application is inter-process communication. That means being able to exchange messages between applications, between different instances of the application, or between users of the application. Traditionally, this is achieved by reliance on a centralized server. However, there are a variety of decentralized alternatives to server-based protocols, offering messaging over a P2P network. The most notable P2P messaging protocol for DApps is <a href="http://bit.ly/2CSls5h" data-href="http://bit.ly/2CSls5h"><em>Whisper</em></a>, which is part of the Ethereum Foundation&#8217;s Go-Ethereum suite of tools.</p>
</div>
<div class="paragraph data-line-96">
<p>The final aspect of an application that can be decentralized is name resolution. We&#8217;ll take a close look at Ethereum&#8217;s name service later in this chapter; now, though, let&#8217;s dig into an example.</p>
</div>
</div>
</div>
<div class="sect2 data-line-99">
<h3 id="auction_dapp_intro">A Basic DApp Example: Auction DApp</h3>
<div class="paragraph data-line-101">
<p>In this section we will start building an example DApp, to explore the various decentralization tools. Our DApp will implement a decentralized auction.</p>
</div>
<div class="paragraph data-line-103">
<p>The Auction DApp allows a user to register a "deed" token, which represents some unique asset, such as a house, a car, a trademark, etc. Once a token has been registered, the ownership of the token is transferred to the Auction DApp, allowing it to be listed for sale. The Auction DApp lists each of the registered tokens, allowing other users to place bids. During each auction, users can join a chat room created specifically for that auction. Once an auction is finalized, the deed token ownership is transferred to the winner of the auction.</p>
</div>
<div class="paragraph data-line-105">
<p>The overall auction process can be seen in <a href="#auction_dapp_overview">Auction DApp: A simple example auction DApp</a>.</p>
</div>
<div class="paragraph data-line-107">
<p>The main components of our Auction DApp are:</p>
</div>
<div class="ulist data-line-109">
<ul>
<li class="data-line-109">
<p>A smart contract implementing ERC721 non-fungible "deed" tokens (<code><span class="keep-together">DeedRepository</span></code>)</p>
</li>
<li class="data-line-110">
<p>A smart contract implementing an auction (AuctionRepository) to sell the deeds</p>
</li>
<li class="data-line-111">
<p>A web frontend using the Vue/Vuetify JavaScript framework</p>
</li>
<li class="data-line-112">
<p>The <em>web3.js</em> library to connect to Ethereum chains (via MetaMask or other clients)</p>
</li>
<li class="data-line-113">
<p>A Swarm client, to store resources such as images</p>
</li>
<li class="data-line-114">
<p>A Whisper client, to create per-auction chat rooms for all participants</p>
</li>
</ul>
</div>
<div id="auction_dapp_overview" class="imageblock data-line-118">
<div class="content">
<img src="images/auction_diagram.png" alt="Auction DApp: A simple example auction DApp">
</div>
<div class="title">Figure 42. Auction DApp: A simple example auction DApp</div>
</div>
<div class="paragraph data-line-120">
<p>You can find the source code for the auction DApp <a href="http://bit.ly/2DcmjyA" data-href="http://bit.ly/2DcmjyA">in the book&#8217;s repository</a>.</p>
</div>
<div class="sect3 data-line-123">
<h4 id="_auction_dapp_backend_smart_contracts">Auction DApp: Backend Smart Contracts</h4>
<div class="paragraph data-line-125">
<p>Our Auction DApp example is supported by two smart contracts that we need to deploy on an Ethereum blockchain in order to support the application: <code><span class="keep-together">AuctionRepository</span></code> and DeedRepository.</p>
</div>
<div class="paragraph data-line-127">
<p>Let&#8217;s start by looking at DeedRepository, shown in <a href="#deed_repository_code">DeedRepository.sol: An ERC721 deed token for use in an auction</a>. This contract is an ERC721-compatible non-fungible token (see <a href="#erc721">ERC721: Non-fungible Token (Deed) Standard</a>).</p>
</div>
<div id="deed_repository_code" class="exampleblock data-line-131">
<div class="title">Example 24. DeedRepository.sol: An ERC721 deed token for use in an auction</div>
<div class="content">
<div class="listingblock data-line-133">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.5.16;
import "./ERC721/ERC721Token.sol";

/**
 * @title Repository of ERC721 Deeds
 * This contract contains the list of deeds registered by users.
 * This is a demo to show how tokens (deeds) can be minted and added 
 * to the repository.
 */
contract DeedRepository is ERC721Token {


    /**
    * @dev Created a DeedRepository with a name and symbol
    * @param _name string represents the name of the repository
    * @param _symbol string represents the symbol of the repository
    */
    constructor(string memory _name, string memory _symbol) 
        public ERC721Token(_name, _symbol) {}
    
    /**
    * @dev Public function to register a new deed
    * @dev Call the ERC721Token minter
    * @param _tokenId uint256 represents a specific deed
    * @param _uri string containing metadata/uri
    */
    function registerDeed(uint256 _tokenId, string memory _uri) public {
        _mint(msg.sender, _tokenId);
        addDeedMetadata(_tokenId, _uri);
        emit DeedRegistered(msg.sender, _tokenId);
    }

    /**
    * @dev Public function to add metadata to a deed
    * @param _tokenId represents a specific deed
    * @param _uri text which describes the characteristics of a given deed
    * @return whether the deed metadata was added to the repository
    */
    function addDeedMetadata(uint256 _tokenId, string memory _uri) public returns(bool){
        _setTokenURI(_tokenId, _uri);
        return true;
    }

    /**
    * @dev Event is triggered if deed/token is registered
    * @param _by address of the registrar
    * @param _tokenId uint256 represents a specific deed
    */
    event DeedRegistered(address _by, uint256 _tokenId);
}</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-138">
<p>As you can see, the DeedRepository contract is a straightforward implementation of an ERC721-compatible token.</p>
</div>
<div class="paragraph data-line-140">
<p>Our Auction DApp uses the DeedRepository contract to issue and track tokens for each auction. The auction itself is orchestrated by the AuctionRepository contract. This contract is too long to include here in full, but <a href="#auction_repository_code">AuctionRepository.sol: The main Auction DApp smart contract</a> shows the main definition of the contract and data structures. The entire contract is available in the book&#8217;s <a href="https://bit.ly/2IaOo9i" data-href="https://bit.ly/2IaOo9i">GitHub repository</a>.</p>
</div>
<div id="auction_repository_code" class="exampleblock data-line-144">
<div class="title">Example 25. AuctionRepository.sol: The main Auction DApp smart contract</div>
<div class="content">
<div class="listingblock data-line-146">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">contract AuctionRepository {

    // Array with all auctions
    Auction[] public auctions;

    // Mapping from auction index to user bids
    mapping(uint256 =&gt; Bid[]) public auctionBids;

    // Mapping from owner to a list of owned auctions
    mapping(address =&gt; uint[]) public auctionOwner;

    // Bid struct to hold bidder and amount
    struct Bid {
        address from;
        uint256 amount;
    }

    // Auction struct which holds all the required info
    struct Auction {
        string name;
        uint256 blockDeadline;
        uint256 startPrice;
        string metadata;
        uint256 deedId;
        address deedRepositoryAddress;
        address owner;
        bool active;
        bool finalized;
    }</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph data-line-179">
<p>The AuctionRepository contract manages all auctions with the following functions:</p>
</div>
<div class="listingblock data-line-182">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">getCount()
getBidsCount(uint _auctionId)
getAuctionsOf(address _owner)
getCurrentBid(uint _auctionId)
getAuctionsCountOfOwner(address _owner)
getAuctionById(uint _auctionId)
createAuction(address _deedRepositoryAddress, uint256 _deedId,
              string _auctionTitle, string _metadata, uint256 _startPrice,
              uint _blockDeadline)
approveAndTransfer(address _from, address _to, address _deedRepositoryAddress,
                   uint256 _deedId)
cancelAuction(uint _auctionId)
finalizeAuction(uint _auctionId)
bidOnAuction(uint _auctionId)</code></pre>
</div>
</div>
<div class="paragraph data-line-199">
<p>You can deploy these contracts to the Ethereum blockchain of your choice (e.g., Ropsten) using truffle in the book&#8217;s repository:</p>
</div>
<pre data-type="programlisting">
$ <strong>cd code/auction_dapp/backend</strong>
$ <strong>truffle init</strong>
$ <strong>truffle compile</strong>
$ <strong>truffle migrate --network ropsten</strong>
</pre>
<div class="sect4 data-line-210">
<h5 id="_dapp_governance">DApp governance</h5>
<div class="paragraph data-line-212">
<p>If you read through the two smart contracts of the Auction DApp you will notice something important: there is no special account or role that has special privileges over the DApp. Each auction has an owner with some special capabilities, but the Auction DApp itself has no privileged user.</p>
</div>
<div class="paragraph data-line-214">
<p>This is a deliberate choice to decentralize the governance of the DApp and relinquish any control once it has been deployed. Some DApps, by comparison, have one or more privileged accounts with special capabilities, such as the ability to terminate the DApp contract, to override or change its configuration, or to "veto" certain operations. Usually, these governance functions are introduced in the DApp in order to avoid unknown problems that might arise due to a bug.</p>
</div>
<div class="paragraph data-line-216">
<p>The issue of governance is a particularly difficult one to solve, as it represents a double-edged sword. On the one side, privileged accounts are dangerous; if compromised, they can subvert the security of the DApp. On the other side, without any privileged account, there are no recovery options if a bug is found. We have seen both of these risks manifest in Ethereum DApps. In the case of The DAO (<a href="#real_world_example_the_dao">Real-World Example: The DAO</a> and <a href="#ethereum_fork_history">Historique de la fourche Ethereum</a>), there were some privileged accounts called the "curators," but they were very limited in their capabilities. Those accounts were not able to override the DAO attacker&#8217;s withdrawal of the funds. In a more recent case, the decentralized exchange Bancor experienced a massive theft because a privileged management account was compromised. Turns out, Bancor was not as decentralized as initially assumed.</p>
</div>
<div class="paragraph data-line-218">
<p>When building a DApp, you have to decide if you want to make the smart contracts truly independent, launching them and then having no control, or create privileged accounts and run the risk of those being compromised. Either choice carries risk, but in the long run, true DApps cannot have specialized access for privileged accounts&#x2014;that&#8217;s not decentralized.</p>
</div>
</div>
</div>
<div class="sect3 data-line-220">
<h4 id="_auction_dapp_frontend_user_interface">Auction DApp: Frontend User Interface</h4>
<div class="paragraph data-line-222">
<p>Once the Auction DApp&#8217;s contracts are deployed, you can interact with them using your favorite JavaScript console and web3.js, or another web3 library. However, most users will need an easy-to-use interface. Our Auction DApp user interface is built using the Vue2/Vuetify JavaScript framework from Google.</p>
</div>
<div class="paragraph data-line-224">
<p>You can find the user interface code in the <em>code/auction_dapp/frontend</em> folder in <a href="https://github.com/ethereumbook/ethereumbook" data-href="https://github.com/ethereumbook/ethereumbook">the book&#8217;s repository</a>. The directory has the following structure and contents:</p>
</div>
<div class="listingblock data-line-226">
<div class="content">
<pre>frontend/
|-- build
|   |-- build.js
|   |-- check-versions.js
|   |-- logo.png
|   |-- utils.js
|   |-- vue-loader.conf.js
|   |-- webpack.base.conf.js
|   |-- webpack.dev.conf.js
|   `-- webpack.prod.conf.js
|-- config
|   |-- dev.env.js
|   |-- index.js
|   `-- prod.env.js
|-- index.html
|-- package.json
|-- package-lock.json
|-- README.md
|-- src
|   |-- App.vue
|   |-- components
|   |   |-- Auction.vue
|   |   `-- Home.vue
|   |-- config.js
|   |-- contracts
|   |   |-- AuctionRepository.json
|   |   `-- DeedRepository.json
|   |-- main.js
|   |-- models
|   |   |-- AuctionRepository.js
|   |   |-- ChatRoom.js
|   |   `-- DeedRepository.js
|   `-- router
|       `-- index.js</pre>
</div>
</div>
<div class="paragraph data-line-263">
<p>Once you have deployed the contracts, edit the frontend configuration in <em>frontend/src/config.js</em> and enter the addresses of the DeedRepository and AuctionRepository contracts, as deployed. The frontend application also needs access to an Ethereum node offering a JSON-RPC and WebSockets interface. Once you&#8217;ve configured the frontend, launch it with a web server on your local machine:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm install</strong>
$ <strong>npm run dev</strong>
</pre>
<div class="paragraph data-line-272">
<p>The Auction DApp frontend will launch and will be accessible via any web browser at <a href="http://localhost:8080" class="undefined" data-href="http://localhost:8080">http://localhost:8080</a>.</p>
</div>
<div class="paragraph data-line-274">
<p>If all goes well you should see the screen shown in <a href="#auction_dapp_screen">Auction DApp user interface</a>, which illustrates the Auction DApp running in a web browser.</p>
</div>
<div id="auction_dapp_screen" class="imageblock data-line-278">
<div class="content">
<img src="images/auction_dapp_home_screen.png" alt="Auction DApp User interface">
</div>
<div class="title">Figure 43. Auction DApp user interface</div>
</div>
</div>
</div>
<div class="sect2 data-line-280">
<h3 id="_further_decentralizing_the_auction_dapp">Further Decentralizing the Auction DApp</h3>
<div class="paragraph data-line-282">
<p>Our DApp is already quite decentralized, but we can improve things.</p>
</div>
<div class="paragraph data-line-284">
<p>The AuctionRepository contract operates independently of any oversight, open to anyone. Once deployed it cannot be stopped, nor can any auction be controlled. Each auction has a separate chat room that allows anyone to communicate about the auction without censorship or identification. The various auction assets, such as the description and associated image, are stored on Swarm, making them hard to censor or block.</p>
</div>
<div class="paragraph data-line-286">
<p>Anyone can interact with the DApp by constructing transactions manually or by running the Vue frontend on their local machine. The DApp code itself is open source and developed collaboratively on a public repository.</p>
</div>
<div class="paragraph data-line-288">
<p>There are two things we can do to make this DApp decentralized and resilient:</p>
</div>
<div class="ulist data-line-290">
<ul>
<li class="data-line-290">
<p>Store all the application code on Swarm or IPFS.</p>
</li>
<li class="data-line-291">
<p>Access the DApp by reference to a name, using the Ethereum Name Service.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-293">
<p>We&#8217;ll explore the first option in the next section, and we&#8217;ll dig into the second in <a href="#ethereum_naming_system_ens">The Ethereum Name Service (ENS)</a>.</p>
</div>
</div>
<div class="sect2 data-line-295">
<h3 id="_storing_the_auction_dapp_on_swarm">Storing the Auction DApp on Swarm</h3>
<div class="paragraph data-line-297">
<p>We introduced Swarm in <a href="#swarm_sec">Swarm</a>, earlier in this chapter. Our Auction DApp already uses Swarm to store the icon image for each auction. This is a much more efficient solution than attempting to store data on Ethereum, which is expensive. It is also a lot more resilient than if these images were stored in a centralized service like a web server or file server.</p>
</div>
<div class="paragraph data-line-299">
<p>But we can take things one step further. We can store the entire frontend of the DApp itself in Swarm and run it from a Swarm node directly, instead of running a web server.</p>
</div>
<div class="sect3 data-line-301">
<h4 id="_preparing_swarm">Preparing Swarm</h4>
<div class="paragraph data-line-303">
<p>To get started, you need to install Swarm and initialize your Swarm node. Swarm is part of the Ethereum Foundation&#8217;s Go-Ethereum suite of tools. Refer to the instructions for installing Go-Ethereum in <a href="#go_ethereum_geth">Go-Ethereum (Geth)</a>, or to install a Swarm binary release, follow the instructions in the <a href="http://bit.ly/2Q75KXw" data-href="http://bit.ly/2Q75KXw">Swarm documentation</a>.</p>
</div>
<div class="paragraph data-line-305">
<p>Once you have installed Swarm, you can check that it is working correctly by running it with the version command:</p>
</div>
<pre data-type="programlisting">
$ <strong>swarm version</strong>
Version: 0.3
Git Commit: 37685930d953bcbe023f9bc65b135a8d8b8f1488
Go Version: go1.10.1
OS: linux
</pre>
<div class="paragraph data-line-317">
<p>To start running Swarm, you must tell it how to connect to an instance of Geth, to access the JSON-RPC API. Get it started by following the instructions in the <a href="https://swarm-guide.readthedocs.io/en/latest/gettingstarted.html" data-href="https://swarm-guide.readthedocs.io/en/latest/gettingstarted.html">Getting Started guide</a>.</p>
</div>
<div class="paragraph data-line-319">
<p>When you start Swarm, you should see something like this:</p>
</div>
<div class="listingblock data-line-321">
<div class="content">
<pre>Maximum peer count                       ETH=25 LES=0 total=25
Starting peer-to-peer node               instance=swarm/v0.3.1-225171a4/linux...
connecting to ENS API                    url=http://127.0.0.1:8545
swarm[5955]: [189B blob data]
Starting P2P networking
UDP listener up                          self=enode://f50c8e19ff841bcd5ce7d2d...
Updated bzz local addr                   oaddr=9c40be8b83e648d50f40ad3... uaddr=e
Starting Swarm service
9c40be8b hive starting
detected an existing store. trying to load peers
hive 9c40be8b: peers loaded
Swarm network started on bzz address: 9c40be8b83e648d50f40ad3d35f...
Pss started
Streamer started
IPC endpoint opened                      url=/home/ubuntu/.ethereum/bzzd.ipc
RLPx listener up                         self=enode://f50c8e19ff841bcd5ce7d2d...</pre>
</div>
</div>
<div class="paragraph data-line-340">
<p>You can confirm that your Swarm node is running correctly by connecting to the local Swarm gateway web interface:
<a href="http://localhost:8500" class="undefined" data-href="http://localhost:8500">http://localhost:8500</a>.</p>
</div>
<div class="paragraph data-line-343">
<p>You should see a screen like the one in <a href="#image_swarm_gateway">Swarm gateway on localhost</a> and be able to query any Swarm hash or ENS name.</p>
</div>
<div id="image_swarm_gateway" class="imageblock data-line-347">
<div class="content">
<img src="images/swarm-gateway.png" alt="Swarm gateway on localhost">
</div>
<div class="title">Figure 44. Swarm gateway on localhost</div>
</div>
</div>
<div class="sect3 data-line-349">
<h4 id="_uploading_files_to_swarm">Uploading Files to Swarm</h4>
<div class="paragraph data-line-351">
<p>Once you have your local Swarm node and gateway running, you can upload to Swarm and the files will be accessible on any Swarm node, simply by reference to the file hash.</p>
</div>
<div class="paragraph data-line-353">
<p>Let&#8217;s test this by uploading a file:</p>
</div>
<pre data-type="programlisting">
$ <strong>swarm up code/auction_dapp/README.md</strong>
ec13042c83ffc2fb5cb0aa8c53f770d36c9b3b35d0468a0c0a77c97016bb8d7c
</pre>
<div class="paragraph data-line-362">
<p>Swarm has uploaded the <em>README.md</em> file and returned a hash that you can use to access the file from any Swarm node. For example, you could use the <a href="https://bit.ly/2znWUP9" data-href="https://bit.ly/2znWUP9">public Swarm gateway</a>.</p>
</div>
<div class="paragraph data-line-364">
<p>While uploading one file is relatively straightforward, it is a bit more complex to upload an entire DApp frontend. That&#8217;s because the various DApp resources (HTML, CSS, JavaScript, libraries, etc.) have embedded references to each other. Normally, a web server translates URLs to local files and serves the correct resources. We can achieve the same for Swarm by packaging our DApp.</p>
</div>
<div class="paragraph data-line-366">
<p>In the Auction DApp, there&#8217;s a script for packaging all the resources:</p>
</div>
<pre data-type="programlisting">
$ <strong>cd code/auction_dapp/frontend</strong>
$ <strong>npm run build</strong>

> <strong>frontend@1.0.0 build /home/aantonop/Dev/ethereumbook/code/auction_dapp/frontend</strong>
> <strong>node build/build.js</strong>

Hash: 9ee134d8db3c44dd574d
Version: webpack 3.10.0
Time: 25665ms
Asset     Size
static/js/vendor.77913f316aaf102cec11.js  1.25 MB
static/js/app.5396ead17892922422d4.js   502 kB
static/js/manifest.87447dd4f5e60a5f9652.js  1.54 kB
static/css/app.0e50d6a1d2b1ed4daa03d306ced779cc.css  1.13 kB
static/css/app.0e50d6a1d2b1ed4daa03d306ced779cc.css.map  2.54 kB
static/js/vendor.77913f316aaf102cec11.js.map  4.74 MB
static/js/app.5396ead17892922422d4.js.map   893 kB
static/js/manifest.87447dd4f5e60a5f9652.js.map  7.86 kB
index.html  1.15 kB

Build complete.
</pre>
<div class="paragraph data-line-394">
<p>The result of this command will be a new directory, <em>code/auction_dapp/frontend/dist</em>, that contains the entire Auction DApp frontend, packed together:</p>
</div>
<div class="listingblock data-line-396">
<div class="content">
<pre>dist/
|-- index.html
`-- static
    |-- css
    |   |-- app.0e50d6a1d2b1ed4daa03d306ced779cc.css
    |   `-- app.0e50d6a1d2b1ed4daa03d306ced779cc.css.map
    `-- js
        |-- app.5396ead17892922422d4.js
        |-- app.5396ead17892922422d4.js.map
        |-- manifest.87447dd4f5e60a5f9652.js
        |-- manifest.87447dd4f5e60a5f9652.js.map
        |-- vendor.77913f316aaf102cec11.js
        `-- vendor.77913f316aaf102cec11.js.map</pre>
</div>
</div>
<div class="paragraph data-line-413">
<p>Now you can upload the entire DApp to Swarm, by using the up command and the --recursive option. Here, we also tell Swarm that index.html is the defaultpath for loading this DApp:</p>
</div>
<pre data-type="programlisting">
$ <strong>swarm --bzzapi http://localhost:8500 --recursive \
  --defaultpath dist/index.html up dist/</strong>

ab164cf37dc10647e43a233486cdeffa8334b026e32a480dd9cbd020c12d4581
</pre>
<div class="paragraph data-line-424">
<p>Now, our entire Auction DApp is hosted on Swarm and accessible by the Swarm URL:</p>
</div>
<ul class="simplelist">
<li><em>bzz://ab164cf37dc10647e43a233486cdeffa8334b026e32a480dd9cbd020c12d4581</em></li>
</ul>
<div class="paragraph data-line-432">
<p>We&#8217;ve made some progress in decentralizing our DApp, but we&#8217;ve made it harder to use. A URL like that is much less user-friendly than a nice name like <em>auction_dapp.com</em>. Are we forced to sacrifice usability in order to gain decentralization? Not necessarily. In the next section we will examine Ethereum&#8217;s name service, which allows us to use easy-to-read names but still preserves the decentralized nature of our application.</p>
</div>
</div>
</div>
<div class="sect2 data-line-435">
<h3 id="ethereum_naming_system_ens">The Ethereum Name Service (ENS)</h3>
<div class="paragraph data-line-437">
<p>You can design the best smart contract in the world, but if you don&#8217;t provide a good interface for users, they won&#8217;t be able to access it.</p>
</div>
<div class="paragraph data-line-439">
<p>On the traditional internet, the Domain Name System (DNS) allows us to use human-readable names in the browser while resolving those names to IP addresses or other identifiers behind the scenes. On the Ethereum blockchain, the <em>Ethereum Naming System</em> (ENS) solves the same problem, but in a decentralized manner.</p>
</div>
<div class="paragraph data-line-441">
<p>For example, the Ethereum Foundation donation address is 0xfB6916095ca1df60bB79Ce92cE3Ea74c37c5d359; in a wallet that supports ENS, it&#8217;s simply ethereum.eth.</p>
</div>
<div class="paragraph data-line-443">
<p>ENS is more than a smart contract; it&#8217;s a fundamental DApp itself, offering a decentralized name service. Furthermore, ENS is supported by a number of DApps for registration, management, and auctions of registered names. ENS demonstrates how DApps can work together: it&#8217;s DApp built to serve other DApps, supported by an ecosystem of DApps, embedded in other DApps, and so on.</p>
</div>
<div class="paragraph data-line-445">
<p>In this section we will look at how ENS works. We&#8217;ll demonstrate how you can set up your own name and link it to a wallet or Ethereum address, how you can embed ENS in another DApp, and how you can use ENS to name your DApp resources to make them easier to use.</p>
</div>
<div class="sect3 data-line-447">
<h4 id="_history_of_ethereum_name_services">History of Ethereum Name Services</h4>
<div class="paragraph data-line-449">
<p>Name registration was the first noncurrency application of blockchains, pioneered by Namecoin. The Ethereum <a href="http://bit.ly/2Of1gfZ" data-href="http://bit.ly/2Of1gfZ">White Paper</a> gave a two-line Namecoin-like registration system as one of its example applications.</p>
</div>
<div class="paragraph data-line-451">
<p>Early releases of Geth and the C++ Ethereum client had a built-in namereg contract (not used any more), and many proposals and ERCs for name services were made, but it was only when Nick Johnson started working for the Ethereum Foundation in 2016 and took the project under his wing that serious work on a registrar started.</p>
</div>
<div class="paragraph data-line-453">
<p>ENS was launched on Star Wars Day, May 4, 2017 (after a failed attempt to launch it on Pi Day, March 15).</p>
</div>
</div>
<div class="sect3 data-line-455">
<h4 id="_the_ens_specification">The ENS Specification</h4>
<div class="paragraph data-line-457">
<p>ENS is specified mainly in three Ethereum Improvement Proposals: EIP-137, which specifies the basic functions of ENS; EIP-162, which describes the auction system for the .eth root; and EIP-181, which specifies reverse resolution of addresses.</p>
</div>
<div class="paragraph data-line-459">
<p>ENS follows a "sandwich" design philosophy: a very simple layer on the bottom, followed by layers of more complex but replaceable code, with a very simple top layer that keeps all the funds in separate accounts.</p>
</div>
</div>
<div class="sect3 data-line-461">
<h4 id="_bottom_layer_name_owners_and_resolvers">Bottom Layer: Name Owners and Resolvers</h4>
<div class="paragraph data-line-463">
<p>The ENS operates on "nodes" instead of human-readable names: a human-readable name is converted to a node using the "Namehash" algorithm.</p>
</div>
<div class="paragraph data-line-465">
<p>The base layer of ENS is a cleverly simple contract (less than 50 lines of code) defined by ERC137 that allows only nodes' owners to set information about their names and to create subnodes (the ENS equivalent of DNS subdomains).</p>
</div>
<div class="paragraph data-line-467">
<p>The only functions on the base layer are those that enable a node owner to set information about their own node (specifically the resolver, time to live, or transferring the ownership) and to create owners of new subnodes.</p>
</div>
<div class="sect4 data-line-469">
<h5 id="_the_namehash_algorithm">The Namehash algorithm</h5>
<div class="paragraph data-line-471">
<p>Namehash is a recursive algorithm that can convert any name into a hash that identifies the name.</p>
</div>
<div class="paragraph data-line-473">
<p>"Recursive" means that we solve the problem by solving a subproblem that is a smaller problem of the same type, and then use the solution to the subproblem to solve the original problem.</p>
</div>
<div class="paragraph data-line-475">
<p>Namehash recursively hashes components of the name, producing a unique, fixed-length string (or &#x201c;node&#x201d;) for any valid input domain. For example, the Namehash node of subdomain.example.eth is <code>keccak('&lt;example.eth&gt;' node) + keccak('&lt;subdomain&gt;')</code>. The subproblem we must solve is to compute the node for example.eth, which is <code>keccak('&lt;.eth&gt;' node) + keccak('&lt;example&gt;')</code>.  To begin, we must compute the node for eth, which is <code>keccak(&lt;root node&gt;) + keccak('&lt;eth&gt;')</code>.</p>
</div>
<div class="paragraph data-line-477">
<p>The root node is what we call the "base case" of our recursion, and we obviously can&#8217;t define it recursively, or the algorithm will never terminate! The root node is defined as <code>0x0000000000000000000000000000000000000000000000000000000000000000</code> (32 zero bytes).</p>
</div>
<div class="paragraph data-line-479">
<p>Putting this all together, the node of subdomain.example.eth is therefore <code><span class="keep-together">keccak</span>(keccak(keccak(0x0...0 + keccak('eth')) + keccak('example')) + keccak('subdomain'))</code>.</p>
</div>
<div class="paragraph data-line-481">
<p>Generalizing, we can define the Namehash function as follows (the base case for the root node, or empty name, followed by the recursive step):</p>
</div>
<div class="literalblock data-line-483">
<div class="content">
<pre>namehash([]) = 0x0000000000000000000000000000000000000000000000000000000000000000
namehash([label, ...]) = keccak256(namehash(...) + keccak256(label))</pre>
</div>
</div>
<div class="paragraph data-line-488">
<p>In Python this becomes:</p>
</div>
<div class="literalblock data-line-490">
<div class="content">
<pre>def namehash(name):
  if name == '':
    return '\0' * 32
  else:
    label, _, remainder = name.partition('.')
    return sha3(namehash(remainder) + sha3(label))</pre>
</div>
</div>
<div class="paragraph data-line-499">
<p>Thus, mastering-ethereum.eth will be processed as follows:</p>
</div>
<div class="literalblock data-line-501">
<div class="content">
<pre>namehash('mastering-ethereum.eth')
⇒ sha3(namehash('eth') + sha3('mastering-ethereum'))
⇒ sha3(sha3(namehash('') + sha3('eth')) + sha3('mastering-ethereum'))
⇒ sha3(sha3(('\0' * 32) + sha3('eth')) + sha3('mastering-ethereum'))</pre>
</div>
</div>
<div class="paragraph data-line-508">
<p>Of course, subdomains can themselves have subdomains: there could be a sub.subdomain.example.eth after subdomain.example.eth, then a sub.sub.subdomain.example.eth, and so on. To avoid expensive recomputation, since Namehash depends only on the name itself, the node for a given name can be precomputed and inserted into a contract, removing the need for string manipulation and permitting immediate lookup of ENS records regardless of the number of components in the raw name.</p>
</div>
</div>
<div class="sect4 data-line-510">
<h5 id="_how_to_choose_a_valid_name">How to choose a valid name</h5>
<div class="paragraph data-line-511">
<p>Names consist of a series of dot-separated labels. Although upper- and lowercase letters are allowed, all labels should follow a UTS &#x23;46 normalization process that case-folds labels before hashing them, so names with different case but identical spelling will end up with the same Namehash.</p>
</div>
<div class="paragraph data-line-513">
<p>You could use labels and domains of any length, but for the sake of compatibility with legacy DNS, the following rules are recommended:</p>
</div>
<div class="ulist data-line-515">
<ul>
<li class="data-line-515">
<p>Labels should be no more than 64 characters each.</p>
</li>
<li class="data-line-516">
<p>Complete ENS names should be no more than 255 characters.</p>
</li>
<li class="data-line-517">
<p>Labels should not start or end with hyphens, or start with digits.</p>
</li>
</ul>
</div>
</div>
<div class="sect4 data-line-519">
<h5 id="_root_node_ownership">Root node ownership</h5>
<div class="paragraph data-line-521">
<p>One of the results of this hierarchical system is that it relies on the owners of the root node, who are able to create top-level domains (TLDs).</p>
</div>
<div class="paragraph data-line-523">
<p>While the eventual goal is to adopt a decentralized decision-making process for new TLDs, at the time of writing the root node is controlled by a 4-of-7 multisig, held by people in different countries (built as a reflection of the 7 keyholders of the DNS system).
As a result, a majority of at least 4 of the 7 keyholders is required to effect any change.</p>
</div>
<div class="paragraph data-line-526">
<p>Currently the purpose and goal of these keyholders is to work in consensus with the community to:</p>
</div>
<div class="ulist data-line-528">
<ul>
<li class="data-line-528">
<p>Migrate and upgrade the temporary ownership of the .eth TLD to a more permanent contract once the system is evaluated.</p>
</li>
<li class="data-line-529">
<p>Allow adding new TLDs, if the community agrees they are needed.</p>
</li>
<li class="data-line-530">
<p>Migrate the ownership of the root multisig to a more decentralized contract, when such a system is agreed upon, tested, and implemented.</p>
</li>
<li class="data-line-531">
<p>Serve as a last-resort way to deal with any bugs or vulnerabilities in the top-level registries.</p>
</li>
</ul>
</div>
</div>
<div class="sect4 data-line-533">
<h5 id="_resolvers">Resolvers</h5>
<div class="paragraph data-line-535">
<p>The basic ENS contract can&#8217;t add metadata to names; that is the job of so-called "resolver contracts." These are user-created contracts that can answer questions about the name, such as what Swarm address is associated with the app, what address receives payments to the app (in ether or tokens), or what the hash of the app is (to verify its integrity).</p>
</div>
</div>
</div>
<div class="sect3 data-line-537">
<h4 id="_middle_layer_the_eth_nodes">Middle Layer: The .eth Nodes</h4>
<div class="paragraph data-line-539">
<p>At the time of writing, the only top-level domain that is uniquely registrable in a smart contract is .eth.</p>
</div>
<div class="admonitionblock note data-line-542">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-543">
<p>There&#8217;s work underway on enabling traditional DNS domain owners to claim ENS ownership.
While in theory this could work for .com, the only domain that this has been implemented for so far is <a href="http://bit.ly/2SwUuFC" data-href="http://bit.ly/2SwUuFC">.xyz, and only on the Ropsten testnet</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-547">
<p>.eth domains are distributed via an auction system. There is no reserved list or priority, and the only way to acquire a name is to use the system. The auction system is a complex piece of code (over 500 lines); most of the early development efforts (and bugs!) in ENS were in this part of the system. However, it&#8217;s also replaceable and upgradeable, without risk to the funds—more on that later.</p>
</div>
<div class="sect4 data-line-550">
<h5 id="vickrey_auction">Vickrey auctions</h5>
<div class="paragraph data-line-552">
<p>Names are distributed via a modified Vickrey auction. In a traditional Vickrey auction, every bidder submits a sealed bid, and all of them are revealed simultaneously, at which point the highest bidder wins the auction but only pays the second-highest bid. Therefore bidders are incentivized not to bid less than the true value of the name to them, since bidding their true value increases the chance they will win but does not affect the price they will eventually pay.</p>
</div>
<div class="paragraph data-line-554">
<p>On a blockchain, some changes are required:</p>
</div>
<div class="ulist data-line-556">
<ul>
<li class="data-line-556">
<p>To ensure bidders don&#8217;t submit bids they have no intention of paying, they must lock up a value equal to or higher than their bid beforehand, to guarantee the bid is valid.</p>
</li>
<li class="data-line-557">
<p>Because you can&#8217;t hide secrets on a blockchain, bidders must execute at least two transactions (a commit–reveal process), in order to hide the original value and name they bid on.</p>
</li>
<li class="data-line-558">
<p>Since you can&#8217;t reveal all bids simultaneously in a decentralized system, bidders must reveal their own bids themselves; if they don&#8217;t, they forfeit their locked-up funds. Without this forfeit, one could make many bids and choose to reveal only one or two, turning a sealed-bid auction into a traditional increasing price <span class="keep-together">auction</span>.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-560">
<p>Therefore, the auction is a four-step process:</p>
</div>
<div class="olist arabic data-line-562">
<ol class="arabic">
<li class="data-line-562">
<p>Start the auction. This is required to broadcast the intent to register a name.
This creates all auction deadlines. The names are hashed, so that only those who have the name in their dictionary will know which auction was opened. This allows some privacy, which is useful if you are creating a new project and don&#8217;t want to share details about it.
You can open multiple dummy auctions at the same time, so if someone is following you they cannot simply bid on all auctions you open.</p>
</li>
<li class="data-line-566">
<p>Make a sealed bid. You must do this before the bidding deadline, by tying a given amount of ether to the hash of a secret message (containing, among other things, the hash of the name, the actual amount of the bid, and a salt).
You can lock up more ether than you are actually bidding in order to mask your true valuation.</p>
</li>
<li class="data-line-569">
<p>Reveal the bid. During the reveal period, you must make a transaction that reveals the bid, which will then calculate the highest bid and the second-highest bid and send ether back to unsuccessful bidders.
Every time the bid is revealed the current winner is recalculated; therefore, the last one to be set before the revealing deadline expires becomes the overall winner.</p>
</li>
<li class="data-line-572">
<p>Clean up after. If you are the winner, you can finalize the auction in order to get back the difference between your bid and the second-highest bid.
If you forgot to reveal you can make a late reveal and recover a little of your bid.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3 data-line-575">
<h4 id="_top_layer_the_deeds">Top Layer: The Deeds</h4>
<div class="paragraph data-line-577">
<p>The top layer of ENS is yet another super-simple contract with a single purpose: to hold the funds.</p>
</div>
<div class="paragraph data-line-579">
<p>When you win a name, the funds are not actually sent anywhere, but are just locked up for the period you want to hold the name (at least a year).
This works like a guaranteed buyback: if the owner does not want the name any more they can sell it back to the system and recover their ether (so the cost of holding the name is the opportunity cost of doing something with a return greater than zero).</p>
</div>
<div class="paragraph data-line-582">
<p>Of course, having a single contract hold millions of dollars in ether has proven to be very risky, so instead ENS creates a deed contract for each new name.
The deed contract is very simple (about 50 lines of code), and it only allows the funds to be transferred back to a single account (the deed owner) and to be called by a single entity (the registrar contract).
This approach drastically reduces the attack surface where bugs can put the funds at risk.</p>
</div>
</div>
<div class="sect3 data-line-586">
<h4 id="_registering_a_name">Registering a Name</h4>
<div class="paragraph data-line-588">
<p>Registering a name in ENS is a four-step process, as we saw in  <a href="#vickrey_auction">Vickrey auctions</a>. First we place a bid for any available name, then we reveal our bid after 48 hours to secure the name. <a href="#ens_registration_timeline">ENS timeline for registration</a> is a diagram showing the timeline of registration.</p>
</div>
<div class="paragraph data-line-590">
<p>Let&#8217;s register our first name!</p>
</div>
<div class="paragraph data-line-592">
<p>We will use one of several available user-friendly interfaces to search for available names, place a bid on the name ethereumbook.eth, reveal the bid, and secure the name.</p>
</div>
<div class="paragraph data-line-594">
<p>There are a number of web-based interfaces to ENS that allow us to interact with the ENS DApp. For this example, we will use the <a href="https://mycrypto.com/" data-href="https://mycrypto.com/">MyCrypto interface</a>, in conjunction with MetaMask as our wallet.</p>
</div>
<div id="ens_registration_timeline" class="imageblock data-line-598">
<div class="content">
<img src="images/ens-flow.png" alt="ens flow">
</div>
<div class="title">Figure 45. ENS timeline for registration</div>
</div>
<div class="paragraph data-line-602">
<p>First, we need to make sure the name we want is available. While writing this book, we really wanted to register the name mastering.eth, but alas, <a href="#ens-name-search">Searching for ENS names on MyCrypto.com</a> revealed it was already taken! Because ENS registrations only last one year, it might become possible to secure that name in the future. In the meantime, let&#8217;s search for ethereumbook.eth (<a href="#ens-name-search">Searching for ENS names on MyCrypto.com</a>).</p>
</div>
<div id="ens-name-search" class="imageblock data-line-606">
<div class="content">
<img src="images/ens-checkname.png" alt="Searching for ENS names on MyCrypto.com">
</div>
<div class="title">Figure 46. Searching for ENS names on MyCrypto.com</div>
</div>
<div class="paragraph data-line-608">
<p>Great! The name is available. In order to register it, we need to move forward with <a href="#ens-auction">Starting an auction for an ENS name</a>. Let&#8217;s unlock MetaMask and start an auction for ethereumbook.eth.</p>
</div>
<div id="ens-auction" class="imageblock data-line-613">
<div class="content">
<img src="images/ens-auction.png" alt="Starting an auction for an ENS name">
</div>
<div class="title">Figure 47. Starting an auction for an ENS name</div>
</div>
<div class="paragraph data-line-616">
<p>Let&#8217;s make our bid. In order to do that we need to follow the steps in <a href="#ens-bid">Placing a bid for an ENS name</a>.</p>
</div>
<div id="ens-bid" class="imageblock data-line-621">
<div class="content">
<img src="images/ens-bid.png" alt="Placing a bid for an ENS name">
</div>
<div class="title">Figure 48. Placing a bid for an ENS name</div>
</div>
<div class="admonitionblock warning data-line-624">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph data-line-625">
<p>As mentioned in <a href="#vickrey_auction">Vickrey auctions</a>, you must reveal your bid within 48 hours after the auction is complete, or you <em>lose the funds in your bid</em>. Did we forget to do this and lose 0.01 ETH ourselves? You bet we did.</p>
</div>
<div class="paragraph data-line-627">
<p>Take a screenshot, save your secret phrase (as a backup for your bid), and add a reminder in your calendar for the reveal date and time, so you don&#8217;t forget and lose your funds.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-630">
<p>Finally, we confirm the transaction by clicking the big green submit button shown in <a href="#ens-metamask-bid">MetaMask transaction containing your bid</a>.</p>
</div>
<div id="ens-metamask-bid" class="imageblock data-line-634">
<div class="content">
<img src="images/ens-metamask-bid.png" alt="MetaMask transaction containing your bid">
</div>
<div class="title">Figure 49. MetaMask transaction containing your bid</div>
</div>
<div class="paragraph data-line-636">
<p>If all goes well, after submitting a transaction in this way you can return and reveal the bid in 48 hours, and the name you requested will be registered to your Ethereum address.</p>
</div>
</div>
<div class="sect3 data-line-638">
<h4 id="_managing_your_ens_name">Managing Your ENS Name</h4>
<div class="paragraph data-line-640">
<p>Once you have registered an ENS name, you can manage it using another user-friendly interface: <a href="https://manager.ens.domains/" data-href="https://manager.ens.domains/">ENS Manager</a>.</p>
</div>
<div class="paragraph data-line-643">
<p>Once there, enter the name you want to manage in the search box (see <a href="#ens-manager">The ENS Manager web interface</a>). You need to have your Ethereum wallet  (e.g., MetaMask) unlocked, so that the ENS Manager DApp can manage the name on your behalf.</p>
</div>
<div id="ens-manager" class="imageblock data-line-647">
<div class="content">
<img src="images/ens-manager.png" alt="The ENS Manager web interface">
</div>
<div class="title">Figure 50. The ENS Manager web interface</div>
</div>
<div class="paragraph data-line-649">
<p>From this interface, we can create subdomains, set a resolver contract (more on that later), and connect each name to the appropriate resource, such as the Swarm address of a DApp frontend.</p>
</div>
<div class="sect4 data-line-651">
<h5 id="_creating_an_ens_subdomain">Creating an ENS subdomain</h5>
<div class="paragraph data-line-653">
<p>First, let&#8217;s create a subdomain for our example Auction DApp (see <a href="#ens-manager-add-subdomain">Adding the subdomain auction.ethereumbook.eth</a>). We will name the subdomain auction, so the fully qualified name will be auction.ethereumbook.eth.</p>
</div>
<div id="ens-manager-add-subdomain" class="imageblock data-line-657">
<div class="content">
<img src="images/ens_manager_add_subdomain.png" alt="Adding the subdomain auction.ethereumbook.eth">
</div>
<div class="title">Figure 51. Adding the subdomain auction.ethereumbook.eth</div>
</div>
<div class="paragraph data-line-659">
<p>Once we&#8217;ve created the subdomain, we can enter auction.ethereumbook.eth in the search box and manage it, just as we managed the domain ethereumbook.eth <span class="keep-together">previously</span>.</p>
</div>
</div>
</div>
<div class="sect3 pagebreak-before data-line-662">
<h4 id="_ens_resolvers">ENS Resolvers</h4>
<div class="paragraph data-line-664">
<p>In ENS, resolving a name is a two-step process:</p>
</div>
<div class="olist arabic data-line-666">
<ol class="arabic">
<li class="data-line-666">
<p>The ENS registry is called with the name to resolve after hashing it.
If the record exists, the registry returns the address of its resolver.</p>
</li>
<li class="data-line-669">
<p>The resolver is called, using the method appropriate to the resource being requested. The resolver returns the desired result.</p>
</li>
</ol>
</div>
<div class="paragraph data-line-671">
<p>This two-step process has several benefits. Separating the functionality of resolvers from the naming system itself gives us a lot more flexibility. The owners of names can use custom resolvers to resolve any type or resource, extending the functionality of ENS. For example, if in the future you wanted to link a geolocation resource (longitude/lattitude) to an ENS name, you could create a new resolver that answers a <span class="keep-together"><code>geolocation</code></span> query. Who knows what applications might be useful in the future? With custom resolvers, the only limitation is your imagination.</p>
</div>
<div class="paragraph data-line-673">
<p>For convenience, there is a default public resolver that can resolve a variety of resources, including the address (for wallets or contracts) and content (a Swarm hash for DApps or contract source code).</p>
</div>
<div class="paragraph data-line-675">
<p>Since we want to link our Auction DApp to a Swarm hash, we can use the public resolver, which supports content resolution, as shown in <a href="#ens-manager-set-default-resolver">Setting the default public resolver for auction.ethereumbook.eth</a>; we don&#8217;t need to code or deploy a custom resolver.</p>
</div>
<div id="ens-manager-set-default-resolver" class="imageblock data-line-679">
<div class="content">
<img src="images/ens-manager-set-default-resolver.png" alt="Set the default public resolver for auction.ethereumbook.eth">
</div>
<div class="title">Figure 52. Setting the default public resolver for auction.ethereumbook.eth</div>
</div>
</div>
<div class="sect3 data-line-681">
<h4 id="_resolving_a_name_to_a_swarm_hash_content">Resolving a Name to a Swarm Hash (Content)</h4>
<div class="paragraph data-line-683">
<p>Once the resolver for auction.ethereumbook.eth is set to be the public resolver, we can set it to return the Swarm hash as the content of our name (see <a href="#ens-set-content">Setting the 'content' to return for auction.ethereumbook.eth</a>).</p>
</div>
<div id="ens-set-content" class="imageblock data-line-687">
<div class="content">
<img src="images/ens-manager-set-content.png" alt="Set the 'content' return for auction.ethereumbook.eth">
</div>
<div class="title">Figure 53. Setting the 'content' to return for auction.ethereumbook.eth</div>
</div>
<div class="paragraph data-line-689">
<p>After waiting a short time for our transaction to be confirmed, we should be able to resolve the name correctly. Before setting a name, our Auction DApp could be found on a Swarm gateway by its hash:</p>
</div>
<ul class="simplelist">
<li><em>https://swarm-gateways.net/bzz:/ab164cf37dc10647e43a233486cdeffa8334b026e32a480dd9cbd020c12d4581</em></li>
</ul>
<div class="paragraph data-line-697">
<p>or by searching in a DApp browser or Swarm gateway for the Swarm URL:</p>
</div>
<ul class="simplelist">
<li><em>bzz://ab164cf37dc10647e43a233486cdeffa8334b026e32a480dd9cbd020c12d4581</em></li>
</ul>
<div class="paragraph pagebreak-before data-line-706">
<p>Now that we have attached it to a name, it is much easier:</p>
</div>
<ul class="simplelist">
<li><em>http://swarm-gateways.net/bzz:/auction.ethereumbook.eth/</em></li>
</ul>
<div class="paragraph data-line-714">
<p>We can also find it by searching for "auction.ethereumbook.eth" in any ENS-compatible wallet or DApp browser (e.g., Mist).</p>
</div>
</div>
</div>
<div class="sect2 data-line-716">
<h3 id="_from_app_to_dapp">From App to DApp</h3>
<div class="paragraph data-line-718">
<p>Over the past several sections, we have gradually built a decentralized application. We started with a pair of smart contracts to run an auction for ERC721 deeds. These contracts were designed to have no governing or privileged accounts, so that their operation is truly decentralized. We  added a frontend, implemented in JavaScript, that offers a convenient and user-friendly interface to our DApp. The auction DApp uses the decentralized storage system Swarm to store application resources such as images. The DApp also uses the decentralized communications protocol Whisper to offer an encrypted chat room for each auction, without any central servers.</p>
</div>
<div class="paragraph data-line-720">
<p>We uploaded the entire frontend to Swarm, so that our DApp doesn&#8217;t rely on any web servers to serve the files. Finally, we allocated a name for our DApp using ENS, connecting it to the Swarm hash of the frontend, so that users can access it with a simple and easy-to-remember human-readable name.</p>
</div>
<div class="paragraph data-line-722">
<p>With each of these steps, we increased the decentralization of our application. The final result is a DApp that has no central point of authority, no central point of failure, and expresses the "web3" vision.</p>
</div>
<div class="paragraph data-line-724">
<p><a href="#auction_dapp_final_architecture">Auction DApp architecture</a> shows the complete architecture of the Auction DApp.</p>
</div>
<div id="auction_dapp_final_architecture" class="imageblock data-line-728">
<div class="content">
<img src="images/auction_dapp_final_architecture.png" alt="Auction DApp architecture">
</div>
<div class="title">Figure 54. Auction DApp architecture</div>
</div>
</div>
<div class="sect2 data-line-730">
<h3 id="_conclusions_9">Conclusions</h3>
<div class="paragraph data-line-27">
<p>Decentralized applications are the culmination of the Ethereum vision, as expressed by the founders from the very earliest designs. While a lot of applications call themselves "DApps" today, most are not fully decentralized. However, it is already possible to construct applications that are almost completely decentralized. Over time, as the technology matures further, more and more of our applications can be decentralized, resulting in a more resilient, censorship-resistant, and free web.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="evm_chapter">La machine virtuelle Ethereum</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>At the heart of the Ethereum protocol and operation is the Ethereum Virtual Machine, or EVM for short. As you might guess from the name, it is a computation engine, not hugely dissimilar to the virtual machines of Microsoft&#8217;s .NET Framework, or interpreters of other bytecode-compiled programming languages such as Java. In this chapter we take a detailed look at the EVM, including its instruction set, structure, and operation, within the context of Ethereum state updates.</p>
</div>
<div class="sect2 data-line-7">
<h3 id="evm_description">What Is the EVM?</h3>
<div class="paragraph data-line-8">
<p>The EVM is the part of Ethereum that handles smart contract deployment and execution. Simple value transfer transactions from one EOA to another don&#8217;t need to involve it, practically speaking, but everything else will involve a state update computed by the EVM. At a high level, the EVM running on the Ethereum blockchain can be thought of as a global decentralized computer containing millions of executable objects, each with its own permanent data store.</p>
</div>
<div class="paragraph data-line-10">
<p>The EVM is a quasi–Turing-complete state machine; "quasi" because all execution processes are limited to a finite number of computational steps by the amount of gas available for any given smart contract execution. As such, the halting problem is "solved" (all program executions will halt) and the situation where execution might (accidentally or maliciously) run forever, thus bringing the Ethereum platform to halt in its entirety, is avoided.</p>
</div>
<div class="paragraph data-line-12">
<p>The EVM has a stack-based architecture, storing all in-memory values on a stack. It works with a word size of 256 bits (mainly to facilitate native hashing and elliptic curve operations) and has several addressable data components:</p>
</div>
<div class="ulist pagebreak-before data-line-15">
<ul>
<li class="data-line-15">
<p>An immutable <em>program code ROM</em>, loaded with the bytecode of the smart contract to be executed</p>
</li>
<li class="data-line-16">
<p>A volatile <em>memory</em>, with every location explicitly initialized to zero</p>
</li>
<li class="data-line-17">
<p>A permanent <em>storage</em> that is part of the Ethereum state, also zero-initialized</p>
</li>
</ul>
</div>
<div class="paragraph data-line-19">
<p>There is also a set of environment variables and data that is available during execution. We will go through these in more detail later in this chapter.</p>
</div>
<div class="paragraph data-line-21">
<p><a href="#evm_architecture">The Ethereum Virtual Machine (EVM) Architecture and Execution Context</a> shows the EVM architecture and execution context.</p>
</div>
<div id="evm_architecture" class="imageblock data-line-25">
<div class="content">
<img src="images/evm-architecture.png" alt="The Ethereum Virtual Machine (EVM) Architecture and Execution Context">
</div>
<div class="title">Figure 55. The Ethereum Virtual Machine (EVM) Architecture and Execution Context</div>
</div>
<div class="sect3 data-line-28">
<h4 id="evm_comparison">Comparison with Existing Technology</h4>
<div class="paragraph data-line-30">
<p>The term "virtual machine" is often applied to the virtualization of a real computer, typically by a "hypervisor" such as VirtualBox or QEMU, or of an entire operating system instance, such as Linux&#8217;s KVM. These must provide a software abstraction, respectively, of actual hardware, and of system calls and other kernel functionality.</p>
</div>
<div class="paragraph data-line-32">
<p>The EVM operates in a much more limited domain: it is just a computation engine, and as such provides an abstraction of just computation and storage, similar to the Java Virtual Machine (JVM) specification, for example. From a high-level viewpoint, the JVM is designed to provide a runtime environment that is agnostic of the underlying host OS or hardware, enabling compatibility across a wide variety of systems. High-level programming languages such as Java or Scala (which use the JVM) or C# (which uses .NET) are compiled into the bytecode instruction set of their respective virtual machine. In the same way, the EVM executes its own bytecode instruction set (described in the next section), which higher-level smart contract programming languages such as LLL, Serpent, Mutan, or Solidity are compiled into.</p>
</div>
<div class="paragraph data-line-34">
<p>The EVM, therefore, has no scheduling capability, because execution ordering is organized externally to it&#x2014;Ethereum clients run through verified block transactions to determine which smart contracts need executing and in which order. In this sense, the Ethereum world computer is single-threaded, like JavaScript. Neither does the EVM have any "system interface" handling or &#x201c;hardware support&#x201d;&#x2014;there is no physical machine to interface with. The Ethereum world computer is completely virtual.</p>
</div>
</div>
<div class="sect3 data-line-37">
<h4 id="evm_bytecode_overview">The EVM Instruction Set (Bytecode Operations)</h4>
<div class="paragraph data-line-39">
<p>The EVM instruction set offers most of the operations you might expect, including:</p>
</div>
<div class="ulist data-line-41">
<ul>
<li class="data-line-41">
<p>Arithmetic and bitwise logic operations</p>
</li>
<li class="data-line-42">
<p>Execution context inquiries</p>
</li>
<li class="data-line-43">
<p>Stack, memory, and storage access</p>
</li>
<li class="data-line-44">
<p>Control flow operations</p>
</li>
<li class="data-line-45">
<p>Logging, calling, and other operators</p>
</li>
</ul>
</div>
<div class="paragraph data-line-47">
<p>In addition to the typical bytecode operations, the EVM also has access to account information (e.g., address and balance) and block information (e.g., block number and current gas price).</p>
</div>
<div class="paragraph data-line-49">
<p>Let&#8217;s start our exploration of the EVM in more detail by looking at the available opcodes and what they do. As you might expect, all operands are taken from the stack, and the result (where applicable) is often
put back on the top of the stack.</p>
</div>
<div class="admonitionblock note data-line-53">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-54">
<p>A complete list of opcodes and their corresponding gas cost can be found in <a href="#evm_opcodes">Opcodes Ethereum EVM et consommation de gaz</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-57">
<p>The available opcodes can be divided into the following categories:</p>
</div>
<div id="arithmetic_opcodes" class="dlist data-line-60">
<dl>
<dt class="hdlist1">Arithmetic operations</dt>
<dd>
<p>Arithmetic opcode instructions:</p>
<div class="listingblock data-line-62">
<div class="content">
<pre>ADD        //Add the top two stack items
MUL        //Multiply the top two stack items
SUB        //Subtract the top two stack items
DIV        //Integer division
SDIV       //Signed integer division
MOD        //Modulo (remainder) operation
SMOD       //Signed modulo operation
ADDMOD     //Addition modulo any number
MULMOD     //Multiplication modulo any number
EXP        //Exponential operation
SIGNEXTEND //Extend the length of a two's complement signed integer
SHA3       //Compute the Keccak-256 hash of a block of memory</pre>
</div>
</div>
<div class="paragraph data-line-77">
<p>Note that all arithmetic is performed modulo 2<sup>256</sup> (unless otherwise noted), and that the zeroth power of zero, 0<sup>0</sup>, is taken to be 1.</p>
</div>
</dd>
</dl>
</div>
<div id="stack_opcodes" class="dlist data-line-81">
<dl>
<dt class="hdlist1">Stack operations</dt>
<dd>
<p>Stack, memory, and storage management instructions:</p>
<div class="listingblock data-line-83">
<div class="content">
<pre>POP     //Remove the top item from the stack
MLOAD   //Load a word from memory
MSTORE  //Save a word to memory
MSTORE8 //Save a byte to memory
SLOAD   //Load a word from storage
SSTORE  //Save a word to storage
MSIZE   //Get the size of the active memory in bytes
PUSHx   //Place x byte item on the stack, where x can be any integer from
        // 1 to 32 (full word) inclusive
DUPx    //Duplicate the x-th stack item, where x can be any integer from
        // 1 to 16 inclusive
SWAPx   //Exchange 1st and (x+1)-th stack items, where x can be any
        // integer from 1 to 16 inclusive</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="flow_opcodes" class="dlist data-line-101">
<dl>
<dt class="hdlist1">Process flow operations</dt>
<dd>
<p>Instructions for control flow:</p>
<div class="listingblock data-line-103">
<div class="content">
<pre>STOP      //Halt execution
JUMP      //Set the program counter to any value
JUMPI     //Conditionally alter the program counter
PC        //Get the value of the program counter (prior to the increment
          //corresponding to this instruction)
JUMPDEST  //Mark a valid destination for jumps</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="system_opcodes" class="dlist data-line-113">
<dl>
<dt class="hdlist1">System operations</dt>
<dd>
<p>Opcodes for the system executing the program:</p>
<div class="listingblock data-line-115">
<div class="content">
<pre>LOGx          //Append a log record with x topics, where x is any integer
              //from 0 to 4 inclusive
CREATE        //Create a new account with associated code
CALL          //Message-call into another account, i.e. run another
              //account's code
CALLCODE      //Message-call into this account with another
              //account's code
RETURN        //Halt execution and return output data
DELEGATECALL  //Message-call into this account with an alternative
              //account's code, but persisting the current values for
              //sender and value
STATICCALL    //Static message-call into an account
REVERT        //Halt execution, reverting state changes but returning
              //data and remaining gas
INVALID       //The designated invalid instruction
SELFDESTRUCT  //Halt execution and register account for deletion</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="logic_opcides" class="dlist data-line-135">
<dl>
<dt class="hdlist1">Logic operations</dt>
<dd>
<p>Opcodes for comparisons and bitwise logic:</p>
<div class="listingblock data-line-137">
<div class="content">
<pre>LT     //Less-than comparison
GT     //Greater-than comparison
SLT    //Signed less-than comparison
SGT    //Signed greater-than comparison
EQ     //Equality comparison
ISZERO //Simple NOT operator
AND    //Bitwise AND operation
OR     //Bitwise OR operation
XOR    //Bitwise XOR operation
NOT    //Bitwise NOT operation
BYTE   //Retrieve a single byte from a full-width 256-bit word</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="environment_opcodes" class="dlist data-line-152">
<dl>
<dt class="hdlist1">Environmental operations</dt>
<dd>
<p>Opcodes dealing with execution environment information:</p>
<div class="listingblock data-line-154">
<div class="content">
<pre>GAS            //Get the amount of available gas (after the reduction for
               //this instruction)
ADDRESS        //Get the address of the currently executing account
BALANCE        //Get the account balance of any given account
ORIGIN         //Get the address of the EOA that initiated this EVM
               //execution
CALLER         //Get the address of the caller immediately responsible
               //for this execution
CALLVALUE      //Get the ether amount deposited by the caller responsible
               //for this execution
CALLDATALOAD   //Get the input data sent by the caller responsible for
               //this execution
CALLDATASIZE   //Get the size of the input data
CALLDATACOPY   //Copy the input data to memory
CODESIZE       //Get the size of code running in the current environment
CODECOPY       //Copy the code running in the current environment to
               //memory
GASPRICE       //Get the gas price specified by the originating
               //transaction
EXTCODESIZE    //Get the size of any account's code
EXTCODECOPY    //Copy any account's code to memory
RETURNDATASIZE //Get the size of the output data from the previous call
               //in the current environment
RETURNDATACOPY //Copy data output from the previous call to memory</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="block_opcodes" class="dlist data-line-182">
<dl>
<dt class="hdlist1">Block operations</dt>
<dd>
<p>Opcodes for accessing information on the current block:</p>
<div class="listingblock data-line-184">
<div class="content">
<pre>BLOCKHASH  //Get the hash of one of the 256 most recently completed
           //blocks
COINBASE   //Get the block's beneficiary address for the block reward
TIMESTAMP  //Get the block's timestamp
NUMBER     //Get the block's number
DIFFICULTY //Get the block's difficulty
GASLIMIT   //Get the block's gas limit</pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-195">
<h4 id="evm_state_descriptions">Ethereum State</h4>
<div class="paragraph data-line-197">
<p>The job of the EVM is to update the Ethereum state by computing valid state transitions as a result of smart contract code execution, as defined by the Ethereum protocol. This aspect leads to the description of Ethereum as a <em>transaction-based state machine</em>, which reflects the fact that external actors (i.e., account holders and miners) initiate state transitions by creating, accepting, and ordering transactions. It is useful at this point to consider what constitutes the Ethereum state.</p>
</div>
<div class="paragraph data-line-199">
<p>At the top level, we have the Ethereum <em>world state</em>. The world state is a mapping of Ethereum addresses (160-bit values) to <em>accounts</em>. At the lower level, each Ethereum address represents an account comprising an ether <em>balance</em> (stored as the number of wei owned by the account), a <em>nonce</em> (representing the number of transactions successfully sent from this account if it is an EOA, or the number of contracts created by it if it is a contract account), the account&#8217;s <em>storage</em> (which is a permanent data store, only used by smart contracts), and the account&#8217;s <em>program code</em> (again, only if the account is a smart contract account). An EOA will always have no code and an empty storage.</p>
</div>
<div class="paragraph data-line-205">
<p>When a transaction results in smart contract code execution, an EVM is instantiated with all the information required in relation to the current block being created and the specific transaction being processed. In particular, the EVM&#8217;s program code ROM is loaded with the code of the contract account being called, the program counter is set to zero, the storage is loaded from the contract account&#8217;s storage, the memory is set to all zeros, and all the block and environment variables are set. A key variable is the gas supply for this execution, which is set to the amount of gas paid for by the sender at the start of the transaction (see <a href="#gas">Gas</a> for more details). As code execution progresses, the gas supply is reduced according to the gas cost of the operations executed. If at any point the gas supply is reduced to zero we get an "Out of Gas" (OOG) exception; execution immediately halts and the transaction is abandoned. No changes to the Ethereum state are applied, except for the sender&#8217;s nonce being incremented and their ether balance going down to pay the block&#8217;s beneficiary for the resources used to execute the code to the halting point. At this point, you can think of the EVM running on a sandboxed copy of the Ethereum world state, with this sandboxed version being discarded completely if execution cannot complete for whatever reason. However, if execution does complete successfully, then the real-world state is updated to match the sandboxed version, including any changes to the called contract&#8217;s storage data, any new contracts created, and any ether balance transfers that were initiated.</p>
</div>
<div class="paragraph data-line-207">
<p>Note that because a smart contract can itself effectively initiate transactions, code execution is a recursive process. A contract can call other contracts, with each call resulting in another EVM being instantiated around the new target of the call. Each instantiation has its sandbox world state initialized from the sandbox of the EVM at the level above. Each instantiation is also given a specified amount of gas for its gas supply (not exceeding the amount of gas remaining in the level above, of course), and so may itself halt with an exception due to being given too little gas to complete its execution. Again, in such cases, the sandbox state is discarded, and execution returns to the EVM at the level above.</p>
</div>
</div>
<div class="sect3 data-line-210">
<h4 id="compiling_solidity_to_evm">Compiling Solidity to EVM Bytecode</h4>
<div id="solc_help" class="paragraph data-line-213">
<p>Compiling a Solidity source file to EVM bytecode can be accomplished via several methods. In <a href="#intro_chapter">Les bases d&#39;Ethereum</a> we used the online Remix compiler. In this chapter, we will use the solc executable at the command line. For a list of options, run the following <span class="keep-together">command</span>:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc --help</strong>
</pre>
<div id="solc_opcodes_option" class="paragraph data-line-222">
<p>Generating the raw opcode stream of a Solidity source file is easily achieved with the --opcodes command-line option. This opcode stream leaves out some information (the --asm option produces the full information), but it is sufficient for this discussion. For example, compiling an example Solidity file, <em>Example.sol</em>, and sending the opcode output into a directory named <em>BytecodeDir</em> is accomplished with the following command:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc -o BytecodeDir --opcodes Example.sol</strong>
</pre>
<div class="paragraph data-line-230">
<p>or:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc -o BytecodeDir --asm Example.sol</strong>
</pre>
<div id="solc_bin_option" class="paragraph data-line-239">
<p>The following command will produce the bytecode binary for our example program:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc -o BytecodeDir --bin Example.sol</strong>
</pre>
<div class="paragraph data-line-247">
<p>The output opcode files generated will depend on the specific contracts contained within the Solidity source file. Our simple Solidity file <em>Example.sol</em> has only one contract, named example:</p>
</div>
<div id="simple_solidity_example" class="listingblock data-line-251">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.19;

contract example {

  address contractOwner;

  function example() {
    contractOwner = msg.sender;
  }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-264">
<p>As you can see, all this contract does is hold one persistent state variable, which is set as the address of the last account to run this contract.</p>
</div>
<div class="paragraph data-line-266">
<p>If you look in the <em>BytecodeDir</em> directory you will see the opcode file <em>example.opcode</em>, which contains the EVM opcode instructions of the example contract. Opening the <em>example.opcode</em> file in a text editor will show the following:</p>
</div>
<div id="opcode_output" class="listingblock data-line-269">
<div class="content">
<pre>PUSH1 0x60 PUSH1 0x40 MSTORE CALLVALUE ISZERO PUSH1 0xE JUMPI PUSH1 0x0 DUP1
REVERT JUMPDEST CALLER PUSH1 0x0 DUP1 PUSH2 0x100 EXP DUP2 SLOAD DUP2 PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF MUL NOT AND SWAP1 DUP4 PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND MUL OR SWAP1 SSTORE POP PUSH1
0x35 DUP1 PUSH1 0x5B PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x60 PUSH1
0x40 MSTORE PUSH1 0x0 DUP1 REVERT STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 JUMP
0xb9 SWAP14 0xcb 0x1e 0xdd RETURNDATACOPY 0xec 0xe0 0x1f 0x27 0xc9 PUSH5
0x9C5ABCC14A NUMBER 0x5e INVALID EXTCODESIZE 0xdb 0xcf EXTCODESIZE 0x27
EXTCODESIZE 0xe2 0xb8 SWAP10 0xed 0x</pre>
</div>
</div>
<div class="paragraph data-line-281">
<p>Compiling the example with the --asm option produces a file named <em>example.evm</em> in our <em>BytecodeDir</em> directory. This contains a slightly higher-level description of the EVM bytecode instructions, together with some helpful annotations:</p>
</div>
<div id="asm_output" class="listingblock data-line-285">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">/* "Example.sol":26:132  contract example {... */
  mstore(0x40, 0x60)
    /* "Example.sol":74:130  function example() {... */
  jumpi(tag_1, iszero(callvalue))
  0x0
  dup1
  revert
tag_1:
    /* "Example.sol":115:125  msg.sender */
  caller
    /* "Example.sol":99:112  contractOwner */
  0x0
  dup1
    /* "Example.sol":99:125  contractOwner = msg.sender */
  0x100
  exp
  dup2
  sload
  dup2
  0xffffffffffffffffffffffffffffffffffffffff
  mul
  not
  and
  swap1
  dup4
  0xffffffffffffffffffffffffffffffffffffffff
  and
  mul
  or
  swap1
  sstore
  pop
    /* "Example.sol":26:132  contract example {... */
  dataSize(sub_0)
  dup1
  dataOffset(sub_0)
  0x0
  codecopy
  0x0
  return
stop

sub_0: assembly {
        /* "Example.sol":26:132  contract example {... */
      mstore(0x40, 0x60)
      0x0
      dup1
      revert

    auxdata: 0xa165627a7a7230582056b99dcb1edd3eece01f27c9649c5abcc14a435efe3b...
}</code></pre>
</div>
</div>
<div class="paragraph data-line-339">
<p>The --bin-runtime option produces the machine-readable hexadecimal bytecode:</p>
</div>
<div id="bin_output" class="listingblock data-line-342">
<div class="content">
<pre>60606040523415600e57600080fd5b336000806101000a81548173
ffffffffffffffffffffffffffffffffffffffff
021916908373
ffffffffffffffffffffffffffffffffffffffff
160217905550603580605b6000396000f3006060604052600080fd00a165627a7a7230582056b...</pre>
</div>
</div>
<div class="paragraph data-line-350">
<p>You can investigate what&#8217;s going on here in detail using the opcode list given in <a href="#evm_bytecode_overview">The EVM Instruction Set (Bytecode Operations)</a>. However, that&#8217;s quite a task, so let&#8217;s just start by examining the first four instructions:</p>
</div>
<div id="opcode_analysis_1" class="listingblock data-line-353">
<div class="content">
<pre>PUSH1 0x60 PUSH1 0x40 MSTORE CALLVALUE</pre>
</div>
</div>
<div class="paragraph data-line-357">
<p>Here we have PUSH1 followed by a raw byte of value 0x60. This EVM instruction takes the single byte following the opcode in the program code (as a literal value) and pushes it onto the stack. It is possible to push values of size up to 32 bytes onto the stack, as in:</p>
</div>
<div class="listingblock data-line-359">
<div class="content">
<pre>PUSH32 0x436f6e67726174756c6174696f6e732120536f6f6e20746f206d617374657221</pre>
</div>
</div>
<div class="paragraph data-line-363">
<p>The second PUSH1 opcode from <em>example.opcode</em> stores 0x40 onto the top of the stack (pushing the 0x60 already present there down one slot).</p>
</div>
<div class="paragraph data-line-365">
<p>Next is MSTORE, which is a memory store operation that saves a value to the EVM&#8217;s memory. It takes two arguments and, like most EVM operations, obtains them from the stack. For each argument the stack is &#x201c;popped&#x201d;; i.e., the top value on the stack is taken off and all the other values on the stack are shifted up one position. The first argument for MSTORE is the address of the word in memory where the value to be saved will be put. For this program we have 0x40 at the top of the stack, so that is removed from the stack and used as the memory address. The second argument is the value to be saved, which is 0x60 here. After the MSTORE operation is executed our stack is empty again, but we have the value 0x60 (96 in decimal) at the memory location 0x40.</p>
</div>
<div class="paragraph data-line-367">
<p>The next opcode is CALLVALUE, which is an environmental opcode that pushes onto the top of the stack the amount of ether (measured in wei) sent with the message call that initiated this execution.</p>
</div>
<div class="paragraph data-line-369">
<p>We could continue to step through this program in this way until we had a full understanding of the low-level state changes that this code effects, but it wouldn&#8217;t help us at this stage. We&#8217;ll come back to it later in the chapter.</p>
</div>
</div>
<div class="sect3 data-line-372">
<h4 id="contract_deployment_code">Contract Deployment Code</h4>
<div class="paragraph data-line-374">
<p>There is an important but subtle difference between the code used when creating and deploying a new contract on the Ethereum platform and the code of the contract itself. In order to create a new contract, a special transaction is needed that has its to field set to the special 0x0 address and its data field set to the contract&#8217;s <em>initiation code</em>. When such a contract creation transaction is processed, the code for the new contract account is <em>not</em> the code in the data field of the transaction. Instead, an EVM is instantiated with the code in the data field of the transaction loaded into its program code ROM, and then the output of the execution of that deployment code is taken as the code for the new contract account. This is so that new contracts can be programmatically initialized using the Ethereum world state at the time of deployment, setting values in the contract&#8217;s storage and even sending ether or creating further new contracts.</p>
</div>
<div class="paragraph data-line-376">
<p>When compiling a contract offline, e.g., using solc on the command line, you can either get the <em>deployment bytecode</em> or the <em>runtime bytecode</em>.</p>
</div>
<div class="paragraph data-line-378">
<p>The deployment bytecode is used for every aspect of the initialization of a new contract account, including the bytecode that will actually end up being executed when transactions call this new contract (i.e., the runtime bytecode) and the code to initialize everything based on the contract&#8217;s constructor.</p>
</div>
<div class="paragraph data-line-380">
<p>The runtime bytecode, on the other hand, is exactly the bytecode that ends up being executed when the new contract is called, and nothing more; it does not include the bytecode needed to initialize the contract during deployment.</p>
</div>
<div class="paragraph data-line-382">
<p>Let&#8217;s take the simple <em>Faucet.sol</em> contract we created earlier as an example:</p>
</div>
<div id="faucet_example" class="listingblock data-line-386">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Version of Solidity compiler this program was written for
pragma solidity ^0.4.19;

// Our first contract is a faucet!
contract Faucet {

  // Give out ether to anyone who asks
  function withdraw(uint withdraw_amount) public {

      // Limit withdrawal amount
      require(withdraw_amount &lt;= 100000000000000000);

      // Send the amount to the address that requested it
      msg.sender.transfer(withdraw_amount);
    }

  // Accept any incoming amount
  function () external payable {}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-409">
<p>To get the deployment bytecode, we would run <code>solc --bin Faucet.sol</code>. If we instead wanted just the runtime bytecode, we would run <code>solc --bin-runtime <span class="keep-together">Faucet.sol</span></code>.</p>
</div>
<div class="paragraph data-line-411">
<p>If you compare the output of these commands, you will see that the runtime bytecode is a subset of the deployment bytecode. In other words, the runtime bytecode is entirely contained within the deployment bytecode.</p>
</div>
</div>
<div class="sect3 data-line-414">
<h4 id="disassembling_the_bytecode">Disassembling the Bytecode</h4>
<div class="paragraph data-line-416">
<p>Disassembling EVM bytecode is a great way to understand how high-level Solidity acts in the EVM. There are a few disassemblers you can use to do this:</p>
</div>
<div class="ulist data-line-418">
<ul>
<li class="data-line-418">
<p><a href="https://github.com/comaeio/porosity" data-href="https://github.com/comaeio/porosity"><em>Porosity</em></a> is a popular open source decompiler.</p>
</li>
<li class="data-line-419">
<p><a href="https://github.com/trailofbits/ethersplay" data-href="https://github.com/trailofbits/ethersplay"><em>Ethersplay</em></a> is an EVM plug-in for Binary Ninja, a disassembler.</p>
</li>
<li class="data-line-420">
<p><a href="https://github.com/trailofbits/ida-evm" data-href="https://github.com/trailofbits/ida-evm"><em>IDA-Evm</em></a> is an EVM plugin for IDA, another disassembler.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-422">
<p>In this section, we will be using the Ethersplay plug-in for Binary Ninja and to start <a href="#Faucet_disassembled">Disassembling the Faucet runtime bytecode</a>. After getting the runtime bytecode of <em>Faucet.sol</em>, we can feed it into Binary Ninja (after loading the Ethersplay plug-in) to see what the EVM instructions look like.</p>
</div>
<div id="Faucet_disassembled" class="imageblock data-line-426">
<div class="content">
<img src="images/Faucet_disassembled.png" alt="Faucet.sol runtime bytecode disassembled">
</div>
<div class="title">Figure 56. Disassembling the Faucet runtime bytecode</div>
</div>
<div class="paragraph data-line-428">
<p>When you send a transaction to an ABI-compatible smart contract (which you can assume all contracts are), the transaction first interacts with that smart contract&#8217;s <em>dispatcher</em>. The dispatcher reads in the data field of the transaction and sends the relevant part to the appropriate function. We can see an example of a dispatcher at the beginning of our disassembled <em>Faucet.sol</em> runtime bytecode. After the familiar MSTORE instruction, we see the following instructions:</p>
</div>
<div id="faucet_instructions" class="listingblock data-line-431">
<div class="content">
<pre>PUSH1 0x4
CALLDATASIZE
LT
PUSH1 0x3f
JUMPI</pre>
</div>
</div>
<div class="paragraph data-line-439">
<p>As we have seen, PUSH1 0x4 places 0x4 onto the top of the stack, which is otherwise empty. CALLDATASIZE gets the size in bytes of the data sent with the transaction (known as the <em>calldata</em>) and pushes that number onto the stack. After these operations have been executed, the stack looks like this:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-442" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;length of calldata from tx&gt;</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x4</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-448">
<p>This next instruction is LT, short for “less than.” The LT instruction checks whether the top item on the stack is less than the next item on the stack. In our case, it checks to see if the result of CALLDATASIZE is less than 4 bytes.</p>
</div>
<div class="paragraph data-line-450">
<p>Why does the EVM check to see that the calldata of the transaction is at least 4 bytes? Because of how function identifiers work. Each function is identified by the first 4 bytes of its Keccak-256 hash. By placing the function&#8217;s name and what arguments it takes into a keccak256 hash function, we can deduce its function identifier. In our case, we have:</p>
</div>
<div id="faucet_function_identifier" class="listingblock data-line-453">
<div class="content">
<pre class="highlight"><code>keccak256("withdraw(uint256)") = 0x2e1a7d4d...</code></pre>
</div>
</div>
<div class="paragraph data-line-457">
<p>Thus, the function identifier for the withdraw(uint256) function is 0x2e1a7d4d, since these are the first 4 bytes of the resulting hash. A function identifier is always 4 bytes long, so if the entire data field of the transaction sent to the contract is less than 4 bytes, then there’s no function with which the transaction could possibly be communicating, unless a <em>fallback function</em> is defined. Because we implemented such a fallback function in <em>Faucet.sol</em>, the EVM jumps to this function when the calldata&#8217;s length is less than 4 bytes.</p>
</div>
<div class="paragraph data-line-459">
<p>LT pops the top two values off the stack and, if the transaction&#8217;s data field is less than 4 bytes, pushes 1 onto it. Otherwise, it pushes 0. In our example, let&#8217;s assume the data field of the transaction sent to our contract <em>was</em> less than 4 bytes.</p>
</div>
<div class="paragraph data-line-461">
<p>The PUSH1 0x3f instruction pushes the byte 0x3f onto the stack. After this instruction, the stack looks like this:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-464" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x3f</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-470">
<p>The next instruction is JUMPI, which stands for "jump if." It works like so:</p>
</div>
<div id="faucet_jump_instruction_text" class="listingblock data-line-473">
<div class="content">
<pre>jumpi(label, cond) // Jump to "label" if "cond" is true</pre>
</div>
</div>
<div class="paragraph data-line-477">
<p>In our case, label is 0x3f, which is where our fallback function lives in our smart contract. The cond argument is 1, which was the result of the LT instruction earlier. To put this entire sequence into words, the contract jumps to the fallback function if the transaction data is less than 4 bytes.</p>
</div>
<div class="paragraph data-line-479">
<p>At 0x3f, only a STOP instruction follows, because although we declared a fallback function, we kept it empty. As you can see in <a href="#Faucet_jumpi_instruction">JUMPI instruction leading to fallback function</a>, had we not implemented a fallback function, the contract would throw an exception instead.</p>
</div>
<div id="Faucet_jumpi_instruction" class="imageblock data-line-483">
<div class="content">
<img src="images/Faucet_jumpi_instruction.png" alt="JUMPI instruction leading to fallback function">
</div>
<div class="title">Figure 57. JUMPI instruction leading to fallback function</div>
</div>
<div class="paragraph data-line-485">
<p>Let&#8217;s examine the central block of the dispatcher. Assuming we received calldata that was <em>greater</em> than 4 bytes in length, the JUMPI instruction would not jump to the fallback function. Instead, code execution would proceed to the following instructions:</p>
</div>
<div id="faucet_instructions2" class="listingblock data-line-488">
<div class="content">
<pre>PUSH1 0x0
CALLDATALOAD
PUSH29 0x1000000...
SWAP1
DIV
PUSH4 0xffffffff
AND
DUP1
PUSH4 0x2e1a7d4d
EQ
PUSH1 0x41
JUMPI</pre>
</div>
</div>
<div class="paragraph data-line-503">
<p>PUSH1 0x0 pushes 0 onto the stack, which is now otherwise empty again. CALLDATALOAD accepts as an argument an index within the calldata sent to the smart contract and reads 32 bytes from that index, like so:</p>
</div>
<div id="faucet_calldataload_instruction_text" class="listingblock data-line-506">
<div class="content">
<pre>calldataload(p) //load 32 bytes of calldata starting from byte position p</pre>
</div>
</div>
<div class="paragraph data-line-510">
<p>Since 0 was the index passed to it from the PUSH1 0x0 command, CALLDATALOAD reads 32 bytes of calldata starting at byte 0, and then pushes it to the top of the stack (after popping the original 0x0). After the PUSH29 0x1000000&#8230;&#8203; instruction, the stack is then:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-513" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x1000000&#8230;&#8203; (29 bytes in length)</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;32 bytes of calldata starting at byte 0&gt;</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-519">
<p>SWAP1 switches the top element on the stack with the <em>i</em>-th element after it. In this case, it swaps 0x1000000&#8230;&#8203; with the calldata. The new stack is:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-522" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;32 bytes of calldata starting at byte 0&gt;</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x1000000&#8230;&#8203; (29 bytes in length)</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-528">
<p>The next instruction is DIV, which works as follows:</p>
</div>
<div id="faucet_div_instruction_text" class="listingblock data-line-531">
<div class="content">
<pre>div(x, y) // integer division x / y</pre>
</div>
</div>
<div class="paragraph data-line-535">
<p>In this case, x = 32 bytes of calldata starting at byte 0, and y = 0x100000000&#8230;&#8203; (29 bytes total). Can you think of why the dispatcher is doing the division? Here&#8217;s a hint: we read 32 bytes from calldata earlier, starting at index 0. The first 4 bytes of that calldata is the function identifier.</p>
</div>
<div class="paragraph data-line-538">
<p>The 0x100000000&#8230;&#8203; we pushed earlier is 29 bytes long, consisting of a 1 at the beginning, followed by all 0s. Dividing our 32 bytes of calldata by this value will leave us only the <em>topmost 4 bytes</em> of our calldata load, starting at index 0. These 4 bytes—the first 4 bytes in the calldata starting at index 0—are the function identifier, and this is how the EVM extracts that field.</p>
</div>
<div class="paragraph data-line-540">
<p>If this part isn’t clear to you, think of it like this: in base 10, 1234000 / 1000 = 1234. In base 16, this is no different. Instead of every place being a multiple of 10, it is a multiple of 16. Just as dividing by 10<sup>3</sup> (1000) in our smaller example kept only the topmost digits, dividing our 32-byte base 16 value by 16<sup>29</sup> does the same.</p>
</div>
<div class="paragraph data-line-542">
<p>The result of the DIV (the function identifier) gets pushed onto the stack, and our stack is now:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-545" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;function identifier sent in data&gt;</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-550">
<p>Since the PUSH4 0xffffffff and AND instructions are redundant, we can ignore them entirely, as the stack will remain the same after they are done. The DUP1 instruction duplicates the first item on the stack, which is the function identifier. The next instruction, PUSH4 0x2e1a7d4d, pushes the precalculated function identifier of the <code><span class="keep-together">withdraw</span>(uint256)</code> function onto the stack. The stack is now:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-553" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x2e1a7d4d</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;function identifier sent in data&gt;</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;function identifier sent in data&gt;</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-560">
<p>The next instruction, EQ, pops off the top two items of the stack and compares them. This is where the dispatcher does its main job: it compares whether the function identifier sent in the msg.data field of the transaction matches that of <code><span class="keep-together">withdraw</span>(uint256)</code>. If they are equal, EQ pushes 1 onto the stack, which will ultimately be used to jump to the withdraw function. Otherwise, EQ pushes 0 onto the stack.</p>
</div>
<div class="paragraph data-line-562">
<p>Assuming the transaction sent to our contract indeed began with the function identifier for withdraw(uint256), our stack has become:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-565" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;function identifier sent in data&gt; (now known to be 0x2e1a7d4d)</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-571">
<p>Next, we have PUSH1 0x41, which is the address at which the withdraw(uint256) function lives in the contract. After this instruction, the stack looks like this:</p>
</div>
<table class="tableblock frame-ends grid-all data-line-574" style="width: 40%;">
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0x41</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
</tbody>
<tfoot>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">function identifier sent in msg.data</p></td>
</tr>
</tfoot>
</table>
<div class="paragraph data-line-581">
<p>The JUMPI instruction is next, and it once again accepts the top two elements on the stack as arguments. In this case, we have jumpi(0x41, 1), which tells the EVM to execute the jump to the location of the withdraw(uint256) function, and the execution of that function&#8217;s code can proceed.</p>
</div>
</div>
</div>
<div class="sect2 data-line-584">
<h3 id="turing_completeness_and_gas">Turing Completeness and Gas</h3>
<div class="paragraph data-line-586">
<p>As we have already touched on, in simple terms, a system or programming language is <em>Turing complete</em> if it can run any program. This capability, however, comes with a very important caveat: some programs take forever to run. An important aspect of this is that we can&#8217;t tell, just by looking at a program, whether it will take forever or not to execute. We have to actually go through with the execution of the program and wait for it to finish to find out. Of course, if it is going to take forever to execute, we will have to wait forever to find out. This is called the <em>halting problem</em> and would be a huge problem for Ethereum if it were not addressed.</p>
</div>
<div class="paragraph data-line-588">
<p>Because of the halting problem, the Ethereum world computer is at risk of being asked to execute a program that never stops. This could be by accident or malice. We have discussed that Ethereum acts like a single-threaded machine, without any scheduler, and so if it became stuck in an infinite loop this would mean it would become unusable.</p>
</div>
<div class="paragraph data-line-590">
<p>However, with gas, there is a solution: if after a prespecified maximum amount of computation has been performed, the execution hasn&#8217;t ended, the execution of the program is halted by the EVM. This makes the EVM a <em>quasi</em>&#x2013;Turing-complete machine: it can run any program you feed into it, but only if the program terminates within a particular amount of computation. That limit isn&#8217;t fixed in Ethereum&#x2014;you can pay to increase it up to a maximum (called the "block gas limit"), and everyone can agree to increase that maximum over time. Nevertheless, at any one time, there is a limit in place, and transactions that consume too much gas while executing are <span class="keep-together">halted</span>.</p>
</div>
<div class="paragraph data-line-592">
<p>In the following sections, we will look at gas and examine how it works in detail.</p>
</div>
</div>
<div class="sect2 data-line-595">
<h3 id="gas">Gas</h3>
<div class="paragraph data-line-597">
<p><em>Gas</em> is Ethereum&#8217;s unit for measuring the computational and storage resources required to perform actions on the Ethereum blockchain. In contrast to Bitcoin, whose transaction fees only take into account the size of a transaction in kilobytes, Ethereum must account for every computational step performed by transactions and smart contract code execution.</p>
</div>
<div class="paragraph data-line-599">
<p>Each operation performed by a transaction or contract costs a fixed amount of gas. Some examples, from the Ethereum Yellow Paper:</p>
</div>
<div class="ulist data-line-601">
<ul>
<li class="data-line-601">
<p>Adding two numbers costs 3 gas</p>
</li>
<li class="data-line-602">
<p>Calculating a Keccak-256 hash costs 30 gas + 6 gas for each 256 bits of data being hashed</p>
</li>
<li class="data-line-603">
<p>Sending a transaction costs 21,000 gas</p>
</li>
</ul>
</div>
<div class="paragraph data-line-605">
<p>Gas is a crucial component of Ethereum, and serves a dual role: as a buffer between the (volatile) price of Ethereum and the reward to miners for the work they do, and as a defense against denial-of-service attacks. To prevent accidental or malicious infinite loops or other computational wastage in the network, the initiator of each transaction is required to set a limit to the amount of computation they are willing to pay for. The gas system thereby disincentivizes attackers from sending "spam" transactions, as they must pay proportionately for the computational, bandwidth, and storage resources that they consume.</p>
</div>
<div class="sect3 data-line-608">
<h4 id="gas_accounting_execution">Gas Accounting During Execution</h4>
<div class="paragraph data-line-609">
<p>When an EVM is needed to complete a transaction, in the first instance it is given a gas supply equal to the amount specified by the gas limit in the transaction. Every opcode that is executed has a cost in gas, and so the EVM&#8217;s gas supply is reduced as the EVM steps through the program. Before each operation, the EVM checks that there is enough gas to pay for the operation&#8217;s execution. If there isn&#8217;t enough gas, execution is halted and the transaction is reverted.</p>
</div>
<div class="paragraph data-line-611">
<p>If the EVM reaches the end of execution successfully, without running out of gas, the  gas cost used is paid to the miner as a transaction fee, converted to ether based on the gas price specified in the transaction:</p>
</div>
<div class="listingblock data-line-613">
<div class="content">
<pre>miner fee = gas cost * gas price</pre>
</div>
</div>
<div class="paragraph data-line-618">
<p>The gas remaining in the gas supply is refunded to the sender, again converted to ether based on the gas price specified in the transaction:</p>
</div>
<div class="listingblock data-line-620">
<div class="content">
<pre>remaining gas = gas limit - gas cost
refunded ether = remaining gas * gas price</pre>
</div>
</div>
<div class="paragraph data-line-625">
<p>If the transaction &#x201c;runs out of gas&#x201d; during execution, the operation is immediately terminated, raising an &#x201c;out of gas&#x201d; exception. The transaction is reverted and all changes to the state are rolled back.</p>
</div>
<div class="paragraph data-line-627">
<p>Although the transaction was unsuccessful, the sender will be charged a transaction fee, as miners have already performed the computational work up to that point and must be compensated for doing so.</p>
</div>
</div>
<div class="sect3 data-line-629">
<h4 id="_gas_accounting_considerations">Gas Accounting Considerations</h4>
<div class="paragraph data-line-631">
<p>The relative gas costs of the various operations that can be performed by the EVM have been carefully chosen to best protect the Ethereum blockchain from attack. You can see a detailed table of gas costs for different EVM opcodes in <a href="#evm_opcodes_table">EVM opcodes and gas cost</a>.</p>
</div>
<div class="paragraph data-line-633">
<p>More computationally intensive operations cost more gas. For example, executing the SHA3 function is 10 times more expensive (30 gas) than the ADD operation (3 gas). More importantly, some operations, such as EXP, require an additional payment based on the size of the operand. There is also a gas cost to using EVM memory and for storing data in a contract&#8217;s on-chain storage.</p>
</div>
<div class="paragraph data-line-635">
<p>The importance of matching gas cost to the real-world cost of resources was demonstrated in 2016 when an attacker found and exploited a mismatch in costs. The attack generated transactions that were very computationally expensive, and made the Ethereum mainnet almost grind to a halt. This mismatch was resolved by a hard fork (codenamed "Tangerine Whistle") that tweaked the relative gas costs.</p>
</div>
</div>
<div class="sect3 data-line-637">
<h4 id="_gas_cost_versus_gas_price">Gas Cost Versus Gas Price</h4>
<div class="paragraph data-line-638">
<p>While the gas <em>cost</em> is a measure of computation and storage used in the EVM, the gas itself also has a <em>price</em> measured in ether. When performing a transaction, the sender specifies the gas price they are willing to pay (in ether) for each unit of gas, allowing the market to decide the relationship between the price of ether and the cost of computing operations (as measured in gas):</p>
</div>
<div class="listingblock data-line-640">
<div class="content">
<pre>transaction fee = total gas used * gas price paid  (in ether)</pre>
</div>
</div>
<div class="paragraph data-line-644">
<p>When constructing a new block, miners on the Ethereum network can choose among pending transactions by selecting those that offer to pay a higher gas price. Offering a higher gas price will therefore incentivize miners to include your transaction and get it confirmed faster.</p>
</div>
<div class="paragraph data-line-646">
<p>In practice, the sender of a transaction will set a gas limit that is higher than or equal to the amount of gas expected to be used. If the gas limit is set higher than the amount of gas consumed, the sender will receive a refund of the excess amount, as miners are only compensated for the work they actually perform.</p>
</div>
<div class="paragraph data-line-648">
<p>It is important to be clear about the distinction between the <em>gas cost</em> and the <em>gas price</em>. To recap:</p>
</div>
<div class="ulist data-line-650">
<ul>
<li class="data-line-650">
<p>Gas cost is the number of units of gas required to perform a particular operation.</p>
</li>
<li class="data-line-652">
<p>Gas price is the amount of ether you are willing to pay per unit of gas when you send your transaction to the Ethereum network.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip data-line-655">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-656">
<p>While gas has a price, it cannot be "owned" nor "spent." Gas exists only inside the EVM, as a count of how much computational work is being performed. The sender is charged a transaction fee in ether, which is then converted to gas for EVM accounting and then back to ether as a transaction fee paid to the miners.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-660">
<h5 id="_negative_gas_costs">Negative gas costs</h5>
<div class="paragraph data-line-662">
<p>Ethereum encourages the deletion of used storage variables and accounts by refunding some of the gas used during contract execution.</p>
</div>
<div class="paragraph data-line-664">
<p>There are two operations in the EVM with negative gas costs:</p>
</div>
<div class="ulist data-line-666">
<ul>
<li class="data-line-666">
<p>Deleting a contract (SELFDESTRUCT) is worth a refund of 24,000 gas.</p>
</li>
<li class="data-line-667">
<p>Changing a storage address from a nonzero value to zero (SSTORE[x] = 0) is worth a refund of 15,000 gas.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-669">
<p>To avoid exploitation of the refund mechanism, the maximum refund for a transaction is set to half the total amount of gas used (rounded down).</p>
</div>
</div>
</div>
<div class="sect3 data-line-671">
<h4 id="_block_gas_limit">Block Gas Limit</h4>
<div class="paragraph data-line-673">
<p>The block gas limit is the maximum amount of gas that may be consumed by all the transactions in a block, and constrains how many transactions can fit into a block.</p>
</div>
<div class="paragraph data-line-675">
<p>For example, let’s say we have 5 transactions whose gas limits have been set to 30,000, 30,000, 40,000, 50,000, and 50,000. If the block gas limit is 180,000, then any four of those transactions can fit in a block, while the fifth will have to wait for a future block. As previously discussed, miners decide which transactions to include in a block. Different miners are likely to select different combinations, mainly because they receive transactions from the network in a different order.</p>
</div>
<div class="paragraph data-line-677">
<p>If a miner tries to include a transaction that requires more gas than the current block gas limit, the block will be rejected by the network. Most Ethereum clients will stop you from issuing such a transaction by giving a warning along the lines of “transaction exceeds block gas limit.” The block gas limit on the Ethereum mainnet is 8 million gas at the time of writing according to <a href="https://etherscan.io" class="undefined" data-href="https://etherscan.io">https://etherscan.io</a>, meaning that around 380 basic transactions (each consuming 21,000 gas) could fit into a block.</p>
</div>
<div class="sect4 data-line-679">
<h5 id="_who_decides_what_the_block_gas_limit_is">Who decides what the block gas limit is?</h5>
<div class="paragraph data-line-681">
<p>The miners on the network collectively decide the block gas limit. Individuals who want to mine on the Ethereum network use a mining program, such as Ethminer, which connects to a Geth or Parity Ethereum client. The Ethereum protocol has a built-in mechanism where miners can vote on the gas limit so capacity can be increased or decreased in subsequent blocks. The miner of a block can vote to adjust the block gas limit by a factor of 1/1,024 (0.0976%) in either direction. The result of this is an adjustable block size based on the needs of the network at the time. This mechanism is coupled with a default mining strategy where miners vote on a gas limit that is at least 4.7 million gas, but which targets a value of 150% of the average of recent total gas usage per block (using a 1,024-block exponential moving average).</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-683">
<h3 id="_conclusions_10">Conclusions</h3>
<div class="paragraph data-line-29">
<p>In this chapter we have explored the Ethereum Virtual Machine, tracing the execution of various smart contracts and looking at how the EVM executes bytecode. We also looked at gas, the EVM&#8217;s accounting mechanism, and saw how it solves the halting problem and protects Ethereum from denial-of-service attacks. Next, in <a href="#consensus">Consensus</a>, we will look at the mechanism used by Ethereum to achieve decentralized consensus.</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-2">
<h2 id="consensus">Consensus</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Throughout this book we have talked about "consensus rules&#x201d;&#x2014;the rules that everyone must agree to for the system to operate in a decentralized, yet deterministic, manner. In computer science, the term <em>consensus</em> predates blockchains and is related to the broader problem of synchronizing state in distributed systems, such that different participants in a distributed system all (eventually) agree on a single system-wide state. This is called "reaching consensus."</p>
</div>
<div class="paragraph data-line-6">
<p>When it comes to the core function of decentralized record keeping and verification, it can become problematic to rely on trust alone to ensure that information derived from state updates is correct. This rather general challenge is particularly pronounced in decentralized networks because there is no central entity to decide what is true. The lack of a central decision-making entity is one of the main attractions of blockchain platforms, because of the resulting capacity to resist censorship and the lack of dependence on authority for permission to access information. However, these benefits come at a cost: without a trusted arbitrator, any disagreements, deceptions, or differences need to be reconciled using other means. Consensus algorithms are the  mechanism used to reconcile security and decentralization.</p>
</div>
<div class="paragraph data-line-8">
<p>In blockchains, consensus is a critical property of the system. Simply put, there is money at stake! So, in the context of blockchains, <em>consensus</em> is about being able to arrive at a common state, while maintaining decentralization. In other words, consensus is intended to produce a system of <em>strict rules without rulers</em>. There is no one person, organization, or group "in charge&#x201d;; rather, power and control are diffused across a broad network of participants, whose self-interest is served by following the rules and behaving honestly.</p>
</div>
<div class="paragraph data-line-10">
<p>The ability to come to consensus across a distributed network, under adversarial conditions, without centralizing control is the core principle of all open public blockchains. To address this challenge and maintain the valued property of decentralization, the community continues to experiment with different models of consensus. This chapter explores these consensus models and their expected impact on smart contract blockchains such as Ethereum.</p>
</div>
<div class="admonitionblock note data-line-13">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-14">
<p>While consensus algorithms are an important part of how blockchains work, they operate at a foundational layer, far below the abstraction of smart contracts. In other words, most of the details of consensus are hidden from the writers of smart contracts. You don&#8217;t need to know how they work to use Ethereum, any more than you need to know how routing works to use the internet.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2 data-line-17">
<h3 id="_consensus_via_proof_of_work">Consensus via Proof of Work</h3>
<div class="paragraph data-line-19">
<p>The creator of the original blockchain, Bitcoin, invented a <em>consensus algorithm</em> called <em>proof of work</em> (PoW). Arguably, PoW is the most important invention underpinning Bitcoin. The colloquial term for PoW is "mining," which creates a misunderstanding about the primary purpose of consensus. Often people assume that the purpose of mining is the creation of new currency, since the purpose of real-world mining is the extraction of precious metals or other resources. Rather, the real purpose of mining (and all other consensus models) is to <em>secure the blockchain</em>, while keeping control over the system decentralized and diffused across as many participants as possible. The reward of newly minted currency is an incentive to those who contribute to the security of the system: a means to an end. In that sense, the reward is the means and decentralized security is the end. In PoW consensus there is also a corresponding "punishment," which is the cost of energy required to participate in mining. If participants do not follow the rules and earn the reward, they risk the funds they have already spent on electricity to mine. Thus, PoW consensus is a careful balance of risk and reward that drives participants to behave honestly out of self-interest.</p>
</div>
<div class="paragraph data-line-21">
<p>Ethereum is currently a PoW blockchain, in that it uses a PoW algorithm with the same basic incentive system for the same basic goal: securing the blockchain while decentralizing control. Ethereum&#8217;s PoW algorithm is slightly different than Bitcoin&#8217;s and is called <em>Ethash</em>. We will examine the function and design characteristics of the algorithm in <a href="#ethash">Ethash: Ethereum&#8217;s Proof-of-Work Algorithm</a>.</p>
</div>
</div>
<div class="sect2 data-line-23">
<h3 id="_consensus_via_proof_of_stake_pos">Consensus via Proof of Stake (PoS)</h3>
<div class="paragraph data-line-25">
<p>Historically, proof of work was not the first consensus algorithm proposed. Preceding the introduction of proof of work, many researchers had proposed variations of consensus algorithms based on financial stake, now called <em>proof of stake</em> (PoS). In some respects, proof of work was invented as an alternative to proof of stake. Following the success of Bitcoin, many blockchains have emulated proof of work. Yet the explosion of research into consensus algorithms has also resurrected proof of stake, significantly advancing the state of the technology. From the beginning, Ethereum&#8217;s founders were hoping to eventually migrate its consensus algorithm to proof of stake. In fact, there is a deliberate handicap on Ethereum&#8217;s proof of work called the <em>difficulty bomb</em>, intended to gradually make proof-of-work mining of Ethereum more and more difficult, thereby forcing the transition to proof of stake.</p>
</div>
<div class="paragraph data-line-27">
<p>At the time of publication of this book, Ethereum is still using proof of work, but the ongoing research toward a proof-of-stake alternative is nearing completion. Ethereum&#8217;s planned PoS algorithm is called <em>Casper</em>. The introduction of Casper as a replacement for Ethash has been postponed several times over the past two years, necessitating interventions to defuse the difficulty bomb and postpone its forced obsolescence of proof of work.</p>
</div>
<div class="paragraph data-line-29">
<p>In general, a PoS algorithm works as follows. The blockchain keeps track of a set of validators, and anyone who holds the blockchain&#8217;s base cryptocurrency (in Ethereum&#8217;s case, ether) can become a validator by sending a special type of transaction that locks up their ether into a deposit. The validators take turns proposing and voting on the next valid block, and the weight of each validator&#8217;s vote depends on the size of its deposit (i.e., stake). Importantly, a validator risks losing their deposit if the block they staked it on is rejected by the majority of validators. Conversely, validators earn a small reward, proportional to their deposited stake, for every block that is accepted by the majority. Thus, PoS forces validators to act honestly and follow the consensus rules, by a system of reward and punishment. The major difference between PoS and PoW is that the punishment in PoS is intrinsic to the blockchain (e.g., loss of staked ether), whereas in PoW the punishment is extrinsic (e.g., loss of funds spent on <span class="keep-together">electricity</span>).</p>
</div>
</div>
<div class="sect2 data-line-32">
<h3 id="ethash">Ethash: Ethereum&#8217;s Proof-of-Work Algorithm</h3>
<div class="paragraph data-line-34">
<p>Ethash is the Ethereum PoW algorithm. It uses an evolution of the Dagger–Hashimoto algorithm, which is a combination of Vitalik Buterin&#8217;s Dagger algorithm and Thaddeus Dryja&#8217;s Hashimoto algorithm. Ethash is dependent on the generation and analysis of a large dataset, known as a <em>directed acyclic graph</em> (or, more simply, &#x201c;the DAG&#x201d;). The DAG had an initial size of about 1 GB and will continue to slowly and linearly grow in size, being updated once every epoch (30,000 blocks, or roughly 125 hours).</p>
</div>
<div class="paragraph data-line-36">
<p>The purpose of the DAG is to make the Ethash PoW algorithm dependent on maintaining a large, frequently accessed data structure. This in turn is intended to make Ethash "ASIC resistant," which means that it is more difficult to make <em>application-specific integrated circuits</em> (ASIC) mining equipment that is orders of magnitude faster than a fast <em>graphics processing unit</em> (GPU). Ethereum&#8217;s founders wanted to avoid centralization in PoW mining, where those with access to specialized silicon fabrication factories and big budgets could dominate the mining infrastructure and undermine the security of the consensus algorithm.</p>
</div>
<div class="paragraph data-line-38">
<p>Use of consumer-level GPUs for carrying out the PoW on the Ethereum network means that more people around the world can participate in the mining process. The more independent miners there are the more decentralized the mining power is, which means we can avoid a situation like in Bitcoin, where much of the mining power is concentrated in the hands of a few large industrial mining operations. The downside of the use of GPUs for mining is that it precipitated a worldwide shortage GPUs in 2017, causing their price to skyrocket and an outcry from gamers. This led to purchase restrictions at retailers, limiting buyers to one or two GPUs per customer.</p>
</div>
<div class="paragraph data-line-40">
<p>Until recently, the threat of ASIC miners on the Ethereum network was largely nonexistent. Using ASICs for Ethereum requires the design, manufacture, and distribution of highly customized hardware. Producing them requires considerable investment of time and money. The Ethereum developers' long-expressed plans to move to a PoS consensus algorithm likely kept ASIC suppliers away from targeting the Ethereum network for a long time. As soon as Ethereum moves to PoS, ASICs designed for the PoW algorithm will be rendered useless—that is, unless miners can use them to mine other cryptocurrencies instead. The latter possibility is now a reality with a range of other Ethash-based consensus coins available, such as PIRL and Ubiq, and Ethereum Classic has pledged to remain a PoW blockchain for the foreseeable future. This means that we will likely see ASIC mining begin to become a force on the Ethereum network while is it still operating on PoW consensus.</p>
</div>
</div>
<div class="sect2 data-line-42">
<h3 id="_casper_ethereums_proof_of_stake_algorithm">Casper: Ethereum&#8217;s Proof-of-Stake Algorithm</h3>
<div class="paragraph data-line-44">
<p>Casper is the proposed name for Ethereum&#8217;s PoS consensus algorithm. It is still under active research and development and is not implemented on the Ethereum blockchain at the time of publication of this book. Casper is being developed in two competing "flavors":</p>
</div>
<div class="ulist data-line-46">
<ul>
<li class="data-line-46">
<p>Casper FFG: "The Friendly Finality Gadget"</p>
</li>
<li class="data-line-47">
<p>Casper CBC: "The Friendly GHOST/Correct-by-Construction"</p>
</li>
</ul>
</div>
<div class="paragraph data-line-49">
<p>Initially, Casper FFG was proposed as a hybrid PoW/PoS algorithm to be implemented as a transition to a more permanent "pure PoS" algorithm. But in June 2018, Vitalik Buterin, who was leading the research work on Casper FFG, decided to "scrap" the hybrid model in favor of a pure PoS algorithm. Now, Casper FFG and Casper CBC are both being developed in parallel. As Vitalik explains:</p>
</div>
<div class="quoteblock data-line-51">
<blockquote>
<div class="paragraph data-line-52">
<p>The main tradeoff between FFG and CBC is that CBC seems to have nicer theoretical properties, but FFG seems to be easier to implement.</p>
</div>
</blockquote>
</div>
<div class="paragraph data-line-55">
<p>More information about Casper&#8217;s history, ongoing research and future plans can be found at the following links:</p>
</div>
<div class="ulist data-line-57">
<ul>
<li class="data-line-57">
<p><a href="http://bit.ly/2RO5HAl" data-href="http://bit.ly/2RO5HAl">Ethereum Casper (Proof of Stake)</a></p>
</li>
<li class="data-line-58">
<p><a href="http://bit.ly/2FlBojb" data-href="http://bit.ly/2FlBojb">History of Casper, Part 1</a></p>
</li>
<li class="data-line-59">
<p><a href="http://bit.ly/2QyHiic" data-href="http://bit.ly/2QyHiic">History of Casper, Part 2</a></p>
</li>
<li class="data-line-60">
<p><a href="http://bit.ly/2JWWFyt" data-href="http://bit.ly/2JWWFyt">History of Casper, Part 3</a></p>
</li>
<li class="data-line-61">
<p><a href="http://bit.ly/2FsaExI" data-href="http://bit.ly/2FsaExI">History of Casper, Part 4</a></p>
</li>
<li class="data-line-62">
<p><a href="http://bit.ly/2PPhhOv" data-href="http://bit.ly/2PPhhOv">History of Casper, Part 5</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2 data-line-64">
<h3 id="_principles_of_consensus">Principles of Consensus</h3>
<div class="paragraph data-line-66">
<p>The principles and assumptions of consensus algorithms can be more clearly understood by asking a few key questions:</p>
</div>
<div class="ulist data-line-68">
<ul>
<li class="data-line-68">
<p>Who can change the past, and how? (This is also known as <em>immutability</em>.)</p>
</li>
<li class="data-line-69">
<p>Who can change the future, and how? (This is also known as <em>finality</em>.)</p>
</li>
<li class="data-line-70">
<p>What is the cost to make such changes?</p>
</li>
<li class="data-line-71">
<p>How decentralized is the power to make such changes?</p>
</li>
<li class="data-line-72">
<p>Who will know if something has changed, and how will they know?</p>
</li>
</ul>
</div>
<div class="paragraph data-line-74">
<p>Consensus algorithms are evolving rapidly, attempting to answer these questions in increasingly innovative ways.</p>
</div>
</div>
<div class="sect2 data-line-76">
<h3 id="_controversy_and_competition">Controversy and Competition</h3>
<div class="paragraph data-line-78">
<p>At this point you might be wondering: Why do we need so many different consensus algorithms? Which one works better? The answer to the latter question is at the center of the most exciting area of research in distributed systems of the past decade. It all boils down to what you consider "better&#x201d;&#x2014;which in the context of computer science is about assumptions, goals, and the unavoidable trade-offs.</p>
</div>
<div class="paragraph data-line-80">
<p>It is likely that no  algorithm can optimize across all dimensions of the problem of decentralized consensus. When someone suggests that one consensus algorithm is "better" than the others, you should start asking questions that clarify: Better at what? Immutability, finality, decentralization, cost? There is no clear answer to these questions, at least not yet. Furthermore, the design of consensus algorithms is at the center of a multi-billion-dollar industry and generates enormous controversy and heated arguments. In the end, there might not be a "correct" answer, just as there might be different answers for different applications.</p>
</div>
<div class="paragraph data-line-82">
<p>The entire blockchain industry is one giant experiment where these questions will be tested under adversarial conditions, with enormous monetary value at stake. In the end, history will answer the controversy.</p>
</div>
</div>
<div class="sect2 data-line-84">
<h3 id="_conclusions_11">Conclusions</h3>
<div class="paragraph data-line-31">
<p>Ethereum&#8217;s consensus algorithm is still in flux at the time of completion of this book. In a future edition, we will likely add more detail about Casper and other related technologies as these mature and are deployed on Ethereum. This chapter represents the end of our journey, completing <em>Mastering Ethereum</em>. Additional reference material follows in the appendixes. Thank you for reading this book, and congratulations on reaching the end!</p>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-3">
<h2 id="ethereum_fork_history">Appendix A: Historique de la fourche Ethereum</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>Most hard forks are planned as part of an upgrade roadmap and consist of updates that the community generally agrees to (i.e., there is social consensus). However, some hard forks lack consensus, which leads to multiple distinct blockchains. The events that led to the Ethereum/Ethereum Classic split are one such case, and are discussed in this appendix.</p>
</div>
<div class="sect2 data-line-7">
<h3 id="etc_origin">Ethereum Classic (ETC)</h3>
<div class="paragraph data-line-8">
<p>Ethereum Classic came to be after members of the Ethereum community implemented a time-sensitive hard fork (codenamed &#x201c;DAO&#x201d;). On July 20, 2016, at a block height of 1.92 million, Ethereum introduced an irregular state change via a hard fork in an effort to return approximately 3.6 million ether that had been taken from a smart contract known as The DAO. Almost everyone agreed that the ether taken had been stolen and that leaving it all in the hands of the thief would be of significant detriment to the development of the Ethereum ecosystem as well as the platform itself.</p>
</div>
<div class="paragraph data-line-10">
<p>Returning the ether to its respective owners as though The DAO had never even existed was technically easy, if rather politically controversial. A number of people in the ecosystem disagreed with this change, believing immutability should be a fundamental principle of the Ethereum blockchain without exception; they elected to continue the original chain under the moniker of Ethereum Classic. While the split itself was initially ideological, the two chains have since evolved into separate entities.</p>
</div>
</div>
<div class="sect2 data-line-13">
<h3 id="dao_origin">The Decentralized Autonomous Organization (The DAO)</h3>
<div class="paragraph data-line-15">
<p>The DAO was created by Slock.it, with the aim of providing community-based funding and governance for projects. The core idea was that proposals would be submitted, curators would manage proposals, funds would be raised from investors within the Ethereum community, and, if the projects proved successful, investors would receive a share of the profits.</p>
</div>
<div class="paragraph data-line-17">
<p>The DAO was also one of the first experiments in an Ethereum token. Rather than funding projects directly with ether, participants would trade their ether for DAO tokens, use them to vote on project funding, and later be able to trade them back for ether.</p>
</div>
<div class="paragraph data-line-19">
<p>DAO tokens were available to purchase in a crowdsale that ran from April 5 through April 30, 2016, amassing <a href="https://econ.st/2qfJO1g" data-href="https://econ.st/2qfJO1g">nearly 14%</a> of the total ether in existence, which was worth ~$150 million at the time.</p>
</div>
</div>
<div class="sect2 data-line-22">
<h3 id="dao_reentrancy_bug">The Reentrancy Bug</h3>
<div class="paragraph data-line-24">
<p>On June 9, 2016, developers Peter Vessenes and Chriseth reported that most Ethereum-based contracts that managed funds were potentially <a href="http://bit.ly/2AAaDmA" data-href="http://bit.ly/2AAaDmA">vulnerable to an exploit</a> that could empty contract funds. A few days later, on June 12, Stephen Tual (cofounder of Slock.it) reported that <a href="http://bit.ly/2qmo3g1" data-href="http://bit.ly/2qmo3g1">The DAO&#8217;s code was not vulnerable</a> to the bug described by Peter and Chriseth. Worried DAO contributors breathed a sigh of relief&#x2014;until five days later, when an unknown attacker started <a href="http://bit.ly/2Q7zR1h" data-href="http://bit.ly/2Q7zR1h">draining The DAO</a> using an exploit similar to the one for which the warning had been issued. Ultimately, the DAO attacker siphoned ~3.6 million ether out of The DAO.</p>
</div>
<div class="paragraph data-line-26">
<p>Simultaneously, an assemblage of volunteers calling themselves the Robin Hood Group (RHG) started using the same exploit to withdraw the remaining funds in order to save them from being stolen by the DAO attacker. On June 21, <a href="http://bit.ly/2PtX4xl" data-href="http://bit.ly/2PtX4xl">the RHG announced</a> that they had secured about 70% of The DAO&#8217;s funds (roughly 7.2 million ether), with plans to return it to the community (which they successfully did on the ETC network, and didn&#8217;t need to do on the Ethereum network after the fork). Many thanks and commendations were given to the RHG for their quick thinking and fast actions that helped secure the bulk of the community&#8217;s ether.</p>
</div>
<div class="sect3 data-line-29">
<h4 id="dao_reentrancy_bug_technicals">Technical Details</h4>
<div class="paragraph data-line-30">
<p>While a more detailed and thorough explanation of the bug is given by <a href="http://bit.ly/2EQaLCI" data-href="http://bit.ly/2EQaLCI">Phil Daian</a>, the short explanation is that a crucial function in the DAO had two lines of code in the wrong order, meaning that the attacker could have requests to withdraw ether acted upon repeatedly, before the check of whether the attacker was entitled to the withdrawal was completed. This type of vulnerability is described in <a href="#reentrancy_security">Reentrancy</a>.</p>
</div>
</div>
<div class="sect3 data-line-33">
<h4 id="dao_reentrancy_bug_attack_flow">Attack Flow</h4>
<div class="paragraph data-line-34">
<p>Imagine you had $100 in your bank account and you could bring your bank teller any number of withdrawal slips. The teller would give you money for each slip in order, and only after processing all the slips would they record your withdrawal. What if you brought them three slips, each requesting withdraw $100? What if you brought them three thousand?</p>
</div>
<div class="paragraph data-line-36">
<p>The DAO attack worked like this:</p>
</div>
<div class="olist arabic data-line-38">
<ol class="arabic">
<li class="data-line-38">
<p>The DAO attacker asks the DAO contract to withdraw DAO tokens (DAO).</p>
</li>
<li class="data-line-39">
<p>The attacker asks the contract to withdraw DAO <em>again</em>, before the contract updates its records to show that DAO was withdrawn.</p>
</li>
<li class="data-line-40">
<p>The attacker repeats step 2 as many times as possible.</p>
</li>
<li class="data-line-41">
<p>The contract finally logs a single DAO withdrawal, losing track of the withdrawals that happened in the interim.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2 data-line-44">
<h3 id="dao_hard_fork">The DAO Hard Fork</h3>
<div class="paragraph data-line-45">
<p>Fortunately, there were several safeguards built into The DAO: notably, all withdrawal requests were subject to a 28-day delay. This gave the community a little while to discuss what to do about the exploit, because from roughly June 17&#x2013;July 20 the DAO attacker would be unable to convert their DAO tokens into ether.</p>
</div>
<div class="paragraph data-line-47">
<p>Several developers focused on finding a viable solution, and multiple avenues were explored in this short space of time. Among them were a <a href="http://bit.ly/2qhruEK" data-href="http://bit.ly/2qhruEK"><em>DAO soft fork</em></a>, announced on June 24, to delay DAO withdrawals until consensus was reached, and a <a href="http://bit.ly/2AAGjIu" data-href="http://bit.ly/2AAGjIu"><em>DAO hard fork</em></a>, announced on July 15, to reverse the effects of the DAO attack with an exceptional state change.</p>
</div>
<div class="paragraph data-line-49">
<p>On June 28, developers discovered <a href="http://bit.ly/2zgOxUn" data-href="http://bit.ly/2zgOxUn">a DoS exploit in the DAO soft fork</a>  and concluded that the DAO hard fork would be the only viable option to fully resolve the situation. The DAO hard fork would transfer all ether that had been invested in The DAO into a new refund smart contract, allowing the original owners of the ether to claim full refunds. This provided a solution for returning the hacked funds, but also meant interfering with the balances of specific addresses on the network, however isolated they were. There would also be some leftover ether in portions of The DAO known as <em>childDAOs</em>. A group of trustees would manually authorize the leftover ether, worth <a href="http://bit.ly/2RuUrJh" data-href="http://bit.ly/2RuUrJh">~$6–7 million</a> at the time.</p>
</div>
<div class="paragraph data-line-51">
<p>With time running out, multiple Ethereum development teams created clients that allowed a user to decide whether they wanted to enable this fork. However, the client creators wanted to decide whether to make this choice opt-in (don&#8217;t fork by default) or opt-out (fork by default). On July 15, a vote was opened on <a href="http://bit.ly/2ABkTuV" data-href="http://bit.ly/2ABkTuV"><em>carbonvote.com</em></a>. The next day, at block height <a href="http://bit.ly/2yHb7Gl" data-href="http://bit.ly/2yHb7Gl">1,894,000</a>, it was closed. Of the <a href="http://bit.ly/2RuUrJh" data-href="http://bit.ly/2RuUrJh">5.5% of the total ether supply</a> that voted, &#x7e;80% of the votes (&#x7e;4.5% of the total ether supply) voted for opt-out. One-quarter of the opt-out vote came from a single address.</p>
</div>
<div class="paragraph data-line-53">
<p>Ultimately the decision became opt-out, so those who opposed the DAO hard fork would need to explicitly state their opposition by changing a configuration option in the software they were running.</p>
</div>
<div class="paragraph data-line-55">
<p>On July 20, at block height <a href="http://bit.ly/2zfaIKB" data-href="http://bit.ly/2zfaIKB">1,920,000</a>, Ethereum <a href="http://bit.ly/2yJxZ83" data-href="http://bit.ly/2yJxZ83">implemented the DAO hard fork</a> and thus two Ethereum networks were created: one including the state change, and the other ignoring it.</p>
</div>
<div class="paragraph data-line-57">
<p>When the DAO hard-forked Ethereum (present-day Ethereum) gained a majority of the mining power, many assumed that consensus was achieved and the minority chain would fade away, as in previous forks. Despite this, a sizable portion of the Ethereum community (roughly 10% by value and mining power) started supporting the non-forked chain, which came to be known as Ethereum Classic.</p>
</div>
<div class="paragraph data-line-59">
<p>Within days of the fork, several exchanges began to list both Ethereum ("ETH") and Ethereum Classic ("ETC"). Due to the nature of hard forks, all Ethereum users holding ether at the time of the split then held funds on both of the chains, and a market value for ETC was soon established with <a href="http://bit.ly/2qhuNvP" data-href="http://bit.ly/2qhuNvP">Poloniex</a> listing ETC on July 24.</p>
</div>
<div class="sect3 data-line-62">
<h4 id="dao_hard_fork_timeline">Timeline of the DAO Hard Fork</h4>
<div class="ulist data-line-64">
<ul>
<li class="data-line-64">
<p>April 5, 2016: Slock.it <a href="http://bit.ly/2Db4boE" data-href="http://bit.ly/2Db4boE">releases a security review</a> of the generic DAO framework smart contracts by Deja Vu Security.</p>
</li>
<li class="data-line-65">
<p>April 30, 2016: The DAO crowdsale <a href="http://bit.ly/2qhwhpI" data-href="http://bit.ly/2qhwhpI">launches</a>.</p>
</li>
<li class="data-line-66">
<p>May 27, 2016: The DAO crowdsale ends.</p>
</li>
<li class="data-line-67">
<p>June 9, 2016: A generic <a href="http://bit.ly/2AAaDmA" data-href="http://bit.ly/2AAaDmA">recursive call bug</a> is discovered and believed to affect many Solidity contracts that track users' balances.</p>
</li>
<li class="data-line-68">
<p>June 12, 2016: Stephen Tual <a href="http://bit.ly/2qmo3g1" data-href="http://bit.ly/2qmo3g1">declares</a> that The DAO&#8217;s funds are not at risk.</p>
</li>
<li class="data-line-69">
<p>June 17, 2016: <a href="http://bit.ly/2EQaLCI" data-href="http://bit.ly/2EQaLCI">The DAO is exploited</a> and a variant of the discovered bug (termed the "reentrancy bug") is used to start draining the funds, eventually nabbing ~30% of the ether.</p>
</li>
<li class="data-line-70">
<p>June 21, 2016: The RHG <a href="http://bit.ly/2zgl3Gk" data-href="http://bit.ly/2zgl3Gk">announces</a> it has secured the other ~70% of the ether stored within The DAO.</p>
</li>
<li class="data-line-71">
<p>June 24, 2016: A <a href="http://bit.ly/2qhruEK" data-href="http://bit.ly/2qhruEK">soft fork vote</a> is announced via opt-in signaling through Geth and Parity clients, designed to temporarily withhold funds until the community can better decide what to do.</p>
</li>
<li class="data-line-72">
<p>June 28, 2016: A <a href="http://bit.ly/2zgOxUn" data-href="http://bit.ly/2zgOxUn">vulnerability</a> is discovered in the soft fork and it&#8217;s abandoned.</p>
</li>
<li class="data-line-73">
<p>June 28, 2016 to July 15: Users debate whether or not to hard fork; most of the vocal public debate occurs on the <em>/r/ethereum</em> subreddit.</p>
</li>
<li class="data-line-74">
<p>July 15, 2016: The <a href="http://bit.ly/2qmo3g1" data-href="http://bit.ly/2qmo3g1">DAO hard fork</a> is proposed, to return the funds taken in the DAO attack.</p>
</li>
<li class="data-line-75">
<p>July 15, 2016: A <a href="http://bit.ly/2ABkTuV" data-href="http://bit.ly/2ABkTuV">vote is held</a> on CarbonVote to decide if the DAO hard fork will be opt-in (don&#8217;t fork by default) or opt-out (fork by default).</p>
</li>
<li class="data-line-76">
<p>July 16, 2016: <a href="http://bit.ly/2RuUrJh" data-href="http://bit.ly/2RuUrJh">5.5% of the total ether supply votes</a>; ~80% of the votes (~4.5% of the total supply) are pro the opt-out hard fork, with one-quarter of the pro-vote coming from a single address.</p>
</li>
<li class="data-line-77">
<p>July 20, 2016: The <a href="http://bit.ly/2yJxZ83" data-href="http://bit.ly/2yJxZ83">hard fork</a> occurs at block 1,920,000.</p>
</li>
<li class="data-line-78">
<p>July 20, 2016: Those against the DAO hard fork continue running the old client software; this leads to issues with <a href="http://bit.ly/2qjJm27" data-href="http://bit.ly/2qjJm27">transactions being replayed on both chains</a>.</p>
</li>
<li class="data-line-79">
<p>July 24, 2016: <a href="http://bit.ly/2qhuNvP" data-href="http://bit.ly/2qhuNvP">Poloniex lists</a> the original Ethereum chain under the ticker symbol ETC; it&#8217;s the first exchange to do so.</p>
</li>
<li class="data-line-80">
<p>August 10, 2016: The RHG <a href="http://bit.ly/2JrLpK2" data-href="http://bit.ly/2JrLpK2">transfers 2.9</a> million of the recovered ETC to Poloniex in order to convert it to ETH on the advice of Bity SA; 14% of the total RHG holdings are converted from ETC to ETH and other cryptocurrencies, and <a href="http://bit.ly/2ETDdUc" data-href="http://bit.ly/2ETDdUc">Poloniex freezes</a> the other 86% of deposited ETH.</p>
</li>
<li class="data-line-81">
<p>August 30, 2016: The frozen funds are sent by Poloniex back to the RHG, which then sets up a refund contract on the ETC chain.</p>
</li>
<li class="data-line-82">
<p>December 11, 2016: IOHK&#8217;s ETC development team forms, led by Ethereum founding member Charles Hoskinson.</p>
</li>
<li class="data-line-83">
<p>January 13, 2017: The ETC network is updated to resolve transaction replay issues; the chains are now functionally separate.</p>
</li>
<li class="data-line-84">
<p>February 20, 2017: The ETCDEVTeam forms, led by early ETC developer Igor Artamonov (splix).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2 data-line-87">
<h3 id="eth_etc_differences">Ethereum and Ethereum Classic</h3>
<div class="paragraph data-line-89">
<p>While the initial split was centered around The DAO, the two networks, Ethereum and Ethereum Classic, are now separate projects, although most development is still done by the Ethereum community and simply ported to Ethereum Classic codebases. Nevertheless, the full set of differences is constantly evolving and too extensive to cover in this appendix. However, it is worth noting that the chains do differ significantly in their core development and community structure. A few of the technical differences are discussed next.</p>
</div>
<div class="sect3 data-line-93">
<h4 id="eth_etc_differences_evm">The EVM</h4>
<div class="paragraph data-line-94">
<p>For the most part (at the time of writing), the two networks remain highly compatible: contract code produced for one chain runs as expected on the other; but there are some small differences in EVM OPCODES (see EIPs <a href="http://bit.ly/2yIajkF" data-href="http://bit.ly/2yIajkF">140</a>, <a href="http://bit.ly/2qhKz9Y" data-href="http://bit.ly/2qhKz9Y">145</a>, and <a href="http://bit.ly/2SxsrFR" data-href="http://bit.ly/2SxsrFR">214</a>).</p>
</div>
</div>
<div class="sect3 data-line-97">
<h4 id="eth_etc_differences_core_development">Core Network Development</h4>
<div class="paragraph data-line-98">
<p>Being open projects, blockchain platforms often have many users and contributors. However, the core network development (i.e., of the code that runs the network) is often done by small groups due to the expertise and knowledge required to develop this type of software. On Ethereum, this work is done by the Ethereum Foundation and volunteers. On Ethereum Classic, it&#8217;s done by ETCDEV, IOHK, and volunteers.</p>
</div>
</div>
</div>
<div class="sect2 data-line-101">
<h3 id="ethereum_forks">Other Notable Ethereum Forks</h3>
<div class="paragraph data-line-103">
<p><a href="https://ellaism.org/about/" data-href="https://ellaism.org/about/">Ellaism</a> is an Ethereum-based network that intends to use PoW exclusively to secure the blockchain. It has no pre-mine and no mandatory developer fees, with all support and development donated freely by the community. Its developers believe this makes theirs &#x201c;one of the most honest pure Ethereum projects,&#x201d; and one that is &#x201c;uniquely interesting as a platform for serious developers, educators, and enthusiasts. Ellaism is a pure smart contract platform. Its goal is to create a smart contract platform that is both fair and trustworthy.&#x201d; The principles of the platform are as follows:</p>
</div>
<div class="quoteblock data-line-105">
<blockquote>
<div class="ulist data-line-106">
<ul>
<li class="data-line-106">
<p>All changes and upgrades to the protocol should strive to maintain and reinforce these Principles of Ellaism.</p>
</li>
<li class="data-line-107">
<p>Monetary Policy: 280 million coins.</p>
</li>
<li class="data-line-108">
<p>No Censorship: Nobody should be able to prevent valid txs from being confirmed.</p>
</li>
<li class="data-line-109">
<p>Open-Source: Ellaism source code should always be open for anyone to read, modify, copy, share.</p>
</li>
<li class="data-line-110">
<p>Permissionless: No arbitrary gatekeepers should ever prevent anybody from being part of the network (user, node, miner, etc).</p>
</li>
<li class="data-line-111">
<p>Pseudonymous: No ID should be required to own, use Ellaism.</p>
</li>
<li class="data-line-112">
<p>Fungible: All coins are equal and should be equally spendable.</p>
</li>
<li class="data-line-113">
<p>Irreversible Transactions: Confirmed blocks should be set in stone. Blockchain History should be immutable.</p>
</li>
<li class="data-line-114">
<p>No Contentious Hard Forks: Never hard fork without consensus from the whole community. Only break the existing consensus when necessary.</p>
</li>
<li class="data-line-115">
<p>Many feature upgrades can be carried out without a hard fork, such as improving the performance of the EVM.</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph data-line-118">
<p>Several other forks have occurred on Ethereum as well. Some of these are hard forks, in the sense that they split directly off of the preexisting Ethereum network. Others are software forks: they use Ethereum&#8217;s client/node software but run entirely separate networks without any history shared with Ethereum. There will likely be more forks over the life of Ethereum.</p>
</div>
<div class="paragraph data-line-120">
<p>There are also several other projects that claim to be Ethereum forks but are actually based on ERC20 tokens and run on the Ethereum network. Two examples of these are EtherBTC (ETHB) and Ethereum Modification (EMOD). These are not forks in the traditional sense, and may sometimes be called &#x201c;airdrops.&#x201d;</p>
</div>
<div class="paragraph data-line-122">
<p>Here&#8217;s a brief rundown of some of the more notable forks that have occurred:</p>
</div>
<div class="ulist data-line-124">
<ul>
<li class="data-line-124">
<p><em>Expanse</em> was the first fork of the Ethereum blockchain to gain traction. It was announced via the Bitcoin Talk forum on September 7, 2015. The actual fork occurred a week later on September 14, 2015, at a block height of 800,000. It was originally founded by Christopher Franko and James Clayton. Their stated vision was to create an advanced chain for: "identity, governance, charity, commerce, and equity".</p>
</li>
<li class="data-line-125">
<p><em>EthereumFog</em> (ETF) was launched on December 14, 2017, and forked at a block height of 4,730,660. The project&#8217;s stated aim is to develop "world decentralized fog computing" by focusing on fog computing and decentralized storage. There is still little information on what this will actually entail.</p>
</li>
<li class="data-line-126">
<p><em>EtherZero</em> (ETZ) was launched on January 19, 2018, at a block height of 4,936,270. Its notable innovations were the introduction of a masternode architecture and the removal of transaction fees for smart contracts to enable a wider diversity of DApps. There has been some criticism from some prominent members of the Ethereum community, MyEtherWallet, and MetaMask, due to the lack of clarity surrounding development and some accusations of possible phishing.</p>
</li>
<li class="data-line-127">
<p><em>EtherInc</em> (ETI) was launched on February 13, 2018, at a block height of 5,078,585, with a focus on building decentralized organizations. Stated goals include the reduction of block times, increased miner rewards, the removal of uncle rewards, and setting a cap on mineable coins. EtherInc uses the same private keys as Ethereum and has implemented replay protection to protect ether on the original non-forked chain.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-3">
<h2 id="ethereum_standards">Appendix B: Normes Ethereum</h2>
<div class="sectionbody">
<div class="sect2 data-line-6">
<h3 id="eips">Ethereum Improvement Proposals (EIPs)</h3>
<div class="paragraph data-line-8">
<p>The Ethereum Improvement Proposal repository is located at <a href="https://github.com/ethereum/EIPs/" class="undefined" data-href="https://github.com/ethereum/EIPs/">https://github.com/ethereum/EIPs/</a>. The workflow is illustrated in <a href="#eip_workflow">Ethereum Improvement Proposal workflow</a>.</p>
</div>
<div class="paragraph data-line-10">
<p>From <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1.md" data-href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1.md">EIP-1</a>:</p>
</div>
<div class="quoteblock data-line-12">
<blockquote>
<div class="paragraph data-line-13">
<p>EIP stands for Ethereum Improvement Proposal. An EIP is a design document providing information to the Ethereum community, or describing a new feature for Ethereum or its processes or environment. The EIP should provide a concise technical specification of the feature and a rationale for the feature. The EIP author is responsible for building consensus within the community and documenting dissenting opinions.</p>
</div>
</blockquote>
</div>
<div id="eip_workflow" class="imageblock data-line-18">
<div class="content">
<img src="images/eip_workflow.png" alt="Ethereum Improvement Proposal Workflow">
</div>
<div class="title">Figure 58. Ethereum Improvement Proposal workflow</div>
</div>
</div>
<div class="sect2 data-line-21">
<h3 id="eip_table">Table of Most Important EIPs and ERCs</h3>
<table class="tableblock frame-all grid-all stretch data-line-25">
<caption class="title">Table 10. Important EIPs and ERCs</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">EIP/ERC #</th>
<th class="tableblock halign-left valign-top">Title/Description</th>
<th class="tableblock halign-left valign-top">Author</th>
<th class="tableblock halign-left valign-top">Layer</th>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Created</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OVq6qa" data-href="http://bit.ly/2OVq6qa">EIP-1</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EIP Purpose and Guidelines</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Martin Becze, Hudson Jameson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meta</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2yJtTNa" data-href="http://bit.ly/2yJtTNa">EIP-2</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Homestead Hard-fork Changes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Jrx93V" data-href="http://bit.ly/2Jrx93V">EIP-5</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gas Usage for <code>RETURN</code> and <code>CALL*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Christian Reitwiessner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OYbc2t" data-href="http://bit.ly/2OYbc2t">EIP-6</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renaming SUICIDE Opcode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hudson Jameson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2JxdBeN" data-href="http://bit.ly/2JxdBeN">EIP-7</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELEGATECALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Q6Oly6" data-href="http://bit.ly/2Q6Oly6">EIP-8</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devp2p Forward Compatibility Requirements for Homestead</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Felix Lange</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Networking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CUf7WG" data-href="http://bit.ly/2CUf7WG">EIP-20</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC-20 Token Standard. Describes standard functions a token contract may implement to allow DApps and wallets to handle tokens across multiple interfaces/DApps. Methods include: <code>totalSupply</code>, balanceOf(address), <code>transfer</code>, <code>transferFrom</code>, <code>approve</code>, <code>allowance</code>. Events include: <code>Transfer</code> (triggered when tokens are transferred), <span class="keep-together"><code>Approval</code></span> (triggered when <code>approve</code> is called).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fabian Vogelsteller, Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Frontier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Q6R4YB" data-href="http://bit.ly/2Q6R4YB">EIP-55</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mixed-case checksum address encoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OgE5la" data-href="http://bit.ly/2OgE5la">EIP-86</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstraction of transaction origin and signature. Sets the stage for "abstracting out" account security and allowing users to create "account contracts," moving toward a model where in the long term all accounts are contracts that can pay for gas, and users are free to define their own security models that perform any desired signature verification and nonce checks (instead of using the in-protocol mechanism where ECDSA and the default nonce scheme are the only "standard" way to secure an account, which is currently hardcoded into transaction processing).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deferred (to be replaced)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constantinople</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2QedSFC" data-href="http://bit.ly/2QedSFC">EIP-96</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Blockhash and state root changes. Stores blockhashes in the state to reduce protocol complexity and need for complex client implementations to process the <code>BLOCKHASH</code> opcode. Extends range of how far back blockhash checking may go, with the side effect of creating direct links between blocks with very distant block numbers to facilitate much more efficient initial light client syncing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deferred</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constantinople</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2AC05DM" data-href="http://bit.ly/2AC05DM">EIP-100</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Change difficulty adjustment to target mean block time and including uncles.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Jr1zDv" data-href="http://bit.ly/2Jr1zDv">EIP-101</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serenity Currency and Crypto Abstraction. Abstracts ether up a level with the benefit of allowing ether and subtokens to be treated similarly by contracts, reduces the level of indirection required for custom-policy accounts such as multisigs, and purifies the underlying Ethereum protocol by reducing the minimal consensus implementation complexity.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serenity feature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serenity Casper</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Q5sdEv" data-href="http://bit.ly/2Q5sdEv">EIP-105</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary sharding plus contract calling semantics. "Sharding scaffolding" EIP to allow Ethereum transactions to be parallelized using a binary tree sharding mechanism, and to set the stage for a later sharding scheme. Research in progress; see <a href="https://github.com/ethereum/sharding" class="undefined" data-href="https://github.com/ethereum/sharding">https://github.com/ethereum/sharding</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serenity feature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Serenity Casper</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2yG2Dzi" data-href="http://bit.ly/2yG2Dzi">EIP-137</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethereum Domain Name Service - Specification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nick Johnson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2yJtWZm" data-href="http://bit.ly/2yJtWZm">EIP-140</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New Opcode: REVERT. Adds <code>REVERT</code> opcode instruction, which stops execution and rolls back the EVM execution state changes without consuming all provided gas (instead the contract only has to pay for memory) or losing logs, and returns to the caller a pointer to the memory location with the error code or message.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alex Beregszaszi, Nikolai Mushegian</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CQMXfe" data-href="http://bit.ly/2CQMXfe">EIP-141</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Designated invalid EVM instruction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alex Beregszaszi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2qhKz9Y" data-href="http://bit.ly/2qhKz9Y">EIP-145</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise shifting instructions in EVM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alex Beregszaszi, Paweł Bylica</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deferred</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2qhxflQ" data-href="http://bit.ly/2qhxflQ">EIP-150</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gas cost changes for IO-heavy operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CQUgne" data-href="http://bit.ly/2CQUgne">EIP-155</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple replay attack protection. Replay Attack allows any transaction using a pre-EIP-155 Ethereum node or client to become signed so it is valid and executed on both the Ethereum and Ethereum Classic chains.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Homestead</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2JryBmT" data-href="http://bit.ly/2JryBmT">EIP-158</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">State clearing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Superseded</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR6VGY" data-href="http://bit.ly/2CR6VGY">EIP-160</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP cost increase</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OfU96M" data-href="http://bit.ly/2OfU96M">EIP-161</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">State trie clearing (invariant-preserving alternative)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gavin Wood</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2JxdKil" data-href="http://bit.ly/2JxdKil">EIP-162</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initial ENS Hash Registrar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maurelian, Nick Johnson, Alex Van de Sande</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OgsOkO" data-href="http://bit.ly/2OgsOkO">EIP-165</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC-165 Standard Interface Detection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Christian Reitwiessner et al.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OgCWu1" data-href="http://bit.ly/2OgCWu1">EIP-170</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contract code size limit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2ERNv7g" data-href="http://bit.ly/2ERNv7g">EIP-181</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ENS support for reverse resolution of Ethereum addresses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nick Johnson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2P0wPz5" data-href="http://bit.ly/2P0wPz5">EIP-190</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ethereum Smart Contract Packaging Standard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Piper Merriam et al.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2SwNQiz" data-href="http://bit.ly/2SwNQiz">EIP-196</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Precompiled contracts for addition and scalar multiplication on the elliptic curve alt_bn128. Required in order to perform zkSNARK verification within the block gas limit.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Christian Reitwiessner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2ETDC9a" data-href="http://bit.ly/2ETDC9a">EIP-197</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Precompiled contracts for optimal ate pairing check on the elliptic curve alt_bn128. Combined with EIP-196.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin, Christian Reitwiessner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2DdTCRN" data-href="http://bit.ly/2DdTCRN">EIP-198</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Big integer modular exponentiation. Precompile enabling RSA signature verification and other cryptographic applications.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2qjYJr3" data-href="http://bit.ly/2qjYJr3">EIP-211</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New opcodes: <code>RETURNDATASIZE</code> and <code>RETURNDATACOPY</code>. Adds support for returning variable-length values inside the EVM with simple gas charging and minimal change to calling opcodes using new opcodes <code>RETURNDATASIZE</code> and <code>RETURNDATACOPY</code>. Handles similar to existing <code>calldata</code>, whereby after a call, return data is kept inside a virtual buffer from which the caller can copy it (or parts thereof) into memory, and upon the next call, the buffer is overwritten.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Christian Reitwiessner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OgV0Eb" data-href="http://bit.ly/2OgV0Eb">EIP-214</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New opcode: <code>STATICCALL</code>. Permits non-state-changing calls to itself or other contracts while disallowing any modifications to state during the call (and its subcalls, if present) to increase smart contract security and assure developers that re-entrancy bugs cannot arise from the call. Calls the child with <code>STATIC</code> flag set to <code>true</code> for execution of child, causing exception to be thrown upon any attempts to make state-changing operations inside an execution instance where <code>STATIC</code> is <code>true</code>, and resets flag once call returns.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vitalik Buterin, Christian Reitwiessner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2JssHlJ" data-href="http://bit.ly/2JssHlJ">EIP-225</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rinkeby testnet using proof of authority where blocks are only mined by trusted signers.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Péter Szilágyi</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Homestead</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2yPBavd" data-href="http://bit.ly/2yPBavd">EIP-234</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add <code>blockHash</code> to JSON-RPC filter options</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Micah Zoltu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2yKrBNM" data-href="http://bit.ly/2yKrBNM">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subroutines and Static Jumps for the EVM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greg Colvin, Paweł Bylica, Christian Reitwiessner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2AzGX99" data-href="http://bit.ly/2AzGX99">EIP-616</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SIMD Operations for the EVM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greg Colvin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2qjYX1n" data-href="http://bit.ly/2qjYX1n">EIP-681</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL Format for Transaction Requests</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Daniel A. Nagy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2OYgE5n" data-href="http://bit.ly/2OYgE5n">EIP-649</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Difficulty Bomb Delay and Block Reward Reduction. Delayed the Ice Age (aka Difficulty Bomb) by 1 year, and reduced the block reward from 5 to 3 ether.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Afri Schoedon, Vitalik Buterin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2RoGCvH" data-href="http://bit.ly/2RoGCvH">EIP-658</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embedding transaction status code in receipts. Fetches and embeds a status field indicative of success or failure state to transaction receipts for callers, as it&#8217;s no longer possible to assume the transaction failed if and only if it consumed all gas after the introduction of the <code>REVERT</code> opcode in EIP-140.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nick Johnson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Core</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Metropolis Byzantinium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Ogwpzs" data-href="http://bit.ly/2Ogwpzs">EIP-706</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEVp2p snappy compression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Péter Szilágyi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Networking</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Final</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2AAkCIP" data-href="http://bit.ly/2AAkCIP">EIP-721</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC-721 Non-Fungible Token Standard. A standard API that allows smart contracts to operate as unique tradable non-fungible tokens (NFTs) that may be tracked in standardized wallets and traded on exchanges as assets of value, similar to ERC20. CryptoKitties was the first popularly adopted implementation of a digital NFT in the Ethereum ecosystem.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">William Entriken, Dieter Shirley, Jacob Evans, Nastassia Sachs</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Standard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2qmuDmJ" data-href="http://bit.ly/2qmuDmJ">EIP-758</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscriptions and filters for completed transactions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jack Peterson</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2RnqlHy" data-href="http://bit.ly/2RnqlHy">EIP-801</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC-801 Canary Standard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ligi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Interface</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2DdTKkf" data-href="http://bit.ly/2DdTKkf">EIP-827</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC827 Token Standard. An extension of the standard interface ERC20 for tokens with methods that allow the execution of calls inside transfer and approvals. This standard provides basic functionality to transfer tokens, as well as allowing tokens to be approved so they can be spent by another on-chain third party. Also, it allows the developer to execute calls on transfers and approvals.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Augusto Lemble</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2Jq2hAM" data-href="http://bit.ly/2Jq2hAM">EIP-930</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC930 Eternal Storage. The ES (Eternal Storage) contract is owned by an address that has write permissions. The storage is public, which means everyone has read permissions. It stores the data in mappings, using one mapping per type of variable. The use of this contract allows the developer to migrate the storage easily to another contract if needed.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Augusto Lemble</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Draft</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1 data-line-3">
<h2 id="evm_opcodes">Appendix C: Opcodes Ethereum EVM et consommation de gaz</h2>
<div class="sectionbody">
<div class="paragraph data-line-5">
<p>This appendix is based on the consolidation work done by the people of <a href="https://github.com/trailofbits/evm-opcodes" class="undefined" data-href="https://github.com/trailofbits/evm-opcodes">https://github.com/trailofbits/evm-opcodes</a> as a reference for Ethereum VM (EVM) opcodes and instruction information licensed under the <a href="http://bit.ly/2zfrv0b" data-href="http://bit.ly/2zfrv0b">Apache License 2.0</a>.</p>
</div>
<table id="evm_opcodes_table" class="tableblock frame-all grid-all stretch data-line-10">
<caption class="title">Table 11. EVM opcodes and gas cost</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Opcode</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Extra info</th>
<th class="tableblock halign-left valign-top">Gas</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x00</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STOP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Halts execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x01</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Addition operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x02</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MUL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multiplication operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x03</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subtraction operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x04</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DIV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer division operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x05</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SDIV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed integer division operation (truncated)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x06</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modulo remainder operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x07</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed modulo remainder operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x08</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADDMOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modulo addition operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x09</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MULMOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Modulo multiplication operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exponential operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10***</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SIGNEXTEND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extend length of two&#8217;s complement signed integer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x0c</code> - <code>0x0f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less-than comparison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x11</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater-than comparison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SLT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed less-than comparison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x13</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SGT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed greater-than comparison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x14</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EQ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equality comparison</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x15</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ISZERO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple NOT operator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x16</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise AND operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x17</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise OR operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x18</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XOR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise XOR operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x19</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bitwise NOT operation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x1a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BYTE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieve single byte from word</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x1b</code> - <code>0x1f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x20</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHA3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Compute Keccak-256 hash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x21</code> - <code>0x2f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x30</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADDRESS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get address of currently executing account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x31</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BALANCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get balance of the given account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x32</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ORIGIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get execution origination address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x33</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get caller address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x34</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLVALUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get deposited value by the instruction/transaction responsible for this execution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x35</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLDATALOAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get input data of current environment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x36</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLDATASIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get size of input data in current environment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x37</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLDATACOPY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copy input data in current environment to memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x38</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CODESIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get size of code running in current environment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x39</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CODECOPY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copy code running in current environment to memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x3a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GASPRICE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get price of gas in current environment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x3b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXTCODESIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get size of an account&#8217;s code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">700</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x3c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXTCODECOPY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copy an account&#8217;s code to memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">700</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x3d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RETURNDATASIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pushes the size of the return data buffer onto the stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2zaBcNe" data-href="http://bit.ly/2zaBcNe">EIP-211</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x3e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RETURNDATACOPY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copies data from the return data buffer to memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2zaBcNe" data-href="http://bit.ly/2zaBcNe">EIP-211</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x3f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x40</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOCKHASH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the hash of one of the 256 most recent complete blocks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x41</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">COINBASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the block&#8217;s beneficiary address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x42</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the block&#8217;s timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x43</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the block&#8217;s number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x44</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DIFFICULTY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the block&#8217;s difficulty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x45</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GASLIMIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the block&#8217;s gas limit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x46</code> - <code>0x4f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x50</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">POP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Remove word from stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x51</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MLOAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load word from memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x52</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MSTORE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save word to memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x53</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MSTORE8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save byte to memory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x54</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SLOAD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Load word from storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x55</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSTORE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save word to storage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x56</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alter the program counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x57</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMPI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditionally alter the program counter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x58</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GETPC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the value of the program counter prior to the increment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x59</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MSIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the size of active memory in bytes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x5a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GAS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Get the amount of available gas, including the corresponding reduction in the amount of available gas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x5b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMPDEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mark a valid destination for jumps</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x5c</code> - <code>0x5f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x60</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 1-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x61</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 2-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x62</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 3-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x63</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 4-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x64</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 5-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x65</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 6-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x66</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 7-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x67</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 8-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x68</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 9-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x69</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 10-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x6a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 11-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x6b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 12-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x6c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 13-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x6d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 14-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x6e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 15-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x6f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 16-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x70</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 17-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x71</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH18</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 18-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x72</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 19-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x73</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 20-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x74</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH21</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 21-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x75</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH22</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 22-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x76</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH23</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 23-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x77</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 24-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x78</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 25-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x79</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 26-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x7a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 27-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x7b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 28-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x7c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 29-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x7d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH30</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 30-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x7e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 31-byte item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x7f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUSH32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Place 32-byte (full word) item on stack</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x80</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 1st stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x81</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 2nd stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x82</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 3rd stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x83</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 4th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x84</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 5th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x85</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 6th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x86</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 7th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x87</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 8th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x88</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 9th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x89</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 10th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x8a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 11th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x8b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 12th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x8c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 13th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x8d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 14th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x8e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 15th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x8f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DUP16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duplicate 16th stack item</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x90</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 2nd stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x91</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 3rd stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x92</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 4th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x93</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 5th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x94</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 6th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x95</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 7th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x96</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 8th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x97</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 9th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x98</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 10th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x99</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 11th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x9a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 12th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x9b</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 13th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x9c</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 14th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x9d</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 15th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x9e</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 16th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0x9f</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SWAP16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Exchange 1st and 17th stack items</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xa0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Append log record with no topics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">375</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xa1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Append log record with one topic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">750</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xa2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Append log record with two topics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1125</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xa3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Append log record with three topics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1500</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xa4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOG4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Append log record with four topics</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1875</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xa5</code> - <code>0xaf</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMPTO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative <a href="http://bit.ly/2Sx2Vkg" data-href="http://bit.ly/2Sx2Vkg">libevmasm has different numbers</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP 615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMPIF</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMPSUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JUMPSUBV</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BEGINSUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb6</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BEGINDATA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb8</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RETURNSUB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xb9</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PUTLOCAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xba</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">GETLOCA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tentative</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://bit.ly/2CR77pu" data-href="http://bit.ly/2CR77pu">EIP-615</a></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xbb</code> - <code>0xe0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xe1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SLOADBYTES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only referenced in pyethereum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xe2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSTOREBYTES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only referenced in pyethereum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xe3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSIZE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only referenced in pyethereum</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xe4</code> - <code>0xef</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new account with associated code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message-call into an account</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complicated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLCODE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message-call into this account with alternative account&#8217;s code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complicated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RETURN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Halt execution returning output data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DELEGATECALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message-call into this account with an alternative account&#8217;s code, but persisting into this account with an alternative account&#8217;s code</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complicated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf5</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CALLBLACKBOX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xf6</code> - <code>0xf9</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unused</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xfa</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">STATICCALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Similar to CALL, but does not modify state</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">40</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xfb</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new account and set creation address to <code>sha3(sender + sha3(init code)) % 2**160</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xfc</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TXEXECGAS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not in yellow paper FIXME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xfd</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REVERT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stop execution and revert state changes, without consuming all provided gas and providing a reason</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xfe</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVALID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Designated invalid instruction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0xff</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELFDESTRUCT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Halt execution and register account for later deletion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5000*</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1 data-line-3">
<h2 id="dev_tools_frameworks">Appendix D: Outils de développement, cadres de développement, <span class="keep-together">et bibliothèques</span></h2>
<div class="sectionbody">
<div class="sect2 data-line-5">
<h3 id="_frameworks">Frameworks</h3>
<div class="paragraph data-line-7">
<p>Frameworks can be used to ease Ethereum smart contract development. By doing everything yourself you get a better understanding of how everything fits together, but it&#8217;s a lot of tedious, repetitive work. The frameworks described in this section can automate certain tasks and make development easier.</p>
</div>
<div class="sect3 data-line-10">
<h4 id="truffle">Truffle</h4>
<div class="paragraph data-line-12">
<p>GitHub: <a href="https://github.com/trufflesuite/truffle" class="undefined" data-href="https://github.com/trufflesuite/truffle">https://github.com/trufflesuite/truffle</a></p>
</div>
<div class="paragraph data-line-14">
<p>Website: <a href="https://truffleframework.com" class="undefined" data-href="https://truffleframework.com">https://truffleframework.com</a></p>
</div>
<div class="paragraph data-line-16">
<p>Documentation: <a href="https://truffleframework.com/docs" class="undefined" data-href="https://truffleframework.com/docs">https://truffleframework.com/docs</a></p>
</div>
<div class="paragraph data-line-18">
<p>Truffle Boxes: <a href="http://truffleframework.com/boxes/" class="undefined" data-href="http://truffleframework.com/boxes/">http://truffleframework.com/boxes/</a></p>
</div>
<div class="paragraph data-line-20">
<p>npm package repository: <a href="https://www.npmjs.com/package/truffle" class="undefined" data-href="https://www.npmjs.com/package/truffle">https://www.npmjs.com/package/truffle</a></p>
</div>
<div class="sect4 data-line-24">
<h5 id="installing_truffle">Installing the Truffle framework</h5>
<div class="paragraph data-line-26">
<p>The Truffle framework comprises several Node.js packages. Before you install truffle, you need to have an up-to-date and working installation of Node.js and the Node Package Manager (npm).</p>
</div>
<div class="paragraph data-line-28">
<p>The recommended way to install Node.js and npm is to use the Node Version Manager (nvm). Once you install nvm, it will handle all the dependencies and updates for you. Follow the instructions found at <a href="http://nvm.sh" class="undefined" data-href="http://nvm.sh">http://nvm.sh</a>.</p>
</div>
<div class="paragraph data-line-30">
<p>Once nvm is installed on your operating system, installing Node.js is simple. Use the --lts flag to tell nvm that you want the most recent &#x201c;long-term support&#x201d; (LTS) version of Node.js:</p>
</div>
<pre data-type="programlisting">
$ <strong>nvm install --lts</strong>
</pre>
<div class="paragraph data-line-38">
<p>Confirm you have node and npm installed:</p>
</div>
<pre data-type="programlisting">
$ <strong>node -v</strong>
v8.9.4
$ <strong>npm -v</strong>
5.6.0
</pre>
<div class="paragraph data-line-49">
<p>Next, create a hidden file, <em>.nvmrc</em>, that contains the Node.js version supported by your DApp so developers just need to run <code>nvm install</code> in the root of the project directory and it will automatically install and switch to using that version:</p>
</div>
<pre data-type="programlisting">
$ <strong>node -v &gt; .nvmrc</strong>
$ <strong>nvm install</strong>
</pre>
<div class="paragraph data-line-58">
<p>Looking good. Now to install truffle:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm -g install truffle</strong>

+ truffle@4.0.6
installed 1 package in 37.508s
</pre>
</div>
<div class="sect4 data-line-70">
<h5 id="truffle_box">Integrating a prebuilt Truffle project (Truffle Box)</h5>
<div class="paragraph data-line-72">
<p>If you want to use or create a DApp that builds upon prebuilt boilerplate, go to the Truffle Boxes website, choose an existing Truffle project, and then run the following command to download and extract it:</p>
</div>
<pre data-type="programlisting">
$ <strong>truffle unbox <em>BOX_NAME</em></strong>
</pre>
</div>
<div class="sect4 data-line-81">
<h5 id="truffle_project_directory">Creating a truffle project directory</h5>
<div class="paragraph data-line-83">
<p>For each project where you will use truffle, create a project directory and initialize truffle within that directory. truffle will create the necessary directory structure inside your project directory. It&#8217;s customary to give the project directory a name that describes the project. For this example, we will use truffle to deploy our Faucet contract from <a href="#simple_contract_example">[simple_contract_example]</a>, and therefore we will name the project folder <em>Faucet</em>:</p>
</div>
<pre data-type="programlisting">
$ <strong>mkdir Faucet</strong>
$ <strong>cd Faucet</strong>
Faucet $
</pre>
<div class="paragraph data-line-93">
<p>Once inside the <em>Faucet</em> directory, we initialize truffle:</p>
</div>
<pre data-type="programlisting">
Faucet $ <strong>truffle init</strong>
</pre>
<div class="paragraph data-line-101">
<p>truffle creates a directory structure and some default files:</p>
</div>
<div class="listingblock data-line-103">
<div class="content">
<pre>Faucet
+---- contracts
|   `---- Migrations.sol
+---- migrations
|   `---- 1_initial_migration.js
+---- test
+---- truffle-config.js
`---- truffle.js</pre>
</div>
</div>
<div class="paragraph data-line-114">
<p>We will also use a number of JavaScript (Node.js) support packages, in addition to truffle itself. We can install these with npm. We initialize the npm directory structure and accept the defaults suggested by npm:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm init</strong>

package name: (faucet)
version: (1.0.0)
description:
entry point: (truffle-config.js)
test command:
git repository:
keywords:
author:
license: (ISC)
About to write to Faucet/package.json:

{
  "name": "faucet",
  "version": "1.0.0",
  "description": "",
  "main": "truffle-config.js",
  "directories": {
    "test": "test"
  },
  "scripts": {
    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"
  },
  "author": "",
  "license": "ISC"
}


Is this ok? (yes)
</pre>
<div class="paragraph data-line-151">
<p>Now, we can install the dependencies that we will use to make working with truffle easier:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm install dotenv truffle-wallet-provider ethereumjs-wallet</strong>
</pre>
<div class="paragraph data-line-159">
<p>We now have a <em>node_modules</em> directory with several thousand files inside our <em>Faucet</em> directory.</p>
</div>
<div class="paragraph data-line-161">
<p>Prior to deploying a DApp to a cloud production or continuous integration environment, it is important to specify the engines field so that your DApp is built with the correct Node.js version and its associated dependencies are installed. For details on configuring this field, see the <a href="http://bit.ly/2zp2GPF" data-href="http://bit.ly/2zp2GPF">documentation</a>.</p>
</div>
</div>
<div class="sect4 data-line-163">
<h5 id="_configuring_truffle">Configuring truffle</h5>
<div class="paragraph data-line-165">
<p>truffle creates some empty configuration files, <em>truffle.js</em> and <em>truffle-config.js</em>. On Windows systems the <em>truffle.js</em> name may cause a conflict when you try to run the command truffle and Windows attempts to run <em>truffle.js</em> instead. To avoid this, we will delete <em>truffle.js</em> and use <em>truffle-config.js</em> (in support of Windows users, who, honestly, suffer enough already):</p>
</div>
<pre data-type="programlisting">
$ <strong>rm truffle.js</strong>
</pre>
<div class="paragraph data-line-173">
<p>Now we edit <em>truffle-config.js</em> and replace the contents with the sample configuation shown here:</p>
</div>
<div class="listingblock data-line-176">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">module.exports = {
  networks: {
    localnode: { // Whatever network our local node connects to
      network_id: "*", // Match any network ID
      host: "localhost",
      port: 8545,
    }
  }
};</code></pre>
</div>
</div>
<div class="paragraph data-line-188">
<p>This configuration is a good starting point. It sets up one default Ethereum network (named localnode), which assumes we are running an Ethereum client such as Parity, either as a full node or as a light client. This configuration will instruct truffle to communicate with the local node over RPC, on port 8545. truffle will use whatever Ethereum network the local node is connected to, such as the Ethereum main network, or a test network like Ropsten. The local node will also be providing the wallet functionality.</p>
</div>
<div class="paragraph data-line-190">
<p>In following sections, we will configure additional networks for truffle to use, such as the ganache local test blockchain and Infura, a hosted network provider. As we add more networks, the configuration file will get more complex, but it will also give us more options for our testing and development workflow.</p>
</div>
</div>
<div class="sect4 data-line-192">
<h5 id="_using_truffle_to_deploy_a_contract">Using truffle to deploy a contract</h5>
<div class="paragraph data-line-194">
<p>We now have a basic working directory for our <em>Faucet</em> project, and we have truffle and its dependencies configured. Contracts go in the <em>contracts</em> subdirectory of our project. The directory already contains a "helper" contract, <em>Migrations.sol</em>, which manages contract upgrades for us. We&#8217;ll examine the use of <em>Migrations.sol</em> in the next section.</p>
</div>
<div class="paragraph data-line-196">
<p>Let&#8217;s copy the <em>Faucet.sol</em> contract (from <a href="#solidity_faucet_example">Faucet.sol: Un contrat Solidity mettant en place un robinet</a>) into the <em>contracts</em> subdirectory, so that the project directory looks like this:</p>
</div>
<div class="listingblock data-line-198">
<div class="content">
<pre>Faucet
+---- contracts
|   +---- Faucet.sol
|   `---- Migrations.sol
...</pre>
</div>
</div>
<div class="paragraph data-line-206">
<p>We can now ask truffle to compile the contract for us:</p>
</div>
<pre data-type="programlisting">
$ <strong>truffle compile</strong>
Compiling ./contracts/Faucet.sol...
Compiling ./contracts/Migrations.sol...
Writing artifacts to ./build/contracts
</pre>
</div>
<div class="sect4 data-line-218">
<h5 id="truffle_migrations_understanding_deployment_scripts">Truffle migrations&#x2014;understanding deployment scripts</h5>
<div class="paragraph data-line-220">
<p>Truffle offers a deployment system called a <em>migration</em>. If you have worked in other frameworks, you may have seen something similar: Ruby on Rails, Python Django, and many other languages and frameworks have a migrate command.</p>
</div>
<div class="paragraph data-line-222">
<p>In all those frameworks, the purpose of a migration is to handle changes in the data schema between different versions of the software. The purpose of migrations in Ethereum is slightly different. Because Ethereum contracts are immutable and cost gas to deploy, Truffle offers a migration mechanism to keep track of which contracts (and which versions) have already been deployed. In a complex project with dozens of contracts and complex dependencies, you would not want to have to pay to redeploy contracts that haven&#8217;t changed. You would also not want to manually track which versions of which contracts have been deployed already. The Truffle migration mechanism does all that by deploying the smart contract <em>Migrations.sol</em>, which then keeps track of all other contract deployments.</p>
</div>
<div class="paragraph data-line-224">
<p>We have only one contract, <em>Faucet.sol</em>, which means that the migration system is overkill, to say the least. Unfortunately, we have to use it. But, by learning how to use it for one contract, we can start practicing some good habits for our development workflow. The effort will pay off as things get more complicated.</p>
</div>
<div class="paragraph data-line-226">
<p>Truffle&#8217;s <em>migrations</em> directory is where the migration scripts are found. Right now there&#8217;s only one script, <em>1_initial_migration.js</em>, which deploys the <em>Migrations.sol</em> contract itself:</p>
</div>
<div class="listingblock data-line-0">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var Migrations = artifacts.require("./Migrations.sol");

module.exports = function(deployer) {
  deployer.deploy(Migrations);
};</code></pre>
</div>
</div>
<div class="paragraph data-line-234">
<p>We need a second migration script, to deploy <em>Faucet.sol</em>. Let&#8217;s call it <em>2_deploy_contracts.js</em>. It is very simple, just like <em>1_initial_migration.js</em>, with only a few small changes. In fact, you can copy the contents of <em>1_initial_migration.j</em> and simply replace all instances of Migrations with Faucet:</p>
</div>
<div class="listingblock data-line-0">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var Faucet = artifacts.require("./Faucet.sol");

module.exports = function(deployer) {
  deployer.deploy(Faucet);
};</code></pre>
</div>
</div>
<div class="paragraph data-line-241">
<p>The script initializes a variable Faucet, identifying the <em>Faucet.sol</em> Solidity source code as the artifact that defines Faucet. Then it calls the <code>deploy</code> function to deploy this contract.</p>
</div>
<div class="paragraph data-line-243">
<p>We&#8217;re all set. Let&#8217;s use truffle migrate to deploy it on. We have to specify which network to deploy the contract, using the --network argument. We only have one network specified in the configuration file, which we named localnode. Make sure your local Ethereum client is running and then type:</p>
</div>
<pre data-type="programlisting">
Faucet $ <strong>truffle migrate --network localnode</strong>
</pre>
<div class="paragraph data-line-251">
<p>Because we are using a local node to connect to the Ethereum network and manage our wallet, we have to authorize the transaction that truffle creates. We&#8217;re running parity connected to the Ropsten test blockchain, so during the migration we&#8217;ll see a pop-up like the one in <a href="#parity_deployment_confirmation">Parity asking for confirmation to deploy Faucet</a> on Parity&#8217;s web console.</p>
</div>
<div id="parity_deployment_confirmation" class="imageblock data-line-255">
<div class="content">
<img src="images/parity_deployment_confirmation.png" alt="Parity asking for confirmation to deploy Faucet">
</div>
<div class="title">Figure 59. Parity asking for confirmation to deploy Faucet</div>
</div>
<div class="paragraph data-line-257">
<p>There are four transactions in total: one to deploy Migrations, one to update the deployments counter to 1, one to deploy Faucet, and one to update the deployments counter to 2.</p>
</div>
<div class="paragraph data-line-259">
<p>Truffle will show the migrations completing, show each of the transactions, and show the contract addresses:</p>
</div>
<pre data-type="programlisting">
$ <strong>truffle migrate --network localnode</strong>
Using network 'localnode'.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  ... 0xfa090db179d023d2abae543b4a21a1479e70ca7d35a469a5d1a98bfc6bd80fe8
  Migrations: 0x8861c27715550bed8362c0345add158489df6db0
Saving successful migration to network...
  ... 0x985c4a32716826ddbe4eae284104bef8bc69e959899f62246a1b27c9dfcd6c03
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying Faucet...
  ... 0xecdbeef77f0558edc689440e34b7bba0a3ba7a45e4b680b071b47c30a930e9d6
  Faucet: 0xd01cd8e7bd29e4bff8c1693f59eee46137a9f300
Saving successful migration to network...
  ... 0x11f376bd7307edddfd40dc4a14c3f7cb84b6c921ac2465602060b67d08f9fd8a
Saving artifacts...
</pre>
</div>
<div class="sect4 data-line-283">
<h5 id="_using_the_truffle_console">Using the Truffle console</h5>
<div class="paragraph data-line-285">
<p>Truffle offers a JavaScript console that we can use to interact with the Ethereum network (via the local node), interact with deployed contracts, and interact with the wallet provider. In our current configuration (localnode), the node and wallet provider is our local Parity client.</p>
</div>
<div class="paragraph data-line-287">
<p>Let&#8217;s start the Truffle console and try some commands:</p>
</div>
<pre data-type="programlisting">
$ <strong>truffle console --network localnode</strong>
truffle(localnode)>
</pre>
<div class="paragraph data-line-296">
<p>Truffle presents a prompt, showing the selected network configuration (localnode).</p>
</div>
<div class="admonitionblock tip data-line-299">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-300">
<p>It&#8217;s important to remember and be aware of which network you are using. You wouldn&#8217;t want to accidentally deploy a test contract or make a transaction on the Ethereum main network. That could be an expensive mistake!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-303">
<p>The Truffle console offers an autocomplete function that makes it easy for us to explore the environment. If we press Tab after a partially completed command, Truffle will complete the command for us. Pressing Tab twice will show all possible completions if more than one command matches our input. In fact, if we press Tab twice on an empty prompt, Truffle lists all the available commands:</p>
</div>
<pre data-type="programlisting" class="codewrap">
truffle(localnode)&gt;
Array Boolean Date Error EvalError Function Infinity JSON Math NaN Number Object RangeError ReferenceError RegExp String SyntaxError TypeError URIError decodeURI decodeURIComponent encodeURI encodeURIComponent eval isFinite isNaN parseFloat parseInt undefined

ArrayBuffer Buffer DataView Faucet Float32Array Float64Array GLOBAL Int16Array Int32Array Int8Array Intl Map Migrations Promise Proxy Reflect Set StateManager Symbol Uint16Array Uint32Array Uint8Array Uint8ClampedArray WeakMap WeakSet WebAssembly XMLHttpRequest _ assert async_hooks buffer child_process clearImmediate clearInterval clearTimeout cluster console crypto dgram dns domain escape events fs global http http2 https module net os path perf_hooks process punycode querystring readline repl require root setImmediate setInterval setTimeout stream string_decoder tls tty unescape url util v8 vm web3 zlib

__defineGetter__ __defineSetter__ __lookupGetter__ __lookupSetter__ __proto__ constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf
</pre>
<div class="paragraph data-line-316">
<p>The vast majority of the wallet- and node-related functions are provided by the web3 object, which is an instance of the web3.js library. The web3 object abstracts the RPC interface to our Parity node. You will also notice two objects with familiar names: Migrations and Faucet. Those represent the contracts we just deployed. We will use the Truffle console to interact with a contract. First, let&#8217;s check our wallet via the web3 object:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>web3.eth.accounts</strong>
[ '0x9e713963a92c02317a681b9bb3065a8249de124f',
  '0xdb5dc1a13e3a55cf3b4587cd8d1e5fdeb6738145' ]
</pre>
<div class="paragraph data-line-326">
<p>Our Parity client has two wallets, with some test ether on Ropsten. The web3.eth.accounts attribute contains a list of all the accounts. We can check the balance of the first account using the getBalance function:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>web3.eth.getBalance(web3.eth.accounts[0]).toNumber()</strong>
191198572800000000
truffle(localnode)&gt;
</pre>
<div class="paragraph data-line-336">
<p>web3.js is a large JavaScript library that offers a comprehensive interface to the Ethereum system, via a provider such as a local client. We will examine web3.js in more detail in <a href="#web3js_tutorial">Tutoriel web3.js</a>. Now let&#8217;s try to interact with our contracts:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>Faucet.address</strong>
'0xd01cd8e7bd29e4bff8c1693f59eee46137a9f300'
truffle(localnode)&gt; <strong>web3.eth.getBalance(Faucet.address).toNumber()</strong>
0
truffle(localnode)&gt;
</pre>
<div class="paragraph data-line-348">
<p>Next, we&#8217;ll use sendTransaction to send some test ether to fund the Faucet contract. Note the use of web3.utils.toWei to convert ether units for us. Typing 18 zeros without making a mistake is both difficult and dangerous, so it&#8217;s always better to use a unit converter for values. Here&#8217;s how we send the transaction:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>web3.eth.sendTransaction({from:web3.eth.accounts[0],
                    to:Faucet.address, value:web3.utils.toWei(0.5, 'ether')});</strong>
'0xf134c75b985dc0e0c27c2f0412251e0860eb530a5055e660f21e7483ab336808'
</pre>
<div class="paragraph data-line-358">
<p>If we switch to the Parity web interface, we&#8217;ll see a pop-up asking us to confirm this transaction. Once the transaction is mined, we&#8217;ll be able to see the balance of our Faucet contract:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>web3.eth.getBalance(Faucet.address).toNumber()</strong>
500000000000000000
</pre>
<div class="paragraph data-line-367">
<p>Let&#8217;s call the withdraw function now, to withdraw some test ether from the contract:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>Faucet.deployed().then(instance =>
                       {instance.withdraw(web3.utils.toWei(0.1,
                       'ether'))}).then(console.log)</strong>
</pre>
<div class="paragraph data-line-377">
<p>Again, we&#8217;ll need to approve the transaction in the Parity web interface. If we check again we&#8217;ll see that the balance of the Faucet contract has decreased, and our test wallet has received 0.1 ether:</p>
</div>
<pre data-type="programlisting">
truffle(localnode)&gt; <strong>web3.eth.getBalance(Faucet.address).toNumber()</strong>
400000000000000000
truffle(localnode)&gt; <strong>Faucet.deployed().then(instance =>
                    {instance.withdraw(web3.utils.toWei(1, 'ether'))})</strong>
StatusError: Transaction: 0xe147ae9e3610334...8612b92d3f9c
  exited with an error (status 0).
</pre>
</div>
</div>
<div class="sect3 data-line-390">
<h4 id="_embark">Embark</h4>
<div class="paragraph data-line-392">
<p>GitHub: <a href="https://github.com/embark-framework/embark/" class="undefined" data-href="https://github.com/embark-framework/embark/">https://github.com/embark-framework/embark/</a></p>
</div>
<div class="paragraph data-line-394">
<p>Documentation: <a href="https://embark.status.im/docs/" class="undefined" data-href="https://embark.status.im/docs/">https://embark.status.im/docs/</a></p>
</div>
<div class="paragraph data-line-396">
<p>npm package repository: <a href="https://www.npmjs.com/package/embark" class="undefined" data-href="https://www.npmjs.com/package/embark">https://www.npmjs.com/package/embark</a></p>
</div>
<div class="paragraph data-line-398">
<p>Embark is a framework built to allow developers to easily develop and deploy decentralized applications.
Embark integrates with Ethereum, IPFS, Whisper, and Swarm to offer the following features:</p>
</div>
<div class="ulist data-line-401">
<ul>
<li class="data-line-401">
<p>Automatically deploy contracts and make them available in JS code.</p>
</li>
<li class="data-line-402">
<p>Watch for changes and update contracts to redeploy if needed.</p>
</li>
<li class="data-line-403">
<p>Manage and interact with different chains (e.g., testnet, local, mainnet).</p>
</li>
<li class="data-line-404">
<p>Manage complex systems of interdependent contracts.</p>
</li>
<li class="data-line-405">
<p>Store and retrieve data, including uploading and retrieving files hosted in IPFS.</p>
</li>
<li class="data-line-406">
<p>Ease the process of deploying the full application to IPFS or Swarm.</p>
</li>
<li class="data-line-407">
<p>Send and receive messages through Whisper.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-409">
<p>You can install it with npm:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm -g install embark</strong>
</pre>
</div>
<div class="sect3 pagebreak-before data-line-418">
<h4 id="_openzeppelin">OpenZeppelin</h4>
<div class="paragraph data-line-420">
<p>GitHub: <a href="https://github.com/OpenZeppelin/openzeppelin-solidity" class="undefined" data-href="https://github.com/OpenZeppelin/openzeppelin-solidity">https://github.com/OpenZeppelin/openzeppelin-solidity</a></p>
</div>
<div class="paragraph data-line-422">
<p>Website: <a href="https://openzeppelin.org/" class="undefined" data-href="https://openzeppelin.org/">https://openzeppelin.org/</a></p>
</div>
<div class="paragraph data-line-424">
<p>Documentation: <a href="https://openzeppelin.org/api/docs/open-zeppelin.html" class="undefined" data-href="https://openzeppelin.org/api/docs/open-zeppelin.html">https://openzeppelin.org/api/docs/open-zeppelin.html</a></p>
</div>
<div class="paragraph data-line-426">
<p><a href="https://openzeppelin.org/" data-href="https://openzeppelin.org/">OpenZeppelin</a> is an open framework of reusable and secure smart contracts in the Solidity language.</p>
</div>
<div class="paragraph data-line-428">
<p>It is community-driven, led by the <a href="https://zeppelin.solutions/" data-href="https://zeppelin.solutions/">Zeppelin</a> team, with over a hundred external contributors. The main focus of the framework is security, achieved by applying industry-standard contract security patterns and best practices, drawing on all the experience the Zeppelin devs have gained from <a href="https://blog.zeppelin.solutions/tagged/security" data-href="https://blog.zeppelin.solutions/tagged/security">auditing</a> a huge number of contracts, and through constant testing and auditing from the community that uses the framework as a base for their real-world applications.</p>
</div>
<div class="paragraph data-line-430">
<p>The OpenZeppelin framework is the most widely used solution for Ethereum smart contracts. The framework currently has an ample library of contracts including implementations of ERC20 and ERC721 tokens, many flavors of crowdsale models, and simple behaviors commonly found in contracts such as <code>Ownable</code>, <code>Pausable</code>, or <code>LimitBalance</code>. The contracts in this repository in some cases function as <em>de facto</em> standard implementations.</p>
</div>
<div class="paragraph data-line-432">
<p>The framework is licensed under an MIT license, and all the contracts have been designed with a modular approach to guarantee ease of reuse and extension. These are clean and basic building blocks, ready to be used in your next Ethereum project. Let&#8217;s set up the framework and build a simple crowdsale using the OpenZeppelin contracts, to demonstrate how easy it is to use. This example also stresses the importance of reusing secure components instead of writing them by yourself.</p>
</div>
<div class="paragraph data-line-434">
<p>First, we will need to install the openzeppelin-solidity library into our workspace. The latest release as of the time of this writing is v1.9.0, so we will use that one:</p>
</div>
<pre data-type="programlisting">
$ <strong>mkdir sample-crowdsale</strong>
$ <strong>cd sample-crowdsale</strong>
$ <strong>npm install openzeppelin-solidity@1.9.0</strong>
$ <strong>mkdir contracts</strong>
</pre>
<div class="paragraph data-line-445">
<p>At the time of writing, OpenZeppelin includes multiple basic token contracts that follow the ERC20, ERC721, and ERC827 standards, with different characteristics for emission, limits, vesting, life cycle, etc.</p>
</div>
<div class="paragraph data-line-447">
<p>Let&#8217;s make an ERC20 token that&#8217;s mintable, meaning that the initial supply starts at 0 and new tokens can be created by the token owner (in our case, the crowdsale <span class="keep-together">contract</span>) and sold to buyers. In order to do this, we&#8217;ll create a <em>contracts/SampleToken.sol</em> file with the following contents:</p>
</div>
<div class="listingblock data-line-0">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity 0.4.23;

import 'openzeppelin-solidity/contracts/token/ERC20/MintableToken.sol';

contract SampleToken is MintableToken {
  string public name = "SAMPLE TOKEN";
  string public symbol = "SAM";
  uint8 public decimals = 18;
}</code></pre>
</div>
</div>
<div class="paragraph data-line-454">
<p>OpenZeppelin already provides a MintableToken contract that we can use as a base for our token, so we only define the details that are specific to our case. Next, let&#8217;s make the crowdsale contract. Just like with tokens, OpenZeppelin already provides a wide variety of crowdsale flavors. Currently, you will find contracts for various scenarios involving distribution, emission, price, and validation. So, let’s say that you want to set a goal for your crowdsale and if it’s not met by the time the sale finishes, you want to refund all your investors. For that, you can use the <a href="http://bit.ly/2yHoh65" data-href="http://bit.ly/2yHoh65">RefundableCrowdsale</a> contract. Or maybe you want to define a crowdsale with an increasing price to incentivize early buyers; there is an <a href="http://bit.ly/2PtWOys" data-href="http://bit.ly/2PtWOys">IncreasingPriceCrowdsale</a> contract just for that. You can also end the crowdsale when a specified amount of ether has been received by the contract (<a href="http://bit.ly/2OVsCN8" data-href="http://bit.ly/2OVsCN8">CappedCrowdsale</a>), or set a finishing time with the <a href="http://bit.ly/2zp2Nuz" data-href="http://bit.ly/2zp2Nuz">TimedCrowdsale</a> contract, or create a whitelist of buyers with the <a href="http://bit.ly/2CN8Hc9" data-href="http://bit.ly/2CN8Hc9">WhitelistedCrowdsale</a> contract.</p>
</div>
<div class="paragraph data-line-456">
<p>As we said before, the OpenZeppelin contracts are basic building blocks. These crowdsale contracts have been designed to be combined; just read the source code of the base <a href="http://bit.ly/2ABIQSI" data-href="http://bit.ly/2ABIQSI">Crowdsale</a> contract for directions on how to extend it. For the crowdsale of our token, we need to mint tokens when ether is received by the crowdsale contract, so let&#8217;s use <a href="http://bit.ly/2Sx3HOc" data-href="http://bit.ly/2Sx3HOc">MintedCrowdsale</a> as a base. And to make it more interesting, let&#8217;s also make it a <a href="http://bit.ly/2Qef0Jm" data-href="http://bit.ly/2Qef0Jm">PostDeliveryCrowdsale</a> so the tokens can only be withdrawn after the crowdsale ends. To do this, we&#8217;ll write the following into <em>contracts/SampleCrowdsale.sol</em>:</p>
</div>
<div class="listingblock data-line-0">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity 0.4.23;

import './SampleToken.sol';
import 'openzeppelin-solidity/contracts/crowdsale/emission/MintedCrowdsale.sol';
import 'openzeppelin-solidity/contracts/crowdsale/ \
  distribution/PostDeliveryCrowdsale.sol';

contract SampleCrowdsale is PostDeliveryCrowdsale, MintedCrowdsale {

  constructor(
    uint256 _openingTime,
    uint256 _closingTime
    uint256 _rate,
    address _wallet,
    MintableToken _token
  )
    public
    Crowdsale(_rate, _wallet, _token)
    PostDeliveryCrowdsale(_openingTime, _closingTime)
  {
  }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-463">
<p>Again, we barely had to write any code; we just reused the battle-tested code that the OpenZeppelin community made available. However, it is important to note that this case is different than that of our <code>SampleToken</code> contract. If you go to the <a href="http://bit.ly/2Q8lQ3o" data-href="http://bit.ly/2Q8lQ3o">Crowdsale automated tests</a> you will see that they are tested in isolation. When you integrate different units of code into a bigger component, it&#8217;s not enough to test all the units separately, because the interactions between them might cause behaviors that you didn&#8217;t expect. In particular, you will see that here we introduced multiple inheritance, which can surprise the developer if they don&#8217;t understand the details of Solidity. Our <span class="keep-together"><code>SampleCrowdsale</code></span> contract is simple, and it will work just as we expect because the framework was designed to make cases like these straightforward; but do not relax your vigilance because of the simplicity that this framework introduces. Every time you integrate parts of the OpenZeppelin framework to build a more complex solution, you must fully test every aspect of your solution to ensure that all the interactions of the units work as you intend.</p>
</div>
<div class="paragraph data-line-465">
<p>Finally, when we are happy with our solution and have tested it thoroughly, we need to deploy it. OpenZeppelin integrates well with Truffle, so we can just write a migrations file like the following (<em>migrations/2_deploy_contracts.js</em>), as explained in <a href="#truffle_migrations_understanding_deployment_scripts">Truffle migrations&#x2014;understanding deployment scripts</a>:</p>
</div>
<div class="listingblock data-line-0">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">const SampleCrowdsale = artifacts.require('./SampleCrowdsale.sol');
const SampleToken = artifacts.require('./SampleToken.sol');

module.exports = function(deployer, network, accounts) {
  const openingTime = web3.eth.getBlock('latest').timestamp + 2; // 2s in future
  const closingTime = openingTime + 86400 * 20; // 20 days
  const rate = new web3.BigNumber(1000);
  const wallet = accounts[1];

  return deployer
    .then(() =&gt; {
      return deployer.deploy(SampleToken);
    })
    .then(() =&gt; {
      return deployer.deploy(
        SampleCrowdsale,
        openingTime,
        closingTime,
        rate,
        wallet,
        SampleToken.address
      );
    });
};</code></pre>
</div>
</div>
<div class="admonitionblock note data-line-473">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-474">
<p>This was just a quick overview of a few of the contracts that are part of the OpenZeppelin framework. You are welcome to join the OpenZeppelin development community to learn and contribute.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3 data-line-477">
<h4 id="_zeppelinos">ZeppelinOS</h4>
<div class="paragraph data-line-479">
<p>GitHhub: <a href="https://github.com/zeppelinos" class="undefined" data-href="https://github.com/zeppelinos">https://github.com/zeppelinos</a></p>
</div>
<div class="paragraph data-line-481">
<p>Website: <a href="https://zeppelinos.org" class="undefined" data-href="https://zeppelinos.org">https://zeppelinos.org</a></p>
</div>
<div class="paragraph data-line-483">
<p>Blog: <a href="https://blog.zeppelinos.org" class="undefined" data-href="https://blog.zeppelinos.org">https://blog.zeppelinos.org</a></p>
</div>
<div class="paragraph data-line-485">
<p><a href="https://github.com/zeppelinos" data-href="https://github.com/zeppelinos">ZeppelinOS</a> is &#x201c;an open source, distributed platform of tools and services on top of the EVM
to develop and manage smart contract applications securely.&#x201d;</p>
</div>
<div class="paragraph data-line-488">
<p>Unlike OpenZeppelin&#8217;s code, which needs to be redeployed with each application every time it&#8217;s used, ZeppelinOS&#8217;s code lives on-chain. Applications that need a given functionality&#x2014;say, an ERC20 token&#x2014;not only do not have to redesign and reaudit its implementation (something that OpenZeppelin solved) but do not even need to deploy it. With ZeppelinOS, an application interacts with the token&#8217;s on-chain implementation directly, in much the same way as a desktop application interacts with the components of its underlying OS.</p>
</div>
<div class="paragraph data-line-490">
<p>At the core of ZeppelinOS sits a very clever contract known as a <em>proxy</em>. A proxy is a contract that is capable of wrapping any other contract, exposing its interface without having to manually implement setters and getters for it, and can upgrade it without losing state. In Solidity terms, it can be seen as a normal contract whose business logic is contained within a library, which can be swapped for a new library at any time without losing its state. The way in which the proxy links to its implementation is completely automated and encapsulated for the developer. Practically any contract can be made upgradeable with little to no change in its code. More about ZeppelinOS&#8217;s proxy mechanism can be found in the  <a href="http://bit.ly/2OfuNpu" data-href="http://bit.ly/2OfuNpu">blog</a>, and an example of how to use it can be found <a href="http://bit.ly/2OfuE5q" data-href="http://bit.ly/2OfuE5q">on GitHub</a>.</p>
</div>
<div class="paragraph data-line-492">
<p>Developing applications using ZeppelinOS is similar to developing JavaScript applications using npm. An AppManager handles an application package for each version of the application. A package is simply a directory of contracts, each of which can have one or more upgradeable proxies. The AppManager not only provides proxies for application-specific contracts, but also does so for ZeppelinOS implementations, in the form of a standard library. To see a full example of this, please visit <a href="http://bit.ly/2PtyJb3" data-href="http://bit.ly/2PtyJb3">examples/complex</a>.</p>
</div>
<div class="paragraph data-line-494">
<p>Although currently in development, ZeppelinOS aims to provide a wide set of additional features, such as developer tools, a scheduler that automates background operations within contracts, development bounties, a marketplace that facilitates communication and exchange of value between applications, and much more. All of this is described in ZeppelinOS&#8217;s <a href="http://bit.ly/2QcxV7K" data-href="http://bit.ly/2QcxV7K">whitepaper</a>.</p>
</div>
</div>
</div>
<div class="sect2 data-line-499">
<h3 id="_utilities">Utilities</h3>
<div class="sect3 data-line-501">
<h4 id="_ethereumjs_helpeth_a_command_line_utility">EthereumJS helpeth: A Command-Line Utility</h4>
<div class="paragraph data-line-503">
<p>GitHub: <a href="https://github.com/ethereumjs/helpeth" class="undefined" data-href="https://github.com/ethereumjs/helpeth">https://github.com/ethereumjs/helpeth</a></p>
</div>
<div class="paragraph data-line-505">
<p>helpeth is a command-line tool for key and transaction manipulation that makes a developer&#8217;s job a lot easier.</p>
</div>
<div class="paragraph data-line-507">
<p>It is part of the EthereumJS collection of JavaScript-based libraries and tools:</p>
</div>
<div class="listingblock data-line-511">
<div class="content">
<pre>Usage: helpeth [command]

Commands:
  signMessage &lt;message&gt;                     Sign a message
  verifySig &lt;hash&gt; &lt;sig&gt;                    Verify signature
  verifySigParams &lt;hash&gt; &lt;r&gt; &lt;s&gt; &lt;v&gt;        Verify signature parameters
  createTx &lt;nonce&gt; &lt;to&gt; &lt;value&gt; &lt;data&gt;      Sign a transaction
  &lt;gasLimit&gt; &lt;gasPrice&gt;
  assembleTx &lt;nonce&gt; &lt;to&gt; &lt;value&gt; &lt;data&gt;    Assemble a transaction from its
  &lt;gasLimit&gt; &lt;gasPrice&gt; &lt;v&gt; &lt;r&gt; &lt;s&gt;         components
  parseTx &lt;tx&gt;                              Parse raw transaction
  keyGenerate [format] [icapdirect]         Generate new key
  keyConvert                                Convert a key to V3 keystore format
  keyDetails                                Print key details
  bip32Details &lt;path&gt;                       Print key details for a given path
  addressDetails &lt;address&gt;                  Print details about an address
  unitConvert &lt;value&gt; &lt;from&gt; &lt;to&gt;           Convert between Ethereum units

Options:
  -p, --private      Private key as a hex string                        [string]
  --password         Password for the private key                       [string]
  --password-prompt  Prompt for the private key password               [boolean]
  -k, --keyfile      Encoded key file                                   [string]
  --show-private     Show private key details                          [boolean]
  --mnemonic         Mnemonic for HD key derivation                     [string]
  --version          Show version number                               [boolean]
  --help             Show help                                         [boolean]</pre>
</div>
</div>
</div>
<div class="sect3 data-line-541">
<h4 id="_dapp_tools">dapp.tools</h4>
<div class="paragraph data-line-543">
<p>Website: <a href="https://dapp.tools/" class="undefined" data-href="https://dapp.tools/">https://dapp.tools/</a></p>
</div>
<div class="paragraph data-line-545">
<p>dapp.tools is a comprehensive suite of blockchain-oriented developer tools created in the spirit of the Unix philosophy. The tools included are:</p>
</div>
<div class="dlist data-line-548">
<dl>
<dt class="hdlist1">Dapp</dt>
<dd>
<p>Dapp is the basic user-facing tool, for creating new DApps, running Solidity unit tests, debugging and deploying contracts, launching testnets, and more.</p>
</dd>
<dt class="hdlist1">Seth</dt>
<dd>
<p>Seth is used for composing transactions, querying the blockchain, converting between data formats, performing remote calls, and similar everyday tasks.</p>
</dd>
<dt class="hdlist1">Hevm</dt>
<dd>
<p>Hevm is a Haskell EVM implementation with a nimble terminal-based Solidity debugger. It’s used to test and debug DApps.</p>
</dd>
<dt class="hdlist1">evmdis</dt>
<dd>
<p>evmdis is an EVM disassembler; it performs static analysis on the bytecode to provide a higher level of abstraction than raw EVM operations.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-561">
<h4 id="_sputnikvm">SputnikVM</h4>
<div class="paragraph data-line-563">
<p><a href="https://github.com/etcdevteam/sputnikvm" data-href="https://github.com/etcdevteam/sputnikvm">SputnikVM</a> is a standalone pluggable virtual machine for different Ethereum-based blockchains. It&#8217;s written in Rust and can be used as a binary, cargo crate, or shared library, or integrated through FFI, Protobuf, and JSON interfaces. It has a separate binary, sputnikvm-dev, intended for testing purposes, which emulates most of the JSON-RPC API and block mining.</p>
</div>
</div>
</div>
<div class="sect2 data-line-565">
<h3 id="_libraries">Libraries</h3>
<div class="sect3 data-line-567">
<h4 id="_web3_js">web3.js</h4>
<div class="paragraph data-line-569">
<p>web3.js is the Ethereum-compatible JavaScript API for communicating with clients via JSON-RPC, developed by the Ethereum Foundation.</p>
</div>
<div class="paragraph data-line-571">
<p>GitHub: <a href="https://github.com/ethereum/web3.js" class="undefined" data-href="https://github.com/ethereum/web3.js">https://github.com/ethereum/web3.js</a></p>
</div>
<div class="paragraph data-line-573">
<p>npm package repository: <a href="https://www.npmjs.com/package/web3" class="undefined" data-href="https://www.npmjs.com/package/web3">https://www.npmjs.com/package/web3</a></p>
</div>
<div class="paragraph data-line-575">
<p>Documentation for web3.js API 0.2x.x: <a href="http://bit.ly/2Qcyq1C" class="undefined" data-href="http://bit.ly/2Qcyq1C">http://bit.ly/2Qcyq1C</a></p>
</div>
<div class="paragraph data-line-577">
<p>Documentation for web3.js API 1.0.0-beta.xx: <a href="http://bit.ly/2CT33p0" class="undefined" data-href="http://bit.ly/2CT33p0">http://bit.ly/2CT33p0</a></p>
</div>
</div>
<div class="sect3 pagebreak-before data-line-580">
<h4 id="_web3_py">web3.py</h4>
<div class="paragraph data-line-582">
<p>web3.py is a Python library for interacting with the Ethereum blockchain, maintained by the Ethereum Foundation.</p>
</div>
<div class="paragraph data-line-584">
<p>GitHub: <a href="https://github.com/ethereum/web3.py" class="undefined" data-href="https://github.com/ethereum/web3.py">https://github.com/ethereum/web3.py</a></p>
</div>
<div class="paragraph data-line-586">
<p>PyPi: <a href="https://pypi.python.org/pypi/web3/4.0.0b9" class="undefined" data-href="https://pypi.python.org/pypi/web3/4.0.0b9">https://pypi.python.org/pypi/web3/4.0.0b9</a></p>
</div>
<div class="paragraph data-line-588">
<p>Documentation: <a href="https://web3py.readthedocs.io/" class="undefined" data-href="https://web3py.readthedocs.io/">https://web3py.readthedocs.io/</a></p>
</div>
</div>
<div class="sect3 data-line-590">
<h4 id="_ethereumjs">EthereumJS</h4>
<div class="paragraph data-line-592">
<p>EthereumJS is collection of libraries and utilities for Ethereum.</p>
</div>
<div class="paragraph data-line-594">
<p>GitHub: <a href="https://github.com/ethereumjs" class="undefined" data-href="https://github.com/ethereumjs">https://github.com/ethereumjs</a></p>
</div>
<div class="paragraph data-line-596">
<p>Website: <a href="https://ethereumjs.github.io/" class="undefined" data-href="https://ethereumjs.github.io/">https://ethereumjs.github.io/</a></p>
</div>
</div>
<div class="sect3 data-line-598">
<h4 id="_web3j">web3j</h4>
<div class="paragraph data-line-600">
<p>web3j is a Java and Android library for integrating with Ethereum clients and working with smart contracts.</p>
</div>
<div class="paragraph data-line-602">
<p>GitHub: <a href="https://github.com/web3j/web3j" class="undefined" data-href="https://github.com/web3j/web3j">https://github.com/web3j/web3j</a></p>
</div>
<div class="paragraph data-line-604">
<p>Website: <a href="https://web3j.io" class="undefined" data-href="https://web3j.io">https://web3j.io</a></p>
</div>
<div class="paragraph data-line-606">
<p>Documentation: <a href="https://docs.web3j.io" class="undefined" data-href="https://docs.web3j.io">https://docs.web3j.io</a></p>
</div>
</div>
<div class="sect3 data-line-608">
<h4 id="_etherjar">EtherJar</h4>
<div class="paragraph data-line-610">
<p>EtherJar is another Java library for integrating with Ethereum and working with smart contracts. It&#8217;s designed for server-side projects based on Java 8+ and provides low-level access and a high-level wrapper around RPC, Ethereum data structures, and smart contract access.</p>
</div>
<div class="paragraph data-line-612">
<p>GitHub: <a href="https://github.com/infinitape/etherjar" class="undefined" data-href="https://github.com/infinitape/etherjar">https://github.com/infinitape/etherjar</a></p>
</div>
</div>
<div class="sect3 data-line-614">
<h4 id="_nethereum">Nethereum</h4>
<div class="paragraph data-line-616">
<p>Nethereum is the .Net integration library for Ethereum.</p>
</div>
<div class="paragraph data-line-618">
<p>GitHub: <a href="https://github.com/Nethereum/Nethereum" class="undefined" data-href="https://github.com/Nethereum/Nethereum">https://github.com/Nethereum/Nethereum</a></p>
</div>
<div class="paragraph data-line-620">
<p>Website: <a href="http://nethereum.com/" class="undefined" data-href="http://nethereum.com/">http://nethereum.com/</a></p>
</div>
<div class="paragraph data-line-622">
<p>Documentation: <a href="https://nethereum.readthedocs.io/en/latest/" class="undefined" data-href="https://nethereum.readthedocs.io/en/latest/">https://nethereum.readthedocs.io/en/latest/</a></p>
</div>
</div>
<div class="sect3 data-line-624">
<h4 id="_ethers_js">ethers.js</h4>
<div class="paragraph data-line-626">
<p>The ethers.js library is a compact, complete, full-featured, extensively tested MIT-licensed Ethereum library, which has received a DevEx grant from the Ethereum Foundation toward its extension and maintenance.</p>
</div>
<div class="paragraph data-line-628">
<p>GitHub link: <a href="https://github.com/ethers-io/ethers.js" class="undefined" data-href="https://github.com/ethers-io/ethers.js">https://github.com/ethers-io/ethers.js</a></p>
</div>
<div class="paragraph data-line-630">
<p>Documentation: <a href="https://docs.ethers.io" class="undefined" data-href="https://docs.ethers.io">https://docs.ethers.io</a></p>
</div>
</div>
<div class="sect3 data-line-633">
<h4 id="_emerald_platform">Emerald Platform</h4>
<div class="paragraph data-line-635">
<p>Emerald Platform provides libraries and UI components to build DApps on top of Ethereum. Emerald JS and Emerald JS UI provide sets of modules and React components to build JavaScript applications and websites; Emerald SVG Icons is a set of blockchain-related icons. In addition to JavaScript libraries Emerald has a Rust library to operate private keys and transaction signatures. All Emerald libraries and components are licensed under the Apache License, version 2.0.</p>
</div>
<div class="paragraph data-line-637">
<p>GitHub: <a href="https://github.com/etcdevteam/emerald-platform" class="undefined" data-href="https://github.com/etcdevteam/emerald-platform">https://github.com/etcdevteam/emerald-platform</a></p>
</div>
<div class="paragraph data-line-639">
<p>Documentation: <a href="https://docs.etcdevteam.com" class="undefined" data-href="https://docs.etcdevteam.com">https://docs.etcdevteam.com</a></p>
</div>
</div>
</div>
<div class="sect2 data-line-642">
<h3 id="testing_frameworks">Testing Smart Contracts</h3>
<div class="paragraph data-line-644">
<p>There are several commonly used test frameworks for smart contract development, summarized in <a href="#testing_frameworks_table">Smart contract test frameworks summary</a>:</p>
</div>
<table id="testing_frameworks_table" class="tableblock frame-all grid-all stretch data-line-649">
<caption class="title">Table 12. Smart contract test frameworks summary</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Framework</th>
<th class="tableblock halign-left valign-top">Test language(s)</th>
<th class="tableblock halign-left valign-top">Testing framework</th>
<th class="tableblock halign-left valign-top">Chain emulator</th>
<th class="tableblock halign-left valign-top">Website</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Truffle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaScript/Solidity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mocha</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TestRPC/Ganache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://truffleframework.com/" class="undefined" data-href="https://truffleframework.com/">https://truffleframework.com/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Embark</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JavaScript</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mocha</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TestRPC/Ganache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://embark.status.im/docs/" class="undefined" data-href="https://embark.status.im/docs/">https://embark.status.im/docs/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dapp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Solidity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ds-test (custom)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ethrun (Parity)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://dapp.tools/dapp/" class="undefined" data-href="https://dapp.tools/dapp/">https://dapp.tools/dapp/</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Populus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Python</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pytest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Python chain emulator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://populus.readthedocs.io" class="undefined" data-href="https://populus.readthedocs.io">https://populus.readthedocs.io</a></p></td>
</tr>
</tbody>
</table>
<div class="dlist data-line-658">
<dl>
<dt class="hdlist1">Truffle</dt>
<dd>
<p>Truffle allows for unit tests to be written in JavaScript (Mocha-based) or Solidity. These tests are run against Ganache.</p>
</dd>
<dt class="hdlist1">Embark</dt>
<dd>
<p>Embark integrates with Mocha to run unit tests written in JavaScript. The tests are in turn run against contracts deployed on TestRPC/Ganache. The Embark framework automatically deploys smart contracts, and will automatically redeploy the contracts when they are changed. It also keeps track of deployed contracts and deploys contracts only when truly needed. Embark includes a testing library to rapidly run and test your contracts in an EVM, with functions like assert.equal. The command embark test will run any test files under the directory <em>test</em>.</p>
</dd>
<dt class="hdlist1">Dapp</dt>
<dd>
<p>Dapp uses native Solidity code (a library called ds-test) and a Parity-built Rust library called ethrun to execute Ethereum bytecode and then assert correctness. The ds-test library provides assertion functions for validating correctness and events for logging data in the console.</p>
<div class="paragraph data-line-664">
<p>The assertion functions include:</p>
</div>
<div class="listingblock data-line-666">
<div class="content">
<pre>assert(bool condition)
assertEq(address a, address b)
assertEq(bytes32 a, bytes32 b)
assertEq(int a, int b)
assertEq(uint a, uint b)
assertEq0(bytes a, bytes b)
expectEventsExact(address target)</pre>
</div>
</div>
<div class="paragraph data-line-676">
<p>The logging commands will log information to the console, making them useful for debugging:</p>
</div>
<div class="listingblock data-line-678">
<div class="content">
<pre>logs(bytes)
log_bytes32(bytes32)
log_named_bytes32(bytes32 key, bytes32 val)
log_named_address(bytes32 key, address val)
log_named_int(bytes32 key, int val)
log_named_uint(bytes32 key, uint val)
log_named_decimal_int(bytes32 key, int val, uint decimals)
log_named_decimal_uint(bytes32 key, uint val, uint decimals)</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Populus</dt>
<dd>
<p>Populus uses Python and its own chain emulator to run contracts written in Solidity. Unit tests are written in Python with the pytest library. Populus supports writing contracts specifically for testing. These contract filenames should match the glob pattern <em>Test*.sol</em> and be located anywhere under the project tests directory, <em>tests</em>.</p>
</dd>
</dl>
</div>
<div class="sect3 data-line-693">
<h4 id="on_blockchain_testing_sec">On-Blockchain Testing</h4>
<div class="paragraph data-line-695">
<p>Although most testing shouldn&#8217;t occur on deployed contracts, a contract&#8217;s behavior can be checked via Ethereum clients.  The following commands can be used to assess a smart contract&#8217;s state. These commands should be typed at the geth terminal, although any web3 console will also support them.</p>
</div>
<div class="paragraph data-line-697">
<p>To get the address of a contract at <em>txhash</em>, use:</p>
</div>
<pre data-type="programlisting">
web3.eth.getTransactionReceipt(<em>txhash</em>);
</pre>
<div class="paragraph data-line-706">
<p>This command gets the code of a contract deployed at <em>contractaddress</em>; this can be used to verify proper deployment:</p>
</div>
<pre data-type="programlisting">
web3.eth.getCode(<em>contractaddress</em>)
</pre>
<div class="paragraph data-line-714">
<p>This gets the full logs of the contract located at the address specified in <em>options</em>, which is helpful for viewing the history of a contract&#8217;s calls:</p>
</div>
<pre data-type="programlisting">
web3.eth.getPastLogs(<em>options</em>)
</pre>
<div class="paragraph data-line-722">
<p>Finally, this command gets the storage located at <em>address</em> with an offset of <em>position</em>:</p>
</div>
<pre data-type="programlisting">
web3.eth.getStorageAt(<em>address</em>, <em>position</em>)
</pre>
</div>
<div class="sect3 data-line-731">
<h4 id="ganache">Ganache: A Local Test Blockchain</h4>
<div class="paragraph data-line-733">
<p>Ganache is a local test blockchain that you can use to deploy contracts, develop your applications, and run tests. It is available as a desktop application (with a graphical user interface) for Windows, macOS, and Linux. It is also available as a command-line utility called ganache-cli. For more details and installation instructions for the Ganache desktop application, see <a href="https://truffleframework.com/ganache" class="undefined" data-href="https://truffleframework.com/ganache">https://truffleframework.com/ganache</a>.</p>
</div>
<div class="paragraph data-line-735">
<p>The ganache-cli code can be found at <a href="https://github.com/trufflesuite/ganache-cli/" class="undefined" data-href="https://github.com/trufflesuite/ganache-cli/">https://github.com/trufflesuite/ganache-cli/</a>.</p>
</div>
<div class="paragraph data-line-737">
<p>To install the command line ganache-cli, use npm:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm install -g ganache-cli</strong>
</pre>
<div class="paragraph data-line-745">
<p>You can use ganache-cli to start a local blockchain for testing as follows:</p>
</div>
<pre data-type="programlisting">
$ <strong>ganache-cli \
  --networkId=3 \
  --port="8545" \
  --verbose \
  --gasLimit=8000000 \
  --gasPrice=4000000000;</strong>
</pre>
<div class="paragraph data-line-758">
<p>A few notes on this command line:</p>
</div>
<div class="ulist checklist data-line-760">
<ul class="checklist">
<li class="data-line-760">
<p>&#10063; Check the <code>--networkId</code> and <code>--port</code> flag values match your configuration in <em>truffle.js</em>.</p>
</li>
<li class="data-line-761">
<p>&#10063; Check the <code>--gasLimit</code> flag value matches the latest mainnet gas limit (e.g., 8,000,000 gas) shown at <a href="https://ethstats.net" class="undefined" data-href="https://ethstats.net">https://ethstats.net</a> to avoid encountering &#x201c;out of gas&#x201d; exceptions unnecessarily. Note that a <code>--gasPrice</code> of 4000000000 represents a gas price of 4 gwei.</p>
</li>
<li class="data-line-762">
<p>&#10063; You can optionally enter a <code>--mnemonic</code> flag value to restore a previous HD wallet and associated addresses.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1 data-line-3">
<h2 id="web3js_tutorial">Appendix E: Tutoriel web3.js</h2>
<div class="sectionbody">
<div class="sect2 data-line-5">
<h3 id="_description">Description</h3>
<div class="paragraph data-line-6">
<p>This tutorial is based on web3@1.0.0-beta.29 web3.js. It is intended as an introduction to web3.js.</p>
</div>
<div class="paragraph data-line-8">
<p>The web3.js JavaScript library is a collection of modules that contain specific functionality for the Ethereum ecosystem, together with an Ethereum-compatible JavaScript API that implements the Generic JSON RPC spec.</p>
</div>
<div class="paragraph data-line-10">
<p>To run this script you don’t need to run your own local node, because it uses the <a href="https://infura.io" data-href="https://infura.io">Infura services</a>.</p>
</div>
</div>
<div class="sect2 data-line-12">
<h3 id="_web3_js_contract_basic_interaction_in_a_nonblocked_async_fashion">web3.js Contract Basic Interaction in a Nonblocked (Async) Fashion</h3>
<div class="paragraph data-line-14">
<p>Check you have a valid npm version:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm -v</strong>
5.6.0
</pre>
<div class="paragraph data-line-23">
<p>If you haven&#8217;t, initialize npm:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm init</strong>
</pre>
<div class="paragraph data-line-31">
<p>Install basic dependencies:</p>
</div>
<pre data-type="programlisting">
$ <strong>npm i command-line-args</strong>
$ <strong>npm i web3</strong>
$ <strong>npm i node-rest-client-promise</strong>
</pre>
<div class="paragraph data-line-41">
<p>This will update your <em>package.json</em> configuration file with your new dependencies.</p>
</div>
<div class="sect3 data-line-43">
<h4 id="_node_js_script_execution">Node.js Script Execution</h4>
<div class="paragraph data-line-45">
<p>Basic execution:</p>
</div>
<pre data-type="programlisting">
$ <strong>node code/web3js/web3-contract-basic-interaction.js</strong>
</pre>
<div class="paragraph data-line-53">
<p>Use your own Infura token (register at <a href="https://infura.io/" class="undefined" data-href="https://infura.io/">https://infura.io/</a> and store the api-key in a local file called <em>infura_token</em>):</p>
</div>
<pre data-type="programlisting">
$ <strong>node code/web3js/web3-contract-basic-interaction.js \
  --infuraFileToken /path/to/file/with/infura_token</strong>
</pre>
<div class="paragraph data-line-62">
<p>or:</p>
</div>
<pre data-type="programlisting">
$ <strong>node code/web3js/web3-contract-basic-interaction.js \
  /path/to/file/with/infura_token</strong>
</pre>
<div class="paragraph data-line-71">
<p>This will read the file with your own token and pass it in as a command-line argument to the actual command.</p>
</div>
</div>
</div>
<div class="sect2 data-line-73">
<h3 id="_reviewing_the_demo_script">Reviewing the Demo Script</h3>
<div class="paragraph data-line-75">
<p>Next, let&#8217;s review our demo script, <em>web3-contract-basic-interaction</em>.</p>
</div>
<div class="paragraph data-line-77">
<p>We use the Web3 object to obtain a basic web3 provider:</p>
</div>
<div class="listingblock data-line-80">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">var web3 = new Web3(infura_host);</code></pre>
</div>
</div>
<div class="paragraph data-line-84">
<p>We can then interact with web3 and try some basic functions. Let&#8217;s see the protocol version:</p>
</div>
<div class="listingblock data-line-87">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">web3.eth.getProtocolVersion().then(function(protocolVersion) {
      console.log(`Protocol Version: ${protocolVersion}`);
  })</code></pre>
</div>
</div>
<div class="paragraph data-line-93">
<p>Now let&#8217;s look at the current gas price:</p>
</div>
<div class="listingblock data-line-96">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">web3.eth.getGasPrice().then(function(gasPrice) {
      console.log(`Gas Price: ${gasPrice}`);
  })</code></pre>
</div>
</div>
<div class="paragraph data-line-102">
<p>What&#8217;s the last mined block in the current chain?</p>
</div>
<div class="listingblock data-line-105">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">web3.eth.getBlockNumber().then(function(blockNumber) {
      console.log(`Block Number: ${blockNumber}`);
  })</code></pre>
</div>
</div>
</div>
<div class="sect2 data-line-111">
<h3 id="_contract_interaction">Contract Interaction</h3>
<div class="paragraph data-line-113">
<p>Now let&#8217;s try some basic interactions with a contract. For these examples, we&#8217;ll use the <a href="https://bit.ly/2MPZZLx" data-href="https://bit.ly/2MPZZLx">WETH9_ contract</a> on the Kovan testnet.</p>
</div>
<div class="paragraph pagebreak-before data-line-116">
<p>First, let&#8217;s initialize our contract address:</p>
</div>
<div class="listingblock data-line-119">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">var our_contract_address = "0xd0A1E359811322d97991E03f863a0C30C2cF029C";</code></pre>
</div>
</div>
<div class="paragraph data-line-123">
<p>We can then look at its balance:</p>
</div>
<div class="listingblock data-line-126">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">web3.eth.getBalance(our_contract_address).then(function(balance) {
      console.log(`Balance of ${our_contract_address}: ${balance}`);
})</code></pre>
</div>
</div>
<div class="paragraph data-line-132">
<p>and see its bytecode:</p>
</div>
<div class="listingblock data-line-135">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">web3.eth.getCode(our_contract_address).then(function(code) {
      console.log(code);
})</code></pre>
</div>
</div>
<div class="paragraph data-line-141">
<p>Next, we&#8217;ll prepare our environment to interact with the Etherscan explorer API.</p>
</div>
<div class="paragraph data-line-143">
<p>Let&#8217;s initialize our contract URL in the Etherscan explorer API for the Kovan chain:</p>
</div>
<div class="listingblock data-line-146">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">var etherscan_url =
  "https://kovan.etherscan.io/api?module=contract&amp;action=getabi&amp;
  address=${our_contract_address}"</code></pre>
</div>
</div>
<div class="paragraph data-line-152">
<p>And let&#8217;s initialize a REST client to interact with the Etherscan API:</p>
</div>
<div class="listingblock data-line-155">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">var client = require('node-rest-client-promise').Client();</code></pre>
</div>
</div>
<div class="paragraph data-line-159">
<p>and get a client promise:</p>
</div>
<div class="listingblock data-line-162">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">client.getPromise(etherscan_url)</code></pre>
</div>
</div>
<div class="paragraph data-line-166">
<p>Once we&#8217;ve got a valid client promise, we can get our contract ABI from the Etherscan API:</p>
</div>
<div class="listingblock data-line-169">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">.then((client_promise) =&gt; {
  our_contract_abi = JSON.parse(client_promise.data.result);</code></pre>
</div>
</div>
<div class="paragraph data-line-174">
<p>And now we can create our contract object as a promise to consume later:</p>
</div>
<div class="listingblock data-line-177">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">  return new Promise((resolve, reject) =&gt; {
      var our_contract = new web3.eth.Contract(our_contract_abi,
                                               our_contract_address);
      try {
        // If all goes well
        resolve(our_contract);
      } catch (ex) {
        // If something goes wrong
        reject(ex);
      }
    });
})</code></pre>
</div>
</div>
<div class="paragraph data-line-192">
<p>If our contract promise returns successfully, we can start interacting with it:</p>
</div>
<div class="listingblock data-line-195">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">.then((our_contract) =&gt; {</code></pre>
</div>
</div>
<div class="paragraph data-line-199">
<p>Let&#8217;s see our contract address:</p>
</div>
<div class="listingblock data-line-202">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">console.log(`Our Contract address:
            ${our_contract._address}`);</code></pre>
</div>
</div>
<div class="paragraph data-line-207">
<p>or alternatively:</p>
</div>
<div class="listingblock data-line-210">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">console.log(`Our Contract address in another way:
            ${our_contract.options.address}`);</code></pre>
</div>
</div>
<div class="paragraph data-line-215">
<p>Now let&#8217;s query our contract ABI:</p>
</div>
<div class="listingblock data-line-218">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">console.log("Our contract abi: " +
            JSON.stringify(our_contract.options.jsonInterface));</code></pre>
</div>
</div>
<div class="paragraph data-line-223">
<p>We can see our contract&#8217;s total supply using a callback:</p>
</div>
<div class="listingblock data-line-226">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">our_contract.methods.totalSupply().call(function(err, totalSupply) {
    if (!err) {
        console.log(`Total Supply with a callback:  ${totalSupply}`);
    } else {
        console.log(err);
    }
});</code></pre>
</div>
</div>
<div class="paragraph data-line-236">
<p>Or we can use the returned promise instead of passing in the callback:</p>
</div>
<div class="listingblock data-line-239">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">our_contract.methods.totalSupply().call().then(function(totalSupply){
    console.log(`Total Supply with a promise:  ${totalSupply}`);
}).catch(function(err) {
    console.log(err);
});</code></pre>
</div>
</div>
</div>
<div class="sect2 data-line-247">
<h3 id="_asynchronous_operation_with_await">Asynchronous Operation with Await</h3>
<div class="paragraph data-line-41">
<p>Now that you&#8217;ve seen the basic tutorial, you can try the same interactions using an asynchronous await construct. Review the <em>web3-contract-basic-interaction-async-await.js</em> script in <a href="http://bit.ly/2ABrFkl" data-href="http://bit.ly/2ABrFkl"><em>code/web3js</em></a> and compare it to this tutorial to see how they differ. Async-await is easier to read, as it makes the asynchronous interaction behave more like a sequence of blocking calls.</p>
</div>
<div class="paragraph data-line-43">
<p>&lt;section data-type="index"/&gt;</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-04-13 16:19:10 -0400
</div>
</div>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>