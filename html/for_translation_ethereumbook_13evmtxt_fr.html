<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>La machine virtuelle Ethereum</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article data-line-1">
<div id="header">
</div>
<div id="content">
<div class="sect1 data-line-2">
<h2 id="evm_chapter">La machine virtuelle Ethereum</h2>
<div class="sectionbody">
<div class="paragraph data-line-4">
<p>At the heart of the Ethereum protocol and operation is the Ethereum Virtual Machine, or EVM for short. As you might guess from the name, it is a computation engine, not hugely dissimilar to the virtual machines of Microsoft&#8217;s .NET Framework, or interpreters of other bytecode-compiled programming languages such as Java. In this chapter we take a detailed look at the EVM, including its instruction set, structure, and operation, within the context of Ethereum state updates.</p>
</div>
<div class="sect2 data-line-7">
<h3 id="evm_description">Qu&#8217;est-ce que l&#8217;EVM ?</h3>
<div class="paragraph data-line-8">
<p>The EVM is the part of Ethereum that handles smart contract deployment and execution. Simple value transfer transactions from one EOA to another don&#8217;t need to involve it, practically speaking, but everything else will involve a state update computed by the EVM. At a high level, the EVM running on the Ethereum blockchain can be thought of as a global decentralized computer containing millions of executable objects, each with its own permanent data store.</p>
</div>
<div class="paragraph data-line-10">
<p>The EVM is a quasi–Turing-complete state machine; "quasi" because all execution processes are limited to a finite number of computational steps by the amount of gas available for any given smart contract execution. As such, the halting problem is "solved" (all program executions will halt) and the situation where execution might (accidentally or maliciously) run forever, thus bringing the Ethereum platform to halt in its entirety, is avoided.</p>
</div>
<div class="paragraph data-line-12">
<p>The EVM has a stack-based architecture, storing all in-memory values on a stack. It works with a word size of 256 bits (mainly to facilitate native hashing and elliptic curve operations) and has several addressable data components:</p>
</div>
<div class="ulist pagebreak-before data-line-15">
<ul>
<li class="data-line-15">
<p>An immutable <em>program code ROM</em>, loaded with the bytecode of the smart contract to be executed</p>
</li>
<li class="data-line-16">
<p>A volatile <em>memory</em>, with every location explicitly initialized to zero</p>
</li>
<li class="data-line-17">
<p>A permanent <em>storage</em> that is part of the Ethereum state, also zero-initialized</p>
</li>
</ul>
</div>
<div class="paragraph data-line-19">
<p>There is also a set of environment variables and data that is available during execution. We will go through these in more detail later in this chapter.</p>
</div>
<div class="paragraph data-line-21">
<p><a href="#evm_architecture">The Ethereum Virtual Machine (EVM) Architecture and Execution Context</a> shows the EVM architecture and execution context.</p>
</div>
<div id="evm_architecture" class="imageblock data-line-25">
<div class="content">
<img src="images/evm-architecture.png" alt="The Ethereum Virtual Machine (EVM) Architecture and Execution Context">
</div>
<div class="title">Figure 1. The Ethereum Virtual Machine (EVM) Architecture and Execution Context</div>
</div>
<div class="sect3 data-line-28">
<h4 id="evm_comparison">Comparaison avec les technologies existantes</h4>
<div class="paragraph data-line-30">
<p>The term "virtual machine" is often applied to the virtualization of a real computer, typically by a "hypervisor" such as VirtualBox or QEMU, or of an entire operating system instance, such as Linux&#8217;s KVM. These must provide a software abstraction, respectively, of actual hardware, and of system calls and other kernel functionality.</p>
</div>
<div class="paragraph data-line-32">
<p>The EVM operates in a much more limited domain: it is just a computation engine, and as such provides an abstraction of just computation and storage, similar to the Java Virtual Machine (JVM) specification, for example. From a high-level viewpoint, the JVM is designed to provide a runtime environment that is agnostic of the underlying host OS or hardware, enabling compatibility across a wide variety of systems. High-level programming languages such as Java or Scala (which use the JVM) or C# (which uses .NET) are compiled into the bytecode instruction set of their respective virtual machine. In the same way, the EVM executes its own bytecode instruction set (described in the next section), which higher-level smart contract programming languages such as LLL, Serpent, Mutan, or Solidity are compiled into.</p>
</div>
<div class="paragraph data-line-34">
<p>The EVM, therefore, has no scheduling capability, because execution ordering is organized externally to it&#x2014;Ethereum clients run through verified block transactions to determine which smart contracts need executing and in which order. In this sense, the Ethereum world computer is single-threaded, like JavaScript. Neither does the EVM have any "system interface" handling or &#x201c;hardware support&#x201d;&#x2014;there is no physical machine to interface with. The Ethereum world computer is completely virtual.</p>
</div>
</div>
<div class="sect3 data-line-37">
<h4 id="evm_bytecode_overview">Le jeu d&#8217;instructions EVM (opérations de bytecode)</h4>
<div class="paragraph data-line-39">
<p>The EVM instruction set offers most of the operations you might expect, including:</p>
</div>
<div class="ulist data-line-41">
<ul>
<li class="data-line-41">
<p>Arithmetic and bitwise logic operations</p>
</li>
<li class="data-line-42">
<p>Execution context inquiries</p>
</li>
<li class="data-line-43">
<p>Stack, memory, and storage access</p>
</li>
<li class="data-line-44">
<p>Control flow operations</p>
</li>
<li class="data-line-45">
<p>Logging, calling, and other operators</p>
</li>
</ul>
</div>
<div class="paragraph data-line-47">
<p>In addition to the typical bytecode operations, the EVM also has access to account information (e.g., address and balance) and block information (e.g., block number and current gas price).</p>
</div>
<div class="paragraph data-line-49">
<p>Commençons par explorer plus en détail de l&#8217;EVM en examinant les opcodes disponibles et ce qu&#8217;ils font. Comme vous pouvez vous y attendre, tous les opérandes sont extraits de la pile et le résultat (le cas échéant) est souvent
remis sur le dessus de la pile.</p>
</div>
<div class="admonitionblock note data-line-53">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph data-line-54">
<p>Une liste complète des opcodes et leur coût de gaz correspondant peut être trouvée dans &lt; &lt;evm_opcodes&gt; &gt;.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph data-line-57">
<p>Les opcodes disponibles peuvent être divisés dans les catégories suivantes:</p>
</div>
<div id="arithmetic_opcodes" class="dlist data-line-60">
<dl>
<dt class="hdlist1">Opérations arithmétiques </dt>
<dd>
<p>Instructions opcode arithmétiques :</p>
<div class="listingblock data-line-62">
<div class="content">
<pre>ADD // Ajoute les deux premiers éléments de la pile
MUL        //Multiply the top two stack items
SUB        //Subtract the top two stack items
DIV // Division entière
SDIV // Division entière signée
MOD // Opérateur modulo (reste)
SMOD // Opérateur modulo signé
ADDMOD     //Addition modulo any number
MULMOD // Multiplication modulo un nombre
EXP // Opérateur exponentiel
SIGNEXTEND //Extend the length of a two's complement signed integer
SHA3       //Compute the Keccak-256 hash of a block of memory</pre>
</div>
</div>
<div class="paragraph data-line-77">
<p>Note that all arithmetic is performed modulo 2<sup>256</sup> (unless otherwise noted), and that the zeroth power of zero, 0<sup>0</sup>, is taken to be 1.</p>
</div>
</dd>
</dl>
</div>
<div id="stack_opcodes" class="dlist data-line-81">
<dl>
<dt class="hdlist1">Stack operations</dt>
<dd>
<p>Stack, memory, and storage management instructions:</p>
<div class="listingblock data-line-83">
<div class="content">
<pre>POP     //Remove the top item from the stack
MLOAD   //Load a word from memory
MSTORE  //Save a word to memory
MSTORE8 //Save a byte to memory
SLOAD   //Load a word from storage
SSTORE  //Save a word to storage
MSIZE   //Get the size of the active memory in bytes
PUSHx   //Place x byte item on the stack, where x can be any integer from
        // 1 to 32 (full word) inclusive
DUPx    //Duplicate the x-th stack item, where x can be any integer from
        // 1 to 16 inclusive
SWAPx   //Exchange 1st and (x+1)-th stack items, where x can be any
        // integer from 1 to 16 inclusive</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="flow_opcodes" class="dlist data-line-101">
<dl>
<dt class="hdlist1">Process flow operations</dt>
<dd>
<p>Instructions for control flow:</p>
<div class="listingblock data-line-103">
<div class="content">
<pre>STOP      //Halt execution
JUMP      //Set the program counter to any value
JUMPI     //Conditionally alter the program counter
PC // Récupère la valeur du compteur de programme (avant l'incrémentation
// correspondant à cette instruction)
JUMPDEST  //Mark a valid destination for jumps</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="system_opcodes" class="dlist data-line-113">
<dl>
<dt class="hdlist1">System operations</dt>
<dd>
<p>Opcodes for the system executing the program:</p>
<div class="listingblock data-line-115">
<div class="content">
<pre>LOGx          //Append a log record with x topics, where x is any integer
              //from 0 to 4 inclusive
CREATE        //Create a new account with associated code
CALL          //Message-call into another account, i.e. run another
              //account's code
CALLCODE      //Message-call into this account with another
              //account's code
RETURN        //Halt execution and return output data
DELEGATECALL  //Message-call into this account with an alternative
              //account's code, but persisting the current values for
              //sender and value
STATICCALL    //Static message-call into an account
REVERT        //Halt execution, reverting state changes but returning
              //data and remaining gas
INVALID       //The designated invalid instruction
SELFDESTRUCT  //Halt execution and register account for deletion</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="logic_opcides" class="dlist data-line-135">
<dl>
<dt class="hdlist1">Logic operations</dt>
<dd>
<p>Opcodes for comparisons and bitwise logic:</p>
<div class="listingblock data-line-137">
<div class="content">
<pre>LT     //Less-than comparison
GT     //Greater-than comparison
SLT    //Signed less-than comparison
SGT    //Signed greater-than comparison
EQ     //Equality comparison
ISZERO //Simple NOT operator
AND    //Bitwise AND operation
OR     //Bitwise OR operation
XOR    //Bitwise XOR operation
NOT    //Bitwise NOT operation
BYTE   //Retrieve a single byte from a full-width 256-bit word</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="environment_opcodes" class="dlist data-line-152">
<dl>
<dt class="hdlist1">Environmental operations</dt>
<dd>
<p>Opcodes dealing with execution environment information:</p>
<div class="listingblock data-line-154">
<div class="content">
<pre>GAS            //Get the amount of available gas (after the reduction for
               //this instruction)
ADDRESS        //Get the address of the currently executing account
BALANCE        //Get the account balance of any given account
ORIGIN         //Get the address of the EOA that initiated this EVM
               //execution
CALLER         //Get the address of the caller immediately responsible
               //for this execution
CALLVALUE      //Get the ether amount deposited by the caller responsible
               //for this execution
CALLDATALOAD   //Get the input data sent by the caller responsible for
               //this execution
CALLDATASIZE   //Get the size of the input data
CALLDATACOPY   //Copy the input data to memory
CODESIZE       //Get the size of code running in the current environment
CODECOPY       //Copy the code running in the current environment to
               //memory
GASPRICE       //Get the gas price specified by the originating
               //transaction
EXTCODESIZE    //Get the size of any account's code
EXTCODECOPY    //Copy any account's code to memory
RETURNDATASIZE //Get the size of the output data from the previous call
               //in the current environment
RETURNDATACOPY //Copy data output from the previous call to memory</pre>
</div>
</div>
</dd>
</dl>
</div>
<div id="block_opcodes" class="dlist data-line-182">
<dl>
<dt class="hdlist1">Block operations</dt>
<dd>
<p>Opcodes for accessing information on the current block:</p>
<div class="listingblock data-line-184">
<div class="content">
<pre>BLOCKHASH  //Get the hash of one of the 256 most recently completed
           //blocks
COINBASE   //Get the block's beneficiary address for the block reward
TIMESTAMP  //Get the block's timestamp
NUMBER     //Get the block's number
DIFFICULTY //Get the block's difficulty
GASLIMIT   //Get the block's gas limit</pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect3 data-line-195">
<h4 id="evm_state_descriptions">L&#8217;état Ethereum</h4>
<div class="paragraph data-line-197">
<p>The job of the EVM is to update the Ethereum state by computing valid state transitions as a result of smart contract code execution, as defined by the Ethereum protocol. This aspect leads to the description of Ethereum as a <em>transaction-based state machine</em>, which reflects the fact that external actors (i.e., account holders and miners) initiate state transitions by creating, accepting, and ordering transactions. It is useful at this point to consider what constitutes the Ethereum state.</p>
</div>
<div class="paragraph data-line-199">
<p>At the top level, we have the Ethereum <em>world state</em>. The world state is a mapping of Ethereum addresses (160-bit values) to <em>accounts</em>. At the lower level, each Ethereum address represents an account comprising an ether <em>balance</em> (stored as the number of wei owned by the account), a <em>nonce</em> (representing the number of transactions successfully sent from this account if it is an EOA, or the number of contracts created by it if it is a contract account), the account&#8217;s <em>storage</em> (which is a permanent data store, only used by smart contracts), and the account&#8217;s <em>program code</em> (again, only if the account is a smart contract account). An EOA will always have no code and an empty storage.</p>
</div>
<div class="paragraph data-line-205">
<p>When a transaction results in smart contract code execution, an EVM is instantiated with all the information required in relation to the current block being created and the specific transaction being processed. In particular, the EVM&#8217;s program code ROM is loaded with the code of the contract account being called, the program counter is set to zero, the storage is loaded from the contract account&#8217;s storage, the memory is set to all zeros, and all the block and environment variables are set. A key variable is the gas supply for this execution, which is set to the amount of gas paid for by the sender at the start of the transaction (see <a href="#gas">Gaz</a> for more details). As code execution progresses, the gas supply is reduced according to the gas cost of the operations executed. If at any point the gas supply is reduced to zero we get an "Out of Gas" (OOG) exception; execution immediately halts and the transaction is abandoned. No changes to the Ethereum state are applied, except for the sender&#8217;s nonce being incremented and their ether balance going down to pay the block&#8217;s beneficiary for the resources used to execute the code to the halting point. At this point, you can think of the EVM running on a sandboxed copy of the Ethereum world state, with this sandboxed version being discarded completely if execution cannot complete for whatever reason. However, if execution does complete successfully, then the real-world state is updated to match the sandboxed version, including any changes to the called contract&#8217;s storage data, any new contracts created, and any ether balance transfers that were initiated.</p>
</div>
<div class="paragraph data-line-207">
<p>Note that because a smart contract can itself effectively initiate transactions, code execution is a recursive process. A contract can call other contracts, with each call resulting in another EVM being instantiated around the new target of the call. Each instantiation has its sandbox world state initialized from the sandbox of the EVM at the level above. Each instantiation is also given a specified amount of gas for its gas supply (not exceeding the amount of gas remaining in the level above, of course), and so may itself halt with an exception due to being given too little gas to complete its execution. Again, in such cases, the sandbox state is discarded, and execution returns to the EVM at the level above.</p>
</div>
</div>
<div class="sect3 data-line-210">
<h4 id="compiling_solidity_to_evm">Compiler Solidity vers du bytecode EVM</h4>
<div id="solc_help" class="paragraph data-line-213">
<p>Compiling a Solidity source file to EVM bytecode can be accomplished via several methods. In <a href="#intro_chapter">[intro_chapter]</a> we used the online Remix compiler. In this chapter, we will use the solc executable at the command line. For a list of options, run the following <span class="keep-together">command</span>:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc --help</strong>
</pre>
<div id="solc_opcodes_option" class="paragraph data-line-222">
<p>Generating the raw opcode stream of a Solidity source file is easily achieved with the --opcodes command-line option. This opcode stream leaves out some information (the --asm option produces the full information), but it is sufficient for this discussion. For example, compiling an example Solidity file, <em>Example.sol</em>, and sending the opcode output into a directory named <em>BytecodeDir</em> is accomplished with the following command:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc -o BytecodeDir --opcodes Example.sol</strong>
</pre>
<div class="paragraph data-line-230">
<p>or:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc -o BytecodeDir --asm Example.sol</strong>
</pre>
<div id="solc_bin_option" class="paragraph data-line-239">
<p>The following command will produce the bytecode binary for our example program:</p>
</div>
<pre data-type="programlisting">
$ <strong>solc -o BytecodeDir --bin Example.sol</strong>
</pre>
<div class="paragraph data-line-247">
<p>The output opcode files generated will depend on the specific contracts contained within the Solidity source file. Our simple Solidity file <em>Example.sol</em> has only one contract, named example:</p>
</div>
<div id="simple_solidity_example" class="listingblock data-line-251">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">pragma solidity ^0.4.19;

contract example {

  address contractOwner;

  function example() {
    contractOwner = msg.sender;
  }
}</code></pre>
</div>
</div>
<div class="paragraph data-line-264">
<p>As you can see, all this contract does is hold one persistent state variable, which is set as the address of the last account to run this contract.</p>
</div>
<div class="paragraph data-line-266">
<p>If you look in the <em>BytecodeDir</em> directory you will see the opcode file <em>example.opcode</em>, which contains the EVM opcode instructions of the example contract. Opening the <em>example.opcode</em> file in a text editor will show the following:</p>
</div>
<div id="opcode_output" class="listingblock data-line-269">
<div class="content">
<pre>PUSH1 0x60 PUSH1 0x40 MSTORE CALLVALUE ISZERO PUSH1 0xE JUMPI PUSH1 0x0 DUP1
REVERT JUMPDEST CALLER PUSH1 0x0 DUP1 PUSH2 0x100 EXP DUP2 SLOAD DUP2 PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF MUL NOT AND SWAP1 DUP4 PUSH20
0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF AND MUL OR SWAP1 SSTORE POP PUSH1
0x35 DUP1 PUSH1 0x5B PUSH1 0x0 CODECOPY PUSH1 0x0 RETURN STOP PUSH1 0x60 PUSH1
0x40 MSTORE PUSH1 0x0 DUP1 REVERT STOP LOG1 PUSH6 0x627A7A723058 KECCAK256 JUMP
0xb9 SWAP14 0xcb 0x1e 0xdd RETURNDATACOPY 0xec 0xe0 0x1f 0x27 0xc9 PUSH5
0x9C5ABCC14A NUMBER 0x5e INVALID EXTCODESIZE 0xdb 0xcf EXTCODESIZE 0x27
EXTCODESIZE 0xe2 0xb8 SWAP10 0xed 0x</pre>
</div>
</div>
<div class="paragraph data-line-281">
<p>Compiling the example with the --asm option produces a file named <em>example.evm</em> in our <em>BytecodeDir</em> directory. This contains a slightly higher-level description of the EVM bytecode instructions, together with some helpful annotations:</p>
</div>
<div id="asm_output" class="listingblock data-line-285">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">/* "Example.sol":26:132  contract example {... */
  mstore(0x40, 0x60)
    /* "Example.sol":74:130  function example() {... */
  jumpi(tag_1, iszero(callvalue))
  0x0
  dup1
  revert
tag_1:
    /* "Example.sol":115:125  msg.sender */
  caller
    /* "Example.sol":99:112  contractOwner */
  0x0
  dup1
    /* "Example.sol":99:125  contractOwner = msg.sender */
  0x100
  exp
  dup2
  sload
  dup2
  0xffffffffffffffffffffffffffffffffffffffff
  mul
  not
  and
  swap1
  dup4
  0xffffffffffffffffffffffffffffffffffffffff
  and
  mul
  or
  swap1
  sstore
  pop
    /* "Example.sol":26:132  contract example {... */
  dataSize(sub_0)
  dup1
  dataOffset(sub_0)
  0x0
  codecopy
  0x0
  return
stop

sub_0: assembly {
        /* "Example.sol":26:132  contract example {... */
      mstore(0x40, 0x60)
      0x0
      dup1
      revert

    auxdata: 0xa165627a7a7230582056b99dcb1edd3eece01f27c9649c5abcc14a435efe3b...
}</code></pre>
</div>
</div>
<div class="paragraph data-line-339">
<p>The --bin-runtime option produces the machine-readable hexadecimal bytecode:</p>
</div>
<div id="bin_output" class="listingblock data-line-342">
<div class="content">
<pre>60606040523415600e57600080fd5b336000806101000a81548173
ffffffffffffffffffffffffffffffffffffffff
021916908373
ffffffffffffffffffffffffffffffffffffffff
160217905550603580605b6000396000f3006060604052600080fd00a165627a7a7230582056b...</pre>
</div>
</div>
<div class="paragraph data-line-350">
<p>You can investigate what&#8217;s going on here in detail using the opcode list given in <a href="#evm_bytecode_overview">Le jeu d&#8217;instructions EVM (opérations de bytecode)</a>. However, that&#8217;s quite a task, so let&#8217;s just start by examining the first four instructions:</p>
</div>
<div id="opcode_analysis_1" class="listingblock data-line-353">
<div class="content">
<pre>PUSH1 0x60 PUSH1 0x40 MSTORE CALLVALUE</pre>
</div>
</div>
<div class="paragraph data-line-357">
<p>Here we have PUSH1 followed by a raw byte of value 0x60. This EVM instruction takes the single byte following the opcode in the program code (as a literal value) and pushes it onto the stack. It is possible to push values of size up to 32 bytes onto the stack, as in:</p>
</div>
<div class="listingblock data-line-359">
<div class="content">
<pre>PUSH32 0x436f6e67726174756c6174696f6e732120536f6f6e20746f206d617374657221</pre>
</div>
</div>
<div class="paragraph data-line-363">
<p>The second PUSH1 opcode from <em>example.opcode</em> stores 0x40 onto the top of the stack (pushing the 0x60 already present there down one slot).</p>
</div>
<div class="paragraph data-line-365">
<p>Next is MSTORE, which is a memory store operation that saves a value to the EVM&#8217;s memory. It takes two arguments and, like most EVM operations, obtains them from the stack. For each argument the stack is &#x201c;popped&#x201d;; i.e., the top value on the stack is taken off and all the other values on the stack are shifted up one position. The first argument for MSTORE is the address of the word in memory where the value to be saved will be put. For this program we have 0x40 at the top of the stack, so that is removed from the stack and used as the memory address. The second argument is the value to be saved, which is 0x60 here. After the MSTORE operation is executed our stack is empty again, but we have the value 0x60 (96 in decimal) at the memory location 0x40.</p>
</div>
<div class="paragraph data-line-367">
<p>The next opcode is CALLVALUE, which is an environmental opcode that pushes onto the top of the stack the amount of ether (measured in wei) sent with the message call that initiated this execution.</p>
</div>
<div class="paragraph data-line-369">
<p>We could continue to step through this program in this way until we had a full understanding of the low-level state changes that this code effects, but it wouldn&#8217;t help us at this stage. We&#8217;ll come back to it later in the chapter.</p>
</div>
</div>
<div class="sect3 data-line-372">
<h4 id="contract_deployment_code">Code de déploiement de contrat</h4>
<div class="paragraph data-line-374">
<p>There is an important but subtle difference between the code used when creating and deploying a new contract on the Ethereum platform and the code of the contract itself. In order to create a new contract, a special transaction is needed that has its to field set to the special 0x0 address and its data field set to the contract&#8217;s <em>initiation code</em>. When such a contract creation transaction is processed, the code for the new contract account is <em>not</em> the code in the data field of the transaction. Instead, an EVM is instantiated with the code in the data field of the transaction loaded into its program code ROM, and then the output of the execution of that deployment code is taken as the code for the new contract account. This is so that new contracts can be programmatically initialized using the Ethereum world state at the time of deployment, setting values in the contract&#8217;s storage and even sending ether or creating further new contracts.</p>
</div>
<div class="paragraph data-line-376">
<p>When compiling a contract offline, e.g., using solc on the command line, you can either get the <em>deployment bytecode</em> or the <em>runtime bytecode</em>.</p>
</div>
<div class="paragraph data-line-378">
<p>The deployment bytecode is used for every aspect of the initialization of a new contract account, including the bytecode that will actually end up being executed when transactions call this new contract (i.e., the runtime bytecode) and the code to initialize everything based on the contract&#8217;s constructor.</p>
</div>
<div class="paragraph data-line-380">
<p>The runtime bytecode, on the other hand, is exactly the bytecode that ends up being executed when the new contract is called, and nothing more; it does not include the bytecode needed to initialize the contract during deployment.</p>
</div>
<div class="paragraph data-line-382">
<p>Let&#8217;s take the simple <em>Faucet.sol</em> contract we created earlier as an example:</p>
</div>
<div id="faucet_example" class="listingblock data-line-386">
<div class="content">
<pre class="highlight"><code class="language-solidity" data-lang="solidity">// Version du compilateur Solidity pour lequel ce programme a été écrit
pragma solidity ^0.4.19;

// Notre premier contrat est un faucet!
contract Faucet {

// Donne de l'éther à tous ceux qui le demandent
  function withdraw(uint withdraw_amount) public {

// Limiter le montant du retrait
      require(withdraw_amount &lt;= 100000000000000000);

// Envoi du montant à l'adresse qui l'a demandé
      msg.sender.transfer(withdraw_amount);
    }

// Accepte tout montant entrant
  function () external payable {}

}</code></pre>
</div>
</div>
<div class="paragraph data-line-409">
<p>To get the deployment bytecode, we would run <code>solc --bin Faucet.sol</code>. If we instead wanted just the runtime bytecode, we would run <code>solc --bin-runtime <span class="keep-together">Faucet.sol</span></code>.</p>
</div>
<div class="paragraph data-line-411">
<p>If you compare the output of these commands, you will see that the runtime bytecode is a subset of the deployment bytecode. In other words, the runtime bytecode is entirely contained within the deployment bytecode.</p>
</div>
</div>
<div class="sect3 data-line-414">
<h4 id="disassembling_the_bytecode">Désassembler le Bytecode</h4>
<div class="paragraph data-line-416">
<p>Disassembling EVM bytecode is a great way to understand how high-level Solidity acts in the EVM. There are a few disassemblers you can use to do this:</p>
</div>
<div class="ulist data-line-418">
<ul>
<li class="data-line-418">
<p><a href="https://github.com/comaeio/porosity" data-href="https://github.com/comaeio/porosity"><em>Porosity</em></a> est un décompilateur open source populaire.</p>
</li>
<li class="data-line-419">
<p><a href="https://github.com/trailofbits/ethersplay" data-href="https://github.com/trailofbits/ethersplay"><em>Ethersplay</em></a> is an EVM plug-in for Binary Ninja, a disassembler.</p>
</li>
<li class="data-line-420">
<p><a href="https://github.com/trailofbits/ida-evm" data-href="https://github.com/trailofbits/ida-evm"><em>IDA-Evm</em></a> est un plugin EVM pour IDA, un autre désassembleur.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-422">
<p>In this section, we will be using the Ethersplay plug-in for Binary Ninja and to start <a href="#Faucet_disassembled">Disassembling the Faucet runtime bytecode</a>. After getting the runtime bytecode of <em>Faucet.sol</em>, we can feed it into Binary Ninja (after loading the Ethersplay plug-in) to see what the EVM instructions look like.</p>
</div>
<div id="Faucet_disassembled" class="imageblock data-line-426">
<div class="content">
<img src="images/Faucet_disassembled.png" alt="Faucet.sol runtime bytecode disassembled">
</div>
<div class="title">Figure 2. Disassembling the Faucet runtime bytecode</div>
</div>
<div class="paragraph data-line-428">
<p>When you send a transaction to an ABI-compatible smart contract (which you can assume all contracts are), the transaction first interacts with that smart contract&#8217;s <em>dispatcher</em>. The dispatcher reads in the data field of the transaction and sends the relevant part to the appropriate function. We can see an example of a dispatcher at the beginning of our disassembled <em>Faucet.sol</em> runtime bytecode. After the familiar MSTORE instruction, we see the following instructions:</p>
</div>
<div id="faucet_instructions" class="listingblock data-line-431">
<div class="content">
<pre>PUSH1 0x4
CALLDATASIZE
LT
PUSH1 0x3f
JUMPI</pre>
</div>
</div>
<div class="paragraph data-line-439">
<p>As we have seen, PUSH1 0x4 places 0x4 onto the top of the stack, which is otherwise empty. CALLDATASIZE gets the size in bytes of the data sent with the transaction (known as the <em>calldata</em>) and pushes that number onto the stack. After these operations have been executed, the stack looks like this:</p>
</div>
<div class="paragraph data-line-442">
<p>| ======================
|Stack
|&lt;length of calldata from tx&gt;
|0x4
| ======================</p>
</div>
<div class="paragraph data-line-448">
<p>This next instruction is LT, short for “less than.” The LT instruction checks whether the top item on the stack is less than the next item on the stack. In our case, it checks to see if the result of CALLDATASIZE is less than 4 bytes.</p>
</div>
<div class="paragraph data-line-450">
<p>Why does the EVM check to see that the calldata of the transaction is at least 4 bytes? Because of how function identifiers work. Each function is identified by the first 4 bytes of its Keccak-256 hash. By placing the function&#8217;s name and what arguments it takes into a keccak256 hash function, we can deduce its function identifier. In our case, we have:</p>
</div>
<div id="faucet_function_identifier" class="listingblock data-line-453">
<div class="content">
<pre class="highlight"><code>keccak256("withdraw(uint256)") = 0x2e1a7d4d...</code></pre>
</div>
</div>
<div class="paragraph data-line-457">
<p>Thus, the function identifier for the withdraw(uint256) function is 0x2e1a7d4d, since these are the first 4 bytes of the resulting hash. A function identifier is always 4 bytes long, so if the entire data field of the transaction sent to the contract is less than 4 bytes, then there’s no function with which the transaction could possibly be communicating, unless a <em>fallback function</em> is defined. Because we implemented such a fallback function in <em>Faucet.sol</em>, the EVM jumps to this function when the calldata&#8217;s length is less than 4 bytes.</p>
</div>
<div class="paragraph data-line-459">
<p>LT pops the top two values off the stack and, if the transaction&#8217;s data field is less than 4 bytes, pushes 1 onto it. Otherwise, it pushes 0. In our example, let&#8217;s assume the data field of the transaction sent to our contract <em>was</em> less than 4 bytes.</p>
</div>
<div class="paragraph data-line-461">
<p>The PUSH1 0x3f instruction pushes the byte 0x3f onto the stack. After this instruction, the stack looks like this:</p>
</div>
<div class="paragraph data-line-464">
<p>| ======================
|Stack
|0x3f
|1
| ======================</p>
</div>
<div class="paragraph data-line-470">
<p>The next instruction is JUMPI, which stands for "jump if." It works like so:</p>
</div>
<div id="faucet_jump_instruction_text" class="listingblock data-line-473">
<div class="content">
<pre>jumpi(label, cond) // Jump to "label" if "cond" is true</pre>
</div>
</div>
<div class="paragraph data-line-477">
<p>In our case, label is 0x3f, which is where our fallback function lives in our smart contract. The cond argument is 1, which was the result of the LT instruction earlier. To put this entire sequence into words, the contract jumps to the fallback function if the transaction data is less than 4 bytes.</p>
</div>
<div class="paragraph data-line-479">
<p>At 0x3f, only a STOP instruction follows, because although we declared a fallback function, we kept it empty. As you can see in <a href="#Faucet_jumpi_instruction">JUMPI instruction leading to fallback function</a>, had we not implemented a fallback function, the contract would throw an exception instead.</p>
</div>
<div id="Faucet_jumpi_instruction" class="imageblock data-line-483">
<div class="content">
<img src="images/Faucet_jumpi_instruction.png" alt="JUMPI instruction leading to fallback function">
</div>
<div class="title">Figure 3. JUMPI instruction leading to fallback function</div>
</div>
<div class="paragraph data-line-485">
<p>Let&#8217;s examine the central block of the dispatcher. Assuming we received calldata that was <em>greater</em> than 4 bytes in length, the JUMPI instruction would not jump to the fallback function. Instead, code execution would proceed to the following instructions:</p>
</div>
<div id="faucet_instructions2" class="listingblock data-line-488">
<div class="content">
<pre>PUSH1 0x0
CALLDATALOAD
PUSH29 0x1000000...
SWAP1
DIV
PUSH4 0xffffffff
AND
DUP1
PUSH4 0x2e1a7d4d
EQ
PUSH1 0x41
JUMPI</pre>
</div>
</div>
<div class="paragraph data-line-503">
<p>PUSH1 0x0 pushes 0 onto the stack, which is now otherwise empty again. CALLDATALOAD accepts as an argument an index within the calldata sent to the smart contract and reads 32 bytes from that index, like so:</p>
</div>
<div id="faucet_calldataload_instruction_text" class="listingblock data-line-506">
<div class="content">
<pre>calldataload(p) //load 32 bytes of calldata starting from byte position p</pre>
</div>
</div>
<div class="paragraph data-line-510">
<p>Since 0 was the index passed to it from the PUSH1 0x0 command, CALLDATALOAD reads 32 bytes of calldata starting at byte 0, and then pushes it to the top of the stack (after popping the original 0x0). After the PUSH29 0x1000000&#8230;&#8203; instruction, the stack is then:</p>
</div>
<div class="paragraph data-line-513">
<p>| ======================
|Stack
|0x1000000&#8230;&#8203; (longueur de 29 octets)
|&lt;32 bytes of calldata starting at byte 0&gt;
| ======================</p>
</div>
<div class="paragraph data-line-519">
<p>SWAP1 switches the top element on the stack with the <em>i</em>-th element after it. In this case, it swaps 0x1000000&#8230;&#8203; with the calldata. The new stack is:</p>
</div>
<div class="paragraph data-line-522">
<p>| ======================
|Stack
|&lt;32 bytes of calldata starting at byte 0&gt;
|0x1000000&#8230;&#8203; (longueur de 29 octets)
| ======================</p>
</div>
<div class="paragraph data-line-528">
<p>The next instruction is DIV, which works as follows:</p>
</div>
<div id="faucet_div_instruction_text" class="listingblock data-line-531">
<div class="content">
<pre>div(x, y) // division entière x / y</pre>
</div>
</div>
<div class="paragraph data-line-535">
<p>In this case, x = 32 bytes of calldata starting at byte 0, and y = 0x100000000&#8230;&#8203; (29 bytes total). Can you think of why the dispatcher is doing the division? Here&#8217;s a hint: we read 32 bytes from calldata earlier, starting at index 0. The first 4 bytes of that calldata is the function identifier.</p>
</div>
<div class="paragraph data-line-538">
<p>The 0x100000000&#8230;&#8203; we pushed earlier is 29 bytes long, consisting of a 1 at the beginning, followed by all 0s. Dividing our 32 bytes of calldata by this value will leave us only the <em>topmost 4 bytes</em> of our calldata load, starting at index 0. These 4 bytes—the first 4 bytes in the calldata starting at index 0—are the function identifier, and this is how the EVM extracts that field.</p>
</div>
<div class="paragraph data-line-540">
<p>If this part isn’t clear to you, think of it like this: in base 10, 1234000 / 1000 = 1234. In base 16, this is no different. Instead of every place being a multiple of 10, it is a multiple of 16. Just as dividing by 10<sup>3</sup> (1000) in our smaller example kept only the topmost digits, dividing our 32-byte base 16 value by 16<sup>29</sup> does the same.</p>
</div>
<div class="paragraph data-line-542">
<p>The result of the DIV (the function identifier) gets pushed onto the stack, and our stack is now:</p>
</div>
<div class="paragraph data-line-545">
<p>| ======================
|Stack
|&lt;function identifier sent in data&gt;
| ======================</p>
</div>
<div class="paragraph data-line-550">
<p>Since the PUSH4 0xffffffff and AND instructions are redundant, we can ignore them entirely, as the stack will remain the same after they are done. The DUP1 instruction duplicates the first item on the stack, which is the function identifier. The next instruction, PUSH4 0x2e1a7d4d, pushes the precalculated function identifier of the <code><span class="keep-together">withdraw</span>(uint256)</code> function onto the stack. The stack is now:</p>
</div>
<div class="paragraph data-line-553">
<p>| ======================
|Stack
|0x2e1a7d4d
|&lt;function identifier sent in data&gt;
|&lt;function identifier sent in data&gt;
| ======================</p>
</div>
<div class="paragraph data-line-560">
<p>The next instruction, EQ, pops off the top two items of the stack and compares them. This is where the dispatcher does its main job: it compares whether the function identifier sent in the msg.data field of the transaction matches that of <code><span class="keep-together">withdraw</span>(uint256)</code>. If they are equal, EQ pushes 1 onto the stack, which will ultimately be used to jump to the withdraw function. Otherwise, EQ pushes 0 onto the stack.</p>
</div>
<div class="paragraph data-line-562">
<p>Assuming the transaction sent to our contract indeed began with the function identifier for withdraw(uint256), our stack has become:</p>
</div>
<div class="paragraph data-line-565">
<p>| ======================
|Stack
|1
|&lt;function identifier sent in data&gt; (et non pas 0x2e1a7d4d)
| ======================</p>
</div>
<div class="paragraph data-line-571">
<p>Next, we have PUSH1 0x41, which is the address at which the withdraw(uint256) function lives in the contract. After this instruction, the stack looks like this:</p>
</div>
<div class="paragraph data-line-574">
<p>| ======================
|Stack
|0x41
|1
|function identifier sent in msg.data
| ======================</p>
</div>
<div class="paragraph data-line-581">
<p>The JUMPI instruction is next, and it once again accepts the top two elements on the stack as arguments. In this case, we have jumpi(0x41, 1), which tells the EVM to execute the jump to the location of the withdraw(uint256) function, and the execution of that function&#8217;s code can proceed.</p>
</div>
</div>
</div>
<div class="sect2 data-line-584">
<h3 id="turing_completeness_and_gas">Complétude de Turing et gaz</h3>
<div class="paragraph data-line-586">
<p>As we have already touched on, in simple terms, a system or programming language is <em>Turing complete</em> if it can run any program. This capability, however, comes with a very important caveat: some programs take forever to run. An important aspect of this is that we can&#8217;t tell, just by looking at a program, whether it will take forever or not to execute. We have to actually go through with the execution of the program and wait for it to finish to find out. Of course, if it is going to take forever to execute, we will have to wait forever to find out. This is called the <em>halting problem</em> and would be a huge problem for Ethereum if it were not addressed.</p>
</div>
<div class="paragraph data-line-588">
<p>Because of the halting problem, the Ethereum world computer is at risk of being asked to execute a program that never stops. This could be by accident or malice. We have discussed that Ethereum acts like a single-threaded machine, without any scheduler, and so if it became stuck in an infinite loop this would mean it would become unusable.</p>
</div>
<div class="paragraph data-line-590">
<p>However, with gas, there is a solution: if after a prespecified maximum amount of computation has been performed, the execution hasn&#8217;t ended, the execution of the program is halted by the EVM. This makes the EVM a <em>quasi</em>&#x2013;Turing-complete machine: it can run any program you feed into it, but only if the program terminates within a particular amount of computation. That limit isn&#8217;t fixed in Ethereum&#x2014;you can pay to increase it up to a maximum (called the "block gas limit"), and everyone can agree to increase that maximum over time. Nevertheless, at any one time, there is a limit in place, and transactions that consume too much gas while executing are <span class="keep-together">halted</span>.</p>
</div>
<div class="paragraph data-line-592">
<p>Dans les sections suivantes, nous examinerons le gaz et examinerons son fonctionnement en détail.</p>
</div>
</div>
<div class="sect2 data-line-595">
<h3 id="gas">Gaz</h3>
<div class="paragraph data-line-597">
<p><em>Gas</em> is Ethereum&#8217;s unit for measuring the computational and storage resources required to perform actions on the Ethereum blockchain. In contrast to Bitcoin, whose transaction fees only take into account the size of a transaction in kilobytes, Ethereum must account for every computational step performed by transactions and smart contract code execution.</p>
</div>
<div class="paragraph data-line-599">
<p>Chaque opération réalisée par une transaction ou un contrat coûte une quantité fixe de gaz. Quelques exemples, tirés du Livre jaune Ethereum:</p>
</div>
<div class="ulist data-line-601">
<ul>
<li class="data-line-601">
<p>L&#8217;ajout de deux nombres coûte 3 gaz</p>
</li>
<li class="data-line-602">
<p>Calculating a Keccak-256 hash costs 30 gas + 6 gas for each 256 bits of data being hashed</p>
</li>
<li class="data-line-603">
<p>L&#8217;envoi d&#8217;une transaction coûte 21 000 gaz</p>
</li>
</ul>
</div>
<div class="paragraph data-line-605">
<p>Gas is a crucial component of Ethereum, and serves a dual role: as a buffer between the (volatile) price of Ethereum and the reward to miners for the work they do, and as a defense against denial-of-service attacks. To prevent accidental or malicious infinite loops or other computational wastage in the network, the initiator of each transaction is required to set a limit to the amount of computation they are willing to pay for. The gas system thereby disincentivizes attackers from sending "spam" transactions, as they must pay proportionately for the computational, bandwidth, and storage resources that they consume.</p>
</div>
<div class="sect3 data-line-608">
<h4 id="gas_accounting_execution">Décompte du gaz lors de l&#8217;exécution</h4>
<div class="paragraph data-line-609">
<p>When an EVM is needed to complete a transaction, in the first instance it is given a gas supply equal to the amount specified by the gas limit in the transaction. Every opcode that is executed has a cost in gas, and so the EVM&#8217;s gas supply is reduced as the EVM steps through the program. Before each operation, the EVM checks that there is enough gas to pay for the operation&#8217;s execution. If there isn&#8217;t enough gas, execution is halted and the transaction is reverted.</p>
</div>
<div class="paragraph data-line-611">
<p>If the EVM reaches the end of execution successfully, without running out of gas, the  gas cost used is paid to the miner as a transaction fee, converted to ether based on the gas price specified in the transaction:</p>
</div>
<div class="listingblock data-line-613">
<div class="content">
<pre>miner fee = gas cost * gas price</pre>
</div>
</div>
<div class="paragraph data-line-618">
<p>The gas remaining in the gas supply is refunded to the sender, again converted to ether based on the gas price specified in the transaction:</p>
</div>
<div class="listingblock data-line-620">
<div class="content">
<pre>gaz restant = limite de gaz - coût du gaz
éther remboursé = gaz restant * prix du gaz</pre>
</div>
</div>
<div class="paragraph data-line-625">
<p>If the transaction &#x201c;runs out of gas&#x201d; during execution, the operation is immediately terminated, raising an &#x201c;out of gas&#x201d; exception. The transaction is reverted and all changes to the state are rolled back.</p>
</div>
<div class="paragraph data-line-627">
<p>Although the transaction was unsuccessful, the sender will be charged a transaction fee, as miners have already performed the computational work up to that point and must be compensated for doing so.</p>
</div>
</div>
<div class="sect3 data-line-629">
<h4 id="_considérations_relatives_au_décompte_du_gaz">Considérations relatives au décompte du gaz</h4>
<div class="paragraph data-line-631">
<p>The relative gas costs of the various operations that can be performed by the EVM have been carefully chosen to best protect the Ethereum blockchain from attack. You can see a detailed table of gas costs for different EVM opcodes in <a href="#evm_opcodes_table">[evm_opcodes_table]</a>.</p>
</div>
<div class="paragraph data-line-633">
<p>More computationally intensive operations cost more gas. For example, executing the SHA3 function is 10 times more expensive (30 gas) than the ADD operation (3 gas). More importantly, some operations, such as EXP, require an additional payment based on the size of the operand. There is also a gas cost to using EVM memory and for storing data in a contract&#8217;s on-chain storage.</p>
</div>
<div class="paragraph data-line-635">
<p>The importance of matching gas cost to the real-world cost of resources was demonstrated in 2016 when an attacker found and exploited a mismatch in costs. The attack generated transactions that were very computationally expensive, and made the Ethereum mainnet almost grind to a halt. This mismatch was resolved by a hard fork (codenamed "Tangerine Whistle") that tweaked the relative gas costs.</p>
</div>
</div>
<div class="sect3 data-line-637">
<h4 id="_coût_du_gaz_et_prix_du_gaz">Coût du gaz et prix du gaz</h4>
<div class="paragraph data-line-638">
<p>While the gas <em>cost</em> is a measure of computation and storage used in the EVM, the gas itself also has a <em>price</em> measured in ether. When performing a transaction, the sender specifies the gas price they are willing to pay (in ether) for each unit of gas, allowing the market to decide the relationship between the price of ether and the cost of computing operations (as measured in gas):</p>
</div>
<div class="listingblock data-line-640">
<div class="content">
<pre>transaction fee = total gas used * gas price paid  (in ether)</pre>
</div>
</div>
<div class="paragraph data-line-644">
<p>When constructing a new block, miners on the Ethereum network can choose among pending transactions by selecting those that offer to pay a higher gas price. Offering a higher gas price will therefore incentivize miners to include your transaction and get it confirmed faster.</p>
</div>
<div class="paragraph data-line-646">
<p>In practice, the sender of a transaction will set a gas limit that is higher than or equal to the amount of gas expected to be used. If the gas limit is set higher than the amount of gas consumed, the sender will receive a refund of the excess amount, as miners are only compensated for the work they actually perform.</p>
</div>
<div class="paragraph data-line-648">
<p>It is important to be clear about the distinction between the <em>gas cost</em> and the <em>gas price</em>. To recap:</p>
</div>
<div class="ulist data-line-650">
<ul>
<li class="data-line-650">
<p>Gas cost is the number of units of gas required to perform a particular operation.</p>
</li>
<li class="data-line-652">
<p>Gas price is the amount of ether you are willing to pay per unit of gas when you send your transaction to the Ethereum network.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip data-line-655">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph data-line-656">
<p>While gas has a price, it cannot be "owned" nor "spent." Gas exists only inside the EVM, as a count of how much computational work is being performed. The sender is charged a transaction fee in ether, which is then converted to gas for EVM accounting and then back to ether as a transaction fee paid to the miners.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4 data-line-660">
<h5 id="_coûts_négatifs_du_gaz">Coûts négatifs du gaz</h5>
<div class="paragraph data-line-662">
<p>Ethereum encourages the deletion of used storage variables and accounts by refunding some of the gas used during contract execution.</p>
</div>
<div class="paragraph data-line-664">
<p>There are two operations in the EVM with negative gas costs:</p>
</div>
<div class="ulist data-line-666">
<ul>
<li class="data-line-666">
<p>Deleting a contract (SELFDESTRUCT) is worth a refund of 24,000 gas.</p>
</li>
<li class="data-line-667">
<p>Changing a storage address from a nonzero value to zero (SSTORE[x] = 0) is worth a refund of 15,000 gas.</p>
</li>
</ul>
</div>
<div class="paragraph data-line-669">
<p>To avoid exploitation of the refund mechanism, the maximum refund for a transaction is set to half the total amount of gas used (rounded down).</p>
</div>
</div>
</div>
<div class="sect3 data-line-671">
<h4 id="_limite_de_gaz_dun_bloc">Limite de gaz d&#8217;un bloc</h4>
<div class="paragraph data-line-673">
<p>The block gas limit is the maximum amount of gas that may be consumed by all the transactions in a block, and constrains how many transactions can fit into a block.</p>
</div>
<div class="paragraph data-line-675">
<p>For example, let’s say we have 5 transactions whose gas limits have been set to 30,000, 30,000, 40,000, 50,000, and 50,000. If the block gas limit is 180,000, then any four of those transactions can fit in a block, while the fifth will have to wait for a future block. As previously discussed, miners decide which transactions to include in a block. Different miners are likely to select different combinations, mainly because they receive transactions from the network in a different order.</p>
</div>
<div class="paragraph data-line-677">
<p>If a miner tries to include a transaction that requires more gas than the current block gas limit, the block will be rejected by the network. Most Ethereum clients will stop you from issuing such a transaction by giving a warning along the lines of “transaction exceeds block gas limit.” The block gas limit on the Ethereum mainnet is 8 million gas at the time of writing according to <a href="https://etherscan.io" class="undefined" data-href="https://etherscan.io">https://etherscan.io</a>, meaning that around 380 basic transactions (each consuming 21,000 gas) could fit into a block.</p>
</div>
<div class="sect4 data-line-679">
<h5 id="_qui_décide_de_la_limite_de_gaz_dun_bloc">Qui décide de la limite de gaz d&#8217;un bloc ?</h5>
<div class="paragraph data-line-681">
<p>The miners on the network collectively decide the block gas limit. Individuals who want to mine on the Ethereum network use a mining program, such as Ethminer, which connects to a Geth or Parity Ethereum client. The Ethereum protocol has a built-in mechanism where miners can vote on the gas limit so capacity can be increased or decreased in subsequent blocks. The miner of a block can vote to adjust the block gas limit by a factor of 1/1,024 (0.0976%) in either direction. The result of this is an adjustable block size based on the needs of the network at the time. This mechanism is coupled with a default mining strategy where miners vote on a gas limit that is at least 4.7 million gas, but which targets a value of 150% of the average of recent total gas usage per block (using a 1,024-block exponential moving average).</p>
</div>
</div>
</div>
</div>
<div class="sect2 data-line-683">
<h3 id="_conclusions">Conclusions</h3>
<div class="paragraph data-line-685">
<p>Dans ce chapitre, nous avons exploré la machine virtuelle Ethereum, retracé l&#8217;exécution de divers contrats intelligents et analysé comment l&#8217;EVM exécute le bytecode. Nous avons également examiné le gaz, le mécanisme de comptabilité de l&#8217;EVM, et avons vu comment il résout le problème de l&#8217;arrêt et protège Ethereum des attaques par déni de service. Ensuite, dans &lt; &lt;consensus&gt; &gt;, nous examinerons le mécanisme utilisé par Ethereum pour parvenir à un consensus décentralisé. </p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-26 01:03:19 -0400
</div>
</div>
</body>
</html>